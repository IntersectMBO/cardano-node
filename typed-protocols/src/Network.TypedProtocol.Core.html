<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds          #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds                #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DerivingVia              #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE EmptyCase                #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts         #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances        #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE GADTs                    #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses    #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE PatternSynonyms          #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE PolyKinds                #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes               #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables      #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving       #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE StandaloneKindSignatures #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilyDependencies   #-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators            #-}</span><span>
</span><span id="line-17"></span><span class="hs-pragma">{-# LANGUAGE ViewPatterns             #-}</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-pragma">{-# OPTIONS_HADDOCK show-extensions #-}</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-comment">-- | This module defines the core of the typed protocol framework.</span><span>
</span><span id="line-22"></span><span class="hs-comment">--</span><span>
</span><span id="line-23"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.TypedProtocol.Core</span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Introduction</span></span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><span class="hs-comment">-- $intro</span></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Defining protocols</span></span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><span class="hs-comment">-- $defining</span></span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Protocol"><span class="hs-identifier">Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateTokenI"><span class="hs-identifier">StateTokenI</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><span class="hs-comment">-- $lemmas</span></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Engaging in protocols</span></span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** PeerRole</span></span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier">PeerRole</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingPeerRole"><span class="hs-identifier">SingPeerRole</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Agency and its evidence</span></span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="hs-comment">-- $agency</span></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Agency"><span class="hs-identifier">Agency</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingAgency"><span class="hs-identifier">SingAgency</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#RelativeAgency"><span class="hs-identifier">RelativeAgency</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Relative"><span class="hs-identifier">Relative</span></a></span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ReflRelativeAgency"><span class="hs-identifier">ReflRelativeAgency</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#WeHaveAgencyProof"><span class="hs-identifier">WeHaveAgencyProof</span></a></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#TheyHaveAgencyProof"><span class="hs-identifier">TheyHaveAgencyProof</span></a></span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyHasAgencyProof"><span class="hs-identifier">NobodyHasAgencyProof</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** FlipAgency</span></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#FlipAgency"><span class="hs-identifier">FlipAgency</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** ActiveState</span></span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsActiveState"><span class="hs-identifier">IsActiveState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveState"><span class="hs-identifier">ActiveState</span></a></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#notActiveState"><span class="hs-identifier">notActiveState</span></a></span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveAgency"><span class="hs-identifier">ActiveAgency</span></a></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveAgency%27"><span class="hs-identifier">ActiveAgency'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Pipelining</span></span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** IsPipelined</span></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsPipelined"><span class="hs-identifier">IsPipelined</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** Outstanding</span></span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Outstanding"><span class="hs-identifier">Outstanding</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** N and Nat</span></span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#N"><span class="hs-identifier">N</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Nat"><span class="hs-identifier">Nat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#Succ"><span class="hs-identifier">Succ</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Zero"><span class="hs-identifier">Zero</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#natToInt"><span class="hs-identifier">natToInt</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#unsafeIntToNat"><span class="hs-identifier">unsafeIntToNat</span></a></span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Kind.html"><span class="hs-identifier">Data.Kind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Constraint"><span class="hs-identifier">Constraint</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Unsafe.Coerce.html"><span class="hs-identifier">Unsafe.Coerce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Unsafe.Coerce.html#unsafeCoerce"><span class="hs-identifier">unsafeCoerce</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Singletons</span></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-comment">-- $intro</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- A typed protocol between two peers is defined via a state machine: a</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- collection of protocol states and protocol messages which are transitions</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- between those states.</span><span>
</span><span id="line-76"></span><span class="hs-comment">--</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- Start from the idea that a protocol is some language of messages sent</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- between two peers. To specify a protocol is to describe what possible</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- sequences of messages are valid. One simple but still relatively expressive</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- way to do this is via a state machine: starting from some initial state,</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- all possible paths through the state machine gives the set of valid protocol</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- traces. This then dictates what a peer participating in a protocol may</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- produce and what it must accept.</span><span>
</span><span id="line-84"></span><span class="hs-comment">--</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- In this style we have a fixed number of states and in each state there is</span><span>
</span><span id="line-86"></span><span class="hs-comment">-- some number of valid messages that move us on to the next state. This can be</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- illustrated as a graph, which can be a helpful form of documentation.</span><span>
</span><span id="line-88"></span><span class="hs-comment">--</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- We further constrain this idea by saying that the two peers will use the</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- same state machine and change states in lock-step by sending\/receiving</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- messages. In this approach, for each protocol state, the description</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- dictates which peer has the agency to choose to send a message, while</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- correspondingly the other must be prepared to receive the message.</span><span>
</span><span id="line-94"></span><span class="hs-comment">--</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- The views of the two peers are dual. In each state one peer can send any</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- message that is valid for the current protocol state while the other</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- must be prepared to receive any valid message for current protocol state.</span><span>
</span><span id="line-98"></span><span class="hs-comment">--</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- We can also have terminal protocol states in which neither peer has agency.</span><span>
</span><span id="line-100"></span><span class="hs-comment">--</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- So part of the protocol description is to label each protocol state with</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- the peer that has the agency in that state, or none for terminal states.</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- We use the labels \&quot;client\&quot; and \&quot;server\&quot; for the two peers, but they are</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- in fact symmetric.</span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="hs-comment">-- $defining</span><span>
</span><span id="line-108"></span><span class="hs-comment">--</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- The 'Protocol' type class bundles up all the requirements for a typed</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- protocol, which are in fact all type level constructs. Defining a new</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- protocol and making it an instance of the 'Protocol' class requires the</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- following language extensions:</span><span>
</span><span id="line-113"></span><span class="hs-comment">--</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- &gt; {-# LANGUAGE GADTs, TypeFamilies, DataKinds #-}</span><span>
</span><span id="line-115"></span><span class="hs-comment">--</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- The type class itself is indexed on a protocol \&quot;tag\&quot; type. This type</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- does double duty as the /kind/ of the /types/ of the protocol states.</span><span>
</span><span id="line-118"></span><span class="hs-comment">--</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- We will use as a running example a simple \&quot;ping\/pong\&quot; protocol. (You can</span><span>
</span><span id="line-120"></span><span class="hs-comment">-- see the example in full in &quot;Network.TypedProtocol.PingPong.Type&quot;.) In this</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- example protocol the client sends a ping message and the serve must respond</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- with a pong message. The client can also terminate the protocol. So modelled</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- as a state machine this protocol has three states, the one in which the</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- client can send a ping or terminate message, the one in which the server</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- must send a pong, and the terminal state where neither can send anything.</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- We somewhat arbitrarily choose label these protocol states as \&quot;idle\&quot;</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- \&quot;busy\&quot; and \&quot;done\&quot;.</span><span>
</span><span id="line-128"></span><span class="hs-comment">--</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- For this ping pong example the protocol tag and the protocol state types</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- would be defined (via promoted data kinds) as:</span><span>
</span><span id="line-131"></span><span class="hs-comment">--</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- &gt; data PingPong where</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- &gt;   StIdle :: PingPong</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- &gt;   StBusy :: PingPong</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- &gt;   StDone :: PingPong</span><span>
</span><span id="line-136"></span><span class="hs-comment">--</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- We use @DataKinds@ promotion here so @StIdle@, @StBusy@ and @StDone@ are</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- /types/ (of /kind/ @PingPong@) representing the three states in this</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- protocol's state machine. @PingPong@ itself is both the kind of these types</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- and is also the tag for protocol. We only ever use these as types, via the</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- @DataKinds@ promotion, never as value level data constructors.</span><span>
</span><span id="line-142"></span><span class="hs-comment">--</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- Having defined our protocol tag and states we can instantiate the 'Protocol'</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- type class and fill out the other details.</span><span>
</span><span id="line-145"></span><span class="hs-comment">--</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- The protocol must define what its messages are. These form the state</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- transitions in the protocol state machine. Each transition specifies a</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- \&quot;from\&quot; and \&quot;to\&quot; state as type parameters. This of course determines in</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- which protocol states each message can appear.</span><span>
</span><span id="line-150"></span><span class="hs-comment">--</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- In the \&quot;ping\/pong\&quot; protocol example, the messages are of course ping and</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- pong, which transition between the two main states. There is also a done</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- message that moves the system into a terminal state.</span><span>
</span><span id="line-154"></span><span class="hs-comment">--</span><span>
</span><span id="line-155"></span><span class="hs-comment">-- &gt; instance Protocol PingPong where</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- &gt;   data Message PingPong from to where</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- &gt;     MsgPing :: Message PingPong StIdle StBusy</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- &gt;     MsgPong :: Message PingPong StBusy StIdle</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- &gt;     MsgDone :: Message PingPong StIdle StDone</span><span>
</span><span id="line-160"></span><span class="hs-comment">--</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- This says that in the idle state a ping message takes us to the busy state,</span><span>
</span><span id="line-162"></span><span class="hs-comment">-- while a pong message takes us back to idle. Also in the idle state a done</span><span>
</span><span id="line-163"></span><span class="hs-comment">-- message takes us to the done state.</span><span>
</span><span id="line-164"></span><span class="hs-comment">--</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- It is not required that protocols have any terminal states or corresponding</span><span>
</span><span id="line-166"></span><span class="hs-comment">-- transitions, as in this example, but it is often useful and it aids testing</span><span>
</span><span id="line-167"></span><span class="hs-comment">-- to have protocols that terminate cleanly as it allows them to return a</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- result.</span><span>
</span><span id="line-169"></span><span class="hs-comment">--</span><span>
</span><span id="line-170"></span><span class="hs-comment">-- As described above, this style of protocol gives agency to only one peer at</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- once. That is, in each protocol state, one peer has agency (the ability to</span><span>
</span><span id="line-172"></span><span class="hs-comment">-- send) and the other does not (it must only receive).</span><span>
</span><span id="line-173"></span><span class="hs-comment">--</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- In the \&quot;ping\/pong\&quot; protocol example, the idle state is the one in which</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- the client can send a message, and the busy state is the one in which the</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- server must respond. Finally in the done state, neither peer can send any</span><span>
</span><span id="line-177"></span><span class="hs-comment">-- further messages. This arrangement is defined as so:</span><span>
</span><span id="line-178"></span><span class="hs-comment">--</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- &gt;    -- still within the instance Protocol PingPong</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- &gt;    type StateAgency StIdle = ClientAgency</span><span>
</span><span id="line-181"></span><span class="hs-comment">-- &gt;    type StateAgency StBusy = ServerAgency</span><span>
</span><span id="line-182"></span><span class="hs-comment">-- &gt;    type StateAgency StDone = NobodyAgency</span><span>
</span><span id="line-183"></span><span class="hs-comment">--</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- In this simple protocol there is exactly one state in each category, but in</span><span>
</span><span id="line-185"></span><span class="hs-comment">-- general for non-trivial protocols there may be several protocol states in</span><span>
</span><span id="line-186"></span><span class="hs-comment">-- each category.</span><span>
</span><span id="line-187"></span><span class="hs-comment">--</span><span>
</span><span id="line-188"></span><span class="hs-comment">-- Finally we need to point which singletons to use for the protocol states</span><span>
</span><span id="line-189"></span><span class="hs-comment">--</span><span>
</span><span id="line-190"></span><span class="hs-comment">-- &gt;    -- still within the instance Protocol PingPong, 'SPingPong' type is what we define next.</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- &gt;    type StateToken = SPingPong</span><span>
</span><span id="line-192"></span><span class="hs-comment">--</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- Furthermore we use singletons to provide term level reflection of type level</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- states.  One is required to provide singletons for all types of kind</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- 'PingPong'.  These definitions are provided outside of the 'Protocol' type</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- class.  This is as simple as providing a GADT:</span><span>
</span><span id="line-197"></span><span class="hs-comment">--</span><span>
</span><span id="line-198"></span><span class="hs-comment">-- &gt; data SingPingPong (st :: PingPong) where</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- &gt;   SingIdle :: SingPingPong StIdle</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- &gt;   SingBusy :: SingPingPong StBusy</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- &gt;   SingDone :: SingPingPong StDone</span><span>
</span><span id="line-202"></span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- together with 'StateTokenI' instance (similar to 'SingI' from the</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- &quot;singletons&quot; package):</span><span>
</span><span id="line-205"></span><span class="hs-comment">--</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- &gt; instance StateTokenI StIdle where stateToken = SingIdle</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- &gt; instance StateTokenI StBusy where stateToken = SingBusy</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- &gt; instance StateTokenI StDone where stateToken = SingDone</span><span>
</span><span id="line-209"></span><span class="hs-comment">--</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- This and other example protocols are provided in &quot;typed-protocols-examples&quot;</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- package.</span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="hs-comment">-- | Types for client and server peer roles. As protocol can be viewed from</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- either client or server side.</span><span>
</span><span id="line-215"></span><span class="hs-comment">--</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- Note that technically \&quot;client\&quot; and \&quot;server\&quot; are arbitrary labels. The</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- framework is completely symmetric between the two peers.</span><span>
</span><span id="line-218"></span><span class="hs-comment">--</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- This definition is only used as promoted types and kinds, never as values.</span><span>
</span><span id="line-220"></span><span class="hs-comment">--</span><span>
</span><span id="line-221"></span><span class="hs-keyword">data</span><span> </span><span id="PeerRole"><span class="annot"><a href="Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-var">PeerRole</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AsClient"><span class="annot"><a href="Network.TypedProtocol.Core.html#AsClient"><span class="hs-identifier hs-var">AsClient</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="AsServer"><span class="annot"><a href="Network.TypedProtocol.Core.html#AsServer"><span class="hs-identifier hs-var">AsServer</span></a></span></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="hs-comment">-- | Singletons for 'PeerRole'.  We provide 'Sing' and 'SingI' instances from</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- the &quot;singletons&quot; package.</span><span>
</span><span id="line-225"></span><span class="hs-comment">--</span><span>
</span><span id="line-226"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingPeerRole"><span class="hs-identifier hs-type">SingPeerRole</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-227"></span><span class="hs-keyword">data</span><span> </span><span id="SingPeerRole"><span class="annot"><a href="Network.TypedProtocol.Core.html#SingPeerRole"><span class="hs-identifier hs-var">SingPeerRole</span></a></span></span><span> </span><span id="local-6989586621679071928"><span class="annot"><a href="#local-6989586621679071928"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-228"></span><span>    </span><span id="SingAsClient"><span class="annot"><a href="Network.TypedProtocol.Core.html#SingAsClient"><span class="hs-identifier hs-var">SingAsClient</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingPeerRole"><span class="hs-identifier hs-type">SingPeerRole</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsClient"><span class="hs-identifier hs-type">AsClient</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span id="SingAsServer"><span class="annot"><a href="Network.TypedProtocol.Core.html#SingAsServer"><span class="hs-identifier hs-var">SingAsServer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingPeerRole"><span class="hs-identifier hs-type">SingPeerRole</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsServer"><span class="hs-identifier hs-type">AsServer</span></a></span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span id="local-6989586621679071836"><span id="local-6989586621679071932"><span id="local-6989586621679071934"><span id="local-6989586621679071938"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingPeerRole"><span class="hs-identifier hs-type">SingPeerRole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071836"><span class="hs-identifier hs-type">pr</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="Sing"><span class="annot"><span class="hs-identifier hs-var">Sing</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingPeerRole"><span class="hs-identifier hs-type">SingPeerRole</span></a></span><span>
</span><span id="line-234"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SingI</span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsClient"><span class="hs-identifier hs-type">AsClient</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-235"></span><span>    </span><span id="local-6989586621679071944"><span class="annot"><span class="annottext">sing :: Sing 'AsClient
</span><a href="#local-6989586621679071944"><span class="hs-identifier hs-var hs-var hs-var hs-var">sing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sing 'AsClient
SingPeerRole 'AsClient
</span><a href="Network.TypedProtocol.Core.html#SingAsClient"><span class="hs-identifier hs-var">SingAsClient</span></a></span><span>
</span><span id="line-236"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SingI</span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsServer"><span class="hs-identifier hs-type">AsServer</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-237"></span><span>    </span><span id="local-6989586621679071948"><span class="annot"><span class="annottext">sing :: Sing 'AsServer
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">sing</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sing 'AsServer
SingPeerRole 'AsServer
</span><a href="Network.TypedProtocol.Core.html#SingAsServer"><span class="hs-identifier hs-var">SingAsServer</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- $agency</span><span>
</span><span id="line-240"></span><span class="hs-comment">-- The protocols we consider either give agency to one side (one side can send</span><span>
</span><span id="line-241"></span><span class="hs-comment">-- a message) or the protocol terminated.  Agency is a (type-level) function of</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- the protocol state, and thus uniquely determined by it.</span><span>
</span><span id="line-243"></span><span class="hs-comment">--</span><span>
</span><span id="line-244"></span><span class="hs-comment">-- The following types define the necessary type-level machinery and its</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- term-level evidence to provide type-safe API for `typed-protocols`.</span><span>
</span><span id="line-246"></span><span class="hs-comment">-- Required proofs are hidden in an (unexposed) module</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- @Network.TypedProtocol.Lemmas@.</span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span class="hs-comment">-- | A promoted data type which denotes three possible agencies a protocol</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- state might be assigned.</span><span>
</span><span id="line-251"></span><span class="hs-comment">--</span><span>
</span><span id="line-252"></span><span class="hs-keyword">data</span><span> </span><span id="Agency"><span class="annot"><a href="Network.TypedProtocol.Core.html#Agency"><span class="hs-identifier hs-var">Agency</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-253"></span><span>    </span><span class="annot"><span class="hs-comment">-- | The client has agency.</span></span><span>
</span><span id="line-254"></span><span>    </span><span id="ClientAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#ClientAgency"><span class="hs-identifier hs-var">ClientAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Agency"><span class="hs-identifier hs-type">Agency</span></a></span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><span class="hs-comment">-- | The server has agency.</span></span><span>
</span><span id="line-257"></span><span>    </span><span id="ServerAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#ServerAgency"><span class="hs-identifier hs-var">ServerAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Agency"><span class="hs-identifier hs-type">Agency</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span>    </span><span class="annot"><span class="hs-comment">-- | Nobody has agency, terminal state.</span></span><span>
</span><span id="line-260"></span><span>    </span><span id="NobodyAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyAgency"><span class="hs-identifier hs-var">NobodyAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Agency"><span class="hs-identifier hs-type">Agency</span></a></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingAgency"><span class="hs-identifier hs-type">SingAgency</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Agency"><span class="hs-identifier hs-type">Agency</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-263"></span><span class="hs-keyword">data</span><span> </span><span id="SingAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#SingAgency"><span class="hs-identifier hs-var">SingAgency</span></a></span></span><span> </span><span id="local-6989586621679071949"><span class="annot"><a href="#local-6989586621679071949"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-264"></span><span>    </span><span id="SingClientAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#SingClientAgency"><span class="hs-identifier hs-var">SingClientAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingAgency"><span class="hs-identifier hs-type">SingAgency</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ClientAgency"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span>
</span><span id="line-265"></span><span>    </span><span id="SingServerAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#SingServerAgency"><span class="hs-identifier hs-var">SingServerAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingAgency"><span class="hs-identifier hs-type">SingAgency</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ServerAgency"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span>
</span><span id="line-266"></span><span>    </span><span id="SingNobodyAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#SingNobodyAgency"><span class="hs-identifier hs-var">SingNobodyAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingAgency"><span class="hs-identifier hs-type">SingAgency</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyAgency"><span class="hs-identifier hs-type">NobodyAgency</span></a></span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span id="local-6989586621679071842"><span id="local-6989586621679071954"><span id="local-6989586621679071956"><span id="local-6989586621679071960"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingAgency"><span class="hs-identifier hs-type">SingAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071842"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="Sing"><span class="annot"><span class="hs-identifier hs-var">Sing</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#SingAgency"><span class="hs-identifier hs-type">SingAgency</span></a></span><span>
</span><span id="line-271"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SingI</span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ClientAgency"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621679071964"><span class="annot"><span class="annottext">sing :: Sing 'ClientAgency
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">sing</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sing 'ClientAgency
SingAgency 'ClientAgency
</span><a href="Network.TypedProtocol.Core.html#SingClientAgency"><span class="hs-identifier hs-var">SingClientAgency</span></a></span><span>
</span><span id="line-273"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SingI</span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ServerAgency"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-274"></span><span>    </span><span id="local-6989586621679071967"><span class="annot"><span class="annottext">sing :: Sing 'ServerAgency
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">sing</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sing 'ServerAgency
SingAgency 'ServerAgency
</span><a href="Network.TypedProtocol.Core.html#SingServerAgency"><span class="hs-identifier hs-var">SingServerAgency</span></a></span><span>
</span><span id="line-275"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SingI</span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyAgency"><span class="hs-identifier hs-type">NobodyAgency</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-276"></span><span>    </span><span id="local-6989586621679071970"><span class="annot"><span class="annottext">sing :: Sing 'NobodyAgency
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">sing</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sing 'NobodyAgency
SingAgency 'NobodyAgency
</span><a href="Network.TypedProtocol.Core.html#SingNobodyAgency"><span class="hs-identifier hs-var">SingNobodyAgency</span></a></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span class="hs-comment">-- | A promoted data type which indicates the effective agency (which is</span><span>
</span><span id="line-279"></span><span class="hs-comment">-- relative to current role).  It is computed by `Relative` type family.</span><span>
</span><span id="line-280"></span><span class="hs-comment">--</span><span>
</span><span id="line-281"></span><span class="hs-keyword">data</span><span> </span><span id="RelativeAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#RelativeAgency"><span class="hs-identifier hs-var">RelativeAgency</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-comment">-- evidence that we have agency</span><span>
</span><span id="line-283"></span><span>    </span><span id="WeHaveAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#WeHaveAgency"><span class="hs-identifier hs-var">WeHaveAgency</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#RelativeAgency"><span class="hs-identifier hs-type">RelativeAgency</span></a></span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-comment">-- evidence that proof the remote side has agency</span><span>
</span><span id="line-285"></span><span>    </span><span id="TheyHaveAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#TheyHaveAgency"><span class="hs-identifier hs-var">TheyHaveAgency</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#RelativeAgency"><span class="hs-identifier hs-type">RelativeAgency</span></a></span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-comment">-- evidence of protocol termination</span><span>
</span><span id="line-287"></span><span>    </span><span id="NobodyHasAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyHasAgency"><span class="hs-identifier hs-var">NobodyHasAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#RelativeAgency"><span class="hs-identifier hs-type">RelativeAgency</span></a></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- TODO: input-output-hk/typed-protocols#57</span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="hs-comment">-- | Compute effective agency with respect to the peer role, for client role,</span><span>
</span><span id="line-292"></span><span class="hs-comment">-- agency is preserved, while for the server role it is flipped.</span><span>
</span><span id="line-293"></span><span class="hs-comment">--</span><span>
</span><span id="line-294"></span><span class="hs-keyword">type</span><span>        </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Relative"><span class="hs-identifier hs-type">Relative</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Agency"><span class="hs-identifier hs-type">Agency</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#RelativeAgency"><span class="hs-identifier hs-type">RelativeAgency</span></a></span><span>
</span><span id="line-295"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="Relative"><span class="annot"><a href="Network.TypedProtocol.Core.html#Relative"><span class="hs-identifier hs-var">Relative</span></a></span></span><span>  </span><span id="local-6989586621679071974"><span class="annot"><a href="#local-6989586621679071974"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679071975"><span class="annot"><a href="#local-6989586621679071975"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-296"></span><span>  </span><span id="Relative"><span class="annot"><a href="Network.TypedProtocol.Core.html#Relative"><span class="hs-identifier hs-var">Relative</span></a></span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsClient"><span class="hs-identifier hs-type">AsClient</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ClientAgency"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#WeHaveAgency"><span class="hs-identifier hs-type">WeHaveAgency</span></a></span><span>
</span><span id="line-297"></span><span>  </span><span id="Relative"><span class="annot"><a href="Network.TypedProtocol.Core.html#Relative"><span class="hs-identifier hs-var">Relative</span></a></span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsClient"><span class="hs-identifier hs-type">AsClient</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ServerAgency"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#TheyHaveAgency"><span class="hs-identifier hs-type">TheyHaveAgency</span></a></span><span>
</span><span id="line-298"></span><span>  </span><span id="Relative"><span class="annot"><a href="Network.TypedProtocol.Core.html#Relative"><span class="hs-identifier hs-var">Relative</span></a></span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsClient"><span class="hs-identifier hs-type">AsClient</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyAgency"><span class="hs-identifier hs-type">NobodyAgency</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyHasAgency"><span class="hs-identifier hs-type">NobodyHasAgency</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span id="Relative"><span class="annot"><a href="Network.TypedProtocol.Core.html#Relative"><span class="hs-identifier hs-var">Relative</span></a></span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsServer"><span class="hs-identifier hs-type">AsServer</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ClientAgency"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#TheyHaveAgency"><span class="hs-identifier hs-type">TheyHaveAgency</span></a></span><span>
</span><span id="line-300"></span><span>  </span><span id="Relative"><span class="annot"><a href="Network.TypedProtocol.Core.html#Relative"><span class="hs-identifier hs-var">Relative</span></a></span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsServer"><span class="hs-identifier hs-type">AsServer</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ServerAgency"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#WeHaveAgency"><span class="hs-identifier hs-type">WeHaveAgency</span></a></span><span>
</span><span id="line-301"></span><span>  </span><span id="Relative"><span class="annot"><a href="Network.TypedProtocol.Core.html#Relative"><span class="hs-identifier hs-var">Relative</span></a></span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsServer"><span class="hs-identifier hs-type">AsServer</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyAgency"><span class="hs-identifier hs-type">NobodyAgency</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyHasAgency"><span class="hs-identifier hs-type">NobodyHasAgency</span></a></span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span class="hs-comment">-- | Type equality for 'RelativeAgency' which also carries information about</span><span>
</span><span id="line-305"></span><span class="hs-comment">-- agency.  It is isomorphic to a product of 'Agency' singleton and</span><span>
</span><span id="line-306"></span><span class="hs-comment">-- @r :~: r'@, where both @r@ and @r'@ have kind 'RelativeAgency'.</span><span>
</span><span id="line-307"></span><span class="hs-comment">--</span><span>
</span><span id="line-308"></span><span class="hs-comment">-- This is a proper type with values used by the 'Peer', however they are</span><span>
</span><span id="line-309"></span><span class="hs-comment">-- hidden by using &quot;Network.TypedProtocol.Peer.Client&quot; and</span><span>
</span><span id="line-310"></span><span class="hs-comment">-- &quot;Network.TypedProtocol.Peer.Server&quot; APIs.</span><span>
</span><span id="line-311"></span><span class="hs-comment">--</span><span>
</span><span id="line-312"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ReflRelativeAgency"><span class="hs-identifier hs-type">ReflRelativeAgency</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Agency"><span class="hs-identifier hs-type">Agency</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#RelativeAgency"><span class="hs-identifier hs-type">RelativeAgency</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#RelativeAgency"><span class="hs-identifier hs-type">RelativeAgency</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-313"></span><span class="hs-keyword">data</span><span> </span><span id="ReflRelativeAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#ReflRelativeAgency"><span class="hs-identifier hs-var">ReflRelativeAgency</span></a></span></span><span> </span><span id="local-6989586621679071976"><span class="annot"><a href="#local-6989586621679071976"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679071977"><span class="annot"><a href="#local-6989586621679071977"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621679071978"><span class="annot"><a href="#local-6989586621679071978"><span class="hs-identifier hs-type">r'</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-314"></span><span>    </span><span id="local-6989586621679071979"><span id="ReflClientAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#ReflClientAgency"><span class="hs-identifier hs-var">ReflClientAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ReflRelativeAgency"><span class="hs-identifier hs-type">ReflRelativeAgency</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ClientAgency"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071979"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071979"><span class="hs-identifier hs-type">r</span></a></span></span><span>
</span><span id="line-315"></span><span>    </span><span id="local-6989586621679071981"><span id="ReflServerAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#ReflServerAgency"><span class="hs-identifier hs-var">ReflServerAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ReflRelativeAgency"><span class="hs-identifier hs-type">ReflRelativeAgency</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ServerAgency"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071981"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071981"><span class="hs-identifier hs-type">r</span></a></span></span><span>
</span><span id="line-316"></span><span>    </span><span id="local-6989586621679071983"><span id="ReflNobodyAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#ReflNobodyAgency"><span class="hs-identifier hs-var">ReflNobodyAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ReflRelativeAgency"><span class="hs-identifier hs-type">ReflRelativeAgency</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyAgency"><span class="hs-identifier hs-type">NobodyAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071983"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071983"><span class="hs-identifier hs-type">r</span></a></span></span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span class="hs-comment">-- | Type of the proof that we have the agency.</span><span>
</span><span id="line-319"></span><span class="hs-comment">--</span><span>
</span><span id="line-320"></span><span class="hs-comment">-- 'ReflClientAgency' has this type only iff `'StateAgency' st ~ 'ClientAgency'`</span><span>
</span><span id="line-321"></span><span class="hs-comment">-- and `pr ~ 'AsClient'`.</span><span>
</span><span id="line-322"></span><span class="hs-comment">--</span><span>
</span><span id="line-323"></span><span class="hs-comment">-- 'ReflServerAgency' has this type only iff `'StateAgency' st ~ 'ServerAgency'`</span><span>
</span><span id="line-324"></span><span class="hs-comment">-- and `pr ~ 'AsServer'`</span><span>
</span><span id="line-325"></span><span class="hs-comment">--</span><span>
</span><span id="line-326"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#WeHaveAgencyProof"><span class="hs-identifier hs-type">WeHaveAgencyProof</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679071985"><span class="annot"><a href="Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679071985"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span></span><span>
</span><span id="line-327"></span><span class="hs-keyword">type</span><span> </span><span id="WeHaveAgencyProof"><span class="annot"><a href="Network.TypedProtocol.Core.html#WeHaveAgencyProof"><span class="hs-identifier hs-var">WeHaveAgencyProof</span></a></span></span><span> </span><span id="local-6989586621679071986"><span class="annot"><a href="#local-6989586621679071986"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679071987"><span class="annot"><a href="#local-6989586621679071987"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ReflRelativeAgency"><span class="hs-identifier hs-type">ReflRelativeAgency</span></a></span><span>
</span><span id="line-328"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071987"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>                                  </span><span class="annot"><a href="Network.TypedProtocol.Core.html#WeHaveAgency"><span class="hs-identifier hs-type">WeHaveAgency</span></a></span><span>
</span><span id="line-330"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#Relative"><span class="hs-identifier hs-type">Relative</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071986"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071987"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span class="hs-comment">-- | Type of the proof that the remote side has the agency.</span><span>
</span><span id="line-333"></span><span class="hs-comment">--</span><span>
</span><span id="line-334"></span><span class="hs-comment">-- 'ReflClientAgency' has this type only iff `'StateAgency' st ~ 'ClientAgency'`</span><span>
</span><span id="line-335"></span><span class="hs-comment">-- and `pr ~ 'AsServer'`.</span><span>
</span><span id="line-336"></span><span class="hs-comment">--</span><span>
</span><span id="line-337"></span><span class="hs-comment">-- 'ReflServerAgency' has this type only iff `'StateAgency' st ~ 'ServerAgency'`</span><span>
</span><span id="line-338"></span><span class="hs-comment">-- and `pr ~ 'AsClient'`</span><span>
</span><span id="line-339"></span><span class="hs-comment">--</span><span>
</span><span id="line-340"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#TheyHaveAgencyProof"><span class="hs-identifier hs-type">TheyHaveAgencyProof</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679071988"><span class="annot"><a href="Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679071988"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span></span><span>
</span><span id="line-341"></span><span class="hs-keyword">type</span><span> </span><span id="TheyHaveAgencyProof"><span class="annot"><a href="Network.TypedProtocol.Core.html#TheyHaveAgencyProof"><span class="hs-identifier hs-var">TheyHaveAgencyProof</span></a></span></span><span> </span><span id="local-6989586621679071989"><span class="annot"><a href="#local-6989586621679071989"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679071990"><span class="annot"><a href="#local-6989586621679071990"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ReflRelativeAgency"><span class="hs-identifier hs-type">ReflRelativeAgency</span></a></span><span>
</span><span id="line-342"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071990"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>                                    </span><span class="annot"><a href="Network.TypedProtocol.Core.html#TheyHaveAgency"><span class="hs-identifier hs-type">TheyHaveAgency</span></a></span><span>
</span><span id="line-344"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#Relative"><span class="hs-identifier hs-type">Relative</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071989"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071990"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span class="hs-comment">-- | Type of the proof that nobody has agency in this state.</span><span>
</span><span id="line-348"></span><span class="hs-comment">--</span><span>
</span><span id="line-349"></span><span class="hs-comment">-- Only 'ReflNobodyAgency' can fulfil the proof obligation.</span><span>
</span><span id="line-350"></span><span class="hs-comment">--</span><span>
</span><span id="line-351"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyHasAgencyProof"><span class="hs-identifier hs-type">NobodyHasAgencyProof</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679071991"><span class="annot"><a href="Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679071991"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span></span><span>
</span><span id="line-352"></span><span class="hs-keyword">type</span><span> </span><span id="NobodyHasAgencyProof"><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyHasAgencyProof"><span class="hs-identifier hs-var">NobodyHasAgencyProof</span></a></span></span><span> </span><span id="local-6989586621679071992"><span class="annot"><a href="#local-6989586621679071992"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679071993"><span class="annot"><a href="#local-6989586621679071993"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ReflRelativeAgency"><span class="hs-identifier hs-type">ReflRelativeAgency</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071993"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>                                                      </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyHasAgency"><span class="hs-identifier hs-type">NobodyHasAgency</span></a></span><span>
</span><span id="line-354"></span><span>                                                     </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#Relative"><span class="hs-identifier hs-type">Relative</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071992"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071993"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span class="hs-comment">-- $lemmas</span><span>
</span><span id="line-357"></span><span class="hs-comment">--</span><span>
</span><span id="line-358"></span><span class="hs-comment">-- The 'Network.TypedProtocol.connect' proof rely on lemmas about the</span><span>
</span><span id="line-359"></span><span class="hs-comment">-- protocol. Specifically they rely on the property that each protocol state is</span><span>
</span><span id="line-360"></span><span class="hs-comment">-- labelled with the agency of one peer or the other, or neither, but never</span><span>
</span><span id="line-361"></span><span class="hs-comment">-- both.  This property is true by construction, since we use a type family</span><span>
</span><span id="line-362"></span><span class="hs-comment">-- 'StateAgency' which maps states to agencies, however we still need an evince</span><span>
</span><span id="line-363"></span><span class="hs-comment">-- that cases where both peer have the agency or neither of them has it can be</span><span>
</span><span id="line-364"></span><span class="hs-comment">-- eliminated.</span><span>
</span><span id="line-365"></span><span class="hs-comment">--</span><span>
</span><span id="line-366"></span><span class="hs-comment">-- The packages defines lemmas (in a hidden module) which are structured as</span><span>
</span><span id="line-367"></span><span class="hs-comment">-- proofs by contradiction, e.g. stating \&quot;if the client and the server have</span><span>
</span><span id="line-368"></span><span class="hs-comment">-- agency for this state then it leads to contradiction\&quot;. Contradiction is</span><span>
</span><span id="line-369"></span><span class="hs-comment">-- represented as the 'Void' type that has no values except &#8869;.</span><span>
</span><span id="line-370"></span><span class="hs-comment">--</span><span>
</span><span id="line-371"></span><span class="hs-comment">-- The framework defines protocol-agnostic proofs (in the hidden module</span><span>
</span><span id="line-372"></span><span class="hs-comment">-- `Network.TypedProtocol.Lemmas`) which excludes that the client and server</span><span>
</span><span id="line-373"></span><span class="hs-comment">-- have agency at the same time.</span><span>
</span><span id="line-374"></span><span class="hs-comment">--</span><span>
</span><span id="line-375"></span><span class="hs-comment">-- * 'exclusionLemma_ClientAndServerHaveAgency',</span><span>
</span><span id="line-376"></span><span class="hs-comment">-- * 'terminationLemma_1',</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- * 'terminationLemma_2'.</span><span>
</span><span id="line-378"></span><span class="hs-comment">--</span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="hs-comment">-- | A type class which hides a state token / singleton inside a class</span><span>
</span><span id="line-381"></span><span class="hs-comment">-- dictionary.</span><span>
</span><span id="line-382"></span><span class="hs-comment">--</span><span>
</span><span id="line-383"></span><span class="hs-comment">-- This is similar to the 'SingI' instance, but specific to protocol state</span><span>
</span><span id="line-384"></span><span class="hs-comment">-- singletons.</span><span>
</span><span id="line-385"></span><span class="hs-comment">--</span><span>
</span><span id="line-386"></span><span class="hs-keyword">class</span><span> </span><span id="StateTokenI"><span class="annot"><a href="Network.TypedProtocol.Core.html#StateTokenI"><span class="hs-identifier hs-var">StateTokenI</span></a></span></span><span> </span><span id="local-6989586621679071994"><span class="annot"><a href="#local-6989586621679071994"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-387"></span><span>    </span><span id="stateToken"><span class="annot"><a href="Network.TypedProtocol.Core.html#stateToken"><span class="hs-identifier hs-type">stateToken</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateToken"><span class="hs-identifier hs-type">StateToken</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071994"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span class="hs-comment">-- | The protocol type class bundles up all the requirements for a typed</span><span>
</span><span id="line-390"></span><span class="hs-comment">-- protocol.</span><span>
</span><span id="line-391"></span><span class="hs-comment">--</span><span>
</span><span id="line-392"></span><span class="hs-comment">-- Each protocol consists of four components:</span><span>
</span><span id="line-393"></span><span class="hs-comment">--</span><span>
</span><span id="line-394"></span><span class="hs-comment">-- * the protocol itself, which is also expected to be the kind of the types</span><span>
</span><span id="line-395"></span><span class="hs-comment">--   of the protocol states. The class is indexed on the protocol itself;</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- * the protocol messages;</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- * a type level map from the protocol states to agency: in each state either</span><span>
</span><span id="line-398"></span><span class="hs-comment">--   client or server or nobody has the agency.</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- * a singleton type for the protocol states (e.g. `StateToken` type family</span><span>
</span><span id="line-400"></span><span class="hs-comment">--   instance), together with 'StateTokenI' instances.</span><span>
</span><span id="line-401"></span><span class="hs-comment">--</span><span>
</span><span id="line-402"></span><span class="hs-comment">-- It is required provide 'StateToken' type family instance as well as</span><span>
</span><span id="line-403"></span><span class="hs-comment">-- 'StateTokenI' instances for all protocol states.  These singletons allow one</span><span>
</span><span id="line-404"></span><span class="hs-comment">-- to pattern match on the state, which is useful when defining codecs, or</span><span>
</span><span id="line-405"></span><span class="hs-comment">-- providing informative error messages, however they are not necessary for</span><span>
</span><span id="line-406"></span><span class="hs-comment">-- proving correctness of the protocol.  These type families are similar to</span><span>
</span><span id="line-407"></span><span class="hs-comment">-- 'Sing' and 'SingI' in the &quot;singletons&quot; package.</span><span>
</span><span id="line-408"></span><span class="hs-comment">--</span><span>
</span><span id="line-409"></span><span class="hs-keyword">class</span><span> </span><span id="Protocol"><span class="annot"><a href="Network.TypedProtocol.Core.html#Protocol"><span class="hs-identifier hs-var">Protocol</span></a></span></span><span> </span><span id="local-6989586621679071996"><span class="annot"><a href="#local-6989586621679071996"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-comment">-- | The messages for this protocol. It is expected to be a GADT that is</span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-comment">-- indexed by the @from@ and @to@ protocol states. That is the protocol state</span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-comment">-- the message transitions from, and the protocol state it transitions into.</span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-comment">-- These are the edges of the protocol state transition system.</span><span>
</span><span id="line-415"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-keyword">data</span><span> </span><span id="Message"><span class="annot"><a href="Network.TypedProtocol.Core.html#Message"><span class="hs-identifier hs-var">Message</span></a></span></span><span> </span><span id="local-6989586621679071996"><span class="annot"><a href="#local-6989586621679071996"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679071998"><span class="annot"><a href="#local-6989586621679071998"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679071996"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679071999"><span class="annot"><a href="#local-6989586621679071999"><span class="hs-identifier hs-type">st'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679071996"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>
</span><span id="line-418"></span><span>  </span><span class="hs-comment">-- | Associate an 'Agency' for each state.</span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="StateAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-var">StateAgency</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679071996"><span id="local-6989586621679072000"><span class="annot"><a href="#local-6989586621679072000"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679071996"><span class="hs-identifier hs-type">ps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Agency"><span class="hs-identifier hs-type">Agency</span></a></span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-comment">-- | A type family for protocol state token, e.g. term level representation of</span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-comment">-- type level state (also known as singleton).</span><span>
</span><span id="line-424"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-425"></span><span>  </span><span class="hs-comment">-- This type family is similar to 'Sing' type class in the &quot;singletons&quot;</span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-comment">-- package, but specific for protocol states.</span><span>
</span><span id="line-427"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="StateToken"><span class="annot"><a href="Network.TypedProtocol.Core.html#StateToken"><span class="hs-identifier hs-var">StateToken</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679071996"><span class="annot"><a href="#local-6989586621679071996"><span class="hs-identifier hs-type hs-type">ps</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span>
</span><span id="line-431"></span><span class="hs-comment">-- | Evidence that one side of the protocol has the agency, and thus that the</span><span>
</span><span id="line-432"></span><span class="hs-comment">-- protocol hasn't yet terminated.</span><span>
</span><span id="line-433"></span><span class="hs-comment">--</span><span>
</span><span id="line-434"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveAgency%27"><span class="hs-identifier hs-type">ActiveAgency'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679072001"><span class="annot"><a href="#local-6989586621679072001"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Agency"><span class="hs-identifier hs-type">Agency</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span></span><span>
</span><span id="line-435"></span><span class="hs-keyword">data</span><span> </span><span id="ActiveAgency%27"><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveAgency%27"><span class="hs-identifier hs-var">ActiveAgency'</span></a></span></span><span> </span><span id="local-6989586621679072002"><span class="annot"><a href="#local-6989586621679072002"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679072003"><span class="annot"><a href="#local-6989586621679072003"><span class="hs-identifier hs-type">agency</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-436"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Evidence that the client has the agency.</span></span><span>
</span><span id="line-437"></span><span>  </span><span id="local-6989586621679071859"><span id="ClientHasAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#ClientHasAgency"><span class="hs-identifier hs-var">ClientHasAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071859"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ClientAgency"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span>
</span><span id="line-438"></span><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveAgency%27"><span class="hs-identifier hs-type">ActiveAgency'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071859"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ClientAgency"><span class="hs-identifier hs-type">ClientAgency</span></a></span></span><span>
</span><span id="line-439"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Evidence that the server has the agency.</span></span><span>
</span><span id="line-440"></span><span>  </span><span id="local-6989586621679071865"><span id="ServerHasAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#ServerHasAgency"><span class="hs-identifier hs-var">ServerHasAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071865"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ServerAgency"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span>
</span><span id="line-441"></span><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveAgency%27"><span class="hs-identifier hs-type">ActiveAgency'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071865"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ServerAgency"><span class="hs-identifier hs-type">ServerAgency</span></a></span></span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span id="local-6989586621679071845"><span id="local-6989586621679071846"><span id="local-6989586621679072007"><span id="local-6989586621679072009"><span id="local-6989586621679072013"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveAgency%27"><span class="hs-identifier hs-type">ActiveAgency'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071845"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071846"><span class="hs-identifier hs-type">agency</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span class="hs-comment">-- | Evidence that the protocol isn't in a terminal state.</span><span>
</span><span id="line-446"></span><span class="hs-comment">--</span><span>
</span><span id="line-447"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveAgency"><span class="hs-identifier hs-type">ActiveAgency</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679072015"><span class="annot"><a href="#local-6989586621679072015"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span></span><span>
</span><span id="line-448"></span><span class="hs-keyword">type</span><span> </span><span id="ActiveAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveAgency"><span class="hs-identifier hs-var">ActiveAgency</span></a></span></span><span> </span><span id="local-6989586621679072016"><span class="annot"><a href="#local-6989586621679072016"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveAgency%27"><span class="hs-identifier hs-type">ActiveAgency'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072016"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072016"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span class="hs-comment">-- | A type class which restricts states to ones that have `ClientAgency` or</span><span>
</span><span id="line-452"></span><span class="hs-comment">-- `ServerAgency`, excluding `NobodyAgency`.</span><span>
</span><span id="line-453"></span><span class="hs-comment">--</span><span>
</span><span id="line-454"></span><span class="hs-comment">-- One can use `notActive' to eliminate cases for which both @'IsActiveState'</span><span>
</span><span id="line-455"></span><span class="hs-comment">-- st@ is in scope and for which we have an evidence that the state is not</span><span>
</span><span id="line-456"></span><span class="hs-comment">-- active (i.e. a singleton).  This is useful when writing a 'Codec'.</span><span>
</span><span id="line-457"></span><span class="hs-comment">--</span><span>
</span><span id="line-458"></span><span class="hs-keyword">class</span><span> </span><span id="IsActiveState"><span class="annot"><a href="Network.TypedProtocol.Core.html#IsActiveState"><span class="hs-identifier hs-var">IsActiveState</span></a></span></span><span> </span><span id="local-6989586621679071851"><span class="annot"><a href="#local-6989586621679071851"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679071852"><span class="annot"><a href="#local-6989586621679071852"><span class="hs-identifier hs-type">agency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Agency"><span class="hs-identifier hs-type">Agency</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-459"></span><span>  </span><span id="activeAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#activeAgency"><span class="hs-identifier hs-type">activeAgency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveAgency%27"><span class="hs-identifier hs-type">ActiveAgency'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071851"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071852"><span class="hs-identifier hs-type">agency</span></a></span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679071854"><span class="annot"><a href="Network.TypedProtocol.Core.html#ClientAgency"><span class="hs-identifier hs-type">ClientAgency</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071854"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-462"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsActiveState"><span class="hs-identifier hs-type">IsActiveState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071854"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ClientAgency"><span class="hs-identifier hs-type">ClientAgency</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-463"></span><span>  </span><span id="local-6989586621679072026"><span class="annot"><span class="annottext">activeAgency :: ActiveAgency' st 'ClientAgency
</span><a href="Network.TypedProtocol.Core.html#activeAgency"><span class="hs-identifier hs-var hs-var hs-var hs-var">activeAgency</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ActiveAgency' st 'ClientAgency
forall {ps} (st :: ps).
(StateAgency st ~ 'ClientAgency) =&gt;
ActiveAgency' st 'ClientAgency
</span><a href="Network.TypedProtocol.Core.html#ClientHasAgency"><span class="hs-identifier hs-var">ClientHasAgency</span></a></span><span>
</span><span id="line-464"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679071863"><span class="annot"><a href="Network.TypedProtocol.Core.html#ServerAgency"><span class="hs-identifier hs-type">ServerAgency</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071863"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-465"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsActiveState"><span class="hs-identifier hs-type">IsActiveState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071863"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ServerAgency"><span class="hs-identifier hs-type">ServerAgency</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-466"></span><span>  </span><span id="local-6989586621679072034"><span class="annot"><span class="annottext">activeAgency :: ActiveAgency' st 'ServerAgency
</span><a href="Network.TypedProtocol.Core.html#activeAgency"><span class="hs-identifier hs-var hs-var hs-var hs-var">activeAgency</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ActiveAgency' st 'ServerAgency
forall {ps} (st :: ps).
(StateAgency st ~ 'ServerAgency) =&gt;
ActiveAgency' st 'ServerAgency
</span><a href="Network.TypedProtocol.Core.html#ServerHasAgency"><span class="hs-identifier hs-var">ServerHasAgency</span></a></span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span class="hs-comment">-- | A constraint which provides an evidence that the protocol isn't in</span><span>
</span><span id="line-469"></span><span class="hs-comment">-- a terminal state.</span><span>
</span><span id="line-470"></span><span class="hs-comment">--</span><span>
</span><span id="line-471"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveState"><span class="hs-identifier hs-type">ActiveState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679072035"><span class="annot"><a href="#local-6989586621679072035"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Constraint"><span class="hs-identifier hs-type">Constraint</span></a></span></span><span>
</span><span id="line-472"></span><span class="hs-keyword">type</span><span> </span><span id="ActiveState"><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveState"><span class="hs-identifier hs-var">ActiveState</span></a></span></span><span> </span><span id="local-6989586621679072036"><span class="annot"><a href="#local-6989586621679072036"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsActiveState"><span class="hs-identifier hs-type">IsActiveState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072036"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072036"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span class="hs-comment">-- | This is useful function to eliminate cases where the `ActiveState st` is</span><span>
</span><span id="line-476"></span><span class="hs-comment">-- provided but we are given a state in which neither side has agency</span><span>
</span><span id="line-477"></span><span class="hs-comment">-- (`NobodyAgency`).  For example when writing a codec, we only need to encode</span><span>
</span><span id="line-478"></span><span class="hs-comment">-- / decode messages which are in active states, but to make such functions</span><span>
</span><span id="line-479"></span><span class="hs-comment">-- total, `notActiveState` needs to be used to eliminate the states in which</span><span>
</span><span id="line-480"></span><span class="hs-comment">-- nobody has agency.</span><span>
</span><span id="line-481"></span><span class="hs-comment">--</span><span>
</span><span id="line-482"></span><span class="hs-comment">-- A good analogy for this function is @'Data.Void.absurd' :: 'Void' -&gt; a@.</span><span>
</span><span id="line-483"></span><span class="hs-comment">--</span><span>
</span><span id="line-484"></span><span class="annot"><a href="Network.TypedProtocol.Core.html#notActiveState"><span class="hs-identifier hs-type">notActiveState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679071866"><span class="annot"><a href="#local-6989586621679071866"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679071867"><span class="annot"><a href="#local-6989586621679071867"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679071866"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-485"></span><span>                  </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071867"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyAgency"><span class="hs-identifier hs-type">NobodyAgency</span></a></span><span>
</span><span id="line-486"></span><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveState"><span class="hs-identifier hs-type">ActiveState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071867"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-487"></span><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateToken"><span class="hs-identifier hs-type">StateToken</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071867"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-488"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679071870"><span class="annot"><a href="#local-6989586621679071870"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679071870"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-489"></span><span id="notActiveState"><span class="annot"><span class="annottext">notActiveState :: forall ps (st :: ps).
(StateAgency st ~ 'NobodyAgency, ActiveState st) =&gt;
StateToken st -&gt; forall a. a
</span><a href="Network.TypedProtocol.Core.html#notActiveState"><span class="hs-identifier hs-var hs-var">notActiveState</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateToken st
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateToken"><span class="hs-identifier hs-type">StateToken</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071867"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-490"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ActiveAgency' st (StateAgency st)
ActiveAgency' st 'NobodyAgency
forall {ps} (st :: ps) (agency :: Agency).
IsActiveState st agency =&gt;
ActiveAgency' st agency
</span><a href="Network.TypedProtocol.Core.html#activeAgency"><span class="hs-identifier hs-var">activeAgency</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveAgency"><span class="hs-identifier hs-type">ActiveAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071867"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><span id="line-491"></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span class="hs-comment">-- | A type function to flip the client and server roles.</span><span>
</span><span id="line-494"></span><span class="hs-comment">--</span><span>
</span><span id="line-495"></span><span class="hs-keyword">type</span><span>        </span><span class="annot"><a href="Network.TypedProtocol.Core.html#FlipAgency"><span class="hs-identifier hs-type">FlipAgency</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a></span><span>
</span><span id="line-496"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="FlipAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#FlipAgency"><span class="hs-identifier hs-var">FlipAgency</span></a></span></span><span> </span><span id="local-6989586621679072042"><span class="annot"><a href="#local-6989586621679072042"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-497"></span><span>  </span><span id="FlipAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#FlipAgency"><span class="hs-identifier hs-var">FlipAgency</span></a></span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsClient"><span class="hs-identifier hs-type">AsClient</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsServer"><span class="hs-identifier hs-type">AsServer</span></a></span><span>
</span><span id="line-498"></span><span>  </span><span id="FlipAgency"><span class="annot"><a href="Network.TypedProtocol.Core.html#FlipAgency"><span class="hs-identifier hs-var">FlipAgency</span></a></span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsServer"><span class="hs-identifier hs-type">AsServer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#AsClient"><span class="hs-identifier hs-type">AsClient</span></a></span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span class="annot"><span class="hs-comment">-- | A type level inductive natural number.</span></span><span>
</span><span id="line-502"></span><span class="hs-keyword">data</span><span> </span><span id="N"><span class="annot"><a href="Network.TypedProtocol.Core.html#N"><span class="hs-identifier hs-var">N</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Z"><span class="annot"><a href="Network.TypedProtocol.Core.html#Z"><span class="hs-identifier hs-var">Z</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="S"><span class="annot"><a href="Network.TypedProtocol.Core.html#S"><span class="hs-identifier hs-var">S</span></a></span></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#N"><span class="hs-identifier hs-type">N</span></a></span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span class="hs-comment">-- | Promoted data type which indicates if 'Peer' is used in</span><span>
</span><span id="line-505"></span><span class="hs-comment">-- pipelined mode or not.</span><span>
</span><span id="line-506"></span><span class="hs-comment">--</span><span>
</span><span id="line-507"></span><span class="hs-keyword">data</span><span> </span><span id="IsPipelined"><span class="annot"><a href="Network.TypedProtocol.Core.html#IsPipelined"><span class="hs-identifier hs-var">IsPipelined</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-comment">-- | Pipelined peer which is using `c :: Type` for collecting responses</span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-comment">-- from a pipelined messages. 'N' indicates depth of pipelining.</span><span>
</span><span id="line-510"></span><span>    </span><span id="Pipelined"><span class="annot"><a href="Network.TypedProtocol.Core.html#Pipelined"><span class="hs-identifier hs-var">Pipelined</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#N"><span class="hs-identifier hs-type">N</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsPipelined"><span class="hs-identifier hs-type">IsPipelined</span></a></span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span>    </span><span class="annot"><span class="hs-comment">-- | Non-pipelined peer.</span></span><span>
</span><span id="line-513"></span><span>    </span><span id="NonPipelined"><span class="annot"><a href="Network.TypedProtocol.Core.html#NonPipelined"><span class="hs-identifier hs-var">NonPipelined</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsPipelined"><span class="hs-identifier hs-type">IsPipelined</span></a></span><span>
</span><span id="line-514"></span><span>
</span><span id="line-515"></span><span class="hs-comment">-- | Type level count of the number of outstanding pipelined yields for which</span><span>
</span><span id="line-516"></span><span class="hs-comment">-- we have not yet collected a receiver result. Used to</span><span>
</span><span id="line-517"></span><span class="hs-comment">-- ensure that 'Collect' is only used when there are outstanding results to</span><span>
</span><span id="line-518"></span><span class="hs-comment">-- collect (e.g. after 'YieldPipeliend' was used);</span><span>
</span><span id="line-519"></span><span class="hs-comment">-- and to ensure that the non-pipelined primitives 'Yield', 'Await' and 'Done'</span><span>
</span><span id="line-520"></span><span class="hs-comment">-- are only used when there are none unsatisfied pipelined requests.</span><span>
</span><span id="line-521"></span><span class="hs-comment">--</span><span>
</span><span id="line-522"></span><span class="hs-keyword">type</span><span>        </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Outstanding"><span class="hs-identifier hs-type">Outstanding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsPipelined"><span class="hs-identifier hs-type">IsPipelined</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#N"><span class="hs-identifier hs-type">N</span></a></span><span>
</span><span id="line-523"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="Outstanding"><span class="annot"><a href="Network.TypedProtocol.Core.html#Outstanding"><span class="hs-identifier hs-var">Outstanding</span></a></span></span><span> </span><span id="local-6989586621679072045"><span class="annot"><a href="#local-6989586621679072045"><span class="hs-identifier hs-type">pl</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-524"></span><span>  </span><span id="Outstanding"><span class="annot"><a href="Network.TypedProtocol.Core.html#Outstanding"><span class="hs-identifier hs-var">Outstanding</span></a></span></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Network.TypedProtocol.Core.html#NonPipelined"><span class="hs-identifier hs-type">NonPipelined</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Z"><span class="hs-identifier hs-type">Z</span></a></span><span>
</span><span id="line-525"></span><span>  </span><span id="Outstanding"><span class="annot"><a href="Network.TypedProtocol.Core.html#Outstanding"><span class="hs-identifier hs-var">Outstanding</span></a></span></span><span> </span><span id="local-6989586621679072046"><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Network.TypedProtocol.Core.html#Pipelined"><span class="hs-identifier hs-type">Pipelined</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072046"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679072046"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span class="hs-comment">-- | A value level inductive natural number, indexed by the corresponding type</span><span>
</span><span id="line-528"></span><span class="hs-comment">-- level natural number 'N'.</span><span>
</span><span id="line-529"></span><span class="hs-comment">--</span><span>
</span><span id="line-530"></span><span class="hs-comment">-- This is often needed when writing pipelined peers to be able to count the</span><span>
</span><span id="line-531"></span><span class="hs-comment">-- number of outstanding pipelined yields, and show to the type checker that</span><span>
</span><span id="line-532"></span><span class="hs-comment">-- 'Network.TypedProtocol.Peer.Collect' and 'Network.TypedProtocol.Peer.Done'</span><span>
</span><span id="line-533"></span><span class="hs-comment">-- are being used correctly.</span><span>
</span><span id="line-534"></span><span class="hs-comment">--</span><span>
</span><span id="line-535"></span><span class="hs-keyword">newtype</span><span> </span><span id="Nat"><span class="annot"><a href="Network.TypedProtocol.Core.html#Nat"><span class="hs-identifier hs-var">Nat</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679071883"><span class="annot"><a href="#local-6989586621679071883"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#N"><span class="hs-identifier hs-type">N</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span id="UnsafeInt"><span class="annot"><a href="Network.TypedProtocol.Core.html#UnsafeInt"><span class="hs-identifier hs-var">UnsafeInt</span></a></span></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-536"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679072049"><span id="local-6989586621679072054"><span id="local-6989586621679072058"><span class="annot"><span class="annottext">Int -&gt; Nat n -&gt; ShowS
[Nat n] -&gt; ShowS
Nat n -&gt; String
(Int -&gt; Nat n -&gt; ShowS)
-&gt; (Nat n -&gt; String) -&gt; ([Nat n] -&gt; ShowS) -&gt; Show (Nat n)
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
forall (n :: N). Int -&gt; Nat n -&gt; ShowS
forall (n :: N). [Nat n] -&gt; ShowS
forall (n :: N). Nat n -&gt; String
$cshowsPrec :: forall (n :: N). Int -&gt; Nat n -&gt; ShowS
showsPrec :: Int -&gt; Nat n -&gt; ShowS
$cshow :: forall (n :: N). Nat n -&gt; String
show :: Nat n -&gt; String
$cshowList :: forall (n :: N). [Nat n] -&gt; ShowS
showList :: [Nat n] -&gt; ShowS
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span class="hs-keyword">data</span><span> </span><span id="IsNat"><span class="annot"><a href="Network.TypedProtocol.Core.html#IsNat"><span class="hs-identifier hs-var">IsNat</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072062"><span class="annot"><a href="#local-6989586621679072062"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#N"><span class="hs-identifier hs-type">N</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-539"></span><span>  </span><span id="IsZero"><span class="annot"><a href="Network.TypedProtocol.Core.html#IsZero"><span class="hs-identifier hs-var">IsZero</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>          </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsNat"><span class="hs-identifier hs-type">IsNat</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Z"><span class="hs-identifier hs-type">Z</span></a></span><span>
</span><span id="line-540"></span><span>  </span><span id="local-6989586621679072064"><span id="IsSucc"><span class="annot"><a href="Network.TypedProtocol.Core.html#IsSucc"><span class="hs-identifier hs-var">IsSucc</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Nat"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072064"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsNat"><span class="hs-identifier hs-type">IsNat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#S"><span class="hs-identifier hs-type">S</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072064"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-541"></span><span>
</span><span id="line-542"></span><span id="local-6989586621679071877"><span class="annot"><a href="Network.TypedProtocol.Core.html#toIsNat"><span class="hs-identifier hs-type">toIsNat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Nat"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071877"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsNat"><span class="hs-identifier hs-type">IsNat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071877"><span class="hs-identifier hs-type">n</span></a></span></span><span>
</span><span id="line-543"></span><span id="toIsNat"><span class="annot"><span class="annottext">toIsNat :: forall (n :: N). Nat n -&gt; IsNat n
</span><a href="Network.TypedProtocol.Core.html#toIsNat"><span class="hs-identifier hs-var hs-var">toIsNat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#UnsafeInt"><span class="hs-identifier hs-type">UnsafeInt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsNat 'Z -&gt; IsNat n
forall a b. a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Unsafe.Coerce.html#unsafeCoerce"><span class="hs-identifier hs-var">unsafeCoerce</span></a></span><span> </span><span class="annot"><span class="annottext">IsNat 'Z
</span><a href="Network.TypedProtocol.Core.html#IsZero"><span class="hs-identifier hs-var">IsZero</span></a></span><span>
</span><span id="line-544"></span><span class="annot"><a href="Network.TypedProtocol.Core.html#toIsNat"><span class="hs-identifier hs-var">toIsNat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#UnsafeInt"><span class="hs-identifier hs-type">UnsafeInt</span></a></span><span> </span><span id="local-6989586621679072072"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679072072"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IsNat ('S Any) -&gt; IsNat n
forall a b. a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Unsafe.Coerce.html#unsafeCoerce"><span class="hs-identifier hs-var">unsafeCoerce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat Any -&gt; IsNat ('S Any)
forall (n :: N). Nat n -&gt; IsNat ('S n)
</span><a href="Network.TypedProtocol.Core.html#IsSucc"><span class="hs-identifier hs-var">IsSucc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Nat Any
forall (n :: N). Int -&gt; Nat n
</span><a href="Network.TypedProtocol.Core.html#UnsafeInt"><span class="hs-identifier hs-var">UnsafeInt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int
forall a. Enum a =&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Enum.html#pred"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679072072"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span class="hs-keyword">pattern</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Zero"><span class="hs-identifier hs-type">Zero</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679071886"><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Z"><span class="hs-identifier hs-type">Z</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071886"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Nat"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071886"><span class="hs-identifier hs-type">n</span></a></span></span><span>
</span><span id="line-547"></span><span class="hs-keyword">pattern</span><span> </span><span id="Zero"><span id="%24mZero"><span id="%24bZero"><span class="annot"><span class="annottext">$mZero :: forall {r} {n :: N}. Nat n -&gt; (('Z ~ n) =&gt; r) -&gt; ((# #) -&gt; r) -&gt; r
$bZero :: forall (n :: N). ('Z ~ n) =&gt; Nat n
</span><a href="Network.TypedProtocol.Core.html#Zero"><span class="hs-identifier hs-var hs-var hs-var hs-var">Zero</span></a></span></span></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#toIsNat"><span class="hs-identifier hs-type">toIsNat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsZero"><span class="hs-identifier hs-type">IsZero</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-548"></span><span>  </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Zero"><span class="hs-identifier hs-var">Zero</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Nat n
forall (n :: N). Int -&gt; Nat n
</span><a href="Network.TypedProtocol.Core.html#UnsafeInt"><span class="hs-identifier hs-var">UnsafeInt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-549"></span><span>
</span><span id="line-550"></span><span class="hs-keyword">pattern</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Succ"><span class="hs-identifier hs-type">Succ</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679071889"><span id="local-6989586621679071890"><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679071889"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#S"><span class="hs-identifier hs-type">S</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071890"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Nat"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071890"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Nat"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071889"><span class="hs-identifier hs-type">m</span></a></span></span></span><span>
</span><span id="line-551"></span><span class="hs-keyword">pattern</span><span> </span><span id="Succ"><span id="%24mSucc"><span id="%24bSucc"><span class="annot"><span class="annottext">$mSucc :: forall {r} {m :: N}.
Nat m
-&gt; (forall {n :: N}. (m ~ 'S n) =&gt; Nat n -&gt; r) -&gt; ((# #) -&gt; r) -&gt; r
$bSucc :: forall (m :: N) (n :: N). (m ~ 'S n) =&gt; Nat n -&gt; Nat m
</span><a href="Network.TypedProtocol.Core.html#Succ"><span class="hs-identifier hs-var hs-var hs-var hs-var">Succ</span></a></span></span></span></span><span> </span><span class="annot"><a href="#local-6989586621679072081"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#toIsNat"><span class="hs-identifier hs-type">toIsNat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsSucc"><span class="hs-identifier hs-type">IsSucc</span></a></span><span> </span><span id="local-6989586621679072081"><span class="annot"><a href="#local-6989586621679072081"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-552"></span><span>  </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Succ"><span class="hs-identifier hs-var">Succ</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#UnsafeInt"><span class="hs-identifier hs-type">UnsafeInt</span></a></span><span> </span><span id="local-6989586621679072085"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679072085"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Nat m
forall (n :: N). Int -&gt; Nat n
</span><a href="Network.TypedProtocol.Core.html#UnsafeInt"><span class="hs-identifier hs-var">UnsafeInt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int
forall a. Enum a =&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Enum.html#succ"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679072085"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span class="hs-pragma">{-# COMPLETE</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Zero"><span class="hs-pragma hs-type">Zero</span></a></span><span class="hs-pragma">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Succ"><span class="hs-pragma hs-type">Succ</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-555"></span><span>
</span><span id="line-556"></span><span id="local-6989586621679071893"><span class="annot"><a href="Network.TypedProtocol.Core.html#natToInt"><span class="hs-identifier hs-type">natToInt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Nat"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679071893"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span></span><span>
</span><span id="line-557"></span><span id="natToInt"><span class="annot"><span class="annottext">natToInt :: forall (n :: N). Nat n -&gt; Int
</span><a href="Network.TypedProtocol.Core.html#natToInt"><span class="hs-identifier hs-var hs-var">natToInt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#UnsafeInt"><span class="hs-identifier hs-type">UnsafeInt</span></a></span><span> </span><span id="local-6989586621679072087"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679072087"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679072087"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-558"></span><span>
</span><span id="line-559"></span><span id="local-6989586621679072088"><span class="annot"><a href="Network.TypedProtocol.Core.html#unsafeIntToNat"><span class="hs-identifier hs-type">unsafeIntToNat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Nat"><span class="hs-identifier hs-type">Nat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072088"><span class="hs-identifier hs-type">n</span></a></span></span><span>
</span><span id="line-560"></span><span id="unsafeIntToNat"><span class="annot"><span class="annottext">unsafeIntToNat :: forall (n :: N). Int -&gt; Nat n
</span><a href="Network.TypedProtocol.Core.html#unsafeIntToNat"><span class="hs-identifier hs-var hs-var">unsafeIntToNat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Nat n
forall (n :: N). Int -&gt; Nat n
</span><a href="Network.TypedProtocol.Core.html#UnsafeInt"><span class="hs-identifier hs-var">UnsafeInt</span></a></span><span>
</span><span id="line-561"></span></pre></body></html>