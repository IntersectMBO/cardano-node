<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds                #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveFunctor            #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DerivingVia              #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts         #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE GADTs                    #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE PolyKinds                #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes               #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving       #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE StandaloneKindSignatures #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators            #-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-comment">-- | Protocol EDSL.</span><span>
</span><span id="line-13"></span><span class="hs-comment">--</span><span>
</span><span id="line-14"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.TypedProtocol.Peer</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier">Peer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#PeerPipelined"><span class="hs-identifier">PeerPipelined</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Receiver"><span class="hs-identifier">Receiver</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Outstanding"><span class="hs-identifier">Outstanding</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#N"><span class="hs-identifier">N</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Nat"><span class="hs-identifier">Nat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#Zero"><span class="hs-identifier">Zero</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Succ"><span class="hs-identifier">Succ</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#natToInt"><span class="hs-identifier">natToInt</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#unsafeIntToNat"><span class="hs-identifier">unsafeIntToNat</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Kind.html"><span class="hs-identifier">Data.Kind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Network.TypedProtocol.Core.html"><span class="hs-identifier">Network.TypedProtocol.Core</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Core</span></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-comment">-- | A description of a peer that engages in a protocol.</span><span>
</span><span id="line-30"></span><span class="hs-comment">--</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- __Note__: You should use pattern synonyms exposed in</span><span>
</span><span id="line-32"></span><span class="hs-comment">-- &quot;Network.TypedProtocol.Peer.Client&quot; and &quot;Network.TypedProtocol.Peer.Server&quot;,</span><span>
</span><span id="line-33"></span><span class="hs-comment">-- however here we provide in-depth documentation.</span><span>
</span><span id="line-34"></span><span class="hs-comment">--</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- The protocol describes what messages peers /may/ send or /must/ accept.</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- A particular peer implementation decides what to actually do within the</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- constraints of the protocol.</span><span>
</span><span id="line-38"></span><span class="hs-comment">--</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- Peers engage in a protocol in either the client or server role. Of course</span><span>
</span><span id="line-40"></span><span class="hs-comment">-- the client role can only interact with the serve role for the same protocol</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- and vice versa.</span><span>
</span><span id="line-42"></span><span class="hs-comment">--</span><span>
</span><span id="line-43"></span><span class="hs-comment">-- 'Peer' has several type arguments:</span><span>
</span><span id="line-44"></span><span class="hs-comment">--</span><span>
</span><span id="line-45"></span><span class="hs-comment">-- * the protocol itself;</span><span>
</span><span id="line-46"></span><span class="hs-comment">-- * the client\/server role;</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- * whether the peer is using pipelining or not, if pipelined it holds the</span><span>
</span><span id="line-48"></span><span class="hs-comment">--   depth of pipelining and a type used to collect data from pipelined</span><span>
</span><span id="line-49"></span><span class="hs-comment">--   transitions;</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- * the current protocol state;</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- * the monad in which the peer operates (e.g. 'IO');</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- * the type of the final result once the peer terminates.</span><span>
</span><span id="line-53"></span><span class="hs-comment">--</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- For example:</span><span>
</span><span id="line-55"></span><span class="hs-comment">--</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- &gt; pingPongClientExample :: Peer PingPong AsClient (Pipelined Z Int) StIdle IO ()</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- &gt; pingPongServerExample :: Peer PingPong AsServer NonPipeliend      StIdle IO Int</span><span>
</span><span id="line-58"></span><span class="hs-comment">--</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- The actions that a non-pipelining peer can take are:</span><span>
</span><span id="line-60"></span><span class="hs-comment">--</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- * to perform local monadic effects</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- * to terminate with a result (but only in a terminal protocol state)</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- * to send a message (but only in a protocol state in which we have agency)</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- * to wait to receive a message (but only in a protocol state in which the</span><span>
</span><span id="line-65"></span><span class="hs-comment">--   other peer has agency)</span><span>
</span><span id="line-66"></span><span class="hs-comment">--</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- In addition a pipelining peer can:</span><span>
</span><span id="line-68"></span><span class="hs-comment">--</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- * pipeline a message, which requires upfront declaration at which state we</span><span>
</span><span id="line-70"></span><span class="hs-comment">--   continue at and passing a receiver which will run in parallel.  When</span><span>
</span><span id="line-71"></span><span class="hs-comment">--   receiver terminates it pushes the result into the pipelining queue.</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- * collect a response from the pipelining queue.</span><span>
</span><span id="line-73"></span><span class="hs-comment">--</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- The 'Yield', 'Await', 'Done', 'YieldPipelined', 'Collect',</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- constructors require to provide an evidence that the</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- peer has agency in the current state. The types guarantee that it is not</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- possible to supply incorrect evidence,  however the</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- pattern synonyms exposed in &quot;Network.TypedProtocol.Peer.Client&quot; and</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- &quot;Network.TypedProtocol.Peer.Client&quot; supply this evidence for you, and hence</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- are easier to use and let you avoid some kinds of type errors.</span><span>
</span><span id="line-81"></span><span class="hs-comment">--</span><span>
</span><span id="line-82"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679072459"><span class="annot"><a href="#local-6989586621679072459"><span class="hs-identifier hs-type">ps</span></a></span></span><span>
</span><span id="line-83"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a></span><span>
</span><span id="line-84"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#IsPipelined"><span class="hs-identifier hs-type">IsPipelined</span></a></span><span>
</span><span id="line-85"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679072459"><span class="hs-identifier hs-type">ps</span></a></span><span>
</span><span id="line-86"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>          </span><span class="hs-comment">-- ^ monad's kind</span><span>
</span><span id="line-88"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-89"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-90"></span><span class="hs-keyword">data</span><span> </span><span id="Peer"><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-var">Peer</span></a></span></span><span> </span><span id="local-6989586621679072460"><span class="annot"><a href="#local-6989586621679072460"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679072461"><span class="annot"><a href="#local-6989586621679072461"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679072462"><span class="annot"><a href="#local-6989586621679072462"><span class="hs-identifier hs-type">pl</span></a></span></span><span> </span><span id="local-6989586621679072463"><span class="annot"><a href="#local-6989586621679072463"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679072464"><span class="annot"><a href="#local-6989586621679072464"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679072465"><span class="annot"><a href="#local-6989586621679072465"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-comment">-- | Perform a local monadic effect and then continue.</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-comment">-- Example:</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-comment">-- &gt; Effect $ do</span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-comment">-- &gt;   ...          -- actions in the monad</span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-comment">-- &gt;   return $ ... -- another Peer value</span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-100"></span><span>  </span><span id="Effect"><span class="annot"><a href="Network.TypedProtocol.Peer.html#Effect"><span class="hs-identifier hs-var">Effect</span></a></span></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679072467"><span class="annot"><a href="#local-6989586621679072467"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679072468"><span class="annot"><a href="#local-6989586621679072468"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679072469"><span class="annot"><a href="#local-6989586621679072469"><span class="hs-identifier hs-type">pl</span></a></span></span><span> </span><span id="local-6989586621679072470"><span class="annot"><a href="#local-6989586621679072470"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679072471"><span class="annot"><a href="#local-6989586621679072471"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679072472"><span class="annot"><a href="#local-6989586621679072472"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-102"></span><span>       </span><span class="annot"><a href="#local-6989586621679072471"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072467"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072468"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072469"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072470"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072471"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072472"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ monadic continuation</span></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-glyph">-&gt;</span><span>    </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072467"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072468"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072469"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072470"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072471"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072472"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-comment">-- | Send a message to the other peer and then continue. This takes the</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-comment">-- message and the continuation. It also requires evidence that we have</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-comment">-- agency for this protocol state and thus are allowed to send messages.</span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-comment">-- Example:</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-comment">-- &gt; Yield ReflClientAgency MsgPing $ ...</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-114"></span><span>  </span><span id="Yield"><span class="annot"><a href="Network.TypedProtocol.Peer.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679072473"><span class="annot"><a href="#local-6989586621679072473"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679072474"><span class="annot"><a href="#local-6989586621679072474"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679072475"><span class="annot"><a href="#local-6989586621679072475"><span class="hs-identifier hs-type">pl</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072476"><span class="annot"><a href="#local-6989586621679072476"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679072473"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072477"><span class="annot"><a href="#local-6989586621679072477"><span class="hs-identifier hs-type">st'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679072473"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679072478"><span class="annot"><a href="#local-6989586621679072478"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679072479"><span class="annot"><a href="#local-6989586621679072479"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-116"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateTokenI"><span class="hs-identifier hs-type">StateTokenI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072476"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-117"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateTokenI"><span class="hs-identifier hs-type">StateTokenI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072477"><span class="hs-identifier hs-type">st'</span></a></span><span>
</span><span id="line-118"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveState"><span class="hs-identifier hs-type">ActiveState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072476"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-119"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Outstanding"><span class="hs-identifier hs-type">Outstanding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072475"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Z"><span class="hs-identifier hs-type">Z</span></a></span><span>
</span><span id="line-120"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#WeHaveAgencyProof"><span class="hs-identifier hs-type">WeHaveAgencyProof</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072474"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072476"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ agency proof</span></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072473"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072476"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072477"><span class="hs-identifier hs-type">st'</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ protocol message</span></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072473"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072474"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072475"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072477"><span class="hs-identifier hs-type">st'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072478"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072479"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ continuation</span></span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072473"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072474"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072475"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072476"><span class="hs-identifier hs-type">st</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679072478"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072479"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span>  </span><span class="hs-comment">-- | Waits to receive a message from the other peer and then continues.</span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-comment">-- This takes the continuation that is supplied with the received message. It</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-comment">-- also requires evidence that the other peer has agency for this protocol</span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-comment">-- state and thus we are expected to wait to receive messages.</span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-comment">-- Note that the continuation that gets supplied with the message must be</span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-comment">-- prepared to deal with /any/ message that is allowed in /this/ protocol</span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-comment">-- state. This is why the continuation /must/ be polymorphic in the target</span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-comment">-- state of the message (the third type argument of 'Message').</span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-comment">-- Example:</span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-comment">-- &gt; Await ReflClientAgency $ \msg -&gt;</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-comment">-- &gt; case msg of</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-comment">-- &gt;   MsgDone -&gt; ...</span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-comment">-- &gt;   MsgPing -&gt; ...</span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-146"></span><span>  </span><span id="Await"><span class="annot"><a href="Network.TypedProtocol.Peer.html#Await"><span class="hs-identifier hs-var">Await</span></a></span></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679072482"><span class="annot"><a href="#local-6989586621679072482"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679072483"><span class="annot"><a href="#local-6989586621679072483"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679072484"><span class="annot"><a href="#local-6989586621679072484"><span class="hs-identifier hs-type">pl</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072485"><span class="annot"><a href="#local-6989586621679072485"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679072482"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679072486"><span class="annot"><a href="#local-6989586621679072486"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679072487"><span class="annot"><a href="#local-6989586621679072487"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-148"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateTokenI"><span class="hs-identifier hs-type">StateTokenI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072485"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-149"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveState"><span class="hs-identifier hs-type">ActiveState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072485"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-150"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Outstanding"><span class="hs-identifier hs-type">Outstanding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072484"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Z"><span class="hs-identifier hs-type">Z</span></a></span><span>
</span><span id="line-151"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#TheyHaveAgencyProof"><span class="hs-identifier hs-type">TheyHaveAgencyProof</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072483"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072485"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ agency proof</span></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072489"><span class="annot"><a href="#local-6989586621679072489"><span class="hs-identifier hs-type">st'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679072482"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072482"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072485"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072489"><span class="hs-identifier hs-type">st'</span></a></span><span>
</span><span id="line-155"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072482"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072483"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072484"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072489"><span class="hs-identifier hs-type">st'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072486"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072487"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ continuation</span></span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span>     </span><span class="annot"><a href="#local-6989586621679072482"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072483"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072484"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072485"><span class="hs-identifier hs-type">st</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679072486"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072487"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-comment">-- | Terminate with a result. A state token must be provided from the</span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-comment">-- 'NobodyHasAgency' states, to show that this is a state in which we can</span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-comment">-- terminate.</span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-comment">-- Example:</span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-comment">-- &gt; Yield ReflClientAgency</span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-comment">-- &gt;        MsgDone</span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-comment">-- &gt;       (Done ReflNobodyAgency TokDone result)</span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-169"></span><span>  </span><span id="Done"><span class="annot"><a href="Network.TypedProtocol.Peer.html#Done"><span class="hs-identifier hs-var">Done</span></a></span></span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679072491"><span class="annot"><a href="#local-6989586621679072491"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679072492"><span class="annot"><a href="#local-6989586621679072492"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679072493"><span class="annot"><a href="#local-6989586621679072493"><span class="hs-identifier hs-type">pl</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072494"><span class="annot"><a href="#local-6989586621679072494"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679072491"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679072495"><span class="annot"><a href="#local-6989586621679072495"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679072496"><span class="annot"><a href="#local-6989586621679072496"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-171"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateTokenI"><span class="hs-identifier hs-type">StateTokenI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072494"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-172"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateAgency"><span class="hs-identifier hs-type">StateAgency</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072494"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyAgency"><span class="hs-identifier hs-type">NobodyAgency</span></a></span><span>
</span><span id="line-173"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Outstanding"><span class="hs-identifier hs-type">Outstanding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072493"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Z"><span class="hs-identifier hs-type">Z</span></a></span><span>
</span><span id="line-174"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#NobodyHasAgencyProof"><span class="hs-identifier hs-type">NobodyHasAgencyProof</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072492"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072494"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-176"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ (no) agency proof</span></span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679072496"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ returned value</span></span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072491"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072492"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072493"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072494"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072495"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072496"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-comment">-- Pipelining primitives</span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-comment">-- | Pipelined send.  We statically decide from which state we continue (the</span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-comment">-- `st''` state here), the gap (between `st'` and `st''`) must be fulfilled</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-comment">-- by 'Receiver' which runs will run in parallel.</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-189"></span><span>  </span><span id="YieldPipelined"><span class="annot"><a href="Network.TypedProtocol.Peer.html#YieldPipelined"><span class="hs-identifier hs-var">YieldPipelined</span></a></span></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679072498"><span class="annot"><a href="#local-6989586621679072498"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679072499"><span class="annot"><a href="#local-6989586621679072499"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072500"><span class="annot"><a href="#local-6989586621679072500"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679072498"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072501"><span class="annot"><a href="#local-6989586621679072501"><span class="hs-identifier hs-type">st'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679072498"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679072502"><span class="annot"><a href="#local-6989586621679072502"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span id="local-6989586621679072503"><span class="annot"><a href="#local-6989586621679072503"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span id="local-6989586621679072504"><span class="annot"><a href="#local-6989586621679072504"><span class="hs-identifier hs-type">st''</span></a></span></span><span> </span><span id="local-6989586621679072505"><span class="annot"><a href="#local-6989586621679072505"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679072506"><span class="annot"><a href="#local-6989586621679072506"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-191"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateTokenI"><span class="hs-identifier hs-type">StateTokenI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072500"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-192"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateTokenI"><span class="hs-identifier hs-type">StateTokenI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072501"><span class="hs-identifier hs-type">st'</span></a></span><span>
</span><span id="line-193"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveState"><span class="hs-identifier hs-type">ActiveState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072500"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-194"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#WeHaveAgencyProof"><span class="hs-identifier hs-type">WeHaveAgencyProof</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072499"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072500"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ agency proof</span></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072498"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072500"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072501"><span class="hs-identifier hs-type">st'</span></a></span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ protocol message</span></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Receiver"><span class="hs-identifier hs-type">Receiver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072498"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072499"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072501"><span class="hs-identifier hs-type">st'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072504"><span class="hs-identifier hs-type">st''</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072502"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ receiver</span></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072498"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072499"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#Pipelined"><span class="hs-identifier hs-type">Pipelined</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#S"><span class="hs-identifier hs-type">S</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072503"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679072502"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679072504"><span class="hs-identifier hs-type">st''</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072506"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ continuation from state `st''`</span></span><span>
</span><span id="line-203"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072498"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072499"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#Pipelined"><span class="hs-identifier hs-type">Pipelined</span></a></span><span>    </span><span class="annot"><a href="#local-6989586621679072503"><span class="hs-identifier hs-type">n</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679072502"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>   </span><span class="annot"><a href="#local-6989586621679072500"><span class="hs-identifier hs-type">st</span></a></span><span>   </span><span class="annot"><a href="#local-6989586621679072505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072506"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-comment">-- | Collect results returned by a `Receiver`.  Results are collected in the</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-comment">-- first-in-first-out way.</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-208"></span><span>  </span><span id="Collect"><span class="annot"><a href="Network.TypedProtocol.Peer.html#Collect"><span class="hs-identifier hs-var">Collect</span></a></span></span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679072507"><span class="annot"><a href="#local-6989586621679072507"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679072508"><span class="annot"><a href="#local-6989586621679072508"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679072509"><span class="annot"><a href="#local-6989586621679072509"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span id="local-6989586621679072510"><span class="annot"><a href="#local-6989586621679072510"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span id="local-6989586621679072511"><span class="annot"><a href="#local-6989586621679072511"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679072512"><span class="annot"><a href="#local-6989586621679072512"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679072513"><span class="annot"><a href="#local-6989586621679072513"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-210"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateTokenI"><span class="hs-identifier hs-type">StateTokenI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072511"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-211"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveState"><span class="hs-identifier hs-type">ActiveState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072511"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-212"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072507"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072508"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#Pipelined"><span class="hs-identifier hs-type">Pipelined</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#S"><span class="hs-identifier hs-type">S</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072510"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679072509"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679072511"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072512"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072513"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ continuation, executed if no message has arrived so far</span></span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679072509"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072507"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072508"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#Pipelined"><span class="hs-identifier hs-type">Pipelined</span></a></span><span>    </span><span class="annot"><a href="#local-6989586621679072510"><span class="hs-identifier hs-type">n</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679072509"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>  </span><span class="annot"><a href="#local-6989586621679072511"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072512"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072513"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ continuation</span></span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span>        </span><span class="annot"><a href="#local-6989586621679072507"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072508"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#Pipelined"><span class="hs-identifier hs-type">Pipelined</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#S"><span class="hs-identifier hs-type">S</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072510"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679072509"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679072511"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072512"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072513"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span id="local-6989586621679072322"><span id="local-6989586621679072323"><span id="local-6989586621679072324"><span id="local-6989586621679072325"><span id="local-6989586621679072326"><span id="local-6989586621679072515"><span id="local-6989586621679072519"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Functor"><span class="hs-identifier hs-type">Functor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072323"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Functor"><span class="hs-identifier hs-type">Functor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072322"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072324"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072325"><span class="hs-identifier hs-type">pl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072326"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072323"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span class="hs-comment">-- | Receiver.  It is limited to only awaiting for messages and running monadic</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- computations.  This means that one can only pipeline messages if they can be</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- connected by state transitions which all have remote agency.</span><span>
</span><span id="line-225"></span><span class="hs-comment">--</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- The receiver runs in parallel, see `runPipelinedPeerWithDriver`.  This makes</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- pipelining quite effective, since the receiver callbacks are called in</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- a separate thread which can effectively use CPU cache and can avoids</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- unnecessary context switches.</span><span>
</span><span id="line-230"></span><span class="hs-comment">--</span><span>
</span><span id="line-231"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Receiver"><span class="hs-identifier hs-type">Receiver</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679072523"><span class="annot"><a href="#local-6989586621679072523"><span class="hs-identifier hs-type">ps</span></a></span></span><span>
</span><span id="line-232"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#PeerRole"><span class="hs-identifier hs-type">PeerRole</span></a></span><span>
</span><span id="line-233"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679072523"><span class="hs-identifier hs-type">ps</span></a></span><span>
</span><span id="line-234"></span><span>              </span><span class="hs-comment">-- ^ initial state</span><span>
</span><span id="line-235"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679072523"><span class="hs-identifier hs-type">ps</span></a></span><span>
</span><span id="line-236"></span><span>              </span><span class="hs-comment">-- ^ final state</span><span>
</span><span id="line-237"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>              </span><span class="hs-comment">-- ^ monad</span><span>
</span><span id="line-239"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-240"></span><span>              </span><span class="hs-comment">-- ^ returned type by the receiver</span><span>
</span><span id="line-241"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-242"></span><span class="hs-keyword">data</span><span> </span><span id="Receiver"><span class="annot"><a href="Network.TypedProtocol.Peer.html#Receiver"><span class="hs-identifier hs-var">Receiver</span></a></span></span><span> </span><span id="local-6989586621679072524"><span class="annot"><a href="#local-6989586621679072524"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679072525"><span class="annot"><a href="#local-6989586621679072525"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679072526"><span class="annot"><a href="#local-6989586621679072526"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679072527"><span class="annot"><a href="#local-6989586621679072527"><span class="hs-identifier hs-type">stdone</span></a></span></span><span> </span><span id="local-6989586621679072528"><span class="annot"><a href="#local-6989586621679072528"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679072529"><span class="annot"><a href="#local-6989586621679072529"><span class="hs-identifier hs-type">c</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-comment">-- | Execute a monadic computation.</span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-246"></span><span>  </span><span id="local-6989586621679072530"><span id="local-6989586621679072531"><span id="local-6989586621679072532"><span id="local-6989586621679072533"><span id="local-6989586621679072534"><span id="local-6989586621679072535"><span id="ReceiverEffect"><span class="annot"><a href="Network.TypedProtocol.Peer.html#ReceiverEffect"><span class="hs-identifier hs-var">ReceiverEffect</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679072530"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Receiver"><span class="hs-identifier hs-type">Receiver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072531"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072532"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072533"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072534"><span class="hs-identifier hs-type">stdone</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072530"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072535"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span>    </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Receiver"><span class="hs-identifier hs-type">Receiver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072531"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072532"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072533"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072534"><span class="hs-identifier hs-type">stdone</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072530"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072535"><span class="hs-identifier hs-type">c</span></a></span></span></span></span></span></span></span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-comment">-- | Return value.</span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-251"></span><span>  </span><span id="local-6989586621679072537"><span id="local-6989586621679072538"><span id="local-6989586621679072539"><span id="local-6989586621679072540"><span id="local-6989586621679072541"><span id="ReceiverDone"><span class="annot"><a href="Network.TypedProtocol.Peer.html#ReceiverDone"><span class="hs-identifier hs-var">ReceiverDone</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679072537"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Receiver"><span class="hs-identifier hs-type">Receiver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072538"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072539"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072540"><span class="hs-identifier hs-type">stdone</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072540"><span class="hs-identifier hs-type">stdone</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072541"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072537"><span class="hs-identifier hs-type">c</span></a></span></span></span></span></span></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-comment">-- | Await for for a remote transition.</span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-255"></span><span>  </span><span id="local-6989586621679072543"><span id="local-6989586621679072544"><span id="local-6989586621679072545"><span id="local-6989586621679072546"><span id="local-6989586621679072547"><span id="local-6989586621679072548"><span id="ReceiverAwait"><span class="annot"><a href="Network.TypedProtocol.Peer.html#ReceiverAwait"><span class="hs-identifier hs-var">ReceiverAwait</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#StateTokenI"><span class="hs-identifier hs-type">StateTokenI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072543"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-256"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#ActiveState"><span class="hs-identifier hs-type">ActiveState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072543"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-257"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#TheyHaveAgencyProof"><span class="hs-identifier hs-type">TheyHaveAgencyProof</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072544"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072543"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-259"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679072550"><span class="annot"><a href="#local-6989586621679072550"><span class="hs-identifier hs-type">st'</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072545"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072543"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072550"><span class="hs-identifier hs-type">st'</span></a></span><span>
</span><span id="line-260"></span><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Receiver"><span class="hs-identifier hs-type">Receiver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072545"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072544"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072550"><span class="hs-identifier hs-type">st'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072546"><span class="hs-identifier hs-type">stdone</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072547"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072548"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Receiver"><span class="hs-identifier hs-type">Receiver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072545"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072544"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072543"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072546"><span class="hs-identifier hs-type">stdone</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072547"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072548"><span class="hs-identifier hs-type">c</span></a></span></span></span></span></span></span></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span id="local-6989586621679072327"><span id="local-6989586621679072328"><span id="local-6989586621679072329"><span id="local-6989586621679072330"><span id="local-6989586621679072331"><span id="local-6989586621679072552"><span id="local-6989586621679072556"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Functor"><span class="hs-identifier hs-type">Functor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072328"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Functor"><span class="hs-identifier hs-type">Functor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Receiver"><span class="hs-identifier hs-type">Receiver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072327"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072329"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072330"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072331"><span class="hs-identifier hs-type">stdone</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072328"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="hs-comment">-- | A description of a peer that engages in a protocol in a pipelined fashion.</span><span>
</span><span id="line-266"></span><span class="hs-comment">--</span><span>
</span><span id="line-267"></span><span class="hs-comment">-- This type is useful for wrapping pipelined peers to hide information which</span><span>
</span><span id="line-268"></span><span class="hs-comment">-- is only relevant in peer lift.  It is expected by</span><span>
</span><span id="line-269"></span><span class="hs-comment">-- `Network.TypedProtocol.Driver.runPeerPipelinedWithDriver`.</span><span>
</span><span id="line-270"></span><span class="hs-comment">--</span><span>
</span><span id="line-271"></span><span class="hs-keyword">data</span><span> </span><span id="PeerPipelined"><span class="annot"><a href="Network.TypedProtocol.Peer.html#PeerPipelined"><span class="hs-identifier hs-var">PeerPipelined</span></a></span></span><span> </span><span id="local-6989586621679072559"><span class="annot"><a href="#local-6989586621679072559"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679072560"><span class="annot"><a href="#local-6989586621679072560"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072561"><span class="annot"><a href="#local-6989586621679072561"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679072559"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679072562"><span class="annot"><a href="#local-6989586621679072562"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679072563"><span class="annot"><a href="#local-6989586621679072563"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621679072564"><span id="local-6989586621679072565"><span id="local-6989586621679072566"><span id="local-6989586621679072567"><span id="local-6989586621679072568"><span id="local-6989586621679072569"><span id="PeerPipelined"><span class="annot"><a href="Network.TypedProtocol.Peer.html#PeerPipelined"><span class="hs-identifier hs-var">PeerPipelined</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">{</span><span> </span><span id="runPeerPipelined"><span class="annot"><span class="annottext">()
</span><a href="Network.TypedProtocol.Peer.html#runPeerPipelined"><span class="hs-identifier hs-var hs-var">runPeerPipelined</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072564"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072565"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Core.html#Pipelined"><span class="hs-identifier hs-type">Pipelined</span></a></span><span> </span><span class="annot"><a href="Network.TypedProtocol.Core.html#Z"><span class="hs-identifier hs-type">Z</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072566"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679072567"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072568"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072569"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-273"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Peer.html#PeerPipelined"><span class="hs-identifier hs-type">PeerPipelined</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072564"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072565"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072567"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072568"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072569"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span></span></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span id="local-6989586621679072333"><span id="local-6989586621679072334"><span id="local-6989586621679072335"><span id="local-6989586621679072336"><span id="local-6989586621679072573"><span id="local-6989586621679072575"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Functor"><span class="hs-identifier hs-type">Functor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072334"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Functor"><span class="hs-identifier hs-type">Functor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Peer.html#PeerPipelined"><span class="hs-identifier hs-type">PeerPipelined</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072333"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072335"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072336"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072334"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span><span>
</span><span id="line-276"></span></pre></body></html>