<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE GADTs #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Trace.Forward.Utils.TraceObject</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Trace.Forward.Utils.TraceObject.html#initForwardSink"><span class="hs-identifier">initForwardSink</span></a></span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Trace.Forward.Utils.TraceObject.html#writeToSink"><span class="hs-identifier">writeToSink</span></a></span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Trace.Forward.Utils.TraceObject.html#readFromSink"><span class="hs-identifier">readFromSink</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Trace.Forward.Utils.TraceObject.html#getTraceObjectsFromReply"><span class="hs-identifier">getTraceObjectsFromReply</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.html"><span class="hs-identifier">Control.Concurrent.STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Conc.Sync.html#STM"><span class="hs-identifier">STM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Conc.Sync.html#atomically"><span class="hs-identifier">atomically</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Conc.Sync.html#retry"><span class="hs-identifier">retry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html"><span class="hs-identifier">Control.Concurrent.STM.TBQueue</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#TBQueue"><span class="hs-identifier">TBQueue</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#newTBQueue"><span class="hs-identifier">newTBQueue</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#isFullTBQueue"><span class="hs-identifier">isFullTBQueue</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#lengthTBQueue"><span class="hs-identifier">lengthTBQueue</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#readTBQueue"><span class="hs-identifier">readTBQueue</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#writeTBQueue"><span class="hs-identifier">writeTBQueue</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#flushTBQueue"><span class="hs-identifier">flushTBQueue</span></a></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Control.Monad.html#replicateM"><span class="hs-identifier">replicateM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Word.html#Word16"><span class="hs-identifier">Word16</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Trace.Forward.Configuration.TraceObject.html"><span class="hs-identifier">Trace.Forward.Configuration.TraceObject</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Trace.Forward.Protocol.TraceObject.Forwarder.html"><span class="hs-identifier">Trace.Forward.Protocol.TraceObject.Forwarder</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Forwarder</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Trace.Forward.Protocol.TraceObject.Type.html"><span class="hs-identifier">Trace.Forward.Protocol.TraceObject.Type</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Trace.Forward.Utils.ForwardSink.html"><span class="hs-identifier">Trace.Forward.Utils.ForwardSink</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Trace.Forward.Utils.ForwardSink.html#ForwardSink"><span class="hs-identifier">ForwardSink</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span id="local-6989586621679137802"><span class="annot"><a href="Trace.Forward.Utils.TraceObject.html#initForwardSink"><span class="hs-identifier hs-type">initForwardSink</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Trace.Forward.Configuration.TraceObject.html#ForwarderConfiguration"><span class="hs-identifier hs-type">ForwarderConfiguration</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679137802"><span class="hs-identifier hs-type">lo</span></a></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679137802"><span class="hs-identifier hs-type">lo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Trace.Forward.Utils.ForwardSink.html#ForwardSink"><span class="hs-identifier hs-type">ForwardSink</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679137802"><span class="hs-identifier hs-type">lo</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-41"></span><span id="initForwardSink"><span class="annot"><span class="annottext">initForwardSink :: forall lo.
ForwarderConfiguration lo -&gt; ([lo] -&gt; IO ()) -&gt; IO (ForwardSink lo)
</span><a href="Trace.Forward.Utils.TraceObject.html#initForwardSink"><span class="hs-identifier hs-var hs-var">initForwardSink</span></a></span></span><span> </span><span class="annot"><a href="Trace.Forward.Configuration.TraceObject.html#ForwarderConfiguration"><span class="hs-identifier hs-type">ForwarderConfiguration</span></a></span><span class="hs-special">{</span><span id="local-6989586621679137885"><span class="annot"><span class="annottext">Word
queueSize :: Word
queueSize :: forall lo. ForwarderConfiguration lo -&gt; Word
</span><a href="#local-6989586621679137885"><span class="hs-identifier hs-var hs-var">queueSize</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679137887"><span class="annot"><span class="annottext">[lo] -&gt; IO ()
</span><a href="#local-6989586621679137887"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-comment">-- Initially we always create a big queue, because during node's start</span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-comment">-- the number of tracing items may be very big.</span><span>
</span><span id="line-44"></span><span>  </span><span id="local-6989586621679137888"><span class="annot"><span class="annottext">TBQueue lo
</span><a href="#local-6989586621679137888"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TBQueue lo) -&gt; IO (TBQueue lo)
forall a. STM a -&gt; IO a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Conc.Sync.html#atomically"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (TBQueue lo) -&gt; IO (TBQueue lo))
-&gt; STM (TBQueue lo) -&gt; IO (TBQueue lo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; STM (TBQueue lo)
forall a. Natural -&gt; STM (TBQueue a)
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#newTBQueue"><span class="hs-identifier hs-var">newTBQueue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; Natural
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679137885"><span class="hs-identifier hs-var">queueSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>  </span><span class="annot"><span class="annottext">ForwardSink lo -&gt; IO (ForwardSink lo)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ForwardSink lo -&gt; IO (ForwardSink lo))
-&gt; ForwardSink lo -&gt; IO (ForwardSink lo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Trace.Forward.Utils.ForwardSink.html#ForwardSink"><span class="hs-identifier hs-type">ForwardSink</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">forwardQueue :: TBQueue lo
</span><a href="Trace.Forward.Utils.ForwardSink.html#forwardQueue"><span class="hs-identifier hs-var">forwardQueue</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TBQueue lo
</span><a href="#local-6989586621679137888"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">overflowCallback :: [lo] -&gt; IO ()
</span><a href="Trace.Forward.Utils.ForwardSink.html#overflowCallback"><span class="hs-identifier hs-var">overflowCallback</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[lo] -&gt; IO ()
</span><a href="#local-6989586621679137887"><span class="hs-identifier hs-var">callback</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span id="local-6989586621679137818"><span class="annot"><a href="Trace.Forward.Utils.TraceObject.html#writeToSink"><span class="hs-identifier hs-type">writeToSink</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Trace.Forward.Utils.ForwardSink.html#ForwardSink"><span class="hs-identifier hs-type">ForwardSink</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679137818"><span class="hs-identifier hs-type">lo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679137818"><span class="hs-identifier hs-type">lo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-53"></span><span id="writeToSink"><span class="annot"><span class="annottext">writeToSink :: forall lo. ForwardSink lo -&gt; lo -&gt; IO ()
</span><a href="Trace.Forward.Utils.TraceObject.html#writeToSink"><span class="hs-identifier hs-var hs-var">writeToSink</span></a></span></span><span> </span><span class="annot"><a href="Trace.Forward.Utils.ForwardSink.html#ForwardSink"><span class="hs-identifier hs-type">ForwardSink</span></a></span><span class="hs-special">{</span><span id="local-6989586621679137895"><span class="annot"><span class="annottext">TBQueue lo
forwardQueue :: forall lo. ForwardSink lo -&gt; TBQueue lo
forwardQueue :: TBQueue lo
</span><a href="Trace.Forward.Utils.ForwardSink.html#forwardQueue"><span class="hs-identifier hs-var hs-var">forwardQueue</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679137896"><span class="annot"><span class="annottext">[lo] -&gt; IO ()
overflowCallback :: forall lo. ForwardSink lo -&gt; [lo] -&gt; IO ()
overflowCallback :: [lo] -&gt; IO ()
</span><a href="Trace.Forward.Utils.ForwardSink.html#overflowCallback"><span class="hs-identifier hs-var hs-var">overflowCallback</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679137897"><span class="annot"><span class="annottext">lo
</span><a href="#local-6989586621679137897"><span class="hs-identifier hs-var">traceObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-54"></span><span>  </span><span id="local-6989586621679137898"><span class="annot"><span class="annottext">[lo]
</span><a href="#local-6989586621679137898"><span class="hs-identifier hs-var">flushedTraceObjects</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM [lo] -&gt; IO [lo]
forall a. STM a -&gt; IO a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Conc.Sync.html#atomically"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM [lo] -&gt; IO [lo]) -&gt; STM [lo] -&gt; IO [lo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue lo -&gt; lo -&gt; STM [lo]
forall lo. TBQueue lo -&gt; lo -&gt; STM [lo]
</span><a href="Trace.Forward.Utils.TraceObject.html#writeToSinkSTM"><span class="hs-identifier hs-var">writeToSinkSTM</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue lo
</span><a href="#local-6989586621679137895"><span class="hs-identifier hs-var">forwardQueue</span></a></span><span> </span><span class="annot"><span class="annottext">lo
</span><a href="#local-6989586621679137897"><span class="hs-identifier hs-var">traceObject</span></a></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-comment">-- The overflow callback last, outside of `atomically`.</span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[lo]
</span><a href="#local-6989586621679137898"><span class="hs-identifier hs-var">flushedTraceObjects</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-comment">-- Don't call the overflow function with an empty list.</span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><span class="annottext">[lo]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[lo] -&gt; IO ()
</span><a href="#local-6989586621679137896"><span class="hs-identifier hs-var">overflowCallback</span></a></span><span> </span><span class="annot"><span class="annottext">[lo]
</span><a href="#local-6989586621679137898"><span class="hs-identifier hs-var">flushedTraceObjects</span></a></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span id="local-6989586621679137822"><span class="annot"><a href="Trace.Forward.Utils.TraceObject.html#writeToSinkSTM"><span class="hs-identifier hs-type">writeToSinkSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#TBQueue"><span class="hs-identifier hs-type">TBQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679137822"><span class="hs-identifier hs-type">lo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679137822"><span class="hs-identifier hs-type">lo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Conc.Sync.html#STM"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679137822"><span class="hs-identifier hs-type">lo</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-62"></span><span id="writeToSinkSTM"><span class="annot"><span class="annottext">writeToSinkSTM :: forall lo. TBQueue lo -&gt; lo -&gt; STM [lo]
</span><a href="Trace.Forward.Utils.TraceObject.html#writeToSinkSTM"><span class="hs-identifier hs-var hs-var">writeToSinkSTM</span></a></span></span><span> </span><span id="local-6989586621679137907"><span class="annot"><span class="annottext">TBQueue lo
</span><a href="#local-6989586621679137907"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679137908"><span class="annot"><span class="annottext">lo
</span><a href="#local-6989586621679137908"><span class="hs-identifier hs-var">traceObject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-comment">---------- STM transaction: start ----------</span><span>
</span><span id="line-64"></span><span>    </span><span id="local-6989586621679137909"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679137909"><span class="hs-identifier hs-var">isFull</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TBQueue lo -&gt; STM Bool
forall a. TBQueue a -&gt; STM Bool
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#isFullTBQueue"><span class="hs-identifier hs-var">isFullTBQueue</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue lo
</span><a href="#local-6989586621679137907"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679137910"><span class="annot"><span class="annottext">[lo]
</span><a href="#local-6989586621679137910"><span class="hs-identifier hs-var">flushedTraceObjects</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679137909"><span class="hs-identifier hs-var">isFull</span></a></span><span>
</span><span id="line-66"></span><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TBQueue lo -&gt; STM [lo]
forall a. TBQueue a -&gt; STM [a]
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#flushTBQueue"><span class="hs-identifier hs-var">flushTBQueue</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue lo
</span><a href="#local-6989586621679137907"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-67"></span><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[lo] -&gt; STM [lo]
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-68"></span><span>    </span><span class="annot"><span class="annottext">TBQueue lo -&gt; lo -&gt; STM ()
forall a. TBQueue a -&gt; a -&gt; STM ()
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#writeTBQueue"><span class="hs-identifier hs-var">writeTBQueue</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue lo
</span><a href="#local-6989586621679137907"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">lo
</span><a href="#local-6989586621679137908"><span class="hs-identifier hs-var">traceObject</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><span class="annottext">[lo] -&gt; STM [lo]
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">[lo]
</span><a href="#local-6989586621679137910"><span class="hs-identifier hs-var">flushedTraceObjects</span></a></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-comment">---------- STM transaction: end ----------</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span id="local-6989586621679137830"><span class="annot"><a href="Trace.Forward.Utils.TraceObject.html#readFromSink"><span class="hs-identifier hs-type">readFromSink</span></a></span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Trace.Forward.Utils.ForwardSink.html#ForwardSink"><span class="hs-identifier hs-type">ForwardSink</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679137830"><span class="hs-identifier hs-type">lo</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ The sink contains the queue we read 'TraceObject's from.</span></span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Trace.Forward.Protocol.TraceObject.Forwarder.html#TraceObjectForwarder"><span class="hs-identifier hs-type">Forwarder.TraceObjectForwarder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679137830"><span class="hs-identifier hs-type">lo</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-77"></span><span id="readFromSink"><span class="annot"><span class="annottext">readFromSink :: forall lo. ForwardSink lo -&gt; TraceObjectForwarder lo IO ()
</span><a href="Trace.Forward.Utils.TraceObject.html#readFromSink"><span class="hs-identifier hs-var hs-var">readFromSink</span></a></span></span><span> </span><span class="annot"><a href="Trace.Forward.Utils.ForwardSink.html#ForwardSink"><span class="hs-identifier hs-type">ForwardSink</span></a></span><span class="hs-special">{</span><span id="local-6989586621679137912"><span class="annot"><span class="annottext">TBQueue lo
forwardQueue :: forall lo. ForwardSink lo -&gt; TBQueue lo
forwardQueue :: TBQueue lo
</span><a href="Trace.Forward.Utils.ForwardSink.html#forwardQueue"><span class="hs-identifier hs-var hs-var">forwardQueue</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-78"></span><span>  </span><span class="annot"><a href="Trace.Forward.Protocol.TraceObject.Forwarder.html#TraceObjectForwarder"><span class="hs-identifier hs-type">Forwarder.TraceObjectForwarder</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">recvMsgTraceObjectsRequest :: forall (blocking :: StBlockingStyle).
TokBlockingStyle blocking
-&gt; NumberOfTraceObjects -&gt; IO (BlockingReplyList blocking lo)
</span><a href="Trace.Forward.Protocol.TraceObject.Forwarder.html#recvMsgTraceObjectsRequest"><span class="hs-identifier hs-var">Forwarder.recvMsgTraceObjectsRequest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679137917"><span class="annot"><span class="annottext">TokBlockingStyle blocking
</span><a href="#local-6989586621679137917"><span class="hs-identifier hs-var">blocking</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Trace.Forward.Protocol.TraceObject.Type.html#NumberOfTraceObjects"><span class="hs-identifier hs-type">NumberOfTraceObjects</span></a></span><span> </span><span id="local-6989586621679137919"><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679137919"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-80"></span><span>        </span><span class="hs-comment">-- Handle response format outside of `atomically`.</span><span>
</span><span id="line-81"></span><span>        </span><span id="local-6989586621679137920"><span class="annot"><span class="annottext">[lo]
</span><a href="#local-6989586621679137920"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM [lo] -&gt; IO [lo]
forall a. STM a -&gt; IO a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Conc.Sync.html#atomically"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM [lo] -&gt; IO [lo]) -&gt; STM [lo] -&gt; IO [lo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue lo -&gt; TokBlockingStyle blocking -&gt; Word16 -&gt; STM [lo]
forall lo (blocking :: StBlockingStyle).
TBQueue lo -&gt; TokBlockingStyle blocking -&gt; Word16 -&gt; STM [lo]
</span><a href="Trace.Forward.Utils.TraceObject.html#readFromSinkSTM"><span class="hs-identifier hs-var">readFromSinkSTM</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue lo
</span><a href="#local-6989586621679137912"><span class="hs-identifier hs-var">forwardQueue</span></a></span><span> </span><span class="annot"><span class="annottext">TokBlockingStyle blocking
</span><a href="#local-6989586621679137917"><span class="hs-identifier hs-var">blocking</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679137919"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-82"></span><span>        </span><span class="annot"><span class="annottext">BlockingReplyList blocking lo -&gt; IO (BlockingReplyList blocking lo)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockingReplyList blocking lo
 -&gt; IO (BlockingReplyList blocking lo))
-&gt; BlockingReplyList blocking lo
-&gt; IO (BlockingReplyList blocking lo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TokBlockingStyle blocking
</span><a href="#local-6989586621679137917"><span class="hs-identifier hs-var">blocking</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-83"></span><span>                 </span><span class="annot"><span class="annottext">TokBlockingStyle blocking
</span><a href="Trace.Forward.Protocol.TraceObject.Type.html#TokBlocking"><span class="hs-identifier hs-var">TokBlocking</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NonEmpty lo -&gt; BlockingReplyList 'StBlocking lo
forall lo. NonEmpty lo -&gt; BlockingReplyList 'StBlocking lo
</span><a href="Trace.Forward.Protocol.TraceObject.Type.html#BlockingReply"><span class="hs-identifier hs-var">BlockingReply</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmpty lo -&gt; BlockingReplyList 'StBlocking lo)
-&gt; NonEmpty lo -&gt; BlockingReplyList 'StBlocking lo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-84"></span><span>                                     </span><span class="hs-comment">-- Convert to a non-empty list.</span><span>
</span><span id="line-85"></span><span>                                     </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[lo]
</span><a href="#local-6989586621679137920"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-86"></span><span>                                       </span><span class="hs-special">(</span><span id="local-6989586621679137929"><span class="annot"><span class="annottext">lo
</span><a href="#local-6989586621679137929"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679137930"><span class="annot"><span class="annottext">[lo]
</span><a href="#local-6989586621679137930"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">lo
</span><a href="#local-6989586621679137929"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">lo -&gt; [lo] -&gt; NonEmpty lo
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%3A%7C"><span class="hs-operator hs-var">NE.:|</span></a></span><span> </span><span class="annot"><span class="annottext">[lo]
</span><a href="#local-6989586621679137930"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-87"></span><span>                                        </span><span class="hs-comment">-- Either GHC-impossible or impossible</span><span>
</span><span id="line-88"></span><span>                                        </span><span class="hs-comment">-- to create a non-empty list with zero</span><span>
</span><span id="line-89"></span><span>                                        </span><span class="hs-comment">-- items or less.</span><span>
</span><span id="line-90"></span><span>                                       </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; NonEmpty lo
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; NonEmpty lo) -&gt; [Char] -&gt; NonEmpty lo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;impossible: requested = &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679137919"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-91"></span><span>                 </span><span class="annot"><span class="annottext">TokBlockingStyle blocking
</span><a href="Trace.Forward.Protocol.TraceObject.Type.html#TokNonBlocking"><span class="hs-identifier hs-var">TokNonBlocking</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[lo] -&gt; BlockingReplyList 'StNonBlocking lo
forall lo. [lo] -&gt; BlockingReplyList 'StNonBlocking lo
</span><a href="Trace.Forward.Protocol.TraceObject.Type.html#NonBlockingReply"><span class="hs-identifier hs-var">NonBlockingReply</span></a></span><span> </span><span class="annot"><span class="annottext">[lo]
</span><a href="#local-6989586621679137920"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">recvMsgDone :: IO ()
</span><a href="Trace.Forward.Protocol.TraceObject.Forwarder.html#recvMsgDone"><span class="hs-identifier hs-var">Forwarder.recvMsgDone</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span id="local-6989586621679137839"><span id="local-6989586621679137840"><span class="annot"><a href="Trace.Forward.Utils.TraceObject.html#readFromSinkSTM"><span class="hs-identifier hs-type">readFromSinkSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#TBQueue"><span class="hs-identifier hs-type">TBQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679137839"><span class="hs-identifier hs-type">lo</span></a></span><span>
</span><span id="line-96"></span><span>                </span><span class="hs-comment">-- If queue is empty, block or not?</span><span>
</span><span id="line-97"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Trace.Forward.Protocol.TraceObject.Type.html#TokBlockingStyle"><span class="hs-identifier hs-type">TokBlockingStyle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679137840"><span class="hs-identifier hs-type">blocking</span></a></span><span>
</span><span id="line-98"></span><span>                </span><span class="hs-comment">-- Maximum number of requested trace objects.</span><span>
</span><span id="line-99"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Word.html#Word16"><span class="hs-identifier hs-type">Word16</span></a></span><span>
</span><span id="line-100"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Conc.Sync.html#STM"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679137839"><span class="hs-identifier hs-type">lo</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-101"></span><span id="readFromSinkSTM"><span class="annot"><span class="annottext">readFromSinkSTM :: forall lo (blocking :: StBlockingStyle).
TBQueue lo -&gt; TokBlockingStyle blocking -&gt; Word16 -&gt; STM [lo]
</span><a href="Trace.Forward.Utils.TraceObject.html#readFromSinkSTM"><span class="hs-identifier hs-var hs-var">readFromSinkSTM</span></a></span></span><span> </span><span id="local-6989586621679137953"><span class="annot"><span class="annottext">TBQueue lo
</span><a href="#local-6989586621679137953"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679137954"><span class="annot"><span class="annottext">TokBlockingStyle blocking
</span><a href="#local-6989586621679137954"><span class="hs-identifier hs-var">blocking</span></a></span></span><span> </span><span id="local-6989586621679137955"><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679137955"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-comment">---------- STM transaction: start ----------</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-comment">-- Instead of using `isEmptyTBQueue`, that internally may read only one TVar,</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-comment">-- we optimize for the critical path, the case in which the queue has objects</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-comment">-- and directly use `lengthTBQueue` that always reads two TVars.</span><span>
</span><span id="line-106"></span><span>  </span><span id="local-6989586621679137956"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679137956"><span class="hs-identifier hs-var">queueLength</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TBQueue lo -&gt; STM Natural
forall a. TBQueue a -&gt; STM Natural
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#lengthTBQueue"><span class="hs-identifier hs-var">lengthTBQueue</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue lo
</span><a href="#local-6989586621679137953"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679137956"><span class="hs-identifier hs-var">queueLength</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-keyword">then</span><span>
</span><span id="line-109"></span><span>     </span><span class="hs-comment">-- Here we already know the queue is NOT empty.</span><span>
</span><span id="line-110"></span><span>     </span><span class="hs-comment">-- We will either get the entire queue (flush) or do `n` reads.</span><span>
</span><span id="line-111"></span><span>     </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Enum.html#fromEnum"><span class="hs-identifier hs-var">fromEnum</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679137955"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Enum.html#fromEnum"><span class="hs-identifier hs-var">fromEnum</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679137956"><span class="hs-identifier hs-var">queueLength</span></a></span><span>
</span><span id="line-112"></span><span>     </span><span class="hs-comment">-- If the requested maximum number is more or equal length, return all.</span><span>
</span><span id="line-113"></span><span>     </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TBQueue lo -&gt; STM [lo]
forall a. TBQueue a -&gt; STM [a]
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#flushTBQueue"><span class="hs-identifier hs-var">flushTBQueue</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue lo
</span><a href="#local-6989586621679137953"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="hs-comment">-- Flush is non-blocking, can return empty.</span><span>
</span><span id="line-114"></span><span>     </span><span class="hs-comment">-- If the requested maximum number is less than length, read `n` times.</span><span>
</span><span id="line-115"></span><span>     </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; STM lo -&gt; STM [lo]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Control.Monad.html#replicateM"><span class="hs-identifier hs-var">replicateM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word16 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679137955"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TBQueue lo -&gt; STM lo
forall a. TBQueue a -&gt; STM a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TBQueue.html#readTBQueue"><span class="hs-identifier hs-var">readTBQueue</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue lo
</span><a href="#local-6989586621679137953"><span class="hs-identifier hs-var">queue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-keyword">else</span><span>
</span><span id="line-117"></span><span>   </span><span class="hs-comment">-- The queue is empty, return nothing or wait.</span><span>
</span><span id="line-118"></span><span>   </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TokBlockingStyle blocking
</span><a href="#local-6989586621679137954"><span class="hs-identifier hs-var">blocking</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-119"></span><span>     </span><span class="annot"><span class="annottext">TokBlockingStyle blocking
</span><a href="Trace.Forward.Protocol.TraceObject.Type.html#TokBlocking"><span class="hs-identifier hs-var">TokBlocking</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM [lo]
forall a. STM a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Conc.Sync.html#retry"><span class="hs-identifier hs-var">retry</span></a></span><span>
</span><span id="line-120"></span><span>     </span><span class="annot"><span class="annottext">TokBlockingStyle blocking
</span><a href="Trace.Forward.Protocol.TraceObject.Type.html#TokNonBlocking"><span class="hs-identifier hs-var">TokNonBlocking</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[lo] -&gt; STM [lo]
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-comment">---------- STM transaction: end ----------</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span id="local-6989586621679137859"><span id="local-6989586621679137860"><span class="annot"><a href="Trace.Forward.Utils.TraceObject.html#getTraceObjectsFromReply"><span class="hs-identifier hs-type">getTraceObjectsFromReply</span></a></span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Trace.Forward.Protocol.TraceObject.Type.html#BlockingReplyList"><span class="hs-identifier hs-type">BlockingReplyList</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679137859"><span class="hs-identifier hs-type">blocking</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679137860"><span class="hs-identifier hs-type">lo</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ The reply with list of 'TraceObject's.</span></span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679137860"><span class="hs-identifier hs-type">lo</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-128"></span><span id="getTraceObjectsFromReply"><span class="annot"><span class="annottext">getTraceObjectsFromReply :: forall (blocking :: StBlockingStyle) lo.
BlockingReplyList blocking lo -&gt; [lo]
</span><a href="Trace.Forward.Utils.TraceObject.html#getTraceObjectsFromReply"><span class="hs-identifier hs-var hs-var">getTraceObjectsFromReply</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Trace.Forward.Protocol.TraceObject.Type.html#BlockingReply"><span class="hs-identifier hs-type">BlockingReply</span></a></span><span> </span><span id="local-6989586621679137963"><span class="annot"><span class="annottext">NonEmpty lo
</span><a href="#local-6989586621679137963"><span class="hs-identifier hs-var">neList</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty lo -&gt; [lo]
forall a. NonEmpty a -&gt; [a]
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Data.List.NonEmpty.html#toList"><span class="hs-identifier hs-var">NE.toList</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty lo
</span><a href="#local-6989586621679137963"><span class="hs-identifier hs-var">neList</span></a></span><span>
</span><span id="line-129"></span><span class="annot"><a href="Trace.Forward.Utils.TraceObject.html#getTraceObjectsFromReply"><span class="hs-identifier hs-var">getTraceObjectsFromReply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Trace.Forward.Protocol.TraceObject.Type.html#NonBlockingReply"><span class="hs-identifier hs-type">NonBlockingReply</span></a></span><span> </span><span id="local-6989586621679137966"><span class="annot"><span class="annottext">[lo]
</span><a href="#local-6989586621679137966"><span class="hs-identifier hs-var">list</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[lo]
</span><a href="#local-6989586621679137966"><span class="hs-identifier hs-var">list</span></a></span><span>
</span><span id="line-130"></span></pre></body></html>