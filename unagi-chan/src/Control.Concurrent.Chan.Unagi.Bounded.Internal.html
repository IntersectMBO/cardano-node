<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns , DeriveDataTypeable, CPP #-}</span><span>
</span><span id="line-2"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Control.Concurrent.Chan.Unagi.Bounded.Internal</span><span>
</span><span id="line-3"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier">InChan</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier">OutChan</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier">ChanEnd</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamSegment"><span class="hs-identifier">StreamSegment</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Cell"><span class="hs-identifier">Cell</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier">Stream</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-4"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writerCheckin"><span class="hs-identifier">writerCheckin</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#unblockWriters"><span class="hs-identifier">unblockWriters</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#tryWriterCheckin"><span class="hs-identifier">tryWriterCheckin</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#WriterCheckpoint"><span class="hs-identifier">WriterCheckpoint</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-5"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextSegment"><span class="hs-identifier">NextSegment</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamHead"><span class="hs-identifier">StreamHead</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-6"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#newChanStarting"><span class="hs-identifier">newChanStarting</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writeChan"><span class="hs-identifier">writeChan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readChan"><span class="hs-identifier">readChan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readChanOnException"><span class="hs-identifier">readChanOnException</span></a></span><span>
</span><span id="line-7"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#tryWriteChan"><span class="hs-identifier">tryWriteChan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#tryReadChan"><span class="hs-identifier">tryReadChan</span></a></span><span>
</span><span id="line-8"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#dupChan"><span class="hs-identifier">dupChan</span></a></span><span>
</span><span id="line-9"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#estimatedLength"><span class="hs-identifier">estimatedLength</span></a></span><span>
</span><span id="line-10"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-comment">-- NOTE: forked from src/Control/Concurrent/Chan/Unagi/Internal.hs 43706b2</span><span>
</span><span id="line-14"></span><span class="hs-comment">--       some commentary not specific to this Bounded variant has been removed.</span><span>
</span><span id="line-15"></span><span class="hs-comment">--       See the Unagi source for that.</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Concurrent.MVar.html"><span class="hs-identifier">Control.Concurrent.MVar</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.IORef.html"><span class="hs-identifier">Data.IORef</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Primitive</span></span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Prim.html#RealWorld"><span class="hs-identifier">RealWorld</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Atomics.Counter.Fat.html"><span class="hs-identifier">Data.Atomics.Counter.Fat</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Atomics</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Primitive</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">P</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Applicative.html"><span class="hs-identifier">Control.Applicative</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Bits.html"><span class="hs-identifier">Data.Bits</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier">fromMaybe</span></a></span><span class="hs-special">,</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#isJust"><span class="hs-identifier">isJust</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Typeable.html"><span class="hs-identifier">Data.Typeable</span></a></span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier">Typeable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Exts.html"><span class="hs-identifier">GHC.Exts</span></a></span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Magic.html#inline"><span class="hs-identifier">inline</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Utilities.html"><span class="hs-identifier">Utilities</span></a></span><span class="hs-special">(</span><span class="annot"><a href="Utilities.html#nextHighestPowerOfTwo"><span class="hs-identifier">nextHighestPowerOfTwo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.NoBlocking.Types.html"><span class="hs-identifier">Control.Concurrent.Chan.Unagi.NoBlocking.Types</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UT</span></span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Prelude.html"><span class="hs-identifier">Prelude</span></a></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="annot"><span class="hs-comment">-- | The write end of a channel created with 'newChan'.</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">data</span><span> </span><span id="InChan"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-var">InChan</span></a></span></span><span> </span><span id="local-6989586621679054026"><span class="annot"><a href="#local-6989586621679054026"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InChan"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-var">InChan</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- readCounterReader, for tryWriteChan</span><span>
</span><span id="line-38"></span><span>                       </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ticket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Cell"><span class="hs-identifier hs-type">Cell</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054026"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-39"></span><span>                       </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054026"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a></span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="annot"><span class="hs-comment">-- | The read end of a channel created with 'newChan'.</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">newtype</span><span> </span><span id="OutChan"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-var">OutChan</span></a></span></span><span> </span><span id="local-6989586621679054027"><span class="annot"><a href="#local-6989586621679054027"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="OutChan"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-var">OutChan</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054027"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679053975"><span id="local-6989586621679054129"><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053975"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span class="annot"><span class="annottext">IO Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">AtomicCounter
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679054136"><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054136"><span class="hs-identifier hs-var">headA</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679054137"><span class="annot"><span class="annottext">== :: InChan a -&gt; InChan a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span class="annot"><span class="annottext">IO Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">AtomicCounter
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679054138"><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054138"><span class="hs-identifier hs-var">headB</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054136"><span class="hs-identifier hs-var">headA</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a) -&gt; IORef (StreamHead a) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054138"><span class="hs-identifier hs-var">headB</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679053986"><span id="local-6989586621679054141"><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-type">OutChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053986"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-type">OutChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">AtomicCounter
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679054145"><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054145"><span class="hs-identifier hs-var">headA</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679054146"><span class="annot"><span class="annottext">== :: OutChan a -&gt; OutChan a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-type">OutChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">AtomicCounter
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679054147"><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054147"><span class="hs-identifier hs-var">headB</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054145"><span class="hs-identifier hs-var">headA</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a) -&gt; IORef (StreamHead a) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054147"><span class="hs-identifier hs-var">headB</span></a></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">data</span><span> </span><span id="ChanEnd"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-var">ChanEnd</span></a></span></span><span> </span><span id="local-6989586621679054015"><span class="annot"><a href="#local-6989586621679054015"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-54"></span><span>            </span><span class="hs-comment">-- For efficient div and mod:</span><span>
</span><span id="line-55"></span><span>    </span><span id="ChanEnd"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-var">ChanEnd</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>  </span><span class="hs-comment">-- logBase 2 BOUNDS</span><span>
</span><span id="line-56"></span><span>            </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>  </span><span class="hs-comment">-- BOUNDS - 1</span><span>
</span><span id="line-57"></span><span>            </span><span class="hs-comment">-- an efficient producer of segments of length BOUNDS:</span><span>
</span><span id="line-58"></span><span>            </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#SegSource"><span class="hs-identifier hs-type">SegSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054015"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>            </span><span class="hs-comment">-- Both Chan ends must start with the same counter value.</span><span>
</span><span id="line-60"></span><span>            </span><span class="hs-glyph">!</span><span class="annot"><a href="Data.Atomics.Counter.Fat.html#AtomicCounter"><span class="hs-identifier hs-type">AtomicCounter</span></a></span><span> </span><span>
</span><span id="line-61"></span><span>            </span><span class="hs-comment">-- the stream head; this must never point to a segment whose offset</span><span>
</span><span id="line-62"></span><span>            </span><span class="hs-comment">-- is greater than the counter value</span><span>
</span><span id="line-63"></span><span>            </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamHead"><span class="hs-identifier hs-type">StreamHead</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054015"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- NOTE [1]</span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a></span><span>
</span><span id="line-65"></span><span> </span><span class="hs-comment">-- [1] For the writers' ChanEnd: the segment that appears in the StreamHead is</span><span>
</span><span id="line-66"></span><span> </span><span class="hs-comment">-- implicitly unlocked for writers (the segment size being equal to the chan</span><span>
</span><span id="line-67"></span><span> </span><span class="hs-comment">-- bounds). See 'writeChan' for notes on how we make sure to keep this</span><span>
</span><span id="line-68"></span><span> </span><span class="hs-comment">-- invariant.</span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-keyword">data</span><span> </span><span id="StreamHead"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamHead"><span class="hs-identifier hs-var">StreamHead</span></a></span></span><span> </span><span id="local-6989586621679054019"><span class="annot"><a href="#local-6989586621679054019"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="StreamHead"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamHead"><span class="hs-identifier hs-var">StreamHead</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054019"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-comment">-- This is always of length BOUNDS</span><span>
</span><span id="line-73"></span><span class="hs-keyword">type</span><span> </span><span id="StreamSegment"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamSegment"><span class="hs-identifier hs-var">StreamSegment</span></a></span></span><span> </span><span id="local-6989586621679054149"><span class="annot"><a href="#local-6989586621679054149"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">P.MutableArray</span></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Prim.html#RealWorld"><span class="hs-identifier hs-type">RealWorld</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Cell"><span class="hs-identifier hs-type">Cell</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054149"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-keyword">data</span><span> </span><span id="Cell"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Cell"><span class="hs-identifier hs-var">Cell</span></a></span></span><span> </span><span id="local-6989586621679054038"><span class="annot"><a href="#local-6989586621679054038"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Empty"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Empty"><span class="hs-identifier hs-var">Empty</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Written"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Written"><span class="hs-identifier hs-var">Written</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679054038"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Blocking"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Blocking"><span class="hs-identifier hs-var">Blocking</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054038"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-keyword">data</span><span> </span><span id="Stream"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span></span><span> </span><span id="local-6989586621679054009"><span class="annot"><a href="#local-6989586621679054009"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-78"></span><span>    </span><span id="Stream"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamSegment"><span class="hs-identifier hs-type">StreamSegment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054009"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>           </span><span class="hs-comment">-- The next segment in the stream; new segments are allocated and</span><span>
</span><span id="line-80"></span><span>           </span><span class="hs-comment">-- put here by the reader of index-0 of the previous segment. That</span><span>
</span><span id="line-81"></span><span>           </span><span class="hs-comment">-- reader (and the next one or two) also do a tryPutMVar to the MVar</span><span>
</span><span id="line-82"></span><span>           </span><span class="hs-comment">-- below, to indicate that any blocked writers may proceed.</span><span>
</span><span id="line-83"></span><span>           </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextSegment"><span class="hs-identifier hs-type">NextSegment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054009"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>           </span><span class="hs-comment">-- writers that find Nothing above, must check in with a possibly</span><span>
</span><span id="line-85"></span><span>           </span><span class="hs-comment">-- blocking readMVar here before proceeding (the slow path):</span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-comment">-- Next segment, installed by either a reader or a writer:</span><span>
</span><span id="line-89"></span><span class="hs-keyword">data</span><span> </span><span id="NextSegment"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextSegment"><span class="hs-identifier hs-var">NextSegment</span></a></span></span><span> </span><span id="local-6989586621679054088"><span class="annot"><a href="#local-6989586621679054088"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NextByWriter"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByWriter"><span class="hs-identifier hs-var">NextByWriter</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054088"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- the next stream segment</span><span>
</span><span id="line-90"></span><span>                                  </span><span class="hs-glyph">!</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#WriterCheckpoint"><span class="hs-identifier hs-type">WriterCheckpoint</span></a></span><span> </span><span class="hs-comment">-- blocking for this segment</span><span>
</span><span id="line-91"></span><span>                   </span><span class="hs-comment">-- a reader-installed one is implicitly unlocked for writers</span><span>
</span><span id="line-92"></span><span>                   </span><span class="hs-comment">-- so needs no checkpoint:</span><span>
</span><span id="line-93"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span id="NextByReader"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByReader"><span class="hs-identifier hs-var">NextByReader</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054088"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-comment">-- helper accessors TODO consider making records</span><span>
</span><span id="line-96"></span><span id="local-6989586621679053987"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#getNextRef"><span class="hs-identifier hs-type">getNextRef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextSegment"><span class="hs-identifier hs-type">NextSegment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053987"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextSegment"><span class="hs-identifier hs-type">NextSegment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053987"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-97"></span><span id="getNextRef"><span class="annot"><span class="annottext">getNextRef :: forall a. NextSegment a -&gt; IORef (Maybe (NextSegment a))
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#getNextRef"><span class="hs-identifier hs-var hs-var">getNextRef</span></a></span></span><span> </span><span id="local-6989586621679054157"><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054157"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">StreamSegment a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679054158"><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
</span><a href="#local-6989586621679054158"><span class="hs-identifier hs-var">nextSegRef</span></a></span></span><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
</span><a href="#local-6989586621679054158"><span class="hs-identifier hs-var">nextSegRef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stream a -&gt; IORef (Maybe (NextSegment a)))
-&gt; Stream a -&gt; IORef (Maybe (NextSegment a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a -&gt; Stream a
forall a. NextSegment a -&gt; Stream a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#getStr"><span class="hs-identifier hs-var">getStr</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054157"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span id="local-6989586621679053995"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#getStr"><span class="hs-identifier hs-type">getStr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextSegment"><span class="hs-identifier hs-type">NextSegment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053995"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053995"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-100"></span><span id="getStr"><span class="annot"><span class="annottext">getStr :: forall a. NextSegment a -&gt; Stream a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#getStr"><span class="hs-identifier hs-var hs-var">getStr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByReader"><span class="hs-identifier hs-type">NextByReader</span></a></span><span> </span><span id="local-6989586621679054160"><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054160"><span class="hs-identifier hs-var">str</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054160"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-101"></span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#getStr"><span class="hs-identifier hs-var">getStr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByWriter"><span class="hs-identifier hs-type">NextByWriter</span></a></span><span> </span><span id="local-6989586621679054161"><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054161"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="annot"><span class="annottext">WriterCheckpoint
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054161"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#asReader"><span class="hs-identifier hs-type">asReader</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#asWriter"><span class="hs-identifier hs-type">asWriter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-104"></span><span id="asReader"><span class="annot"><span class="annottext">asReader :: Bool
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#asReader"><span class="hs-identifier hs-var hs-var">asReader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-105"></span><span id="asWriter"><span class="annot"><span class="annottext">asWriter :: Bool
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#asWriter"><span class="hs-identifier hs-var hs-var">asWriter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-comment">-- WRITER BLOCKING SCHEME OVERVIEW</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- -------------------------------</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- We use segments of size equal to the requested bounds. When a reader reads</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- index 0 of a segment it tries to pre-allocate the next segment, marking it</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- installed by reader (NextByReader), which indicates to writers who read it</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- that they may write and return without blocking (and this makes the queue</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- loosely bounded between size n and n*2).</span><span>
</span><span id="line-115"></span><span class="hs-comment">--</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- Whenever a reader encounters a segment (in waitingAdvanceStream) installed</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- by a writer it unblocks writers and rewrites the NextBy* constructor to</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- NextByReader, replacing the installed stream segment.</span><span>
</span><span id="line-119"></span><span class="hs-comment">--</span><span>
</span><span id="line-120"></span><span class="hs-comment">-- Writers first make their write available (by writing to the segment) before</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- doing any blocking. This is more efficient, lets us handle async exceptions</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- in a principled way without changing the semantics. This also means that in</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- some cases a writer will install the next segment, marked installed by</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- writer, insicating that writers must checkin and block; readers will mark</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- these segments as installed by reader to avoid unnecessary overhead when the</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- segment becomes unlocked as described in the paragraph above.</span><span>
</span><span id="line-127"></span><span class="hs-comment">--</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- The writer StreamHead is only ever updated by a writer that sees that a</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- segment is unlocked for writing (either because the writer has returned from</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- blocking on that segment, or because it sees that it was installed by a</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- reader); in this way a writer knows if its segment is at the StreamHead that</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- it is free to write and return without blocking (writerCheckin).</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span id="local-6989586621679053998"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#newChanStarting"><span class="hs-identifier hs-type">newChanStarting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053998"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-type">OutChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679053998"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-136"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#newChanStarting"><span class="hs-pragma hs-type">newChanStarting</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-137"></span><span id="newChanStarting"><span class="annot"><span class="annottext">newChanStarting :: forall a. Int -&gt; Int -&gt; IO (InChan a, OutChan a)
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#newChanStarting"><span class="hs-identifier hs-var hs-var">newChanStarting</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679054187"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054187"><span class="hs-identifier hs-var">startingCellOffset</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679054188"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054188"><span class="hs-identifier hs-var">sizeDirty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679054189"><span class="annot"><span class="annottext">size :: Int
</span><a href="#local-6989586621679054189"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="Utilities.html#nextHighestPowerOfTwo"><span class="hs-identifier hs-var">nextHighestPowerOfTwo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054188"><span class="hs-identifier hs-var">sizeDirty</span></a></span><span>
</span><span id="line-139"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679054205"><span class="annot"><span class="annottext">logBounds :: Int
</span><a href="#local-6989586621679054205"><span class="hs-identifier hs-var hs-var">logBounds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Float -&gt; Int
forall b. Integral b =&gt; Float -&gt; b
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#round"><span class="hs-identifier hs-var">round</span></a></span><span> </span><span class="annot"><span class="annottext">(Float -&gt; Int) -&gt; Float -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Float -&gt; Float -&gt; Float
forall a. Floating a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Float.html#logBase"><span class="hs-identifier hs-var">logBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Float
</span><span class="hs-number">2</span></span><span class="hs-glyph">::</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Float"><span class="hs-identifier hs-type">Float</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Float -&gt; Float) -&gt; Float -&gt; Float
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Float
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054189"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-140"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679054210"><span class="annot"><span class="annottext">boundsMn1 :: Int
</span><a href="#local-6989586621679054210"><span class="hs-identifier hs-var hs-var">boundsMn1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054189"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span>    </span><span id="local-6989586621679054211"><span class="annot"><span class="annottext">SegSource a
</span><a href="#local-6989586621679054211"><span class="hs-identifier hs-var">segSource</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (SegSource a)
forall a. Int -&gt; IO (SegSource a)
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#newSegmentSource"><span class="hs-identifier hs-var">newSegmentSource</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054189"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span id="local-6989586621679054213"><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054213"><span class="hs-identifier hs-var">firstSeg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><a href="#local-6989586621679054211"><span class="hs-identifier hs-var">segSource</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">-- collect a ticket to save for writer CAS</span><span>
</span><span id="line-145"></span><span>    </span><span id="local-6989586621679054214"><span class="annot"><span class="annottext">Ticket (Cell a)
</span><a href="#local-6989586621679054214"><span class="hs-identifier hs-var">savedEmptyTkt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamSegment a -&gt; Int -&gt; IO (Ticket (Cell a))
forall a. MutableArray RealWorld a -&gt; Int -&gt; IO (Ticket a)
</span><span class="hs-identifier hs-var">readArrayElem</span></span><span> </span><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054213"><span class="hs-identifier hs-var">firstSeg</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-146"></span><span>    </span><span id="local-6989586621679054216"><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054216"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamSegment a -&gt; IORef (Maybe (NextSegment a)) -&gt; Stream a
forall a.
StreamSegment a -&gt; IORef (Maybe (NextSegment a)) -&gt; Stream a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054213"><span class="hs-identifier hs-var">firstSeg</span></a></span><span> </span><span class="annot"><span class="annottext">(IORef (Maybe (NextSegment a)) -&gt; Stream a)
-&gt; IO (IORef (Maybe (NextSegment a))) -&gt; IO (Stream a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (NextSegment a) -&gt; IO (IORef (Maybe (NextSegment a)))
forall a. a -&gt; IO (IORef a)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (NextSegment a)
forall a. Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679054222"><span class="annot"><span class="annottext">end :: IO (ChanEnd a)
</span><a href="#local-6989586621679054222"><span class="hs-identifier hs-var hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Int
-&gt; SegSource a
-&gt; AtomicCounter
-&gt; IORef (StreamHead a)
-&gt; ChanEnd a
forall a.
Int
-&gt; Int
-&gt; SegSource a
-&gt; AtomicCounter
-&gt; IORef (StreamHead a)
-&gt; ChanEnd a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-var">ChanEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054205"><span class="hs-identifier hs-var">logBounds</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054210"><span class="hs-identifier hs-var">boundsMn1</span></a></span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><a href="#local-6989586621679054211"><span class="hs-identifier hs-var">segSource</span></a></span><span> </span><span>
</span><span id="line-148"></span><span>                  </span><span class="annot"><span class="annottext">(AtomicCounter -&gt; IORef (StreamHead a) -&gt; ChanEnd a)
-&gt; IO AtomicCounter -&gt; IO (IORef (StreamHead a) -&gt; ChanEnd a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO AtomicCounter
</span><a href="Data.Atomics.Counter.Fat.html#newCounter"><span class="hs-identifier hs-var">newCounter</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054187"><span class="hs-identifier hs-var">startingCellOffset</span></a></span><span>
</span><span id="line-149"></span><span>                  </span><span class="annot"><span class="annottext">IO (IORef (StreamHead a) -&gt; ChanEnd a)
-&gt; IO (IORef (StreamHead a)) -&gt; IO (ChanEnd a)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StreamHead a -&gt; IO (IORef (StreamHead a))
forall a. a -&gt; IO (IORef a)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Stream a -&gt; StreamHead a
forall a. Int -&gt; Stream a -&gt; StreamHead a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamHead"><span class="hs-identifier hs-var">StreamHead</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054187"><span class="hs-identifier hs-var">startingCellOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054216"><span class="hs-identifier hs-var">stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>    </span><span id="local-6989586621679054224"><span class="annot"><span class="annottext">endR :: ChanEnd a
</span><a href="#local-6989586621679054224"><span class="hs-identifier hs-var">endR</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679054225"><span class="annot"><span class="annottext">AtomicCounter
</span><a href="#local-6989586621679054225"><span class="hs-identifier hs-var">counterR</span></a></span></span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (ChanEnd a)
</span><a href="#local-6989586621679054222"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span id="local-6989586621679054226"><span class="annot"><span class="annottext">ChanEnd a
</span><a href="#local-6989586621679054226"><span class="hs-identifier hs-var">endW</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (ChanEnd a)
</span><a href="#local-6989586621679054222"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO (InChan a, OutChan a) -&gt; IO (InChan a, OutChan a)
forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054189"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054210"><span class="hs-identifier hs-var">boundsMn1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a b. (Num a, Integral b) =&gt; a -&gt; b -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#%5E"><span class="hs-operator hs-var">^</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054205"><span class="hs-identifier hs-var">logBounds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (InChan a, OutChan a) -&gt; IO (InChan a, OutChan a))
-&gt; IO (InChan a, OutChan a) -&gt; IO (InChan a, OutChan a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-153"></span><span>       </span><span class="annot"><span class="annottext">(InChan a, OutChan a) -&gt; IO (InChan a, OutChan a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">IO Int -&gt; Ticket (Cell a) -&gt; ChanEnd a -&gt; InChan a
forall a. IO Int -&gt; Ticket (Cell a) -&gt; ChanEnd a -&gt; InChan a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-var">InChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AtomicCounter -&gt; IO Int
</span><a href="Data.Atomics.Counter.Fat.html#readCounter"><span class="hs-identifier hs-var">readCounter</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicCounter
</span><a href="#local-6989586621679054225"><span class="hs-identifier hs-var">counterR</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a)
</span><a href="#local-6989586621679054214"><span class="hs-identifier hs-var">savedEmptyTkt</span></a></span><span> </span><span class="annot"><span class="annottext">ChanEnd a
</span><a href="#local-6989586621679054226"><span class="hs-identifier hs-var">endW</span></a></span><span>
</span><span id="line-154"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChanEnd a -&gt; OutChan a
forall a. ChanEnd a -&gt; OutChan a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-var">OutChan</span></a></span><span> </span><span class="annot"><span class="annottext">ChanEnd a
</span><a href="#local-6989586621679054224"><span class="hs-identifier hs-var">endR</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="hs-comment">-- | Duplicate a chan: the returned @OutChan@ begins empty, but data written to</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- the argument @InChan@ from then on will be available from both the original</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- @OutChan@ and the one returned here, creating a kind of broadcast channel.</span><span>
</span><span id="line-159"></span><span class="hs-comment">--</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- Writers will be blocked only when the fastest reader falls behind the</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- bounds; slower readers of duplicated 'OutChan' may fall arbitrarily behind.</span><span>
</span><span id="line-162"></span><span id="local-6989586621679054028"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#dupChan"><span class="hs-identifier hs-type">dupChan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054028"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-type">OutChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054028"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-163"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#dupChan"><span class="hs-pragma hs-type">dupChan</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-164"></span><span id="dupChan"><span class="annot"><span class="annottext">dupChan :: forall a. InChan a -&gt; IO (OutChan a)
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#dupChan"><span class="hs-identifier hs-var hs-var">dupChan</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span class="annot"><span class="annottext">IO Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span id="local-6989586621679054238"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054238"><span class="hs-identifier hs-var">logBounds</span></a></span></span><span> </span><span id="local-6989586621679054239"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054239"><span class="hs-identifier hs-var">boundsMn1</span></a></span></span><span> </span><span id="local-6989586621679054240"><span class="annot"><span class="annottext">SegSource a
</span><a href="#local-6989586621679054240"><span class="hs-identifier hs-var">segSource</span></a></span></span><span> </span><span id="local-6989586621679054241"><span class="annot"><span class="annottext">AtomicCounter
</span><a href="#local-6989586621679054241"><span class="hs-identifier hs-var">counter</span></a></span></span><span> </span><span id="local-6989586621679054242"><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054242"><span class="hs-identifier hs-var">streamHead</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-165"></span><span>    </span><span id="local-6989586621679054243"><span class="annot"><span class="annottext">StreamHead a
</span><a href="#local-6989586621679054243"><span class="hs-identifier hs-var">hLoc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a) -&gt; IO (StreamHead a)
forall a. IORef a -&gt; IO a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054242"><span class="hs-identifier hs-var">streamHead</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="annot"><span class="annottext">IO ()
</span><span class="hs-identifier hs-var">loadLoadBarrier</span></span><span>
</span><span id="line-167"></span><span>    </span><span id="local-6989586621679054246"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054246"><span class="hs-identifier hs-var">wCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AtomicCounter -&gt; IO Int
</span><a href="Data.Atomics.Counter.Fat.html#readCounter"><span class="hs-identifier hs-var">readCounter</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicCounter
</span><a href="#local-6989586621679054241"><span class="hs-identifier hs-var">counter</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span>
</span><span id="line-169"></span><span>    </span><span id="local-6989586621679054247"><span class="annot"><span class="annottext">AtomicCounter
</span><a href="#local-6989586621679054247"><span class="hs-identifier hs-var">counter'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO AtomicCounter
</span><a href="Data.Atomics.Counter.Fat.html#newCounter"><span class="hs-identifier hs-var">newCounter</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054246"><span class="hs-identifier hs-var">wCount</span></a></span><span> </span><span>
</span><span id="line-170"></span><span>    </span><span id="local-6989586621679054248"><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054248"><span class="hs-identifier hs-var">streamHead'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamHead a -&gt; IO (IORef (StreamHead a))
forall a. a -&gt; IO (IORef a)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">StreamHead a
</span><a href="#local-6989586621679054243"><span class="hs-identifier hs-var">hLoc</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><span class="annottext">OutChan a -&gt; IO (OutChan a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(OutChan a -&gt; IO (OutChan a)) -&gt; OutChan a -&gt; IO (OutChan a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChanEnd a -&gt; OutChan a
forall a. ChanEnd a -&gt; OutChan a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-var">OutChan</span></a></span><span> </span><span class="annot"><span class="annottext">(ChanEnd a -&gt; OutChan a) -&gt; ChanEnd a -&gt; OutChan a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Int
-&gt; SegSource a
-&gt; AtomicCounter
-&gt; IORef (StreamHead a)
-&gt; ChanEnd a
forall a.
Int
-&gt; Int
-&gt; SegSource a
-&gt; AtomicCounter
-&gt; IORef (StreamHead a)
-&gt; ChanEnd a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-var">ChanEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054238"><span class="hs-identifier hs-var">logBounds</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054239"><span class="hs-identifier hs-var">boundsMn1</span></a></span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><a href="#local-6989586621679054240"><span class="hs-identifier hs-var">segSource</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicCounter
</span><a href="#local-6989586621679054247"><span class="hs-identifier hs-var">counter'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054248"><span class="hs-identifier hs-var">streamHead'</span></a></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="hs-comment">-- | Write a value to the channel. If the chan is full this will block.</span><span>
</span><span id="line-175"></span><span class="hs-comment">--</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- To be precise this /may/ block when the number of elements in the queue </span><span>
</span><span id="line-177"></span><span class="hs-comment">-- @&gt;= size@, and will certainly block when @&gt;= size*2@, where @size@ is the</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- argument passed to 'newChan', rounded up to the next highest power of two.</span><span>
</span><span id="line-179"></span><span class="hs-comment">--</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- /Note re. exceptions/: In the case that an async exception is raised </span><span>
</span><span id="line-181"></span><span class="hs-comment">-- while blocking here, the write will nonetheless succeed. When not blocking,</span><span>
</span><span id="line-182"></span><span class="hs-comment">-- exceptions are masked. Thus writes always succeed once 'writeChan' is</span><span>
</span><span id="line-183"></span><span class="hs-comment">-- entered.</span><span>
</span><span id="line-184"></span><span id="local-6989586621679054031"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writeChan"><span class="hs-identifier hs-type">writeChan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054031"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679054031"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-185"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writeChan"><span class="hs-pragma hs-type">writeChan</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-186"></span><span id="writeChan"><span class="annot"><span class="annottext">writeChan :: forall a. InChan a -&gt; a -&gt; IO ()
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writeChan"><span class="hs-identifier hs-var hs-var">writeChan</span></a></span></span><span> </span><span id="local-6989586621679054249"><span class="annot"><span class="annottext">InChan a
</span><a href="#local-6989586621679054249"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679054250"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054250"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; InChan a -&gt; a -&gt; IO ()
forall a. Bool -&gt; InChan a -&gt; a -&gt; IO ()
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writeChanWithBlocking"><span class="hs-identifier hs-var">writeChanWithBlocking</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="annot"><span class="annottext">InChan a
</span><a href="#local-6989586621679054249"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054250"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span id="local-6989586621679054033"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writeChanWithBlocking"><span class="hs-identifier hs-type">writeChanWithBlocking</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054033"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679054033"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-189"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writeChanWithBlocking"><span class="hs-pragma hs-type">writeChanWithBlocking</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-190"></span><span id="writeChanWithBlocking"><span class="annot"><span class="annottext">writeChanWithBlocking :: forall a. Bool -&gt; InChan a -&gt; a -&gt; IO ()
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writeChanWithBlocking"><span class="hs-identifier hs-var hs-var">writeChanWithBlocking</span></a></span></span><span> </span><span id="local-6989586621679054262"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054262"><span class="hs-identifier hs-var">canBlock</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span class="annot"><span class="annottext">IO Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679054263"><span class="annot"><span class="annottext">Ticket (Cell a)
</span><a href="#local-6989586621679054263"><span class="hs-identifier hs-var">savedEmptyTkt</span></a></span></span><span> </span><span id="local-6989586621679054264"><span class="annot"><span class="annottext">ChanEnd a
</span><a href="#local-6989586621679054264"><span class="hs-identifier hs-var">ce</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679054265"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054265"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679054267"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054267"><span class="hs-identifier hs-var">segIx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679054268"><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054268"><span class="hs-identifier hs-var">nextSeg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679054269"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679054269"><span class="hs-identifier hs-var">updateStreamHeadIfNecessary</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ChanEnd a -&gt; IO (Int, NextSegment a, IO ())
forall a. Bool -&gt; ChanEnd a -&gt; IO (Int, NextSegment a, IO ())
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#moveToNextCell"><span class="hs-identifier hs-var">moveToNextCell</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#asWriter"><span class="hs-identifier hs-var">asWriter</span></a></span><span> </span><span class="annot"><span class="annottext">ChanEnd a
</span><a href="#local-6989586621679054264"><span class="hs-identifier hs-var">ce</span></a></span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679054271"><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054271"><span class="hs-identifier hs-var">seg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679054272"><span class="annot"><span class="annottext">Maybe WriterCheckpoint
</span><a href="#local-6989586621679054272"><span class="hs-identifier hs-var">maybeCheckpt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054268"><span class="hs-identifier hs-var">nextSeg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-193"></span><span>          </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByWriter"><span class="hs-identifier hs-type">NextByWriter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679054273"><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054273"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679054274"><span class="annot"><span class="annottext">WriterCheckpoint
</span><a href="#local-6989586621679054274"><span class="hs-identifier hs-var">checkpt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054273"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WriterCheckpoint -&gt; Maybe WriterCheckpoint
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">WriterCheckpoint
</span><a href="#local-6989586621679054274"><span class="hs-identifier hs-var">checkpt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>          </span><span class="hs-comment">-- if installed by reader, no need to check in:</span><span>
</span><span id="line-195"></span><span>          </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByReader"><span class="hs-identifier hs-type">NextByReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679054275"><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054275"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054275"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe WriterCheckpoint
forall a. Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679054276"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054276"><span class="hs-identifier hs-var">success</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679054277"><span class="annot"><span class="annottext">Ticket (Cell a)
</span><a href="#local-6989586621679054277"><span class="hs-identifier hs-var">nonEmptyTkt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamSegment a
-&gt; Int -&gt; Ticket (Cell a) -&gt; Cell a -&gt; IO (Bool, Ticket (Cell a))
forall a.
MutableArray RealWorld a
-&gt; Int -&gt; Ticket a -&gt; a -&gt; IO (Bool, Ticket a)
</span><span class="hs-identifier hs-var">casArrayElem</span></span><span> </span><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054271"><span class="hs-identifier hs-var">seg</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054267"><span class="hs-identifier hs-var">segIx</span></a></span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a)
</span><a href="#local-6989586621679054263"><span class="hs-identifier hs-var">savedEmptyTkt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Cell a
forall a. a -&gt; Cell a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Written"><span class="hs-identifier hs-var">Written</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054265"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054276"><span class="hs-identifier hs-var">success</span></a></span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-comment">-- NOTE: We must only block AFTER writing to be async exception-safe.</span><span>
</span><span id="line-200"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">IO ()
-&gt; (WriterCheckpoint -&gt; IO ()) -&gt; Maybe WriterCheckpoint -&gt; IO ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679054269"><span class="hs-identifier hs-var">updateStreamHeadIfNecessary</span></a></span><span> </span><span class="hs-comment">-- NOTE [2]</span><span>
</span><span id="line-201"></span><span>                 </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679054280"><span class="annot"><span class="annottext">WriterCheckpoint
</span><a href="#local-6989586621679054280"><span class="hs-identifier hs-var">checkpt</span></a></span></span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-202"></span><span>                     </span><span id="local-6989586621679054281"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054281"><span class="hs-identifier hs-var">segUnlocked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054262"><span class="hs-identifier hs-var">canBlock</span></a></span><span> </span><span>
</span><span id="line-203"></span><span>                                     </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO Bool
forall a b. a -&gt; IO b -&gt; IO a
forall (f :: * -&gt; *) a b. Functor f =&gt; a -&gt; f b -&gt; f a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%24"><span class="hs-operator hs-var">&lt;$</span></a></span><span> </span><span class="annot"><span class="annottext">WriterCheckpoint -&gt; IO ()
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writerCheckin"><span class="hs-identifier hs-var">writerCheckin</span></a></span><span> </span><span class="annot"><span class="annottext">WriterCheckpoint
</span><a href="#local-6989586621679054280"><span class="hs-identifier hs-var">checkpt</span></a></span><span>
</span><span id="line-204"></span><span>                                     </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">WriterCheckpoint -&gt; IO Bool
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#tryWriterCheckin"><span class="hs-identifier hs-var">tryWriterCheckin</span></a></span><span> </span><span class="annot"><span class="annottext">WriterCheckpoint
</span><a href="#local-6989586621679054280"><span class="hs-identifier hs-var">checkpt</span></a></span><span>
</span><span id="line-205"></span><span>                     </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054281"><span class="hs-identifier hs-var">segUnlocked</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-206"></span><span>                       </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679054269"><span class="hs-identifier hs-var">updateStreamHeadIfNecessary</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- NOTE [1/2]</span><span>
</span><span id="line-207"></span><span>                 </span><span class="annot"><span class="annottext">Maybe WriterCheckpoint
</span><a href="#local-6989586621679054272"><span class="hs-identifier hs-var">maybeCheckpt</span></a></span><span>
</span><span id="line-208"></span><span>                        </span><span>
</span><span id="line-209"></span><span>      </span><span class="hs-comment">-- If CAS failed then a reader beat us, so we know we're not out of</span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-comment">-- bounds and don't need to writerCheckin</span><span>
</span><span id="line-211"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a) -&gt; Cell a
forall a. Ticket a -&gt; a
</span><span class="hs-identifier hs-var">peekTicket</span></span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a)
</span><a href="#local-6989586621679054277"><span class="hs-identifier hs-var">nonEmptyTkt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-212"></span><span>                </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Blocking"><span class="hs-identifier hs-type">Blocking</span></a></span><span> </span><span id="local-6989586621679054285"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054285"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">MVar a -&gt; a -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054285"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054265"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-213"></span><span>                                 </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679054269"><span class="hs-identifier hs-var">updateStreamHeadIfNecessary</span></a></span><span>  </span><span class="hs-comment">-- NOTE [1] </span><span>
</span><span id="line-214"></span><span>                </span><span class="annot"><span class="annottext">Cell a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Empty"><span class="hs-identifier hs-var">Empty</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IO ()
forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Stored Empty Ticket went stale!&quot;</span></span><span>
</span><span id="line-215"></span><span>                </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Written"><span class="hs-identifier hs-type">Written</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IO ()
forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Nearly Impossible! Expected Blocking&quot;</span></span><span>
</span><span id="line-216"></span><span> </span><span class="hs-comment">-- [1] At this point we know that 'seg' is unlocked for writers because a</span><span>
</span><span id="line-217"></span><span> </span><span class="hs-comment">-- reader unblocked us, so it's safe to update the StreamHead with this</span><span>
</span><span id="line-218"></span><span> </span><span class="hs-comment">-- segment (if we moved to a new segment). This way we maintain the invariant</span><span>
</span><span id="line-219"></span><span> </span><span class="hs-comment">-- that the StreamHead segment is always known &quot;unlocked&quot; to writers.</span><span>
</span><span id="line-220"></span><span> </span><span class="hs-comment">--</span><span>
</span><span id="line-221"></span><span> </span><span class="hs-comment">-- [2] Similarly when in tryWriteChan we only update the stream head when</span><span>
</span><span id="line-222"></span><span> </span><span class="hs-comment">-- we see that it was installed by reader, or we see that it was unlocked,</span><span>
</span><span id="line-223"></span><span> </span><span class="hs-comment">-- but for the latter we check without blocking.</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="hs-comment">-- | Try to write a value to the channel, aborting if the write is likely to</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- exceed the bounds, returning a @Bool@ indicating whether the write was</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- successful.</span><span>
</span><span id="line-230"></span><span class="hs-comment">--</span><span>
</span><span id="line-231"></span><span class="hs-comment">-- This function never blocks, but may occasionally write successfully to a</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- queue that is already &quot;full&quot;. Unlike 'writeChan' this function treats the</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- requested bounds (raised to nearest power of two) strictly, rather than</span><span>
</span><span id="line-234"></span><span class="hs-comment">-- using the @n .. n*2@ range. The more concurrent writes and reads that are</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- happening, the more inaccurate the estimate of the chan's size is likely to</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- be.</span><span>
</span><span id="line-237"></span><span id="local-6989586621679054050"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#tryWriteChan"><span class="hs-identifier hs-type">tryWriteChan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054050"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679054050"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-238"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#tryWriteChan"><span class="hs-pragma hs-type">tryWriteChan</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-239"></span><span id="tryWriteChan"><span class="annot"><span class="annottext">tryWriteChan :: forall a. InChan a -&gt; a -&gt; IO Bool
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#tryWriteChan"><span class="hs-identifier hs-var hs-var">tryWriteChan</span></a></span></span><span> </span><span id="local-6989586621679054293"><span class="annot"><span class="annottext">c :: InChan a
</span><a href="#local-6989586621679054293"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span class="annot"><span class="annottext">IO Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679054294"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054294"><span class="hs-identifier hs-var">boundsMn1</span></a></span></span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">AtomicCounter
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679054295"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054295"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-comment">-- Similar caveats w/r/t counter overflow correctness as elsewhere apply</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-comment">-- here: where this would lap and give incorrect results we have already</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-comment">-- died with OOM:</span><span>
</span><span id="line-243"></span><span>    </span><span id="local-6989586621679054296"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054296"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InChan a -&gt; IO Int
forall a. InChan a -&gt; IO Int
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#estimatedLength"><span class="hs-identifier hs-var">estimatedLength</span></a></span><span> </span><span class="annot"><span class="annottext">InChan a
</span><a href="#local-6989586621679054293"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054296"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054294"><span class="hs-identifier hs-var">boundsMn1</span></a></span><span> </span><span>
</span><span id="line-245"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-246"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; InChan a -&gt; a -&gt; IO ()
forall a. Bool -&gt; InChan a -&gt; a -&gt; IO ()
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writeChanWithBlocking"><span class="hs-identifier hs-var">writeChanWithBlocking</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="annot"><span class="annottext">InChan a
</span><a href="#local-6989586621679054293"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054295"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO Bool -&gt; IO Bool
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span class="hs-comment">-- | Return the estimated length of a bounded queue</span><span>
</span><span id="line-249"></span><span class="hs-comment">--</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- The more concurrent writes and reads that are happening, the more inaccurate</span><span>
</span><span id="line-251"></span><span class="hs-comment">-- the estimate of the chan's size is likely to be.</span><span>
</span><span id="line-252"></span><span id="local-6989586621679054052"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#estimatedLength"><span class="hs-identifier hs-type">estimatedLength</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054052"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span></span><span>
</span><span id="line-253"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#estimatedLength"><span class="hs-pragma hs-type">estimatedLength</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-254"></span><span id="estimatedLength"><span class="annot"><span class="annottext">estimatedLength :: forall a. InChan a -&gt; IO Int
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#estimatedLength"><span class="hs-identifier hs-var hs-var">estimatedLength</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#InChan"><span class="hs-identifier hs-type">InChan</span></a></span><span> </span><span id="local-6989586621679054301"><span class="annot"><span class="annottext">IO Int
</span><a href="#local-6989586621679054301"><span class="hs-identifier hs-var">readCounterReader</span></a></span></span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679054302"><span class="annot"><span class="annottext">AtomicCounter
</span><a href="#local-6989586621679054302"><span class="hs-identifier hs-var">counter</span></a></span></span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621679054303"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054303"><span class="hs-identifier hs-var">ixR</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int
</span><a href="#local-6989586621679054301"><span class="hs-identifier hs-var">readCounterReader</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span id="local-6989586621679054304"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054304"><span class="hs-identifier hs-var">ixW</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AtomicCounter -&gt; IO Int
</span><a href="Data.Atomics.Counter.Fat.html#readCounter"><span class="hs-identifier hs-var">readCounter</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicCounter
</span><a href="#local-6989586621679054302"><span class="hs-identifier hs-var">counter</span></a></span><span>
</span><span id="line-257"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; IO Int
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IO Int) -&gt; Int -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054304"><span class="hs-identifier hs-var">ixW</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054303"><span class="hs-identifier hs-var">ixR</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="hs-comment">-- The core of our 'read' operations, with exception handler:</span><span>
</span><span id="line-260"></span><span id="local-6989586621679054056"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readSegIxUnmasked"><span class="hs-identifier hs-type">readSegIxUnmasked</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054056"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054056"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamSegment"><span class="hs-identifier hs-type">StreamSegment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054056"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054056"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-261"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readSegIxUnmasked"><span class="hs-pragma hs-type">readSegIxUnmasked</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-262"></span><span id="readSegIxUnmasked"><span class="annot"><span class="annottext">readSegIxUnmasked :: forall a. (IO a -&gt; IO a) -&gt; (StreamSegment a, Int) -&gt; IO a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readSegIxUnmasked"><span class="hs-identifier hs-var hs-var">readSegIxUnmasked</span></a></span></span><span> </span><span id="local-6989586621679054313"><span class="annot"><span class="annottext">IO a -&gt; IO a
</span><a href="#local-6989586621679054313"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679054314"><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054314"><span class="hs-identifier hs-var">seg</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679054315"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054315"><span class="hs-identifier hs-var">segIx</span></a></span></span><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>    </span><span id="local-6989586621679054316"><span class="annot"><span class="annottext">Ticket (Cell a)
</span><a href="#local-6989586621679054316"><span class="hs-identifier hs-var">cellTkt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamSegment a -&gt; Int -&gt; IO (Ticket (Cell a))
forall a. MutableArray RealWorld a -&gt; Int -&gt; IO (Ticket a)
</span><span class="hs-identifier hs-var">readArrayElem</span></span><span> </span><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054314"><span class="hs-identifier hs-var">seg</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054315"><span class="hs-identifier hs-var">segIx</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a) -&gt; Cell a
forall a. Ticket a -&gt; a
</span><span class="hs-identifier hs-var">peekTicket</span></span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a)
</span><a href="#local-6989586621679054316"><span class="hs-identifier hs-var">cellTkt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-265"></span><span>         </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Written"><span class="hs-identifier hs-type">Written</span></a></span><span> </span><span id="local-6989586621679054317"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054317"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054317"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-266"></span><span>         </span><span class="annot"><span class="annottext">Cell a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Empty"><span class="hs-identifier hs-var">Empty</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-267"></span><span>            </span><span id="local-6989586621679054318"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054318"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (MVar a)
forall a. IO (MVar a)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.MVar.html#newEmptyMVar"><span class="hs-identifier hs-var">newEmptyMVar</span></a></span><span>
</span><span id="line-268"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679054320"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054320"><span class="hs-identifier hs-var">success</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679054321"><span class="annot"><span class="annottext">Ticket (Cell a)
</span><a href="#local-6989586621679054321"><span class="hs-identifier hs-var">elseWrittenCell</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamSegment a
-&gt; Int -&gt; Ticket (Cell a) -&gt; Cell a -&gt; IO (Bool, Ticket (Cell a))
forall a.
MutableArray RealWorld a
-&gt; Int -&gt; Ticket a -&gt; a -&gt; IO (Bool, Ticket a)
</span><span class="hs-identifier hs-var">casArrayElem</span></span><span> </span><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054314"><span class="hs-identifier hs-var">seg</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054315"><span class="hs-identifier hs-var">segIx</span></a></span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a)
</span><a href="#local-6989586621679054316"><span class="hs-identifier hs-var">cellTkt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar a -&gt; Cell a
forall a. MVar a -&gt; Cell a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Blocking"><span class="hs-identifier hs-var">Blocking</span></a></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054318"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054320"><span class="hs-identifier hs-var">success</span></a></span><span> </span><span>
</span><span id="line-270"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">MVar a -&gt; IO a
</span><a href="#local-6989586621679054322"><span class="hs-identifier hs-var">readBlocking</span></a></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054318"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-271"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a) -&gt; Cell a
forall a. Ticket a -&gt; a
</span><span class="hs-identifier hs-var">peekTicket</span></span><span> </span><span class="annot"><span class="annottext">Ticket (Cell a)
</span><a href="#local-6989586621679054321"><span class="hs-identifier hs-var">elseWrittenCell</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-272"></span><span>                        </span><span class="hs-comment">-- In the meantime a writer has written. Good!</span><span>
</span><span id="line-273"></span><span>                        </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Written"><span class="hs-identifier hs-type">Written</span></a></span><span> </span><span id="local-6989586621679054323"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054323"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054323"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-274"></span><span>                        </span><span class="hs-comment">-- ...or a dupChan reader initiated blocking:</span><span>
</span><span id="line-275"></span><span>                        </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Blocking"><span class="hs-identifier hs-type">Blocking</span></a></span><span> </span><span id="local-6989586621679054324"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054324"><span class="hs-identifier hs-var">v2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MVar a -&gt; IO a
</span><a href="#local-6989586621679054322"><span class="hs-identifier hs-var">readBlocking</span></a></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054324"><span class="hs-identifier hs-var">v2</span></a></span><span>
</span><span id="line-276"></span><span>                        </span><span class="annot"><span class="annottext">Cell a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IO a
forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Impossible! Expecting Written or Blocking&quot;</span></span><span>
</span><span id="line-277"></span><span>         </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Blocking"><span class="hs-identifier hs-type">Blocking</span></a></span><span> </span><span id="local-6989586621679054325"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054325"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MVar a -&gt; IO a
</span><a href="#local-6989586621679054322"><span class="hs-identifier hs-var">readBlocking</span></a></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054325"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-278"></span><span>  </span><span class="hs-comment">-- N.B. must use `readMVar` here to support `dupChan`:</span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679054322"><span class="annot"><span class="annottext">readBlocking :: MVar a -&gt; IO a
</span><a href="#local-6989586621679054322"><span class="hs-identifier hs-var hs-var">readBlocking</span></a></span></span><span> </span><span id="local-6989586621679054326"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054326"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; IO a) -&gt; IO a -&gt; IO a
forall a. a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Magic.html#inline"><span class="hs-identifier hs-var">inline</span></a></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO a
</span><a href="#local-6989586621679054313"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; IO a) -&gt; IO a -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar a -&gt; IO a
forall a. MVar a -&gt; IO a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.MVar.html#readMVar"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054326"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span class="hs-comment">-- factored out for `tryReadChan` below:</span><span>
</span><span id="line-282"></span><span id="local-6989586621679054061"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#startReadChan"><span class="hs-identifier hs-type">startReadChan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-type">OutChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054061"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamSegment"><span class="hs-identifier hs-type">StreamSegment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054061"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-283"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#startReadChan"><span class="hs-pragma hs-type">startReadChan</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-284"></span><span id="startReadChan"><span class="annot"><span class="annottext">startReadChan :: forall a. OutChan a -&gt; IO (StreamSegment a, Int)
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#startReadChan"><span class="hs-identifier hs-var hs-var">startReadChan</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-type">OutChan</span></a></span><span> </span><span id="local-6989586621679054337"><span class="annot"><span class="annottext">ce :: ChanEnd a
</span><a href="#local-6989586621679054337"><span class="hs-identifier hs-var">ce</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679054338"><span class="annot"><span class="annottext">SegSource a
</span><a href="#local-6989586621679054338"><span class="hs-identifier hs-var">segSource</span></a></span></span><span> </span><span class="annot"><span class="annottext">AtomicCounter
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679054339"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054339"><span class="hs-identifier hs-var">segIx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679054340"><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054340"><span class="hs-identifier hs-var">nextSeg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679054341"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679054341"><span class="hs-identifier hs-var">updateStreamHeadIfNecessary</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ChanEnd a -&gt; IO (Int, NextSegment a, IO ())
forall a. Bool -&gt; ChanEnd a -&gt; IO (Int, NextSegment a, IO ())
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#moveToNextCell"><span class="hs-identifier hs-var">moveToNextCell</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#asReader"><span class="hs-identifier hs-var">asReader</span></a></span><span> </span><span class="annot"><span class="annottext">ChanEnd a
</span><a href="#local-6989586621679054337"><span class="hs-identifier hs-var">ce</span></a></span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679054344"><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054344"><span class="hs-identifier hs-var">seg</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679054345"><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
</span><a href="#local-6989586621679054345"><span class="hs-identifier hs-var">next</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054340"><span class="hs-identifier hs-var">nextSeg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-287"></span><span>            </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByReader"><span class="hs-identifier hs-type">NextByReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621679054346"><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054346"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679054347"><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
</span><a href="#local-6989586621679054347"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054346"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
</span><a href="#local-6989586621679054347"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>            </span><span class="annot"><span class="annottext">NextSegment a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; (StreamSegment a, IORef (Maybe (NextSegment a)))
forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;moveToNextCell returned a non-reader-installed next segment to readSegIxUnmasked&quot;</span></span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-comment">-- try to pre-allocate next segment:</span><span>
</span><span id="line-290"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054339"><span class="hs-identifier hs-var">segIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO (NextSegment a) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (NextSegment a) -&gt; IO ()) -&gt; IO (NextSegment a) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-291"></span><span>      </span><span class="annot"><span class="annottext">Bool
-&gt; IORef (Maybe (NextSegment a))
-&gt; SegSource a
-&gt; Int
-&gt; IO (NextSegment a)
forall a.
Bool
-&gt; IORef (Maybe (NextSegment a))
-&gt; SegSource a
-&gt; Int
-&gt; IO (NextSegment a)
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#waitingAdvanceStream"><span class="hs-identifier hs-var">waitingAdvanceStream</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#asReader"><span class="hs-identifier hs-var">asReader</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
</span><a href="#local-6989586621679054345"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><a href="#local-6989586621679054338"><span class="hs-identifier hs-var">segSource</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679054341"><span class="hs-identifier hs-var">updateStreamHeadIfNecessary</span></a></span><span>
</span><span id="line-294"></span><span>    </span><span class="annot"><span class="annottext">(StreamSegment a, Int) -&gt; IO (StreamSegment a, Int)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054344"><span class="hs-identifier hs-var">seg</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054339"><span class="hs-identifier hs-var">segIx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="hs-comment">-- | Returns immediately with:</span><span>
</span><span id="line-299"></span><span class="hs-comment">--</span><span>
</span><span id="line-300"></span><span class="hs-comment">--  - an @'UT.Element' a@ future, which returns one unique element when it</span><span>
</span><span id="line-301"></span><span class="hs-comment">--  becomes available via 'UT.tryRead'.</span><span>
</span><span id="line-302"></span><span class="hs-comment">--</span><span>
</span><span id="line-303"></span><span class="hs-comment">--  - a blocking @IO@ action that returns the element when it becomes available.</span><span>
</span><span id="line-304"></span><span class="hs-comment">--</span><span>
</span><span id="line-305"></span><span class="hs-comment">-- /Note/: This is a destructive operation. See 'UT.Element' for more details.</span><span>
</span><span id="line-306"></span><span class="hs-comment">--</span><span>
</span><span id="line-307"></span><span class="hs-comment">-- /Note re. exceptions/: When an async exception is raised during a @tryReadChan@ </span><span>
</span><span id="line-308"></span><span class="hs-comment">-- the message that the read would have returned is likely to be lost, just as</span><span>
</span><span id="line-309"></span><span class="hs-comment">-- it would be when raised directly after this function returns.</span><span>
</span><span id="line-310"></span><span id="local-6989586621679054066"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#tryReadChan"><span class="hs-identifier hs-type">tryReadChan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-type">OutChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054066"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.NoBlocking.Types.html#Element"><span class="hs-identifier hs-type">UT.Element</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054066"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054066"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-311"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#tryReadChan"><span class="hs-pragma hs-type">tryReadChan</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-312"></span><span id="tryReadChan"><span class="annot"><span class="annottext">tryReadChan :: forall a. OutChan a -&gt; IO (Element a, IO a)
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#tryReadChan"><span class="hs-identifier hs-var hs-var">tryReadChan</span></a></span></span><span> </span><span id="local-6989586621679054359"><span class="annot"><span class="annottext">OutChan a
</span><a href="#local-6989586621679054359"><span class="hs-identifier hs-var">oc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- no mask necessary</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679054360"><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054360"><span class="hs-identifier hs-var">seg</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679054361"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054361"><span class="hs-identifier hs-var">segIx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutChan a -&gt; IO (StreamSegment a, Int)
forall a. OutChan a -&gt; IO (StreamSegment a, Int)
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#startReadChan"><span class="hs-identifier hs-var">startReadChan</span></a></span><span> </span><span class="annot"><span class="annottext">OutChan a
</span><a href="#local-6989586621679054359"><span class="hs-identifier hs-var">oc</span></a></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span>    </span><span class="annot"><span class="annottext">(Element a, IO a) -&gt; IO (Element a, IO a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span>
</span><span id="line-316"></span><span>       </span><span class="annot"><span class="annottext">IO (Maybe a) -&gt; Element a
forall a. IO (Maybe a) -&gt; Element a
</span><a href="Control.Concurrent.Chan.Unagi.NoBlocking.Types.html#Element"><span class="hs-identifier hs-var">UT.Element</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe a) -&gt; Element a) -&gt; IO (Maybe a) -&gt; Element a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-317"></span><span>        </span><span id="local-6989586621679054362"><span class="annot"><span class="annottext">Cell a
</span><a href="#local-6989586621679054362"><span class="hs-identifier hs-var">cell</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MutableArray (PrimState IO) (Cell a) -&gt; Int -&gt; IO (Cell a)
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MutableArray (PrimState m) a -&gt; Int -&gt; m a
</span><span class="hs-identifier hs-var">P.readArray</span></span><span> </span><span class="annot"><span class="annottext">StreamSegment a
MutableArray (PrimState IO) (Cell a)
</span><a href="#local-6989586621679054360"><span class="hs-identifier hs-var">seg</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054361"><span class="hs-identifier hs-var">segIx</span></a></span><span>
</span><span id="line-318"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Cell a
</span><a href="#local-6989586621679054362"><span class="hs-identifier hs-var">cell</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-319"></span><span>             </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Written"><span class="hs-identifier hs-type">Written</span></a></span><span> </span><span id="local-6989586621679054364"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054364"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; IO (Maybe a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; IO (Maybe a)) -&gt; Maybe a -&gt; IO (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679054364"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-320"></span><span>             </span><span class="annot"><span class="annottext">Cell a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Empty"><span class="hs-identifier hs-var">Empty</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; IO (Maybe a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-321"></span><span>             </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Blocking"><span class="hs-identifier hs-type">Blocking</span></a></span><span> </span><span id="local-6989586621679054365"><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054365"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MVar a -&gt; IO (Maybe a)
forall a. MVar a -&gt; IO (Maybe a)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.MVar.html#tryReadMVar"><span class="hs-identifier hs-var">tryReadMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar a
</span><a href="#local-6989586621679054365"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; IO a) -&gt; (StreamSegment a, Int) -&gt; IO a
forall a. (IO a -&gt; IO a) -&gt; (StreamSegment a, Int) -&gt; IO a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readSegIxUnmasked"><span class="hs-identifier hs-var">readSegIxUnmasked</span></a></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamSegment a
</span><a href="#local-6989586621679054360"><span class="hs-identifier hs-var">seg</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054361"><span class="hs-identifier hs-var">segIx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span class="hs-comment">-- | Read an element from the chan, blocking if the chan is empty.</span><span>
</span><span id="line-329"></span><span class="hs-comment">--</span><span>
</span><span id="line-330"></span><span class="hs-comment">-- /Note re. exceptions/: When an async exception is raised during a @readChan@ </span><span>
</span><span id="line-331"></span><span class="hs-comment">-- the message that the read would have returned is likely to be lost, even when</span><span>
</span><span id="line-332"></span><span class="hs-comment">-- the read is known to be blocked on an empty queue. If you need to handle</span><span>
</span><span id="line-333"></span><span class="hs-comment">-- this scenario, you can use 'readChanOnException'.</span><span>
</span><span id="line-334"></span><span id="local-6989586621679054075"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readChan"><span class="hs-identifier hs-type">readChan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-type">OutChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054075"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054075"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-335"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readChan"><span class="hs-pragma hs-type">readChan</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-336"></span><span id="readChan"><span class="annot"><span class="annottext">readChan :: forall a. OutChan a -&gt; IO a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readChan"><span class="hs-identifier hs-var hs-var">readChan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679054369"><span class="annot"><span class="annottext">OutChan a
</span><a href="#local-6989586621679054369"><span class="hs-identifier hs-var">oc</span></a></span></span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OutChan a -&gt; IO (StreamSegment a, Int)
forall a. OutChan a -&gt; IO (StreamSegment a, Int)
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#startReadChan"><span class="hs-identifier hs-var">startReadChan</span></a></span><span> </span><span class="annot"><span class="annottext">OutChan a
</span><a href="#local-6989586621679054369"><span class="hs-identifier hs-var">oc</span></a></span><span> </span><span class="annot"><span class="annottext">IO (StreamSegment a, Int)
-&gt; ((StreamSegment a, Int) -&gt; IO a) -&gt; IO a
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; IO a) -&gt; (StreamSegment a, Int) -&gt; IO a
forall a. (IO a -&gt; IO a) -&gt; (StreamSegment a, Int) -&gt; IO a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readSegIxUnmasked"><span class="hs-identifier hs-var">readSegIxUnmasked</span></a></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span class="hs-comment">-- | Like 'readChan' but allows recovery of the queue element which would have</span><span>
</span><span id="line-339"></span><span class="hs-comment">-- been read, in the case that an async exception is raised during the read. To</span><span>
</span><span id="line-340"></span><span class="hs-comment">-- be precise exceptions are raised, and the handler run, only when</span><span>
</span><span id="line-341"></span><span class="hs-comment">-- @readChanOnException@ is blocking.</span><span>
</span><span id="line-342"></span><span class="hs-comment">--</span><span>
</span><span id="line-343"></span><span class="hs-comment">-- The second argument is a handler that takes a blocking IO action returning</span><span>
</span><span id="line-344"></span><span class="hs-comment">-- the element, and performs some recovery action.  When the handler is called,</span><span>
</span><span id="line-345"></span><span class="hs-comment">-- the passed @IO a@ is the only way to access the element.</span><span>
</span><span id="line-346"></span><span id="local-6989586621679054079"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readChanOnException"><span class="hs-identifier hs-type">readChanOnException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#OutChan"><span class="hs-identifier hs-type">OutChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054079"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054079"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054079"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-347"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readChanOnException"><span class="hs-pragma hs-type">readChanOnException</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-348"></span><span id="readChanOnException"><span class="annot"><span class="annottext">readChanOnException :: forall a. OutChan a -&gt; (IO a -&gt; IO ()) -&gt; IO a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readChanOnException"><span class="hs-identifier hs-var hs-var">readChanOnException</span></a></span></span><span> </span><span id="local-6989586621679054371"><span class="annot"><span class="annottext">OutChan a
</span><a href="#local-6989586621679054371"><span class="hs-identifier hs-var">oc</span></a></span></span><span> </span><span id="local-6989586621679054372"><span class="annot"><span class="annottext">IO a -&gt; IO ()
</span><a href="#local-6989586621679054372"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. IO a -&gt; IO a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-349"></span><span>    </span><span class="annot"><span class="annottext">OutChan a -&gt; IO (StreamSegment a, Int)
forall a. OutChan a -&gt; IO (StreamSegment a, Int)
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#startReadChan"><span class="hs-identifier hs-var">startReadChan</span></a></span><span> </span><span class="annot"><span class="annottext">OutChan a
</span><a href="#local-6989586621679054371"><span class="hs-identifier hs-var">oc</span></a></span><span> </span><span class="annot"><span class="annottext">IO (StreamSegment a, Int)
-&gt; ((StreamSegment a, Int) -&gt; IO a) -&gt; IO a
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span>
</span><span id="line-350"></span><span>      </span><span class="annot"><span class="annottext">(IO a -&gt; IO a) -&gt; (StreamSegment a, Int) -&gt; IO a
forall a. (IO a -&gt; IO a) -&gt; (StreamSegment a, Int) -&gt; IO a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#readSegIxUnmasked"><span class="hs-identifier hs-var">readSegIxUnmasked</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679054373"><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679054373"><span class="hs-identifier hs-var">io</span></a></span></span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679054373"><span class="hs-identifier hs-var">io</span></a></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO () -&gt; IO a
forall a b. IO a -&gt; IO b -&gt; IO a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Exception.Base.html#onException"><span class="hs-operator hs-var">`onException`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO a -&gt; IO ()
</span><a href="#local-6989586621679054372"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679054373"><span class="hs-identifier hs-var">io</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span class="hs-comment">-- increments counter, finds stream segment of corresponding cell (updating the</span><span>
</span><span id="line-355"></span><span class="hs-comment">-- stream head pointer as needed), and returns the stream segment and relative</span><span>
</span><span id="line-356"></span><span class="hs-comment">-- index of our cell.</span><span>
</span><span id="line-357"></span><span id="local-6989586621679054036"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#moveToNextCell"><span class="hs-identifier hs-type">moveToNextCell</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054036"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextSegment"><span class="hs-identifier hs-type">NextSegment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054036"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-358"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#moveToNextCell"><span class="hs-pragma hs-type">moveToNextCell</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-359"></span><span id="moveToNextCell"><span class="annot"><span class="annottext">moveToNextCell :: forall a. Bool -&gt; ChanEnd a -&gt; IO (Int, NextSegment a, IO ())
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#moveToNextCell"><span class="hs-identifier hs-var hs-var">moveToNextCell</span></a></span></span><span> </span><span id="local-6989586621679054388"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054388"><span class="hs-identifier hs-var">isReader</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#ChanEnd"><span class="hs-identifier hs-type">ChanEnd</span></a></span><span> </span><span id="local-6989586621679054389"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054389"><span class="hs-identifier hs-var">logBounds</span></a></span></span><span> </span><span id="local-6989586621679054390"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054390"><span class="hs-identifier hs-var">boundsMn1</span></a></span></span><span> </span><span id="local-6989586621679054391"><span class="annot"><span class="annottext">SegSource a
</span><a href="#local-6989586621679054391"><span class="hs-identifier hs-var">segSource</span></a></span></span><span> </span><span id="local-6989586621679054392"><span class="annot"><span class="annottext">AtomicCounter
</span><a href="#local-6989586621679054392"><span class="hs-identifier hs-var">counter</span></a></span></span><span> </span><span id="local-6989586621679054393"><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054393"><span class="hs-identifier hs-var">streamHead</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-360"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamHead"><span class="hs-identifier hs-type">StreamHead</span></a></span><span> </span><span id="local-6989586621679054394"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054394"><span class="hs-identifier hs-var">offset0</span></a></span></span><span> </span><span id="local-6989586621679054395"><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054395"><span class="hs-identifier hs-var">str0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a) -&gt; IO (StreamHead a)
forall a. IORef a -&gt; IO a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054393"><span class="hs-identifier hs-var">streamHead</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span id="local-6989586621679054396"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054396"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; AtomicCounter -&gt; IO Int
</span><a href="Data.Atomics.Counter.Fat.html#incrCounter"><span class="hs-identifier hs-var">incrCounter</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">AtomicCounter
</span><a href="#local-6989586621679054392"><span class="hs-identifier hs-var">counter</span></a></span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679054399"><span class="annot"><span class="annottext">relIx :: Int
</span><a href="#local-6989586621679054399"><span class="hs-identifier hs-var hs-var">relIx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054396"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054394"><span class="hs-identifier hs-var">offset0</span></a></span><span>
</span><span id="line-363"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679054402"><span class="annot"><span class="annottext">segsAway :: Int
</span><a href="#local-6989586621679054402"><span class="hs-identifier hs-var hs-var">segsAway</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054399"><span class="hs-identifier hs-var">relIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Bits.html#unsafeShiftR"><span class="hs-operator hs-var">`unsafeShiftR`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054389"><span class="hs-identifier hs-var">logBounds</span></a></span><span> </span><span class="hs-comment">-- `div` bounds</span><span>
</span><span id="line-364"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679054405"><span class="annot"><span class="annottext">segIx :: Int
</span><a href="#local-6989586621679054405"><span class="hs-identifier hs-var hs-var">segIx</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054399"><span class="hs-identifier hs-var">relIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Bits.html#.%26."><span class="hs-operator hs-var">.&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054390"><span class="hs-identifier hs-var">boundsMn1</span></a></span><span>            </span><span class="hs-comment">-- `mod` bounds</span><span>
</span><span id="line-365"></span><span>        </span><span class="hs-glyph">~</span><span id="local-6989586621679054411"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054411"><span class="hs-identifier hs-var">nEW_SEGMENT_WAIT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054390"><span class="hs-identifier hs-var">boundsMn1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#div"><span class="hs-operator hs-var">`div`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">12</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">25</span></span><span> </span><span>
</span><span id="line-366"></span><span>    </span><span>
</span><span id="line-367"></span><span>        </span><span id="local-6989586621679054422"><span class="annot"><span class="annottext">go :: t -&gt; NextSegment a -&gt; IO (NextSegment a)
</span><a href="#local-6989586621679054422"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span>  </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679054423"><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054423"><span class="hs-identifier hs-var">nextSeg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NextSegment a -&gt; IO (NextSegment a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054423"><span class="hs-identifier hs-var">nextSeg</span></a></span><span>
</span><span id="line-368"></span><span>        </span><span class="annot"><a href="#local-6989586621679054422"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679054424"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679054424"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679054425"><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054425"><span class="hs-identifier hs-var">nextSeg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-369"></span><span>            </span><span class="annot"><span class="annottext">Bool
-&gt; IORef (Maybe (NextSegment a))
-&gt; SegSource a
-&gt; Int
-&gt; IO (NextSegment a)
forall a.
Bool
-&gt; IORef (Maybe (NextSegment a))
-&gt; SegSource a
-&gt; Int
-&gt; IO (NextSegment a)
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#waitingAdvanceStream"><span class="hs-identifier hs-var">waitingAdvanceStream</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054388"><span class="hs-identifier hs-var">isReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NextSegment a -&gt; IORef (Maybe (NextSegment a))
forall a. NextSegment a -&gt; IORef (Maybe (NextSegment a))
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#getNextRef"><span class="hs-identifier hs-var">getNextRef</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054425"><span class="hs-identifier hs-var">nextSeg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><a href="#local-6989586621679054391"><span class="hs-identifier hs-var">segSource</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054411"><span class="hs-identifier hs-var">nEW_SEGMENT_WAIT</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054405"><span class="hs-identifier hs-var">segIx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- NOTE [1]</span><span>
</span><span id="line-370"></span><span>              </span><span class="annot"><span class="annottext">IO (NextSegment a)
-&gt; (NextSegment a -&gt; IO (NextSegment a)) -&gt; IO (NextSegment a)
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; NextSegment a -&gt; IO (NextSegment a)
</span><a href="#local-6989586621679054422"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679054424"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">t -&gt; t -&gt; t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span class="annot"><span class="annottext">t
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span> </span><span>
</span><span id="line-372"></span><span>    </span><span id="local-6989586621679054427"><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054427"><span class="hs-identifier hs-var">nextSeg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (NextSegment a) -&gt; IO (NextSegment a)
forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054399"><span class="hs-identifier hs-var">relIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (NextSegment a) -&gt; IO (NextSegment a))
-&gt; IO (NextSegment a) -&gt; IO (NextSegment a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-373"></span><span>              </span><span class="hs-comment">-- go segsAway $ NextByReader str0  -- NOTE [2]</span><span>
</span><span id="line-374"></span><span>                 </span><span class="hs-comment">-- NOTE: this is redundant, since `go` doesn't want to get</span><span>
</span><span id="line-375"></span><span>                 </span><span class="hs-comment">-- inlined/unrolled</span><span>
</span><span id="line-376"></span><span>                 </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054402"><span class="hs-identifier hs-var">segsAway</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span>
</span><span id="line-377"></span><span>                     </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">NextSegment a -&gt; IO (NextSegment a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span>      </span><span class="annot"><span class="annottext">(NextSegment a -&gt; IO (NextSegment a))
-&gt; NextSegment a -&gt; IO (NextSegment a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Stream a -&gt; NextSegment a
forall a. Stream a -&gt; NextSegment a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByReader"><span class="hs-identifier hs-var">NextByReader</span></a></span><span> </span><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054395"><span class="hs-identifier hs-var">str0</span></a></span><span> </span><span>
</span><span id="line-378"></span><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; NextSegment a -&gt; IO (NextSegment a)
forall {t}.
(Eq t, Num t) =&gt;
t -&gt; NextSegment a -&gt; IO (NextSegment a)
</span><a href="#local-6989586621679054422"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054402"><span class="hs-identifier hs-var">segsAway</span></a></span><span> </span><span class="annot"><span class="annottext">(NextSegment a -&gt; IO (NextSegment a))
-&gt; NextSegment a -&gt; IO (NextSegment a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Stream a -&gt; NextSegment a
forall a. Stream a -&gt; NextSegment a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByReader"><span class="hs-identifier hs-var">NextByReader</span></a></span><span> </span><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054395"><span class="hs-identifier hs-var">str0</span></a></span><span>  </span><span class="hs-comment">-- NOTE [2]</span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span>    </span><span class="hs-comment">-- writers and readers must perform this continuation at different points:</span><span>
</span><span id="line-381"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679054431"><span class="annot"><span class="annottext">updateStreamHeadIfNecessary :: IO ()
</span><a href="#local-6989586621679054431"><span class="hs-identifier hs-var hs-var">updateStreamHeadIfNecessary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-382"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054402"><span class="hs-identifier hs-var">segsAway</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-383"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679054434"><span class="annot"><span class="annottext">offsetN :: Int
</span><a href="#local-6989586621679054434"><span class="hs-identifier hs-var hs-var">offsetN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">--(segsAway * bounds)</span><span>
</span><span id="line-384"></span><span>                   </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054394"><span class="hs-identifier hs-var">offset0</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054402"><span class="hs-identifier hs-var">segsAway</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Bits.html#unsafeShiftL"><span class="hs-operator hs-var">`unsafeShiftL`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054389"><span class="hs-identifier hs-var">logBounds</span></a></span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-385"></span><span>            </span><span class="annot"><span class="annottext">IORef (StreamHead a) -&gt; StreamHead a -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (StreamHead a)
</span><a href="#local-6989586621679054393"><span class="hs-identifier hs-var">streamHead</span></a></span><span> </span><span class="annot"><span class="annottext">(StreamHead a -&gt; IO ()) -&gt; StreamHead a -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Stream a -&gt; StreamHead a
forall a. Int -&gt; Stream a -&gt; StreamHead a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamHead"><span class="hs-identifier hs-var">StreamHead</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054434"><span class="hs-identifier hs-var">offsetN</span></a></span><span> </span><span class="annot"><span class="annottext">(Stream a -&gt; StreamHead a) -&gt; Stream a -&gt; StreamHead a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a -&gt; Stream a
forall a. NextSegment a -&gt; Stream a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#getStr"><span class="hs-identifier hs-var">getStr</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054427"><span class="hs-identifier hs-var">nextSeg</span></a></span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span>    </span><span class="annot"><span class="annottext">(Int, NextSegment a, IO ()) -&gt; IO (Int, NextSegment a, IO ())
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054405"><span class="hs-identifier hs-var">segIx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054427"><span class="hs-identifier hs-var">nextSeg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679054431"><span class="hs-identifier hs-var">updateStreamHeadIfNecessary</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>  </span><span class="hs-comment">-- [1] All readers or writers needing to work with a not-yet-created segment</span><span>
</span><span id="line-389"></span><span>  </span><span class="hs-comment">-- race to create it, but those past index 0 have progressively long waits.</span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-comment">-- The constant here is an approximation of the way we calculate it in</span><span>
</span><span id="line-391"></span><span>  </span><span class="hs-comment">-- Control.Concurrent.Chan.Unagi.Constants.nEW_SEGMENT_WAIT</span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-comment">-- [2] We start the loop with 'NextByReader' effectively meaning that the head</span><span>
</span><span id="line-394"></span><span>  </span><span class="hs-comment">-- segment was installed by a reader, or really just indicating that the</span><span>
</span><span id="line-395"></span><span>  </span><span class="hs-comment">-- writer has no need to check-in for blocking. This is always the case for</span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-comment">-- the head stream; see `writeChan` NOTE 1.</span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span class="hs-comment">-- TODO play with inlining and look at core; we'd like the conditionals to disappear</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- INVARIANTS: </span><span>
</span><span id="line-402"></span><span class="hs-comment">--   - if isReader, after returning, the nextSegRef will be marked NextByReader</span><span>
</span><span id="line-403"></span><span class="hs-comment">--   - the 'nextSegRef' is only ever modified from Nothing -&gt; Just (NextBy*)</span><span>
</span><span id="line-404"></span><span id="local-6989586621679054065"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#waitingAdvanceStream"><span class="hs-identifier hs-type">waitingAdvanceStream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextSegment"><span class="hs-identifier hs-type">NextSegment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054065"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#SegSource"><span class="hs-identifier hs-type">SegSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054065"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span>
</span><span id="line-405"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextSegment"><span class="hs-identifier hs-type">NextSegment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054065"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-406"></span><span id="waitingAdvanceStream"><span class="annot"><span class="annottext">waitingAdvanceStream :: forall a.
Bool
-&gt; IORef (Maybe (NextSegment a))
-&gt; SegSource a
-&gt; Int
-&gt; IO (NextSegment a)
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#waitingAdvanceStream"><span class="hs-identifier hs-var hs-var">waitingAdvanceStream</span></a></span></span><span> </span><span id="local-6989586621679054439"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054439"><span class="hs-identifier hs-var">isReader</span></a></span></span><span> </span><span id="local-6989586621679054440"><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
</span><a href="#local-6989586621679054440"><span class="hs-identifier hs-var">nextSegRef</span></a></span></span><span> </span><span id="local-6989586621679054441"><span class="annot"><span class="annottext">SegSource a
</span><a href="#local-6989586621679054441"><span class="hs-identifier hs-var">segSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (NextSegment a)
forall {t}. (Ord t, Num t) =&gt; t -&gt; IO (NextSegment a)
</span><a href="#local-6989586621679054442"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-407"></span><span>  </span><span id="local-6989586621679054443"><span class="annot"><span class="annottext">cas :: Ticket (Maybe (NextSegment a))
-&gt; NextSegment a -&gt; IO (Bool, Ticket (Maybe (NextSegment a)))
</span><a href="#local-6989586621679054443"><span class="hs-identifier hs-var hs-var">cas</span></a></span></span><span> </span><span id="local-6989586621679054444"><span class="annot"><span class="annottext">Ticket (Maybe (NextSegment a))
</span><a href="#local-6989586621679054444"><span class="hs-identifier hs-var">tk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
-&gt; Ticket (Maybe (NextSegment a))
-&gt; Maybe (NextSegment a)
-&gt; IO (Bool, Ticket (Maybe (NextSegment a)))
forall a. IORef a -&gt; Ticket a -&gt; a -&gt; IO (Bool, Ticket a)
</span><span class="hs-identifier hs-var">casIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
</span><a href="#local-6989586621679054440"><span class="hs-identifier hs-var">nextSegRef</span></a></span><span> </span><span class="annot"><span class="annottext">Ticket (Maybe (NextSegment a))
</span><a href="#local-6989586621679054444"><span class="hs-identifier hs-var">tk</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (NextSegment a)
 -&gt; IO (Bool, Ticket (Maybe (NextSegment a))))
-&gt; (NextSegment a -&gt; Maybe (NextSegment a))
-&gt; NextSegment a
-&gt; IO (Bool, Ticket (Maybe (NextSegment a)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a -&gt; Maybe (NextSegment a)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span>  </span><span class="hs-comment">-- extract the installed Just NextSegment from the result of the cas</span><span>
</span><span id="line-410"></span><span>  </span><span id="local-6989586621679054449"><span class="annot"><span class="annottext">peekInstalled :: (a, Ticket (Maybe a)) -&gt; a
</span><a href="#local-6989586621679054449"><span class="hs-identifier hs-var hs-var">peekInstalled</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679054450"><span class="annot"><span class="annottext">Ticket (Maybe a)
</span><a href="#local-6989586621679054450"><span class="hs-identifier hs-var">nextSegTk</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-411"></span><span>     </span><span class="annot"><span class="annottext">a -&gt; Maybe a -&gt; a
forall a. a -&gt; Maybe a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; a
forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Impossible! This should only have been a Just NextBy* segment&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; a) -&gt; Maybe a -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-412"></span><span>       </span><span class="annot"><span class="annottext">Ticket (Maybe a) -&gt; Maybe a
forall a. Ticket a -&gt; a
</span><span class="hs-identifier hs-var">peekTicket</span></span><span> </span><span class="annot"><span class="annottext">Ticket (Maybe a)
</span><a href="#local-6989586621679054450"><span class="hs-identifier hs-var">nextSegTk</span></a></span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span>  </span><span id="local-6989586621679054457"><span class="annot"><span class="annottext">readerUnblockAndReturn :: NextSegment a -&gt; IO (NextSegment a)
</span><a href="#local-6989586621679054457"><span class="hs-identifier hs-var hs-var">readerUnblockAndReturn</span></a></span></span><span> </span><span id="local-6989586621679054458"><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054458"><span class="hs-identifier hs-var">nextSeg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (NextSegment a) -&gt; IO (NextSegment a)
forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054439"><span class="hs-identifier hs-var">isReader</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (NextSegment a) -&gt; IO (NextSegment a))
-&gt; IO (NextSegment a) -&gt; IO (NextSegment a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054458"><span class="hs-identifier hs-var">nextSeg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-415"></span><span>      </span><span class="hs-comment">-- if a writer won, try to set as NextByReader so that every writer</span><span>
</span><span id="line-416"></span><span>      </span><span class="hs-comment">-- to this seg doesn't have to check in, and unblockWriters</span><span>
</span><span id="line-417"></span><span>      </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByWriter"><span class="hs-identifier hs-type">NextByWriter</span></a></span><span> </span><span id="local-6989586621679054459"><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054459"><span class="hs-identifier hs-var">strAlreadyInstalled</span></a></span></span><span> </span><span id="local-6989586621679054460"><span class="annot"><span class="annottext">WriterCheckpoint
</span><a href="#local-6989586621679054460"><span class="hs-identifier hs-var">checkpt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-418"></span><span>          </span><span class="annot"><span class="annottext">WriterCheckpoint -&gt; IO ()
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#unblockWriters"><span class="hs-identifier hs-var">unblockWriters</span></a></span><span> </span><span class="annot"><span class="annottext">WriterCheckpoint
</span><a href="#local-6989586621679054460"><span class="hs-identifier hs-var">checkpt</span></a></span><span>  </span><span class="hs-comment">-- idempotent</span><span>
</span><span id="line-419"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679054461"><span class="annot"><span class="annottext">nextSeg' :: NextSegment a
</span><a href="#local-6989586621679054461"><span class="hs-identifier hs-var hs-var">nextSeg'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream a -&gt; NextSegment a
forall a. Stream a -&gt; NextSegment a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByReader"><span class="hs-identifier hs-var">NextByReader</span></a></span><span> </span><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054459"><span class="hs-identifier hs-var">strAlreadyInstalled</span></a></span><span>
</span><span id="line-420"></span><span>          </span><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a)) -&gt; Maybe (NextSegment a) -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
</span><a href="#local-6989586621679054440"><span class="hs-identifier hs-var">nextSegRef</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (NextSegment a) -&gt; IO ()) -&gt; Maybe (NextSegment a) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a -&gt; Maybe (NextSegment a)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054461"><span class="hs-identifier hs-var">nextSeg'</span></a></span><span>
</span><span id="line-421"></span><span>          </span><span class="annot"><span class="annottext">NextSegment a -&gt; IO (NextSegment a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054461"><span class="hs-identifier hs-var">nextSeg'</span></a></span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span>      </span><span id="local-6989586621679054462"><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054462"><span class="hs-identifier hs-var">nextByReader</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NextSegment a -&gt; IO (NextSegment a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054462"><span class="hs-identifier hs-var">nextByReader</span></a></span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span>  </span><span id="local-6989586621679054442"><span class="annot"><span class="annottext">go :: t -&gt; IO (NextSegment a)
</span><a href="#local-6989586621679054442"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679054485"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679054485"><span class="hs-identifier hs-var">wait</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (NextSegment a) -&gt; IO (NextSegment a)
forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679054485"><span class="hs-identifier hs-var">wait</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (NextSegment a) -&gt; IO (NextSegment a))
-&gt; IO (NextSegment a) -&gt; IO (NextSegment a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-426"></span><span>    </span><span id="local-6989586621679054486"><span class="annot"><span class="annottext">Ticket (Maybe (NextSegment a))
</span><a href="#local-6989586621679054486"><span class="hs-identifier hs-var">tk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
-&gt; IO (Ticket (Maybe (NextSegment a)))
forall a. IORef a -&gt; IO (Ticket a)
</span><span class="hs-identifier hs-var">readForCAS</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe (NextSegment a))
</span><a href="#local-6989586621679054440"><span class="hs-identifier hs-var">nextSegRef</span></a></span><span>
</span><span id="line-427"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ticket (Maybe (NextSegment a)) -&gt; Maybe (NextSegment a)
forall a. Ticket a -&gt; a
</span><span class="hs-identifier hs-var">peekTicket</span></span><span> </span><span class="annot"><span class="annottext">Ticket (Maybe (NextSegment a))
</span><a href="#local-6989586621679054486"><span class="hs-identifier hs-var">tk</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-428"></span><span>         </span><span class="hs-comment">-- Rare, slow path: </span><span>
</span><span id="line-429"></span><span>         </span><span class="hs-comment">--   In readers: we outran reader 0 of the previous segment (or it was</span><span>
</span><span id="line-430"></span><span>         </span><span class="hs-comment">--  descheduled) who was tasked with setting this up.</span><span>
</span><span id="line-431"></span><span>         </span><span class="hs-comment">--   In writers: there are number writer threads &gt; bounds, or reader 0</span><span>
</span><span id="line-432"></span><span>         </span><span class="hs-comment">--  of previous segment was slow or descheduled.</span><span>
</span><span id="line-433"></span><span>         </span><span class="annot"><span class="annottext">Maybe (NextSegment a)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span>
</span><span id="line-434"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679054485"><span class="hs-identifier hs-var">wait</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t -&gt; IO (NextSegment a)
</span><a href="#local-6989586621679054442"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679054485"><span class="hs-identifier hs-var">wait</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>             </span><span class="hs-comment">-- Create a potential next segment and try to insert it:</span><span>
</span><span id="line-436"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><span id="line-437"></span><span>               </span><span id="local-6989586621679054488"><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054488"><span class="hs-identifier hs-var">potentialStrNext</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamSegment a -&gt; IORef (Maybe (NextSegment a)) -&gt; Stream a
forall a.
StreamSegment a -&gt; IORef (Maybe (NextSegment a)) -&gt; Stream a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">(StreamSegment a -&gt; IORef (Maybe (NextSegment a)) -&gt; Stream a)
-&gt; SegSource a -&gt; IO (IORef (Maybe (NextSegment a)) -&gt; Stream a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SegSource a
</span><a href="#local-6989586621679054441"><span class="hs-identifier hs-var">segSource</span></a></span><span> </span><span class="annot"><span class="annottext">IO (IORef (Maybe (NextSegment a)) -&gt; Stream a)
-&gt; IO (IORef (Maybe (NextSegment a))) -&gt; IO (Stream a)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (NextSegment a) -&gt; IO (IORef (Maybe (NextSegment a)))
forall a. a -&gt; IO (IORef a)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (NextSegment a)
forall a. Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-438"></span><span>               </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054439"><span class="hs-identifier hs-var">isReader</span></a></span><span>
</span><span id="line-439"></span><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-440"></span><span>                   </span><span class="hs-comment">-- This may fail because of either a competing reader or</span><span>
</span><span id="line-441"></span><span>                   </span><span class="hs-comment">-- writer which certainly modified this to a Just value</span><span>
</span><span id="line-442"></span><span>                   </span><span id="local-6989586621679054489"><span class="annot"><span class="annottext">(Bool, Ticket (Maybe (NextSegment a)))
</span><a href="#local-6989586621679054489"><span class="hs-identifier hs-var">installed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ticket (Maybe (NextSegment a))
-&gt; NextSegment a -&gt; IO (Bool, Ticket (Maybe (NextSegment a)))
</span><a href="#local-6989586621679054443"><span class="hs-identifier hs-var">cas</span></a></span><span> </span><span class="annot"><span class="annottext">Ticket (Maybe (NextSegment a))
</span><a href="#local-6989586621679054486"><span class="hs-identifier hs-var">tk</span></a></span><span> </span><span class="annot"><span class="annottext">(NextSegment a -&gt; IO (Bool, Ticket (Maybe (NextSegment a))))
-&gt; NextSegment a -&gt; IO (Bool, Ticket (Maybe (NextSegment a)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Stream a -&gt; NextSegment a
forall a. Stream a -&gt; NextSegment a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByReader"><span class="hs-identifier hs-var">NextByReader</span></a></span><span> </span><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054488"><span class="hs-identifier hs-var">potentialStrNext</span></a></span><span>
</span><span id="line-443"></span><span>                   </span><span class="hs-comment">-- The segment we're reading from (or any *behind* the one</span><span>
</span><span id="line-444"></span><span>                   </span><span class="hs-comment">-- we're reading from) is always unblocked for writers:</span><span>
</span><span id="line-445"></span><span>                   </span><span class="annot"><span class="annottext">NextSegment a -&gt; IO (NextSegment a)
</span><a href="#local-6989586621679054457"><span class="hs-identifier hs-var">readerUnblockAndReturn</span></a></span><span> </span><span class="annot"><span class="annottext">(NextSegment a -&gt; IO (NextSegment a))
-&gt; NextSegment a -&gt; IO (NextSegment a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool, Ticket (Maybe (NextSegment a))) -&gt; NextSegment a
forall {a} {a}. (a, Ticket (Maybe a)) -&gt; a
</span><a href="#local-6989586621679054449"><span class="hs-identifier hs-var">peekInstalled</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool, Ticket (Maybe (NextSegment a)))
</span><a href="#local-6989586621679054489"><span class="hs-identifier hs-var">installed</span></a></span><span>
</span><span id="line-446"></span><span>                 </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-447"></span><span>                   </span><span id="local-6989586621679054490"><span class="annot"><span class="annottext">WriterCheckpoint
</span><a href="#local-6989586621679054490"><span class="hs-identifier hs-var">potentialCheckpt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; WriterCheckpoint
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#WriterCheckpoint"><span class="hs-identifier hs-var">WriterCheckpoint</span></a></span><span> </span><span class="annot"><span class="annottext">(MVar () -&gt; WriterCheckpoint)
-&gt; IO (MVar ()) -&gt; IO WriterCheckpoint
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO (MVar ())
forall a. IO (MVar a)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.MVar.html#newEmptyMVar"><span class="hs-identifier hs-var">newEmptyMVar</span></a></span><span>
</span><span id="line-448"></span><span>                   </span><span class="hs-comment">-- This may fail because of either a competing reader or</span><span>
</span><span id="line-449"></span><span>                   </span><span class="hs-comment">-- writer which certainly modified this to a Just value</span><span>
</span><span id="line-450"></span><span>                   </span><span class="annot"><span class="annottext">(Bool, Ticket (Maybe (NextSegment a))) -&gt; NextSegment a
forall {a} {a}. (a, Ticket (Maybe a)) -&gt; a
</span><a href="#local-6989586621679054449"><span class="hs-identifier hs-var">peekInstalled</span></a></span><span> </span><span class="annot"><span class="annottext">((Bool, Ticket (Maybe (NextSegment a))) -&gt; NextSegment a)
-&gt; IO (Bool, Ticket (Maybe (NextSegment a))) -&gt; IO (NextSegment a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ticket (Maybe (NextSegment a))
-&gt; NextSegment a -&gt; IO (Bool, Ticket (Maybe (NextSegment a)))
</span><a href="#local-6989586621679054443"><span class="hs-identifier hs-var">cas</span></a></span><span> </span><span class="annot"><span class="annottext">Ticket (Maybe (NextSegment a))
</span><a href="#local-6989586621679054486"><span class="hs-identifier hs-var">tk</span></a></span><span> </span><span class="annot"><span class="annottext">(NextSegment a -&gt; IO (Bool, Ticket (Maybe (NextSegment a))))
-&gt; NextSegment a -&gt; IO (Bool, Ticket (Maybe (NextSegment a)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span>
</span><span id="line-451"></span><span>                           </span><span class="annot"><span class="annottext">Stream a -&gt; WriterCheckpoint -&gt; NextSegment a
forall a. Stream a -&gt; WriterCheckpoint -&gt; NextSegment a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#NextByWriter"><span class="hs-identifier hs-var">NextByWriter</span></a></span><span> </span><span class="annot"><span class="annottext">Stream a
</span><a href="#local-6989586621679054488"><span class="hs-identifier hs-var">potentialStrNext</span></a></span><span> </span><span class="annot"><span class="annottext">WriterCheckpoint
</span><a href="#local-6989586621679054490"><span class="hs-identifier hs-var">potentialCheckpt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>   </span><span>
</span><span id="line-453"></span><span>         </span><span class="hs-comment">-- Fast path: Another reader or writer has already advanced the</span><span>
</span><span id="line-454"></span><span>         </span><span class="hs-comment">-- stream. Most likely reader 0 of the last segment.</span><span>
</span><span id="line-455"></span><span>         </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679054492"><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054492"><span class="hs-identifier hs-var">nextSeg</span></a></span></span><span> </span><span>
</span><span id="line-456"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679054439"><span class="hs-identifier hs-var">isReader</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NextSegment a -&gt; IO (NextSegment a)
</span><a href="#local-6989586621679054457"><span class="hs-identifier hs-var">readerUnblockAndReturn</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054492"><span class="hs-identifier hs-var">nextSeg</span></a></span><span>
</span><span id="line-457"></span><span>           </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NextSegment a -&gt; IO (NextSegment a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">NextSegment a
</span><a href="#local-6989586621679054492"><span class="hs-identifier hs-var">nextSeg</span></a></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span class="hs-keyword">type</span><span> </span><span id="SegSource"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#SegSource"><span class="hs-identifier hs-var">SegSource</span></a></span></span><span> </span><span id="local-6989586621679054493"><span class="annot"><a href="#local-6989586621679054493"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#StreamSegment"><span class="hs-identifier hs-type">StreamSegment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054493"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span id="local-6989586621679054006"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#newSegmentSource"><span class="hs-identifier hs-type">newSegmentSource</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#SegSource"><span class="hs-identifier hs-type">SegSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679054006"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-462"></span><span id="newSegmentSource"><span class="annot"><span class="annottext">newSegmentSource :: forall a. Int -&gt; IO (SegSource a)
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#newSegmentSource"><span class="hs-identifier hs-var hs-var">newSegmentSource</span></a></span></span><span> </span><span id="local-6989586621679054499"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054499"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-comment">-- NOTE: evaluate Empty seems to be required here in order to not raise</span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-comment">-- &quot;Stored Empty Ticket went stale!&quot;  exception when in GHCi.</span><span>
</span><span id="line-465"></span><span>    </span><span id="local-6989586621679054500"><span class="annot"><span class="annottext">MutableArray RealWorld (Cell a)
</span><a href="#local-6989586621679054500"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cell a -&gt; IO (Cell a)
forall a. a -&gt; IO a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.html#evaluate"><span class="hs-identifier hs-var">evaluate</span></a></span><span> </span><span class="annot"><span class="annottext">Cell a
forall a. Cell a
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#Empty"><span class="hs-identifier hs-var">Empty</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Cell a) -&gt; (Cell a -&gt; SegSource a) -&gt; SegSource a
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Cell a -&gt; IO (MutableArray (PrimState IO) (Cell a))
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
Int -&gt; a -&gt; m (MutableArray (PrimState m) a)
</span><span class="hs-identifier hs-var">P.newArray</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054499"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-466"></span><span>    </span><span class="annot"><span class="annottext">SegSource a -&gt; IO (SegSource a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableArray (PrimState IO) (Cell a)
-&gt; Int -&gt; Int -&gt; IO (MutableArray (PrimState IO) (Cell a))
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MutableArray (PrimState m) a
-&gt; Int -&gt; Int -&gt; m (MutableArray (PrimState m) a)
</span><span class="hs-identifier hs-var">P.cloneMutableArray</span></span><span> </span><span class="annot"><span class="annottext">MutableArray RealWorld (Cell a)
MutableArray (PrimState IO) (Cell a)
</span><a href="#local-6989586621679054500"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679054499"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span class="hs-comment">-- This begins empty, but several readers will `put` without coordination, to</span><span>
</span><span id="line-470"></span><span class="hs-comment">-- ensure it's filled. Meanwhile writers are blocked on a `readMVar` (see</span><span>
</span><span id="line-471"></span><span class="hs-comment">-- writerCheckin) waiting to proceed. </span><span>
</span><span id="line-472"></span><span class="hs-keyword">newtype</span><span> </span><span id="WriterCheckpoint"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#WriterCheckpoint"><span class="hs-identifier hs-var">WriterCheckpoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="WriterCheckpoint"><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#WriterCheckpoint"><span class="hs-identifier hs-var">WriterCheckpoint</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span>
</span><span id="line-474"></span><span class="hs-comment">-- idempotent</span><span>
</span><span id="line-475"></span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#unblockWriters"><span class="hs-identifier hs-type">unblockWriters</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#WriterCheckpoint"><span class="hs-identifier hs-type">WriterCheckpoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span id="unblockWriters"><span class="annot"><span class="annottext">unblockWriters :: WriterCheckpoint -&gt; IO ()
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#unblockWriters"><span class="hs-identifier hs-var hs-var">unblockWriters</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#WriterCheckpoint"><span class="hs-identifier hs-type">WriterCheckpoint</span></a></span><span> </span><span id="local-6989586621679054504"><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679054504"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-477"></span><span>    </span><span class="annot"><span class="annottext">IO Bool -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO ()) -&gt; IO Bool -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; () -&gt; IO Bool
forall a. MVar a -&gt; a -&gt; IO Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.MVar.html#tryPutMVar"><span class="hs-identifier hs-var">tryPutMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679054504"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span class="hs-comment">-- A writer knows that it doesn't need to call this when:</span><span>
</span><span id="line-480"></span><span class="hs-comment">--   - its segment is in the StreamHead, or...</span><span>
</span><span id="line-481"></span><span class="hs-comment">--   - its segment was reached by a NextByReader</span><span>
</span><span id="line-482"></span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writerCheckin"><span class="hs-identifier hs-type">writerCheckin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#WriterCheckpoint"><span class="hs-identifier hs-type">WriterCheckpoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span id="writerCheckin"><span class="annot"><span class="annottext">writerCheckin :: WriterCheckpoint -&gt; IO ()
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#writerCheckin"><span class="hs-identifier hs-var hs-var">writerCheckin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#WriterCheckpoint"><span class="hs-identifier hs-type">WriterCheckpoint</span></a></span><span> </span><span id="local-6989586621679054506"><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679054506"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-484"></span><span class="hs-comment">-- On GHC &gt; 7.8 we have an atomic `readMVar`.  On earlier GHC readMVar is</span><span>
</span><span id="line-485"></span><span class="hs-comment">-- take+put, creating a race condition; in this case we use take+tryPut</span><span>
</span><span id="line-486"></span><span class="hs-comment">-- ensuring the MVar stays full even if a reader's tryPut slips an () in:</span><span class="hs-cpp">
#if __GLASGOW_HASKELL__ &lt; 708
</span><span>    </span><span class="hs-identifier">takeMVar</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">void</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">tryPutMVar</span><span> </span><span class="hs-identifier">v</span><span class="hs-cpp">
#else
</span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; IO ()
forall a. MVar a -&gt; IO a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.MVar.html#readMVar"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679054506"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-493"></span><span class="hs-comment">-- returns immediately indicating whether the checkpt is currently unblocked.</span><span>
</span><span id="line-494"></span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#tryWriterCheckin"><span class="hs-identifier hs-type">tryWriterCheckin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#WriterCheckpoint"><span class="hs-identifier hs-type">WriterCheckpoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-495"></span><span id="tryWriterCheckin"><span class="annot"><span class="annottext">tryWriterCheckin :: WriterCheckpoint -&gt; IO Bool
</span><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#tryWriterCheckin"><span class="hs-identifier hs-var hs-var">tryWriterCheckin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Chan.Unagi.Bounded.Internal.html#WriterCheckpoint"><span class="hs-identifier hs-type">WriterCheckpoint</span></a></span><span> </span><span id="local-6989586621679054507"><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679054507"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-496"></span><span class="hs-comment">-- On GHC &gt; 7.8 we have an atomic `tryReadMVar`.  On earlier GHC readMVar is</span><span>
</span><span id="line-497"></span><span class="hs-comment">-- take+put, creating a race condition; in this case we use take+tryPut</span><span>
</span><span id="line-498"></span><span class="hs-comment">-- ensuring the MVar stays full even if a reader's tryPut slips an () in.</span><span>
</span><span id="line-499"></span><span class="hs-comment">-- HOWEVER, tryReadMVar is also buggy in GHC &lt; 7.8.3</span><span>
</span><span id="line-500"></span><span class="hs-comment">--   https://ghc.haskell.org/trac/ghc/ticket/9148</span><span class="hs-cpp">
#ifdef TRYREADMVAR
</span><span>    </span><span class="annot"><span class="annottext">Maybe () -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe () -&gt; Bool) -&gt; IO (Maybe ()) -&gt; IO Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; IO (Maybe ())
forall a. MVar a -&gt; IO (Maybe a)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.MVar.html#tryReadMVar"><span class="hs-identifier hs-var">tryReadMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679054507"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-cpp">
#else
</span><span>    </span><span class="hs-identifier">tryTakeMVar</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">False</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">True</span><span> </span><span class="hs-operator">&lt;$</span><span class="hs-special">)</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">tryPutMVar</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span></pre></body></html>