<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds                #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveFunctor            #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts         #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances        #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE GADTs                    #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE PolyKinds                #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes               #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses    #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving       #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE StandaloneKindSignatures #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators            #-}</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- TODO: the 'Functor' instance of 'Peer' is undecidable</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances     #-}</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-comment">-- | Protocol stateful EDSL.</span><span>
</span><span id="line-16"></span><span class="hs-comment">--</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- __Note__: 'Network.TypedProtocol.Peer.Client.Client' and</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- 'Network.TypedProtocol.Peer.Server.Server' patterns are easier to use.</span><span>
</span><span id="line-19"></span><span class="hs-comment">--</span><span>
</span><span id="line-20"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.TypedProtocol.Stateful.Peer</span><span>
</span><span id="line-21"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Peer"><span class="hs-identifier">Peer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Kind.html"><span class="hs-identifier">Data.Kind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.TypedProtocol.Core</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Core</span></span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-comment">-- | A description of a peer that engages in a protocol.</span><span>
</span><span id="line-30"></span><span class="hs-comment">--</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- The protocol describes what messages peers /may/ send or /must/ accept.</span><span>
</span><span id="line-32"></span><span class="hs-comment">-- A particular peer implementation decides what to actually do within the</span><span>
</span><span id="line-33"></span><span class="hs-comment">-- constraints of the protocol.</span><span>
</span><span id="line-34"></span><span class="hs-comment">--</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- Peers engage in a protocol in either the client or server role. Of course</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- the client role can only interact with the serve role for the same protocol</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- and vice versa.</span><span>
</span><span id="line-38"></span><span class="hs-comment">--</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- 'Peer' has several type arguments:</span><span>
</span><span id="line-40"></span><span class="hs-comment">--</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- * the protocol itself;</span><span>
</span><span id="line-42"></span><span class="hs-comment">-- * the client\/server role;</span><span>
</span><span id="line-43"></span><span class="hs-comment">-- *.the current protocol state;</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- * the local state type;</span><span>
</span><span id="line-45"></span><span class="hs-comment">-- * the monad in which the peer operates; and</span><span>
</span><span id="line-46"></span><span class="hs-comment">-- * the type of any final result once the peer terminates.</span><span>
</span><span id="line-47"></span><span class="hs-comment">--</span><span>
</span><span id="line-48"></span><span class="hs-comment">-- For example:</span><span>
</span><span id="line-49"></span><span class="hs-comment">--</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- &gt; reqRespClientExample :: Peer (ReqResp FileAPI) AsClient StIdle State m ()</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- &gt; reqRespServerExample :: Peer (ReqResp FileAPI) AsServer StIdle State m Int</span><span>
</span><span id="line-52"></span><span class="hs-comment">--</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- The actions that a peer can take are:</span><span>
</span><span id="line-54"></span><span class="hs-comment">--</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- * perform a local monadic effect,</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- * terminate with a result (but only in a terminal protocol state),</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- * send a message (but only in a protocol state in which we have agency),</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- * wait to receive a message (but only in a protocol state in which the</span><span>
</span><span id="line-59"></span><span class="hs-comment">--   other peer has agency).</span><span>
</span><span id="line-60"></span><span class="hs-comment">--</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- The 'Yield', 'Await' and 'Done' constructors require to provide an evidence</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- that the appropriate peer has agency.  This information is supplied using</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- one of the constructors of 'ReflRelativeAgency'.</span><span>
</span><span id="line-64"></span><span class="hs-comment">--</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- While this evidence must be provided, the types guarantee that it is not</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- possible to supply incorrect evidence.  The</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- 'Network.TypedProtocol.Peer.Client' or 'Network.TypedProtocol.Peer.Server'</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- pattern synonyms provide this evidence automatically.</span><span>
</span><span id="line-69"></span><span class="hs-comment">--</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- TODO:</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- We are not exposing pipelined version, since it is not possible to write</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- a driver &amp; proofs in a type safe which take into account the state when the</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- peer type only tracks depth of pipelining rather than pipelined transitions.</span><span>
</span><span id="line-74"></span><span class="hs-comment">--</span><span>
</span><span id="line-75"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679050991"><span class="annot"><a href="#local-6989586621679050991"><span class="hs-identifier hs-type">ps</span></a></span></span><span>
</span><span id="line-76"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PeerRole</span></span><span>
</span><span id="line-77"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679050991"><span class="hs-identifier hs-type">ps</span></a></span><span>
</span><span id="line-78"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679050991"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>          </span><span class="hs-comment">-- ^ protocol state</span><span>
</span><span id="line-80"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>          </span><span class="hs-comment">-- ^ monad's kind</span><span>
</span><span id="line-82"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-83"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">data</span><span> </span><span id="Peer"><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Peer"><span class="hs-identifier hs-var">Peer</span></a></span></span><span> </span><span id="local-6989586621679050992"><span class="annot"><a href="#local-6989586621679050992"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679050993"><span class="annot"><a href="#local-6989586621679050993"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679050994"><span class="annot"><a href="#local-6989586621679050994"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679050995"><span class="annot"><a href="#local-6989586621679050995"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621679050996"><span class="annot"><a href="#local-6989586621679050996"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679050997"><span class="annot"><a href="#local-6989586621679050997"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-comment">-- | Perform a local monadic effect and then continue.</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-comment">-- Example:</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-comment">-- &gt; Effect $ do</span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-comment">-- &gt;   ...          -- actions in the monad</span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-comment">-- &gt;   return $ ... -- another Peer value</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-94"></span><span>  </span><span id="Effect"><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Effect"><span class="hs-identifier hs-var">Effect</span></a></span></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679050999"><span class="annot"><a href="#local-6989586621679050999"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679051000"><span class="annot"><a href="#local-6989586621679051000"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span id="local-6989586621679051001"><span class="annot"><a href="#local-6989586621679051001"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679051002"><span class="annot"><a href="#local-6989586621679051002"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621679051003"><span class="annot"><a href="#local-6989586621679051003"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679051004"><span class="annot"><a href="#local-6989586621679051004"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-96"></span><span>       </span><span class="annot"><a href="#local-6989586621679051003"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679050999"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051000"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051001"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051002"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051003"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051004"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ monadic continuation</span></span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-glyph">-&gt;</span><span>    </span><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679050999"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051000"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051001"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051002"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051003"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051004"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-comment">-- | Send a message to the other peer and then continue. The constructor</span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-comment">-- requires evidence that we have agency for this protocol state and thus are</span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-comment">-- allowed to send messages.  It takes local state associated to the source</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-comment">-- and target protocol state of the message that is sent.  This state is only</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-comment">-- maintained locally, never shared remotely.  It also takes the message and</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-comment">-- the continuation. It also requires evidence that we have agency for this</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-comment">-- protocol state and thus are allowed to send messages.</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-comment">-- Example:</span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-comment">-- &gt; Yield ReflClientAgency (StateBusy (ReadFile /etc/os-release))</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-comment">-- &gt;                        StateIdle</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-comment">-- &gt;                      $ MsgResp &quot;...&quot;</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-114"></span><span>  </span><span id="Yield"><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Yield"><span class="hs-identifier hs-var">Yield</span></a></span></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679051005"><span class="annot"><a href="#local-6989586621679051005"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679051006"><span class="annot"><a href="#local-6989586621679051006"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679051007"><span class="annot"><a href="#local-6989586621679051007"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679051005"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679051008"><span class="annot"><a href="#local-6989586621679051008"><span class="hs-identifier hs-type">st'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679051005"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679051009"><span class="annot"><a href="#local-6989586621679051009"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621679051010"><span class="annot"><a href="#local-6989586621679051010"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679051011"><span class="annot"><a href="#local-6989586621679051011"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-116"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateTokenI</span></span><span> </span><span class="annot"><a href="#local-6989586621679051007"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-117"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateTokenI</span></span><span> </span><span class="annot"><a href="#local-6989586621679051008"><span class="hs-identifier hs-type">st'</span></a></span><span>
</span><span id="line-118"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ActiveState</span></span><span> </span><span class="annot"><a href="#local-6989586621679051007"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-119"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WeHaveAgencyProof</span></span><span> </span><span class="annot"><a href="#local-6989586621679051006"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051007"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-121"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ agency singleton</span></span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679051009"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051007"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ associated local state to the source protocol state 'st'</span></span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679051009"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051008"><span class="hs-identifier hs-type">st'</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ associated local state to the target protocol state `st'`</span></span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Message</span></span><span> </span><span class="annot"><a href="#local-6989586621679051005"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051007"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051008"><span class="hs-identifier hs-type">st'</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ protocol message</span></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051005"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051006"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051008"><span class="hs-identifier hs-type">st'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051009"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051010"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051011"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ continuation</span></span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051005"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051006"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051007"><span class="hs-identifier hs-type">st</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679051009"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051010"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051011"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-comment">-- | Waits to receive a message from the other peer and then continues.</span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-comment">-- This takes the continuation that is supplied with the received message. It</span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-comment">-- also requires evidence that the other peer has agency for this protocol</span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-comment">-- state and thus we are expected to wait to receive messages.</span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-comment">-- Note that the continuation that gets supplied with the message must be</span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-comment">-- prepared to deal with /any/ message that is allowed in /this/ protocol</span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-comment">-- state. This is why the continuation /must/ be polymorphic in the target</span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-comment">-- state of the message (the third type argument of 'Message').</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-comment">-- Example:</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-comment">-- &gt; Await ReflClientAgency $ \f msg -&gt;</span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-comment">-- &gt; case (f, msg) of</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-comment">-- &gt;   (StateBusy (ReadFile path), MsgResp resp) -&gt;</span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-comment">-- &gt;     ( _continuation</span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-comment">-- &gt;     , StateIdle</span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-comment">-- &gt;     )</span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-152"></span><span>  </span><span id="Await"><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Await"><span class="hs-identifier hs-var">Await</span></a></span></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679051014"><span class="annot"><a href="#local-6989586621679051014"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679051015"><span class="annot"><a href="#local-6989586621679051015"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679051016"><span class="annot"><a href="#local-6989586621679051016"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679051014"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679051017"><span class="annot"><a href="#local-6989586621679051017"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621679051018"><span class="annot"><a href="#local-6989586621679051018"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679051019"><span class="annot"><a href="#local-6989586621679051019"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-154"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateTokenI</span></span><span> </span><span class="annot"><a href="#local-6989586621679051016"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-155"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ActiveState</span></span><span> </span><span class="annot"><a href="#local-6989586621679051016"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-156"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TheyHaveAgencyProof</span></span><span> </span><span class="annot"><a href="#local-6989586621679051015"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051016"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ agency singleton</span></span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679051021"><span class="annot"><a href="#local-6989586621679051021"><span class="hs-identifier hs-type">st'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679051014"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span class="hs-operator">.</span><span>
</span><span id="line-160"></span><span>           </span><span class="annot"><a href="#local-6989586621679051017"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051016"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-161"></span><span>        </span><span class="hs-comment">-- associated local state to the source protocol state 'st'</span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-163"></span><span>        </span><span class="hs-comment">-- TODO: input-output-hk/typed-protocols#57</span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Message</span></span><span> </span><span class="annot"><a href="#local-6989586621679051014"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051016"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051021"><span class="hs-identifier hs-type">st'</span></a></span><span>
</span><span id="line-165"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051014"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051015"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051021"><span class="hs-identifier hs-type">st'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051017"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051018"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051019"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-166"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679051017"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051021"><span class="hs-identifier hs-type">st'</span></a></span><span>
</span><span id="line-167"></span><span>           </span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>         </span><span class="hs-comment">-- continuation and associated local state to the target protocol</span><span>
</span><span id="line-169"></span><span>         </span><span class="hs-comment">-- state `st'`</span><span>
</span><span id="line-170"></span><span>         </span><span class="hs-comment">--</span><span>
</span><span id="line-171"></span><span>         </span><span class="hs-comment">-- NOTE: the API is limited to pure transition of local state e.g.</span><span>
</span><span id="line-172"></span><span>         </span><span class="hs-comment">-- `f st -&gt; Message ps st st' -&gt; f st'`,</span><span>
</span><span id="line-173"></span><span>         </span><span class="hs-comment">-- see https://github.com/input-output-hk/typed-protocols/discussions/63</span><span>
</span><span id="line-174"></span><span>         </span><span class="hs-comment">--</span><span>
</span><span id="line-175"></span><span>         </span><span class="hs-comment">-- TODO: input-output-hk/typed-protocols#57</span><span>
</span><span id="line-176"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ continuation</span></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051014"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051015"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051016"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051017"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051018"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051019"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-comment">-- | Terminate with a result. A state token must be provided from the</span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-comment">-- 'NobodyHasAgency' states, to show that this is a state in which we can</span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-comment">-- terminate.</span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-comment">-- Example:</span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-comment">-- &gt; Yield ReflClientAgency</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-comment">-- &gt;        MsgDone</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-comment">-- &gt;       (Done ReflNobodyAgency TokDone result)</span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-190"></span><span>  </span><span id="Done"><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Done"><span class="hs-identifier hs-var">Done</span></a></span></span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679051023"><span class="annot"><a href="#local-6989586621679051023"><span class="hs-identifier hs-type">ps</span></a></span></span><span> </span><span id="local-6989586621679051024"><span class="annot"><a href="#local-6989586621679051024"><span class="hs-identifier hs-type">pr</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679051025"><span class="annot"><a href="#local-6989586621679051025"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679051023"><span class="hs-identifier hs-type">ps</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679051026"><span class="annot"><a href="#local-6989586621679051026"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621679051027"><span class="annot"><a href="#local-6989586621679051027"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679051028"><span class="annot"><a href="#local-6989586621679051028"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-192"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateTokenI</span></span><span> </span><span class="annot"><a href="#local-6989586621679051025"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-193"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateAgency</span></span><span> </span><span class="annot"><a href="#local-6989586621679051025"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NobodyAgency</span></span><span>
</span><span id="line-194"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NobodyHasAgencyProof</span></span><span> </span><span class="annot"><a href="#local-6989586621679051024"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051025"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ (no) agency proof</span></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679051028"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ returned value</span></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051023"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051024"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051025"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051026"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679051028"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span id="local-6989586621679050944"><span id="local-6989586621679050945"><span id="local-6989586621679050946"><span id="local-6989586621679050947"><span id="local-6989586621679050948"><span id="local-6989586621679051031"><span id="local-6989586621679051035"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Functor"><span class="hs-identifier hs-type">Functor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679050945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Functor"><span class="hs-identifier hs-type">Functor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TypedProtocol.Stateful.Peer.html#Peer"><span class="hs-identifier hs-type">Peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679050944"><span class="hs-identifier hs-type">ps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679050946"><span class="hs-identifier hs-type">pr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679050947"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679050948"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679050945"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span></span><span>
</span><span id="line-202"></span></pre></body></html>