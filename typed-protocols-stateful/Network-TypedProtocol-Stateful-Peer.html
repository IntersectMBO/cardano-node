<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Network.TypedProtocol.Stateful.Peer</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">typed-protocols-stateful-0.3.0.0: A framework for strongly typed protocols</span><ul class="links" id="page-menu"><li><a href="src/Network.TypedProtocol.Stateful.Peer.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>Safe-Inferred</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Network.TypedProtocol.Stateful.Peer</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Protocol stateful EDSL.</p><p><strong>Note</strong>: <code><a href="Network-TypedProtocol-Peer-Client.html#v:Client" title="Network.TypedProtocol.Peer.Client">Client</a></code> and
 <code><a href="Network-TypedProtocol-Peer-Server.html#v:Server" title="Network.TypedProtocol.Peer.Server">Server</a></code> patterns are easier to use.</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><span class="keyword">data</span> <a href="#t:Peer">Peer</a> ps pr st f m a <span class="keyword">where</span><ul class="subs"><li><a href="#v:Effect">Effect</a> :: <span class="keyword">forall</span> ps pr st f m a. m (<a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m a) -&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m a</li><li><a href="#v:Yield">Yield</a> :: <span class="keyword">forall</span> ps pr (st :: ps) (st' :: ps) f m a. (<a href="Network-TypedProtocol-Stateful-Codec.html#t:StateTokenI" title="Network.TypedProtocol.Stateful.Codec">StateTokenI</a> st, <a href="Network-TypedProtocol-Stateful-Codec.html#t:StateTokenI" title="Network.TypedProtocol.Stateful.Codec">StateTokenI</a> st', <a href="Network-TypedProtocol-Stateful-Codec.html#t:ActiveState" title="Network.TypedProtocol.Stateful.Codec">ActiveState</a> st) =&gt; WeHaveAgencyProof pr st -&gt; f st -&gt; f st' -&gt; Message ps st st' -&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st' f m a -&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m a</li><li><a href="#v:Await">Await</a> :: <span class="keyword">forall</span> ps pr (st :: ps) f m a. (<a href="Network-TypedProtocol-Stateful-Codec.html#t:StateTokenI" title="Network.TypedProtocol.Stateful.Codec">StateTokenI</a> st, <a href="Network-TypedProtocol-Stateful-Codec.html#t:ActiveState" title="Network.TypedProtocol.Stateful.Codec">ActiveState</a> st) =&gt; TheyHaveAgencyProof pr st -&gt; (<span class="keyword">forall</span> (st' :: ps). f st -&gt; Message ps st st' -&gt; (<a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st' f m a, f st')) -&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m a</li><li><a href="#v:Done">Done</a> :: <span class="keyword">forall</span> ps pr (st :: ps) f m a. (<a href="Network-TypedProtocol-Stateful-Codec.html#t:StateTokenI" title="Network.TypedProtocol.Stateful.Codec">StateTokenI</a> st, StateAgency st <a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/Data-Type-Equality.html#t:-126-" title="Data.Type.Equality">~</a> NobodyAgency) =&gt; NobodyHasAgencyProof pr st -&gt; a -&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m a</li></ul></li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:Peer" class="def">Peer</a> ps pr st f m a <span class="keyword">where</span> <a href="src/Network.TypedProtocol.Stateful.Peer.html#Peer" class="link">Source</a> <a href="#t:Peer" class="selflink">#</a></p><div class="doc"><p>A description of a peer that engages in a protocol.</p><p>The protocol describes what messages peers <em>may</em> send or <em>must</em> accept.
 A particular peer implementation decides what to actually do within the
 constraints of the protocol.</p><p>Peers engage in a protocol in either the client or server role. Of course
 the client role can only interact with the serve role for the same protocol
 and vice versa.</p><p><code><a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a></code> has several type arguments:</p><ul><li>the protocol itself;</li><li>the client/server role;</li><li>.the current protocol state;</li><li>the local state type;</li><li>the monad in which the peer operates; and</li><li>the type of any final result once the peer terminates.</li></ul><p>For example:</p><pre>reqRespClientExample :: Peer (ReqResp FileAPI) AsClient StIdle State m ()
reqRespServerExample :: Peer (ReqResp FileAPI) AsServer StIdle State m Int</pre><p>The actions that a peer can take are:</p><ul><li>perform a local monadic effect,</li><li>terminate with a result (but only in a terminal protocol state),</li><li>send a message (but only in a protocol state in which we have agency),</li><li>wait to receive a message (but only in a protocol state in which the
   other peer has agency).</li></ul><p>The <code><a href="Network-TypedProtocol-Stateful-Peer.html#v:Yield" title="Network.TypedProtocol.Stateful.Peer">Yield</a></code>, <code><a href="Network-TypedProtocol-Stateful-Peer.html#v:Await" title="Network.TypedProtocol.Stateful.Peer">Await</a></code> and <code><a href="Network-TypedProtocol-Stateful-Peer.html#v:Done" title="Network.TypedProtocol.Stateful.Peer">Done</a></code> constructors require to provide an evidence
 that the appropriate peer has agency.  This information is supplied using
 one of the constructors of <code>ReflRelativeAgency</code>.</p><p>While this evidence must be provided, the types guarantee that it is not
 possible to supply incorrect evidence.  The
 <code><a href="Network-TypedProtocol-Peer.html#v:Client" title="Network.TypedProtocol.Peer">Client</a></code> or <code><a href="Network-TypedProtocol-Peer.html#v:Server" title="Network.TypedProtocol.Peer">Server</a></code>
 pattern synonyms provide this evidence automatically.</p><p>TODO:
 We are not exposing pipelined version, since it is not possible to write
 a driver &amp; proofs in a type safe which take into account the state when the
 peer type only tracks depth of pipelining rather than pipelined transitions.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:Effect" class="def">Effect</a></td><td class="doc"><p>Perform a local monadic effect and then continue.</p><p>Example:</p><pre>Effect $ do
  ...          -- actions in the monad
  return $ ... -- another Peer value</pre></td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src">:: <span class="keyword">forall</span> ps pr st f m a. m (<a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m a)</dfn><div class="doc"><p>monadic continuation</p></div></li><li><dfn class="src">-&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m a</dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr><tr><td class="src"><a id="v:Yield" class="def">Yield</a></td><td class="doc"><p>Send a message to the other peer and then continue. The constructor
 requires evidence that we have agency for this protocol state and thus are
 allowed to send messages.  It takes local state associated to the source
 and target protocol state of the message that is sent.  This state is only
 maintained locally, never shared remotely.  It also takes the message and
 the continuation. It also requires evidence that we have agency for this
 protocol state and thus are allowed to send messages.</p><p>Example:</p><pre>Yield ReflClientAgency (StateBusy (ReadFile /etc/os-release))
                       StateIdle
                     $ MsgResp &quot;...&quot;</pre></td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src">:: <span class="keyword">forall</span> ps pr (st :: ps) (st' :: ps) f m a. (<a href="Network-TypedProtocol-Stateful-Codec.html#t:StateTokenI" title="Network.TypedProtocol.Stateful.Codec">StateTokenI</a> st, <a href="Network-TypedProtocol-Stateful-Codec.html#t:StateTokenI" title="Network.TypedProtocol.Stateful.Codec">StateTokenI</a> st', <a href="Network-TypedProtocol-Stateful-Codec.html#t:ActiveState" title="Network.TypedProtocol.Stateful.Codec">ActiveState</a> st)</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src">=&gt; WeHaveAgencyProof pr st</dfn><div class="doc"><p>agency singleton</p></div></li><li><dfn class="src">-&gt; f st</dfn><div class="doc"><p>associated local state to the source protocol state <code>st</code></p></div></li><li><dfn class="src">-&gt; f st'</dfn><div class="doc"><p>associated local state to the target protocol state <code>st'</code></p></div></li><li><dfn class="src">-&gt; Message ps st st'</dfn><div class="doc"><p>protocol message</p></div></li><li><dfn class="src">-&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st' f m a</dfn><div class="doc"><p>continuation</p></div></li><li><dfn class="src">-&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m a</dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr><tr><td class="src"><a id="v:Await" class="def">Await</a></td><td class="doc"><p>Waits to receive a message from the other peer and then continues.
 This takes the continuation that is supplied with the received message. It
 also requires evidence that the other peer has agency for this protocol
 state and thus we are expected to wait to receive messages.</p><p>Note that the continuation that gets supplied with the message must be
 prepared to deal with <em>any</em> message that is allowed in <em>this</em> protocol
 state. This is why the continuation <em>must</em> be polymorphic in the target
 state of the message (the third type argument of <code>Message</code>).</p><p>Example:</p><pre>Await ReflClientAgency $ \f msg -&gt;
case (f, msg) of
  (StateBusy (ReadFile path), MsgResp resp) -&gt;
    ( _continuation
    , StateIdle
    )</pre></td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src">:: <span class="keyword">forall</span> ps pr (st :: ps) f m a. (<a href="Network-TypedProtocol-Stateful-Codec.html#t:StateTokenI" title="Network.TypedProtocol.Stateful.Codec">StateTokenI</a> st, <a href="Network-TypedProtocol-Stateful-Codec.html#t:ActiveState" title="Network.TypedProtocol.Stateful.Codec">ActiveState</a> st)</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src">=&gt; TheyHaveAgencyProof pr st</dfn><div class="doc"><p>agency singleton</p></div></li><li><dfn class="src">-&gt; (<span class="keyword">forall</span> (st' :: ps). f st -&gt; Message ps st st' -&gt; (<a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st' f m a, f st'))</dfn><div class="doc"><p>continuation</p></div></li><li><dfn class="src">-&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m a</dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr><tr><td class="src"><a id="v:Done" class="def">Done</a></td><td class="doc"><p>Terminate with a result. A state token must be provided from the
 <code>NobodyHasAgency</code> states, to show that this is a state in which we can
 terminate.</p><p>Example:</p><pre>Yield ReflClientAgency
       MsgDone
      (Done ReflNobodyAgency TokDone result)</pre></td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src">:: <span class="keyword">forall</span> ps pr (st :: ps) f m a. (<a href="Network-TypedProtocol-Stateful-Codec.html#t:StateTokenI" title="Network.TypedProtocol.Stateful.Codec">StateTokenI</a> st, StateAgency st <a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/Data-Type-Equality.html#t:-126-" title="Data.Type.Equality">~</a> NobodyAgency)</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src">=&gt; NobodyHasAgencyProof pr st</dfn><div class="doc"><p>(no) agency proof</p></div></li><li><dfn class="src">-&gt; a</dfn><div class="doc"><p>returned value</p></div></li><li><dfn class="src">-&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m a</dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div><div class="subs instances"><h4 class="instances details-toggle-control details-toggle" data-details-id="i:Peer">Instances</h4><details id="i:Peer" open="open"><summary class="hide-when-js-enabled">Instances details</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:Peer:Functor:1"></span> <a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/Data-Functor.html#t:Functor" title="Data.Functor">Functor</a> m =&gt; <a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/Data-Functor.html#t:Functor" title="Data.Functor">Functor</a> (<a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m)</span> <a href="src/Network.TypedProtocol.Stateful.Peer.html#line-201" class="link">Source</a> <a href="#t:Peer" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:Peer:Functor:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Network-TypedProtocol-Stateful-Peer.html">Network.TypedProtocol.Stateful.Peer</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:fmap">fmap</a> :: (a -&gt; b) -&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m a -&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m b <a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src" class="link">Source</a> <a href="#v:fmap" class="selflink">#</a></p><p class="src"><a href="#v:-60--36-">(&lt;$)</a> :: a -&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m b -&gt; <a href="Network-TypedProtocol-Stateful-Peer.html#t:Peer" title="Network.TypedProtocol.Stateful.Peer">Peer</a> ps pr st f m a <a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src" class="link">Source</a> <a href="#v:-60--36-" class="selflink">#</a></p></div></details></td></tr></table></details></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.29.2</p></div></body></html>