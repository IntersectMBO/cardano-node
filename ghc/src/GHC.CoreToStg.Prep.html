<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">{-
(c) The University of Glasgow, 1994-2006


Core pass to saturate constructors and PrimOps
-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.CoreToStg.Prep</span><span>
</span><span id="line-13"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier">CorePrepConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepPgmConfig"><span class="hs-identifier">CorePrepPgmConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#corePrepPgm"><span class="hs-identifier">corePrepPgm</span></a></span><span>
</span><span id="line-16"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#corePrepExpr"><span class="hs-identifier">corePrepExpr</span></a></span><span>
</span><span id="line-17"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#mkConvertNumLiteral"><span class="hs-identifier">mkConvertNumLiteral</span></a></span><span>
</span><span id="line-18"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">where</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Platform.html"><span class="hs-identifier">GHC.Platform</span></a></span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html"><span class="hs-identifier">GHC.Driver.Flags</span></a></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html"><span class="hs-identifier">GHC.Tc.Utils.Env</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.html"><span class="hs-identifier">GHC.Unit</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html"><span class="hs-identifier">GHC.Core.Opt.Arity</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Lint.html"><span class="hs-identifier">GHC.Core.Lint</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Lint.html#EndPassConfig"><span class="hs-identifier">EndPassConfig</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Lint.html#endPassIO"><span class="hs-identifier">endPassIO</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Make.html"><span class="hs-identifier">GHC.Core.Make</span></a></span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Make.html#FloatBind"><span class="hs-identifier">FloatBind</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- We use our own FloatBind here</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html"><span class="hs-identifier">GHC.Core.Opt.OccurAnal</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html"><span class="hs-identifier">GHC.Core.TyCo.Rep</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#UnivCoProvenance"><span class="hs-identifier">UnivCoProvenance</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html"><span class="hs-identifier">GHC.Data.OrdList</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html"><span class="hs-identifier">GHC.Data.Pair</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Graph.UnVar.html"><span class="hs-identifier">GHC.Data.Graph.UnVar</span></a></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Error.html"><span class="hs-identifier">GHC.Utils.Error</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html"><span class="hs-identifier">GHC.Utils.Panic.Plain</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html"><span class="hs-identifier">GHC.Utils.Monad</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#mapAccumLM"><span class="hs-identifier">mapAccumLM</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html"><span class="hs-identifier">GHC.Utils.Logger</span></a></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html"><span class="hs-identifier">GHC.Types.Id.Make</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#realWorldPrimId"><span class="hs-identifier">realWorldPrimId</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#NamedThing"><span class="hs-identifier">NamedThing</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#nameSrcSpan"><span class="hs-identifier">nameSrcSpan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#isInternalName"><span class="hs-identifier">isInternalName</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html"><span class="hs-identifier">GHC.Types.SrcLoc</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier">SrcSpan</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#realSrcLocSpan"><span class="hs-identifier">realSrcLocSpan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#mkRealSrcLoc"><span class="hs-identifier">mkRealSrcLoc</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Literal.html"><span class="hs-identifier">GHC.Types.Literal</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.TyThing.html"><span class="hs-identifier">GHC.Types.TyThing</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html"><span class="hs-identifier">GHC.Types.Unique.Supply</span></a></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.List.html#/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.OldList.html#unfoldr/Data.OldList.html#unfoldr"><span class="hs-identifier">unfoldr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Functor.Identity.html#/Data.Functor.Identity.html"><span class="hs-identifier">Data.Functor.Identity</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Control.Monad.html#/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-comment">{-
Note [CorePrep Overview]
~~~~~~~~~~~~~~~~~~~~~~~~

The goal of this pass is to prepare for code generation.

1.  Saturate constructor and primop applications.

2.  Convert to A-normal form; that is, function arguments
    are always variables.

    * Use case for strict arguments:
        f E ==&gt; case E of x -&gt; f x
        (where f is strict)

    * Use let for non-trivial lazy arguments
        f E ==&gt; let x = E in f x
        (were f is lazy and x is non-trivial)

3.  Similarly, convert any unboxed lets into cases.
    [I'm experimenting with leaving 'ok-for-speculation'
     rhss in let-form right up to this point.]

4.  Ensure that *value* lambdas only occur as the RHS of a binding
    (The code generator can't deal with anything else.)
    Type lambdas are ok, however, because the code gen discards them.

5.  [Not any more; nuked Jun 2002] Do the seq/par munging.

6.  Clone all local Ids.
    This means that all such Ids are unique, rather than the
    weaker guarantee of no clashes which the simplifier provides.
    And that is what the code generator needs.

    We don't clone TyVars or CoVars. The code gen doesn't need that,
    and doing so would be tiresome because then we'd need
    to substitute in types and coercions.

    We need to clone ids for two reasons:
    + Things associated with labels in the final code must be truly unique in
      order to avoid labels being shadowed in the final output.
    + Even binders without info tables like function arguments or alternative
      bound binders must be unique at least in their type/unique combination.
      We only emit a single declaration for each binder when compiling to C
      so if binders are not unique we would either get duplicate declarations
      or misstyped variables. The later happend in #22402.
    + We heavily use unique-keyed maps in the backend which can go wrong when
      ids with the same unique are meant to represent the same variable.

7.  Give each dynamic CCall occurrence a fresh unique; this is
    rather like the cloning step above.

8.  Inject bindings for the &quot;implicit&quot; Ids:
        * Constructor wrappers
        * Constructor workers
    We want curried definitions for all of these in case they
    aren't inlined by some caller.

 9. Convert bignum literals into their core representation.

10. Uphold tick consistency while doing this: We move ticks out of
    (non-type) applications where we can, and make sure that we
    annotate according to scoping rules when floating.

11. Collect cost centres (including cost centres in unfoldings) if we're in
    profiling mode. We have to do this here because we won't have unfoldings
    after this pass (see `trimUnfolding` and Note [Drop unfoldings and rules].

12. Eliminate case clutter in favour of unsafe coercions.
    See Note [Unsafe coercions]

13. Eliminate some magic Ids, specifically
     runRW# (\s. e)  ==&gt;  e[readWorldId/s]
             lazy e  ==&gt;  e (see Note [lazyId magic] in GHC.Types.Id.Make)
         noinline e  ==&gt;  e
           nospec e  ==&gt;  e
     ToDo:  keepAlive# ...
    This is done in cpeApp

This is all done modulo type applications and abstractions, so that
when type erasure is done for conversion to STG, we don't end up with
any trivial or useless bindings.

Note [Unsafe coercions]
~~~~~~~~~~~~~~~~~~~~~~~
CorePrep does these two transformations:

1. Convert empty case to cast with an unsafe coercion
          (case e of {}) ===&gt;  e |&gt; unsafe-co
   See Note [Empty case alternatives] in GHC.Core: if the case
   alternatives are empty, the scrutinee must diverge or raise an
   exception, so we can just dive into it.

   Of course, if the scrutinee *does* return, we may get a seg-fault.
   A belt-and-braces approach would be to persist empty-alternative
   cases to code generator, and put a return point anyway that calls a
   runtime system error function.

   Notice that eliminating empty case can lead to an ill-kinded coercion
       case error @Int &quot;foo&quot; of {}  :: Int#
       ===&gt; error @Int &quot;foo&quot; |&gt; unsafe-co
       where unsafe-co :: Int ~ Int#
   But that's fine because the expression diverges anyway. And it's
   no different to what happened before.

2. Eliminate unsafeEqualityProof in favour of an unsafe coercion
           case unsafeEqualityProof of UnsafeRefl g -&gt; e
           ===&gt;  e[unsafe-co/g]
   See (U2) in Note [Implementing unsafeCoerce] in base:Unsafe.Coerce

   Note that this requires us to substitute 'unsafe-co' for 'g', and
   that is the main (current) reason for cpe_tyco_env in CorePrepEnv.
   Tiresome, but not difficult.

These transformations get rid of &quot;case clutter&quot;, leaving only casts.
We are doing no further significant transformations, so the reasons
for the case forms have disappeared. And it is extremely helpful for
the ANF-ery, CoreToStg, and backends, if trivial expressions really do
look trivial. #19700 was an example.

In both cases, the &quot;unsafe-co&quot; is just (UnivCo ty1 ty2 (CorePrepProv b)),
The boolean 'b' says whether the unsafe coercion is supposed to be
kind-homogeneous (yes for (2), no for (1).  This information is used
/only/ by Lint.

Note [CorePrep invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Here is the syntax of the Core produced by CorePrep:

    Trivial expressions
       arg ::= lit |  var
              | arg ty  |  /\a. arg
              | truv co  |  /\c. arg  |  arg |&gt; co

    Applications
       app ::= lit  |  var  |  app arg  |  app ty  | app co | app |&gt; co

    Expressions
       body ::= app
              | let(rec) x = rhs in body     -- Boxed only
              | case body of pat -&gt; body
              | /\a. body | /\c. body
              | body |&gt; co

    Right hand sides (only place where value lambdas can occur)
       rhs ::= /\a.rhs  |  \x.rhs  |  body

We define a synonym for each of these non-terminals.  Functions
with the corresponding name produce a result in that syntax.
-}</span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="hs-keyword">type</span><span> </span><span id="CpeArg"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeArg"><span class="hs-identifier hs-var">CpeArg</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>    </span><span class="hs-comment">-- Non-terminal 'arg'</span><span>
</span><span id="line-229"></span><span class="hs-keyword">type</span><span> </span><span id="CpeApp"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>    </span><span class="hs-comment">-- Non-terminal 'app'</span><span>
</span><span id="line-230"></span><span class="hs-keyword">type</span><span> </span><span id="CpeBody"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-var">CpeBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>    </span><span class="hs-comment">-- Non-terminal 'body'</span><span>
</span><span id="line-231"></span><span class="hs-keyword">type</span><span> </span><span id="CpeRhs"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-var">CpeRhs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>    </span><span class="hs-comment">-- Non-terminal 'rhs'</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Top level stuff
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="hs-keyword">data</span><span> </span><span id="CorePrepPgmConfig"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepPgmConfig"><span class="hs-identifier hs-var">CorePrepPgmConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CorePrepPgmConfig"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepPgmConfig"><span class="hs-identifier hs-var">CorePrepPgmConfig</span></a></span></span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="cpPgm_endPassConfig"><span class="annot"><span class="annottext">CorePrepPgmConfig -&gt; EndPassConfig
</span><a href="GHC.CoreToStg.Prep.html#cpPgm_endPassConfig"><span class="hs-identifier hs-var hs-var">cpPgm_endPassConfig</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Lint.html#EndPassConfig"><span class="hs-identifier hs-type">EndPassConfig</span></a></span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="cpPgm_generateDebugInfo"><span class="annot"><span class="annottext">CorePrepPgmConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cpPgm_generateDebugInfo"><span class="hs-identifier hs-var hs-var">cpPgm_generateDebugInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#corePrepPgm"><span class="hs-identifier hs-type">corePrepPgm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span>
</span><span id="line-247"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier hs-type">CorePrepConfig</span></a></span><span>
</span><span id="line-248"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepPgmConfig"><span class="hs-identifier hs-type">CorePrepPgmConfig</span></a></span><span>
</span><span id="line-249"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Location.html#ModLocation"><span class="hs-identifier hs-type">ModLocation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-250"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span>
</span><span id="line-251"></span><span id="corePrepPgm"><span class="annot"><span class="annottext">corePrepPgm :: Logger
-&gt; CorePrepConfig
-&gt; CorePrepPgmConfig
-&gt; Module
-&gt; ModLocation
-&gt; CoreProgram
-&gt; [TyCon]
-&gt; IO CoreProgram
</span><a href="GHC.CoreToStg.Prep.html#corePrepPgm"><span class="hs-identifier hs-var hs-var">corePrepPgm</span></a></span></span><span> </span><span id="local-6989586621681997677"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681997677"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681997678"><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621681997678"><span class="hs-identifier hs-var">cp_cfg</span></a></span></span><span> </span><span id="local-6989586621681997679"><span class="annot"><span class="annottext">CorePrepPgmConfig
</span><a href="#local-6989586621681997679"><span class="hs-identifier hs-var">pgm_cfg</span></a></span></span><span>
</span><span id="line-252"></span><span>            </span><span id="local-6989586621681997680"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681997680"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span id="local-6989586621681997681"><span class="annot"><span class="annottext">ModLocation
</span><a href="#local-6989586621681997681"><span class="hs-identifier hs-var">mod_loc</span></a></span></span><span> </span><span id="local-6989586621681997682"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681997682"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span id="local-6989586621681997683"><span class="annot"><span class="annottext">[TyCon]
</span><a href="#local-6989586621681997683"><span class="hs-identifier hs-var">data_tycons</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-253"></span><span>    </span><span class="annot"><span class="annottext">Logger
-&gt; SDoc -&gt; (CoreProgram -&gt; ()) -&gt; IO CoreProgram -&gt; IO CoreProgram
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Logger -&gt; SDoc -&gt; (a -&gt; ()) -&gt; m a -&gt; m a
</span><a href="GHC.Utils.Error.html#withTiming"><span class="hs-identifier hs-var">withTiming</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681997677"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-254"></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CorePrep&quot;</span></span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681997680"><span class="hs-identifier hs-var">this_mod</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>               </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681997689"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681997689"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681997689"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; () -&gt; ()
forall a b. [a] -&gt; b -&gt; b
</span><a href="GHC.Utils.Misc.html#seqList"><span class="hs-operator hs-var">`seqList`</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO CoreProgram -&gt; IO CoreProgram)
-&gt; IO CoreProgram -&gt; IO CoreProgram
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>    </span><span id="local-6989586621681997691"><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621681997691"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Char -&gt; IO UniqSupply
</span><a href="GHC.Types.Unique.Supply.html#mkSplitUniqSupply"><span class="hs-identifier hs-var">mkSplitUniqSupply</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'s'</span></span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997693"><span class="annot"><span class="annottext">initialCorePrepEnv :: CorePrepEnv
</span><a href="#local-6989586621681997693"><span class="hs-identifier hs-var hs-var">initialCorePrepEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepConfig -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#mkInitialCorePrepEnv"><span class="hs-identifier hs-var">mkInitialCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621681997678"><span class="hs-identifier hs-var">cp_cfg</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-260"></span><span>        </span><span id="local-6989586621681997695"><span class="annot"><span class="annottext">implicit_binds :: CoreProgram
</span><a href="#local-6989586621681997695"><span class="hs-identifier hs-var hs-var">implicit_binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ModLocation -&gt; [TyCon] -&gt; CoreProgram
</span><a href="GHC.CoreToStg.Prep.html#mkDataConWorkers"><span class="hs-identifier hs-var">mkDataConWorkers</span></a></span><span>
</span><span id="line-261"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepPgmConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cpPgm_generateDebugInfo"><span class="hs-identifier hs-var">cpPgm_generateDebugInfo</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepPgmConfig
</span><a href="#local-6989586621681997679"><span class="hs-identifier hs-var">pgm_cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>          </span><span class="annot"><span class="annottext">ModLocation
</span><a href="#local-6989586621681997681"><span class="hs-identifier hs-var">mod_loc</span></a></span><span> </span><span class="annot"><span class="annottext">[TyCon]
</span><a href="#local-6989586621681997683"><span class="hs-identifier hs-var">data_tycons</span></a></span><span>
</span><span id="line-263"></span><span>            </span><span class="hs-comment">-- NB: we must feed mkImplicitBinds through corePrep too</span><span>
</span><span id="line-264"></span><span>            </span><span class="hs-comment">-- so that they are suitably cloned and eta-expanded</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span>        </span><span id="local-6989586621681997697"><span class="annot"><span class="annottext">binds_out :: CoreProgram
</span><a href="#local-6989586621681997697"><span class="hs-identifier hs-var hs-var">binds_out</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqSupply -&gt; UniqSM CoreProgram -&gt; CoreProgram
forall a. UniqSupply -&gt; UniqSM a -&gt; a
</span><a href="GHC.Types.Unique.Supply.html#initUs_"><span class="hs-identifier hs-var">initUs_</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621681997691"><span class="hs-identifier hs-var">us</span></a></span><span> </span><span class="annot"><span class="annottext">(UniqSM CoreProgram -&gt; CoreProgram)
-&gt; UniqSM CoreProgram -&gt; CoreProgram
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-267"></span><span>                      </span><span id="local-6989586621681997699"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997699"><span class="hs-identifier hs-var">floats1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CoreProgram -&gt; UniqSM Floats
</span><a href="GHC.CoreToStg.Prep.html#corePrepTopBinds"><span class="hs-identifier hs-var">corePrepTopBinds</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997693"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681997682"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-268"></span><span>                      </span><span id="local-6989586621681997701"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997701"><span class="hs-identifier hs-var">floats2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CoreProgram -&gt; UniqSM Floats
</span><a href="GHC.CoreToStg.Prep.html#corePrepTopBinds"><span class="hs-identifier hs-var">corePrepTopBinds</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997693"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681997695"><span class="hs-identifier hs-var">implicit_binds</span></a></span><span>
</span><span id="line-269"></span><span>                      </span><span class="annot"><span class="annottext">CoreProgram -&gt; UniqSM CoreProgram
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; CoreProgram
</span><a href="GHC.CoreToStg.Prep.html#deFloatTop"><span class="hs-identifier hs-var">deFloatTop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997699"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">Floats -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#appendFloats"><span class="hs-operator hs-var">`appendFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997701"><span class="hs-identifier hs-var">floats2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span>    </span><span class="annot"><span class="annottext">Logger -&gt; EndPassConfig -&gt; CoreProgram -&gt; [CoreRule] -&gt; IO ()
</span><a href="GHC.Core.Lint.html#endPassIO"><span class="hs-identifier hs-var">endPassIO</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681997677"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepPgmConfig -&gt; EndPassConfig
</span><a href="GHC.CoreToStg.Prep.html#cpPgm_endPassConfig"><span class="hs-identifier hs-var">cpPgm_endPassConfig</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepPgmConfig
</span><a href="#local-6989586621681997679"><span class="hs-identifier hs-var">pgm_cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>              </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681997697"><span class="hs-identifier hs-var">binds_out</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><span class="annottext">CoreProgram -&gt; IO CoreProgram
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681997697"><span class="hs-identifier hs-var">binds_out</span></a></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#corePrepExpr"><span class="hs-identifier hs-type">corePrepExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier hs-type">CorePrepConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-276"></span><span id="corePrepExpr"><span class="annot"><span class="annottext">corePrepExpr :: Logger -&gt; CorePrepConfig -&gt; CpeApp -&gt; IO CpeApp
</span><a href="GHC.CoreToStg.Prep.html#corePrepExpr"><span class="hs-identifier hs-var hs-var">corePrepExpr</span></a></span></span><span> </span><span id="local-6989586621681997704"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681997704"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681997705"><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621681997705"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span id="local-6989586621681997706"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997706"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-277"></span><span>    </span><span class="annot"><span class="annottext">Logger -&gt; SDoc -&gt; (CpeApp -&gt; ()) -&gt; IO CpeApp -&gt; IO CpeApp
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Logger -&gt; SDoc -&gt; (a -&gt; ()) -&gt; m a -&gt; m a
</span><a href="GHC.Utils.Error.html#withTiming"><span class="hs-identifier hs-var">withTiming</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681997704"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CorePrep [expr]&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681997707"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997707"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997707"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; () -&gt; ()
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO CpeApp -&gt; IO CpeApp) -&gt; IO CpeApp -&gt; IO CpeApp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-278"></span><span>      </span><span id="local-6989586621681997708"><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621681997708"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Char -&gt; IO UniqSupply
</span><a href="GHC.Types.Unique.Supply.html#mkSplitUniqSupply"><span class="hs-identifier hs-var">mkSplitUniqSupply</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'s'</span></span><span>
</span><span id="line-279"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997709"><span class="annot"><span class="annottext">initialCorePrepEnv :: CorePrepEnv
</span><a href="#local-6989586621681997709"><span class="hs-identifier hs-var hs-var">initialCorePrepEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepConfig -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#mkInitialCorePrepEnv"><span class="hs-identifier hs-var">mkInitialCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621681997705"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-280"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997710"><span class="annot"><span class="annottext">new_expr :: CpeApp
</span><a href="#local-6989586621681997710"><span class="hs-identifier hs-var hs-var">new_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqSupply -&gt; UniqSM CpeApp -&gt; CpeApp
forall a. UniqSupply -&gt; UniqSM a -&gt; a
</span><a href="GHC.Types.Unique.Supply.html#initUs_"><span class="hs-identifier hs-var">initUs_</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621681997708"><span class="hs-identifier hs-var">us</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-var">cpeBodyNF</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997709"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997706"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>      </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; String -&gt; DumpFormat -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#putDumpFileMaybe"><span class="hs-identifier hs-var">putDumpFileMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681997704"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_prep"><span class="hs-identifier hs-var">Opt_D_dump_prep</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CorePrep&quot;</span></span><span> </span><span class="annot"><span class="annottext">DumpFormat
</span><a href="GHC.Utils.Logger.html#FormatCore"><span class="hs-identifier hs-var">FormatCore</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997710"><span class="hs-identifier hs-var">new_expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>      </span><span class="annot"><span class="annottext">CpeApp -&gt; IO CpeApp
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997710"><span class="hs-identifier hs-var">new_expr</span></a></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#corePrepTopBinds"><span class="hs-identifier hs-type">corePrepTopBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-285"></span><span class="hs-comment">-- Note [Floating out of top level bindings]</span><span>
</span><span id="line-286"></span><span id="corePrepTopBinds"><span class="annot"><span class="annottext">corePrepTopBinds :: CorePrepEnv -&gt; CoreProgram -&gt; UniqSM Floats
</span><a href="GHC.CoreToStg.Prep.html#corePrepTopBinds"><span class="hs-identifier hs-var hs-var">corePrepTopBinds</span></a></span></span><span> </span><span id="local-6989586621681997715"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997715"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a></span></span><span> </span><span id="local-6989586621681997716"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681997716"><span class="hs-identifier hs-var">binds</span></a></span></span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CoreProgram -&gt; UniqSM Floats
</span><a href="#local-6989586621681997717"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997715"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681997716"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-289"></span><span>    </span><span id="local-6989586621681997717"><span class="annot"><span class="annottext">go :: CorePrepEnv -&gt; CoreProgram -&gt; UniqSM Floats
</span><a href="#local-6989586621681997717"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; UniqSM Floats
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span class="annot"><a href="#local-6989586621681997717"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681997727"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997727"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997728"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681997728"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681997729"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681997729"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997730"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997730"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997731"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997731"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997732"><span class="annot"><span class="annottext">Maybe CoreBind
</span><a href="#local-6989586621681997732"><span class="hs-identifier hs-var">maybe_new_bind</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>                                 </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; CorePrepEnv
-&gt; CoreBind
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
</span><a href="GHC.CoreToStg.Prep.html#cpeBind"><span class="hs-identifier hs-var">cpeBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997727"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681997728"><span class="hs-identifier hs-var">bind</span></a></span><span>
</span><span id="line-292"></span><span>                               </span><span class="annot"><span class="annottext">Bool -&gt; UniqSM ()
forall (m :: * -&gt; *). (HasCallStack, Applicative m) =&gt; Bool -&gt; m ()
</span><a href="GHC.Utils.Panic.Plain.html#massert"><span class="hs-identifier hs-var">massert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe CoreBind -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Maybe.html#isNothing/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CoreBind
</span><a href="#local-6989586621681997732"><span class="hs-identifier hs-var">maybe_new_bind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>                                 </span><span class="hs-comment">-- Only join points get returned this way by</span><span>
</span><span id="line-294"></span><span>                                 </span><span class="hs-comment">-- cpeBind, and no join point may float to top</span><span>
</span><span id="line-295"></span><span>                               </span><span id="local-6989586621681997737"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997737"><span class="hs-identifier hs-var">floatss</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CoreProgram -&gt; UniqSM Floats
</span><a href="#local-6989586621681997717"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997730"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681997729"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-296"></span><span>                               </span><span class="annot"><span class="annottext">Floats -&gt; UniqSM Floats
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997731"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">Floats -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#appendFloats"><span class="hs-operator hs-var">`appendFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997737"><span class="hs-identifier hs-var">floatss</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#mkDataConWorkers"><span class="hs-identifier hs-type">mkDataConWorkers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Location.html#ModLocation"><span class="hs-identifier hs-type">ModLocation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-299"></span><span class="hs-comment">-- See Note [Data constructor workers]</span><span>
</span><span id="line-300"></span><span class="hs-comment">-- c.f. Note [Injecting implicit bindings] in GHC.Iface.Tidy</span><span>
</span><span id="line-301"></span><span id="mkDataConWorkers"><span class="annot"><span class="annottext">mkDataConWorkers :: Bool -&gt; ModLocation -&gt; [TyCon] -&gt; CoreProgram
</span><a href="GHC.CoreToStg.Prep.html#mkDataConWorkers"><span class="hs-identifier hs-var hs-var">mkDataConWorkers</span></a></span></span><span> </span><span id="local-6989586621681997738"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681997738"><span class="hs-identifier hs-var">generate_debug_info</span></a></span></span><span> </span><span id="local-6989586621681997739"><span class="annot"><span class="annottext">ModLocation
</span><a href="#local-6989586621681997739"><span class="hs-identifier hs-var">mod_loc</span></a></span></span><span> </span><span id="local-6989586621681997740"><span class="annot"><span class="annottext">[TyCon]
</span><a href="#local-6989586621681997740"><span class="hs-identifier hs-var">data_tycons</span></a></span></span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CpeApp -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997742"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; CpeApp -&gt; CpeApp
</span><a href="#local-6989586621681997743"><span class="hs-identifier hs-var">tick_it</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; Name
forall a. NamedThing a =&gt; a -&gt; Name
</span><a href="GHC.Types.Name.html#getName"><span class="hs-identifier hs-var">getName</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681997745"><span class="hs-identifier hs-var">data_con</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CpeApp
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997742"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>                                </span><span class="hs-comment">-- The ice is thin here, but it works</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681997747"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681997747"><span class="hs-identifier hs-var">tycon</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TyCon]
</span><a href="#local-6989586621681997740"><span class="hs-identifier hs-var">data_tycons</span></a></span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- CorePrep will eta-expand it</span><span>
</span><span id="line-305"></span><span>      </span><span id="local-6989586621681997745"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681997745"><span class="hs-identifier hs-var">data_con</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [DataCon]
</span><a href="GHC.Core.TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681997747"><span class="hs-identifier hs-var">tycon</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-306"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997742"><span class="annot"><span class="annottext">id :: Id
</span><a href="#local-6989586621681997742"><span class="hs-identifier hs-var hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Id
</span><a href="GHC.Core.DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681997745"><span class="hs-identifier hs-var">data_con</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-308"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-309"></span><span>   </span><span class="hs-comment">-- If we want to generate debug info, we put a source note on the</span><span>
</span><span id="line-310"></span><span>   </span><span class="hs-comment">-- worker. This is useful, especially for heap profiling.</span><span>
</span><span id="line-311"></span><span>   </span><span id="local-6989586621681997743"><span class="annot"><span class="annottext">tick_it :: Name -&gt; CpeApp -&gt; CpeApp
</span><a href="#local-6989586621681997743"><span class="hs-identifier hs-var hs-var">tick_it</span></a></span></span><span> </span><span id="local-6989586621681997750"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681997750"><span class="hs-identifier hs-var">name</span></a></span></span><span>
</span><span id="line-312"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681997738"><span class="hs-identifier hs-var">generate_debug_info</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; CpeApp
forall a. a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#id/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-313"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#RealSrcSpan"><span class="hs-identifier hs-type">RealSrcSpan</span></a></span><span> </span><span id="local-6989586621681997754"><span class="annot"><span class="annottext">RealSrcSpan
</span><a href="#local-6989586621681997754"><span class="hs-identifier hs-var">span</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe BufSpan
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; SrcSpan
</span><a href="GHC.Types.Name.html#nameSrcSpan"><span class="hs-identifier hs-var">nameSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681997750"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealSrcSpan -&gt; CpeApp -&gt; CpeApp
</span><a href="#local-6989586621681997755"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">RealSrcSpan
</span><a href="#local-6989586621681997754"><span class="hs-identifier hs-var">span</span></a></span><span>
</span><span id="line-314"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681997756"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681997756"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ModLocation -&gt; Maybe String
</span><a href="GHC.Unit.Module.Location.html#ml_hs_file"><span class="hs-identifier hs-var">ml_hs_file</span></a></span><span> </span><span class="annot"><span class="annottext">ModLocation
</span><a href="#local-6989586621681997739"><span class="hs-identifier hs-var">mod_loc</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealSrcSpan -&gt; CpeApp -&gt; CpeApp
</span><a href="#local-6989586621681997755"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; RealSrcSpan
</span><a href="#local-6989586621681997758"><span class="hs-identifier hs-var">span1</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681997756"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealSrcSpan -&gt; CpeApp -&gt; CpeApp
</span><a href="#local-6989586621681997755"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; RealSrcSpan
</span><a href="#local-6989586621681997758"><span class="hs-identifier hs-var">span1</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;???&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>     </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681997755"><span class="annot"><span class="annottext">tick :: RealSrcSpan -&gt; CpeApp -&gt; CpeApp
</span><a href="#local-6989586621681997755"><span class="hs-identifier hs-var hs-var">tick</span></a></span></span><span> </span><span id="local-6989586621681997759"><span class="annot"><span class="annottext">RealSrcSpan
</span><a href="#local-6989586621681997759"><span class="hs-identifier hs-var">span</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeApp -&gt; CpeApp
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; CpeApp -&gt; CpeApp)
-&gt; CoreTickish -&gt; CpeApp -&gt; CpeApp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealSrcSpan -&gt; String -&gt; CoreTickish
forall (pass :: TickishPass).
RealSrcSpan -&gt; String -&gt; GenTickish pass
</span><a href="GHC.Types.Tickish.html#SourceNote"><span class="hs-identifier hs-var">SourceNote</span></a></span><span> </span><span class="annot"><span class="annottext">RealSrcSpan
</span><a href="#local-6989586621681997759"><span class="hs-identifier hs-var">span</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; CoreTickish) -&gt; String -&gt; CoreTickish
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-317"></span><span>             </span><span class="annot"><span class="annottext">SDocContext -&gt; SDoc -&gt; String
</span><a href="GHC.Utils.Outputable.html#renderWithContext"><span class="hs-identifier hs-var">renderWithContext</span></a></span><span> </span><span class="annot"><span class="annottext">SDocContext
</span><a href="GHC.Utils.Outputable.html#defaultSDocContext"><span class="hs-identifier hs-var">defaultSDocContext</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; String) -&gt; SDoc -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681997750"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-318"></span><span>           </span><span id="local-6989586621681997758"><span class="annot"><span class="annottext">span1 :: String -&gt; RealSrcSpan
</span><a href="#local-6989586621681997758"><span class="hs-identifier hs-var hs-var">span1</span></a></span></span><span> </span><span id="local-6989586621681997764"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681997764"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealSrcLoc -&gt; RealSrcSpan
</span><a href="GHC.Types.SrcLoc.html#realSrcLocSpan"><span class="hs-identifier hs-var">realSrcLocSpan</span></a></span><span> </span><span class="annot"><span class="annottext">(RealSrcLoc -&gt; RealSrcSpan) -&gt; RealSrcLoc -&gt; RealSrcSpan
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FastString -&gt; Int -&gt; Int -&gt; RealSrcLoc
</span><a href="GHC.Types.SrcLoc.html#mkRealSrcLoc"><span class="hs-identifier hs-var">mkRealSrcLoc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681997764"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="hs-comment">{-
Note [Floating out of top level bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NB: we do need to float out of top-level bindings
Consider        x = length [True,False]
We want to get
                s1 = False : []
                s2 = True  : s1
                x  = length s2

We return a *list* of bindings, because we may start with
        x* = f (g y)
where x is demanded, in which case we want to finish with
        a = g y
        x* = f a
And then x will actually end up case-bound

Note [Join points and floating]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Join points can float out of other join points but not out of value bindings:

  let z =
    let  w = ... in -- can float
    join k = ... in -- can't float
    ... jump k ...
  join j x1 ... xn =
    let  y = ... in -- can float (but don't want to)
    join h = ... in -- can float (but not much point)
    ... jump h ...
  in ...

Here, the jump to h remains valid if h is floated outward, but the jump to k
does not.

We don't float *out* of join points. It would only be safe to float out of
nullary join points (or ones where the arguments are all either type arguments
or dead binders). Nullary join points aren't ever recursive, so they're always
effectively one-shot functions, which we don't float out of. We *could* float
join points from nullary join points, but there's no clear benefit at this
stage.

Note [Data constructor workers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Create any necessary &quot;implicit&quot; bindings for data con workers.  We
create the rather strange (non-recursive!) binding

        $wC = \x y -&gt; $wC x y

i.e. a curried constructor that allocates.  This means that we can
treat the worker for a constructor like any other function in the rest
of the compiler.  The point here is that CoreToStg will generate a
StgConApp for the RHS, rather than a call to the worker (which would
give a loop).  As Lennart says: the ice is thin here, but it works.

Hmm.  Should we create bindings for dictionary constructors?  They are
always fully applied, and the bindings are just there to support
partial applications. But it's easier to let them through.


Note [Dead code in CorePrep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Imagine that we got an input program like this (see #4962):

  f :: Show b =&gt; Int -&gt; (Int, b -&gt; Maybe Int -&gt; Int)
  f x = (g True (Just x) + g () (Just x), g)
    where
      g :: Show a =&gt; a -&gt; Maybe Int -&gt; Int
      g _ Nothing = x
      g y (Just z) = if z &gt; 100 then g y (Just (z + length (show y))) else g y unknown

After specialisation and SpecConstr, we would get something like this:

  f :: Show b =&gt; Int -&gt; (Int, b -&gt; Maybe Int -&gt; Int)
  f x = (g$Bool_True_Just x + g$Unit_Unit_Just x, g)
    where
      {-# RULES g $dBool = g$Bool
                g $dUnit = g$Unit #-}
      g = ...
      {-# RULES forall x. g$Bool True (Just x) = g$Bool_True_Just x #-}
      g$Bool = ...
      {-# RULES forall x. g$Unit () (Just x) = g$Unit_Unit_Just x #-}
      g$Unit = ...
      g$Bool_True_Just = ...
      g$Unit_Unit_Just = ...

Note that the g$Bool and g$Unit functions are actually dead code: they
are only kept alive by the occurrence analyser because they are
referred to by the rules of g, which is being kept alive by the fact
that it is used (unspecialised) in the returned pair.

However, at the CorePrep stage there is no way that the rules for g
will ever fire, and it really seems like a shame to produce an output
program that goes to the trouble of allocating a closure for the
unreachable g$Bool and g$Unit functions.

The way we fix this is to:
 * In cloneBndr, drop all unfoldings/rules

 * In deFloatTop, run a simple dead code analyser on each top-level
   RHS to drop the dead local bindings.

The reason we don't just OccAnal the whole output of CorePrep is that
the tidier ensures that all top-level binders are GlobalIds, so they
don't show up in the free variables any longer. So if you run the
occurrence analyser on the output of CoreTidy (or later) you e.g. turn
this program:

  Rec {
  f = ... f ...
  }

Into this one:

  f = ... f ...

(Since f is not considered to be free in its own RHS.)


Note [keepAlive# magic]
~~~~~~~~~~~~~~~~~~~~~~~
When interacting with foreign code, it is often necessary for the user to
extend the lifetime of a heap object beyond the lifetime that would be apparent
from the on-heap references alone. For instance, a program like:

  foreign import safe &quot;hello&quot; hello :: ByteArray# -&gt; IO ()

  callForeign :: IO ()
  callForeign = IO $ \s0 -&gt;
    case newByteArray# n# s0 of (# s1, barr #) -&gt;
      unIO hello barr s1

As-written this program is susceptible to memory-unsafety since there are
no references to `barr` visible to the garbage collector. Consequently, if a
garbage collection happens during the execution of the C function `hello`, it
may be that the array is freed while in use by the foreign function.

To address this, we introduced a new primop, keepAlive#, which &quot;scopes over&quot;
the computation needing the kept-alive value:

  keepAlive# :: forall (ra :: RuntimeRep) (rb :: RuntimeRep) (a :: TYPE a) (b :: TYPE b).
                a -&gt; State# RealWorld -&gt; (State# RealWorld -&gt; b) -&gt; b

When entered, an application (keepAlive# x s k) will apply `k` to the state
token, evaluating it to WHNF. However, during the course of this evaluation
will *guarantee* that `x` is considered to be alive.

There are a few things to note here:

 - we are RuntimeRep-polymorphic in the value to be kept-alive. This is
   necessary since we will often (but not always) be keeping alive something
   unlifted (like a ByteArray#)

 - we are RuntimeRep-polymorphic in the result value since the result may take
   many forms (e.g. a boxed value, a raw state token, or a (# State s, result #).

We implement this operation by desugaring to touch# during CorePrep (see
GHC.CoreToStg.Prep.cpeApp). Specifically,

  keepAlive# x s0 k

is transformed to:

  case k s0 of r -&gt;
  case touch# x realWorld# of s1 -&gt;
    r

Operationally, `keepAlive# x s k` is equivalent to pushing a stack frame with a
pointer to `x` and entering `k s0`. This compilation strategy is safe
because we do no optimization on STG that would drop or re-order the
continuation containing the `touch#`. However, if we were to become more
aggressive in our STG pipeline then we would need to revisit this.

Beyond this CorePrep transformation, there is very little special about
keepAlive#. However, we did explore (and eventually gave up on)
an optimisation which would allow unboxing of constructed product results,
which we describe below.


Lost optimisation: CPR unboxing
--------------------------------
One unfortunate property of this approach is that the simplifier is unable to
unbox the result of a keepAlive# expression. For instance, consider the program:

  case keepAlive# arr s0 (
         \s1 -&gt; case peekInt arr s1 of
                  (# s2, r #) -&gt; I# r
  ) of
    I# x -&gt; ...

This is a surprisingly common pattern, previously used, e.g., in
GHC.IO.Buffer.readWord8Buf. While exploring ideas, we briefly played around
with optimising this away by pushing strict contexts (like the
`case [] of I# x -&gt; ...` above) into keepAlive#'s continuation. While this can
recover unboxing, it can also unfortunately in general change the asymptotic
memory (namely stack) behavior of the program. For instance, consider

  writeN =
    ...
      case keepAlive# x s0 (\s1 -&gt; something s1) of
        (# s2, x #) -&gt;
          writeN ...

As it is tail-recursive, this program will run in constant space. However, if
we push outer case into the continuation we get:

  writeN =

      case keepAlive# x s0 (\s1 -&gt;
        case something s1 of
          (# s2, x #) -&gt;
            writeN ...
      ) of
        ...

Which ends up building a stack which is linear in the recursion depth. For this
reason, we ended up giving up on this optimisation.


Historical note: touch# and its inadequacy
------------------------------------------
Prior to the introduction of `keepAlive#` we instead addressed the need for
lifetime extension with the `touch#` primop:

    touch# :: a -&gt; State# s -&gt; State# s

This operation would ensure that the `a` value passed as the first argument was
considered &quot;alive&quot; at the time the primop application is entered.

For instance, the user might modify `callForeign` as:

  callForeign :: IO ()
  callForeign s0 = IO $ \s0 -&gt;
    case newByteArray# n# s0 of (# s1, barr #) -&gt;
    case unIO hello barr s1 of (# s2, () #) -&gt;
    case touch# barr s2 of s3 -&gt;
      (# s3, () #)

However, in #14346 we discovered that this primop is insufficient in the
presence of simplification. For instance, consider a program like:

  callForeign :: IO ()
  callForeign s0 = IO $ \s0 -&gt;
    case newByteArray# n# s0 of (# s1, barr #) -&gt;
    case unIO (forever $ hello barr) s1 of (# s2, () #) -&gt;
    case touch# barr s2 of s3 -&gt;
      (# s3, () #)

In this case the Simplifier may realize that (forever $ hello barr)
will never return and consequently that the `touch#` that follows is dead code.
As such, it will be dropped, resulting in memory unsoundness.
This unsoundness lead to the introduction of keepAlive#.



Other related tickets:

 - #15544
 - #17760
 - #14375
 - #15260
 - #18061

************************************************************************
*                                                                      *
                The main code
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-588"></span><span>
</span><span id="line-589"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBind"><span class="hs-identifier hs-type">cpeBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span>
</span><span id="line-590"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-591"></span><span>                   </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span>         </span><span class="hs-comment">-- Floating value bindings</span><span>
</span><span id="line-592"></span><span>                   </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Just bind' &lt;=&gt; returned new bind; no float</span><span>
</span><span id="line-593"></span><span>                                   </span><span class="hs-comment">-- Nothing &lt;=&gt; added bind' to floats instead</span><span>
</span><span id="line-594"></span><span id="cpeBind"><span class="annot"><span class="annottext">cpeBind :: TopLevelFlag
-&gt; CorePrepEnv
-&gt; CoreBind
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
</span><a href="GHC.CoreToStg.Prep.html#cpeBind"><span class="hs-identifier hs-var hs-var">cpeBind</span></a></span></span><span> </span><span id="local-6989586621681997766"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681997766"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681997767"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997767"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681997768"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997768"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681997769"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997769"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997768"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-596"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997771"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997771"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997772"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997772"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; UniqSM (CorePrepEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-var">cpCloneBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997767"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997768"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-597"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997774"><span class="annot"><span class="annottext">dmd :: Demand
</span><a href="#local-6989586621681997774"><span class="hs-identifier hs-var hs-var">dmd</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997768"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-598"></span><span>             </span><span id="local-6989586621681997776"><span class="annot"><span class="annottext">is_unlifted :: Bool
</span><a href="#local-6989586621681997776"><span class="hs-identifier hs-var hs-var">is_unlifted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Bool
Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997768"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-599"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997779"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997779"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997780"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997780"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; RecFlag
-&gt; Demand
-&gt; Bool
-&gt; CorePrepEnv
-&gt; Id
-&gt; CpeApp
-&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpePair"><span class="hs-identifier hs-var">cpePair</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681997766"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span>
</span><span id="line-600"></span><span>                                   </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681997774"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681997776"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span>
</span><span id="line-601"></span><span>                                   </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997767"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997772"><span class="hs-identifier hs-var">bndr1</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997769"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-602"></span><span>       </span><span class="hs-comment">-- See Note [Inlining in CorePrep]</span><span>
</span><span id="line-603"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997783"><span class="annot"><span class="annottext">triv_rhs :: Bool
</span><a href="#local-6989586621681997783"><span class="hs-identifier hs-var hs-var">triv_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997780"><span class="hs-identifier hs-var">rhs1</span></a></span><span>
</span><span id="line-604"></span><span>             </span><span id="local-6989586621681997785"><span class="annot"><span class="annottext">env2 :: CorePrepEnv
</span><a href="#local-6989586621681997785"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681997783"><span class="hs-identifier hs-var">triv_rhs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; CpeApp -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvExpr"><span class="hs-identifier hs-var">extendCorePrepEnvExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997771"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997768"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997780"><span class="hs-identifier hs-var">rhs1</span></a></span><span>
</span><span id="line-605"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997771"><span class="hs-identifier hs-var">env1</span></a></span><span>
</span><span id="line-606"></span><span>             </span><span id="local-6989586621681997787"><span class="annot"><span class="annottext">floats1 :: Floats
</span><a href="#local-6989586621681997787"><span class="hs-identifier hs-var hs-var">floats1</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681997783"><span class="hs-identifier hs-var">triv_rhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isInternalName"><span class="hs-identifier hs-var">isInternalName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997768"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-607"></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997779"><span class="hs-identifier hs-var">floats</span></a></span><span>
</span><span id="line-608"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-609"></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#addFloat"><span class="hs-identifier hs-var">addFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997779"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681997790"><span class="hs-identifier hs-var">new_float</span></a></span><span>
</span><span id="line-610"></span><span>
</span><span id="line-611"></span><span>             </span><span id="local-6989586621681997790"><span class="annot"><span class="annottext">new_float :: FloatingBind
</span><a href="#local-6989586621681997790"><span class="hs-identifier hs-var hs-var">new_float</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Demand -&gt; Bool -&gt; Id -&gt; CpeApp -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#mkFloat"><span class="hs-identifier hs-var">mkFloat</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997767"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681997774"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681997776"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997772"><span class="hs-identifier hs-var">bndr1</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997780"><span class="hs-identifier hs-var">rhs1</span></a></span><span>
</span><span id="line-612"></span><span>
</span><span id="line-613"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(CorePrepEnv, Floats, Maybe CoreBind)
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997785"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997787"><span class="hs-identifier hs-var">floats1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe CoreBind
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-comment">-- A join point; see Note [Join points and floating]</span><span>
</span><span id="line-616"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681997766"><span class="hs-identifier hs-var">top_lvl</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
 -&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind))
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-comment">-- can't have top-level join point</span><span>
</span><span id="line-617"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997794"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997794"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; UniqSM (CorePrepEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-var">cpCloneBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997767"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997768"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-618"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997795"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997795"><span class="hs-identifier hs-var">bndr2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997796"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997796"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; CpeApp -&gt; UniqSM (Id, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeJoinPair"><span class="hs-identifier hs-var">cpeJoinPair</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997767"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997794"><span class="hs-identifier hs-var">bndr1</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997769"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-619"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(CorePrepEnv, Floats, Maybe CoreBind)
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; Id -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnv"><span class="hs-identifier hs-var">extendCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997767"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997768"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997795"><span class="hs-identifier hs-var">bndr2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-620"></span><span>                 </span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-621"></span><span>                 </span><span class="annot"><span class="annottext">CoreBind -&gt; Maybe CoreBind
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CpeApp -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997795"><span class="hs-identifier hs-var">bndr2</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997796"><span class="hs-identifier hs-var">rhs1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-622"></span><span>
</span><span id="line-623"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBind"><span class="hs-identifier hs-var">cpeBind</span></a></span><span> </span><span id="local-6989586621681997799"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681997799"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681997800"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997800"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681997802"><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681997802"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-624"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; Id
forall a. HasCallStack =&gt; [a] -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.List.html#head/GHC.List.html#head"><span class="hs-identifier hs-var">head</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997804"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-625"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997805"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997805"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997806"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997806"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [Id] -&gt; UniqSM (CorePrepEnv, [Id])
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997800"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997804"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-626"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997808"><span class="annot"><span class="annottext">env' :: CorePrepEnv
</span><a href="#local-6989586621681997808"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [Id] -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#enterRecGroupRHSs"><span class="hs-identifier hs-var">enterRecGroupRHSs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997805"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997806"><span class="hs-identifier hs-var">bndrs1</span></a></span><span>
</span><span id="line-627"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681997810"><span class="annot"><span class="annottext">[(Floats, CpeApp)]
</span><a href="#local-6989586621681997810"><span class="hs-identifier hs-var">stuff</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp))
-&gt; [Id] -&gt; [CpeApp] -&gt; UniqSM [(Floats, CpeApp)]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><a href="../../base-4.18.3.0/src/Control.Monad.html#zipWithM/Control.Monad.html#zipWithM"><span class="hs-identifier hs-var">zipWithM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; RecFlag
-&gt; Demand
-&gt; Bool
-&gt; CorePrepEnv
-&gt; Id
-&gt; CpeApp
-&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpePair"><span class="hs-identifier hs-var">cpePair</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681997799"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997808"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-628"></span><span>                           </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997806"><span class="hs-identifier hs-var">bndrs1</span></a></span><span> </span><span class="annot"><span class="annottext">[CpeApp]
</span><a href="#local-6989586621681997814"><span class="hs-identifier hs-var">rhss</span></a></span><span>
</span><span id="line-629"></span><span>
</span><span id="line-630"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997815"><span class="annot"><span class="annottext">[Floats]
</span><a href="#local-6989586621681997815"><span class="hs-identifier hs-var">floats_s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997816"><span class="annot"><span class="annottext">[CpeApp]
</span><a href="#local-6989586621681997816"><span class="hs-identifier hs-var">rhss1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Floats, CpeApp)] -&gt; ([Floats], [CpeApp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><a href="../../base-4.18.3.0/src/GHC.List.html#unzip/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a></span><span> </span><span class="annot"><span class="annottext">[(Floats, CpeApp)]
</span><a href="#local-6989586621681997810"><span class="hs-identifier hs-var">stuff</span></a></span><span>
</span><span id="line-631"></span><span>             </span><span id="local-6989586621681997818"><span class="annot"><span class="annottext">all_pairs :: [(Id, CpeApp)]
</span><a href="#local-6989586621681997818"><span class="hs-identifier hs-var hs-var">all_pairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FloatingBind -&gt; [(Id, CpeApp)] -&gt; [(Id, CpeApp)])
-&gt; [(Id, CpeApp)] -&gt; OrdList FloatingBind -&gt; [(Id, CpeApp)]
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
</span><a href="GHC.Data.OrdList.html#foldrOL"><span class="hs-identifier hs-var">foldrOL</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind -&gt; [(Id, CpeApp)] -&gt; [(Id, CpeApp)]
</span><a href="#local-6989586621681997820"><span class="hs-identifier hs-var">add_float</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997806"><span class="hs-identifier hs-var">bndrs1</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [CpeApp] -&gt; [(Id, CpeApp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#zip/GHC.List.html#zip"><span class="hs-operator hs-var">`zip`</span></a></span><span> </span><span class="annot"><span class="annottext">[CpeApp]
</span><a href="#local-6989586621681997816"><span class="hs-identifier hs-var">rhss1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span>                                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Floats] -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#concatFloats"><span class="hs-identifier hs-var">concatFloats</span></a></span><span> </span><span class="annot"><span class="annottext">[Floats]
</span><a href="#local-6989586621681997815"><span class="hs-identifier hs-var">floats_s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-633"></span><span>       </span><span class="hs-comment">-- use env below, so that we reset cpe_rec_ids</span><span>
</span><span id="line-634"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(CorePrepEnv, Floats, Maybe CoreBind)
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [(Id, Id)] -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvList"><span class="hs-identifier hs-var">extendCorePrepEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997805"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997804"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [(Id, Id)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#zip/GHC.List.html#zip"><span class="hs-operator hs-var">`zip`</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997806"><span class="hs-identifier hs-var">bndrs1</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-635"></span><span>                 </span><span class="annot"><span class="annottext">FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#unitFloat"><span class="hs-identifier hs-var">unitFloat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBind -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, CpeApp)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681997818"><span class="hs-identifier hs-var">all_pairs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-636"></span><span>                 </span><span class="annot"><span class="annottext">Maybe CoreBind
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-637"></span><span>
</span><span id="line-638"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-comment">-- See Note [Join points and floating]</span><span>
</span><span id="line-639"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997825"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997825"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997826"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997826"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [Id] -&gt; UniqSM (CorePrepEnv, [Id])
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997800"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997804"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-640"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997827"><span class="annot"><span class="annottext">env' :: CorePrepEnv
</span><a href="#local-6989586621681997827"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [Id] -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#enterRecGroupRHSs"><span class="hs-identifier hs-var">enterRecGroupRHSs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997825"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997826"><span class="hs-identifier hs-var">bndrs1</span></a></span><span>
</span><span id="line-641"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681997828"><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681997828"><span class="hs-identifier hs-var">pairs1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; CpeApp -&gt; UniqSM (Id, CpeApp))
-&gt; [Id] -&gt; [CpeApp] -&gt; UniqSM [(Id, CpeApp)]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><a href="../../base-4.18.3.0/src/Control.Monad.html#zipWithM/Control.Monad.html#zipWithM"><span class="hs-identifier hs-var">zipWithM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; CpeApp -&gt; UniqSM (Id, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeJoinPair"><span class="hs-identifier hs-var">cpeJoinPair</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997827"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997826"><span class="hs-identifier hs-var">bndrs1</span></a></span><span> </span><span class="annot"><span class="annottext">[CpeApp]
</span><a href="#local-6989586621681997814"><span class="hs-identifier hs-var">rhss</span></a></span><span>
</span><span id="line-642"></span><span>
</span><span id="line-643"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997829"><span class="annot"><span class="annottext">bndrs2 :: [Id]
</span><a href="#local-6989586621681997829"><span class="hs-identifier hs-var hs-var">bndrs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Id, CpeApp) -&gt; Id) -&gt; [(Id, CpeApp)] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, CpeApp) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681997828"><span class="hs-identifier hs-var">pairs1</span></a></span><span>
</span><span id="line-644"></span><span>       </span><span class="hs-comment">-- use env below, so that we reset cpe_rec_ids</span><span>
</span><span id="line-645"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(CorePrepEnv, Floats, Maybe CoreBind)
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [(Id, Id)] -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvList"><span class="hs-identifier hs-var">extendCorePrepEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997825"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997804"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [(Id, Id)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#zip/GHC.List.html#zip"><span class="hs-operator hs-var">`zip`</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997829"><span class="hs-identifier hs-var">bndrs2</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-646"></span><span>                 </span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-647"></span><span>                 </span><span class="annot"><span class="annottext">CoreBind -&gt; Maybe CoreBind
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, CpeApp)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681997828"><span class="hs-identifier hs-var">pairs1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-648"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-649"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681997804"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997804"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997814"><span class="annot"><span class="annottext">[CpeApp]
</span><a href="#local-6989586621681997814"><span class="hs-identifier hs-var">rhss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)] -&gt; ([Id], [CpeApp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><a href="../../base-4.18.3.0/src/GHC.List.html#unzip/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681997802"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-650"></span><span>
</span><span id="line-651"></span><span>        </span><span class="hs-comment">-- Flatten all the floats, and the current</span><span>
</span><span id="line-652"></span><span>        </span><span class="hs-comment">-- group into a single giant Rec</span><span>
</span><span id="line-653"></span><span>    </span><span id="local-6989586621681997820"><span class="annot"><span class="annottext">add_float :: FloatingBind -&gt; [(Id, CpeApp)] -&gt; [(Id, CpeApp)]
</span><a href="#local-6989586621681997820"><span class="hs-identifier hs-var hs-var">add_float</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-type">FloatLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681997835"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997835"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681997836"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997836"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681997837"><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681997837"><span class="hs-identifier hs-var">prs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997835"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997836"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Id, CpeApp) -&gt; [(Id, CpeApp)] -&gt; [(Id, CpeApp)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681997837"><span class="hs-identifier hs-var">prs2</span></a></span><span>
</span><span id="line-654"></span><span>    </span><span class="annot"><a href="#local-6989586621681997820"><span class="hs-identifier hs-var">add_float</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-type">FloatLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681997838"><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681997838"><span class="hs-identifier hs-var">prs1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span id="local-6989586621681997839"><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681997839"><span class="hs-identifier hs-var">prs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681997838"><span class="hs-identifier hs-var">prs1</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)] -&gt; [(Id, CpeApp)] -&gt; [(Id, CpeApp)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681997839"><span class="hs-identifier hs-var">prs2</span></a></span><span>
</span><span id="line-655"></span><span>    </span><span class="annot"><a href="#local-6989586621681997820"><span class="hs-identifier hs-var">add_float</span></a></span><span> </span><span id="local-6989586621681997840"><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681997840"><span class="hs-identifier hs-var">b</span></a></span></span><span>                       </span><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; [(Id, CpeApp)]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cpeBind&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatingBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681997840"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span>
</span><span id="line-657"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-658"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpePair"><span class="hs-identifier hs-type">cpePair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-659"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-660"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-661"></span><span class="hs-comment">-- Used for all bindings</span><span>
</span><span id="line-662"></span><span class="hs-comment">-- The binder is already cloned, hence an OutId</span><span>
</span><span id="line-663"></span><span id="cpePair"><span class="annot"><span class="annottext">cpePair :: TopLevelFlag
-&gt; RecFlag
-&gt; Demand
-&gt; Bool
-&gt; CorePrepEnv
-&gt; Id
-&gt; CpeApp
-&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpePair"><span class="hs-identifier hs-var hs-var">cpePair</span></a></span></span><span> </span><span id="local-6989586621681997843"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681997843"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681997844"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681997844"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621681997845"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681997845"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span id="local-6989586621681997846"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681997846"><span class="hs-identifier hs-var">is_unlifted</span></a></span></span><span> </span><span id="local-6989586621681997847"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997847"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681997848"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997848"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681997849"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997849"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-664"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UniqSM (Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997848"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM (Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp))
-&gt; UniqSM (Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-comment">-- those should use cpeJoinPair</span><span>
</span><span id="line-665"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997850"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997850"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997851"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997851"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997847"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997849"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-666"></span><span>
</span><span id="line-667"></span><span>       </span><span class="hs-comment">-- See if we are allowed to float this stuff out of the RHS</span><span>
</span><span id="line-668"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997853"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997853"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997854"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997854"><span class="hs-identifier hs-var">rhs2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="#local-6989586621681997855"><span class="hs-identifier hs-var">float_from_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997850"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997851"><span class="hs-identifier hs-var">rhs1</span></a></span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span>       </span><span class="hs-comment">-- Make the arity match up</span><span>
</span><span id="line-671"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997856"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997856"><span class="hs-identifier hs-var">floats3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997857"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997857"><span class="hs-identifier hs-var">rhs3</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-672"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997851"><span class="hs-identifier hs-var">rhs1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681997860"><span class="hs-identifier hs-var">arity</span></a></span><span>
</span><span id="line-673"></span><span>               </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997853"><span class="hs-identifier hs-var">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681997860"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997854"><span class="hs-identifier hs-var">rhs2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-674"></span><span>               </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; String
-&gt; SDoc
-&gt; UniqSM (Floats, CpeApp)
-&gt; UniqSM (Floats, CpeApp)
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CorePrep: silly extra arguments:&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997848"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM (Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp))
-&gt; UniqSM (Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-675"></span><span>                               </span><span class="hs-comment">-- Note [Silly extra arguments]</span><span>
</span><span id="line-676"></span><span>                    </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681997863"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997863"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; UniqSM Id
</span><a href="GHC.CoreToStg.Prep.html#newVar"><span class="hs-identifier hs-var">newVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997848"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997865"><span class="annot"><span class="annottext">float :: FloatingBind
</span><a href="#local-6989586621681997865"><span class="hs-identifier hs-var hs-var">float</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Demand -&gt; Bool -&gt; Id -&gt; CpeApp -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#mkFloat"><span class="hs-identifier hs-var">mkFloat</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997847"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997863"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997854"><span class="hs-identifier hs-var">rhs2</span></a></span><span>
</span><span id="line-678"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#addFloat"><span class="hs-identifier hs-var">addFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997853"><span class="hs-identifier hs-var">floats2</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681997865"><span class="hs-identifier hs-var">float</span></a></span><span>
</span><span id="line-679"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681997860"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CpeApp
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997863"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-680"></span><span>
</span><span id="line-681"></span><span>        </span><span class="hs-comment">-- Wrap floating ticks</span><span>
</span><span id="line-682"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997866"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997866"><span class="hs-identifier hs-var">floats4</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997867"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997867"><span class="hs-identifier hs-var">rhs4</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; CpeApp -&gt; (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#wrapTicks"><span class="hs-identifier hs-var">wrapTicks</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997856"><span class="hs-identifier hs-var">floats3</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997857"><span class="hs-identifier hs-var">rhs3</span></a></span><span>
</span><span id="line-683"></span><span>
</span><span id="line-684"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997866"><span class="hs-identifier hs-var">floats4</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997867"><span class="hs-identifier hs-var">rhs4</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-685"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-686"></span><span>    </span><span id="local-6989586621681997860"><span class="annot"><span class="annottext">arity :: Int
</span><a href="#local-6989586621681997860"><span class="hs-identifier hs-var hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997848"><span class="hs-identifier hs-var">bndr</span></a></span><span>        </span><span class="hs-comment">-- We must match this arity</span><span>
</span><span id="line-687"></span><span>
</span><span id="line-688"></span><span>    </span><span class="hs-comment">---------------------</span><span>
</span><span id="line-689"></span><span>    </span><span id="local-6989586621681997855"><span class="annot"><span class="annottext">float_from_rhs :: Floats -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="#local-6989586621681997855"><span class="hs-identifier hs-var hs-var">float_from_rhs</span></a></span></span><span> </span><span id="local-6989586621681997870"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997870"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621681997871"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997871"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-690"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isEmptyFloats"><span class="hs-identifier hs-var">isEmptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997870"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997871"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-691"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681997843"><span class="hs-identifier hs-var">top_lvl</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="#local-6989586621681997873"><span class="hs-identifier hs-var">float_top</span></a></span><span>    </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997870"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997871"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-692"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="#local-6989586621681997874"><span class="hs-identifier hs-var">float_nested</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997870"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997871"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-693"></span><span>
</span><span id="line-694"></span><span>    </span><span class="hs-comment">---------------------</span><span>
</span><span id="line-695"></span><span>    </span><span id="local-6989586621681997874"><span class="annot"><span class="annottext">float_nested :: Floats -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="#local-6989586621681997874"><span class="hs-identifier hs-var hs-var">float_nested</span></a></span></span><span> </span><span id="local-6989586621681997875"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997875"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621681997876"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997876"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-696"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RecFlag -&gt; Demand -&gt; Bool -&gt; Floats -&gt; CpeApp -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#wantFloatNested"><span class="hs-identifier hs-var">wantFloatNested</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681997844"><span class="hs-identifier hs-var">is_rec</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681997845"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681997846"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997875"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997876"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-697"></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997875"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997876"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-698"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#dontFloat"><span class="hs-identifier hs-var">dontFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997875"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997876"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-699"></span><span>
</span><span id="line-700"></span><span>    </span><span class="hs-comment">---------------------</span><span>
</span><span id="line-701"></span><span>    </span><span id="local-6989586621681997873"><span class="annot"><span class="annottext">float_top :: Floats -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="#local-6989586621681997873"><span class="hs-identifier hs-var hs-var">float_top</span></a></span></span><span> </span><span id="local-6989586621681997881"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997881"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621681997882"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997882"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-702"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#allLazyTop"><span class="hs-identifier hs-var">allLazyTop</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997881"><span class="hs-identifier hs-var">floats</span></a></span><span>
</span><span id="line-703"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997881"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997882"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-704"></span><span>
</span><span id="line-705"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681997884"><span class="annot"><span class="annottext">(Floats, CpeApp)
</span><a href="#local-6989586621681997884"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; CpeApp -&gt; Maybe (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#canFloat"><span class="hs-identifier hs-var">canFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997881"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997882"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-706"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp)
</span><a href="#local-6989586621681997884"><span class="hs-identifier hs-var">floats</span></a></span><span>
</span><span id="line-707"></span><span>
</span><span id="line-708"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-709"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#dontFloat"><span class="hs-identifier hs-var">dontFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997881"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997882"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-710"></span><span>
</span><span id="line-711"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#dontFloat"><span class="hs-identifier hs-type">dontFloat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-712"></span><span class="hs-comment">-- Non-empty floats, but do not want to float from rhs</span><span>
</span><span id="line-713"></span><span class="hs-comment">-- So wrap the rhs in the floats</span><span>
</span><span id="line-714"></span><span class="hs-comment">-- But: rhs1 might have lambdas, and we can't</span><span>
</span><span id="line-715"></span><span class="hs-comment">--      put them inside a wrapBinds</span><span>
</span><span id="line-716"></span><span id="dontFloat"><span class="annot"><span class="annottext">dontFloat :: Floats -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#dontFloat"><span class="hs-identifier hs-var hs-var">dontFloat</span></a></span></span><span> </span><span id="local-6989586621681997886"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997886"><span class="hs-identifier hs-var">floats1</span></a></span></span><span> </span><span id="local-6989586621681997887"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997887"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-717"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997888"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997888"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997889"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997889"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997887"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-718"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#wrapBinds"><span class="hs-identifier hs-var">wrapBinds</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997886"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">(CpeApp -&gt; CpeApp) -&gt; CpeApp -&gt; CpeApp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-719"></span><span>                               </span><span class="annot"><span class="annottext">Floats -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#wrapBinds"><span class="hs-identifier hs-var">wrapBinds</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997888"><span class="hs-identifier hs-var">floats2</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997889"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-720"></span><span>
</span><span id="line-721"></span><span class="hs-comment">{- Note [Silly extra arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we had this
        f{arity=1} = \x\y. e
We *must* match the arity on the Id, so we have to generate
        f' = \x\y. e
        f  = \x. f' x

It's a bizarre case: why is the arity on the Id wrong?  Reason
(in the days of __inline_me__):
        f{arity=0} = __inline_me__ (let v = expensive in \xy. e)
When InlineMe notes go away this won't happen any more.  But
it seems good for CorePrep to be robust.
-}</span><span>
</span><span id="line-735"></span><span>
</span><span id="line-736"></span><span class="hs-comment">---------------</span><span>
</span><span id="line-737"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeJoinPair"><span class="hs-identifier hs-type">cpeJoinPair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#JoinId"><span class="hs-identifier hs-type">JoinId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-738"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#JoinId"><span class="hs-identifier hs-type">JoinId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-739"></span><span class="hs-comment">-- Used for all join bindings</span><span>
</span><span id="line-740"></span><span class="hs-comment">-- No eta-expansion: see Note [Do not eta-expand join points] in GHC.Core.Opt.Simplify.Utils</span><span>
</span><span id="line-741"></span><span id="cpeJoinPair"><span class="annot"><span class="annottext">cpeJoinPair :: CorePrepEnv -&gt; Id -&gt; CpeApp -&gt; UniqSM (Id, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeJoinPair"><span class="hs-identifier hs-var hs-var">cpeJoinPair</span></a></span></span><span> </span><span id="local-6989586621681997893"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997893"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681997894"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997894"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681997895"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997895"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-742"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UniqSM (Id, CpeApp) -&gt; UniqSM (Id, CpeApp)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997894"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM (Id, CpeApp) -&gt; UniqSM (Id, CpeApp))
-&gt; UniqSM (Id, CpeApp) -&gt; UniqSM (Id, CpeApp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-743"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681997896"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681997896"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Maybe Int
</span><a href="GHC.Types.Id.html#isJoinId_maybe"><span class="hs-identifier hs-var">isJoinId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997894"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-744"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621681997898"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997898"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997899"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997899"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CpeApp -&gt; ([Id], CpeApp)
forall b. Int -&gt; Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectNBinders"><span class="hs-identifier hs-var">collectNBinders</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681997896"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997895"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-745"></span><span>
</span><span id="line-746"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997901"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997901"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997902"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997902"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [Id] -&gt; UniqSM (CorePrepEnv, [Id])
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997893"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997898"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-747"></span><span>
</span><span id="line-748"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681997903"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997903"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-var">cpeBodyNF</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997901"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997899"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-comment">-- Will let-bind the body if it starts</span><span>
</span><span id="line-749"></span><span>                                      </span><span class="hs-comment">-- with a lambda</span><span>
</span><span id="line-750"></span><span>
</span><span id="line-751"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997904"><span class="annot"><span class="annottext">rhs' :: CpeApp
</span><a href="#local-6989586621681997904"><span class="hs-identifier hs-var hs-var">rhs'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Make.html#mkCoreLams"><span class="hs-identifier hs-var">mkCoreLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997902"><span class="hs-identifier hs-var">bndrs'</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997903"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-752"></span><span>             </span><span id="local-6989586621681997906"><span class="annot"><span class="annottext">bndr' :: Id
</span><a href="#local-6989586621681997906"><span class="hs-identifier hs-var hs-var">bndr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997894"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unfolding -&gt; Id
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#evaldUnfolding"><span class="hs-identifier hs-var">evaldUnfolding</span></a></span><span>
</span><span id="line-753"></span><span>                          </span><span class="annot"><span class="annottext">Id -&gt; Int -&gt; Id
</span><a href="GHC.Types.Id.html#setIdArity"><span class="hs-operator hs-var">`setIdArity`</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Int
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Int
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997898"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-754"></span><span>                            </span><span class="hs-comment">-- See Note [Arity and join points]</span><span>
</span><span id="line-755"></span><span>
</span><span id="line-756"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Id, CpeApp) -&gt; UniqSM (Id, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997906"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997904"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-757"></span><span>
</span><span id="line-758"></span><span class="hs-comment">{-
Note [Arity and join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Up to now, we've allowed a join point to have an arity greater than its join
arity (minus type arguments), since this is what's useful for eta expansion.
However, for code gen purposes, its arity must be exactly the number of value
arguments it will be called with, and it must have exactly that many value
lambdas. Hence if there are extra lambdas we must let-bind the body of the RHS:

  join j x y z = \w -&gt; ... in ...
    =&gt;
  join j x y z = (let f = \w -&gt; ... in f) in ...

This is also what happens with Note [Silly extra arguments]. Note that it's okay
for us to mess with the arity because a join point is never exported.
-}</span><span>
</span><span id="line-774"></span><span>
</span><span id="line-775"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-776"></span><span class="hs-comment">--              CpeRhs: produces a result satisfying CpeRhs</span><span>
</span><span id="line-777"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-778"></span><span>
</span><span id="line-779"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-type">cpeRhsE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-780"></span><span class="hs-comment">-- If</span><span>
</span><span id="line-781"></span><span class="hs-comment">--      e  ===&gt;  (bs, e')</span><span>
</span><span id="line-782"></span><span class="hs-comment">-- then</span><span>
</span><span id="line-783"></span><span class="hs-comment">--      e = let bs in e'        (semantically, that is!)</span><span>
</span><span id="line-784"></span><span class="hs-comment">--</span><span>
</span><span id="line-785"></span><span class="hs-comment">-- For example</span><span>
</span><span id="line-786"></span><span class="hs-comment">--      f (g x)   ===&gt;   ([v = g x], f v)</span><span>
</span><span id="line-787"></span><span>
</span><span id="line-788"></span><span id="cpeRhsE"><span class="annot"><span class="annottext">cpeRhsE :: CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var hs-var">cpeRhsE</span></a></span></span><span> </span><span id="local-6989586621681997912"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997912"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621681997914"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681997914"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-789"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CpeApp
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Type -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-var">cpSubstTy</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997912"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681997914"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-790"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621681997916"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997916"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621681997918"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681997918"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-791"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; CpeApp
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.CoreToStg.Prep.html#cpSubstCo"><span class="hs-identifier hs-var">cpSubstCo</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997916"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681997918"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-792"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621681997920"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997920"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681997921"><span class="annot"><span class="annottext">expr :: CpeApp
</span><a href="#local-6989586621681997921"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Literal.html#LitNumber"><span class="hs-identifier hs-type">LitNumber</span></a></span><span> </span><span id="local-6989586621681997924"><span class="annot"><span class="annottext">LitNumType
</span><a href="#local-6989586621681997924"><span class="hs-identifier hs-var">nt</span></a></span></span><span> </span><span id="local-6989586621681997925"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681997925"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-793"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CorePrepConfig -&gt; LitNumType -&gt; Integer -&gt; Maybe CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cp_convertNumLit"><span class="hs-identifier hs-var">cp_convertNumLit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CorePrepConfig
</span><a href="GHC.CoreToStg.Prep.html#cpe_config"><span class="hs-identifier hs-var">cpe_config</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997920"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LitNumType
</span><a href="#local-6989586621681997924"><span class="hs-identifier hs-var">nt</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681997925"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-794"></span><span>      </span><span class="annot"><span class="annottext">Maybe CpeApp
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997921"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-795"></span><span>      </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681997928"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997928"><span class="hs-identifier hs-var">e</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997920"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997928"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-796"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621681997929"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997929"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span id="local-6989586621681997930"><span class="annot"><span class="annottext">expr :: CpeApp
</span><a href="#local-6989586621681997930"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997930"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-797"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621681997931"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997931"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681997932"><span class="annot"><span class="annottext">expr :: CpeApp
</span><a href="#local-6989586621681997932"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeApp"><span class="hs-identifier hs-var">cpeApp</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997931"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997932"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-798"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621681997934"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997934"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681997935"><span class="annot"><span class="annottext">expr :: CpeApp
</span><a href="#local-6989586621681997935"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeApp"><span class="hs-identifier hs-var">cpeApp</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997934"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997935"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-799"></span><span>
</span><span id="line-800"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621681997937"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997937"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621681997939"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681997939"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621681997940"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997940"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-801"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997941"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997941"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997942"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997942"><span class="hs-identifier hs-var">bind_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997943"><span class="annot"><span class="annottext">Maybe CoreBind
</span><a href="#local-6989586621681997943"><span class="hs-identifier hs-var">maybe_bind'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; CorePrepEnv
-&gt; CoreBind
-&gt; UniqSM (CorePrepEnv, Floats, Maybe CoreBind)
</span><a href="GHC.CoreToStg.Prep.html#cpeBind"><span class="hs-identifier hs-var">cpeBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997937"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681997939"><span class="hs-identifier hs-var">bind</span></a></span><span>
</span><span id="line-802"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997945"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997945"><span class="hs-identifier hs-var">body_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997946"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997946"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997941"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997940"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-803"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997947"><span class="annot"><span class="annottext">expr' :: CpeApp
</span><a href="#local-6989586621681997947"><span class="hs-identifier hs-var hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CoreBind
</span><a href="#local-6989586621681997943"><span class="hs-identifier hs-var">maybe_bind'</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681997948"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681997948"><span class="hs-identifier hs-var">bind'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CpeApp -&gt; CpeApp
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681997948"><span class="hs-identifier hs-var">bind'</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997946"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-804"></span><span>                                         </span><span class="annot"><span class="annottext">Maybe CoreBind
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997946"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-805"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997942"><span class="hs-identifier hs-var">bind_floats</span></a></span><span> </span><span class="annot"><span class="annottext">Floats -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#appendFloats"><span class="hs-operator hs-var">`appendFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997945"><span class="hs-identifier hs-var">body_floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997947"><span class="hs-identifier hs-var">expr'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-806"></span><span>
</span><span id="line-807"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621681997949"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997949"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621681997950"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681997950"><span class="hs-identifier hs-var">tickish</span></a></span></span><span> </span><span id="local-6989586621681997951"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997951"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-808"></span><span>  </span><span class="hs-comment">-- Pull out ticks if they are allowed to be floated.</span><span>
</span><span id="line-809"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681997950"><span class="hs-identifier hs-var">tickish</span></a></span><span>
</span><span id="line-810"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997953"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997953"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997954"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997954"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997949"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997951"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-811"></span><span>         </span><span class="hs-comment">-- See [Floating Ticks in CorePrep]</span><span>
</span><span id="line-812"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#unitFloat"><span class="hs-identifier hs-var">unitFloat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-var">FloatTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681997950"><span class="hs-identifier hs-var">tickish</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#appendFloats"><span class="hs-operator hs-var">`appendFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997953"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997954"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-813"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-814"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681997956"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997956"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-var">cpeBodyNF</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997949"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997951"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-815"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681997958"><span class="hs-identifier hs-var">tickish'</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997956"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-816"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-817"></span><span>    </span><span id="local-6989586621681997958"><span class="annot"><span class="annottext">tickish' :: CoreTickish
</span><a href="#local-6989586621681997958"><span class="hs-identifier hs-var hs-var">tickish'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#Breakpoint"><span class="hs-identifier hs-type">Breakpoint</span></a></span><span> </span><span id="local-6989586621681997960"><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
</span><a href="#local-6989586621681997960"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621681997961"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681997961"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681997962"><span class="annot"><span class="annottext">[XTickishId 'TickishPassCore]
</span><a href="#local-6989586621681997962"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681997950"><span class="hs-identifier hs-var">tickish</span></a></span><span>
</span><span id="line-818"></span><span>             </span><span class="hs-comment">-- See also 'substTickish'</span><span>
</span><span id="line-819"></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
-&gt; Int -&gt; [XTickishId 'TickishPassCore] -&gt; CoreTickish
forall (pass :: TickishPass).
XBreakpoint pass -&gt; Int -&gt; [XTickishId pass] -&gt; GenTickish pass
</span><a href="GHC.Types.Tickish.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a></span><span> </span><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
</span><a href="#local-6989586621681997960"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681997961"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CpeApp -&gt; Id
CpeApp -&gt; Id
</span><a href="GHC.Core.Utils.html#getIdFromTrivialExpr"><span class="hs-identifier hs-var">getIdFromTrivialExpr</span></a></span><span> </span><span class="annot"><span class="annottext">(CpeApp -&gt; Id) -&gt; (Id -&gt; CpeApp) -&gt; Id -&gt; Id
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#lookupCorePrepEnv"><span class="hs-identifier hs-var">lookupCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997949"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
[XTickishId 'TickishPassCore]
</span><a href="#local-6989586621681997962"><span class="hs-identifier hs-var">fvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-820"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-821"></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681997950"><span class="hs-identifier hs-var">tickish</span></a></span><span>
</span><span id="line-822"></span><span>
</span><span id="line-823"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621681997966"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997966"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681997968"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997968"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621681997969"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681997969"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-824"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997970"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997970"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997971"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997971"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997966"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997968"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-825"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997970"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Coercion -&gt; CpeApp
forall b. Expr b -&gt; Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997971"><span class="hs-identifier hs-var">expr'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.CoreToStg.Prep.html#cpSubstCo"><span class="hs-identifier hs-var">cpSubstCo</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997966"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681997969"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-826"></span><span>
</span><span id="line-827"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621681997972"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997972"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681997973"><span class="annot"><span class="annottext">expr :: CpeApp
</span><a href="#local-6989586621681997973"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-828"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997975"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997975"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681997976"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997976"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; ([Id], CpeApp)
forall b. Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997973"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-829"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997978"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997978"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997979"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997979"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [Id] -&gt; UniqSM (CorePrepEnv, [Id])
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997972"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997975"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-830"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681997980"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997980"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-var">cpeBodyNF</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997978"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997976"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-831"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; CpeApp -&gt; CpeApp
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681997979"><span class="hs-identifier hs-var">bndrs'</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997980"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-832"></span><span>
</span><span id="line-833"></span><span class="hs-comment">-- Eliminate empty case</span><span>
</span><span id="line-834"></span><span class="hs-comment">-- See Note [Unsafe coercions]</span><span>
</span><span id="line-835"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621681997982"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997982"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621681997984"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997984"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681997985"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681997985"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-836"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681997986"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997986"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681997987"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997987"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997982"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997984"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-837"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681997988"><span class="annot"><span class="annottext">ty' :: Type
</span><a href="#local-6989586621681997988"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Type -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-var">cpSubstTy</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997982"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681997985"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-838"></span><span>             </span><span id="local-6989586621681997989"><span class="annot"><span class="annottext">scrut_ty' :: Type
</span><a href="#local-6989586621681997989"><span class="hs-identifier hs-var hs-var">scrut_ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CpeApp -&gt; Type
CpeApp -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997987"><span class="hs-identifier hs-var">scrut'</span></a></span><span>
</span><span id="line-839"></span><span>             </span><span id="local-6989586621681997991"><span class="annot"><span class="annottext">co' :: Coercion
</span><a href="#local-6989586621681997991"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnivCoProvenance -&gt; Role -&gt; Type -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkUnivCo"><span class="hs-identifier hs-var">mkUnivCo</span></a></span><span> </span><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621681997993"><span class="hs-identifier hs-var">prov</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681997989"><span class="hs-identifier hs-var">scrut_ty'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681997988"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-840"></span><span>             </span><span id="local-6989586621681997993"><span class="annot"><span class="annottext">prov :: UnivCoProvenance
</span><a href="#local-6989586621681997993"><span class="hs-identifier hs-var hs-var">prov</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UnivCoProvenance
</span><a href="GHC.Core.TyCo.Rep.html#CorePrepProv"><span class="hs-identifier hs-var">CorePrepProv</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-841"></span><span>               </span><span class="hs-comment">-- False says that the kinds of two types may differ</span><span>
</span><span id="line-842"></span><span>               </span><span class="hs-comment">-- E.g. we might cast Int to Int#.  This is fine</span><span>
</span><span id="line-843"></span><span>               </span><span class="hs-comment">-- because the scrutinee is guaranteed to diverge</span><span>
</span><span id="line-844"></span><span>
</span><span id="line-845"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681997986"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Coercion -&gt; CpeApp
forall b. Expr b -&gt; Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997987"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681997991"><span class="hs-identifier hs-var">co'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-846"></span><span>   </span><span class="hs-comment">-- This can give rise to</span><span>
</span><span id="line-847"></span><span>   </span><span class="hs-comment">--   Warning: Unsafe coercion: between unboxed and boxed value</span><span>
</span><span id="line-848"></span><span>   </span><span class="hs-comment">-- but it's fine because 'scrut' diverges</span><span>
</span><span id="line-849"></span><span>
</span><span id="line-850"></span><span class="hs-comment">-- Eliminate unsafeEqualityProof</span><span>
</span><span id="line-851"></span><span class="hs-comment">-- See Note [Unsafe coercions]</span><span>
</span><span id="line-852"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621681997996"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997996"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621681997997"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997997"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621681997998"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997998"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681997999"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681997999"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-853"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Bool
</span><a href="GHC.Core.Utils.html#isUnsafeEqualityProof"><span class="hs-identifier hs-var">isUnsafeEqualityProof</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681997997"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-854"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681997998"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-comment">-- We can only discard the case if the case-binder</span><span>
</span><span id="line-855"></span><span>                      </span><span class="hs-comment">-- is dead.  It usually is, but see #18227</span><span>
</span><span id="line-856"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span id="local-6989586621681998003"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998003"><span class="hs-identifier hs-var">co_var</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621681998004"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998004"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681997999"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-857"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681998006"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998006"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681998007"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998007"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Id -&gt; Pair Type
Id -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coVarTypes"><span class="hs-identifier hs-var">coVarTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998003"><span class="hs-identifier hs-var">co_var</span></a></span><span>
</span><span id="line-858"></span><span>        </span><span id="local-6989586621681998009"><span class="annot"><span class="annottext">the_co :: Coercion
</span><a href="#local-6989586621681998009"><span class="hs-identifier hs-var hs-var">the_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnivCoProvenance -&gt; Role -&gt; Type -&gt; Type -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkUnivCo"><span class="hs-identifier hs-var">mkUnivCo</span></a></span><span> </span><span class="annot"><span class="annottext">UnivCoProvenance
</span><a href="#local-6989586621681998010"><span class="hs-identifier hs-var">prov</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Type -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-var">cpSubstTy</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997996"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998006"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Type -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-var">cpSubstTy</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997996"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998007"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-859"></span><span>        </span><span id="local-6989586621681998010"><span class="annot"><span class="annottext">prov :: UnivCoProvenance
</span><a href="#local-6989586621681998010"><span class="hs-identifier hs-var hs-var">prov</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UnivCoProvenance
</span><a href="GHC.Core.TyCo.Rep.html#CorePrepProv"><span class="hs-identifier hs-var">CorePrepProv</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-comment">-- True &lt;=&gt; kind homogeneous</span><span>
</span><span id="line-860"></span><span>        </span><span id="local-6989586621681998012"><span class="annot"><span class="annottext">env' :: CorePrepEnv
</span><a href="#local-6989586621681998012"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; Coercion -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCoVarEnv"><span class="hs-identifier hs-var">extendCoVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681997996"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998003"><span class="hs-identifier hs-var">co_var</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998009"><span class="hs-identifier hs-var">the_co</span></a></span><span>
</span><span id="line-861"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998012"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998004"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-862"></span><span>
</span><span id="line-863"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span id="local-6989586621681998014"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998014"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621681998015"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998015"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621681998016"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998016"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681998017"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998017"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681998018"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681998018"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-864"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998019"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998019"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998020"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998020"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeBody"><span class="hs-identifier hs-var">cpeBody</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998014"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998015"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-865"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998022"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998022"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998023"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998023"><span class="hs-identifier hs-var">bndr2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; UniqSM (CorePrepEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-var">cpCloneBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998014"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998016"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-866"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681998024"><span class="annot"><span class="annottext">alts' :: [Alt Id]
</span><a href="#local-6989586621681998024"><span class="hs-identifier hs-var hs-var">alts'</span></a></span></span><span>
</span><span id="line-867"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CorePrepConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cp_catchNonexhaustiveCases"><span class="hs-identifier hs-var">cp_catchNonexhaustiveCases</span></a></span><span> </span><span class="annot"><span class="annottext">(CorePrepConfig -&gt; Bool) -&gt; CorePrepConfig -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CorePrepConfig
</span><a href="GHC.CoreToStg.Prep.html#cpe_config"><span class="hs-identifier hs-var">cpe_config</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998014"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-868"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Alt Id] -&gt; Bool
forall b. [Alt b] -&gt; Bool
</span><a href="GHC.Core.Utils.html#altsAreExhaustive"><span class="hs-identifier hs-var">altsAreExhaustive</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681998018"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-869"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Alt Id] -&gt; Maybe CpeApp -&gt; [Alt Id]
forall b. [Alt b] -&gt; Maybe (Expr b) -&gt; [Alt b]
</span><a href="GHC.Core.Utils.html#addDefault"><span class="hs-identifier hs-var">addDefault</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681998018"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; Maybe CpeApp
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998028"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-870"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681998018"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-871"></span><span>               </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681998028"><span class="annot"><span class="annottext">err :: CpeApp
</span><a href="#local-6989586621681998028"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; String -&gt; CpeApp
</span><a href="GHC.Core.Make.html#mkImpossibleExpr"><span class="hs-identifier hs-var">mkImpossibleExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998017"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cpeRhsE: missing case alternative&quot;</span></span><span>
</span><span id="line-872"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681998030"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681998030"><span class="hs-identifier hs-var">alts''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Alt Id -&gt; UniqSM (Alt Id)) -&gt; [Alt Id] -&gt; UniqSM [Alt Id]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapM/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Alt Id -&gt; UniqSM (Alt Id)
</span><a href="#local-6989586621681998032"><span class="hs-identifier hs-var">sat_alt</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998022"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681998024"><span class="hs-identifier hs-var">alts'</span></a></span><span>
</span><span id="line-873"></span><span>
</span><span id="line-874"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998019"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Id -&gt; Type -&gt; [Alt Id] -&gt; CpeApp
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998020"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998023"><span class="hs-identifier hs-var">bndr2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998017"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681998030"><span class="hs-identifier hs-var">alts''</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-875"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-876"></span><span>    </span><span id="local-6989586621681998032"><span class="annot"><span class="annottext">sat_alt :: CorePrepEnv -&gt; Alt Id -&gt; UniqSM (Alt Id)
</span><a href="#local-6989586621681998032"><span class="hs-identifier hs-var hs-var">sat_alt</span></a></span></span><span> </span><span id="local-6989586621681998036"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998036"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621681998037"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681998037"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621681998038"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998038"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681998039"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998039"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-877"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998040"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998040"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998041"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998041"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; [Id] -&gt; UniqSM (CorePrepEnv, [Id])
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998036"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998038"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-878"></span><span>            </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681998042"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998042"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-var">cpeBodyNF</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998040"><span class="hs-identifier hs-var">env2</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998039"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-879"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Alt Id -&gt; UniqSM (Alt Id)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; CpeApp -&gt; Alt Id
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681998037"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998041"><span class="hs-identifier hs-var">bs'</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998042"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-880"></span><span>
</span><span id="line-881"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-882"></span><span class="hs-comment">--              CpeBody: produces a result satisfying CpeBody</span><span>
</span><span id="line-883"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-884"></span><span>
</span><span id="line-885"></span><span class="hs-comment">-- | Convert a 'CoreExpr' so it satisfies 'CpeBody', without</span><span>
</span><span id="line-886"></span><span class="hs-comment">-- producing any floats (any generated floats are immediately</span><span>
</span><span id="line-887"></span><span class="hs-comment">-- let-bound using 'wrapBinds').  Generally you want this, esp.</span><span>
</span><span id="line-888"></span><span class="hs-comment">-- when you've reached a binding form (e.g., a lambda) and</span><span>
</span><span id="line-889"></span><span class="hs-comment">-- floating any further would be incorrect.</span><span>
</span><span id="line-890"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-type">cpeBodyNF</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a></span><span>
</span><span id="line-891"></span><span id="cpeBodyNF"><span class="annot"><span class="annottext">cpeBodyNF :: CorePrepEnv -&gt; CpeApp -&gt; UniqSM CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpeBodyNF"><span class="hs-identifier hs-var hs-var">cpeBodyNF</span></a></span></span><span> </span><span id="local-6989586621681998043"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998043"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998044"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998044"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-892"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998045"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998045"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998046"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998046"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeBody"><span class="hs-identifier hs-var">cpeBody</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998043"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998044"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-893"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; UniqSM CpeApp
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#wrapBinds"><span class="hs-identifier hs-var">wrapBinds</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998045"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998046"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-894"></span><span>
</span><span id="line-895"></span><span class="hs-comment">-- | Convert a 'CoreExpr' so it satisfies 'CpeBody'; also produce</span><span>
</span><span id="line-896"></span><span class="hs-comment">-- a list of 'Floats' which are being propagated upwards.  In</span><span>
</span><span id="line-897"></span><span class="hs-comment">-- fact, this function is used in only two cases: to</span><span>
</span><span id="line-898"></span><span class="hs-comment">-- implement 'cpeBodyNF' (which is what you usually want),</span><span>
</span><span id="line-899"></span><span class="hs-comment">-- and in the case when a let-binding is in a case scrutinee--here,</span><span>
</span><span id="line-900"></span><span class="hs-comment">-- we can always float out:</span><span>
</span><span id="line-901"></span><span class="hs-comment">--</span><span>
</span><span id="line-902"></span><span class="hs-comment">--      case (let x = y in z) of ...</span><span>
</span><span id="line-903"></span><span class="hs-comment">--      ==&gt; let x = y in case z of ...</span><span>
</span><span id="line-904"></span><span class="hs-comment">--</span><span>
</span><span id="line-905"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeBody"><span class="hs-identifier hs-type">cpeBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-906"></span><span id="cpeBody"><span class="annot"><span class="annottext">cpeBody :: CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeBody"><span class="hs-identifier hs-var hs-var">cpeBody</span></a></span></span><span> </span><span id="local-6989586621681998048"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998048"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998049"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998049"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-907"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998050"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998050"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998051"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998051"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998048"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998049"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-908"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998052"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998052"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998053"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998053"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998051"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-909"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998050"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">Floats -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#appendFloats"><span class="hs-operator hs-var">`appendFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998052"><span class="hs-identifier hs-var">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998053"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-910"></span><span>
</span><span id="line-911"></span><span class="hs-comment">--------</span><span>
</span><span id="line-912"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-type">rhsToBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-913"></span><span class="hs-comment">-- Remove top level lambdas by let-binding</span><span>
</span><span id="line-914"></span><span>
</span><span id="line-915"></span><span id="rhsToBody"><span class="annot"><span class="annottext">rhsToBody :: CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var hs-var">rhsToBody</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621681998054"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998054"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621681998055"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998055"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-916"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; TickishScoping
forall (pass :: TickishPass). GenTickish pass -&gt; TickishScoping
</span><a href="GHC.Types.Tickish.html#tickishScoped"><span class="hs-identifier hs-var">tickishScoped</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998054"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">TickishScoping -&gt; TickishScoping -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TickishScoping
</span><a href="GHC.Types.Tickish.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a></span><span>  </span><span class="hs-comment">-- only float out of non-scoped annotations</span><span>
</span><span id="line-917"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998058"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998058"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998059"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998059"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998055"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-918"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998058"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998054"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998059"><span class="hs-identifier hs-var">expr'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-919"></span><span>
</span><span id="line-920"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681998060"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998060"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681998061"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998061"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-921"></span><span>        </span><span class="hs-comment">-- You can get things like</span><span>
</span><span id="line-922"></span><span>        </span><span class="hs-comment">--      case e of { p -&gt; coerce t (\s -&gt; ...) }</span><span>
</span><span id="line-923"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998062"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998062"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998063"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998063"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998060"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-924"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998062"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Coercion -&gt; CpeApp
forall b. Expr b -&gt; Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998063"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998061"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-925"></span><span>
</span><span id="line-926"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span id="local-6989586621681998064"><span class="annot"><span class="annottext">expr :: CpeApp
</span><a href="#local-6989586621681998064"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- See Note [No eta reduction needed in rhsToBody]</span><span>
</span><span id="line-927"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#all/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998067"><span class="hs-identifier hs-var">bndrs</span></a></span><span>           </span><span class="hs-comment">-- Type lambdas are ok</span><span>
</span><span id="line-928"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998064"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-929"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                   </span><span class="hs-comment">-- Some value lambdas</span><span>
</span><span id="line-930"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681998068"><span class="annot"><span class="annottext">rhs :: CpeApp
</span><a href="#local-6989586621681998068"><span class="hs-identifier hs-var hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier hs-var">exprArity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998064"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998064"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-931"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681998070"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998070"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; UniqSM Id
</span><a href="GHC.CoreToStg.Prep.html#newVar"><span class="hs-identifier hs-var">newVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CpeApp -&gt; Type
CpeApp -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998068"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-932"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681998071"><span class="annot"><span class="annottext">float :: FloatingBind
</span><a href="#local-6989586621681998071"><span class="hs-identifier hs-var hs-var">float</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CpeApp -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998070"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998068"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-933"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#unitFloat"><span class="hs-identifier hs-var">unitFloat</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998071"><span class="hs-identifier hs-var">float</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CpeApp
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998070"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-934"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-935"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681998067"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998067"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CpeApp
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; ([Id], CpeApp)
forall b. Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998064"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-936"></span><span>
</span><span id="line-937"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a></span><span> </span><span id="local-6989586621681998072"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998072"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998072"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-938"></span><span>
</span><span id="line-939"></span><span>
</span><span id="line-940"></span><span class="hs-comment">{- Note [No eta reduction needed in rhsToBody]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Historical note.  In the olden days we used to have a Prep-specific
eta-reduction step in rhsToBody:
  rhsToBody expr@(Lam {})
    | Just no_lam_result &lt;- tryEtaReducePrep bndrs body
    = return (emptyFloats, no_lam_result)

The goal was to reduce
        case x of { p -&gt; \xs. map f xs }
    ==&gt; case x of { p -&gt; map f }

to avoid allocating a lambda.  Of course, we'd allocate a PAP
instead, which is hardly better, but that's the way it was.

Now we simply don't bother with this. It doesn't seem to be a win,
and it's extra work.
-}</span><span>
</span><span id="line-958"></span><span>
</span><span id="line-959"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-960"></span><span class="hs-comment">--              CpeApp: produces a result satisfying CpeApp</span><span>
</span><span id="line-961"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-962"></span><span>
</span><span id="line-963"></span><span class="hs-keyword">data</span><span> </span><span id="ArgInfo"><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-var">ArgInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CpeApp"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a></span></span><span>  </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span>
</span><span id="line-964"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span id="CpeCast"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeCast"><span class="hs-identifier hs-var">CpeCast</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-965"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span id="CpeTick"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTick"><span class="hs-identifier hs-var">CpeTick</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span>
</span><span id="line-966"></span><span>
</span><span id="line-967"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-968"></span><span>  </span><span id="local-6989586621681998092"><span class="annot"><span class="annottext">ppr :: ArgInfo -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span id="local-6989586621681998093"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998093"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;app&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998093"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-969"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeCast"><span class="hs-identifier hs-type">CpeCast</span></a></span><span> </span><span id="local-6989586621681998094"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998094"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cast&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998094"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-970"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTick"><span class="hs-identifier hs-type">CpeTick</span></a></span><span> </span><span id="local-6989586621681998095"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998095"><span class="hs-identifier hs-var">tick</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tick&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998095"><span class="hs-identifier hs-var">tick</span></a></span><span>
</span><span id="line-971"></span><span>
</span><span id="line-972"></span><span class="hs-comment">{- Note [Ticks and mandatory eta expansion]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Something like
    `foo x = ({-# SCC foo #-} tagToEnum#) x :: Bool`
caused a compiler panic in #20938. Why did this happen?
The simplifier will eta-reduce the rhs giving us a partial
application of tagToEnum#. The tick is then pushed inside the
type argument. That is we get
    `(Tick&lt;foo&gt; tagToEnum#) @Bool`
CorePrep would go on to see a undersaturated tagToEnum# application
and eta expand the expression under the tick. Giving us:
    (Tick&lt;scc&gt; (\forall a. x -&gt; tagToEnum# @a x) @Bool
Suddenly tagToEnum# is applied to a polymorphic type and the code generator
panics as it needs a concrete type to determine the representation.

The problem in my eyes was that the tick covers a partial application
of a primop. There is no clear semantic for such a construct as we can't
partially apply a primop since they do not have bindings.
We fix this by expanding the scope of such ticks slightly to cover the body
of the eta-expanded expression.

We do this by:
* Checking if an application is headed by a primOpish thing.
* If so we collect floatable ticks and usually but also profiling ticks
  along with regular arguments.
* When rebuilding the application we check if any profiling ticks appear
  before the primop is fully saturated.
* If the primop isn't fully satured we eta expand the primop application
  and scope the tick to scope over the body of the saturated expression.

Going back to #20938 this means starting with
    `(Tick&lt;foo&gt; tagToEnum#) @Bool`
we check if the function head is a primop (yes). This means we collect the
profiling tick like if it was floatable. Giving us
    (tagToEnum#, [CpeTick foo, CpeApp @Bool]).
cpe_app filters out the tick as a underscoped tick on the expression
`tagToEnum# @Bool`. During eta expansion we then put that tick back onto the
body of the eta-expansion lambdas. Giving us `\x -&gt; Tick&lt;foo&gt; (tagToEnum# @Bool x)`.
-}</span><span>
</span><span id="line-1011"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeApp"><span class="hs-identifier hs-type">cpeApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1012"></span><span class="hs-comment">-- May return a CpeRhs because of saturating primops</span><span>
</span><span id="line-1013"></span><span id="cpeApp"><span class="annot"><span class="annottext">cpeApp :: CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeApp"><span class="hs-identifier hs-var hs-var">cpeApp</span></a></span></span><span> </span><span id="local-6989586621681998096"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998096"><span class="hs-identifier hs-var">top_env</span></a></span></span><span> </span><span id="local-6989586621681998097"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998097"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-1014"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998098"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998098"><span class="hs-identifier hs-var">terminal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998099"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998099"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; (CpeApp, [ArgInfo])
</span><a href="#local-6989586621681998100"><span class="hs-identifier hs-var">collect_args</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998097"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1015"></span><span>      </span><span class="hs-comment">--  ; pprTraceM &quot;cpeApp&quot; $ (ppr expr)</span><span>
</span><span id="line-1016"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; [ArgInfo] -&gt; UniqSM (Floats, CpeApp)
</span><a href="#local-6989586621681998101"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998096"><span class="hs-identifier hs-var">top_env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998098"><span class="hs-identifier hs-var">terminal</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998099"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1017"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-1018"></span><span>
</span><span id="line-1019"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1020"></span><span>    </span><span class="hs-comment">-- We have a nested data structure of the form</span><span>
</span><span id="line-1021"></span><span>    </span><span class="hs-comment">-- e `App` a1 `App` a2 ... `App` an, convert it into</span><span>
</span><span id="line-1022"></span><span>    </span><span class="hs-comment">-- (e, [CpeApp a1, CpeApp a2, ..., CpeApp an], depth)</span><span>
</span><span id="line-1023"></span><span>    </span><span class="hs-comment">-- We use 'ArgInfo' because we may also need to</span><span>
</span><span id="line-1024"></span><span>    </span><span class="hs-comment">-- record casts and ticks.  Depth counts the number</span><span>
</span><span id="line-1025"></span><span>    </span><span class="hs-comment">-- of arguments that would consume strictness information</span><span>
</span><span id="line-1026"></span><span>    </span><span class="hs-comment">-- (so, no type or coercion arguments.)</span><span>
</span><span id="line-1027"></span><span>    </span><span class="annot"><a href="#local-6989586621681998100"><span class="hs-identifier hs-type">collect_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1028"></span><span>    </span><span id="local-6989586621681998100"><span class="annot"><span class="annottext">collect_args :: CpeApp -&gt; (CpeApp, [ArgInfo])
</span><a href="#local-6989586621681998100"><span class="hs-identifier hs-var hs-var">collect_args</span></a></span></span><span> </span><span id="local-6989586621681998102"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998102"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; [ArgInfo] -&gt; (CpeApp, [ArgInfo])
</span><a href="#local-6989586621681998103"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998102"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1029"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1030"></span><span>        </span><span id="local-6989586621681998103"><span class="annot"><span class="annottext">go :: CpeApp -&gt; [ArgInfo] -&gt; (CpeApp, [ArgInfo])
</span><a href="#local-6989586621681998103"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681998104"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998104"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681998105"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998105"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span>      </span><span id="local-6989586621681998106"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998106"><span class="hs-keyword hs-var">as</span></a></span></span><span>
</span><span id="line-1031"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; [ArgInfo] -&gt; (CpeApp, [ArgInfo])
</span><a href="#local-6989586621681998103"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998104"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; ArgInfo
</span><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998105"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998106"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1032"></span><span>        </span><span class="annot"><a href="#local-6989586621681998103"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681998107"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998107"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681998108"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998108"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>      </span><span id="local-6989586621681998109"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998109"><span class="hs-keyword hs-var">as</span></a></span></span><span>
</span><span id="line-1033"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; [ArgInfo] -&gt; (CpeApp, [ArgInfo])
</span><a href="#local-6989586621681998103"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998107"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; ArgInfo
</span><a href="GHC.CoreToStg.Prep.html#CpeCast"><span class="hs-identifier hs-var">CpeCast</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998108"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998109"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1034"></span><span>        </span><span class="annot"><a href="#local-6989586621681998103"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621681998110"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998110"><span class="hs-identifier hs-var">tickish</span></a></span></span><span> </span><span id="local-6989586621681998111"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998111"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998112"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998112"><span class="hs-keyword hs-var">as</span></a></span></span><span>
</span><span id="line-1035"></span><span>            </span><span class="hs-comment">-- Profiling ticks are slightly less strict so we expand their scope</span><span>
</span><span id="line-1036"></span><span>            </span><span class="hs-comment">-- if they cover partial applications of things like primOps.</span><span>
</span><span id="line-1037"></span><span>            </span><span class="hs-comment">-- See Note [Ticks and mandatory eta expansion]</span><span>
</span><span id="line-1038"></span><span>            </span><span class="hs-comment">-- Here we look inside `fun` before we make the final decision about</span><span>
</span><span id="line-1039"></span><span>            </span><span class="hs-comment">-- floating the tick which isn't optimal for perf. But this only makes</span><span>
</span><span id="line-1040"></span><span>            </span><span class="hs-comment">-- a difference if we have a non-floatable tick which is somewhat rare.</span><span>
</span><span id="line-1041"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681998113"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998113"><span class="hs-identifier hs-var">vh</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998114"><span class="hs-identifier hs-var">head</span></a></span><span>
</span><span id="line-1042"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681998115"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998115"><span class="hs-identifier hs-var">head'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#lookupCorePrepEnv"><span class="hs-identifier hs-var">lookupCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998096"><span class="hs-identifier hs-var">top_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998113"><span class="hs-identifier hs-var">vh</span></a></span><span>
</span><span id="line-1043"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreTickish -&gt; Bool
forall (pass :: TickishPass). Id -&gt; GenTickish pass -&gt; Bool
</span><a href="GHC.Core.Utils.html#etaExpansionTick"><span class="hs-identifier hs-var">etaExpansionTick</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998115"><span class="hs-identifier hs-var">head'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998110"><span class="hs-identifier hs-var">tickish</span></a></span><span>
</span><span id="line-1044"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998114"><span class="hs-identifier hs-var">head</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998117"><span class="hs-identifier hs-var">as'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1045"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-1046"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621681998114"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998114"><span class="hs-identifier hs-var">head</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681998117"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998117"><span class="hs-identifier hs-var">as'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; [ArgInfo] -&gt; (CpeApp, [ArgInfo])
</span><a href="#local-6989586621681998103"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998111"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; ArgInfo
</span><a href="GHC.CoreToStg.Prep.html#CpeTick"><span class="hs-identifier hs-var">CpeTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998110"><span class="hs-identifier hs-var">tickish</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998112"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1047"></span><span>
</span><span id="line-1048"></span><span>        </span><span class="hs-comment">-- Terminal could still be an app if it's wrapped by a tick.</span><span>
</span><span id="line-1049"></span><span>        </span><span class="hs-comment">-- E.g. Tick&lt;foo&gt; (f x) can give us (f x) as terminal.</span><span>
</span><span id="line-1050"></span><span>        </span><span class="annot"><a href="#local-6989586621681998103"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681998118"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998118"><span class="hs-identifier hs-var">terminal</span></a></span></span><span> </span><span id="local-6989586621681998119"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998119"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998118"><span class="hs-identifier hs-var">terminal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998119"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1051"></span><span>
</span><span id="line-1052"></span><span>    </span><span class="annot"><a href="#local-6989586621681998101"><span class="hs-identifier hs-type">cpe_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-1053"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-comment">-- The thing we are calling</span><span>
</span><span id="line-1054"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1055"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1056"></span><span>    </span><span id="local-6989586621681998101"><span class="annot"><span class="annottext">cpe_app :: CorePrepEnv -&gt; CpeApp -&gt; [ArgInfo] -&gt; UniqSM (Floats, CpeApp)
</span><a href="#local-6989586621681998101"><span class="hs-identifier hs-var hs-var">cpe_app</span></a></span></span><span> </span><span id="local-6989586621681998120"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998120"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681998121"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998121"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span id="local-6989586621681998122"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998122"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681998123"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998123"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1057"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998121"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#lazyIdKey"><span class="hs-identifier hs-var">lazyIdKey</span></a></span><span>          </span><span class="hs-comment">-- Replace (lazy a) with a, and</span><span>
</span><span id="line-1058"></span><span>            </span><span class="hs-comment">-- See Note [lazyId magic] in GHC.Types.Id.Make</span><span>
</span><span id="line-1059"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998121"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#noinlineIdKey"><span class="hs-identifier hs-var">noinlineIdKey</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998121"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#noinlineConstraintIdKey"><span class="hs-identifier hs-var">noinlineConstraintIdKey</span></a></span><span>
</span><span id="line-1060"></span><span>            </span><span class="hs-comment">-- Replace (noinline a) with a</span><span>
</span><span id="line-1061"></span><span>            </span><span class="hs-comment">-- See Note [noinlineId magic] in GHC.Types.Id.Make</span><span>
</span><span id="line-1062"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998121"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#nospecIdKey"><span class="hs-identifier hs-var">nospecIdKey</span></a></span><span>        </span><span class="hs-comment">-- Replace (nospec a) with a</span><span>
</span><span id="line-1063"></span><span>            </span><span class="hs-comment">-- See Note [nospecId magic] in GHC.Types.Id.Make</span><span>
</span><span id="line-1064"></span><span>
</span><span id="line-1065"></span><span>        </span><span class="hs-comment">-- Consider the code:</span><span>
</span><span id="line-1066"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1067"></span><span>        </span><span class="hs-comment">--      lazy (f x) y</span><span>
</span><span id="line-1068"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1069"></span><span>        </span><span class="hs-comment">-- We need to make sure that we need to recursively collect arguments on</span><span>
</span><span id="line-1070"></span><span>        </span><span class="hs-comment">-- &quot;f x&quot;, otherwise we'll float &quot;f x&quot; out (it's not a variable) and</span><span>
</span><span id="line-1071"></span><span>        </span><span class="hs-comment">-- end up with this awful -ddump-prep:</span><span>
</span><span id="line-1072"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1073"></span><span>        </span><span class="hs-comment">--      case f x of f_x {</span><span>
</span><span id="line-1074"></span><span>        </span><span class="hs-comment">--        __DEFAULT -&gt; f_x y</span><span>
</span><span id="line-1075"></span><span>        </span><span class="hs-comment">--      }</span><span>
</span><span id="line-1076"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1077"></span><span>        </span><span class="hs-comment">-- rather than the far superior &quot;f x y&quot;.  Test case is par01.</span><span>
</span><span id="line-1078"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998130"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998130"><span class="hs-identifier hs-var">terminal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998131"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998131"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; (CpeApp, [ArgInfo])
</span><a href="#local-6989586621681998100"><span class="hs-identifier hs-var">collect_args</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998122"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-1079"></span><span>          </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; [ArgInfo] -&gt; UniqSM (Floats, CpeApp)
</span><a href="#local-6989586621681998101"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998120"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998130"><span class="hs-identifier hs-var">terminal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998131"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998123"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1080"></span><span>
</span><span id="line-1081"></span><span>    </span><span class="hs-comment">-- runRW# magic</span><span>
</span><span id="line-1082"></span><span>    </span><span class="annot"><a href="#local-6989586621681998101"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span id="local-6989586621681998132"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998132"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681998133"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998133"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span id="local-6989586621681998134"><span class="annot"><span class="annottext">_runtimeRep :: CpeApp
</span><a href="#local-6989586621681998134"><span class="hs-identifier hs-var">_runtimeRep</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span id="local-6989586621681998135"><span class="annot"><span class="annottext">_type :: CpeApp
</span><a href="#local-6989586621681998135"><span class="hs-identifier hs-var">_type</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span id="local-6989586621681998136"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998136"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681998137"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998137"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1083"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998133"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#runRWKey"><span class="hs-identifier hs-var">runRWKey</span></a></span><span>
</span><span id="line-1084"></span><span>        </span><span class="hs-comment">-- N.B. While it may appear that n == 1 in the case of runRW#</span><span>
</span><span id="line-1085"></span><span>        </span><span class="hs-comment">-- applications, keep in mind that we may have applications that return</span><span>
</span><span id="line-1086"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; Bool
</span><a href="#local-6989586621681998139"><span class="hs-identifier hs-var">has_value_arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; ArgInfo
</span><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998136"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998137"><span class="hs-identifier hs-var">rest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1087"></span><span>        </span><span class="hs-comment">-- See Note [runRW magic]</span><span>
</span><span id="line-1088"></span><span>        </span><span class="hs-comment">-- Replace (runRW# f) by (f realWorld#), beta reducing if possible (this</span><span>
</span><span id="line-1089"></span><span>        </span><span class="hs-comment">-- is why we return a CorePrepEnv as well)</span><span>
</span><span id="line-1090"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998136"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1091"></span><span>            </span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681998140"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998140"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621681998141"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998141"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; [ArgInfo] -&gt; UniqSM (Floats, CpeApp)
</span><a href="#local-6989586621681998101"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; Id -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnv"><span class="hs-identifier hs-var">extendCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998132"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998140"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Types.Id.Make.html#realWorldPrimId"><span class="hs-identifier hs-var">realWorldPrimId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998141"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998137"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-1092"></span><span>            </span><span class="annot"><span class="annottext">CpeApp
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; [ArgInfo] -&gt; UniqSM (Floats, CpeApp)
</span><a href="#local-6989586621681998101"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998132"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998136"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; ArgInfo
</span><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CpeApp
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Types.Id.Make.html#realWorldPrimId"><span class="hs-identifier hs-var">realWorldPrimId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998137"><span class="hs-identifier hs-var">rest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1093"></span><span>             </span><span class="hs-comment">-- TODO: What about casts?</span><span>
</span><span id="line-1094"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1095"></span><span>          </span><span id="local-6989586621681998139"><span class="annot"><span class="annottext">has_value_arg :: [ArgInfo] -&gt; Bool
</span><a href="#local-6989586621681998139"><span class="hs-identifier hs-var hs-var">has_value_arg</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1096"></span><span>          </span><span class="annot"><a href="#local-6989586621681998139"><span class="hs-identifier hs-var">has_value_arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span id="local-6989586621681998142"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998142"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681998143"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998143"><span class="hs-identifier hs-var">_rest</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1097"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTyCoArg"><span class="hs-identifier hs-var">isTyCoArg</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998142"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1098"></span><span>          </span><span class="annot"><a href="#local-6989586621681998139"><span class="hs-identifier hs-var">has_value_arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681998145"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998145"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; Bool
</span><a href="#local-6989586621681998139"><span class="hs-identifier hs-var">has_value_arg</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998145"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-1099"></span><span>
</span><span id="line-1100"></span><span>    </span><span class="annot"><a href="#local-6989586621681998101"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span id="local-6989586621681998146"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998146"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681998147"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998147"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998148"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998148"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-1101"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681998149"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998149"><span class="hs-identifier hs-var">v1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; UniqSM Id
</span><a href="GHC.CoreToStg.Prep.html#fiddleCCall"><span class="hs-identifier hs-var">fiddleCCall</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998147"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1102"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681998151"><span class="annot"><span class="annottext">e2 :: CpeApp
</span><a href="#local-6989586621681998151"><span class="hs-identifier hs-var hs-var">e2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#lookupCorePrepEnv"><span class="hs-identifier hs-var">lookupCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998146"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998149"><span class="hs-identifier hs-var">v1</span></a></span><span>
</span><span id="line-1103"></span><span>                 </span><span id="local-6989586621681998152"><span class="annot"><span class="annottext">hd :: Maybe Id
</span><a href="#local-6989586621681998152"><span class="hs-identifier hs-var hs-var">hd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Maybe Id
</span><a href="GHC.Core.Utils.html#getIdFromTrivialExpr_maybe"><span class="hs-identifier hs-var">getIdFromTrivialExpr_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998151"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-1104"></span><span>                 </span><span class="hs-comment">-- Determine number of required arguments. See Note [Ticks and mandatory eta expansion]</span><span>
</span><span id="line-1105"></span><span>                 </span><span id="local-6989586621681998154"><span class="annot"><span class="annottext">min_arity :: Maybe Int
</span><a href="#local-6989586621681998154"><span class="hs-identifier hs-var hs-var">min_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Id
</span><a href="#local-6989586621681998152"><span class="hs-identifier hs-var">hd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1106"></span><span>                   </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681998155"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998155"><span class="hs-identifier hs-var">v_hd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#hasNoBinding"><span class="hs-identifier hs-var">hasNoBinding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998155"><span class="hs-identifier hs-var">v_hd</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24%21/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998155"><span class="hs-identifier hs-var">v_hd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1107"></span><span>                   </span><span class="annot"><span class="annottext">Maybe Id
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1108"></span><span>          </span><span class="hs-comment">--  ; pprTraceM &quot;cpe_app:stricts:&quot; (ppr v &lt;+&gt; ppr args $$ ppr stricts $$ ppr (idCbvMarks_maybe v))</span><span>
</span><span id="line-1109"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998158"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998158"><span class="hs-identifier hs-var">app</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998159"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998159"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998160"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998160"><span class="hs-identifier hs-var">unsat_ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeApp
-&gt; Floats
-&gt; [Demand]
-&gt; Maybe Int
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
</span><a href="#local-6989586621681998161"><span class="hs-identifier hs-var">rebuild_app</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998146"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998148"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998151"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998162"><span class="hs-identifier hs-var">stricts</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621681998154"><span class="hs-identifier hs-var">min_arity</span></a></span><span>
</span><span id="line-1110"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Maybe Id
-&gt; CpeApp
-&gt; Floats
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (Floats, CpeApp)
forall {a}.
Maybe Id
-&gt; CpeApp -&gt; a -&gt; [CoreTickish] -&gt; Int -&gt; UniqSM (a, CpeApp)
</span><a href="#local-6989586621681998163"><span class="hs-identifier hs-var">mb_saturate</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Id
</span><a href="#local-6989586621681998152"><span class="hs-identifier hs-var">hd</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998158"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998159"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998160"><span class="hs-identifier hs-var">unsat_ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998164"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1111"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1112"></span><span>          </span><span id="local-6989586621681998164"><span class="annot"><span class="annottext">depth :: Int
</span><a href="#local-6989586621681998164"><span class="hs-identifier hs-var hs-var">depth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; Int
</span><a href="#local-6989586621681998165"><span class="hs-identifier hs-var">val_args</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998148"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1113"></span><span>          </span><span id="local-6989586621681998162"><span class="annot"><span class="annottext">stricts :: [Demand]
</span><a href="#local-6989586621681998162"><span class="hs-identifier hs-var hs-var">stricts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Id -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998147"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1114"></span><span>                            </span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681998169"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998169"><span class="hs-identifier hs-var">demands</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1115"></span><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; Int -&gt; Ordering
forall a. [a] -&gt; Int -&gt; Ordering
</span><a href="GHC.Utils.Misc.html#listLengthCmp"><span class="hs-identifier hs-var">listLengthCmp</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998169"><span class="hs-identifier hs-var">demands</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998164"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998169"><span class="hs-identifier hs-var">demands</span></a></span><span>
</span><span id="line-1116"></span><span>                                    </span><span class="hs-comment">-- length demands &lt;= depth</span><span>
</span><span id="line-1117"></span><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1118"></span><span>                </span><span class="hs-comment">-- If depth &lt; length demands, then we have too few args to</span><span>
</span><span id="line-1119"></span><span>                </span><span class="hs-comment">-- satisfy strictness  info so we have to  ignore all the</span><span>
</span><span id="line-1120"></span><span>                </span><span class="hs-comment">-- strictness info, e.g. + (error &quot;urk&quot;)</span><span>
</span><span id="line-1121"></span><span>                </span><span class="hs-comment">-- Here, we can't evaluate the arg strictly, because this</span><span>
</span><span id="line-1122"></span><span>                </span><span class="hs-comment">-- partial application might be seq'd</span><span>
</span><span id="line-1123"></span><span>
</span><span id="line-1124"></span><span>        </span><span class="hs-comment">-- We inlined into something that's not a var and has no args.</span><span>
</span><span id="line-1125"></span><span>        </span><span class="hs-comment">-- Bounce it back up to cpeRhsE.</span><span>
</span><span id="line-1126"></span><span>    </span><span class="annot"><a href="#local-6989586621681998101"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span id="local-6989586621681998172"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998172"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998173"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998173"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998172"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998173"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-1127"></span><span>
</span><span id="line-1128"></span><span>    </span><span class="hs-comment">-- Here we get:</span><span>
</span><span id="line-1129"></span><span>    </span><span class="hs-comment">-- N-variable fun, better let-bind it</span><span>
</span><span id="line-1130"></span><span>    </span><span class="hs-comment">-- This case covers literals, apps, lams or let expressions applied to arguments.</span><span>
</span><span id="line-1131"></span><span>    </span><span class="hs-comment">-- Basically things we want to ANF before applying to arguments.</span><span>
</span><span id="line-1132"></span><span>    </span><span class="annot"><a href="#local-6989586621681998101"><span class="hs-identifier hs-var">cpe_app</span></a></span><span> </span><span id="local-6989586621681998174"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998174"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998175"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998175"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681998176"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998176"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-1133"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998177"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998177"><span class="hs-identifier hs-var">fun_floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998178"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998178"><span class="hs-identifier hs-var">fun'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Demand -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeArg"><span class="hs-identifier hs-var">cpeArg</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998174"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#evalDmd"><span class="hs-identifier hs-var">evalDmd</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998175"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-1134"></span><span>                          </span><span class="hs-comment">-- If evalDmd says that it's sure to be evaluated,</span><span>
</span><span id="line-1135"></span><span>                          </span><span class="hs-comment">-- we'll end up case-binding it</span><span>
</span><span id="line-1136"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998181"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998181"><span class="hs-identifier hs-var">app</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998182"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998182"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681998183"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998183"><span class="hs-identifier hs-var">unsat_ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeApp
-&gt; Floats
-&gt; [Demand]
-&gt; Maybe Int
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
</span><a href="#local-6989586621681998161"><span class="hs-identifier hs-var">rebuild_app</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998174"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998176"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998178"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998177"><span class="hs-identifier hs-var">fun_floats</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1137"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Maybe Id
-&gt; CpeApp
-&gt; Floats
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (Floats, CpeApp)
forall {a}.
Maybe Id
-&gt; CpeApp -&gt; a -&gt; [CoreTickish] -&gt; Int -&gt; UniqSM (a, CpeApp)
</span><a href="#local-6989586621681998163"><span class="hs-identifier hs-var">mb_saturate</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Id
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998181"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998182"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998183"><span class="hs-identifier hs-var">unsat_ticks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ArgInfo] -&gt; Int
</span><a href="#local-6989586621681998165"><span class="hs-identifier hs-var">val_args</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998176"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1138"></span><span>
</span><span id="line-1139"></span><span>    </span><span class="hs-comment">-- Count the number of value arguments *and* coercions (since we don't eliminate the later in STG)</span><span>
</span><span id="line-1140"></span><span>    </span><span class="annot"><a href="#local-6989586621681998165"><span class="hs-identifier hs-type">val_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-1141"></span><span>    </span><span id="local-6989586621681998165"><span class="annot"><span class="annottext">val_args :: [ArgInfo] -&gt; Int
</span><a href="#local-6989586621681998165"><span class="hs-identifier hs-var hs-var">val_args</span></a></span></span><span> </span><span id="local-6989586621681998184"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998184"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; Int -&gt; Int
forall {t}. Num t =&gt; [ArgInfo] -&gt; t -&gt; t
</span><a href="#local-6989586621681998185"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998184"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1142"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1143"></span><span>        </span><span id="local-6989586621681998185"><span class="annot"><span class="annottext">go :: [ArgInfo] -&gt; t -&gt; t
</span><a href="#local-6989586621681998185"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681998189"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681998189"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681998189"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1144"></span><span>        </span><span class="annot"><a href="#local-6989586621681998185"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998190"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621681998190"><span class="hs-identifier hs-var">info</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681998191"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998191"><span class="hs-identifier hs-var">infos</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998192"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681998192"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1145"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621681998190"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1146"></span><span>            </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeCast"><span class="hs-identifier hs-type">CpeCast</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; t -&gt; t
</span><a href="#local-6989586621681998185"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998191"><span class="hs-identifier hs-var">infos</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681998192"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1147"></span><span>            </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTick"><span class="hs-identifier hs-type">CpeTick</span></a></span><span> </span><span id="local-6989586621681998193"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998193"><span class="hs-identifier hs-var">tickish</span></a></span></span><span>
</span><span id="line-1148"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998193"><span class="hs-identifier hs-var">tickish</span></a></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; t -&gt; t
</span><a href="#local-6989586621681998185"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998191"><span class="hs-identifier hs-var">infos</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681998192"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1149"></span><span>              </span><span class="hs-comment">-- If we can't guarantee a tick will be floated out of the application</span><span>
</span><span id="line-1150"></span><span>              </span><span class="hs-comment">-- we can't guarantee the value args following it will be applied.</span><span>
</span><span id="line-1151"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681998192"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1152"></span><span>            </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span id="local-6989586621681998194"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998194"><span class="hs-identifier hs-var">e</span></a></span></span><span>                                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ArgInfo] -&gt; t -&gt; t
</span><a href="#local-6989586621681998185"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998191"><span class="hs-identifier hs-var">infos</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681998195"><span class="hs-identifier hs-var">n'</span></a></span><span>
</span><span id="line-1153"></span><span>              </span><span class="hs-keyword">where</span><span>
</span><span id="line-1154"></span><span>                </span><span class="hs-glyph">!</span><span id="local-6989586621681998195"><span class="annot"><span class="annottext">n' :: t
</span><a href="#local-6989586621681998195"><span class="hs-identifier hs-var hs-var">n'</span></a></span></span><span>
</span><span id="line-1155"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998194"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681998192"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1156"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681998192"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">t -&gt; t -&gt; t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#%2B/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">t
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1157"></span><span>
</span><span id="line-1158"></span><span>    </span><span class="hs-comment">-- Saturate if necessary</span><span>
</span><span id="line-1159"></span><span>    </span><span id="local-6989586621681998163"><span class="annot"><span class="annottext">mb_saturate :: Maybe Id
-&gt; CpeApp -&gt; a -&gt; [CoreTickish] -&gt; Int -&gt; UniqSM (a, CpeApp)
</span><a href="#local-6989586621681998163"><span class="hs-identifier hs-var hs-var">mb_saturate</span></a></span></span><span> </span><span id="local-6989586621681998206"><span class="annot"><span class="annottext">Maybe Id
</span><a href="#local-6989586621681998206"><span class="hs-identifier hs-var">head</span></a></span></span><span> </span><span id="local-6989586621681998207"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998207"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621681998208"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681998208"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621681998209"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998209"><span class="hs-identifier hs-var">unsat_ticks</span></a></span></span><span> </span><span id="local-6989586621681998210"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998210"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1160"></span><span>       </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Id
</span><a href="#local-6989586621681998206"><span class="hs-identifier hs-var">head</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1161"></span><span>         </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681998211"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998211"><span class="hs-identifier hs-var">fn_id</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681998212"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998212"><span class="hs-identifier hs-var">sat_app</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CpeApp -&gt; Int -&gt; [CoreTickish] -&gt; UniqSM CpeApp
</span><a href="GHC.CoreToStg.Prep.html#maybeSaturate"><span class="hs-identifier hs-var">maybeSaturate</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998211"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998207"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998210"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998209"><span class="hs-identifier hs-var">unsat_ticks</span></a></span><span>
</span><span id="line-1162"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(a, CpeApp) -&gt; UniqSM (a, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681998208"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998212"><span class="hs-identifier hs-var">sat_app</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1163"></span><span>         </span><span id="local-6989586621681998214"><span class="annot"><span class="annottext">Maybe Id
</span><a href="#local-6989586621681998214"><span class="hs-identifier hs-var">_other</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UniqSM ()
forall (m :: * -&gt; *). (HasCallStack, Applicative m) =&gt; Bool -&gt; m ()
</span><a href="GHC.Utils.Panic.Plain.html#massert"><span class="hs-identifier hs-var">massert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998209"><span class="hs-identifier hs-var">unsat_ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1164"></span><span>                          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(a, CpeApp) -&gt; UniqSM (a, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681998208"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998207"><span class="hs-identifier hs-var">app</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1165"></span><span>
</span><span id="line-1166"></span><span>    </span><span class="hs-comment">-- Deconstruct and rebuild the application, floating any non-atomic</span><span>
</span><span id="line-1167"></span><span>    </span><span class="hs-comment">-- arguments to the outside.  We collect the type of the expression,</span><span>
</span><span id="line-1168"></span><span>    </span><span class="hs-comment">-- the head of the application, and the number of actual value arguments,</span><span>
</span><span id="line-1169"></span><span>    </span><span class="hs-comment">-- all of which are used to possibly saturate this application if it</span><span>
</span><span id="line-1170"></span><span>    </span><span class="hs-comment">-- has a constructor or primop at the head.</span><span>
</span><span id="line-1171"></span><span>    </span><span class="annot"><a href="#local-6989586621681998161"><span class="hs-identifier hs-type">rebuild_app</span></a></span><span>
</span><span id="line-1172"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-1173"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span class="hs-special">]</span><span>                  </span><span class="hs-comment">-- The arguments (inner to outer)</span><span>
</span><span id="line-1174"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span>                     </span><span class="hs-comment">-- The function</span><span>
</span><span id="line-1175"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-1176"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1177"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-1178"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span>
</span><span id="line-1179"></span><span>                  </span><span class="hs-special">,</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-1180"></span><span>                  </span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Underscoped ticks. See Note [Ticks and mandatory eta expansion]</span><span>
</span><span id="line-1181"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-1182"></span><span>    </span><span id="local-6989586621681998161"><span class="annot"><span class="annottext">rebuild_app :: CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeApp
-&gt; Floats
-&gt; [Demand]
-&gt; Maybe Int
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
</span><a href="#local-6989586621681998161"><span class="hs-identifier hs-var hs-var">rebuild_app</span></a></span></span><span> </span><span id="local-6989586621681998217"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998217"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998218"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998218"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681998219"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998219"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621681998220"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998220"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621681998221"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998221"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621681998222"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621681998222"><span class="hs-identifier hs-var">req_depth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1183"></span><span>      </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeApp
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
</span><a href="#local-6989586621681998223"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998217"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998218"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998219"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998220"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998221"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Maybe.html#fromMaybe/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621681998222"><span class="hs-identifier hs-var">req_depth</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1184"></span><span>
</span><span id="line-1185"></span><span>    </span><span class="annot"><a href="#local-6989586621681998223"><span class="hs-identifier hs-type">rebuild_app'</span></a></span><span>
</span><span id="line-1186"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-1187"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The arguments (inner to outer)</span><span>
</span><span id="line-1188"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span>
</span><span id="line-1189"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-1190"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1191"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1192"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- Number of arguments required to satisfy minimal tick scopes.</span><span>
</span><span id="line-1193"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1194"></span><span>    </span><span id="local-6989586621681998223"><span class="annot"><span class="annottext">rebuild_app' :: CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeApp
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
</span><a href="#local-6989586621681998223"><span class="hs-identifier hs-var hs-var">rebuild_app'</span></a></span></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621681998225"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998225"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621681998226"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998226"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621681998227"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998227"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621681998228"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998228"><span class="hs-identifier hs-var">rt_ticks</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681998229"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998229"><span class="hs-identifier hs-var">_req_depth</span></a></span></span><span>
</span><span id="line-1195"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; ((CpeApp, Floats, [CoreTickish])
    -&gt; UniqSM (CpeApp, Floats, [CoreTickish]))
-&gt; (CpeApp, Floats, [CoreTickish])
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998227"><span class="hs-identifier hs-var">ss</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998227"><span class="hs-identifier hs-var">ss</span></a></span><span class="hs-special">)</span><span class="hs-comment">-- make sure we used all the strictness info</span><span>
</span><span id="line-1196"></span><span>        </span><span class="annot"><span class="annottext">(CpeApp, Floats, [CoreTickish])
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998225"><span class="hs-identifier hs-var">app</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998226"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998228"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1197"></span><span>
</span><span id="line-1198"></span><span>    </span><span class="annot"><a href="#local-6989586621681998223"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span id="local-6989586621681998231"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998231"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998232"><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621681998232"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681998233"><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998233"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998234"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998234"><span class="hs-identifier hs-var">fun'</span></a></span></span><span> </span><span id="local-6989586621681998235"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998235"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621681998236"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998236"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621681998237"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998237"><span class="hs-identifier hs-var">rt_ticks</span></a></span></span><span> </span><span id="local-6989586621681998238"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998238"><span class="hs-identifier hs-var">req_depth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621681998232"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1199"></span><span>      </span><span class="hs-comment">-- See Note [Ticks and mandatory eta expansion]</span><span>
</span><span id="line-1200"></span><span>      </span><span class="annot"><span class="annottext">ArgInfo
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-1201"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998237"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1202"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998238"><span class="hs-identifier hs-var">req_depth</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1203"></span><span>        </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1204"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681998239"><span class="annot"><span class="annottext">tick_fun :: CpeApp
</span><a href="#local-6989586621681998239"><span class="hs-identifier hs-var hs-var">tick_fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; CpeApp -&gt; CpeApp)
-&gt; CpeApp -&gt; [CoreTickish] -&gt; CpeApp
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998234"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998237"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span>
</span><span id="line-1205"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeApp
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
</span><a href="#local-6989586621681998223"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998231"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgInfo
</span><a href="#local-6989586621681998232"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ArgInfo -&gt; [ArgInfo] -&gt; [ArgInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998233"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998239"><span class="hs-identifier hs-var">tick_fun</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998235"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998236"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998237"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998238"><span class="hs-identifier hs-var">req_depth</span></a></span><span>
</span><span id="line-1206"></span><span>
</span><span id="line-1207"></span><span>      </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621681998241"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998241"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1208"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeApp
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
</span><a href="#local-6989586621681998223"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998231"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998233"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; CpeApp -&gt; CpeApp
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998234"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CpeApp
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998242"><span class="hs-identifier hs-var">arg_ty'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998235"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998236"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998237"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998238"><span class="hs-identifier hs-var">req_depth</span></a></span><span>
</span><span id="line-1209"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1210"></span><span>          </span><span id="local-6989586621681998242"><span class="annot"><span class="annottext">arg_ty' :: Type
</span><a href="#local-6989586621681998242"><span class="hs-identifier hs-var hs-var">arg_ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Type -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-var">cpSubstTy</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998231"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998241"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-1211"></span><span>
</span><span id="line-1212"></span><span>      </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621681998243"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998243"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1213"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeApp
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
</span><a href="#local-6989586621681998223"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998231"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998233"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; CpeApp -&gt; CpeApp
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998234"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; CpeApp
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998244"><span class="hs-identifier hs-var">co'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998235"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [Demand] -&gt; [Demand]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#drop/GHC.List.html#drop"><span class="hs-identifier hs-var">drop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998236"><span class="hs-identifier hs-var">ss</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998237"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998238"><span class="hs-identifier hs-var">req_depth</span></a></span><span>
</span><span id="line-1214"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1215"></span><span>            </span><span id="local-6989586621681998244"><span class="annot"><span class="annottext">co' :: Coercion
</span><a href="#local-6989586621681998244"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.CoreToStg.Prep.html#cpSubstCo"><span class="hs-identifier hs-var">cpSubstCo</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998231"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998243"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1216"></span><span>
</span><span id="line-1217"></span><span>      </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span id="local-6989586621681998246"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998246"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1218"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998247"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681998247"><span class="hs-identifier hs-var">ss1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998248"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998248"><span class="hs-identifier hs-var">ss_rest</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [lazyId magic] in GHC.Types.Id.Make</span><span>
</span><span id="line-1219"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998236"><span class="hs-identifier hs-var">ss</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998246"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1220"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand
</span><span class="hs-identifier">_</span></span><span>   </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681998250"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998250"><span class="hs-identifier hs-var">ss_rest</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998250"><span class="hs-identifier hs-var">ss_rest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1221"></span><span>                   </span><span class="hs-special">(</span><span id="local-6989586621681998251"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681998251"><span class="hs-identifier hs-var">ss1</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681998252"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998252"><span class="hs-identifier hs-var">ss_rest</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681998251"><span class="hs-identifier hs-var">ss1</span></a></span><span class="hs-special">,</span><span>    </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998252"><span class="hs-identifier hs-var">ss_rest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1222"></span><span>                   </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1223"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681998253"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998253"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998254"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998254"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Demand -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeArg"><span class="hs-identifier hs-var">cpeArg</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998096"><span class="hs-identifier hs-var">top_env</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681998247"><span class="hs-identifier hs-var">ss1</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998246"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-1224"></span><span>        </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeApp
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
</span><a href="#local-6989586621681998223"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998231"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998233"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; CpeApp -&gt; CpeApp
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998234"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998254"><span class="hs-identifier hs-var">arg'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998253"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="annot"><span class="annottext">Floats -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#appendFloats"><span class="hs-operator hs-var">`appendFloats`</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998235"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998248"><span class="hs-identifier hs-var">ss_rest</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998237"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998238"><span class="hs-identifier hs-var">req_depth</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#-/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-1225"></span><span>
</span><span id="line-1226"></span><span>      </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeCast"><span class="hs-identifier hs-type">CpeCast</span></a></span><span> </span><span id="local-6989586621681998255"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998255"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1227"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeApp
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
</span><a href="#local-6989586621681998223"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998231"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998233"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; Coercion -&gt; CpeApp
forall b. Expr b -&gt; Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998234"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998256"><span class="hs-identifier hs-var">co'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998235"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998236"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998237"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998238"><span class="hs-identifier hs-var">req_depth</span></a></span><span>
</span><span id="line-1228"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1229"></span><span>           </span><span id="local-6989586621681998256"><span class="annot"><span class="annottext">co' :: Coercion
</span><a href="#local-6989586621681998256"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.CoreToStg.Prep.html#cpSubstCo"><span class="hs-identifier hs-var">cpSubstCo</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998231"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998255"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1230"></span><span>      </span><span class="hs-comment">-- See Note [Ticks and mandatory eta expansion]</span><span>
</span><span id="line-1231"></span><span>      </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTick"><span class="hs-identifier hs-type">CpeTick</span></a></span><span> </span><span id="local-6989586621681998257"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998257"><span class="hs-identifier hs-var">tickish</span></a></span></span><span>
</span><span id="line-1232"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; TickishPlacement
forall (pass :: TickishPass). GenTickish pass -&gt; TickishPlacement
</span><a href="GHC.Types.Tickish.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998257"><span class="hs-identifier hs-var">tickish</span></a></span><span> </span><span class="annot"><span class="annottext">TickishPlacement -&gt; TickishPlacement -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TickishPlacement
</span><a href="GHC.Types.Tickish.html#PlaceRuntime"><span class="hs-identifier hs-var">PlaceRuntime</span></a></span><span>
</span><span id="line-1233"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998238"><span class="hs-identifier hs-var">req_depth</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1234"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#isProfTick"><span class="hs-identifier hs-var">isProfTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998257"><span class="hs-identifier hs-var">tickish</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM (CpeApp, Floats, [CoreTickish])
 -&gt; UniqSM (CpeApp, Floats, [CoreTickish]))
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1235"></span><span>           </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeApp
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
</span><a href="#local-6989586621681998223"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998231"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998233"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998234"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998235"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998236"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998257"><span class="hs-identifier hs-var">tickish</span></a></span><span class="annot"><span class="annottext">CoreTickish -&gt; [CoreTickish] -&gt; [CoreTickish]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998237"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998238"><span class="hs-identifier hs-var">req_depth</span></a></span><span>
</span><span id="line-1236"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1237"></span><span>        </span><span class="hs-comment">-- See [Floating Ticks in CorePrep]</span><span>
</span><span id="line-1238"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
-&gt; [ArgInfo]
-&gt; CpeApp
-&gt; Floats
-&gt; [Demand]
-&gt; [CoreTickish]
-&gt; Int
-&gt; UniqSM (CpeApp, Floats, [CoreTickish])
</span><a href="#local-6989586621681998223"><span class="hs-identifier hs-var">rebuild_app'</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998231"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[ArgInfo]
</span><a href="#local-6989586621681998233"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998234"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#addFloat"><span class="hs-identifier hs-var">addFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998235"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-var">FloatTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998257"><span class="hs-identifier hs-var">tickish</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681998236"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998237"><span class="hs-identifier hs-var">rt_ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998238"><span class="hs-identifier hs-var">req_depth</span></a></span><span>
</span><span id="line-1239"></span><span>
</span><span id="line-1240"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-type">isLazyExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1241"></span><span class="hs-comment">-- See Note [lazyId magic] in GHC.Types.Id.Make</span><span>
</span><span id="line-1242"></span><span id="isLazyExpr"><span class="annot"><span class="annottext">isLazyExpr :: CpeApp -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var hs-var">isLazyExpr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681998262"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998262"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998262"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1243"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681998263"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998263"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998263"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1244"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681998264"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998264"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-operator hs-type">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-operator hs-type">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998264"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#lazyIdKey"><span class="hs-identifier hs-var">lazyIdKey</span></a></span><span>
</span><span id="line-1245"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><span class="hs-identifier">_</span></span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1246"></span><span>
</span><span id="line-1247"></span><span class="hs-comment">{- Note [runRW magic]
~~~~~~~~~~~~~~~~~~~~~
Some definitions, for instance @runST@, must have careful control over float out
of the bindings in their body. Consider this use of @runST@,

    f x = runST ( \ s -&gt; let (a, s')  = newArray# 100 [] s
                             (_, s'') = fill_in_array_or_something a x s'
                         in freezeArray# a s'' )

If we inline @runST@, we'll get:

    f x = let (a, s')  = newArray# 100 [] realWorld#{-NB-}
              (_, s'') = fill_in_array_or_something a x s'
          in freezeArray# a s''

And now if we allow the @newArray#@ binding to float out to become a CAF,
we end up with a result that is totally and utterly wrong:

    f = let (a, s')  = newArray# 100 [] realWorld#{-NB-} -- YIKES!!!
        in \ x -&gt;
            let (_, s'') = fill_in_array_or_something a x s'
            in freezeArray# a s''

All calls to @f@ will share a {\em single} array! Clearly this is nonsense and
must be prevented.

This is what @runRW#@ gives us: by being inlined extremely late in the
optimization (right before lowering to STG, in CorePrep), we can ensure that
no further floating will occur. This allows us to safely inline things like
@runST@, which are otherwise needlessly expensive (see #10678 and #5916).

'runRW' has a variety of quirks:

 * 'runRW' is known-key with a NOINLINE definition in
   GHC.Magic. This definition is used in cases where runRW is curried.

 * In addition to its normal Haskell definition in GHC.Magic, we give it
   a special late inlining here in CorePrep and GHC.StgToByteCode, avoiding
   the incorrect sharing due to float-out noted above.

 * It is levity-polymorphic:

    runRW# :: forall (r1 :: RuntimeRep). (o :: TYPE r)
           =&gt; (State# RealWorld -&gt; (# State# RealWorld, o #))
           -&gt; (# State# RealWorld, o #)

 * It has some special simplification logic to allow unboxing of results when
   runRW# appears in a strict context. See Note [Simplification of runRW#]
   below.

 * Since its body is inlined, we allow runRW#'s argument to contain jumps to
   join points. That is, the following is allowed:

    join j x = ...
    in runRW# @_ @_ (\s -&gt; ... jump j 42 ...)

   The Core Linter knows about this. See Note [Linting of runRW#] in
   GHC.Core.Lint for details.

   The occurrence analyser and SetLevels also know about this, as described in
   Note [Simplification of runRW#].

Other relevant Notes:

 * Note [Simplification of runRW#] below, describing a transformation of runRW
   applications in strict contexts performed by the simplifier.
 * Note [Linting of runRW#] in GHC.Core.Lint
 * Note [runRW arg] below, describing a non-obvious case where the
   late-inlining could go wrong.


 Note [runRW arg]
~~~~~~~~~~~~~~~~~~~
Consider the Core program (from #11291),

   runRW# (case bot of {})

The late inlining logic in cpe_app would transform this into:

   (case bot of {}) realWorld#

Which would rise to a panic in CoreToStg.myCollectArgs, which expects only
variables in function position.

However, as runRW#'s strictness signature captures the fact that it will call
its argument this can't happen: the simplifier will transform the bottoming
application into simply (case bot of {}).

Note that this reasoning does *not* apply to non-bottoming continuations like:

    hello :: Bool -&gt; Int
    hello n =
      runRW# (
          case n of
            True -&gt; \s -&gt; 23
            _    -&gt; \s -&gt; 10)

Why? The difference is that (case bot of {}) is considered by okCpeArg to be
trivial, consequently cpeArg (which the catch-all case of cpe_app calls on both
the function and the arguments) will forgo binding it to a variable. By
contrast, in the non-bottoming case of `hello` above  the function will be
deemed non-trivial and consequently will be case-bound.


Note [Simplification of runRW#]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the program,

    case runRW# (\s -&gt; I# 42#) of
      I# n# -&gt; f n#

There is no reason why we should allocate an I# constructor given that we
immediately destructure it.

To avoid this the simplifier has a special transformation rule, specific to
runRW#, that pushes a strict context into runRW#'s continuation.  See the
`runRW#` guard in `GHC.Core.Opt.Simplify.rebuildCall`.  That is, it transforms

    K[ runRW# @r @ty cont ]
              ~&gt;
    runRW# @r @ty (\s -&gt; K[cont s])

This has a few interesting implications. Consider, for instance, this program:

    join j = ...
    in case runRW# @r @ty cont of
         result -&gt; jump j result

Performing the transform described above would result in:

    join j x = ...
    in runRW# @r @ty (\s -&gt;
         case cont of in
           result -&gt; jump j result
       )

If runRW# were a &quot;normal&quot; function this call to join point j would not be
allowed in its continuation argument. However, since runRW# is inlined (as
described in Note [runRW magic] above), such join point occurrences are
completely fine. Both occurrence analysis (see the runRW guard in occAnalApp)
and Core Lint (see the App case of lintCoreExpr) have special treatment for
runRW# applications. See Note [Linting of runRW#] for details on the latter.

Moreover, it's helpful to ensure that runRW's continuation isn't floated out
For instance, if we have

    runRW# (\s -&gt; do_something)

where do_something contains only top-level free variables, we may be tempted to
float the argument to the top-level. However, we must resist this urge as since
doing so would then require that runRW# produce an allocation and call, e.g.:

    let lvl = \s -&gt; do_somethign
    in
    ....(runRW# lvl)....

whereas without floating the inlining of the definition of runRW would result
in straight-line code. Consequently, GHC.Core.Opt.SetLevels.lvlApp has special
treatment for runRW# applications, ensure the arguments are not floated as
MFEs.

Now that we float evaluation context into runRW#, we also have to give runRW# a
special higher-order CPR transformer lest we risk #19822. E.g.,

  case runRW# (\s -&gt; doThings) of x -&gt; Data.Text.Text x something something'
      ~&gt;
  runRW# (\s -&gt; case doThings s of x -&gt; Data.Text.Text x something something')

The former had the CPR property, and so should the latter.

Other considered designs
------------------------

One design that was rejected was to *require* that runRW#'s continuation be
headed by a lambda. However, this proved to be quite fragile. For instance,
SetLevels is very eager to float bottoming expressions. For instance given
something of the form,

    runRW# @r @ty (\s -&gt; case expr of x -&gt; undefined)

SetLevels will see that the body the lambda is bottoming and will consequently
float it to the top-level (assuming expr has no free coercion variables which
prevent this). We therefore end up with

    runRW# @r @ty (\s -&gt; lvl s)

Which the simplifier will beta reduce, leaving us with

    runRW# @r @ty lvl

Breaking our desired invariant. Ultimately we decided to simply accept that
the continuation may not be a manifest lambda.


-- ---------------------------------------------------------------------------
--      CpeArg: produces a result satisfying CpeArg
-- ---------------------------------------------------------------------------

Note [ANF-ising literal string arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Consider a program like,

    data Foo = Foo Addr#

    foo = Foo &quot;turtle&quot;#

When we go to ANFise this we might think that we want to float the string
literal like we do any other non-trivial argument. This would look like,

    foo = u\ [] case &quot;turtle&quot;# of s { __DEFAULT__ -&gt; Foo s }

However, this 1) isn't necessary since strings are in a sense &quot;trivial&quot;; and 2)
wreaks havoc on the CAF annotations that we produce here since we the result
above is caffy since it is updateable. Ideally at some point in the future we
would like to just float the literal to the top level as suggested in #11312,

    s = &quot;turtle&quot;#
    foo = Foo s

However, until then we simply add a special case excluding literals from the
floating done by cpeArg.
-}</span><span>
</span><span id="line-1470"></span><span>
</span><span id="line-1471"></span><span class="annot"><span class="hs-comment">-- | Is an argument okay to CPE?</span></span><span>
</span><span id="line-1472"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#okCpeArg"><span class="hs-identifier hs-type">okCpeArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1473"></span><span class="hs-comment">-- Don't float literals. See Note [ANF-ising literal string arguments].</span><span>
</span><span id="line-1474"></span><span id="okCpeArg"><span class="annot"><span class="annottext">okCpeArg :: CpeApp -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#okCpeArg"><span class="hs-identifier hs-var hs-var">okCpeArg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1475"></span><span class="hs-comment">-- Do not eta expand a trivial argument</span><span>
</span><span id="line-1476"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#okCpeArg"><span class="hs-identifier hs-var">okCpeArg</span></a></span><span> </span><span id="local-6989586621681998266"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998266"><span class="hs-identifier hs-var">expr</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998266"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1477"></span><span>
</span><span id="line-1478"></span><span class="hs-comment">-- This is where we arrange that a non-trivial argument is let-bound</span><span>
</span><span id="line-1479"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeArg"><span class="hs-identifier hs-type">cpeArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-1480"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeArg"><span class="hs-identifier hs-type">CpeArg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1481"></span><span id="cpeArg"><span class="annot"><span class="annottext">cpeArg :: CorePrepEnv -&gt; Demand -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeArg"><span class="hs-identifier hs-var hs-var">cpeArg</span></a></span></span><span> </span><span id="local-6989586621681998267"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998267"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998268"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681998268"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span id="local-6989586621681998269"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998269"><span class="hs-identifier hs-var">arg</span></a></span></span><span>
</span><span id="line-1482"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998270"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998270"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998271"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998271"><span class="hs-identifier hs-var">arg1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998267"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998269"><span class="hs-identifier hs-var">arg</span></a></span><span>     </span><span class="hs-comment">-- arg1 can be a lambda</span><span>
</span><span id="line-1483"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681998272"><span class="annot"><span class="annottext">arg_ty :: Type
</span><a href="#local-6989586621681998272"><span class="hs-identifier hs-var hs-var">arg_ty</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CpeApp -&gt; Type
CpeApp -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998271"><span class="hs-identifier hs-var">arg1</span></a></span><span>
</span><span id="line-1484"></span><span>             </span><span id="local-6989586621681998273"><span class="annot"><span class="annottext">is_unlifted :: Bool
</span><a href="#local-6989586621681998273"><span class="hs-identifier hs-var hs-var">is_unlifted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Bool
Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998272"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-1485"></span><span>             </span><span id="local-6989586621681998274"><span class="annot"><span class="annottext">want_float :: Floats -&gt; CpeApp -&gt; Bool
</span><a href="#local-6989586621681998274"><span class="hs-identifier hs-var hs-var">want_float</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecFlag -&gt; Demand -&gt; Bool -&gt; Floats -&gt; CpeApp -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#wantFloatNested"><span class="hs-identifier hs-var">wantFloatNested</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681998268"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998273"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span>
</span><span id="line-1486"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998275"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998275"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998276"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998276"><span class="hs-identifier hs-var">arg2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; CpeApp -&gt; Bool
</span><a href="#local-6989586621681998274"><span class="hs-identifier hs-var">want_float</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998270"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998271"><span class="hs-identifier hs-var">arg1</span></a></span><span>
</span><span id="line-1487"></span><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998270"><span class="hs-identifier hs-var">floats1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998271"><span class="hs-identifier hs-var">arg1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1488"></span><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; CpeApp -&gt; UniqSM (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#dontFloat"><span class="hs-identifier hs-var">dontFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998270"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998271"><span class="hs-identifier hs-var">arg1</span></a></span><span>
</span><span id="line-1489"></span><span>                </span><span class="hs-comment">-- Else case: arg1 might have lambdas, and we can't</span><span>
</span><span id="line-1490"></span><span>                </span><span class="hs-comment">--            put them inside a wrapBinds</span><span>
</span><span id="line-1491"></span><span>
</span><span id="line-1492"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#okCpeArg"><span class="hs-identifier hs-var">okCpeArg</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998276"><span class="hs-identifier hs-var">arg2</span></a></span><span>
</span><span id="line-1493"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681998277"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998277"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; UniqSM Id
</span><a href="GHC.CoreToStg.Prep.html#newVar"><span class="hs-identifier hs-var">newVar</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998272"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-1494"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681998278"><span class="annot"><span class="annottext">arg3 :: CpeApp
</span><a href="#local-6989586621681998278"><span class="hs-identifier hs-var hs-var">arg3</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; Int
</span><a href="GHC.Core.Opt.Arity.html#exprArity"><span class="hs-identifier hs-var">exprArity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998276"><span class="hs-identifier hs-var">arg2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998276"><span class="hs-identifier hs-var">arg2</span></a></span><span>
</span><span id="line-1495"></span><span>                       </span><span id="local-6989586621681998279"><span class="annot"><span class="annottext">arg_float :: FloatingBind
</span><a href="#local-6989586621681998279"><span class="hs-identifier hs-var hs-var">arg_float</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Demand -&gt; Bool -&gt; Id -&gt; CpeApp -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#mkFloat"><span class="hs-identifier hs-var">mkFloat</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998267"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681998268"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998273"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998277"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998278"><span class="hs-identifier hs-var">arg3</span></a></span><span>
</span><span id="line-1496"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats -&gt; FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#addFloat"><span class="hs-identifier hs-var">addFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998275"><span class="hs-identifier hs-var">floats2</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998279"><span class="hs-identifier hs-var">arg_float</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CpeApp
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998277"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1497"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; UniqSM (Floats, CpeApp)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998275"><span class="hs-identifier hs-var">floats2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998276"><span class="hs-identifier hs-var">arg2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1498"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-1499"></span><span>
</span><span id="line-1500"></span><span class="hs-comment">{-
Note [Floating unlifted arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider    C (let v* = expensive in v)

where the &quot;*&quot; indicates &quot;will be demanded&quot;.  Usually v will have been
inlined by now, but let's suppose it hasn't (see #2756).  Then we
do *not* want to get

     let v* = expensive in C v

because that has different strictness.  Hence the use of 'allLazy'.
(NB: the let v* turns into a FloatCase, in mkLocalNonRec.)


------------------------------------------------------------------------------
-- Building the saturated syntax
-- ---------------------------------------------------------------------------

Note [Eta expansion of hasNoBinding things in CorePrep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
maybeSaturate deals with eta expanding to saturate things that can't deal with
unsaturated applications (identified by 'hasNoBinding', currently
foreign calls, unboxed tuple/sum constructors, and representation-polymorphic
primitives such as 'coerce' and 'unsafeCoerce#').

Historical Note: Note that eta expansion in CorePrep used to be very fragile
due to the &quot;prediction&quot; of CAFfyness that we used to make during tidying.
We previously saturated primop
applications here as well but due to this fragility (see #16846) we now deal
with this another way, as described in Note [Primop wrappers] in GHC.Builtin.PrimOps.
-}</span><span>
</span><span id="line-1532"></span><span>
</span><span id="line-1533"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#maybeSaturate"><span class="hs-identifier hs-type">maybeSaturate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span>
</span><span id="line-1534"></span><span id="maybeSaturate"><span class="annot"><span class="annottext">maybeSaturate :: Id -&gt; CpeApp -&gt; Int -&gt; [CoreTickish] -&gt; UniqSM CpeApp
</span><a href="GHC.CoreToStg.Prep.html#maybeSaturate"><span class="hs-identifier hs-var hs-var">maybeSaturate</span></a></span></span><span> </span><span id="local-6989586621681998281"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998281"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681998282"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998282"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621681998283"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998283"><span class="hs-identifier hs-var">n_args</span></a></span></span><span> </span><span id="local-6989586621681998284"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998284"><span class="hs-identifier hs-var">unsat_ticks</span></a></span></span><span>
</span><span id="line-1535"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#hasNoBinding"><span class="hs-identifier hs-var">hasNoBinding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998281"><span class="hs-identifier hs-var">fn</span></a></span><span>        </span><span class="hs-comment">-- There's no binding</span><span>
</span><span id="line-1536"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; UniqSM CpeApp
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(CpeApp -&gt; UniqSM CpeApp) -&gt; CpeApp -&gt; UniqSM CpeApp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(CpeApp -&gt; CpeApp) -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.Core.html#wrapLamBody"><span class="hs-identifier hs-var">wrapLamBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681998286"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998286"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; CpeApp -&gt; CpeApp)
-&gt; CpeApp -&gt; [CoreTickish] -&gt; CpeApp
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998286"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998284"><span class="hs-identifier hs-var">unsat_ticks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998287"><span class="hs-identifier hs-var">sat_expr</span></a></span><span>
</span><span id="line-1537"></span><span>
</span><span id="line-1538"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998288"><span class="hs-identifier hs-var">mark_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-comment">-- A call-by-value function. See Note [CBV Function Ids]</span><span>
</span><span id="line-1539"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998289"><span class="hs-identifier hs-var">applied_marks</span></a></span><span>
</span><span id="line-1540"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; UniqSM CpeApp -&gt; UniqSM CpeApp
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span>
</span><span id="line-1541"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998281"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Do not eta-expand join points]</span><span>
</span><span id="line-1542"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998281"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;expr:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998282"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;n_args:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998283"><span class="hs-identifier hs-var">n_args</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-1543"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;marks:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [CbvMark] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Maybe [CbvMark]
</span><a href="GHC.Types.Id.html#idCbvMarks_maybe"><span class="hs-identifier hs-var">idCbvMarks_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998281"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-1544"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;join_arity&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Maybe Int
</span><a href="GHC.Types.Id.html#isJoinId_maybe"><span class="hs-identifier hs-var">isJoinId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998281"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-1545"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fn_arity&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998292"><span class="hs-identifier hs-var">fn_arity</span></a></span><span>
</span><span id="line-1546"></span><span>       </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM CpeApp -&gt; UniqSM CpeApp) -&gt; UniqSM CpeApp -&gt; UniqSM CpeApp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1547"></span><span>    </span><span class="hs-comment">-- pprTrace &quot;maybeSat&quot;</span><span>
</span><span id="line-1548"></span><span>    </span><span class="hs-comment">--   ( ppr fn $$ text &quot;expr:&quot; &lt;+&gt; ppr expr $$ text &quot;n_args:&quot; &lt;+&gt; ppr n_args $$</span><span>
</span><span id="line-1549"></span><span>    </span><span class="hs-comment">--       text &quot;marks:&quot; &lt;+&gt; ppr (idCbvMarks_maybe fn) $$</span><span>
</span><span id="line-1550"></span><span>    </span><span class="hs-comment">--       text &quot;join_arity&quot; &lt;+&gt; ppr (isJoinId_maybe fn) $$</span><span>
</span><span id="line-1551"></span><span>    </span><span class="hs-comment">--       text &quot;fn_arity&quot; &lt;+&gt; ppr fn_arity $$</span><span>
</span><span id="line-1552"></span><span>    </span><span class="hs-comment">--       text &quot;excess_arity&quot; &lt;+&gt; ppr excess_arity $$</span><span>
</span><span id="line-1553"></span><span>    </span><span class="hs-comment">--       text &quot;mark_arity&quot; &lt;+&gt; ppr mark_arity</span><span>
</span><span id="line-1554"></span><span>    </span><span class="hs-comment">--    ) $</span><span>
</span><span id="line-1555"></span><span>    </span><span class="annot"><span class="annottext">CpeApp -&gt; UniqSM CpeApp
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998287"><span class="hs-identifier hs-var">sat_expr</span></a></span><span>
</span><span id="line-1556"></span><span>
</span><span id="line-1557"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1558"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UniqSM CpeApp -&gt; UniqSM CpeApp
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998284"><span class="hs-identifier hs-var">unsat_ticks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM CpeApp -&gt; UniqSM CpeApp) -&gt; UniqSM CpeApp -&gt; UniqSM CpeApp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1559"></span><span>    </span><span class="annot"><span class="annottext">CpeApp -&gt; UniqSM CpeApp
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998282"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1560"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1561"></span><span>    </span><span id="local-6989586621681998288"><span class="annot"><span class="annottext">mark_arity :: Int
</span><a href="#local-6989586621681998288"><span class="hs-identifier hs-var hs-var">mark_arity</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Int
</span><a href="GHC.Types.Id.html#idCbvMarkArity"><span class="hs-identifier hs-var">idCbvMarkArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998281"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1562"></span><span>    </span><span id="local-6989586621681998292"><span class="annot"><span class="annottext">fn_arity :: Int
</span><a href="#local-6989586621681998292"><span class="hs-identifier hs-var hs-var">fn_arity</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998281"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1563"></span><span>    </span><span id="local-6989586621681998294"><span class="annot"><span class="annottext">excess_arity :: Int
</span><a href="#local-6989586621681998294"><span class="hs-identifier hs-var hs-var">excess_arity</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998292"><span class="hs-identifier hs-var">fn_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998288"><span class="hs-identifier hs-var">mark_arity</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#-/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998283"><span class="hs-identifier hs-var">n_args</span></a></span><span>
</span><span id="line-1564"></span><span>    </span><span id="local-6989586621681998287"><span class="annot"><span class="annottext">sat_expr :: CpeApp
</span><a href="#local-6989586621681998287"><span class="hs-identifier hs-var hs-var">sat_expr</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998294"><span class="hs-identifier hs-var">excess_arity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998282"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1565"></span><span>    </span><span id="local-6989586621681998289"><span class="annot"><span class="annottext">applied_marks :: Bool
</span><a href="#local-6989586621681998289"><span class="hs-identifier hs-var hs-var">applied_marks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998283"><span class="hs-identifier hs-var">n_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CbvMark] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">([CbvMark] -&gt; Int)
-&gt; (Maybe [CbvMark] -&gt; [CbvMark]) -&gt; Maybe [CbvMark] -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(CbvMark -&gt; Bool) -&gt; [CbvMark] -&gt; [CbvMark]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#dropWhile/GHC.List.html#dropWhile"><span class="hs-identifier hs-var">dropWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (CbvMark -&gt; Bool) -&gt; CbvMark -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CbvMark -&gt; Bool
</span><a href="GHC.Types.Basic.html#isMarkedCbv"><span class="hs-identifier hs-var">isMarkedCbv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([CbvMark] -&gt; [CbvMark])
-&gt; (Maybe [CbvMark] -&gt; [CbvMark]) -&gt; Maybe [CbvMark] -&gt; [CbvMark]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[CbvMark] -&gt; [CbvMark]
forall a. [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#reverse/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">([CbvMark] -&gt; [CbvMark])
-&gt; (Maybe [CbvMark] -&gt; [CbvMark]) -&gt; Maybe [CbvMark] -&gt; [CbvMark]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe [CbvMark] -&gt; [CbvMark]
forall a. HasCallStack =&gt; String -&gt; Maybe a -&gt; a
</span><a href="GHC.Data.Maybe.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;maybeSaturate&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe [CbvMark] -&gt; Int) -&gt; Maybe [CbvMark] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Maybe [CbvMark]
</span><a href="GHC.Types.Id.html#idCbvMarks_maybe"><span class="hs-identifier hs-var">idCbvMarks_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998281"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1566"></span><span>    </span><span class="hs-comment">-- For join points we never eta-expand (See Note [Do not eta-expand join points])</span><span>
</span><span id="line-1567"></span><span>    </span><span class="hs-comment">-- so we assert all arguments that need to be passed cbv are visible so that the backend can evalaute them if required..</span><span>
</span><span id="line-1568"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Simple GHC.Core operations
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1575"></span><span>
</span><span id="line-1576"></span><span class="hs-comment">{-
-- -----------------------------------------------------------------------------
--      Eta reduction
-- -----------------------------------------------------------------------------

Note [Eta expansion]
~~~~~~~~~~~~~~~~~~~~~
Eta expand to match the arity claimed by the binder Remember,
CorePrep must not change arity

Eta expansion might not have happened already, because it is done by
the simplifier only when there at least one lambda already.

NB1:we could refrain when the RHS is trivial (which can happen
    for exported things).  This would reduce the amount of code
    generated (a little) and make things a little worse for
    code compiled without -O.  The case in point is data constructor
    wrappers.

NB2: we have to be careful that the result of etaExpand doesn't
   invalidate any of the assumptions that CorePrep is attempting
   to establish.  One possible cause is eta expanding inside of
   an SCC note - we're now careful in etaExpand to make sure the
   SCC is pushed inside any new lambdas that are generated.

Note [Eta expansion and the CorePrep invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It turns out to be much much easier to do eta expansion
*after* the main CorePrep stuff.  But that places constraints
on the eta expander: given a CpeRhs, it must return a CpeRhs.

For example here is what we do not want:
                f = /\a -&gt; g (h 3)      -- h has arity 2
After ANFing we get
                f = /\a -&gt; let s = h 3 in g s
and now we do NOT want eta expansion to give
                f = /\a -&gt; \ y -&gt; (let s = h 3 in g s) y

Instead GHC.Core.Opt.Arity.etaExpand gives
                f = /\a -&gt; \y -&gt; let s = h 3 in g s y

-}</span><span>
</span><span id="line-1618"></span><span>
</span><span id="line-1619"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-type">cpeEtaExpand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span>
</span><span id="line-1620"></span><span id="cpeEtaExpand"><span class="annot"><span class="annottext">cpeEtaExpand :: Int -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpeEtaExpand"><span class="hs-identifier hs-var hs-var">cpeEtaExpand</span></a></span></span><span> </span><span id="local-6989586621681998301"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998301"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span id="local-6989586621681998302"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998302"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-1621"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998301"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998302"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1622"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Opt.Arity.html#etaExpand"><span class="hs-identifier hs-var">etaExpand</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998301"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998302"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1623"></span><span>
</span><span id="line-1624"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Floats
*                                                                      *
************************************************************************

Note [Pin demand info on floats]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We pin demand info on floated lets, so that we can see the one-shot thunks.

Note [Speculative evaluation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Since call-by-value is much cheaper than call-by-need, we case-bind arguments
that are either

  1. Strictly evaluated anyway, according to the DmdSig of the callee, or
  2. ok-for-spec, according to 'exprOkForSpeculation'

While (1) is a no-brainer and always beneficial, (2) is a bit
more subtle, as the careful haddock for 'exprOkForSpeculation'
points out. Still, by case-binding the argument we don't need
to allocate a thunk for it, whose closure must be retained as
long as the callee might evaluate it. And if it is evaluated on
most code paths anyway, we get to turn the unknown eval in the
callee into a known call at the call site.

However, we must be very careful not to speculate recursive calls!
Doing so might well change termination behavior.

That comes up in practice for DFuns, which are considered ok-for-spec,
because they always immediately return a constructor.
Not so if you speculate the recursive call, as #20836 shows:

  class Foo m =&gt; Foo m where
    runFoo :: m a -&gt; m a
  newtype Trans m a = Trans { runTrans :: m a }
  instance Monad m =&gt; Foo (Trans m) where
    runFoo = id

(NB: class Foo m =&gt; Foo m` looks weird and needs -XUndecidableSuperClasses. The
example in #20836 is more compelling, but boils down to the same thing.)
This program compiles to the following DFun for the `Trans` instance:

  Rec {
  $fFooTrans
    = \ @m $dMonad -&gt; C:Foo ($fFooTrans $dMonad) (\ @a -&gt; id)
  end Rec }

Note that the DFun immediately terminates and produces a dictionary, just
like DFuns ought to, but it calls itself recursively to produce the `Foo m`
dictionary. But alas, if we treat `$fFooTrans` as always-terminating, so
that we can speculate its calls, and hence use call-by-value, we get:

  $fFooTrans
    = \ @m $dMonad -&gt; case ($fFooTrans $dMonad) of sc -&gt;
                      C:Foo sc (\ @a -&gt; id)

and that's an infinite loop!
Note that this bad-ness only happens in `$fFooTrans`'s own RHS. In the
*body* of the letrec, it's absolutely fine to use call-by-value on
`foo ($fFooTrans d)`.

Our solution is this: we track in cpe_rec_ids the set of enclosing
recursively-bound Ids, the RHSs of which we are currently transforming and then
in 'exprOkForSpecEval' (a special entry point to 'exprOkForSpeculation',
basically) we'll say that any binder in this set is not ok-for-spec.

Note if we have a letrec group `Rec { f1 = rhs1; ...; fn = rhsn }`, and we
prep up `rhs1`, we have to include not only `f1`, but all binders of the group
`f1..fn` in this set, otherwise our fix is not robust wrt. mutual recursive
DFuns.

NB: If at some point we decide to have a termination analysis for general
functions (#8655, !1866), we need to take similar precautions for (guarded)
recursive functions:

  repeat x = x : repeat x

Same problem here: As written, repeat evaluates rapidly to WHNF. So `repeat x`
is a cheap call that we are willing to speculate, but *not* in repeat's RHS.
Fortunately, pce_rec_ids already has all the information we need in that case.

The problem is very similar to Note [Eta reduction in recursive RHSs].
Here as well as there it is *unsound* to change the termination properties
of the very function whose termination properties we are exploiting.

It is also similar to Note [Do not strictify a DFun's parameter dictionaries],
where marking recursive DFuns (of undecidable *instances*) strict in dictionary
*parameters* leads to quite the same change in termination as above.

Note [Controlling Speculative Evaluation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Most of the time, speculative evaluation has a positive effect on performance,
but we have found a case where speculative evaluation of dictionary functions
leads to a performance regression #25284.

Therefore we have some flags to control it. See the optimization section in
the User's Guide for the description of these flags and when to use them.

-}</span><span>
</span><span id="line-1726"></span><span>
</span><span id="line-1727"></span><span class="hs-keyword">data</span><span> </span><span id="FloatingBind"><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-var">FloatingBind</span></a></span></span><span>
</span><span id="line-1728"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="FloatLet"><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span>    </span><span class="hs-comment">-- Rhs of bindings are CpeRhss</span><span>
</span><span id="line-1729"></span><span>                         </span><span class="hs-comment">-- They are always of lifted type;</span><span>
</span><span id="line-1730"></span><span>                         </span><span class="hs-comment">-- unlifted ones are done with FloatCase</span><span>
</span><span id="line-1731"></span><span>
</span><span id="line-1732"></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="FloatCase"><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a></span></span><span>
</span><span id="line-1733"></span><span>      </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a></span><span>         </span><span class="hs-comment">-- Always ok-for-speculation</span><span>
</span><span id="line-1734"></span><span>      </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>              </span><span class="hs-comment">-- Case binder</span><span>
</span><span id="line-1735"></span><span>      </span><span class="annot"><a href="GHC.Core.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Single alternative</span><span>
</span><span id="line-1736"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>            </span><span class="hs-comment">-- Ok-for-speculation; False of a strict,</span><span>
</span><span id="line-1737"></span><span>                      </span><span class="hs-comment">-- but lifted binding</span><span>
</span><span id="line-1738"></span><span>
</span><span id="line-1739"></span><span> </span><span class="annot"><span class="hs-comment">-- | See Note [Floating Ticks in CorePrep]</span></span><span>
</span><span id="line-1740"></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="FloatTick"><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-var">FloatTick</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span>
</span><span id="line-1741"></span><span>
</span><span id="line-1742"></span><span class="hs-keyword">data</span><span> </span><span id="Floats"><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Floats"><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a></span></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-type">OkToSpec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1743"></span><span>
</span><span id="line-1744"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1745"></span><span>  </span><span id="local-6989586621681998331"><span class="annot"><span class="annottext">ppr :: FloatingBind -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-type">FloatLet</span></a></span><span> </span><span id="local-6989586621681998332"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681998332"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681998332"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1746"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatCase"><span class="hs-identifier hs-type">FloatCase</span></a></span><span> </span><span id="local-6989586621681998333"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998333"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621681998334"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998334"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681998335"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681998335"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621681998336"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998336"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681998337"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998337"><span class="hs-identifier hs-var">ok</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;case&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998337"><span class="hs-identifier hs-var">ok</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998333"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1747"></span><span>                                </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;of&quot;</span></span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998334"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;@&quot;</span></span><span>
</span><span id="line-1748"></span><span>                                </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998336"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1749"></span><span>                                   </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681998335"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-1750"></span><span>                                   </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AltCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681998335"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998336"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1751"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-type">FloatTick</span></a></span><span> </span><span id="local-6989586621681998341"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998341"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998341"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1752"></span><span>
</span><span id="line-1753"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1754"></span><span>  </span><span id="local-6989586621681998353"><span class="annot"><span class="annottext">ppr :: Floats -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span id="local-6989586621681998354"><span class="annot"><span class="annottext">OkToSpec
</span><a href="#local-6989586621681998354"><span class="hs-identifier hs-var">flag</span></a></span></span><span> </span><span id="local-6989586621681998355"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998355"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Floats&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OkToSpec -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="#local-6989586621681998354"><span class="hs-identifier hs-var">flag</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span>
</span><span id="line-1755"></span><span>                         </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FloatingBind -&gt; SDoc) -&gt; [FloatingBind] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList FloatingBind -&gt; [FloatingBind]
forall a. OrdList a -&gt; [a]
</span><a href="GHC.Data.OrdList.html#fromOL"><span class="hs-identifier hs-var">fromOL</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998355"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1756"></span><span>
</span><span id="line-1757"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-type">OkToSpec</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1758"></span><span>  </span><span id="local-6989586621681998362"><span class="annot"><span class="annottext">ppr :: OkToSpec -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;OkToSpec&quot;</span></span><span>
</span><span id="line-1759"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;IfUnboxedOk&quot;</span></span><span>
</span><span id="line-1760"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;NotOkToSpec&quot;</span></span><span>
</span><span id="line-1761"></span><span>
</span><span id="line-1762"></span><span class="hs-comment">-- Can we float these binds out of the rhs of a let?  We cache this decision</span><span>
</span><span id="line-1763"></span><span class="hs-comment">-- to avoid having to recompute it in a non-linear way when there are</span><span>
</span><span id="line-1764"></span><span class="hs-comment">-- deeply nested lets.</span><span>
</span><span id="line-1765"></span><span class="hs-keyword">data</span><span> </span><span id="OkToSpec"><span class="annot"><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a></span></span><span>
</span><span id="line-1766"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="OkToSpec"><span class="annot"><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a></span></span><span>           </span><span class="hs-comment">-- Lazy bindings of lifted type</span><span>
</span><span id="line-1767"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="IfUnboxedOk"><span class="annot"><a href="GHC.CoreToStg.Prep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a></span></span><span>        </span><span class="hs-comment">-- A mixture of lazy lifted bindings and n</span><span>
</span><span id="line-1768"></span><span>                        </span><span class="hs-comment">-- ok-to-speculate unlifted bindings</span><span>
</span><span id="line-1769"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="NotOkToSpec"><span class="annot"><a href="GHC.CoreToStg.Prep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a></span></span><span>        </span><span class="hs-comment">-- Some not-ok-to-speculate unlifted bindings</span><span>
</span><span id="line-1770"></span><span>
</span><span id="line-1771"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#mkFloat"><span class="hs-identifier hs-type">mkFloat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span>
</span><span id="line-1772"></span><span id="mkFloat"><span class="annot"><span class="annottext">mkFloat :: CorePrepEnv -&gt; Demand -&gt; Bool -&gt; Id -&gt; CpeApp -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#mkFloat"><span class="hs-identifier hs-var hs-var">mkFloat</span></a></span></span><span> </span><span id="local-6989586621681998366"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998366"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998367"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681998367"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span id="local-6989586621681998368"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998368"><span class="hs-identifier hs-var">is_unlifted</span></a></span></span><span> </span><span id="local-6989586621681998369"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998369"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681998370"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998370"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1773"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998371"><span class="hs-identifier hs-var">is_strict</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998372"><span class="hs-identifier hs-var">ok_for_spec</span></a></span><span> </span><span class="hs-comment">-- See Note [Speculative evaluation]</span><span>
</span><span id="line-1774"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998373"><span class="hs-identifier hs-var">is_hnf</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Id -&gt; AltCon -&gt; [Id] -&gt; Bool -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998370"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998369"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998372"><span class="hs-identifier hs-var">ok_for_spec</span></a></span><span>
</span><span id="line-1775"></span><span>    </span><span class="hs-comment">-- Don't make a case for a HNF binding, even if it's strict</span><span>
</span><span id="line-1776"></span><span>    </span><span class="hs-comment">-- Otherwise we get  case (\x -&gt; e) of ...!</span><span>
</span><span id="line-1777"></span><span>
</span><span id="line-1778"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998368"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Id -&gt; AltCon -&gt; [Id] -&gt; Bool -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998370"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998369"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1779"></span><span>      </span><span class="hs-comment">-- we used to assertPpr ok_for_spec (ppr rhs) here, but it is now disabled</span><span>
</span><span id="line-1780"></span><span>      </span><span class="hs-comment">-- because exprOkForSpeculation isn't stable under ANF-ing. See for</span><span>
</span><span id="line-1781"></span><span>      </span><span class="hs-comment">-- example #19489 where the following unlifted expression:</span><span>
</span><span id="line-1782"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1783"></span><span>      </span><span class="hs-comment">--    GHC.Prim.(#|_#) @LiftedRep @LiftedRep @[a_ax0] @[a_ax0]</span><span>
</span><span id="line-1784"></span><span>      </span><span class="hs-comment">--                    (GHC.Types.: @a_ax0 a2_agq a3_agl)</span><span>
</span><span id="line-1785"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1786"></span><span>      </span><span class="hs-comment">-- is ok-for-spec but is ANF-ised into:</span><span>
</span><span id="line-1787"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1788"></span><span>      </span><span class="hs-comment">--    let sat = GHC.Types.: @a_ax0 a2_agq a3_agl</span><span>
</span><span id="line-1789"></span><span>      </span><span class="hs-comment">--    in GHC.Prim.(#|_#) @LiftedRep @LiftedRep @[a_ax0] @[a_ax0] sat</span><span>
</span><span id="line-1790"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1791"></span><span>      </span><span class="hs-comment">-- which isn't ok-for-spec because of the let-expression.</span><span>
</span><span id="line-1792"></span><span>
</span><span id="line-1793"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998373"><span class="hs-identifier hs-var">is_hnf</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CpeApp -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998369"><span class="hs-identifier hs-var">bndr</span></a></span><span>                       </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998370"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1794"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CpeApp -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Demand -&gt; Id
</span><a href="GHC.Types.Id.html#setIdDemandInfo"><span class="hs-identifier hs-var">setIdDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998369"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681998367"><span class="hs-identifier hs-var">dmd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998370"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1795"></span><span>                   </span><span class="hs-comment">-- See Note [Pin demand info on floats]</span><span>
</span><span id="line-1796"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1797"></span><span>    </span><span id="local-6989586621681998373"><span class="annot"><span class="annottext">is_hnf :: Bool
</span><a href="#local-6989586621681998373"><span class="hs-identifier hs-var hs-var">is_hnf</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998370"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1798"></span><span>    </span><span id="local-6989586621681998371"><span class="annot"><span class="annottext">is_strict :: Bool
</span><a href="#local-6989586621681998371"><span class="hs-identifier hs-var hs-var">is_strict</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isStrUsedDmd"><span class="hs-identifier hs-var">isStrUsedDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681998367"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-1799"></span><span>    </span><span id="local-6989586621681998378"><span class="annot"><span class="annottext">cfg :: CorePrepConfig
</span><a href="#local-6989586621681998378"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; CorePrepConfig
</span><a href="GHC.CoreToStg.Prep.html#cpe_config"><span class="hs-identifier hs-var">cpe_config</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998366"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1800"></span><span>
</span><span id="line-1801"></span><span>    </span><span id="local-6989586621681998372"><span class="annot"><span class="annottext">ok_for_spec :: Bool
</span><a href="#local-6989586621681998372"><span class="hs-identifier hs-var hs-var">ok_for_spec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; CpeApp -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprOkForSpecEval"><span class="hs-identifier hs-var">exprOkForSpecEval</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621681998380"><span class="hs-identifier hs-var">call_ok_for_spec</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998370"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1802"></span><span>    </span><span class="hs-comment">-- See Note [Controlling Speculative Evaluation]</span><span>
</span><span id="line-1803"></span><span>    </span><span id="local-6989586621681998380"><span class="annot"><span class="annottext">call_ok_for_spec :: Id -&gt; Bool
</span><a href="#local-6989586621681998380"><span class="hs-identifier hs-var hs-var">call_ok_for_spec</span></a></span></span><span> </span><span id="local-6989586621681998381"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998381"><span class="hs-identifier hs-var">x</span></a></span></span><span>
</span><span id="line-1804"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621681998382"><span class="hs-identifier hs-var">is_rec_call</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998381"><span class="hs-identifier hs-var">x</span></a></span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1805"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cp_specEval"><span class="hs-identifier hs-var">cp_specEval</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621681998378"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1806"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cp_specEvalDFun"><span class="hs-identifier hs-var">cp_specEvalDFun</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621681998378"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDFunId"><span class="hs-identifier hs-var">isDFunId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998381"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1807"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1808"></span><span>    </span><span id="local-6989586621681998382"><span class="annot"><span class="annottext">is_rec_call :: Id -&gt; Bool
</span><a href="#local-6989586621681998382"><span class="hs-identifier hs-var hs-var">is_rec_call</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; UnVarSet -&gt; Bool
</span><a href="GHC.Data.Graph.UnVar.html#elemUnVarSet"><span class="hs-operator hs-var">`elemUnVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; UnVarSet
</span><a href="GHC.CoreToStg.Prep.html#cpe_rec_ids"><span class="hs-identifier hs-var">cpe_rec_ids</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998366"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1809"></span><span>
</span><span id="line-1810"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-type">emptyFloats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-1811"></span><span id="emptyFloats"><span class="annot"><span class="annottext">emptyFloats :: Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var hs-var">emptyFloats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OkToSpec -&gt; OrdList FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
forall a. OrdList a
</span><a href="GHC.Data.OrdList.html#nilOL"><span class="hs-identifier hs-var">nilOL</span></a></span><span>
</span><span id="line-1812"></span><span>
</span><span id="line-1813"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#isEmptyFloats"><span class="hs-identifier hs-type">isEmptyFloats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1814"></span><span id="isEmptyFloats"><span class="annot"><span class="annottext">isEmptyFloats :: Floats -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isEmptyFloats"><span class="hs-identifier hs-var hs-var">isEmptyFloats</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681998390"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998390"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind -&gt; Bool
forall a. OrdList a -&gt; Bool
</span><a href="GHC.Data.OrdList.html#isNilOL"><span class="hs-identifier hs-var">isNilOL</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998390"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-1815"></span><span>
</span><span id="line-1816"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#wrapBinds"><span class="hs-identifier hs-type">wrapBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a></span><span>
</span><span id="line-1817"></span><span id="wrapBinds"><span class="annot"><span class="annottext">wrapBinds :: Floats -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#wrapBinds"><span class="hs-identifier hs-var hs-var">wrapBinds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681998392"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998392"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998393"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998393"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-1818"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FloatingBind -&gt; CpeApp -&gt; CpeApp)
-&gt; CpeApp -&gt; OrdList FloatingBind -&gt; CpeApp
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
</span><a href="GHC.Data.OrdList.html#foldrOL"><span class="hs-identifier hs-var">foldrOL</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind -&gt; CpeApp -&gt; CpeApp
</span><a href="#local-6989586621681998394"><span class="hs-identifier hs-var">mk_bind</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998393"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998392"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-1819"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1820"></span><span>    </span><span id="local-6989586621681998394"><span class="annot"><span class="annottext">mk_bind :: FloatingBind -&gt; CpeApp -&gt; CpeApp
</span><a href="#local-6989586621681998394"><span class="hs-identifier hs-var hs-var">mk_bind</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatCase"><span class="hs-identifier hs-type">FloatCase</span></a></span><span> </span><span id="local-6989586621681998396"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998396"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621681998397"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998397"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681998398"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681998398"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621681998399"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998399"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998400"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998400"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Id -&gt; Type -&gt; [Alt Id] -&gt; CpeApp
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998396"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998397"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CpeApp -&gt; Type
CpeApp -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998400"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; CpeApp -&gt; Alt Id
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681998398"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998399"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998400"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1821"></span><span>    </span><span class="annot"><a href="#local-6989586621681998394"><span class="hs-identifier hs-var">mk_bind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-type">FloatLet</span></a></span><span> </span><span id="local-6989586621681998401"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681998401"><span class="hs-identifier hs-var">bind</span></a></span></span><span class="hs-special">)</span><span>               </span><span id="local-6989586621681998402"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998402"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CpeApp -&gt; CpeApp
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681998401"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998402"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1822"></span><span>    </span><span class="annot"><a href="#local-6989586621681998394"><span class="hs-identifier hs-var">mk_bind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-type">FloatTick</span></a></span><span> </span><span id="local-6989586621681998403"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998403"><span class="hs-identifier hs-var">tickish</span></a></span></span><span class="hs-special">)</span><span>           </span><span id="local-6989586621681998404"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998404"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998403"><span class="hs-identifier hs-var">tickish</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998404"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1823"></span><span>
</span><span id="line-1824"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#addFloat"><span class="hs-identifier hs-type">addFloat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-1825"></span><span id="addFloat"><span class="annot"><span class="annottext">addFloat :: Floats -&gt; FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#addFloat"><span class="hs-identifier hs-var hs-var">addFloat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span id="local-6989586621681998405"><span class="annot"><span class="annottext">OkToSpec
</span><a href="#local-6989586621681998405"><span class="hs-identifier hs-var">ok_to_spec</span></a></span></span><span> </span><span id="local-6989586621681998406"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998406"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998407"><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998407"><span class="hs-identifier hs-var">new_float</span></a></span></span><span>
</span><span id="line-1826"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OkToSpec -&gt; OrdList FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OkToSpec -&gt; OkToSpec -&gt; OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#combine"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="#local-6989586621681998405"><span class="hs-identifier hs-var">ok_to_spec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatingBind -&gt; OkToSpec
</span><a href="#local-6989586621681998409"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998407"><span class="hs-identifier hs-var">new_float</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998406"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind -&gt; FloatingBind -&gt; OrdList FloatingBind
forall a. OrdList a -&gt; a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#snocOL"><span class="hs-operator hs-var">`snocOL`</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998407"><span class="hs-identifier hs-var">new_float</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1827"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1828"></span><span>    </span><span id="local-6989586621681998409"><span class="annot"><span class="annottext">check :: FloatingBind -&gt; OkToSpec
</span><a href="#local-6989586621681998409"><span class="hs-identifier hs-var hs-var">check</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-type">FloatLet</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a></span><span>
</span><span id="line-1829"></span><span>    </span><span class="annot"><a href="#local-6989586621681998409"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatCase"><span class="hs-identifier hs-type">FloatCase</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681998411"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998411"><span class="hs-identifier hs-var">ok_for_spec</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1830"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998411"><span class="hs-identifier hs-var">ok_for_spec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a></span><span>
</span><span id="line-1831"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a></span><span>
</span><span id="line-1832"></span><span>    </span><span class="annot"><a href="#local-6989586621681998409"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-type">FloatTick</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a></span><span>
</span><span id="line-1833"></span><span>        </span><span class="hs-comment">-- The ok-for-speculation flag says that it's safe to</span><span>
</span><span id="line-1834"></span><span>        </span><span class="hs-comment">-- float this Case out of a let, and thereby do it more eagerly</span><span>
</span><span id="line-1835"></span><span>        </span><span class="hs-comment">-- We need the top-level flag because it's never ok to float</span><span>
</span><span id="line-1836"></span><span>        </span><span class="hs-comment">-- an unboxed binding to the top level</span><span>
</span><span id="line-1837"></span><span>
</span><span id="line-1838"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#unitFloat"><span class="hs-identifier hs-type">unitFloat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-1839"></span><span id="unitFloat"><span class="annot"><span class="annottext">unitFloat :: FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#unitFloat"><span class="hs-identifier hs-var hs-var">unitFloat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Floats -&gt; FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#addFloat"><span class="hs-identifier hs-var">addFloat</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="GHC.CoreToStg.Prep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a></span><span>
</span><span id="line-1840"></span><span>
</span><span id="line-1841"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#appendFloats"><span class="hs-identifier hs-type">appendFloats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span>
</span><span id="line-1842"></span><span id="appendFloats"><span class="annot"><span class="annottext">appendFloats :: Floats -&gt; Floats -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#appendFloats"><span class="hs-identifier hs-var hs-var">appendFloats</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span id="local-6989586621681998412"><span class="annot"><span class="annottext">OkToSpec
</span><a href="#local-6989586621681998412"><span class="hs-identifier hs-var">spec1</span></a></span></span><span> </span><span id="local-6989586621681998413"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998413"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span id="local-6989586621681998414"><span class="annot"><span class="annottext">OkToSpec
</span><a href="#local-6989586621681998414"><span class="hs-identifier hs-var">spec2</span></a></span></span><span> </span><span id="local-6989586621681998415"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998415"><span class="hs-identifier hs-var">floats2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1843"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OkToSpec -&gt; OrdList FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OkToSpec -&gt; OkToSpec -&gt; OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#combine"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="#local-6989586621681998412"><span class="hs-identifier hs-var">spec1</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="#local-6989586621681998414"><span class="hs-identifier hs-var">spec2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998413"><span class="hs-identifier hs-var">floats1</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
-&gt; OrdList FloatingBind -&gt; OrdList FloatingBind
forall a. OrdList a -&gt; OrdList a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#appOL"><span class="hs-operator hs-var">`appOL`</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998415"><span class="hs-identifier hs-var">floats2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1844"></span><span>
</span><span id="line-1845"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#concatFloats"><span class="hs-identifier hs-type">concatFloats</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span>
</span><span id="line-1846"></span><span id="concatFloats"><span class="annot"><span class="annottext">concatFloats :: [Floats] -&gt; OrdList FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#concatFloats"><span class="hs-identifier hs-var hs-var">concatFloats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats -&gt; OrdList FloatingBind -&gt; OrdList FloatingBind)
-&gt; OrdList FloatingBind -&gt; [Floats] -&gt; OrdList FloatingBind
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681998417"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998417"><span class="hs-identifier hs-var">bs1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998418"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998418"><span class="hs-identifier hs-var">bs2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
-&gt; OrdList FloatingBind -&gt; OrdList FloatingBind
forall a. OrdList a -&gt; OrdList a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#appOL"><span class="hs-identifier hs-var">appOL</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998417"><span class="hs-identifier hs-var">bs1</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998418"><span class="hs-identifier hs-var">bs2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
forall a. OrdList a
</span><a href="GHC.Data.OrdList.html#nilOL"><span class="hs-identifier hs-var">nilOL</span></a></span><span>
</span><span id="line-1847"></span><span>
</span><span id="line-1848"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#combine"><span class="hs-identifier hs-type">combine</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-type">OkToSpec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-type">OkToSpec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-type">OkToSpec</span></a></span><span>
</span><span id="line-1849"></span><span id="combine"><span class="annot"><span class="annottext">combine :: OkToSpec -&gt; OkToSpec -&gt; OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#combine"><span class="hs-identifier hs-var hs-var">combine</span></a></span></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a></span><span>
</span><span id="line-1850"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#combine"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a></span><span>
</span><span id="line-1851"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#combine"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a></span><span>
</span><span id="line-1852"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#combine"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a></span><span>
</span><span id="line-1853"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#combine"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a></span><span>
</span><span id="line-1854"></span><span>
</span><span id="line-1855"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#deFloatTop"><span class="hs-identifier hs-type">deFloatTop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1856"></span><span class="hs-comment">-- For top level only; we don't expect any FloatCases</span><span>
</span><span id="line-1857"></span><span id="deFloatTop"><span class="annot"><span class="annottext">deFloatTop :: Floats -&gt; CoreProgram
</span><a href="GHC.CoreToStg.Prep.html#deFloatTop"><span class="hs-identifier hs-var hs-var">deFloatTop</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681998419"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998419"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1858"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FloatingBind -&gt; CoreProgram -&gt; CoreProgram)
-&gt; CoreProgram -&gt; OrdList FloatingBind -&gt; CoreProgram
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
</span><a href="GHC.Data.OrdList.html#foldrOL"><span class="hs-identifier hs-var">foldrOL</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind -&gt; CoreProgram -&gt; CoreProgram
</span><a href="#local-6989586621681998420"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998419"><span class="hs-identifier hs-var">floats</span></a></span><span>
</span><span id="line-1859"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1860"></span><span>    </span><span id="local-6989586621681998420"><span class="annot"><span class="annottext">get :: FloatingBind -&gt; CoreProgram -&gt; CoreProgram
</span><a href="#local-6989586621681998420"><span class="hs-identifier hs-var hs-var">get</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-type">FloatLet</span></a></span><span> </span><span id="local-6989586621681998424"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681998424"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span>               </span><span id="local-6989586621681998425"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681998425"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CoreBind
</span><a href="#local-6989586621681998426"><span class="hs-identifier hs-var">get_bind</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681998424"><span class="hs-identifier hs-var">b</span></a></span><span>                 </span><span class="annot"><span class="annottext">CoreBind -&gt; CoreProgram -&gt; CoreProgram
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681998425"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-1861"></span><span>    </span><span class="annot"><a href="#local-6989586621681998420"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatCase"><span class="hs-identifier hs-type">FloatCase</span></a></span><span> </span><span id="local-6989586621681998427"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998427"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621681998428"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998428"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998429"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681998429"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CoreBind
</span><a href="#local-6989586621681998426"><span class="hs-identifier hs-var">get_bind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CpeApp -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998428"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998427"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CoreProgram -&gt; CoreProgram
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681998429"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-1862"></span><span>    </span><span class="annot"><a href="#local-6989586621681998420"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span id="local-6989586621681998430"><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998430"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; CoreProgram
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;corePrepPgm&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatingBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998430"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1863"></span><span>
</span><span id="line-1864"></span><span>    </span><span class="hs-comment">-- See Note [Dead code in CorePrep]</span><span>
</span><span id="line-1865"></span><span>    </span><span id="local-6989586621681998426"><span class="annot"><span class="annottext">get_bind :: CoreBind -&gt; CoreBind
</span><a href="#local-6989586621681998426"><span class="hs-identifier hs-var hs-var">get_bind</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681998431"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998431"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621681998432"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998432"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CpeApp -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998431"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998432"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1866"></span><span>    </span><span class="annot"><a href="#local-6989586621681998426"><span class="hs-identifier hs-var">get_bind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681998434"><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681998434"><span class="hs-identifier hs-var">xes</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998435"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998436"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998435"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998435"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998436"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998436"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681998434"><span class="hs-identifier hs-var">xes</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1867"></span><span>
</span><span id="line-1868"></span><span class="hs-comment">---------------------------------------------------------------------------</span><span>
</span><span id="line-1869"></span><span>
</span><span id="line-1870"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#canFloat"><span class="hs-identifier hs-type">canFloat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1871"></span><span id="canFloat"><span class="annot"><span class="annottext">canFloat :: Floats -&gt; CpeApp -&gt; Maybe (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#canFloat"><span class="hs-identifier hs-var hs-var">canFloat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span id="local-6989586621681998437"><span class="annot"><span class="annottext">OkToSpec
</span><a href="#local-6989586621681998437"><span class="hs-identifier hs-var">ok_to_spec</span></a></span></span><span> </span><span id="local-6989586621681998438"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998438"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998439"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998439"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1872"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="#local-6989586621681998437"><span class="hs-identifier hs-var">ok_to_spec</span></a></span><span>           </span><span class="hs-comment">-- Worth trying</span><span>
</span><span id="line-1873"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681998440"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998440"><span class="hs-identifier hs-var">fs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
-&gt; [FloatingBind] -&gt; Maybe (OrdList FloatingBind)
</span><a href="#local-6989586621681998441"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
forall a. OrdList a
</span><a href="GHC.Data.OrdList.html#nilOL"><span class="hs-identifier hs-var">nilOL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList FloatingBind -&gt; [FloatingBind]
forall a. OrdList a -&gt; [a]
</span><a href="GHC.Data.OrdList.html#fromOL"><span class="hs-identifier hs-var">fromOL</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998438"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1874"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Floats, CpeApp) -&gt; Maybe (Floats, CpeApp)
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OkToSpec -&gt; OrdList FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998440"><span class="hs-identifier hs-var">fs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998439"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1875"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1876"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Floats, CpeApp)
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1877"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1878"></span><span>    </span><span class="annot"><a href="#local-6989586621681998441"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1879"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1880"></span><span>
</span><span id="line-1881"></span><span>    </span><span id="local-6989586621681998441"><span class="annot"><span class="annottext">go :: OrdList FloatingBind
-&gt; [FloatingBind] -&gt; Maybe (OrdList FloatingBind)
</span><a href="#local-6989586621681998441"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998442"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998442"><span class="hs-identifier hs-var">fbs_out</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind -&gt; Maybe (OrdList FloatingBind)
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998442"><span class="hs-identifier hs-var">fbs_out</span></a></span><span>
</span><span id="line-1882"></span><span>
</span><span id="line-1883"></span><span>    </span><span class="annot"><a href="#local-6989586621681998441"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681998443"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998443"><span class="hs-identifier hs-var">fbs_out</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998444"><span class="annot"><span class="annottext">fb :: FloatingBind
</span><a href="#local-6989586621681998444"><span class="hs-identifier hs-var">fb</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-type">FloatLet</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681998445"><span class="annot"><span class="annottext">[FloatingBind]
</span><a href="#local-6989586621681998445"><span class="hs-identifier hs-var">fbs_in</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1884"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
-&gt; [FloatingBind] -&gt; Maybe (OrdList FloatingBind)
</span><a href="#local-6989586621681998441"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998443"><span class="hs-identifier hs-var">fbs_out</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind -&gt; FloatingBind -&gt; OrdList FloatingBind
forall a. OrdList a -&gt; a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#snocOL"><span class="hs-operator hs-var">`snocOL`</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998444"><span class="hs-identifier hs-var">fb</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FloatingBind]
</span><a href="#local-6989586621681998445"><span class="hs-identifier hs-var">fbs_in</span></a></span><span>
</span><span id="line-1885"></span><span>
</span><span id="line-1886"></span><span>    </span><span class="annot"><a href="#local-6989586621681998441"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681998446"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998446"><span class="hs-identifier hs-var">fbs_out</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998447"><span class="annot"><span class="annottext">ft :: FloatingBind
</span><a href="#local-6989586621681998447"><span class="hs-identifier hs-var">ft</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-type">FloatTick</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681998448"><span class="annot"><span class="annottext">[FloatingBind]
</span><a href="#local-6989586621681998448"><span class="hs-identifier hs-var">fbs_in</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1887"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
-&gt; [FloatingBind] -&gt; Maybe (OrdList FloatingBind)
</span><a href="#local-6989586621681998441"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998446"><span class="hs-identifier hs-var">fbs_out</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind -&gt; FloatingBind -&gt; OrdList FloatingBind
forall a. OrdList a -&gt; a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#snocOL"><span class="hs-operator hs-var">`snocOL`</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998447"><span class="hs-identifier hs-var">ft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FloatingBind]
</span><a href="#local-6989586621681998448"><span class="hs-identifier hs-var">fbs_in</span></a></span><span>
</span><span id="line-1888"></span><span>
</span><span id="line-1889"></span><span>    </span><span class="annot"><a href="#local-6989586621681998441"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatCase"><span class="hs-identifier hs-type">FloatCase</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[FloatingBind]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (OrdList FloatingBind)
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1890"></span><span>
</span><span id="line-1891"></span><span>
</span><span id="line-1892"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#wantFloatNested"><span class="hs-identifier hs-type">wantFloatNested</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1893"></span><span id="wantFloatNested"><span class="annot"><span class="annottext">wantFloatNested :: RecFlag -&gt; Demand -&gt; Bool -&gt; Floats -&gt; CpeApp -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#wantFloatNested"><span class="hs-identifier hs-var hs-var">wantFloatNested</span></a></span></span><span> </span><span id="local-6989586621681998449"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681998449"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621681998450"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681998450"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span id="local-6989586621681998451"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998451"><span class="hs-identifier hs-var">is_unlifted</span></a></span></span><span> </span><span id="local-6989586621681998452"><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998452"><span class="hs-identifier hs-var">floats</span></a></span></span><span> </span><span id="local-6989586621681998453"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998453"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1894"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">Floats -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#isEmptyFloats"><span class="hs-identifier hs-var">isEmptyFloats</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998452"><span class="hs-identifier hs-var">floats</span></a></span><span>
</span><span id="line-1895"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isStrUsedDmd"><span class="hs-identifier hs-var">isStrUsedDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681998450"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-1896"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998451"><span class="hs-identifier hs-var">is_unlifted</span></a></span><span>
</span><span id="line-1897"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecFlag -&gt; Floats -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#allLazyNested"><span class="hs-identifier hs-var">allLazyNested</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681998449"><span class="hs-identifier hs-var">is_rec</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><a href="#local-6989586621681998452"><span class="hs-identifier hs-var">floats</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998453"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1898"></span><span>        </span><span class="hs-comment">-- Why the test for allLazyNested?</span><span>
</span><span id="line-1899"></span><span>        </span><span class="hs-comment">--      v = f (x `divInt#` y)</span><span>
</span><span id="line-1900"></span><span>        </span><span class="hs-comment">-- we don't want to float the case, even if f has arity 2,</span><span>
</span><span id="line-1901"></span><span>        </span><span class="hs-comment">-- because floating the case would make it evaluated too early</span><span>
</span><span id="line-1902"></span><span>
</span><span id="line-1903"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#allLazyTop"><span class="hs-identifier hs-type">allLazyTop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1904"></span><span id="allLazyTop"><span class="annot"><span class="annottext">allLazyTop :: Floats -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#allLazyTop"><span class="hs-identifier hs-var hs-var">allLazyTop</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1905"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#allLazyTop"><span class="hs-identifier hs-var">allLazyTop</span></a></span><span> </span><span class="annot"><span class="annottext">Floats
</span><span class="hs-identifier">_</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1906"></span><span>
</span><span id="line-1907"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#allLazyNested"><span class="hs-identifier hs-type">allLazyNested</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1908"></span><span id="allLazyNested"><span class="annot"><span class="annottext">allLazyNested :: RecFlag -&gt; Floats -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#allLazyNested"><span class="hs-identifier hs-var hs-var">allLazyNested</span></a></span></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a></span><span>    </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1909"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#allLazyNested"><span class="hs-identifier hs-var">allLazyNested</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1910"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#allLazyNested"><span class="hs-identifier hs-var">allLazyNested</span></a></span><span> </span><span id="local-6989586621681998455"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681998455"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="GHC.CoreToStg.Prep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isNonRec"><span class="hs-identifier hs-var">isNonRec</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681998455"><span class="hs-identifier hs-var">is_rec</span></a></span><span>
</span><span id="line-1911"></span><span>
</span><span id="line-1912"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Cloning
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1919"></span><span>
</span><span id="line-1920"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-1921"></span><span class="hs-comment">--                      The environment</span><span>
</span><span id="line-1922"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-1923"></span><span>
</span><span id="line-1924"></span><span class="hs-comment">{- Note [Inlining in CorePrep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
There is a subtle but important invariant that must be upheld in the output
of CorePrep: there are no &quot;trivial&quot; updatable thunks.  Thus, this Core
is impermissible:

     let x :: ()
         x = y

(where y is a reference to a GLOBAL variable).  Thunks like this are silly:
they can always be profitably replaced by inlining x with y. Consequently,
the code generator/runtime does not bother implementing this properly
(specifically, there is no implementation of stg_ap_0_upd_info, which is the
stack frame that would be used to update this thunk.  The &quot;0&quot; means it has
zero free variables.)

In general, the inliner is good at eliminating these let-bindings.  However,
there is one case where these trivial updatable thunks can arise: when
we are optimizing away 'lazy' (see Note [lazyId magic], and also
'cpeRhsE'.)  Then, we could have started with:

     let x :: ()
         x = lazy @ () y

which is a perfectly fine, non-trivial thunk, but then CorePrep will
drop 'lazy', giving us 'x = y' which is trivial and impermissible.
The solution is CorePrep to have a miniature inlining pass which deals
with cases like this.  We can then drop the let-binding altogether.

Why does the removal of 'lazy' have to occur in CorePrep?
The gory details are in Note [lazyId magic] in GHC.Types.Id.Make, but the
main reason is that lazy must appear in unfoldings (optimizer
output) and it must prevent call-by-value for catch# (which
is implemented by CorePrep.)

An alternate strategy for solving this problem is to have the
inliner treat 'lazy e' as a trivial expression if 'e' is trivial.
We decided not to adopt this solution to keep the definition
of 'exprIsTrivial' simple.

There is ONE caveat however: for top-level bindings we have
to preserve the binding so that we float the (hacky) non-recursive
binding for data constructors; see Note [Data constructor workers].

Note [CorePrep inlines trivial CoreExpr not Id]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Why does cpe_env need to be an IdEnv CoreExpr, as opposed to an
IdEnv Id?  Naively, we might conjecture that trivial updatable thunks
as per Note [Inlining in CorePrep] always have the form
'lazy @ SomeType gbl_id'.  But this is not true: the following is
perfectly reasonable Core:

     let x :: ()
         x = lazy @ (forall a. a) y @ Bool

When we inline 'x' after eliminating 'lazy', we need to replace
occurrences of 'x' with 'y @ bool', not just 'y'.  Situations like
this can easily arise with higher-rank types; thus, cpe_env must
map to CoreExprs, not Ids.

-}</span><span>
</span><span id="line-1985"></span><span>
</span><span id="line-1986"></span><span class="hs-keyword">data</span><span> </span><span id="CorePrepConfig"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier hs-var">CorePrepConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CorePrepConfig"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier hs-var">CorePrepConfig</span></a></span></span><span>
</span><span id="line-1987"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="cp_catchNonexhaustiveCases"><span class="annot"><span class="annottext">CorePrepConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cp_catchNonexhaustiveCases"><span class="hs-identifier hs-var hs-var">cp_catchNonexhaustiveCases</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1988"></span><span>  </span><span class="hs-comment">-- ^ Whether to generate a default alternative with ``error`` in these</span><span>
</span><span id="line-1989"></span><span>  </span><span class="hs-comment">-- cases. This is helpful when debugging demand analysis or type</span><span>
</span><span id="line-1990"></span><span>  </span><span class="hs-comment">-- checker bugs which can sometimes manifest as segmentation faults.</span><span>
</span><span id="line-1991"></span><span>
</span><span id="line-1992"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="cp_convertNumLit"><span class="annot"><span class="annottext">CorePrepConfig -&gt; LitNumType -&gt; Integer -&gt; Maybe CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cp_convertNumLit"><span class="hs-identifier hs-var hs-var">cp_convertNumLit</span></a></span></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Literal.html#LitNumType"><span class="hs-identifier hs-type">LitNumType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1993"></span><span>  </span><span class="hs-comment">-- ^ Convert some numeric literals (Integer, Natural) into their final</span><span>
</span><span id="line-1994"></span><span>  </span><span class="hs-comment">-- Core form.</span><span>
</span><span id="line-1995"></span><span>
</span><span id="line-1996"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="cp_specEval"><span class="annot"><span class="annottext">CorePrepConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cp_specEval"><span class="hs-identifier hs-var hs-var">cp_specEval</span></a></span></span><span>                </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1997"></span><span>  </span><span class="hs-comment">-- ^ Whether to perform speculative evaluation</span><span>
</span><span id="line-1998"></span><span>  </span><span class="hs-comment">-- See Note [Controlling Speculative Evaluation]</span><span>
</span><span id="line-1999"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="cp_specEvalDFun"><span class="annot"><span class="annottext">CorePrepConfig -&gt; Bool
</span><a href="GHC.CoreToStg.Prep.html#cp_specEvalDFun"><span class="hs-identifier hs-var hs-var">cp_specEvalDFun</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2000"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Whether to perform speculative evaluation on DFuns</span></span><span>
</span><span id="line-2001"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-2002"></span><span>
</span><span id="line-2003"></span><span class="hs-keyword">data</span><span> </span><span id="CorePrepEnv"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-var">CorePrepEnv</span></a></span></span><span>
</span><span id="line-2004"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="CPE"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-var">CPE</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="cpe_config"><span class="annot"><span class="annottext">CorePrepEnv -&gt; CorePrepConfig
</span><a href="GHC.CoreToStg.Prep.html#cpe_config"><span class="hs-identifier hs-var hs-var">cpe_config</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier hs-type">CorePrepConfig</span></a></span><span>
</span><span id="line-2005"></span><span>        </span><span class="hs-comment">-- ^ This flag is intended to aid in debugging strictness</span><span>
</span><span id="line-2006"></span><span>        </span><span class="hs-comment">-- analysis bugs. These are particularly nasty to chase down as</span><span>
</span><span id="line-2007"></span><span>        </span><span class="hs-comment">-- they may manifest as segmentation faults. When this flag is</span><span>
</span><span id="line-2008"></span><span>        </span><span class="hs-comment">-- enabled we instead produce an 'error' expression to catch</span><span>
</span><span id="line-2009"></span><span>        </span><span class="hs-comment">-- the case where a function we think should bottom</span><span>
</span><span id="line-2010"></span><span>        </span><span class="hs-comment">-- unexpectedly returns.</span><span>
</span><span id="line-2011"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="cpe_env"><span class="annot"><span class="annottext">CorePrepEnv -&gt; IdEnv CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpe_env"><span class="hs-identifier hs-var hs-var">cpe_env</span></a></span></span><span>             </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>   </span><span class="hs-comment">-- Clone local Ids</span><span>
</span><span id="line-2012"></span><span>        </span><span class="hs-comment">-- ^ This environment is used for three operations:</span><span>
</span><span id="line-2013"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-2014"></span><span>        </span><span class="hs-comment">--      1. To support cloning of local Ids so that they are</span><span>
</span><span id="line-2015"></span><span>        </span><span class="hs-comment">--      all unique (see item (6) of CorePrep overview).</span><span>
</span><span id="line-2016"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-2017"></span><span>        </span><span class="hs-comment">--      2. To support beta-reduction of runRW, see</span><span>
</span><span id="line-2018"></span><span>        </span><span class="hs-comment">--      Note [runRW magic] and Note [runRW arg].</span><span>
</span><span id="line-2019"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-2020"></span><span>        </span><span class="hs-comment">--      3. To let us inline trivial RHSs of non top-level let-bindings,</span><span>
</span><span id="line-2021"></span><span>        </span><span class="hs-comment">--      see Note [lazyId magic], Note [Inlining in CorePrep]</span><span>
</span><span id="line-2022"></span><span>        </span><span class="hs-comment">--      and Note [CorePrep inlines trivial CoreExpr not Id] (#12076)</span><span>
</span><span id="line-2023"></span><span>
</span><span id="line-2024"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="cpe_tyco_env"><span class="annot"><span class="annottext">CorePrepEnv -&gt; Maybe CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#cpe_tyco_env"><span class="hs-identifier hs-var hs-var">cpe_tyco_env</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span> </span><span class="hs-comment">-- See Note [CpeTyCoEnv]</span><span>
</span><span id="line-2025"></span><span>
</span><span id="line-2026"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="cpe_rec_ids"><span class="annot"><span class="annottext">CorePrepEnv -&gt; UnVarSet
</span><a href="GHC.CoreToStg.Prep.html#cpe_rec_ids"><span class="hs-identifier hs-var hs-var">cpe_rec_ids</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.Graph.UnVar.html#UnVarSet"><span class="hs-identifier hs-type">UnVarSet</span></a></span><span> </span><span class="hs-comment">-- Faster OutIdSet; See Note [Speculative evaluation]</span><span>
</span><span id="line-2027"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-2028"></span><span>
</span><span id="line-2029"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#mkInitialCorePrepEnv"><span class="hs-identifier hs-type">mkInitialCorePrepEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepConfig"><span class="hs-identifier hs-type">CorePrepConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-2030"></span><span id="mkInitialCorePrepEnv"><span class="annot"><span class="annottext">mkInitialCorePrepEnv :: CorePrepConfig -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#mkInitialCorePrepEnv"><span class="hs-identifier hs-var hs-var">mkInitialCorePrepEnv</span></a></span></span><span> </span><span id="local-6989586621681998462"><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621681998462"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span>
</span><span id="line-2031"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_config :: CorePrepConfig
</span><a href="GHC.CoreToStg.Prep.html#cpe_config"><span class="hs-identifier hs-var">cpe_config</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepConfig
</span><a href="#local-6989586621681998462"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-2032"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cpe_env :: IdEnv CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpe_env"><span class="hs-identifier hs-var">cpe_env</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdEnv CpeApp
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-2033"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cpe_tyco_env :: Maybe CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#cpe_tyco_env"><span class="hs-identifier hs-var">cpe_tyco_env</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2034"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cpe_rec_ids :: UnVarSet
</span><a href="GHC.CoreToStg.Prep.html#cpe_rec_ids"><span class="hs-identifier hs-var">cpe_rec_ids</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnVarSet
</span><a href="GHC.Data.Graph.UnVar.html#emptyUnVarSet"><span class="hs-identifier hs-var">emptyUnVarSet</span></a></span><span>
</span><span id="line-2035"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-2036"></span><span>
</span><span id="line-2037"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnv"><span class="hs-identifier hs-type">extendCorePrepEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-2038"></span><span id="extendCorePrepEnv"><span class="annot"><span class="annottext">extendCorePrepEnv :: CorePrepEnv -&gt; Id -&gt; Id -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnv"><span class="hs-identifier hs-var hs-var">extendCorePrepEnv</span></a></span></span><span> </span><span id="local-6989586621681998465"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998465"><span class="hs-identifier hs-var">cpe</span></a></span></span><span> </span><span id="local-6989586621681998466"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998466"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681998467"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998467"><span class="hs-identifier hs-var">id'</span></a></span></span><span>
</span><span id="line-2039"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998465"><span class="hs-identifier hs-var">cpe</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_env"><span class="hs-identifier hs-var">cpe_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-type">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_env"><span class="hs-identifier hs-var">cpe_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681998465"><span class="hs-identifier hs-type">cpe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681998466"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681998467"><span class="hs-identifier hs-type">id'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2040"></span><span>
</span><span id="line-2041"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvExpr"><span class="hs-identifier hs-type">extendCorePrepEnvExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-2042"></span><span id="extendCorePrepEnvExpr"><span class="annot"><span class="annottext">extendCorePrepEnvExpr :: CorePrepEnv -&gt; Id -&gt; CpeApp -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvExpr"><span class="hs-identifier hs-var hs-var">extendCorePrepEnvExpr</span></a></span></span><span> </span><span id="local-6989586621681998469"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998469"><span class="hs-identifier hs-var">cpe</span></a></span></span><span> </span><span id="local-6989586621681998470"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998470"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681998471"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998471"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-2043"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998469"><span class="hs-identifier hs-var">cpe</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_env"><span class="hs-identifier hs-var">cpe_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-type">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_env"><span class="hs-identifier hs-var">cpe_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681998469"><span class="hs-identifier hs-type">cpe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681998470"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681998471"><span class="hs-identifier hs-type">expr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2044"></span><span>
</span><span id="line-2045"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvList"><span class="hs-identifier hs-type">extendCorePrepEnvList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-2046"></span><span id="extendCorePrepEnvList"><span class="annot"><span class="annottext">extendCorePrepEnvList :: CorePrepEnv -&gt; [(Id, Id)] -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnvList"><span class="hs-identifier hs-var hs-var">extendCorePrepEnvList</span></a></span></span><span> </span><span id="local-6989586621681998472"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998472"><span class="hs-identifier hs-var">cpe</span></a></span></span><span> </span><span id="local-6989586621681998473"><span class="annot"><span class="annottext">[(Id, Id)]
</span><a href="#local-6989586621681998473"><span class="hs-identifier hs-var">prs</span></a></span></span><span>
</span><span id="line-2047"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998472"><span class="hs-identifier hs-var">cpe</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_env"><span class="hs-identifier hs-var">cpe_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendVarEnvList"><span class="hs-identifier hs-type">extendVarEnvList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_env"><span class="hs-identifier hs-var">cpe_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681998472"><span class="hs-identifier hs-type">cpe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2048"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-type">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681998475"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998475"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998476"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998476"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998475"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CpeApp
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998476"><span class="hs-identifier hs-var">id'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681998473"><span class="hs-identifier hs-type">prs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2049"></span><span>
</span><span id="line-2050"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#lookupCorePrepEnv"><span class="hs-identifier hs-type">lookupCorePrepEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2051"></span><span id="lookupCorePrepEnv"><span class="annot"><span class="annottext">lookupCorePrepEnv :: CorePrepEnv -&gt; Id -&gt; CpeApp
</span><a href="GHC.CoreToStg.Prep.html#lookupCorePrepEnv"><span class="hs-identifier hs-var hs-var">lookupCorePrepEnv</span></a></span></span><span> </span><span id="local-6989586621681998477"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998477"><span class="hs-identifier hs-var">cpe</span></a></span></span><span> </span><span id="local-6989586621681998478"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998478"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-2052"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IdEnv CpeApp -&gt; Id -&gt; Maybe CpeApp
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; IdEnv CpeApp
</span><a href="GHC.CoreToStg.Prep.html#cpe_env"><span class="hs-identifier hs-var">cpe_env</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998477"><span class="hs-identifier hs-var">cpe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998478"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2053"></span><span>        </span><span class="annot"><span class="annottext">Maybe CpeApp
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CpeApp
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998478"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-2054"></span><span>        </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681998480"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998480"><span class="hs-identifier hs-var">exp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998480"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-2055"></span><span>
</span><span id="line-2056"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#enterRecGroupRHSs"><span class="hs-identifier hs-type">enterRecGroupRHSs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-2057"></span><span id="enterRecGroupRHSs"><span class="annot"><span class="annottext">enterRecGroupRHSs :: CorePrepEnv -&gt; [Id] -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#enterRecGroupRHSs"><span class="hs-identifier hs-var hs-var">enterRecGroupRHSs</span></a></span></span><span> </span><span id="local-6989586621681998481"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998481"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998482"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998482"><span class="hs-identifier hs-var">grp</span></a></span></span><span>
</span><span id="line-2058"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998481"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_rec_ids"><span class="hs-identifier hs-var">cpe_rec_ids</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.Graph.UnVar.html#extendUnVarSetList"><span class="hs-identifier hs-type">extendUnVarSetList</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681998482"><span class="hs-identifier hs-type">grp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_rec_ids"><span class="hs-identifier hs-var">cpe_rec_ids</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681998481"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2059"></span><span>
</span><span id="line-2060"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2061"></span><span class="hs-comment">--           CpeTyCoEnv</span><span>
</span><span id="line-2062"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2063"></span><span>
</span><span id="line-2064"></span><span class="hs-comment">{- Note [CpeTyCoEnv]
~~~~~~~~~~~~~~~~~~~~
The cpe_tyco_env :: Maybe CpeTyCoEnv field carries a substitution
for type and coercion variables

* We need the coercion substitution to support the elimination of
  unsafeEqualityProof (see Note [Unsafe coercions])

* We need the type substitution in case one of those unsafe
  coercions occurs in the kind of tyvar binder (sigh)

We don't need an in-scope set because we don't clone any of these
binders at all, so no new capture can take place.

The cpe_tyco_env is almost always empty -- it only gets populated
when we get under an usafeEqualityProof.  Hence the Maybe CpeTyCoEnv,
which makes everything into a no-op in the common case.
-}</span><span>
</span><span id="line-2082"></span><span>
</span><span id="line-2083"></span><span class="hs-keyword">data</span><span> </span><span id="CpeTyCoEnv"><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-var">CpeTyCoEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TCE"><span class="annot"><a href="GHC.CoreToStg.Prep.html#TCE"><span class="hs-identifier hs-var">TCE</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#CvSubstEnv"><span class="hs-identifier hs-type">CvSubstEnv</span></a></span><span>
</span><span id="line-2084"></span><span>
</span><span id="line-2085"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#emptyTCE"><span class="hs-identifier hs-type">emptyTCE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span>
</span><span id="line-2086"></span><span id="emptyTCE"><span class="annot"><span class="annottext">emptyTCE :: CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#emptyTCE"><span class="hs-identifier hs-var hs-var">emptyTCE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; CvSubstEnv -&gt; CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#TCE"><span class="hs-identifier hs-var">TCE</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="GHC.Core.TyCo.Subst.html#emptyTvSubstEnv"><span class="hs-identifier hs-var">emptyTvSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="GHC.Core.TyCo.Subst.html#emptyCvSubstEnv"><span class="hs-identifier hs-var">emptyCvSubstEnv</span></a></span><span>
</span><span id="line-2087"></span><span>
</span><span id="line-2088"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extend_tce_cv"><span class="hs-identifier hs-type">extend_tce_cv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span>
</span><span id="line-2089"></span><span id="extend_tce_cv"><span class="annot"><span class="annottext">extend_tce_cv :: CpeTyCoEnv -&gt; Id -&gt; Coercion -&gt; CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#extend_tce_cv"><span class="hs-identifier hs-var hs-var">extend_tce_cv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#TCE"><span class="hs-identifier hs-type">TCE</span></a></span><span> </span><span id="local-6989586621681998490"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681998490"><span class="hs-identifier hs-var">tv_env</span></a></span></span><span> </span><span id="local-6989586621681998491"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681998491"><span class="hs-identifier hs-var">cv_env</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998492"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998492"><span class="hs-identifier hs-var">cv</span></a></span></span><span> </span><span id="local-6989586621681998493"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998493"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-2090"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; CvSubstEnv -&gt; CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#TCE"><span class="hs-identifier hs-var">TCE</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681998490"><span class="hs-identifier hs-var">tv_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CvSubstEnv -&gt; Id -&gt; Coercion -&gt; CvSubstEnv
forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681998491"><span class="hs-identifier hs-var">cv_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998492"><span class="hs-identifier hs-var">cv</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998493"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2091"></span><span>
</span><span id="line-2092"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extend_tce_tv"><span class="hs-identifier hs-type">extend_tce_tv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span>
</span><span id="line-2093"></span><span id="extend_tce_tv"><span class="annot"><span class="annottext">extend_tce_tv :: CpeTyCoEnv -&gt; Id -&gt; Type -&gt; CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#extend_tce_tv"><span class="hs-identifier hs-var hs-var">extend_tce_tv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#TCE"><span class="hs-identifier hs-type">TCE</span></a></span><span> </span><span id="local-6989586621681998496"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681998496"><span class="hs-identifier hs-var">tv_env</span></a></span></span><span> </span><span id="local-6989586621681998497"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681998497"><span class="hs-identifier hs-var">cv_env</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998498"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998498"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621681998499"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998499"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-2094"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; CvSubstEnv -&gt; CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#TCE"><span class="hs-identifier hs-var">TCE</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TvSubstEnv -&gt; Id -&gt; Type -&gt; TvSubstEnv
forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681998496"><span class="hs-identifier hs-var">tv_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998498"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998499"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681998497"><span class="hs-identifier hs-var">cv_env</span></a></span><span>
</span><span id="line-2095"></span><span>
</span><span id="line-2096"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#lookup_tce_cv"><span class="hs-identifier hs-type">lookup_tce_cv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-2097"></span><span id="lookup_tce_cv"><span class="annot"><span class="annottext">lookup_tce_cv :: CpeTyCoEnv -&gt; Id -&gt; Coercion
</span><a href="GHC.CoreToStg.Prep.html#lookup_tce_cv"><span class="hs-identifier hs-var hs-var">lookup_tce_cv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#TCE"><span class="hs-identifier hs-type">TCE</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681998501"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681998501"><span class="hs-identifier hs-var">cv_env</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998502"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998502"><span class="hs-identifier hs-var">cv</span></a></span></span><span>
</span><span id="line-2098"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; Id -&gt; Maybe Coercion
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681998501"><span class="hs-identifier hs-var">cv_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998502"><span class="hs-identifier hs-var">cv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2099"></span><span>        </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681998503"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998503"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998503"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2100"></span><span>        </span><span class="annot"><span class="annottext">Maybe Coercion
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998502"><span class="hs-identifier hs-var">cv</span></a></span><span>
</span><span id="line-2101"></span><span>
</span><span id="line-2102"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#lookup_tce_tv"><span class="hs-identifier hs-type">lookup_tce_tv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-2103"></span><span id="lookup_tce_tv"><span class="annot"><span class="annottext">lookup_tce_tv :: CpeTyCoEnv -&gt; Id -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#lookup_tce_tv"><span class="hs-identifier hs-var hs-var">lookup_tce_tv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#TCE"><span class="hs-identifier hs-type">TCE</span></a></span><span> </span><span id="local-6989586621681998506"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681998506"><span class="hs-identifier hs-var">tv_env</span></a></span></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998507"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998507"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-2104"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; Id -&gt; Maybe Type
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681998506"><span class="hs-identifier hs-var">tv_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998507"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2105"></span><span>        </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681998508"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998508"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998508"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2106"></span><span>        </span><span class="annot"><span class="annottext">Maybe Type
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998507"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-2107"></span><span>
</span><span id="line-2108"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extendCoVarEnv"><span class="hs-identifier hs-type">extendCoVarEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span>
</span><span id="line-2109"></span><span id="extendCoVarEnv"><span class="annot"><span class="annottext">extendCoVarEnv :: CorePrepEnv -&gt; Id -&gt; Coercion -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCoVarEnv"><span class="hs-identifier hs-var hs-var">extendCoVarEnv</span></a></span></span><span> </span><span id="local-6989586621681998510"><span class="annot"><span class="annottext">cpe :: CorePrepEnv
</span><a href="#local-6989586621681998510"><span class="hs-identifier hs-var">cpe</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_tyco_env :: CorePrepEnv -&gt; Maybe CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#cpe_tyco_env"><span class="hs-identifier hs-var">cpe_tyco_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681998511"><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="#local-6989586621681998511"><span class="hs-identifier hs-var">mb_tce</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998512"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998512"><span class="hs-identifier hs-var">cv</span></a></span></span><span> </span><span id="local-6989586621681998513"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998513"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-2110"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998510"><span class="hs-identifier hs-var">cpe</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_tyco_env"><span class="hs-identifier hs-var">cpe_tyco_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#extend_tce_cv"><span class="hs-identifier hs-type">extend_tce_cv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681998514"><span class="hs-identifier hs-type">tce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681998512"><span class="hs-identifier hs-type">cv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681998513"><span class="hs-identifier hs-type">co</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2111"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2112"></span><span>    </span><span id="local-6989586621681998514"><span class="annot"><span class="annottext">tce :: CpeTyCoEnv
</span><a href="#local-6989586621681998514"><span class="hs-identifier hs-var hs-var">tce</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="#local-6989586621681998511"><span class="hs-identifier hs-var">mb_tce</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CpeTyCoEnv -&gt; CpeTyCoEnv -&gt; CpeTyCoEnv
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#emptyTCE"><span class="hs-identifier hs-var">emptyTCE</span></a></span><span>
</span><span id="line-2113"></span><span>
</span><span id="line-2114"></span><span>
</span><span id="line-2115"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-type">cpSubstTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-2116"></span><span id="cpSubstTy"><span class="annot"><span class="annottext">cpSubstTy :: CorePrepEnv -&gt; Type -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-var hs-var">cpSubstTy</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_tyco_env :: CorePrepEnv -&gt; Maybe CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#cpe_tyco_env"><span class="hs-identifier hs-var">cpe_tyco_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681998516"><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="#local-6989586621681998516"><span class="hs-identifier hs-var">mb_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998517"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998517"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-2117"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="#local-6989586621681998516"><span class="hs-identifier hs-var">mb_env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2118"></span><span>      </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681998518"><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998518"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Identity Type -&gt; Type
forall a. Identity a -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Functor.Identity.html#runIdentity/Data.Functor.Identity.html#runIdentity"><span class="hs-identifier hs-var">runIdentity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Type -&gt; Identity Type
</span><a href="GHC.CoreToStg.Prep.html#subst_ty"><span class="hs-identifier hs-var">subst_ty</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998518"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998517"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2119"></span><span>      </span><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998517"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2120"></span><span>
</span><span id="line-2121"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpSubstCo"><span class="hs-identifier hs-type">cpSubstCo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-2122"></span><span id="cpSubstCo"><span class="annot"><span class="annottext">cpSubstCo :: CorePrepEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.CoreToStg.Prep.html#cpSubstCo"><span class="hs-identifier hs-var hs-var">cpSubstCo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_tyco_env :: CorePrepEnv -&gt; Maybe CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#cpe_tyco_env"><span class="hs-identifier hs-var">cpe_tyco_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681998521"><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="#local-6989586621681998521"><span class="hs-identifier hs-var">mb_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998522"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998522"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-2123"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="#local-6989586621681998521"><span class="hs-identifier hs-var">mb_env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2124"></span><span>      </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681998523"><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998523"><span class="hs-identifier hs-var">tce</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Identity Coercion -&gt; Coercion
forall a. Identity a -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Functor.Identity.html#runIdentity/Data.Functor.Identity.html#runIdentity"><span class="hs-identifier hs-var">runIdentity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Coercion -&gt; Identity Coercion
</span><a href="GHC.CoreToStg.Prep.html#subst_co"><span class="hs-identifier hs-var">subst_co</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998523"><span class="hs-identifier hs-var">tce</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998522"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2125"></span><span>      </span><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681998522"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-2126"></span><span>
</span><span id="line-2127"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#subst_tyco_mapper"><span class="hs-identifier hs-type">subst_tyco_mapper</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#TyCoMapper"><span class="hs-identifier hs-type">TyCoMapper</span></a></span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Functor.Identity.html#Identity/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-type">Identity</span></a></span><span>
</span><span id="line-2128"></span><span id="subst_tyco_mapper"><span class="annot"><span class="annottext">subst_tyco_mapper :: TyCoMapper CpeTyCoEnv Identity
</span><a href="GHC.CoreToStg.Prep.html#subst_tyco_mapper"><span class="hs-identifier hs-var hs-var">subst_tyco_mapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#TyCoMapper"><span class="hs-identifier hs-type">TyCoMapper</span></a></span><span>
</span><span id="line-2129"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tcm_tyvar :: CpeTyCoEnv -&gt; Id -&gt; Identity Type
</span><a href="GHC.Core.Type.html#tcm_tyvar"><span class="hs-identifier hs-var">tcm_tyvar</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681998528"><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998528"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998529"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998529"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Identity Type
forall a. a -&gt; Identity a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Id -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#lookup_tce_tv"><span class="hs-identifier hs-var">lookup_tce_tv</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998528"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998529"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2130"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tcm_covar :: CpeTyCoEnv -&gt; Id -&gt; Identity Coercion
</span><a href="GHC.Core.Type.html#tcm_covar"><span class="hs-identifier hs-var">tcm_covar</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681998531"><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998531"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998532"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998532"><span class="hs-identifier hs-var">cv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Identity Coercion
forall a. a -&gt; Identity a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Id -&gt; Coercion
</span><a href="GHC.CoreToStg.Prep.html#lookup_tce_cv"><span class="hs-identifier hs-var">lookup_tce_cv</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998531"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998532"><span class="hs-identifier hs-var">cv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2131"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tcm_hole :: CpeTyCoEnv -&gt; CoercionHole -&gt; Identity Coercion
</span><a href="GHC.Core.Type.html#tcm_hole"><span class="hs-identifier hs-var">tcm_hole</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681998534"><span class="annot"><span class="annottext">CoercionHole
</span><a href="#local-6989586621681998534"><span class="hs-identifier hs-var">hole</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; Identity Coercion
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;subst_co_mapper:hole&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionHole -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionHole
</span><a href="#local-6989586621681998534"><span class="hs-identifier hs-var">hole</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2132"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tcm_tycobinder :: CpeTyCoEnv -&gt; Id -&gt; ForAllTyFlag -&gt; Identity (CpeTyCoEnv, Id)
</span><a href="GHC.Core.Type.html#tcm_tycobinder"><span class="hs-identifier hs-var">tcm_tycobinder</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681998536"><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998536"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998537"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998537"><span class="hs-identifier hs-var">tcv</span></a></span></span><span> </span><span id="local-6989586621681998538"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621681998538"><span class="hs-identifier hs-var">_vis</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998537"><span class="hs-identifier hs-var">tcv</span></a></span><span>
</span><span id="line-2133"></span><span>                                      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(CpeTyCoEnv, Id) -&gt; Identity (CpeTyCoEnv, Id)
forall a. a -&gt; Identity a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Id -&gt; (CpeTyCoEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#subst_tv_bndr"><span class="hs-identifier hs-var">subst_tv_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998536"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998537"><span class="hs-identifier hs-var">tcv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2134"></span><span>                                      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(CpeTyCoEnv, Id) -&gt; Identity (CpeTyCoEnv, Id)
forall a. a -&gt; Identity a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Id -&gt; (CpeTyCoEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#subst_cv_bndr"><span class="hs-identifier hs-var">subst_cv_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998536"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998537"><span class="hs-identifier hs-var">tcv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2135"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tcm_tycon :: TyCon -&gt; Identity TyCon
</span><a href="GHC.Core.Type.html#tcm_tycon"><span class="hs-identifier hs-var">tcm_tycon</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681998542"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681998542"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Identity TyCon
forall a. a -&gt; Identity a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681998542"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2136"></span><span>
</span><span id="line-2137"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#subst_ty"><span class="hs-identifier hs-type">subst_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Functor.Identity.html#Identity/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-type">Identity</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-2138"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#subst_co"><span class="hs-identifier hs-type">subst_co</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Functor.Identity.html#Identity/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-type">Identity</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-2139"></span><span class="hs-special">(</span><span id="subst_ty"><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Type -&gt; Identity Type
</span><a href="GHC.CoreToStg.Prep.html#subst_ty"><span class="hs-identifier hs-var">subst_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; [Type] -&gt; Identity [Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="subst_co"><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Coercion -&gt; Identity Coercion
</span><a href="GHC.CoreToStg.Prep.html#subst_co"><span class="hs-identifier hs-var">subst_co</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; [Coercion] -&gt; Identity [Coercion]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCoMapper CpeTyCoEnv Identity
-&gt; (CpeTyCoEnv -&gt; Type -&gt; Identity Type,
    CpeTyCoEnv -&gt; [Type] -&gt; Identity [Type],
    CpeTyCoEnv -&gt; Coercion -&gt; Identity Coercion,
    CpeTyCoEnv -&gt; [Coercion] -&gt; Identity [Coercion])
forall (m :: * -&gt; *) env.
Monad m =&gt;
TyCoMapper env m
-&gt; (env -&gt; Type -&gt; m Type, env -&gt; [Type] -&gt; m [Type],
    env -&gt; Coercion -&gt; m Coercion, env -&gt; [Coercion] -&gt; m [Coercion])
</span><a href="GHC.Core.Type.html#mapTyCoX"><span class="hs-identifier hs-var">mapTyCoX</span></a></span><span> </span><span class="annot"><span class="annottext">TyCoMapper CpeTyCoEnv Identity
</span><a href="GHC.CoreToStg.Prep.html#subst_tyco_mapper"><span class="hs-identifier hs-var">subst_tyco_mapper</span></a></span><span>
</span><span id="line-2140"></span><span>
</span><span id="line-2141"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpSubstTyVarBndr"><span class="hs-identifier hs-type">cpSubstTyVarBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2142"></span><span id="cpSubstTyVarBndr"><span class="annot"><span class="annottext">cpSubstTyVarBndr :: CorePrepEnv -&gt; Id -&gt; (CorePrepEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTyVarBndr"><span class="hs-identifier hs-var hs-var">cpSubstTyVarBndr</span></a></span></span><span> </span><span id="local-6989586621681998546"><span class="annot"><span class="annottext">env :: CorePrepEnv
</span><a href="#local-6989586621681998546"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_tyco_env :: CorePrepEnv -&gt; Maybe CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#cpe_tyco_env"><span class="hs-identifier hs-var">cpe_tyco_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681998547"><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="#local-6989586621681998547"><span class="hs-identifier hs-var">mb_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998548"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998548"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-2143"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="#local-6989586621681998547"><span class="hs-identifier hs-var">mb_env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2144"></span><span>      </span><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998546"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998548"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2145"></span><span>      </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681998549"><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998549"><span class="hs-identifier hs-var">tce</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998546"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_tyco_env"><span class="hs-identifier hs-var">cpe_tyco_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681998550"><span class="hs-identifier hs-type">tce'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998551"><span class="hs-identifier hs-var">tv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2146"></span><span>               </span><span class="hs-keyword">where</span><span>
</span><span id="line-2147"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621681998550"><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998550"><span class="hs-identifier hs-var">tce'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998551"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998551"><span class="hs-identifier hs-var">tv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Id -&gt; (CpeTyCoEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#subst_tv_bndr"><span class="hs-identifier hs-var">subst_tv_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998549"><span class="hs-identifier hs-var">tce</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998548"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-2148"></span><span>
</span><span id="line-2149"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#subst_tv_bndr"><span class="hs-identifier hs-type">subst_tv_bndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2150"></span><span id="subst_tv_bndr"><span class="annot"><span class="annottext">subst_tv_bndr :: CpeTyCoEnv -&gt; Id -&gt; (CpeTyCoEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#subst_tv_bndr"><span class="hs-identifier hs-var hs-var">subst_tv_bndr</span></a></span></span><span> </span><span id="local-6989586621681998552"><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998552"><span class="hs-identifier hs-var">tce</span></a></span></span><span> </span><span id="local-6989586621681998553"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998553"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-2151"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Id -&gt; Type -&gt; CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#extend_tce_tv"><span class="hs-identifier hs-var">extend_tce_tv</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998552"><span class="hs-identifier hs-var">tce</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998553"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998554"><span class="hs-identifier hs-var">tv'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998554"><span class="hs-identifier hs-var">tv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2152"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2153"></span><span>    </span><span id="local-6989586621681998554"><span class="annot"><span class="annottext">tv' :: Id
</span><a href="#local-6989586621681998554"><span class="hs-identifier hs-var hs-var">tv'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Id
</span><a href="GHC.Types.Var.html#mkTyVar"><span class="hs-identifier hs-var">mkTyVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Var.html#tyVarName"><span class="hs-identifier hs-var">tyVarName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998553"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998557"><span class="hs-identifier hs-var">kind'</span></a></span><span>
</span><span id="line-2154"></span><span>    </span><span id="local-6989586621681998557"><span class="annot"><span class="annottext">kind' :: Type
</span><a href="#local-6989586621681998557"><span class="hs-identifier hs-var hs-var">kind'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity Type -&gt; Type
forall a. Identity a -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Functor.Identity.html#runIdentity/Data.Functor.Identity.html#runIdentity"><span class="hs-identifier hs-var">runIdentity</span></a></span><span> </span><span class="annot"><span class="annottext">(Identity Type -&gt; Type) -&gt; Identity Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Type -&gt; Identity Type
</span><a href="GHC.CoreToStg.Prep.html#subst_ty"><span class="hs-identifier hs-var">subst_ty</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998552"><span class="hs-identifier hs-var">tce</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Identity Type) -&gt; Type -&gt; Identity Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998553"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-2155"></span><span>
</span><span id="line-2156"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpSubstCoVarBndr"><span class="hs-identifier hs-type">cpSubstCoVarBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2157"></span><span id="cpSubstCoVarBndr"><span class="annot"><span class="annottext">cpSubstCoVarBndr :: CorePrepEnv -&gt; Id -&gt; (CorePrepEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#cpSubstCoVarBndr"><span class="hs-identifier hs-var hs-var">cpSubstCoVarBndr</span></a></span></span><span> </span><span id="local-6989586621681998560"><span class="annot"><span class="annottext">env :: CorePrepEnv
</span><a href="#local-6989586621681998560"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CPE"><span class="hs-identifier hs-type">CPE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpe_tyco_env :: CorePrepEnv -&gt; Maybe CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#cpe_tyco_env"><span class="hs-identifier hs-var">cpe_tyco_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681998561"><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="#local-6989586621681998561"><span class="hs-identifier hs-var">mb_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998562"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998562"><span class="hs-identifier hs-var">cv</span></a></span></span><span>
</span><span id="line-2158"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="#local-6989586621681998561"><span class="hs-identifier hs-var">mb_env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2159"></span><span>      </span><span class="annot"><span class="annottext">Maybe CpeTyCoEnv
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998560"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998562"><span class="hs-identifier hs-var">cv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2160"></span><span>      </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681998563"><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998563"><span class="hs-identifier hs-var">tce</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998560"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpe_tyco_env"><span class="hs-identifier hs-var">cpe_tyco_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681998564"><span class="hs-identifier hs-type">tce'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998565"><span class="hs-identifier hs-var">cv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2161"></span><span>               </span><span class="hs-keyword">where</span><span>
</span><span id="line-2162"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621681998564"><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998564"><span class="hs-identifier hs-var">tce'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998565"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998565"><span class="hs-identifier hs-var">cv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Id -&gt; (CpeTyCoEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#subst_cv_bndr"><span class="hs-identifier hs-var">subst_cv_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998563"><span class="hs-identifier hs-var">tce</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998562"><span class="hs-identifier hs-var">cv</span></a></span><span>
</span><span id="line-2163"></span><span>
</span><span id="line-2164"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#subst_cv_bndr"><span class="hs-identifier hs-type">subst_cv_bndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CpeTyCoEnv"><span class="hs-identifier hs-type">CpeTyCoEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2165"></span><span id="subst_cv_bndr"><span class="annot"><span class="annottext">subst_cv_bndr :: CpeTyCoEnv -&gt; Id -&gt; (CpeTyCoEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#subst_cv_bndr"><span class="hs-identifier hs-var hs-var">subst_cv_bndr</span></a></span></span><span> </span><span id="local-6989586621681998566"><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998566"><span class="hs-identifier hs-var">tce</span></a></span></span><span> </span><span id="local-6989586621681998567"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998567"><span class="hs-identifier hs-var">cv</span></a></span></span><span>
</span><span id="line-2166"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Id -&gt; Coercion -&gt; CpeTyCoEnv
</span><a href="GHC.CoreToStg.Prep.html#extend_tce_cv"><span class="hs-identifier hs-var">extend_tce_cv</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998566"><span class="hs-identifier hs-var">tce</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998567"><span class="hs-identifier hs-var">cv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998568"><span class="hs-identifier hs-var">cv'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998568"><span class="hs-identifier hs-var">cv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2167"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2168"></span><span>    </span><span id="local-6989586621681998568"><span class="annot"><span class="annottext">cv' :: Id
</span><a href="#local-6989586621681998568"><span class="hs-identifier hs-var hs-var">cv'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; Id
</span><a href="GHC.Types.Var.html#mkCoVar"><span class="hs-identifier hs-var">mkCoVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Var.html#varName"><span class="hs-identifier hs-var">varName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998567"><span class="hs-identifier hs-var">cv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998571"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-2169"></span><span>    </span><span id="local-6989586621681998571"><span class="annot"><span class="annottext">ty' :: Type
</span><a href="#local-6989586621681998571"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity Type -&gt; Type
forall a. Identity a -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Functor.Identity.html#runIdentity/Data.Functor.Identity.html#runIdentity"><span class="hs-identifier hs-var">runIdentity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CpeTyCoEnv -&gt; Type -&gt; Identity Type
</span><a href="GHC.CoreToStg.Prep.html#subst_ty"><span class="hs-identifier hs-var">subst_ty</span></a></span><span> </span><span class="annot"><span class="annottext">CpeTyCoEnv
</span><a href="#local-6989586621681998566"><span class="hs-identifier hs-var">tce</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Identity Type) -&gt; Type -&gt; Identity Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998567"><span class="hs-identifier hs-var">cv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2170"></span><span>
</span><span id="line-2171"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2172"></span><span class="hs-comment">-- Cloning binders</span><span>
</span><span id="line-2173"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2174"></span><span>
</span><span id="line-2175"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-type">cpCloneBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2176"></span><span id="cpCloneBndrs"><span class="annot"><span class="annottext">cpCloneBndrs :: CorePrepEnv -&gt; [Id] -&gt; UniqSM (CorePrepEnv, [Id])
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndrs"><span class="hs-identifier hs-var hs-var">cpCloneBndrs</span></a></span></span><span> </span><span id="local-6989586621681998575"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998575"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998576"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998576"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CorePrepEnv -&gt; Id -&gt; UniqSM (CorePrepEnv, Id))
-&gt; CorePrepEnv -&gt; [Id] -&gt; UniqSM (CorePrepEnv, [Id])
forall (m :: * -&gt; *) (t :: * -&gt; *) acc x y.
(Monad m, Traversable t) =&gt;
(acc -&gt; x -&gt; m (acc, y)) -&gt; acc -&gt; t x -&gt; m (acc, t y)
</span><a href="GHC.Utils.Monad.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; UniqSM (CorePrepEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-var">cpCloneBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998575"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998576"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-2177"></span><span>
</span><span id="line-2178"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-type">cpCloneBndr</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2179"></span><span id="cpCloneBndr"><span class="annot"><span class="annottext">cpCloneBndr :: CorePrepEnv -&gt; Id -&gt; UniqSM (CorePrepEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#cpCloneBndr"><span class="hs-identifier hs-var hs-var">cpCloneBndr</span></a></span></span><span> </span><span id="local-6989586621681998577"><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998577"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681998578"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998578"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-2180"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998578"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2181"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CorePrepEnv, Id) -&gt; UniqSM (CorePrepEnv, Id)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; (CorePrepEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTyVarBndr"><span class="hs-identifier hs-var">cpSubstTyVarBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998577"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998578"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2182"></span><span>
</span><span id="line-2183"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998578"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2184"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CorePrepEnv, Id) -&gt; UniqSM (CorePrepEnv, Id)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; (CorePrepEnv, Id)
</span><a href="GHC.CoreToStg.Prep.html#cpSubstCoVarBndr"><span class="hs-identifier hs-var">cpSubstCoVarBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998577"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998578"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2185"></span><span>
</span><span id="line-2186"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2187"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681998580"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998580"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; UniqSM Id
</span><a href="#local-6989586621681998581"><span class="hs-identifier hs-var">clone_it</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998578"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2188"></span><span>
</span><span id="line-2189"></span><span>       </span><span class="hs-comment">-- Drop (now-useless) rules/unfoldings</span><span>
</span><span id="line-2190"></span><span>       </span><span class="hs-comment">-- See Note [Drop unfoldings and rules]</span><span>
</span><span id="line-2191"></span><span>       </span><span class="hs-comment">-- and Note [Preserve evaluatedness] in GHC.Core.Tidy</span><span>
</span><span id="line-2192"></span><span>       </span><span class="hs-comment">-- And force it.. otherwise the old unfolding is just retained.</span><span>
</span><span id="line-2193"></span><span>       </span><span class="hs-comment">-- See #22071</span><span>
</span><span id="line-2194"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681998582"><span class="annot"><span class="annottext">unfolding' :: Unfolding
</span><a href="#local-6989586621681998582"><span class="hs-identifier hs-var hs-var">unfolding'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Unfolding
</span><a href="GHC.Types.Id.Info.html#trimUnfolding"><span class="hs-identifier hs-var">trimUnfolding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Unfolding
</span><a href="GHC.Types.Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998578"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2195"></span><span>                          </span><span class="hs-comment">-- Simplifier will set the Id's unfolding</span><span>
</span><span id="line-2196"></span><span>
</span><span id="line-2197"></span><span>             </span><span id="local-6989586621681998585"><span class="annot"><span class="annottext">bndr'' :: Id
</span><a href="#local-6989586621681998585"><span class="hs-identifier hs-var hs-var">bndr''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998580"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unfolding -&gt; Id
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span>      </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681998582"><span class="hs-identifier hs-var">unfolding'</span></a></span><span>
</span><span id="line-2198"></span><span>                            </span><span class="annot"><span class="annottext">Id -&gt; RuleInfo -&gt; Id
</span><a href="GHC.Types.Id.html#setIdSpecialisation"><span class="hs-operator hs-var">`setIdSpecialisation`</span></a></span><span> </span><span class="annot"><span class="annottext">RuleInfo
</span><a href="GHC.Types.Id.Info.html#emptyRuleInfo"><span class="hs-identifier hs-var">emptyRuleInfo</span></a></span><span>
</span><span id="line-2199"></span><span>
</span><span id="line-2200"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(CorePrepEnv, Id) -&gt; UniqSM (CorePrepEnv, Id)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Id -&gt; Id -&gt; CorePrepEnv
</span><a href="GHC.CoreToStg.Prep.html#extendCorePrepEnv"><span class="hs-identifier hs-var">extendCorePrepEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998577"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998578"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998585"><span class="hs-identifier hs-var">bndr''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998585"><span class="hs-identifier hs-var">bndr''</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2201"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2202"></span><span>    </span><span id="local-6989586621681998581"><span class="annot"><span class="annottext">clone_it :: Id -&gt; UniqSM Id
</span><a href="#local-6989586621681998581"><span class="hs-identifier hs-var hs-var">clone_it</span></a></span></span><span> </span><span id="local-6989586621681998588"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998588"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-2203"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998588"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2204"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681998590"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681998590"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqSM Unique
forall (m :: * -&gt; *). MonadUnique m =&gt; m Unique
</span><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a></span><span>
</span><span id="line-2205"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681998592"><span class="annot"><span class="annottext">ty' :: Type
</span><a href="#local-6989586621681998592"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CorePrepEnv -&gt; Type -&gt; Type
</span><a href="GHC.CoreToStg.Prep.html#cpSubstTy"><span class="hs-identifier hs-var">cpSubstTy</span></a></span><span> </span><span class="annot"><span class="annottext">CorePrepEnv
</span><a href="#local-6989586621681998577"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998588"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2206"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; UniqSM Id
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Unique -&gt; Id
</span><a href="GHC.Types.Var.html#setVarUnique"><span class="hs-identifier hs-var">setVarUnique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type -&gt; Id
</span><a href="GHC.Types.Id.html#setIdType"><span class="hs-identifier hs-var">setIdType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998588"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998592"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681998590"><span class="hs-identifier hs-var">uniq</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2207"></span><span>
</span><span id="line-2208"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-comment">-- Top level things, which we don't want</span><span>
</span><span id="line-2209"></span><span>                    </span><span class="hs-comment">-- to clone, have become GlobalIds by now</span><span>
</span><span id="line-2210"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; UniqSM Id
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998588"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2211"></span><span>
</span><span id="line-2212"></span><span class="hs-comment">{- Note [Drop unfoldings and rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to drop the unfolding/rules on every Id:

  - We are now past interface-file generation, and in the
    codegen pipeline, so we really don't need full unfoldings/rules

  - The unfolding/rule may be keeping stuff alive that we'd like
    to discard.  See  Note [Dead code in CorePrep]

  - Getting rid of unnecessary unfoldings reduces heap usage

  - We are changing uniques, so if we didn't discard unfoldings/rules
    we'd have to substitute in them

HOWEVER, we want to preserve evaluated-ness;
see Note [Preserve evaluatedness] in GHC.Core.Tidy.
-}</span><span>
</span><span id="line-2230"></span><span>
</span><span id="line-2231"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2232"></span><span class="hs-comment">-- Cloning ccall Ids; each must have a unique name,</span><span>
</span><span id="line-2233"></span><span class="hs-comment">-- to give the code generator a handle to hang it on</span><span>
</span><span id="line-2234"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2235"></span><span>
</span><span id="line-2236"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#fiddleCCall"><span class="hs-identifier hs-type">fiddleCCall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-2237"></span><span id="fiddleCCall"><span class="annot"><span class="annottext">fiddleCCall :: Id -&gt; UniqSM Id
</span><a href="GHC.CoreToStg.Prep.html#fiddleCCall"><span class="hs-identifier hs-var hs-var">fiddleCCall</span></a></span></span><span> </span><span id="local-6989586621681998595"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998595"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-2238"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isFCallId"><span class="hs-identifier hs-var">isFCallId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998595"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998595"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique -&gt; Id
</span><a href="GHC.Types.Var.html#setVarUnique"><span class="hs-operator hs-var">`setVarUnique`</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Unique -&gt; Id) -&gt; UniqSM Unique -&gt; UniqSM Id
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSM Unique
forall (m :: * -&gt; *). MonadUnique m =&gt; m Unique
</span><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a></span><span>
</span><span id="line-2239"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; UniqSM Id
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998595"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-2240"></span><span>
</span><span id="line-2241"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2242"></span><span class="hs-comment">-- Generating new binders</span><span>
</span><span id="line-2243"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2244"></span><span>
</span><span id="line-2245"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#newVar"><span class="hs-identifier hs-type">newVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-2246"></span><span id="newVar"><span class="annot"><span class="annottext">newVar :: Type -&gt; UniqSM Id
</span><a href="GHC.CoreToStg.Prep.html#newVar"><span class="hs-identifier hs-var hs-var">newVar</span></a></span></span><span> </span><span id="local-6989586621681998598"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998598"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-2247"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ()
</span><a href="GHC.Core.Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998598"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; UniqSM Id -&gt; UniqSM Id
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">FastString -&gt; Type -&gt; Type -&gt; UniqSM Id
forall (m :: * -&gt; *).
MonadUnique m =&gt;
FastString -&gt; Type -&gt; Type -&gt; m Id
</span><a href="GHC.Types.Id.html#mkSysLocalOrCoVarM"><span class="hs-identifier hs-var">mkSysLocalOrCoVarM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sat&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681998598"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2248"></span><span>
</span><span id="line-2249"></span><span>
</span><span id="line-2250"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2251"></span><span class="hs-comment">-- Floating ticks</span><span>
</span><span id="line-2252"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2253"></span><span class="hs-comment">--</span><span>
</span><span id="line-2254"></span><span class="hs-comment">-- Note [Floating Ticks in CorePrep]</span><span>
</span><span id="line-2255"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-2256"></span><span class="hs-comment">-- It might seem counter-intuitive to float ticks by default, given</span><span>
</span><span id="line-2257"></span><span class="hs-comment">-- that we don't actually want to move them if we can help it. On the</span><span>
</span><span id="line-2258"></span><span class="hs-comment">-- other hand, nothing gets very far in CorePrep anyway, and we want</span><span>
</span><span id="line-2259"></span><span class="hs-comment">-- to preserve the order of let bindings and tick annotations in</span><span>
</span><span id="line-2260"></span><span class="hs-comment">-- relation to each other. For example, if we just wrapped let floats</span><span>
</span><span id="line-2261"></span><span class="hs-comment">-- when they pass through ticks, we might end up performing the</span><span>
</span><span id="line-2262"></span><span class="hs-comment">-- following transformation:</span><span>
</span><span id="line-2263"></span><span class="hs-comment">--</span><span>
</span><span id="line-2264"></span><span class="hs-comment">--   src&lt;...&gt; let foo = bar in baz</span><span>
</span><span id="line-2265"></span><span class="hs-comment">--   ==&gt;  let foo = src&lt;...&gt; bar in src&lt;...&gt; baz</span><span>
</span><span id="line-2266"></span><span class="hs-comment">--</span><span>
</span><span id="line-2267"></span><span class="hs-comment">-- Because the let-binding would float through the tick, and then</span><span>
</span><span id="line-2268"></span><span class="hs-comment">-- immediately materialize, achieving nothing but decreasing tick</span><span>
</span><span id="line-2269"></span><span class="hs-comment">-- accuracy. The only special case is the following scenario:</span><span>
</span><span id="line-2270"></span><span class="hs-comment">--</span><span>
</span><span id="line-2271"></span><span class="hs-comment">--   let foo = src&lt;...&gt; (let a = b in bar) in baz</span><span>
</span><span id="line-2272"></span><span class="hs-comment">--   ==&gt;  let foo = src&lt;...&gt; bar; a = src&lt;...&gt; b in baz</span><span>
</span><span id="line-2273"></span><span class="hs-comment">--</span><span>
</span><span id="line-2274"></span><span class="hs-comment">-- Here we would not want the source tick to end up covering &quot;baz&quot; and</span><span>
</span><span id="line-2275"></span><span class="hs-comment">-- therefore refrain from pushing ticks outside. Instead, we copy them</span><span>
</span><span id="line-2276"></span><span class="hs-comment">-- into the floating binds (here &quot;a&quot;) in cpePair. Note that where &quot;b&quot;</span><span>
</span><span id="line-2277"></span><span class="hs-comment">-- or &quot;bar&quot; are (value) lambdas we have to push the annotations</span><span>
</span><span id="line-2278"></span><span class="hs-comment">-- further inside in order to uphold our rules.</span><span>
</span><span id="line-2279"></span><span class="hs-comment">--</span><span>
</span><span id="line-2280"></span><span class="hs-comment">-- All of this is implemented below in @wrapTicks@.</span><span>
</span><span id="line-2281"></span><span>
</span><span id="line-2282"></span><span class="annot"><span class="hs-comment">-- | Like wrapFloats, but only wraps tick floats</span></span><span>
</span><span id="line-2283"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#wrapTicks"><span class="hs-identifier hs-type">wrapTicks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2284"></span><span id="wrapTicks"><span class="annot"><span class="annottext">wrapTicks :: Floats -&gt; CpeApp -&gt; (Floats, CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#wrapTicks"><span class="hs-identifier hs-var hs-var">wrapTicks</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a></span><span> </span><span id="local-6989586621681998603"><span class="annot"><span class="annottext">OkToSpec
</span><a href="#local-6989586621681998603"><span class="hs-identifier hs-var">flag</span></a></span></span><span> </span><span id="local-6989586621681998604"><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998604"><span class="hs-identifier hs-var">floats0</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998605"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998605"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2285"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OkToSpec -&gt; OrdList FloatingBind -&gt; Floats
</span><a href="GHC.CoreToStg.Prep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a></span><span> </span><span class="annot"><span class="annottext">OkToSpec
</span><a href="#local-6989586621681998603"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FloatingBind] -&gt; OrdList FloatingBind
forall a. [a] -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#toOL"><span class="hs-identifier hs-var">toOL</span></a></span><span> </span><span class="annot"><span class="annottext">([FloatingBind] -&gt; OrdList FloatingBind)
-&gt; [FloatingBind] -&gt; OrdList FloatingBind
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[FloatingBind] -&gt; [FloatingBind]
forall a. [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#reverse/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[FloatingBind]
</span><a href="#local-6989586621681998607"><span class="hs-identifier hs-var">floats1</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; CpeApp -&gt; CpeApp)
-&gt; CpeApp -&gt; [CoreTickish] -&gt; CpeApp
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998605"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; [CoreTickish]
forall a. [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#reverse/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998608"><span class="hs-identifier hs-var">ticks1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2286"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998607"><span class="annot"><span class="annottext">[FloatingBind]
</span><a href="#local-6989586621681998607"><span class="hs-identifier hs-var">floats1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998608"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998608"><span class="hs-identifier hs-var">ticks1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([FloatingBind], [CoreTickish])
 -&gt; FloatingBind -&gt; ([FloatingBind], [CoreTickish]))
-&gt; ([FloatingBind], [CoreTickish])
-&gt; OrdList FloatingBind
-&gt; ([FloatingBind], [CoreTickish])
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
</span><a href="GHC.Data.OrdList.html#foldlOL"><span class="hs-identifier hs-var">foldlOL</span></a></span><span> </span><span class="annot"><span class="annottext">([FloatingBind], [CoreTickish])
-&gt; FloatingBind -&gt; ([FloatingBind], [CoreTickish])
</span><a href="#local-6989586621681998610"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(OrdList FloatingBind -&gt; ([FloatingBind], [CoreTickish]))
-&gt; OrdList FloatingBind -&gt; ([FloatingBind], [CoreTickish])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList FloatingBind
</span><a href="#local-6989586621681998604"><span class="hs-identifier hs-var">floats0</span></a></span><span>
</span><span id="line-2287"></span><span>        </span><span class="hs-comment">-- Deeply nested constructors will produce long lists of</span><span>
</span><span id="line-2288"></span><span>        </span><span class="hs-comment">-- redundant source note floats here. We need to eliminate</span><span>
</span><span id="line-2289"></span><span>        </span><span class="hs-comment">-- those early, as relying on mkTick to spot it after the fact</span><span>
</span><span id="line-2290"></span><span>        </span><span class="hs-comment">-- can yield O(n^3) complexity [#11095]</span><span>
</span><span id="line-2291"></span><span>        </span><span id="local-6989586621681998610"><span class="annot"><span class="annottext">go :: ([FloatingBind], [CoreTickish])
-&gt; FloatingBind -&gt; ([FloatingBind], [CoreTickish])
</span><a href="#local-6989586621681998610"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998618"><span class="annot"><span class="annottext">[FloatingBind]
</span><a href="#local-6989586621681998618"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998619"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998619"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatTick"><span class="hs-identifier hs-type">FloatTick</span></a></span><span> </span><span id="local-6989586621681998620"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998620"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2292"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; ([FloatingBind], [CoreTickish])
-&gt; ([FloatingBind], [CoreTickish])
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; TickishPlacement
forall (pass :: TickishPass). GenTickish pass -&gt; TickishPlacement
</span><a href="GHC.Types.Tickish.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998620"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">TickishPlacement -&gt; TickishPlacement -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TickishPlacement
</span><a href="GHC.Types.Tickish.html#PlaceNonLam"><span class="hs-identifier hs-var">PlaceNonLam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2293"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FloatingBind]
</span><a href="#local-6989586621681998618"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; [CoreTickish] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#any/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreTickish -&gt; CoreTickish -&gt; Bool)
-&gt; CoreTickish -&gt; CoreTickish -&gt; Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#flip/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreTickish -&gt; Bool
forall (pass :: TickishPass).
Eq (GenTickish pass) =&gt;
GenTickish pass -&gt; GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishContains"><span class="hs-identifier hs-var">tickishContains</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998620"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998619"><span class="hs-identifier hs-var">ticks</span></a></span><span>
</span><span id="line-2294"></span><span>                     </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998619"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998620"><span class="hs-identifier hs-var">t</span></a></span><span class="annot"><span class="annottext">CoreTickish -&gt; [CoreTickish] -&gt; [CoreTickish]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998619"><span class="hs-identifier hs-var">ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2295"></span><span>        </span><span class="annot"><a href="#local-6989586621681998610"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681998625"><span class="annot"><span class="annottext">[FloatingBind]
</span><a href="#local-6989586621681998625"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681998626"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998626"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681998627"><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998627"><span class="hs-identifier hs-var">f</span></a></span></span><span>
</span><span id="line-2296"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreTickish -&gt; FloatingBind -&gt; FloatingBind)
-&gt; FloatingBind -&gt; [CoreTickish] -&gt; FloatingBind
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; FloatingBind -&gt; FloatingBind
</span><a href="#local-6989586621681998628"><span class="hs-identifier hs-var">wrap</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998627"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish] -&gt; [CoreTickish]
forall a. [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#reverse/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998626"><span class="hs-identifier hs-var">ticks</span></a></span><span class="hs-special">)</span><span class="annot"><span class="annottext">FloatingBind -&gt; [FloatingBind] -&gt; [FloatingBind]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[FloatingBind]
</span><a href="#local-6989586621681998625"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681998626"><span class="hs-identifier hs-var">ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2297"></span><span>
</span><span id="line-2298"></span><span>        </span><span id="local-6989586621681998628"><span class="annot"><span class="annottext">wrap :: CoreTickish -&gt; FloatingBind -&gt; FloatingBind
</span><a href="#local-6989586621681998628"><span class="hs-identifier hs-var hs-var">wrap</span></a></span></span><span> </span><span id="local-6989586621681998632"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998632"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-type">FloatLet</span></a></span><span> </span><span id="local-6989586621681998633"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681998633"><span class="hs-identifier hs-var">bind</span></a></span></span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreBind -&gt; CoreBind
</span><a href="#local-6989586621681998634"><span class="hs-identifier hs-var">wrapBind</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998632"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681998633"><span class="hs-identifier hs-var">bind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2299"></span><span>        </span><span class="annot"><a href="#local-6989586621681998628"><span class="hs-identifier hs-var">wrap</span></a></span><span> </span><span id="local-6989586621681998635"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998635"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.CoreToStg.Prep.html#FloatCase"><span class="hs-identifier hs-type">FloatCase</span></a></span><span> </span><span id="local-6989586621681998636"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998636"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621681998637"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998637"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681998638"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681998638"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621681998639"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998639"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681998640"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998640"><span class="hs-identifier hs-var">ok</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Id -&gt; AltCon -&gt; [Id] -&gt; Bool -&gt; FloatingBind
</span><a href="GHC.CoreToStg.Prep.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998635"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998636"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998637"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681998638"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681998639"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681998640"><span class="hs-identifier hs-var">ok</span></a></span><span>
</span><span id="line-2300"></span><span>        </span><span class="annot"><a href="#local-6989586621681998628"><span class="hs-identifier hs-var">wrap</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681998641"><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998641"><span class="hs-identifier hs-var">other</span></a></span></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; FloatingBind
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;wrapTicks: unexpected float!&quot;</span></span><span>
</span><span id="line-2301"></span><span>                                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatingBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FloatingBind
</span><a href="#local-6989586621681998641"><span class="hs-identifier hs-var">other</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2302"></span><span>        </span><span id="local-6989586621681998634"><span class="annot"><span class="annottext">wrapBind :: CoreTickish -&gt; CoreBind -&gt; CoreBind
</span><a href="#local-6989586621681998634"><span class="hs-identifier hs-var hs-var">wrapBind</span></a></span></span><span> </span><span id="local-6989586621681998644"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998644"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681998645"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998645"><span class="hs-identifier hs-var">binder</span></a></span></span><span> </span><span id="local-6989586621681998646"><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998646"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CpeApp -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998645"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998644"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998646"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2303"></span><span>        </span><span class="annot"><a href="#local-6989586621681998634"><span class="hs-identifier hs-var">wrapBind</span></a></span><span> </span><span id="local-6989586621681998647"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998647"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681998648"><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681998648"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CpeApp -&gt; CpeApp) -&gt; [(Id, CpeApp)] -&gt; [(Id, CpeApp)]
forall (f :: * -&gt; *) b c a.
Functor f =&gt;
(b -&gt; c) -&gt; f (a, b) -&gt; f (a, c)
</span><a href="GHC.Utils.Misc.html#mapSnd"><span class="hs-identifier hs-var">mapSnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CpeApp -&gt; CpeApp
</span><a href="GHC.Core.Utils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681998647"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Id, CpeApp)]
</span><a href="#local-6989586621681998648"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2304"></span><span>
</span><span id="line-2305"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-2306"></span><span class="hs-comment">-- Numeric literals</span><span>
</span><span id="line-2307"></span><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><span id="line-2308"></span><span>
</span><span id="line-2309"></span><span class="annot"><span class="hs-comment">-- | Create a function that converts Bignum literals into their final CoreExpr</span></span><span>
</span><span id="line-2310"></span><span class="annot"><a href="GHC.CoreToStg.Prep.html#mkConvertNumLiteral"><span class="hs-identifier hs-type">mkConvertNumLiteral</span></a></span><span>
</span><span id="line-2311"></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Platform.html#Platform"><span class="hs-identifier hs-type">Platform</span></a></span><span>
</span><span id="line-2312"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Home.html#HomeUnit"><span class="hs-identifier hs-type">HomeUnit</span></a></span><span>
</span><span id="line-2313"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Types.TyThing.html#TyThing"><span class="hs-identifier hs-type">TyThing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2314"></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Literal.html#LitNumType"><span class="hs-identifier hs-type">LitNumType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2315"></span><span id="mkConvertNumLiteral"><span class="annot"><span class="annottext">mkConvertNumLiteral :: Platform
-&gt; HomeUnit
-&gt; (Name -&gt; IO TyThing)
-&gt; IO (LitNumType -&gt; Integer -&gt; Maybe CpeApp)
</span><a href="GHC.CoreToStg.Prep.html#mkConvertNumLiteral"><span class="hs-identifier hs-var hs-var">mkConvertNumLiteral</span></a></span></span><span> </span><span id="local-6989586621681998650"><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621681998650"><span class="hs-identifier hs-var">platform</span></a></span></span><span> </span><span id="local-6989586621681998651"><span class="annot"><span class="annottext">HomeUnit
</span><a href="#local-6989586621681998651"><span class="hs-identifier hs-var">home_unit</span></a></span></span><span> </span><span id="local-6989586621681998652"><span class="annot"><span class="annottext">Name -&gt; IO TyThing
</span><a href="#local-6989586621681998652"><span class="hs-identifier hs-var">lookup_global</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2316"></span><span>   </span><span class="hs-keyword">let</span><span>
</span><span id="line-2317"></span><span>      </span><span id="local-6989586621681998653"><span class="annot"><span class="annottext">guardBignum :: IO Id -&gt; IO Id
</span><a href="#local-6989586621681998653"><span class="hs-identifier hs-var hs-var">guardBignum</span></a></span></span><span> </span><span id="local-6989586621681998654"><span class="annot"><span class="annottext">IO Id
</span><a href="#local-6989586621681998654"><span class="hs-identifier hs-var">act</span></a></span></span><span>
</span><span id="line-2318"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">HomeUnit -&gt; UnitId -&gt; Bool
</span><a href="GHC.Unit.Home.html#isHomeUnitInstanceOf"><span class="hs-identifier hs-var">isHomeUnitInstanceOf</span></a></span><span> </span><span class="annot"><span class="annottext">HomeUnit
</span><a href="#local-6989586621681998651"><span class="hs-identifier hs-var">home_unit</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="GHC.Unit.Types.html#primUnitId"><span class="hs-identifier hs-var">primUnitId</span></a></span><span>
</span><span id="line-2319"></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; IO Id
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; IO Id) -&gt; Id -&gt; IO Id
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; Id
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Bignum literals are not supported in ghc-prim&quot;</span></span><span>
</span><span id="line-2320"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">HomeUnit -&gt; UnitId -&gt; Bool
</span><a href="GHC.Unit.Home.html#isHomeUnitInstanceOf"><span class="hs-identifier hs-var">isHomeUnitInstanceOf</span></a></span><span> </span><span class="annot"><span class="annottext">HomeUnit
</span><a href="#local-6989586621681998651"><span class="hs-identifier hs-var">home_unit</span></a></span><span> </span><span class="annot"><span class="annottext">UnitId
</span><a href="GHC.Unit.Types.html#bignumUnitId"><span class="hs-identifier hs-var">bignumUnitId</span></a></span><span>
</span><span id="line-2321"></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; IO Id
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; IO Id) -&gt; Id -&gt; IO Id
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; Id
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Bignum literals are not supported in ghc-bignum&quot;</span></span><span>
</span><span id="line-2322"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Id
</span><a href="#local-6989586621681998654"><span class="hs-identifier hs-var">act</span></a></span><span>
</span><span id="line-2323"></span><span>
</span><span id="line-2324"></span><span>      </span><span id="local-6989586621681998659"><span class="annot"><span class="annottext">lookupBignumId :: Name -&gt; IO Id
</span><a href="#local-6989586621681998659"><span class="hs-identifier hs-var hs-var">lookupBignumId</span></a></span></span><span> </span><span id="local-6989586621681998660"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681998660"><span class="hs-identifier hs-var">n</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Id -&gt; IO Id
</span><a href="#local-6989586621681998653"><span class="hs-identifier hs-var">guardBignum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; TyThing -&gt; Id
TyThing -&gt; Id
</span><a href="GHC.Types.TyThing.html#tyThingId"><span class="hs-identifier hs-var">tyThingId</span></a></span><span> </span><span class="annot"><span class="annottext">(TyThing -&gt; Id) -&gt; IO TyThing -&gt; IO Id
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; IO TyThing
</span><a href="#local-6989586621681998652"><span class="hs-identifier hs-var">lookup_global</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681998660"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2325"></span><span>
</span><span id="line-2326"></span><span>   </span><span class="hs-comment">-- The lookup is done here but the failure (panic) is reported lazily when we</span><span>
</span><span id="line-2327"></span><span>   </span><span class="hs-comment">-- try to access the `bigNatFromWordList` function.</span><span>
</span><span id="line-2328"></span><span>   </span><span class="hs-comment">--</span><span>
</span><span id="line-2329"></span><span>   </span><span class="hs-comment">-- If we ever get built-in ByteArray# literals, we could avoid the lookup by</span><span>
</span><span id="line-2330"></span><span>   </span><span class="hs-comment">-- directly using the Integer/Natural wired-in constructors for big numbers.</span><span>
</span><span id="line-2331"></span><span>
</span><span id="line-2332"></span><span>   </span><span id="local-6989586621681998662"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998662"><span class="hs-identifier hs-var">bignatFromWordListId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; IO Id
</span><a href="#local-6989586621681998659"><span class="hs-identifier hs-var">lookupBignumId</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#bignatFromWordListName"><span class="hs-identifier hs-var">bignatFromWordListName</span></a></span><span>
</span><span id="line-2333"></span><span>
</span><span id="line-2334"></span><span>   </span><span class="hs-keyword">let</span><span>
</span><span id="line-2335"></span><span>      </span><span id="local-6989586621681998664"><span class="annot"><span class="annottext">convertNumLit :: LitNumType -&gt; Integer -&gt; Maybe CpeApp
</span><a href="#local-6989586621681998664"><span class="hs-identifier hs-var hs-var">convertNumLit</span></a></span></span><span> </span><span id="local-6989586621681998665"><span class="annot"><span class="annottext">LitNumType
</span><a href="#local-6989586621681998665"><span class="hs-identifier hs-var">nt</span></a></span></span><span> </span><span id="local-6989586621681998666"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681998666"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LitNumType
</span><a href="#local-6989586621681998665"><span class="hs-identifier hs-var">nt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2336"></span><span>         </span><span class="annot"><span class="annottext">LitNumType
</span><a href="GHC.Types.Literal.html#LitNumBigNat"><span class="hs-identifier hs-var">LitNumBigNat</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; Maybe CpeApp
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; CpeApp
</span><a href="#local-6989586621681998668"><span class="hs-identifier hs-var">convertBignatPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681998666"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2337"></span><span>         </span><span class="annot"><span class="annottext">LitNumType
</span><span class="hs-identifier">_</span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe CpeApp
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2338"></span><span>
</span><span id="line-2339"></span><span>      </span><span id="local-6989586621681998668"><span class="annot"><span class="annottext">convertBignatPrim :: Integer -&gt; CpeApp
</span><a href="#local-6989586621681998668"><span class="hs-identifier hs-var hs-var">convertBignatPrim</span></a></span></span><span> </span><span id="local-6989586621681998669"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681998669"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2340"></span><span>         </span><span class="hs-keyword">let</span><span>
</span><span id="line-2341"></span><span>            </span><span class="hs-comment">-- ByteArray# literals aren't supported (yet). Were they supported,</span><span>
</span><span id="line-2342"></span><span>            </span><span class="hs-comment">-- we would use them directly. We would need to handle</span><span>
</span><span id="line-2343"></span><span>            </span><span class="hs-comment">-- wordSize/endianness conversion between host and target</span><span>
</span><span id="line-2344"></span><span>            </span><span class="hs-comment">-- wordSize  = platformWordSize platform</span><span>
</span><span id="line-2345"></span><span>            </span><span class="hs-comment">-- byteOrder = platformByteOrder platform</span><span>
</span><span id="line-2346"></span><span>
</span><span id="line-2347"></span><span>            </span><span class="hs-comment">-- For now we build a list of Words and we produce</span><span>
</span><span id="line-2348"></span><span>            </span><span class="hs-comment">-- `bigNatFromWordList# list_of_words`</span><span>
</span><span id="line-2349"></span><span>
</span><span id="line-2350"></span><span>            </span><span id="local-6989586621681998670"><span class="annot"><span class="annottext">words :: CpeApp
</span><a href="#local-6989586621681998670"><span class="hs-identifier hs-var hs-var">words</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [CpeApp] -&gt; CpeApp
</span><a href="GHC.Core.Make.html#mkListExpr"><span class="hs-identifier hs-var">mkListExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#wordTy"><span class="hs-identifier hs-var">wordTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CpeApp] -&gt; [CpeApp]
forall a. [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#reverse/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Integer -&gt; Maybe (CpeApp, Integer)) -&gt; Integer -&gt; [CpeApp]
forall b a. (b -&gt; Maybe (a, b)) -&gt; b -&gt; [a]
</span><a href="../../base-4.18.3.0/src/Data.OldList.html#unfoldr/Data.OldList.html#unfoldr"><span class="hs-identifier hs-var">unfoldr</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Maybe (CpeApp, Integer)
</span><a href="#local-6989586621681998673"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681998669"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2351"></span><span>               </span><span class="hs-keyword">where</span><span>
</span><span id="line-2352"></span><span>                  </span><span id="local-6989586621681998673"><span class="annot"><span class="annottext">f :: Integer -&gt; Maybe (CpeApp, Integer)
</span><a href="#local-6989586621681998673"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (CpeApp, Integer)
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2353"></span><span>                  </span><span class="annot"><a href="#local-6989586621681998673"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span id="local-6989586621681998674"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681998674"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681998675"><span class="annot"><span class="annottext">low :: Integer
</span><a href="#local-6989586621681998675"><span class="hs-identifier hs-var hs-var">low</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681998674"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Bits.html#.%26./GHC.Bits.html#.%26."><span class="hs-operator hs-var">.&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681998677"><span class="hs-identifier hs-var">mask</span></a></span><span>
</span><span id="line-2354"></span><span>                            </span><span id="local-6989586621681998678"><span class="annot"><span class="annottext">high :: Integer
</span><a href="#local-6989586621681998678"><span class="hs-identifier hs-var hs-var">high</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681998674"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Integer
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="GHC.Prelude.Basic.html#shiftR"><span class="hs-operator hs-var">`shiftR`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998680"><span class="hs-identifier hs-var">bits</span></a></span><span>
</span><span id="line-2355"></span><span>                        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(CpeApp, Integer) -&gt; Maybe (CpeApp, Integer)
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [CpeApp] -&gt; CpeApp
forall b. DataCon -&gt; [Arg b] -&gt; Arg b
</span><a href="GHC.Core.html#mkConApp"><span class="hs-identifier hs-var">mkConApp</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="GHC.Builtin.Types.html#wordDataCon"><span class="hs-identifier hs-var">wordDataCon</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Literal -&gt; CpeApp
forall b. Literal -&gt; Expr b
</span><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-var">Lit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Platform -&gt; Integer -&gt; Literal
</span><a href="GHC.Types.Literal.html#mkLitWord"><span class="hs-identifier hs-var">mkLitWord</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621681998650"><span class="hs-identifier hs-var">platform</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681998675"><span class="hs-identifier hs-var">low</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681998678"><span class="hs-identifier hs-var">high</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2356"></span><span>                  </span><span id="local-6989586621681998680"><span class="annot"><span class="annottext">bits :: Int
</span><a href="#local-6989586621681998680"><span class="hs-identifier hs-var hs-var">bits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Platform -&gt; Int
</span><a href="GHC.Platform.html#platformWordSizeInBits"><span class="hs-identifier hs-var">platformWordSizeInBits</span></a></span><span> </span><span class="annot"><span class="annottext">Platform
</span><a href="#local-6989586621681998650"><span class="hs-identifier hs-var">platform</span></a></span><span>
</span><span id="line-2357"></span><span>                  </span><span id="local-6989586621681998677"><span class="annot"><span class="annottext">mask :: Integer
</span><a href="#local-6989586621681998677"><span class="hs-identifier hs-var hs-var">mask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int -&gt; Integer
forall a b. (Num a, Integral b) =&gt; a -&gt; b -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Real.html#%5E/GHC.Real.html#%5E"><span class="hs-operator hs-var">^</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681998680"><span class="hs-identifier hs-var">bits</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#-/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span>
</span><span id="line-2358"></span><span>
</span><span id="line-2359"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">CpeApp -&gt; [CpeApp] -&gt; CpeApp
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CpeApp
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681998662"><span class="hs-identifier hs-var">bignatFromWordListId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CpeApp
</span><a href="#local-6989586621681998670"><span class="hs-identifier hs-var">words</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2360"></span><span>
</span><span id="line-2361"></span><span>
</span><span id="line-2362"></span><span>   </span><span class="annot"><span class="annottext">(LitNumType -&gt; Integer -&gt; Maybe CpeApp)
-&gt; IO (LitNumType -&gt; Integer -&gt; Maybe CpeApp)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">LitNumType -&gt; Integer -&gt; Maybe CpeApp
</span><a href="#local-6989586621681998664"><span class="hs-identifier hs-var">convertNumLit</span></a></span><span>
</span><span id="line-2363"></span></pre></body></html>