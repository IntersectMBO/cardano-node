<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-record-updates #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="annot"><span class="hs-comment">-- | Unfolding creation</span></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Core.Unfold.Make</span><span>
</span><span id="line-5"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.html#noUnfolding"><span class="hs-identifier">noUnfolding</span></a></span><span>
</span><span id="line-6"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkUnfolding"><span class="hs-identifier">mkUnfolding</span></a></span><span>
</span><span id="line-7"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkCoreUnfolding"><span class="hs-identifier">mkCoreUnfolding</span></a></span><span>
</span><span id="line-8"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkFinalUnfolding"><span class="hs-identifier">mkFinalUnfolding</span></a></span><span>
</span><span id="line-9"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkFinalUnfolding%27"><span class="hs-identifier">mkFinalUnfolding'</span></a></span><span>
</span><span id="line-10"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkSimpleUnfolding"><span class="hs-identifier">mkSimpleUnfolding</span></a></span><span>
</span><span id="line-11"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkWorkerUnfolding"><span class="hs-identifier">mkWorkerUnfolding</span></a></span><span>
</span><span id="line-12"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkInlineUnfoldingWithArity"><span class="hs-identifier">mkInlineUnfoldingWithArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkInlineUnfoldingNoArity"><span class="hs-identifier">mkInlineUnfoldingNoArity</span></a></span><span>
</span><span id="line-13"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkInlinableUnfolding"><span class="hs-identifier">mkInlinableUnfolding</span></a></span><span>
</span><span id="line-14"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkWrapperUnfolding"><span class="hs-identifier">mkWrapperUnfolding</span></a></span><span>
</span><span id="line-15"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkCompulsoryUnfolding"><span class="hs-identifier">mkCompulsoryUnfolding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkCompulsoryUnfolding%27"><span class="hs-identifier">mkCompulsoryUnfolding'</span></a></span><span>
</span><span id="line-16"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkDFunUnfolding"><span class="hs-identifier">mkDFunUnfolding</span></a></span><span>
</span><span id="line-17"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkDataConUnfolding"><span class="hs-identifier">mkDataConUnfolding</span></a></span><span>
</span><span id="line-18"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#specUnfolding"><span class="hs-identifier">specUnfolding</span></a></span><span>
</span><span id="line-19"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#certainlyWillInline"><span class="hs-identifier">certainlyWillInline</span></a></span><span>
</span><span id="line-20"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">where</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html"><span class="hs-identifier">GHC.Core.Unfold</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html"><span class="hs-identifier">GHC.Core.Opt.OccurAnal</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier">occurAnalyseExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html"><span class="hs-identifier">GHC.Core.Opt.Arity</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier">manifestArity</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier">DmdSig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#isDeadEndSig"><span class="hs-identifier">isDeadEndSig</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Maybe.html#/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Maybe.html#fromMaybe/Data.Maybe.html#fromMaybe"><span class="hs-identifier">fromMaybe</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-comment">-- the very simple optimiser is used to optimise unfoldings</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html"><span class="hs-identifier">GHC.Core.SimpleOpt</span></a></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkFinalUnfolding"><span class="hs-identifier hs-type">mkFinalUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#UnfoldingSource"><span class="hs-identifier hs-type">UnfoldingSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-47"></span><span class="hs-comment">-- &quot;Final&quot; in the sense that this is a GlobalId that will not be further</span><span>
</span><span id="line-48"></span><span class="hs-comment">-- simplified; so the unfolding should be occurrence-analysed</span><span>
</span><span id="line-49"></span><span id="mkFinalUnfolding"><span class="annot"><span class="annottext">mkFinalUnfolding :: UnfoldingOpts -&gt; UnfoldingSource -&gt; DmdSig -&gt; CoreArg -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkFinalUnfolding"><span class="hs-identifier hs-var hs-var">mkFinalUnfolding</span></a></span></span><span> </span><span id="local-6989586621681822081"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621681822081"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822082"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822082"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621681822083"><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681822083"><span class="hs-identifier hs-var">strict_sig</span></a></span></span><span> </span><span id="local-6989586621681822084"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822084"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
-&gt; UnfoldingSource
-&gt; DmdSig
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkFinalUnfolding%27"><span class="hs-identifier hs-var">mkFinalUnfolding'</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621681822081"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822082"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681822083"><span class="hs-identifier hs-var">strict_sig</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822084"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-comment">-- See Note [Tying the 'CoreUnfolding' knot] for why interfaces need</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- to pass a precomputed 'UnfoldingCache'</span><span>
</span><span id="line-53"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkFinalUnfolding%27"><span class="hs-identifier hs-type">mkFinalUnfolding'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#UnfoldingSource"><span class="hs-identifier hs-type">UnfoldingSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#UnfoldingCache"><span class="hs-identifier hs-type">UnfoldingCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-54"></span><span class="hs-comment">-- &quot;Final&quot; in the sense that this is a GlobalId that will not be further</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- simplified; so the unfolding should be occurrence-analysed</span><span>
</span><span id="line-56"></span><span id="mkFinalUnfolding%27"><span class="annot"><span class="annottext">mkFinalUnfolding' :: UnfoldingOpts
-&gt; UnfoldingSource
-&gt; DmdSig
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkFinalUnfolding%27"><span class="hs-identifier hs-var hs-var">mkFinalUnfolding'</span></a></span></span><span> </span><span id="local-6989586621681822085"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621681822085"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822086"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822086"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621681822087"><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681822087"><span class="hs-identifier hs-var">strict_sig</span></a></span></span><span> </span><span id="local-6989586621681822088"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822088"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
-&gt; UnfoldingSource
-&gt; Bool
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkUnfolding"><span class="hs-identifier hs-var">mkUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621681822085"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822086"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-58"></span><span>                </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">{- Top level -}</span><span>
</span><span id="line-59"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdSig -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndSig"><span class="hs-identifier hs-var">isDeadEndSig</span></a></span><span> </span><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681822087"><span class="hs-identifier hs-var">strict_sig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>                </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822088"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="annot"><span class="hs-comment">-- | Same as 'mkCompulsoryUnfolding' but simplifies the unfolding first</span></span><span>
</span><span id="line-63"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkCompulsoryUnfolding%27"><span class="hs-identifier hs-type">mkCompulsoryUnfolding'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#SimpleOpts"><span class="hs-identifier hs-type">SimpleOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-64"></span><span id="mkCompulsoryUnfolding%27"><span class="annot"><span class="annottext">mkCompulsoryUnfolding' :: SimpleOpts -&gt; CoreArg -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCompulsoryUnfolding%27"><span class="hs-identifier hs-var hs-var">mkCompulsoryUnfolding'</span></a></span></span><span> </span><span id="local-6989586621681822089"><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822089"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822090"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822090"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCompulsoryUnfolding"><span class="hs-identifier hs-var">mkCompulsoryUnfolding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; SimpleOpts -&gt; CoreArg -&gt; CoreArg
SimpleOpts -&gt; CoreArg -&gt; CoreArg
</span><a href="GHC.Core.SimpleOpt.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822089"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822090"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="annot"><span class="hs-comment">-- | Used for things that absolutely must be unfolded</span></span><span>
</span><span id="line-67"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkCompulsoryUnfolding"><span class="hs-identifier hs-type">mkCompulsoryUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-68"></span><span id="mkCompulsoryUnfolding"><span class="annot"><span class="annottext">mkCompulsoryUnfolding :: CoreArg -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCompulsoryUnfolding"><span class="hs-identifier hs-var hs-var">mkCompulsoryUnfolding</span></a></span></span><span> </span><span id="local-6989586621681822092"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822092"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; UnfoldingGuidance
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCoreUnfolding"><span class="hs-identifier hs-var">mkCoreUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="GHC.Types.Basic.html#CompulsorySrc"><span class="hs-identifier hs-var">CompulsorySrc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-70"></span><span>                    </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822092"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-71"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#UnfWhen"><span class="hs-identifier hs-type">UnfWhen</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ug_arity :: ArityInfo
</span><a href="GHC.Core.html#ug_arity"><span class="hs-identifier hs-var">ug_arity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityInfo
</span><span class="hs-number">0</span></span><span>    </span><span class="hs-comment">-- Arity of unfolding doesn't matter</span><span>
</span><span id="line-72"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_unsat_ok :: Bool
</span><a href="GHC.Core.html#ug_unsat_ok"><span class="hs-identifier hs-var">ug_unsat_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.html#unSaturatedOk"><span class="hs-identifier hs-var">unSaturatedOk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_boring_ok :: Bool
</span><a href="GHC.Core.html#ug_boring_ok"><span class="hs-identifier hs-var">ug_boring_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.html#boringCxtOk"><span class="hs-identifier hs-var">boringCxtOk</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-comment">-- Note [Top-level flag on inline rules]</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- Slight hack: note that mk_inline_rules conservatively sets the</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- top-level flag to True.  It gets set more accurately by the simplifier</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- Simplify.simplUnfolding.</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkSimpleUnfolding"><span class="hs-identifier hs-type">mkSimpleUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-81"></span><span id="mkSimpleUnfolding"><span class="annot"><span class="annottext">mkSimpleUnfolding :: UnfoldingOpts -&gt; CoreArg -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkSimpleUnfolding"><span class="hs-identifier hs-var hs-var">mkSimpleUnfolding</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681822100"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621681822100"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822101"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822101"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
-&gt; UnfoldingSource
-&gt; Bool
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkUnfolding"><span class="hs-identifier hs-var">mkUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621681822100"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="GHC.Types.Basic.html#VanillaSrc"><span class="hs-identifier hs-var">VanillaSrc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822101"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkDFunUnfolding"><span class="hs-identifier hs-type">mkDFunUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-85"></span><span id="mkDFunUnfolding"><span class="annot"><span class="annottext">mkDFunUnfolding :: [Var] -&gt; DataCon -&gt; [CoreArg] -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkDFunUnfolding"><span class="hs-identifier hs-var hs-var">mkDFunUnfolding</span></a></span></span><span> </span><span id="local-6989586621681822103"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681822103"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621681822104"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681822104"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621681822105"><span class="annot"><span class="annottext">[CoreArg]
</span><a href="#local-6989586621681822105"><span class="hs-identifier hs-var">ops</span></a></span></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#DFunUnfolding"><span class="hs-identifier hs-type">DFunUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">df_bndrs :: [Var]
</span><a href="GHC.Core.html#df_bndrs"><span class="hs-identifier hs-var">df_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681822103"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-87"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">df_con :: DataCon
</span><a href="GHC.Core.html#df_con"><span class="hs-identifier hs-var">df_con</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681822104"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-88"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">df_args :: [CoreArg]
</span><a href="GHC.Core.html#df_args"><span class="hs-identifier hs-var">df_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreArg -&gt; CoreArg) -&gt; [CoreArg] -&gt; [CoreArg]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; CoreArg
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreArg]
</span><a href="#local-6989586621681822105"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-89"></span><span>                  </span><span class="hs-comment">-- See Note [Occurrence analysis of unfoldings]</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkDataConUnfolding"><span class="hs-identifier hs-type">mkDataConUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-92"></span><span class="hs-comment">-- Used for non-newtype data constructors with non-trivial wrappers</span><span>
</span><span id="line-93"></span><span id="mkDataConUnfolding"><span class="annot"><span class="annottext">mkDataConUnfolding :: CoreArg -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkDataConUnfolding"><span class="hs-identifier hs-var hs-var">mkDataConUnfolding</span></a></span></span><span> </span><span id="local-6989586621681822110"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822110"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; UnfoldingGuidance
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCoreUnfolding"><span class="hs-identifier hs-var">mkCoreUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="GHC.Types.Basic.html#StableSystemSrc"><span class="hs-identifier hs-var">StableSystemSrc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822110"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621681822112"><span class="hs-identifier hs-var">guide</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-comment">-- No need to simplify the expression</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-97"></span><span>    </span><span id="local-6989586621681822112"><span class="annot"><span class="annottext">guide :: UnfoldingGuidance
</span><a href="#local-6989586621681822112"><span class="hs-identifier hs-var hs-var">guide</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfWhen"><span class="hs-identifier hs-type">UnfWhen</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ug_arity :: ArityInfo
</span><a href="GHC.Core.html#ug_arity"><span class="hs-identifier hs-var">ug_arity</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; ArityInfo
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822110"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-98"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_unsat_ok :: Bool
</span><a href="GHC.Core.html#ug_unsat_ok"><span class="hs-identifier hs-var">ug_unsat_ok</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.html#unSaturatedOk"><span class="hs-identifier hs-var">unSaturatedOk</span></a></span><span>
</span><span id="line-99"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_boring_ok :: Bool
</span><a href="GHC.Core.html#ug_boring_ok"><span class="hs-identifier hs-var">ug_boring_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkWrapperUnfolding"><span class="hs-identifier hs-type">mkWrapperUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#SimpleOpts"><span class="hs-identifier hs-type">SimpleOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-102"></span><span class="hs-comment">-- Make the unfolding for the wrapper in a worker/wrapper split</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- after demand/CPR analysis</span><span>
</span><span id="line-104"></span><span id="mkWrapperUnfolding"><span class="annot"><span class="annottext">mkWrapperUnfolding :: SimpleOpts -&gt; CoreArg -&gt; ArityInfo -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkWrapperUnfolding"><span class="hs-identifier hs-var hs-var">mkWrapperUnfolding</span></a></span></span><span> </span><span id="local-6989586621681822114"><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822114"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822115"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822115"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621681822116"><span class="annot"><span class="annottext">ArityInfo
</span><a href="#local-6989586621681822116"><span class="hs-identifier hs-var">arity</span></a></span></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; UnfoldingGuidance
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCoreUnfolding"><span class="hs-identifier hs-var">mkCoreUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="GHC.Types.Basic.html#StableSystemSrc"><span class="hs-identifier hs-var">StableSystemSrc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-106"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; SimpleOpts -&gt; CoreArg -&gt; CoreArg
SimpleOpts -&gt; CoreArg -&gt; CoreArg
</span><a href="GHC.Core.SimpleOpt.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822114"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822115"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-107"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#UnfWhen"><span class="hs-identifier hs-type">UnfWhen</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ug_arity :: ArityInfo
</span><a href="GHC.Core.html#ug_arity"><span class="hs-identifier hs-var">ug_arity</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityInfo
</span><a href="#local-6989586621681822116"><span class="hs-identifier hs-var">arity</span></a></span><span>
</span><span id="line-108"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_unsat_ok :: Bool
</span><a href="GHC.Core.html#ug_unsat_ok"><span class="hs-identifier hs-var">ug_unsat_ok</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.html#unSaturatedOk"><span class="hs-identifier hs-var">unSaturatedOk</span></a></span><span>
</span><span id="line-109"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_boring_ok :: Bool
</span><a href="GHC.Core.html#ug_boring_ok"><span class="hs-identifier hs-var">ug_boring_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.html#boringCxtNotOk"><span class="hs-identifier hs-var">boringCxtNotOk</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkWorkerUnfolding"><span class="hs-identifier hs-type">mkWorkerUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#SimpleOpts"><span class="hs-identifier hs-type">SimpleOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-112"></span><span class="hs-comment">-- See Note [Worker/wrapper for INLINABLE functions] in GHC.Core.Opt.WorkWrap</span><span>
</span><span id="line-113"></span><span id="mkWorkerUnfolding"><span class="annot"><span class="annottext">mkWorkerUnfolding :: SimpleOpts -&gt; (CoreArg -&gt; CoreArg) -&gt; Unfolding -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkWorkerUnfolding"><span class="hs-identifier hs-var hs-var">mkWorkerUnfolding</span></a></span></span><span> </span><span id="local-6989586621681822118"><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822118"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822119"><span class="annot"><span class="annottext">CoreArg -&gt; CoreArg
</span><a href="#local-6989586621681822119"><span class="hs-identifier hs-var">work_fn</span></a></span></span><span>
</span><span id="line-114"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_src :: Unfolding -&gt; UnfoldingSource
</span><a href="GHC.Core.html#uf_src"><span class="hs-identifier hs-var">uf_src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822122"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822122"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_tmpl :: Unfolding -&gt; CoreArg
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822124"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822124"><span class="hs-identifier hs-var">tmpl</span></a></span></span><span>
</span><span id="line-115"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_is_top :: Unfolding -&gt; Bool
</span><a href="GHC.Core.html#uf_is_top"><span class="hs-identifier hs-var">uf_is_top</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822126"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822126"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource -&gt; Bool
</span><a href="GHC.Types.Basic.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822122"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; UnfoldingGuidance
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCoreUnfolding"><span class="hs-identifier hs-var">mkCoreUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822122"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822126"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822128"><span class="hs-identifier hs-var">new_tmpl</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621681822129"><span class="hs-identifier hs-var">guidance</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-119"></span><span>    </span><span id="local-6989586621681822128"><span class="annot"><span class="annottext">new_tmpl :: CoreArg
</span><a href="#local-6989586621681822128"><span class="hs-identifier hs-var hs-var">new_tmpl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; SimpleOpts -&gt; CoreArg -&gt; CoreArg
SimpleOpts -&gt; CoreArg -&gt; CoreArg
</span><a href="GHC.Core.SimpleOpt.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822118"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreArg -&gt; CoreArg
</span><a href="#local-6989586621681822119"><span class="hs-identifier hs-var">work_fn</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822124"><span class="hs-identifier hs-var">tmpl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>    </span><span id="local-6989586621681822129"><span class="annot"><span class="annottext">guidance :: UnfoldingGuidance
</span><a href="#local-6989586621681822129"><span class="hs-identifier hs-var hs-var">guidance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Bool -&gt; CoreArg -&gt; UnfoldingGuidance
</span><a href="GHC.Core.Unfold.html#calcUnfoldingGuidance"><span class="hs-identifier hs-var">calcUnfoldingGuidance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimpleOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.SimpleOpt.html#so_uf_opts"><span class="hs-identifier hs-var">so_uf_opts</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822118"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822128"><span class="hs-identifier hs-var">new_tmpl</span></a></span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkWorkerUnfolding"><span class="hs-identifier hs-var">mkWorkerUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; CoreArg
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a></span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="hs-comment">-- | Make an INLINE unfolding that may be used unsaturated</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- (ug_unsat_ok = unSaturatedOk) and that is reported as having its</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- manifest arity (the number of outer lambdas applications will</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- resolve before doing any work).</span><span>
</span><span id="line-128"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkInlineUnfoldingNoArity"><span class="hs-identifier hs-type">mkInlineUnfoldingNoArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#SimpleOpts"><span class="hs-identifier hs-type">SimpleOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#UnfoldingSource"><span class="hs-identifier hs-type">UnfoldingSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-129"></span><span id="mkInlineUnfoldingNoArity"><span class="annot"><span class="annottext">mkInlineUnfoldingNoArity :: SimpleOpts -&gt; UnfoldingSource -&gt; CoreArg -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkInlineUnfoldingNoArity"><span class="hs-identifier hs-var hs-var">mkInlineUnfoldingNoArity</span></a></span></span><span> </span><span id="local-6989586621681822132"><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822132"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822133"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822133"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621681822134"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822134"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; UnfoldingGuidance
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCoreUnfolding"><span class="hs-identifier hs-var">mkCoreUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822133"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-131"></span><span>                    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>         </span><span class="hs-comment">-- Note [Top-level flag on inline rules]</span><span>
</span><span id="line-132"></span><span>                    </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822135"><span class="hs-identifier hs-var">expr'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621681822136"><span class="hs-identifier hs-var">guide</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-134"></span><span>    </span><span id="local-6989586621681822135"><span class="annot"><span class="annottext">expr' :: CoreArg
</span><a href="#local-6989586621681822135"><span class="hs-identifier hs-var hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; SimpleOpts -&gt; CoreArg -&gt; CoreArg
SimpleOpts -&gt; CoreArg -&gt; CoreArg
</span><a href="GHC.Core.SimpleOpt.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822132"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822134"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-135"></span><span>    </span><span id="local-6989586621681822136"><span class="annot"><span class="annottext">guide :: UnfoldingGuidance
</span><a href="#local-6989586621681822136"><span class="hs-identifier hs-var hs-var">guide</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfWhen"><span class="hs-identifier hs-type">UnfWhen</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ug_arity :: ArityInfo
</span><a href="GHC.Core.html#ug_arity"><span class="hs-identifier hs-var">ug_arity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; ArityInfo
</span><a href="GHC.Core.Opt.Arity.html#manifestArity"><span class="hs-identifier hs-var">manifestArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822135"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-136"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_unsat_ok :: Bool
</span><a href="GHC.Core.html#ug_unsat_ok"><span class="hs-identifier hs-var">ug_unsat_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.html#unSaturatedOk"><span class="hs-identifier hs-var">unSaturatedOk</span></a></span><span>
</span><span id="line-137"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_boring_ok :: Bool
</span><a href="GHC.Core.html#ug_boring_ok"><span class="hs-identifier hs-var">ug_boring_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822137"><span class="hs-identifier hs-var">boring_ok</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-138"></span><span>    </span><span id="local-6989586621681822137"><span class="annot"><span class="annottext">boring_ok :: Bool
</span><a href="#local-6989586621681822137"><span class="hs-identifier hs-var hs-var">boring_ok</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; Bool
</span><a href="GHC.Core.Unfold.html#inlineBoringOk"><span class="hs-identifier hs-var">inlineBoringOk</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822135"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="hs-comment">-- | Make an INLINE unfolding that will be used once the RHS has been saturated</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- to the given arity.</span><span>
</span><span id="line-142"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkInlineUnfoldingWithArity"><span class="hs-identifier hs-type">mkInlineUnfoldingWithArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#SimpleOpts"><span class="hs-identifier hs-type">SimpleOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#UnfoldingSource"><span class="hs-identifier hs-type">UnfoldingSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-143"></span><span id="mkInlineUnfoldingWithArity"><span class="annot"><span class="annottext">mkInlineUnfoldingWithArity :: SimpleOpts -&gt; UnfoldingSource -&gt; ArityInfo -&gt; CoreArg -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkInlineUnfoldingWithArity"><span class="hs-identifier hs-var hs-var">mkInlineUnfoldingWithArity</span></a></span></span><span> </span><span id="local-6989586621681822139"><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822139"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822140"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822140"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621681822141"><span class="annot"><span class="annottext">ArityInfo
</span><a href="#local-6989586621681822141"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span id="local-6989586621681822142"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822142"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; UnfoldingGuidance
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCoreUnfolding"><span class="hs-identifier hs-var">mkCoreUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822140"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-145"></span><span>                    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>         </span><span class="hs-comment">-- Note [Top-level flag on inline rules]</span><span>
</span><span id="line-146"></span><span>                    </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822143"><span class="hs-identifier hs-var">expr'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621681822144"><span class="hs-identifier hs-var">guide</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-148"></span><span>    </span><span id="local-6989586621681822143"><span class="annot"><span class="annottext">expr' :: CoreArg
</span><a href="#local-6989586621681822143"><span class="hs-identifier hs-var hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; SimpleOpts -&gt; CoreArg -&gt; CoreArg
SimpleOpts -&gt; CoreArg -&gt; CoreArg
</span><a href="GHC.Core.SimpleOpt.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822139"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822142"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span id="local-6989586621681822144"><span class="annot"><span class="annottext">guide :: UnfoldingGuidance
</span><a href="#local-6989586621681822144"><span class="hs-identifier hs-var hs-var">guide</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfWhen"><span class="hs-identifier hs-type">UnfWhen</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ug_arity :: ArityInfo
</span><a href="GHC.Core.html#ug_arity"><span class="hs-identifier hs-var">ug_arity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArityInfo
</span><a href="#local-6989586621681822141"><span class="hs-identifier hs-var">arity</span></a></span><span>
</span><span id="line-150"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_unsat_ok :: Bool
</span><a href="GHC.Core.html#ug_unsat_ok"><span class="hs-identifier hs-var">ug_unsat_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Core.html#needSaturated"><span class="hs-identifier hs-var">needSaturated</span></a></span><span>
</span><span id="line-151"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_boring_ok :: Bool
</span><a href="GHC.Core.html#ug_boring_ok"><span class="hs-identifier hs-var">ug_boring_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822146"><span class="hs-identifier hs-var">boring_ok</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-comment">-- See Note [INLINE pragmas and boring contexts] as to why we need to look</span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-comment">-- at the arity here.</span><span>
</span><span id="line-154"></span><span>    </span><span id="local-6989586621681822146"><span class="annot"><span class="annottext">boring_ok :: Bool
</span><a href="#local-6989586621681822146"><span class="hs-identifier hs-var hs-var">boring_ok</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArityInfo
</span><a href="#local-6989586621681822141"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">ArityInfo -&gt; ArityInfo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ArityInfo
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-155"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; Bool
</span><a href="GHC.Core.Unfold.html#inlineBoringOk"><span class="hs-identifier hs-var">inlineBoringOk</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822143"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkInlinableUnfolding"><span class="hs-identifier hs-type">mkInlinableUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#SimpleOpts"><span class="hs-identifier hs-type">SimpleOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#UnfoldingSource"><span class="hs-identifier hs-type">UnfoldingSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-158"></span><span id="mkInlinableUnfolding"><span class="annot"><span class="annottext">mkInlinableUnfolding :: SimpleOpts -&gt; UnfoldingSource -&gt; CoreArg -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkInlinableUnfolding"><span class="hs-identifier hs-var hs-var">mkInlinableUnfolding</span></a></span></span><span> </span><span id="local-6989586621681822147"><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822147"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822148"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822148"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621681822149"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822149"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
-&gt; UnfoldingSource
-&gt; Bool
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkUnfolding"><span class="hs-identifier hs-var">mkUnfolding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimpleOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.SimpleOpt.html#so_uf_opts"><span class="hs-identifier hs-var">so_uf_opts</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822147"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822148"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822150"><span class="hs-identifier hs-var">expr'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-161"></span><span>    </span><span id="local-6989586621681822150"><span class="annot"><span class="annottext">expr' :: CoreArg
</span><a href="#local-6989586621681822150"><span class="hs-identifier hs-var hs-var">expr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; SimpleOpts -&gt; CoreArg -&gt; CoreArg
SimpleOpts -&gt; CoreArg -&gt; CoreArg
</span><a href="GHC.Core.SimpleOpt.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822147"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822149"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#specUnfolding"><span class="hs-identifier hs-type">specUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#SimpleOpts"><span class="hs-identifier hs-type">SimpleOpts</span></a></span><span>
</span><span id="line-164"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- LHS arguments in the RULE</span><span>
</span><span id="line-166"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-167"></span><span class="hs-comment">-- See Note [Specialising unfoldings]</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- specUnfolding spec_bndrs spec_args unf</span><span>
</span><span id="line-169"></span><span class="hs-comment">--   = \spec_bndrs. unf spec_args</span><span>
</span><span id="line-170"></span><span class="hs-comment">--</span><span>
</span><span id="line-171"></span><span id="specUnfolding"><span class="annot"><span class="annottext">specUnfolding :: SimpleOpts
-&gt; [Var]
-&gt; (CoreArg -&gt; CoreArg)
-&gt; [CoreArg]
-&gt; Unfolding
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#specUnfolding"><span class="hs-identifier hs-var hs-var">specUnfolding</span></a></span></span><span> </span><span id="local-6989586621681822151"><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822151"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822152"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681822152"><span class="hs-identifier hs-var">spec_bndrs</span></a></span></span><span> </span><span id="local-6989586621681822153"><span class="annot"><span class="annottext">CoreArg -&gt; CoreArg
</span><a href="#local-6989586621681822153"><span class="hs-identifier hs-var">spec_app</span></a></span></span><span> </span><span id="local-6989586621681822154"><span class="annot"><span class="annottext">[CoreArg]
</span><a href="#local-6989586621681822154"><span class="hs-identifier hs-var">rule_lhs_args</span></a></span></span><span>
</span><span id="line-172"></span><span>              </span><span id="local-6989586621681822155"><span class="annot"><span class="annottext">df :: Unfolding
</span><a href="#local-6989586621681822155"><span class="hs-identifier hs-var">df</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DFunUnfolding"><span class="hs-identifier hs-type">DFunUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">df_bndrs :: Unfolding -&gt; [Var]
</span><a href="GHC.Core.html#df_bndrs"><span class="hs-identifier hs-var">df_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822156"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681822156"><span class="hs-identifier hs-var">old_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">df_con :: Unfolding -&gt; DataCon
</span><a href="GHC.Core.html#df_con"><span class="hs-identifier hs-var">df_con</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822157"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681822157"><span class="hs-identifier hs-var">con</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">df_args :: Unfolding -&gt; [CoreArg]
</span><a href="GHC.Core.html#df_args"><span class="hs-identifier hs-var">df_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822158"><span class="annot"><span class="annottext">[CoreArg]
</span><a href="#local-6989586621681822158"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Unfolding -&gt; Unfolding
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreArg]
</span><a href="#local-6989586621681822154"><span class="hs-identifier hs-var">rule_lhs_args</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreArg] -&gt; [Var] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-operator hs-var">`equalLength`</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681822156"><span class="hs-identifier hs-var">old_bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unfolding -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681822155"><span class="hs-identifier hs-var">df</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreArg] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreArg]
</span><a href="#local-6989586621681822154"><span class="hs-identifier hs-var">rule_lhs_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Unfolding -&gt; Unfolding) -&gt; Unfolding -&gt; Unfolding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-175"></span><span>           </span><span class="hs-comment">-- For this ASSERT see Note [Specialising DFuns] in GHC.Core.Opt.Specialise</span><span>
</span><span id="line-176"></span><span>    </span><span class="annot"><span class="annottext">[Var] -&gt; DataCon -&gt; [CoreArg] -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkDFunUnfolding"><span class="hs-identifier hs-var">mkDFunUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681822152"><span class="hs-identifier hs-var">spec_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681822157"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CoreArg -&gt; CoreArg) -&gt; [CoreArg] -&gt; [CoreArg]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; CoreArg
</span><a href="#local-6989586621681822163"><span class="hs-identifier hs-var">spec_arg</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreArg]
</span><a href="#local-6989586621681822158"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>      </span><span class="hs-comment">-- For DFunUnfoldings we transform</span><span>
</span><span id="line-178"></span><span>      </span><span class="hs-comment">--       \obs. MkD &lt;op1&gt; ... &lt;opn&gt;</span><span>
</span><span id="line-179"></span><span>      </span><span class="hs-comment">-- to</span><span>
</span><span id="line-180"></span><span>      </span><span class="hs-comment">--       \sbs. MkD ((\obs. &lt;op1&gt;) spec_args) ... ditto &lt;opn&gt;</span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-182"></span><span>    </span><span id="local-6989586621681822163"><span class="annot"><span class="annottext">spec_arg :: CoreArg -&gt; CoreArg
</span><a href="#local-6989586621681822163"><span class="hs-identifier hs-var hs-var">spec_arg</span></a></span></span><span> </span><span id="local-6989586621681822164"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822164"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; SimpleOpts -&gt; CoreArg -&gt; CoreArg
SimpleOpts -&gt; CoreArg -&gt; CoreArg
</span><a href="GHC.Core.SimpleOpt.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822151"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreArg -&gt; CoreArg) -&gt; CoreArg -&gt; CoreArg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-183"></span><span>                   </span><span class="annot"><span class="annottext">CoreArg -&gt; CoreArg
</span><a href="#local-6989586621681822153"><span class="hs-identifier hs-var">spec_app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Var] -&gt; CoreArg -&gt; CoreArg
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681822156"><span class="hs-identifier hs-var">old_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822164"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>                   </span><span class="hs-comment">-- The beta-redexes created by spec_app will be</span><span>
</span><span id="line-185"></span><span>                   </span><span class="hs-comment">-- simplified away by simplOptExpr</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#specUnfolding"><span class="hs-identifier hs-var">specUnfolding</span></a></span><span> </span><span id="local-6989586621681822166"><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822166"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822167"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681822167"><span class="hs-identifier hs-var">spec_bndrs</span></a></span></span><span> </span><span id="local-6989586621681822168"><span class="annot"><span class="annottext">CoreArg -&gt; CoreArg
</span><a href="#local-6989586621681822168"><span class="hs-identifier hs-var">spec_app</span></a></span></span><span> </span><span id="local-6989586621681822169"><span class="annot"><span class="annottext">[CoreArg]
</span><a href="#local-6989586621681822169"><span class="hs-identifier hs-var">rule_lhs_args</span></a></span></span><span>
</span><span id="line-188"></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_src :: Unfolding -&gt; UnfoldingSource
</span><a href="GHC.Core.html#uf_src"><span class="hs-identifier hs-var">uf_src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822170"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822170"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_tmpl :: Unfolding -&gt; CoreArg
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822171"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822171"><span class="hs-identifier hs-var">tmpl</span></a></span></span><span>
</span><span id="line-189"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_is_top :: Unfolding -&gt; Bool
</span><a href="GHC.Core.html#uf_is_top"><span class="hs-identifier hs-var">uf_is_top</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822172"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822172"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span>
</span><span id="line-190"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_guidance :: Unfolding -&gt; UnfoldingGuidance
</span><a href="GHC.Core.html#uf_guidance"><span class="hs-identifier hs-var">uf_guidance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822174"><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621681822174"><span class="hs-identifier hs-var">old_guidance</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource -&gt; Bool
</span><a href="GHC.Types.Basic.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822170"><span class="hs-identifier hs-var">src</span></a></span><span>  </span><span class="hs-comment">-- See Note [Specialising unfoldings]</span><span>
</span><span id="line-192"></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfWhen"><span class="hs-identifier hs-type">UnfWhen</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ug_arity :: UnfoldingGuidance -&gt; ArityInfo
</span><a href="GHC.Core.html#ug_arity"><span class="hs-identifier hs-var">ug_arity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822175"><span class="annot"><span class="annottext">ArityInfo
</span><a href="#local-6989586621681822175"><span class="hs-identifier hs-var">old_arity</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621681822174"><span class="hs-identifier hs-var">old_guidance</span></a></span><span>
</span><span id="line-193"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; UnfoldingGuidance
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCoreUnfolding"><span class="hs-identifier hs-var">mkCoreUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822170"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822172"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822176"><span class="hs-identifier hs-var">new_tmpl</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-194"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621681822174"><span class="hs-identifier hs-var">old_guidance</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#ug_arity"><span class="hs-identifier hs-var">ug_arity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681822175"><span class="hs-identifier hs-type">old_arity</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Num.html#-/GHC.Num.html#-"><span class="hs-glyph hs-type">-</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681822177"><span class="hs-identifier hs-type">arity_decrease</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-196"></span><span>   </span><span id="local-6989586621681822176"><span class="annot"><span class="annottext">new_tmpl :: CoreArg
</span><a href="#local-6989586621681822176"><span class="hs-identifier hs-var hs-var">new_tmpl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; SimpleOpts -&gt; CoreArg -&gt; CoreArg
SimpleOpts -&gt; CoreArg -&gt; CoreArg
</span><a href="GHC.Core.SimpleOpt.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681822166"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreArg -&gt; CoreArg) -&gt; CoreArg -&gt; CoreArg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-197"></span><span>              </span><span class="annot"><span class="annottext">[Var] -&gt; CoreArg -&gt; CoreArg
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681822167"><span class="hs-identifier hs-var">spec_bndrs</span></a></span><span>  </span><span class="annot"><span class="annottext">(CoreArg -&gt; CoreArg) -&gt; CoreArg -&gt; CoreArg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-198"></span><span>              </span><span class="annot"><span class="annottext">CoreArg -&gt; CoreArg
</span><a href="#local-6989586621681822168"><span class="hs-identifier hs-var">spec_app</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822171"><span class="hs-identifier hs-var">tmpl</span></a></span><span>  </span><span class="hs-comment">-- The beta-redexes created by spec_app</span><span>
</span><span id="line-199"></span><span>                             </span><span class="hs-comment">-- will be simplified away by simplOptExpr</span><span>
</span><span id="line-200"></span><span>   </span><span id="local-6989586621681822177"><span class="annot"><span class="annottext">arity_decrease :: ArityInfo
</span><a href="#local-6989586621681822177"><span class="hs-identifier hs-var hs-var">arity_decrease</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreArg -&gt; Bool) -&gt; [CoreArg] -&gt; ArityInfo
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ArityInfo
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isValArg"><span class="hs-identifier hs-var">isValArg</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreArg]
</span><a href="#local-6989586621681822169"><span class="hs-identifier hs-var">rule_lhs_args</span></a></span><span> </span><span class="annot"><span class="annottext">ArityInfo -&gt; ArityInfo -&gt; ArityInfo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#-/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">(Var -&gt; Bool) -&gt; [Var] -&gt; ArityInfo
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ArityInfo
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681822167"><span class="hs-identifier hs-var">spec_bndrs</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#specUnfolding"><span class="hs-identifier hs-var">specUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; CoreArg
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[CoreArg]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a></span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span class="hs-comment">{- Note [Specialising unfoldings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we specialise a function for some given type-class arguments, we use
specUnfolding to specialise its unfolding.  Some important points:

* If the original function has a DFunUnfolding, the specialised one
  must do so too!  Otherwise we lose the magic rules that make it
  interact with ClassOps

* For a /stable/ CoreUnfolding, we specialise the unfolding, no matter
  how big, iff it has UnfWhen guidance.  This happens for INLINE
  functions, and for wrappers.  For these, it would be very odd if a
  function marked INLINE was specialised (because of some local use),
  and then forever after (including importing modules) the specialised
  version wasn't INLINEd!  After all, the programmer said INLINE.

* However, for a stable CoreUnfolding with guidance UnfoldIfGoodArgs,
  which arises from INLINABLE functions, we drop the unfolding.
  See #4874 for persuasive examples.  Suppose we have
    {-# INLINABLE f #-}
    f :: Ord a =&gt; [a] -&gt; Int f xs = letrec f' = ...f'... in f'

  Then, when f is specialised and optimised we might get
    wgo :: [Int] -&gt; Int#
    wgo = ...wgo...
    f_spec :: [Int] -&gt; Int
    f_spec xs = case wgo xs of { r -&gt; I# r }

  and we clearly want to inline f_spec at call sites.  But if we still
  have the big, un-optimised of f (albeit specialised) captured in the
  stable unfolding for f_spec, we won't get that optimisation.

  This happens with Control.Monad.liftM3, and can cause a lot more
  allocation as a result (nofib n-body shows this).

  Moreover, keeping the stable unfolding isn't much help, because
  the specialised function (probably) isn't overloaded any more.

  TL;DR: we simply drop the stable unfolding when specialising. It's not
  really a complete solution; ignoring specialisation for now, INLINABLE
  functions don't get properly strictness analysed, for example.
  Moreover, it means that the specialised function has an INLINEABLE
  pragma, but no stable unfolding. But it works well for examples
  involving specialisation, which is the dominant use of INLINABLE.

Note [Honour INLINE on 0-ary bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

   x = &lt;expensive&gt;
   {-# INLINE x #-}

   f y = ...x...

The semantics of an INLINE pragma is

  inline x at every call site, provided it is saturated;
  that is, applied to at least as many arguments as appear
  on the LHS of the Haskell source definition.

(This source-code-derived arity is stored in the `ug_arity` field of
the `UnfoldingGuidance`.)

In the example, x's ug_arity is 0, so we should inline it at every use
site.  It's rare to have such an INLINE pragma (usually INLINE is on
functions), but it's occasionally very important (#15578, #15519).
In #15519 we had something like
   x = case (g a b) of I# r -&gt; T r
   {-# INLINE x #-}
   f y = ...(h x)....

where h is strict.  So we got
   f y = ...(case g a b of I# r -&gt; h (T r))...

and that in turn allowed SpecConstr to ramp up performance.

How do we deliver on this?  By adjusting the ug_boring_ok
flag in mkInlineUnfoldingWithArity; see
Note [INLINE pragmas and boring contexts]

NB: there is a real risk that full laziness will float it right back
out again. Consider again
  x = factorial 200
  {-# INLINE x #-}
  f y = ...x...

After inlining we get
  f y = ...(factorial 200)...

but it's entirely possible that full laziness will do
  lvl23 = factorial 200
  f y = ...lvl23...

That's a problem for another day.

Note [INLINE pragmas and boring contexts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
An INLINE pragma uses mkInlineUnfoldingWithArity to build the
unfolding.  That sets the ug_boring_ok flag to False if the function
is not tiny (inlineBoringOK), so that even INLINE functions are not
inlined in an utterly boring context.  E.g.
     \x y. Just (f y x)
Nothing is gained by inlining f here, even if it has an INLINE
pragma.

But for 0-ary bindings, we want to inline regardless; see
Note [Honour INLINE on 0-ary bindings].

I'm a bit worried that it's possible for the same kind of problem
to arise for non-0-ary functions too, but let's wait and see.
-}</span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkUnfolding"><span class="hs-identifier hs-type">mkUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span>
</span><span id="line-318"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#UnfoldingSource"><span class="hs-identifier hs-type">UnfoldingSource</span></a></span><span>
</span><span id="line-319"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>       </span><span class="hs-comment">-- Is top-level</span><span>
</span><span id="line-320"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>       </span><span class="hs-comment">-- Definitely a bottoming binding</span><span>
</span><span id="line-321"></span><span>                          </span><span class="hs-comment">-- (only relevant for top-level bindings)</span><span>
</span><span id="line-322"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-323"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#UnfoldingCache"><span class="hs-identifier hs-type">UnfoldingCache</span></a></span><span>
</span><span id="line-324"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-325"></span><span class="hs-comment">-- Calculates unfolding guidance</span><span>
</span><span id="line-326"></span><span class="hs-comment">-- Occurrence-analyses the expression before capturing it</span><span>
</span><span id="line-327"></span><span id="mkUnfolding"><span class="annot"><span class="annottext">mkUnfolding :: UnfoldingOpts
-&gt; UnfoldingSource
-&gt; Bool
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkUnfolding"><span class="hs-identifier hs-var hs-var">mkUnfolding</span></a></span></span><span> </span><span id="local-6989586621681822181"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621681822181"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822182"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822182"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621681822183"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822183"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681822184"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822184"><span class="hs-identifier hs-var">is_bottoming</span></a></span></span><span> </span><span id="local-6989586621681822185"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822185"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621681822186"><span class="annot"><span class="annottext">Maybe UnfoldingCache
</span><a href="#local-6989586621681822186"><span class="hs-identifier hs-var">cache</span></a></span></span><span>
</span><span id="line-328"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; UnfoldingGuidance
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCoreUnfolding"><span class="hs-identifier hs-var">mkCoreUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822182"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822183"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822185"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
</span><a href="#local-6989586621681822186"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621681822187"><span class="hs-identifier hs-var">guidance</span></a></span><span>
</span><span id="line-329"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-330"></span><span>    </span><span id="local-6989586621681822188"><span class="annot"><span class="annottext">is_top_bottoming :: Bool
</span><a href="#local-6989586621681822188"><span class="hs-identifier hs-var hs-var">is_top_bottoming</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822183"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822184"><span class="hs-identifier hs-var">is_bottoming</span></a></span><span>
</span><span id="line-331"></span><span>    </span><span id="local-6989586621681822187"><span class="annot"><span class="annottext">guidance :: UnfoldingGuidance
</span><a href="#local-6989586621681822187"><span class="hs-identifier hs-var hs-var">guidance</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; Bool -&gt; CoreArg -&gt; UnfoldingGuidance
</span><a href="GHC.Core.Unfold.html#calcUnfoldingGuidance"><span class="hs-identifier hs-var">calcUnfoldingGuidance</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621681822181"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822188"><span class="hs-identifier hs-var">is_top_bottoming</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822185"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-332"></span><span>        </span><span class="hs-comment">-- NB: *not* (calcUnfoldingGuidance (occurAnalyseExpr expr))!</span><span>
</span><span id="line-333"></span><span>        </span><span class="hs-comment">-- See Note [Calculate unfolding guidance on the non-occ-anal'd expression]</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#mkCoreUnfolding"><span class="hs-identifier hs-type">mkCoreUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#UnfoldingSource"><span class="hs-identifier hs-type">UnfoldingSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-336"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#UnfoldingCache"><span class="hs-identifier hs-type">UnfoldingCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfoldingGuidance"><span class="hs-identifier hs-type">UnfoldingGuidance</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-337"></span><span class="hs-comment">-- Occurrence-analyses the expression before capturing it</span><span>
</span><span id="line-338"></span><span id="mkCoreUnfolding"><span class="annot"><span class="annottext">mkCoreUnfolding :: UnfoldingSource
-&gt; Bool
-&gt; CoreArg
-&gt; Maybe UnfoldingCache
-&gt; UnfoldingGuidance
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkCoreUnfolding"><span class="hs-identifier hs-var hs-var">mkCoreUnfolding</span></a></span></span><span> </span><span id="local-6989586621681822190"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822190"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621681822191"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822191"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681822192"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822192"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621681822193"><span class="annot"><span class="annottext">Maybe UnfoldingCache
</span><a href="#local-6989586621681822193"><span class="hs-identifier hs-var">precomputed_cache</span></a></span></span><span> </span><span id="local-6989586621681822194"><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621681822194"><span class="hs-identifier hs-var">guidance</span></a></span></span><span>
</span><span id="line-339"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_tmpl :: CoreArg
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingCache
</span><a href="#local-6989586621681822195"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingCache -&gt; CoreArg -&gt; CoreArg
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span>
</span><span id="line-340"></span><span>                              </span><span class="annot"><span class="annottext">CoreArg -&gt; CoreArg
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822192"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-341"></span><span>      </span><span class="hs-comment">-- occAnalyseExpr: see Note [Occurrence analysis of unfoldings]</span><span>
</span><span id="line-342"></span><span>      </span><span class="hs-comment">-- See #20905 for what a discussion of this 'seq'.</span><span>
</span><span id="line-343"></span><span>      </span><span class="hs-comment">-- We are careful to make sure we only</span><span>
</span><span id="line-344"></span><span>      </span><span class="hs-comment">-- have one copy of an unfolding around at once.</span><span>
</span><span id="line-345"></span><span>      </span><span class="hs-comment">-- Note [Thoughtful forcing in mkCoreUnfolding]</span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_src :: UnfoldingSource
</span><a href="GHC.Core.html#uf_src"><span class="hs-identifier hs-var">uf_src</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822190"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-348"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_is_top :: Bool
</span><a href="GHC.Core.html#uf_is_top"><span class="hs-identifier hs-var">uf_is_top</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822191"><span class="hs-identifier hs-var">top_lvl</span></a></span><span>
</span><span id="line-349"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_cache :: UnfoldingCache
</span><a href="GHC.Core.html#uf_cache"><span class="hs-identifier hs-var">uf_cache</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingCache
</span><a href="#local-6989586621681822195"><span class="hs-identifier hs-var">cache</span></a></span><span>
</span><span id="line-350"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_guidance :: UnfoldingGuidance
</span><a href="GHC.Core.html#uf_guidance"><span class="hs-identifier hs-var">uf_guidance</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621681822194"><span class="hs-identifier hs-var">guidance</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-352"></span><span>    </span><span id="local-6989586621681822197"><span class="annot"><span class="annottext">is_value :: Bool
</span><a href="#local-6989586621681822197"><span class="hs-identifier hs-var hs-var">is_value</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822192"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-353"></span><span>    </span><span id="local-6989586621681822199"><span class="annot"><span class="annottext">is_conlike :: Bool
</span><a href="#local-6989586621681822199"><span class="hs-identifier hs-var hs-var">is_conlike</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsConLike"><span class="hs-identifier hs-var">exprIsConLike</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822192"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-354"></span><span>    </span><span id="local-6989586621681822201"><span class="annot"><span class="annottext">is_work_free :: Bool
</span><a href="#local-6989586621681822201"><span class="hs-identifier hs-var hs-var">is_work_free</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsWorkFree"><span class="hs-identifier hs-var">exprIsWorkFree</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822192"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span id="local-6989586621681822203"><span class="annot"><span class="annottext">is_expandable :: Bool
</span><a href="#local-6989586621681822203"><span class="hs-identifier hs-var hs-var">is_expandable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsExpandable"><span class="hs-identifier hs-var">exprIsExpandable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822192"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span>    </span><span id="local-6989586621681822205"><span class="annot"><span class="annottext">recomputed_cache :: UnfoldingCache
</span><a href="#local-6989586621681822205"><span class="hs-identifier hs-var hs-var">recomputed_cache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfoldingCache"><span class="hs-identifier hs-type">UnfoldingCache</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_is_value :: Bool
</span><a href="GHC.Core.html#uf_is_value"><span class="hs-identifier hs-var">uf_is_value</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822197"><span class="hs-identifier hs-var">is_value</span></a></span><span>
</span><span id="line-358"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_is_conlike :: Bool
</span><a href="GHC.Core.html#uf_is_conlike"><span class="hs-identifier hs-var">uf_is_conlike</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822199"><span class="hs-identifier hs-var">is_conlike</span></a></span><span>
</span><span id="line-359"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_is_work_free :: Bool
</span><a href="GHC.Core.html#uf_is_work_free"><span class="hs-identifier hs-var">uf_is_work_free</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822201"><span class="hs-identifier hs-var">is_work_free</span></a></span><span>
</span><span id="line-360"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_expandable :: Bool
</span><a href="GHC.Core.html#uf_expandable"><span class="hs-identifier hs-var">uf_expandable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822203"><span class="hs-identifier hs-var">is_expandable</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span>    </span><span id="local-6989586621681822195"><span class="annot"><span class="annottext">cache :: UnfoldingCache
</span><a href="#local-6989586621681822195"><span class="hs-identifier hs-var hs-var">cache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingCache -&gt; Maybe UnfoldingCache -&gt; UnfoldingCache
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Maybe.html#fromMaybe/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingCache
</span><a href="#local-6989586621681822205"><span class="hs-identifier hs-var">recomputed_cache</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnfoldingCache
</span><a href="#local-6989586621681822193"><span class="hs-identifier hs-var">precomputed_cache</span></a></span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span class="hs-comment">----------------</span><span>
</span><span id="line-365"></span><span class="annot"><a href="GHC.Core.Unfold.Make.html#certainlyWillInline"><span class="hs-identifier hs-type">certainlyWillInline</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#UnfoldingOpts"><span class="hs-identifier hs-type">UnfoldingOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#IdInfo"><span class="hs-identifier hs-type">IdInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a></span><span>
</span><span id="line-366"></span><span class="hs-comment">-- ^ Sees if the unfolding is pretty certain to inline.</span><span>
</span><span id="line-367"></span><span class="hs-comment">-- If so, return a *stable* unfolding for it, that will always inline.</span><span>
</span><span id="line-368"></span><span class="hs-comment">-- The CoreExpr is the WW'd and simplified RHS. In contrast, the unfolding</span><span>
</span><span id="line-369"></span><span class="hs-comment">-- template might not have been WW'd yet.</span><span>
</span><span id="line-370"></span><span id="certainlyWillInline"><span class="annot"><span class="annottext">certainlyWillInline :: UnfoldingOpts -&gt; IdInfo -&gt; CoreArg -&gt; Maybe Unfolding
</span><a href="GHC.Core.Unfold.Make.html#certainlyWillInline"><span class="hs-identifier hs-var hs-var">certainlyWillInline</span></a></span></span><span> </span><span id="local-6989586621681822211"><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621681822211"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681822212"><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681822212"><span class="hs-identifier hs-var">fn_info</span></a></span></span><span> </span><span id="local-6989586621681822213"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822213"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span>
</span><span id="line-371"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681822214"><span class="hs-identifier hs-var">fn_unf</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-372"></span><span>      </span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_guidance :: Unfolding -&gt; UnfoldingGuidance
</span><a href="GHC.Core.html#uf_guidance"><span class="hs-identifier hs-var">uf_guidance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822215"><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621681822215"><span class="hs-identifier hs-var">guidance</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">uf_src :: Unfolding -&gt; UnfoldingSource
</span><a href="GHC.Core.html#uf_src"><span class="hs-identifier hs-var">uf_src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822216"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822216"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-373"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681822217"><span class="hs-identifier hs-var">noinline</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Unfolding
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>       </span><span class="hs-comment">-- See Note [Worker/wrapper for NOINLINE functions]</span><span>
</span><span id="line-374"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-375"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="#local-6989586621681822215"><span class="hs-identifier hs-var">guidance</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-376"></span><span>             </span><span class="annot"><span class="annottext">UnfoldingGuidance
</span><a href="GHC.Core.html#UnfNever"><span class="hs-identifier hs-var">UnfNever</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Unfolding
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-377"></span><span>             </span><span class="annot"><a href="GHC.Core.html#UnfWhen"><span class="hs-identifier hs-type">UnfWhen</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Maybe Unfolding
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681822214"><span class="hs-identifier hs-var">fn_unf</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#uf_src"><span class="hs-identifier hs-var">uf_src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681822219"><span class="hs-identifier hs-type">src'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681822220"><span class="hs-identifier hs-type">tmpl'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>                             </span><span class="hs-comment">-- INLINE functions have UnfWhen</span><span>
</span><span id="line-379"></span><span>             </span><span class="annot"><a href="GHC.Core.html#UnfIfGoodArgs"><span class="hs-identifier hs-type">UnfIfGoodArgs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ug_size :: UnfoldingGuidance -&gt; ArityInfo
</span><a href="GHC.Core.html#ug_size"><span class="hs-identifier hs-var">ug_size</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822223"><span class="annot"><span class="annottext">ArityInfo
</span><a href="#local-6989586621681822223"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ug_args :: UnfoldingGuidance -&gt; [ArityInfo]
</span><a href="GHC.Core.html#ug_args"><span class="hs-identifier hs-var">ug_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681822225"><span class="annot"><span class="annottext">[ArityInfo]
</span><a href="#local-6989586621681822225"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-380"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArityInfo
-&gt; [ArityInfo] -&gt; UnfoldingSource -&gt; CoreArg -&gt; Maybe Unfolding
</span><a href="#local-6989586621681822226"><span class="hs-identifier hs-var">do_cunf</span></a></span><span> </span><span class="annot"><span class="annottext">ArityInfo
</span><a href="#local-6989586621681822223"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">[ArityInfo]
</span><a href="#local-6989586621681822225"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822219"><span class="hs-identifier hs-var">src'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822220"><span class="hs-identifier hs-var">tmpl'</span></a></span><span>
</span><span id="line-381"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-382"></span><span>          </span><span id="local-6989586621681822219"><span class="annot"><span class="annottext">src' :: UnfoldingSource
</span><a href="#local-6989586621681822219"><span class="hs-identifier hs-var hs-var">src'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource -&gt; Bool
</span><a href="GHC.Types.Basic.html#isCompulsorySource"><span class="hs-identifier hs-var">isCompulsorySource</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822216"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822216"><span class="hs-identifier hs-var">src</span></a></span><span>  </span><span class="hs-comment">-- Do not change InlineCompulsory!</span><span>
</span><span id="line-383"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="GHC.Types.Basic.html#StableSystemSrc"><span class="hs-identifier hs-var">StableSystemSrc</span></a></span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span>          </span><span id="local-6989586621681822220"><span class="annot"><span class="annottext">tmpl' :: CoreArg
</span><a href="#local-6989586621681822220"><span class="hs-identifier hs-var hs-var">tmpl'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UnfoldingSource -&gt; Bool
</span><a href="GHC.Types.Basic.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822216"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; CoreArg
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681822214"><span class="hs-identifier hs-var">fn_unf</span></a></span><span>
</span><span id="line-386"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreArg -&gt; CoreArg
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822213"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-387"></span><span>                </span><span class="hs-comment">-- Do not overwrite stable unfoldings!</span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span>      </span><span class="annot"><a href="GHC.Core.html#DFunUnfolding"><span class="hs-identifier hs-type">DFunUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Maybe Unfolding
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681822214"><span class="hs-identifier hs-var">fn_unf</span></a></span><span>  </span><span class="hs-comment">-- Don't w/w DFuns; it never makes sense</span><span>
</span><span id="line-390"></span><span>                                       </span><span class="hs-comment">-- to do so, and even if it is currently a</span><span>
</span><span id="line-391"></span><span>                                       </span><span class="hs-comment">-- loop breaker, it may not be later</span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>      </span><span id="local-6989586621681822228"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681822228"><span class="hs-identifier hs-var">_other_unf</span></a></span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Unfolding
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-396"></span><span>    </span><span id="local-6989586621681822217"><span class="annot"><span class="annottext">noinline :: Bool
</span><a href="#local-6989586621681822217"><span class="hs-identifier hs-var hs-var">noinline</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InlinePragma -&gt; Bool
</span><a href="GHC.Types.Basic.html#isNoInlinePragma"><span class="hs-identifier hs-var">isNoInlinePragma</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; InlinePragma
</span><a href="GHC.Types.Id.Info.html#inlinePragInfo"><span class="hs-identifier hs-var">inlinePragInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681822212"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span>    </span><span id="local-6989586621681822214"><span class="annot"><span class="annottext">fn_unf :: Unfolding
</span><a href="#local-6989586621681822214"><span class="hs-identifier hs-var hs-var">fn_unf</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding
</span><a href="GHC.Types.Id.Info.html#unfoldingInfo"><span class="hs-identifier hs-var">unfoldingInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681822212"><span class="hs-identifier hs-var">fn_info</span></a></span><span> </span><span class="hs-comment">-- NB: loop-breakers never inline</span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span>        </span><span class="hs-comment">-- The UnfIfGoodArgs case seems important.  If we w/w small functions</span><span>
</span><span id="line-400"></span><span>        </span><span class="hs-comment">-- binary sizes go up by 10%!  (This is with SplitObjs.)</span><span>
</span><span id="line-401"></span><span>        </span><span class="hs-comment">-- I'm not totally sure why.</span><span>
</span><span id="line-402"></span><span>        </span><span class="hs-comment">-- INLINABLE functions come via this path</span><span>
</span><span id="line-403"></span><span>        </span><span class="hs-comment">--    See Note [certainlyWillInline: INLINABLE]</span><span>
</span><span id="line-404"></span><span>    </span><span id="local-6989586621681822226"><span class="annot"><span class="annottext">do_cunf :: ArityInfo
-&gt; [ArityInfo] -&gt; UnfoldingSource -&gt; CoreArg -&gt; Maybe Unfolding
</span><a href="#local-6989586621681822226"><span class="hs-identifier hs-var hs-var">do_cunf</span></a></span></span><span> </span><span id="local-6989586621681822232"><span class="annot"><span class="annottext">ArityInfo
</span><a href="#local-6989586621681822232"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621681822233"><span class="annot"><span class="annottext">[ArityInfo]
</span><a href="#local-6989586621681822233"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681822234"><span class="annot"><span class="annottext">UnfoldingSource
</span><a href="#local-6989586621681822234"><span class="hs-identifier hs-var">src'</span></a></span></span><span> </span><span id="local-6989586621681822235"><span class="annot"><span class="annottext">CoreArg
</span><a href="#local-6989586621681822235"><span class="hs-identifier hs-var">tmpl'</span></a></span></span><span>
</span><span id="line-405"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; ArityInfo
</span><a href="GHC.Types.Id.Info.html#arityInfo"><span class="hs-identifier hs-var">arityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681822212"><span class="hs-identifier hs-var">fn_info</span></a></span><span> </span><span class="annot"><span class="annottext">ArityInfo -&gt; ArityInfo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">ArityInfo
</span><span class="hs-number">0</span></span><span>  </span><span class="hs-comment">-- See Note [certainlyWillInline: be careful of thunks]</span><span>
</span><span id="line-406"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdSig -&gt; Bool
</span><a href="GHC.Types.Demand.html#isDeadEndSig"><span class="hs-identifier hs-var">isDeadEndSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; DmdSig
</span><a href="GHC.Types.Id.Info.html#dmdSigInfo"><span class="hs-identifier hs-var">dmdSigInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681822212"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>              </span><span class="hs-comment">-- Do not unconditionally inline a bottoming functions even if</span><span>
</span><span id="line-408"></span><span>              </span><span class="hs-comment">-- it seems smallish. We've carefully lifted it out to top level,</span><span>
</span><span id="line-409"></span><span>              </span><span class="hs-comment">-- so we don't want to re-inline it.</span><span>
</span><span id="line-410"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681822240"><span class="annot"><span class="annottext">unf_arity :: ArityInfo
</span><a href="#local-6989586621681822240"><span class="hs-identifier hs-var hs-var">unf_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ArityInfo] -&gt; ArityInfo
forall a. [a] -&gt; ArityInfo
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; ArityInfo
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[ArityInfo]
</span><a href="#local-6989586621681822233"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-411"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArityInfo
</span><a href="#local-6989586621681822232"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">ArityInfo -&gt; ArityInfo -&gt; ArityInfo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#-/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityInfo
</span><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">ArityInfo -&gt; ArityInfo -&gt; ArityInfo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#%2A/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArityInfo
</span><a href="#local-6989586621681822240"><span class="hs-identifier hs-var">unf_arity</span></a></span><span> </span><span class="annot"><span class="annottext">ArityInfo -&gt; ArityInfo -&gt; ArityInfo
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#%2B/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">ArityInfo
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ArityInfo -&gt; ArityInfo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; ArityInfo
</span><a href="GHC.Core.Unfold.html#unfoldingUseThreshold"><span class="hs-identifier hs-var">unfoldingUseThreshold</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621681822211"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-412"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Maybe Unfolding
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681822214"><span class="hs-identifier hs-var">fn_unf</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#uf_src"><span class="hs-identifier hs-var">uf_src</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681822234"><span class="hs-identifier hs-type">src'</span></a></span><span>
</span><span id="line-413"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681822235"><span class="hs-identifier hs-type">tmpl'</span></a></span><span>
</span><span id="line-414"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#uf_guidance"><span class="hs-identifier hs-var">uf_guidance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#UnfWhen"><span class="hs-identifier hs-type">UnfWhen</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.html#ug_arity"><span class="hs-identifier hs-var">ug_arity</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681822240"><span class="hs-identifier hs-type">unf_arity</span></a></span><span>
</span><span id="line-415"></span><span>                                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#ug_unsat_ok"><span class="hs-identifier hs-var">ug_unsat_ok</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#unSaturatedOk"><span class="hs-identifier hs-type">unSaturatedOk</span></a></span><span>
</span><span id="line-416"></span><span>                                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#ug_boring_ok"><span class="hs-identifier hs-var">ug_boring_ok</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html#inlineBoringOk"><span class="hs-identifier hs-type">inlineBoringOk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681822235"><span class="hs-identifier hs-type">tmpl'</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>             </span><span class="hs-comment">-- Note the &quot;unsaturatedOk&quot;. A function like  f = \ab. a</span><span>
</span><span id="line-418"></span><span>             </span><span class="hs-comment">-- will certainly inline, even if partially applied (f e), so we'd</span><span>
</span><span id="line-419"></span><span>             </span><span class="hs-comment">-- better make sure that the transformed inlining has the same property</span><span>
</span><span id="line-420"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-421"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Unfolding
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span class="hs-comment">{- Note [certainlyWillInline: be careful of thunks]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Don't claim that thunks will certainly inline, because that risks work
duplication.  Even if the work duplication is not great (eg is_cheap
holds), it can make a big difference in an inner loop In #5623 we
found that the WorkWrap phase thought that
       y = case x of F# v -&gt; F# (v +# v)
was certainlyWillInline, so the addition got duplicated.

Note that we check arityInfo instead of the arity of the unfolding to detect
this case. This is so that we don't accidentally fail to inline small partial
applications, like `f = g 42` (where `g` recurses into `f`) where g has arity 2
(say). Here there is no risk of work duplication, and the RHS is tiny, so
certainlyWillInline should return True. But `unf_arity` is zero! However f's
arity, gotten from `arityInfo fn_info`, is 1.

Failing to say that `f` will inline forces W/W to generate a potentially huge
worker for f that will immediately cancel with `g`'s wrapper anyway, causing
unnecessary churn in the Simplifier while arriving at the same result.

Note [certainlyWillInline: INLINABLE]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
certainlyWillInline /must/ return Nothing for a large INLINABLE thing,
even though we have a stable inlining, so that strictness w/w takes
place.  It makes a big difference to efficiency, and the w/w pass knows
how to transfer the INLINABLE info to the worker; see WorkWrap
Note [Worker/wrapper for INLINABLE functions]

Note [Thoughtful forcing in mkCoreUnfolding]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Core expressions retained in unfoldings is one of biggest uses of memory when compiling
a program. Therefore we have to be careful about retaining copies of old or redundant
templates (see !6202 for a particularly bad case).

With that in mind we want to maintain the invariant that each unfolding only references
a single CoreExpr. One place where we have to be careful is in mkCoreUnfolding.

* The template of the unfolding is the result of performing occurrence analysis
  (Note [Occurrence analysis of unfoldings])
* Predicates are applied to the unanalysed expression

Therefore if we are not thoughtful about forcing you can end up in a situation where the
template is forced but not all the predicates are forced so the unfolding will retain
both the old and analysed expressions.

I investigated this using ghc-debug and it was clear this situation did often arise:

```
([&quot;ghc:GHC.Core:Lam&quot;,&quot;ghc-prim:GHC.Types:True&quot;,&quot;THUNK_1_0&quot;,&quot;THUNK_1_0&quot;,&quot;THUNK_1_0&quot;],Count 4307)
```

Here the predicates are unforced but the template is forced.

Therefore we basically had two options in order to fix this:

1. Perform the predicates on the analysed expression.
2. Force the predicates to remove retainer to the old expression if we force the template.

Option 1 is bad because occurrence analysis is expensive and destroys any sharing of the unfolding
with the actual program. (Testing this approach showed peak 25G memory usage)

Therefore we got for Option 2 which performs a little more work but compensates by
reducing memory pressure.

The result of fixing this led to a 1G reduction in peak memory usage (12G -&gt; 11G) when
compiling a very large module (peak 3 million terms). For more discussion see #20905.
-}</span><span>
</span><span id="line-491"></span></pre></body></html>