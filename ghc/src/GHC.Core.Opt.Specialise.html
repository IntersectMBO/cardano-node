<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1993-1998

\section[Specialise]{Stamping out overloading, and (optionally) polymorphism}
-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Core.Opt.Specialise</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specProgram"><span class="hs-identifier">specProgram</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html#specUnfolding"><span class="hs-identifier">specUnfolding</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html"><span class="hs-identifier">GHC.Driver.Session</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Config.html"><span class="hs-identifier">GHC.Driver.Config</span></a></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Diagnostic.html"><span class="hs-identifier">GHC.Driver.Config.Diagnostic</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Core.Rules.html"><span class="hs-identifier">GHC.Driver.Config.Core.Rules</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.Config.Core.Rules.html#initRuleOpts"><span class="hs-identifier">initRuleOpts</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>  </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier">substTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier">substCo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendTvSubst"><span class="hs-identifier">extendTvSubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#zapSubst"><span class="hs-identifier">zapSubst</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Multiplicity.html"><span class="hs-identifier">GHC.Core.Multiplicity</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html"><span class="hs-identifier">GHC.Core.SimpleOpt</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#defaultSimpleOpts"><span class="hs-identifier">defaultSimpleOpts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html#simpleOptExprWith"><span class="hs-identifier">simpleOptExprWith</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier">Coercion</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html"><span class="hs-identifier">GHC.Core.Opt.Monad</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html"><span class="hs-identifier">GHC.Core.Subst</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Core</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html"><span class="hs-identifier">GHC.Core.Unfold.Make</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Make.html"><span class="hs-identifier">GHC.Core.Make</span></a></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Make.html#mkLitRubbish"><span class="hs-identifier">mkLitRubbish</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html"><span class="hs-identifier">GHC.Core.Unify</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTy"><span class="hs-identifier">tcMatchTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html"><span class="hs-identifier">GHC.Core.Rules</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier">exprIsTrivial</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#exprIsTopLevelBindable"><span class="hs-identifier">exprIsTopLevelBindable</span></a></span><span>
</span><span id="line-31"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier">mkCast</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier">exprType</span></a></span><span>
</span><span id="line-32"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#stripTicksTop"><span class="hs-identifier">stripTicksTop</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkInScopeSetBndrs"><span class="hs-identifier">mkInScopeSetBndrs</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html"><span class="hs-identifier">GHC.Core.TyCo.FVs</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypeList"><span class="hs-identifier">tyCoVarsOfTypeList</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html"><span class="hs-identifier">GHC.Core.Opt.Arity</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#collectBindersPushingCo"><span class="hs-identifier">collectBindersPushingCo</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- import GHC.Core.Ppr( pprIds )</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html#unboxedUnitTy"><span class="hs-identifier">unboxedUnitTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Maybe.html#maybeToList/Data.Maybe.html#maybeToList"><span class="hs-identifier">maybeToList</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Maybe.html#isJust/Data.Maybe.html#isJust"><span class="hs-identifier">isJust</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html"><span class="hs-identifier">GHC.Data.Bag</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html"><span class="hs-identifier">GHC.Data.OrdList</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.List.SetOps.html"><span class="hs-identifier">GHC.Data.List.SetOps</span></a></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html"><span class="hs-identifier">GHC.Types.Unique.Supply</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.DFM.html"><span class="hs-identifier">GHC.Types.Unique.DFM</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html"><span class="hs-identifier">GHC.Types.Id.Make</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#voidArgId"><span class="hs-identifier">voidArgId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.Make.html#voidPrimId"><span class="hs-identifier">voidPrimId</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#PiTyBinder"><span class="hs-identifier">PiTyBinder</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#isLocalVar"><span class="hs-identifier">isLocalVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#isInvisibleFunArg"><span class="hs-identifier">isInvisibleFunArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#mkLocalVar"><span class="hs-identifier">mkLocalVar</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Error.html"><span class="hs-identifier">GHC.Types.Error</span></a></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Error.html"><span class="hs-identifier">GHC.Utils.Error</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.Error.html#mkMCDiagnostic"><span class="hs-identifier">mkMCDiagnostic</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html"><span class="hs-identifier">GHC.Utils.Monad</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldlM/Data.Foldable.html#foldlM"><span class="hs-identifier">foldlM</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html"><span class="hs-identifier">GHC.Utils.Panic.Plain</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier">assert</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html"><span class="hs-identifier">GHC.Unit.Module</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier">Module</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html"><span class="hs-identifier">GHC.Unit.Module.ModGuts</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.html"><span class="hs-identifier">GHC.Core.Unfold</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.List.html#/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.OldList.html#partition/Data.OldList.html#partition"><span class="hs-identifier">partition</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.List.NonEmpty.html#/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Base.html#NonEmpty/GHC.Base.html#NonEmpty"><span class="hs-identifier">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[notes-Specialise]{Implementation notes [SLPJ, Aug 18 1993]}
*                                                                      *
************************************************************************

These notes describe how we implement specialisation to eliminate
overloading.

The specialisation pass works on Core
syntax, complete with all the explicit dictionary application,
abstraction and construction as added by the type checker.  The
existing type checker remains largely as it is.

One important thought: the {\em types} passed to an overloaded
function, and the {\em dictionaries} passed are mutually redundant.
If the same function is applied to the same type(s) then it is sure to
be applied to the same dictionary(s)---or rather to the same {\em
values}.  (The arguments might look different but they will evaluate
to the same value.)

Second important thought: we know that we can make progress by
treating dictionary arguments as static and worth specialising on.  So
we can do without binding-time analysis, and instead specialise on
dictionary arguments and no others.

The basic idea
~~~~~~~~~~~~~~
Suppose we have

        let f = &lt;f_rhs&gt;
        in &lt;body&gt;

and suppose f is overloaded.

STEP 1: CALL-INSTANCE COLLECTION

We traverse &lt;body&gt;, accumulating all applications of f to types and
dictionaries.

(Might there be partial applications, to just some of its types and
dictionaries?  In principle yes, but in practice the type checker only
builds applications of f to all its types and dictionaries, so partial
applications could only arise as a result of transformation, and even
then I think it's unlikely.  In any case, we simply don't accumulate such
partial applications.)


STEP 2: EQUIVALENCES

So now we have a collection of calls to f:
        f t1 t2 d1 d2
        f t3 t4 d3 d4
        ...
Notice that f may take several type arguments.  To avoid ambiguity, we
say that f is called at type t1/t2 and t3/t4.

We take equivalence classes using equality of the *types* (ignoring
the dictionary args, which as mentioned previously are redundant).

STEP 3: SPECIALISATION

For each equivalence class, choose a representative (f t1 t2 d1 d2),
and create a local instance of f, defined thus:

        f@t1/t2 = &lt;f_rhs&gt; t1 t2 d1 d2

f_rhs presumably has some big lambdas and dictionary lambdas, so lots
of simplification will now result.  However we don't actually *do* that
simplification.  Rather, we leave it for the simplifier to do.  If we
*did* do it, though, we'd get more call instances from the specialised
RHS.  We can work out what they are by instantiating the call-instance
set from f's RHS with the types t1, t2.

Add this new id to f's IdInfo, to record that f has a specialised version.

Before doing any of this, check that f's IdInfo doesn't already
tell us about an existing instance of f at the required type/s.
(This might happen if specialisation was applied more than once, or
it might arise from user SPECIALIZE pragmas.)

Recursion
~~~~~~~~~
Wait a minute!  What if f is recursive?  Then we can't just plug in
its right-hand side, can we?

But it's ok.  The type checker *always* creates non-recursive definitions
for overloaded recursive functions.  For example:

        f x = f (x+x)           -- Yes I know its silly

becomes

        f a (d::Num a) = let p = +.sel a d
                         in
                         letrec fl (y::a) = fl (p y y)
                         in
                         fl

We still have recursion for non-overloaded functions which we
specialise, but the recursive call should get specialised to the
same recursive version.


Polymorphism 1
~~~~~~~~~~~~~~

All this is crystal clear when the function is applied to *constant
types*; that is, types which have no type variables inside.  But what if
it is applied to non-constant types?  Suppose we find a call of f at type
t1/t2.  There are two possibilities:

(a) The free type variables of t1, t2 are in scope at the definition point
of f.  In this case there's no problem, we proceed just as before.  A common
example is as follows.  Here's the Haskell:

        g y = let f x = x+x
              in f y + f y

After typechecking we have

        g a (d::Num a) (y::a) = let f b (d'::Num b) (x::b) = +.sel b d' x x
                                in +.sel a d (f a d y) (f a d y)

Notice that the call to f is at type type &quot;a&quot;; a non-constant type.
Both calls to f are at the same type, so we can specialise to give:

        g a (d::Num a) (y::a) = let f@a (x::a) = +.sel a d x x
                                in +.sel a d (f@a y) (f@a y)


(b) The other case is when the type variables in the instance types
are *not* in scope at the definition point of f.  The example we are
working with above is a good case.  There are two instances of (+.sel a d),
but &quot;a&quot; is not in scope at the definition of +.sel.  Can we do anything?
Yes, we can &quot;common them up&quot;, a sort of limited common sub-expression deal.
This would give:

        g a (d::Num a) (y::a) = let +.sel@a = +.sel a d
                                    f@a (x::a) = +.sel@a x x
                                in +.sel@a (f@a y) (f@a y)

This can save work, and can't be spotted by the type checker, because
the two instances of +.sel weren't originally at the same type.

Further notes on (b)

* There are quite a few variations here.  For example, the defn of
  +.sel could be floated outside the \y, to attempt to gain laziness.
  It certainly mustn't be floated outside the \d because the d has to
  be in scope too.

* We don't want to inline f_rhs in this case, because
that will duplicate code.  Just commoning up the call is the point.

* Nothing gets added to +.sel's IdInfo.

* Don't bother unless the equivalence class has more than one item!

Not clear whether this is all worth it.  It is of course OK to
simply discard call-instances when passing a big lambda.

Polymorphism 2 -- Overloading
~~~~~~~~~~~~~~
Consider a function whose most general type is

        f :: forall a b. Ord a =&gt; [a] -&gt; b -&gt; b

There is really no point in making a version of g at Int/Int and another
at Int/Bool, because it's only instantiating the type variable &quot;a&quot; which
buys us any efficiency. Since g is completely polymorphic in b there
ain't much point in making separate versions of g for the different
b types.

That suggests that we should identify which of g's type variables
are constrained (like &quot;a&quot;) and which are unconstrained (like &quot;b&quot;).
Then when taking equivalence classes in STEP 2, we ignore the type args
corresponding to unconstrained type variable.  In STEP 3 we make
polymorphic versions.  Thus:

        f@t1/ = /\b -&gt; &lt;f_rhs&gt; t1 b d1 d2

We do this.


Dictionary floating
~~~~~~~~~~~~~~~~~~~
Consider this

        f a (d::Num a) = let g = ...
                         in
                         ...(let d1::Ord a = Num.Ord.sel a d in g a d1)...

Here, g is only called at one type, but the dictionary isn't in scope at the
definition point for g.  Usually the type checker would build a
definition for d1 which enclosed g, but the transformation system
might have moved d1's defn inward.  Solution: float dictionary bindings
outwards along with call instances.

Consider

        f x = let g p q = p==q
                  h r s = (r+s, g r s)
              in
              h x x


Before specialisation, leaving out type abstractions we have

        f df x = let g :: Eq a =&gt; a -&gt; a -&gt; Bool
                     g dg p q = == dg p q
                     h :: Num a =&gt; a -&gt; a -&gt; (a, Bool)
                     h dh r s = let deq = eqFromNum dh
                                in (+ dh r s, g deq r s)
              in
              h df x x

After specialising h we get a specialised version of h, like this:

                    h' r s = let deq = eqFromNum df
                             in (+ df r s, g deq r s)

But we can't naively make an instance for g from this, because deq is not in scope
at the defn of g.  Instead, we have to float out the (new) defn of deq
to widen its scope.  Notice that this floating can't be done in advance -- it only
shows up when specialisation is done.

User SPECIALIZE pragmas
~~~~~~~~~~~~~~~~~~~~~~~
Specialisation pragmas can be digested by the type checker, and implemented
by adding extra definitions along with that of f, in the same way as before

        f@t1/t2 = &lt;f_rhs&gt; t1 t2 d1 d2

Indeed the pragmas *have* to be dealt with by the type checker, because
only it knows how to build the dictionaries d1 and d2!  For example

        g :: Ord a =&gt; [a] -&gt; [a]
        {-# SPECIALIZE f :: [Tree Int] -&gt; [Tree Int] #-}

Here, the specialised version of g is an application of g's rhs to the
Ord dictionary for (Tree Int), which only the type checker can conjure
up.  There might not even *be* one, if (Tree Int) is not an instance of
Ord!  (All the other specialisation has suitable dictionaries to hand
from actual calls.)

Problem.  The type checker doesn't have to hand a convenient &lt;f_rhs&gt;, because
it is buried in a complex (as-yet-un-desugared) binding group.
Maybe we should say

        f@t1/t2 = f* t1 t2 d1 d2

where f* is the Id f with an IdInfo which says &quot;inline me regardless!&quot;.
Indeed all the specialisation could be done in this way.
That in turn means that the simplifier has to be prepared to inline absolutely
any in-scope let-bound thing.


Again, the pragma should permit polymorphism in unconstrained variables:

        h :: Ord a =&gt; [a] -&gt; b -&gt; b
        {-# SPECIALIZE h :: [Int] -&gt; b -&gt; b #-}

We *insist* that all overloaded type variables are specialised to ground types,
(and hence there can be no context inside a SPECIALIZE pragma).
We *permit* unconstrained type variables to be specialised to
        - a ground type
        - or left as a polymorphic type variable
but nothing in between.  So

        {-# SPECIALIZE h :: [Int] -&gt; [c] -&gt; [c] #-}

is *illegal*.  (It can be handled, but it adds complication, and gains the
programmer nothing.)


SPECIALISING INSTANCE DECLARATIONS
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

        instance Foo a =&gt; Foo [a] where
                ...
        {-# SPECIALIZE instance Foo [Int] #-}

The original instance decl creates a dictionary-function
definition:

        dfun.Foo.List :: forall a. Foo a -&gt; Foo [a]

The SPECIALIZE pragma just makes a specialised copy, just as for
ordinary function definitions:

        dfun.Foo.List@Int :: Foo [Int]
        dfun.Foo.List@Int = dfun.Foo.List Int dFooInt

The information about what instance of the dfun exist gets added to
the dfun's IdInfo in the same way as a user-defined function too.


Automatic instance decl specialisation?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Can instance decls be specialised automatically?  It's tricky.
We could collect call-instance information for each dfun, but
then when we specialised their bodies we'd get new call-instances
for ordinary functions; and when we specialised their bodies, we might get
new call-instances of the dfuns, and so on.  This all arises because of
the unrestricted mutual recursion between instance decls and value decls.

Still, there's no actual problem; it just means that we may not do all
the specialisation we could theoretically do.

Furthermore, instance decls are usually exported and used non-locally,
so we'll want to compile enough to get those specialisations done.

Lastly, there's no such thing as a local instance decl, so we can
survive solely by spitting out *usage* information, and then reading that
back in as a pragma when next compiling the file.  So for now,
we only specialise instance decls in response to pragmas.


SPITTING OUT USAGE INFORMATION
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To spit out usage information we need to traverse the code collecting
call-instance information for all imported (non-prelude?) functions
and data types. Then we equivalence-class it and spit it out.

This is done at the top-level when all the call instances which escape
must be for imported functions and data types.

*** Not currently done ***


Partial specialisation by pragmas
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
What about partial specialisation:

        k :: (Ord a, Eq b) =&gt; [a] -&gt; b -&gt; b -&gt; [a]
        {-# SPECIALIZE k :: Eq b =&gt; [Int] -&gt; b -&gt; b -&gt; [a] #-}

or even

        {-# SPECIALIZE k :: Eq b =&gt; [Int] -&gt; [b] -&gt; [b] -&gt; [a] #-}

Seems quite reasonable.  Similar things could be done with instance decls:

        instance (Foo a, Foo b) =&gt; Foo (a,b) where
                ...
        {-# SPECIALIZE instance Foo a =&gt; Foo (a,Int) #-}
        {-# SPECIALIZE instance Foo b =&gt; Foo (Int,b) #-}

Ho hum.  Things are complex enough without this.  I pass.


Requirements for the simplifier
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The simplifier has to be able to take advantage of the specialisation.

* When the simplifier finds an application of a polymorphic f, it looks in
f's IdInfo in case there is a suitable instance to call instead.  This converts

        f t1 t2 d1 d2   ===&gt;   f_t1_t2

Note that the dictionaries get eaten up too!

* Dictionary selection operations on constant dictionaries must be
  short-circuited:

        +.sel Int d     ===&gt;  +Int

The obvious way to do this is in the same way as other specialised
calls: +.sel has inside it some IdInfo which tells that if it's applied
to the type Int then it should eat a dictionary and transform to +Int.

In short, dictionary selectors need IdInfo inside them for constant
methods.

* Exactly the same applies if a superclass dictionary is being
  extracted:

        Eq.sel Int d   ===&gt;   dEqInt

* Something similar applies to dictionary construction too.  Suppose
dfun.Eq.List is the function taking a dictionary for (Eq a) to
one for (Eq [a]).  Then we want

        dfun.Eq.List Int d      ===&gt; dEq.List_Int

Where does the Eq [Int] dictionary come from?  It is built in
response to a SPECIALIZE pragma on the Eq [a] instance decl.

In short, dfun Ids need IdInfo with a specialisation for each
constant instance of their instance declaration.

All this uses a single mechanism: the SpecEnv inside an Id


What does the specialisation IdInfo look like?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The SpecEnv of an Id maps a list of types (the template) to an expression

        [Type]  |-&gt;  Expr

For example, if f has this RuleInfo:

        [Int, a]  -&gt;  \d:Ord Int. f' a

it means that we can replace the call

        f Int t  ===&gt;  (\d. f' t)

This chucks one dictionary away and proceeds with the
specialised version of f, namely f'.


What can't be done this way?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There is no way, post-typechecker, to get a dictionary for (say)
Eq a from a dictionary for Eq [a].  So if we find

        ==.sel [t] d

we can't transform to

        eqList (==.sel t d')

where
        eqList :: (a-&gt;a-&gt;Bool) -&gt; [a] -&gt; [a] -&gt; Bool

Of course, we currently have no way to automatically derive
eqList, nor to connect it to the Eq [a] instance decl, but you
can imagine that it might somehow be possible.  Taking advantage
of this is permanently ruled out.

Still, this is no great hardship, because we intend to eliminate
overloading altogether anyway!

A note about non-tyvar dictionaries
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Some Ids have types like

        forall a,b,c. Eq a -&gt; Ord [a] -&gt; tau

This seems curious at first, because we usually only have dictionary
args whose types are of the form (C a) where a is a type variable.
But this doesn't hold for the functions arising from instance decls,
which sometimes get arguments with types of form (C (T a)) for some
type constructor T.

Should we specialise wrt this compound-type dictionary?  We used to say
&quot;no&quot;, saying:
        &quot;This is a heuristic judgement, as indeed is the fact that we
        specialise wrt only dictionaries.  We choose *not* to specialise
        wrt compound dictionaries because at the moment the only place
        they show up is in instance decls, where they are simply plugged
        into a returned dictionary.  So nothing is gained by specialising
        wrt them.&quot;

But it is simpler and more uniform to specialise wrt these dicts too;
and in future GHC is likely to support full fledged type signatures
like
        f :: Eq [(a,b)] =&gt; ...


Note [Specialisation and overlapping instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here is at tricky case (see a comment in MR !8916):

    module A where
      class C a where
        meth :: a -&gt; String
      instance {-# OVERLAPPABLE #-} C (Maybe a) where
        meth _ = &quot;Maybe&quot;

      {-# SPECIALISE f :: Maybe a -&gt; Bool -&gt; String #-}
      f :: C a =&gt; a -&gt; Bool -&gt; String
      f a True = f a False
      f a _    = meth a

    module B where
      import A

      instance C (Maybe Int) where
        meth _ = &quot;Int&quot;

      main = putStrLn $ f (Just 42 :: Maybe Int) True

Running main without optimisations yields &quot;Int&quot;, the correct answer.
Activating optimisations yields &quot;Maybe&quot; due to a rewrite rule in module
A generated by the SPECIALISE pragma:

    RULE &quot;USPEC f&quot; forall a (d :: C a). f @a d = $sf

In B we get the call (f @(Maybe Int) (d :: C (Maybe Int))), and
that rewrites to $sf, but that isn't really right.

Overlapping instances mean that `C (Maybe Int)` is not a singleton
type: there two distinct dictionaries that have this type.  And that
spells trouble for specialistion, which really asssumes singleton
types.

For now, we just accept this problem, but it may bite us one day.
One solution would be to decline to expose any specialisation rules
to an importing module -- but that seems a bit drastic.


************************************************************************
*                                                                      *
\subsubsection{The new specialiser}
*                                                                      *
************************************************************************

Our basic game plan is this.  For let(rec) bound function
        f :: (C a, D c) =&gt; (a,b,c,d) -&gt; Bool

* Find any specialised calls of f, (f ts ds), where
  ts are the type arguments t1 .. t4, and
  ds are the dictionary arguments d1 .. d2.

* Add a new definition for f1 (say):

        f1 = /\ b d -&gt; (..body of f..) t1 b t3 d d1 d2

  Note that we abstract over the unconstrained type arguments.

* Add the mapping

        [t1,b,t3,d]  |-&gt;  \d1 d2 -&gt; f1 b d

  to the specialisations of f.  This will be used by the
  simplifier to replace calls
                (f t1 t2 t3 t4) da db
  by
                (\d1 d1 -&gt; f1 t2 t4) da db

  All the stuff about how many dictionaries to discard, and what types
  to apply the specialised function to, are handled by the fact that the
  SpecEnv contains a template for the result of the specialisation.

We don't build *partial* specialisations for f.  For example:

  f :: Eq a =&gt; a -&gt; a -&gt; Bool
  {-# SPECIALISE f :: (Eq b, Eq c) =&gt; (b,c) -&gt; (b,c) -&gt; Bool #-}

Here, little is gained by making a specialised copy of f.
There's a distinct danger that the specialised version would
first build a dictionary for (Eq b, Eq c), and then select the (==)
method from it!  Even if it didn't, not a great deal is saved.

We do, however, generate polymorphic, but not overloaded, specialisations:

  f :: Eq a =&gt; [a] -&gt; b -&gt; b -&gt; b
  ... SPECIALISE f :: [Int] -&gt; b -&gt; b -&gt; b ...

Hence, the invariant is this:

        *** no specialised version is overloaded ***


************************************************************************
*                                                                      *
\subsubsection{The exported function}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-639"></span><span>
</span><span id="line-640"></span><span class="annot"><span class="hs-comment">-- | Specialise calls to type-class overloaded functions occurring in a program.</span></span><span>
</span><span id="line-641"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specProgram"><span class="hs-identifier hs-type">specProgram</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span>
</span><span id="line-642"></span><span id="specProgram"><span class="annot"><span class="annottext">specProgram :: ModGuts -&gt; CoreM ModGuts
</span><a href="GHC.Core.Opt.Specialise.html#specProgram"><span class="hs-identifier hs-var hs-var">specProgram</span></a></span></span><span> </span><span id="local-6989586621681902715"><span class="annot"><span class="annottext">guts :: ModGuts
</span><a href="#local-6989586621681902715"><span class="hs-identifier hs-var">guts</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mg_module :: ModGuts -&gt; Module
</span><a href="GHC.Unit.Module.ModGuts.html#mg_module"><span class="hs-identifier hs-var">mg_module</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681902718"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681902718"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span>
</span><span id="line-643"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mg_rules :: ModGuts -&gt; [CoreRule]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_rules"><span class="hs-identifier hs-var">mg_rules</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681902720"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902720"><span class="hs-identifier hs-var">local_rules</span></a></span></span><span>
</span><span id="line-644"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mg_binds :: ModGuts -&gt; CoreProgram
</span><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681902722"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902722"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-645"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681902723"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681902723"><span class="hs-identifier hs-var">dflags</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreM DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.Session.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-646"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681902725"><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621681902725"><span class="hs-identifier hs-var">rule_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ModGuts -&gt; CoreM RuleEnv
</span><a href="GHC.Core.Opt.Monad.html#initRuleEnv"><span class="hs-identifier hs-var">initRuleEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621681902715"><span class="hs-identifier hs-var">guts</span></a></span><span>
</span><span id="line-647"></span><span>                     </span><span class="hs-comment">-- See Note [Fire rules in the specialiser]</span><span>
</span><span id="line-648"></span><span>
</span><span id="line-649"></span><span>              </span><span class="hs-comment">-- We need to start with a Subst that knows all the things</span><span>
</span><span id="line-650"></span><span>              </span><span class="hs-comment">-- that are in scope, so that the substitution engine doesn't</span><span>
</span><span id="line-651"></span><span>              </span><span class="hs-comment">-- accidentally re-use a unique that's already in use</span><span>
</span><span id="line-652"></span><span>              </span><span class="hs-comment">-- Easiest thing is to do it all at once, as if all the top-level</span><span>
</span><span id="line-653"></span><span>              </span><span class="hs-comment">-- decls were mutually recursive</span><span>
</span><span id="line-654"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681902727"><span class="annot"><span class="annottext">top_env :: SpecEnv
</span><a href="#local-6989586621681902727"><span class="hs-identifier hs-var hs-var">top_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SE"><span class="hs-identifier hs-type">SE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">se_subst :: Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">Core.mkEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">(InScopeSet -&gt; Subst) -&gt; InScopeSet -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-655"></span><span>                                        </span><span class="annot"><span class="annottext">CoreProgram -&gt; InScopeSet
</span><a href="GHC.Core.Utils.html#mkInScopeSetBndrs"><span class="hs-identifier hs-var">mkInScopeSetBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902722"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-656"></span><span>                                      </span><span class="hs-comment">--    mkInScopeSetList $</span><span>
</span><span id="line-657"></span><span>                                      </span><span class="hs-comment">--  bindersOfBinds binds</span><span>
</span><span id="line-658"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">se_module :: Module
</span><a href="GHC.Core.Opt.Specialise.html#se_module"><span class="hs-identifier hs-var">se_module</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681902718"><span class="hs-identifier hs-var">this_mod</span></a></span><span>
</span><span id="line-659"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">se_rules :: RuleEnv
</span><a href="GHC.Core.Opt.Specialise.html#se_rules"><span class="hs-identifier hs-var">se_rules</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621681902725"><span class="hs-identifier hs-var">rule_env</span></a></span><span>
</span><span id="line-660"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">se_dflags :: DynFlags
</span><a href="GHC.Core.Opt.Specialise.html#se_dflags"><span class="hs-identifier hs-var">se_dflags</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681902723"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-661"></span><span>
</span><span id="line-662"></span><span>             </span><span id="local-6989586621681902734"><span class="annot"><span class="annottext">go :: CoreProgram -&gt; SpecM (CoreProgram, UsageDetails)
</span><a href="#local-6989586621681902734"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreProgram, UsageDetails) -&gt; SpecM (CoreProgram, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-663"></span><span>             </span><span class="annot"><a href="#local-6989586621681902734"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902736"><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681902736"><span class="hs-identifier hs-var">bind</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681902737"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902737"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902738"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902738"><span class="hs-identifier hs-var">bind'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902739"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902739"><span class="hs-identifier hs-var">binds'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902740"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902740"><span class="hs-identifier hs-var">uds'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; SpecEnv
-&gt; InBind
-&gt; (SpecEnv -&gt; SpecM (CoreProgram, UsageDetails))
-&gt; SpecM (CoreProgram, CoreProgram, UsageDetails)
forall body.
TopLevelFlag
-&gt; SpecEnv
-&gt; InBind
-&gt; (SpecEnv -&gt; SpecM (body, UsageDetails))
-&gt; SpecM (CoreProgram, body, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specBind"><span class="hs-identifier hs-var">specBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902727"><span class="hs-identifier hs-var">top_env</span></a></span><span> </span><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681902736"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="annot"><span class="annottext">((SpecEnv -&gt; SpecM (CoreProgram, UsageDetails))
 -&gt; SpecM (CoreProgram, CoreProgram, UsageDetails))
-&gt; (SpecEnv -&gt; SpecM (CoreProgram, UsageDetails))
-&gt; SpecM (CoreProgram, CoreProgram, UsageDetails)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">SpecEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-664"></span><span>                                                           </span><span class="annot"><span class="annottext">CoreProgram -&gt; SpecM (CoreProgram, UsageDetails)
</span><a href="#local-6989586621681902734"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902737"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-665"></span><span>                                  </span><span class="annot"><span class="annottext">(CoreProgram, UsageDetails) -&gt; SpecM (CoreProgram, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902738"><span class="hs-identifier hs-var">bind'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; CoreProgram -&gt; CoreProgram
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902739"><span class="hs-identifier hs-var">binds'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902740"><span class="hs-identifier hs-var">uds'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-666"></span><span>
</span><span id="line-667"></span><span>             </span><span class="hs-comment">-- Specialise the bindings of this module</span><span>
</span><span id="line-668"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902743"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902743"><span class="hs-identifier hs-var">binds'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902744"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902744"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecM (CoreProgram, UsageDetails)
-&gt; CoreM (CoreProgram, UsageDetails)
forall a. SpecM a -&gt; CoreM a
</span><a href="GHC.Core.Opt.Specialise.html#runSpecM"><span class="hs-identifier hs-var">runSpecM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreProgram -&gt; SpecM (CoreProgram, UsageDetails)
</span><a href="#local-6989586621681902734"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902722"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902746"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902746"><span class="hs-identifier hs-var">spec_rules</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902747"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902747"><span class="hs-identifier hs-var">spec_binds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; UsageDetails -&gt; CoreM ([CoreRule], CoreProgram)
</span><a href="GHC.Core.Opt.Specialise.html#specImports"><span class="hs-identifier hs-var">specImports</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902727"><span class="hs-identifier hs-var">top_env</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902744"><span class="hs-identifier hs-var">uds</span></a></span><span>
</span><span id="line-671"></span><span>
</span><span id="line-672"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ModGuts -&gt; CoreM ModGuts
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621681902715"><span class="hs-identifier hs-var">guts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681902747"><span class="hs-identifier hs-type">spec_binds</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-type">++</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681902743"><span class="hs-identifier hs-type">binds'</span></a></span><span>
</span><span id="line-673"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_rules"><span class="hs-identifier hs-var">mg_rules</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681902746"><span class="hs-identifier hs-type">spec_rules</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-type">++</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681902720"><span class="hs-identifier hs-type">local_rules</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span class="hs-comment">{-
Note [Wrap bindings returned by specImports]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
'specImports' returns a set of specialized bindings. However, these are lacking
necessary floated dictionary bindings, which are returned by
UsageDetails(ud_binds). These dictionaries need to be brought into scope with
'wrapDictBinds' before the bindings returned by 'specImports' can be used. See,
for instance, the 'specImports' call in 'specProgram'.


Note [Disabling cross-module specialisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Since GHC 7.10 we have performed specialisation of INLINABLE bindings living
in modules outside of the current module. This can sometimes uncover user code
which explodes in size when aggressively optimized. The
-fno-cross-module-specialise option was introduced to allow users to being
bitten by such instances to revert to the pre-7.10 behavior.

See #10491
-}</span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span>
</span><span id="line-697"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   Specialising imported functions
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-702"></span><span>
</span><span id="line-703"></span><span class="hs-comment">{- Note [Specialising imported functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
specImports specialises imported functions, based on calls in this module.

When -fspecialise-aggressively is on, we specialise any imported
function for which we have an unfolding.  The
-fspecialise-aggressively flag is usually off, because we risk lots of
orphan modules from over-vigorous specialisation.  (See Note [Orphans]
in GHC.Core.) However it's not a big deal: anything non-recursive with
an unfolding-template will probably have been inlined already.

When -fspecialise-aggressively is off, we are more selective about
specialisation (see canSpecImport):

(1) Without -fspecialise-aggressively, do not specialise
    DFunUnfoldings. Note [Do not specialise imported DFuns].

(2) Without -fspecialise-aggressively, specialise only imported things
    that have a /user-supplied/ INLINE or INLINABLE pragma (hence
    isAnyInlinePragma rather than isStableSource).

    In particular, we don't want to specialise workers created by
    worker/wrapper (for functions with no pragma) because they won't
    specialise usefully, and they generate quite a bit of useless code
    bloat.

    Specialise even INLINE things; it hasn't inlined yet, so perhaps
    it never will.  Moreover it may have calls inside it that we want
    to specialise

Wrinkle (W1): If we specialise an imported Id M.foo, we make a /local/
binding $sfoo.  But specImports may further specialise $sfoo. So we end up
with RULES for both M.foo (imported) and $sfoo (local).  Rules for local
Ids should be attached to the Ids themselves (see GHC.HsToCore
Note [Attach rules to local ids]); so we must partition the rules and
attach the local rules.  That is done in specImports, via addRulesToId.

Note [Glom the bindings if imported functions are specialised]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have an imported, *recursive*, INLINABLE function
   f :: Eq a =&gt; a -&gt; a
   f = /\a \d x. ...(f a d)...
In the module being compiled we have
   g x = f (x::Int)
Now we'll make a specialised function
   f_spec :: Int -&gt; Int
   f_spec = \x -&gt; ...(f Int dInt)...
   {-# RULE  f Int _ = f_spec #-}
   g = \x. f Int dInt x
Note that f_spec doesn't look recursive
After rewriting with the RULE, we get
   f_spec = \x -&gt; ...(f_spec)...
BUT since f_spec was non-recursive before it'll *stay* non-recursive.
The occurrence analyser never turns a NonRec into a Rec.  So we must
make sure that f_spec is recursive.  Easiest thing is to make all
the specialisations for imported bindings recursive.
-}</span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specImports"><span class="hs-identifier hs-type">specImports</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>
</span><span id="line-762"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-763"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-764"></span><span id="specImports"><span class="annot"><span class="annottext">specImports :: SpecEnv -&gt; UsageDetails -&gt; CoreM ([CoreRule], CoreProgram)
</span><a href="GHC.Core.Opt.Specialise.html#specImports"><span class="hs-identifier hs-var hs-var">specImports</span></a></span></span><span> </span><span id="local-6989586621681902750"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902750"><span class="hs-identifier hs-var">top_env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_binds :: UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681902753"><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902753"><span class="hs-identifier hs-var">dict_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_calls :: UsageDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681902755"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681902755"><span class="hs-identifier hs-var">calls</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-765"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_CrossModuleSpecialise"><span class="hs-identifier hs-var">Opt_CrossModuleSpecialise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; DynFlags
</span><a href="GHC.Core.Opt.Specialise.html#se_dflags"><span class="hs-identifier hs-var">se_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902750"><span class="hs-identifier hs-var">top_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-766"></span><span>    </span><span class="hs-comment">-- See Note [Disabling cross-module specialisation]</span><span>
</span><span id="line-767"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([CoreRule], CoreProgram) -&gt; CoreM ([CoreRule], CoreProgram)
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds -&gt; CoreProgram -&gt; CoreProgram
</span><a href="GHC.Core.Opt.Specialise.html#wrapDictBinds"><span class="hs-identifier hs-var">wrapDictBinds</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902753"><span class="hs-identifier hs-var">dict_binds</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-768"></span><span>
</span><span id="line-769"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-770"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681902760"><span class="annot"><span class="annottext">env_w_dict_bndrs :: SpecEnv
</span><a href="#local-6989586621681902760"><span class="hs-identifier hs-var hs-var">env_w_dict_bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902750"><span class="hs-identifier hs-var">top_env</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; FloatedDictBinds -&gt; SpecEnv
</span><a href="GHC.Core.Opt.Specialise.html#bringFloatedDictsIntoScope"><span class="hs-operator hs-var">`bringFloatedDictsIntoScope`</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902753"><span class="hs-identifier hs-var">dict_binds</span></a></span><span>
</span><span id="line-771"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902762"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902762"><span class="hs-identifier hs-var">_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902763"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902763"><span class="hs-identifier hs-var">spec_rules</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902764"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902764"><span class="hs-identifier hs-var">spec_binds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; [Id]
-&gt; FloatedDictBinds
-&gt; CallDetails
-&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
</span><a href="GHC.Core.Opt.Specialise.html#spec_imports"><span class="hs-identifier hs-var">spec_imports</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902760"><span class="hs-identifier hs-var">env_w_dict_bndrs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902753"><span class="hs-identifier hs-var">dict_binds</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681902755"><span class="hs-identifier hs-var">calls</span></a></span><span>
</span><span id="line-772"></span><span>
</span><span id="line-773"></span><span>             </span><span class="hs-comment">-- Make a Rec: see Note [Glom the bindings if imported functions are specialised]</span><span>
</span><span id="line-774"></span><span>             </span><span class="hs-comment">--</span><span>
</span><span id="line-775"></span><span>             </span><span class="hs-comment">-- wrapDictBinds: don't forget to wrap the specialized bindings with</span><span>
</span><span id="line-776"></span><span>             </span><span class="hs-comment">--   bindings for the needed dictionaries.</span><span>
</span><span id="line-777"></span><span>             </span><span class="hs-comment">--   See Note [Wrap bindings returned by specImports]</span><span>
</span><span id="line-778"></span><span>             </span><span class="hs-comment">--</span><span>
</span><span id="line-779"></span><span>             </span><span class="hs-comment">-- addRulesToId: see Wrinkle (W1) in Note [Specialising imported functions]</span><span>
</span><span id="line-780"></span><span>             </span><span class="hs-comment">--               c.f. GHC.HsToCore.addExportFlagsAndRules</span><span>
</span><span id="line-781"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902766"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902766"><span class="hs-identifier hs-var">rules_for_locals</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902767"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902767"><span class="hs-identifier hs-var">rules_for_imps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreRule -&gt; Bool) -&gt; [CoreRule] -&gt; ([CoreRule], [CoreRule])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><a href="../../base-4.18.2.1/src/Data.OldList.html#partition/Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; Bool
</span><a href="GHC.Core.html#isLocalRule"><span class="hs-identifier hs-var">isLocalRule</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902763"><span class="hs-identifier hs-var">spec_rules</span></a></span><span>
</span><span id="line-782"></span><span>             </span><span id="local-6989586621681902769"><span class="annot"><span class="annottext">local_rule_base :: RuleBase
</span><a href="#local-6989586621681902769"><span class="hs-identifier hs-var hs-var">local_rule_base</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleBase -&gt; [CoreRule] -&gt; RuleBase
</span><a href="GHC.Core.Rules.html#extendRuleBaseList"><span class="hs-identifier hs-var">extendRuleBaseList</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="GHC.Core.Rules.html#emptyRuleBase"><span class="hs-identifier hs-var">emptyRuleBase</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902766"><span class="hs-identifier hs-var">rules_for_locals</span></a></span><span>
</span><span id="line-783"></span><span>             </span><span id="local-6989586621681902772"><span class="annot"><span class="annottext">final_binds :: CoreProgram
</span><a href="#local-6989586621681902772"><span class="hs-identifier hs-var hs-var">final_binds</span></a></span></span><span>
</span><span id="line-784"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902764"><span class="hs-identifier hs-var">spec_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds -&gt; CoreProgram -&gt; CoreProgram
</span><a href="GHC.Core.Opt.Specialise.html#wrapDictBinds"><span class="hs-identifier hs-var">wrapDictBinds</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902753"><span class="hs-identifier hs-var">dict_binds</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-785"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; InBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">([(Id, OutExpr)] -&gt; InBind) -&gt; [(Id, OutExpr)] -&gt; InBind
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [(Id, OutExpr)] -&gt; [(Id, OutExpr)]
forall (f :: * -&gt; *) a c b.
Functor f =&gt;
(a -&gt; c) -&gt; f (a, b) -&gt; f (c, b)
</span><a href="GHC.Utils.Misc.html#mapFst"><span class="hs-identifier hs-var">mapFst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleBase -&gt; Id -&gt; Id
</span><a href="GHC.Core.Rules.html#addRulesToId"><span class="hs-identifier hs-var">addRulesToId</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621681902769"><span class="hs-identifier hs-var">local_rule_base</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Id, OutExpr)] -&gt; [(Id, OutExpr)])
-&gt; [(Id, OutExpr)] -&gt; [(Id, OutExpr)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-786"></span><span>                                          </span><span class="annot"><span class="annottext">CoreProgram -&gt; [(Id, OutExpr)]
forall b. [Bind b] -&gt; [(b, Expr b)]
</span><a href="GHC.Core.html#flattenBinds"><span class="hs-identifier hs-var">flattenBinds</span></a></span><span>                          </span><span class="annot"><span class="annottext">(CoreProgram -&gt; [(Id, OutExpr)]) -&gt; CoreProgram -&gt; [(Id, OutExpr)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-787"></span><span>                                          </span><span class="annot"><span class="annottext">FloatedDictBinds -&gt; CoreProgram -&gt; CoreProgram
</span><a href="GHC.Core.Opt.Specialise.html#wrapDictBinds"><span class="hs-identifier hs-var">wrapDictBinds</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902753"><span class="hs-identifier hs-var">dict_binds</span></a></span><span>              </span><span class="annot"><span class="annottext">(CoreProgram -&gt; CoreProgram) -&gt; CoreProgram -&gt; CoreProgram
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-788"></span><span>                                          </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902764"><span class="hs-identifier hs-var">spec_binds</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-789"></span><span>
</span><span id="line-790"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">([CoreRule], CoreProgram) -&gt; CoreM ([CoreRule], CoreProgram)
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902767"><span class="hs-identifier hs-var">rules_for_imps</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902772"><span class="hs-identifier hs-var">final_binds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-791"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-792"></span><span>
</span><span id="line-793"></span><span class="annot"><span class="hs-comment">-- | Specialise a set of calls to imported bindings</span></span><span>
</span><span id="line-794"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#spec_imports"><span class="hs-identifier hs-type">spec_imports</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>          </span><span class="hs-comment">-- Passed in so that all top-level Ids are in scope</span><span>
</span><span id="line-795"></span><span>                                 </span><span class="hs-comment">---In-scope set includes the FloatedDictBinds</span><span>
</span><span id="line-796"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Stack of imported functions being specialised</span><span>
</span><span id="line-797"></span><span>                                 </span><span class="hs-comment">-- See Note [specImport call stack]</span><span>
</span><span id="line-798"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span> </span><span class="hs-comment">-- Dict bindings, used /only/ for filterCalls</span><span>
</span><span id="line-799"></span><span>                                 </span><span class="hs-comment">-- See Note [Avoiding loops in specImports]</span><span>
</span><span id="line-800"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a></span><span>      </span><span class="hs-comment">-- Calls for imported things</span><span>
</span><span id="line-801"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>      </span><span class="hs-comment">-- Env contains the new rules</span><span>
</span><span id="line-802"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- New rules</span><span>
</span><span id="line-803"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Specialised bindings</span><span>
</span><span id="line-804"></span><span id="spec_imports"><span class="annot"><span class="annottext">spec_imports :: SpecEnv
-&gt; [Id]
-&gt; FloatedDictBinds
-&gt; CallDetails
-&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
</span><a href="GHC.Core.Opt.Specialise.html#spec_imports"><span class="hs-identifier hs-var hs-var">spec_imports</span></a></span></span><span> </span><span id="local-6989586621681902778"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902778"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681902779"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902779"><span class="hs-identifier hs-var">callers</span></a></span></span><span> </span><span id="local-6989586621681902780"><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902780"><span class="hs-identifier hs-var">dict_binds</span></a></span></span><span> </span><span id="local-6989586621681902781"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681902781"><span class="hs-identifier hs-var">calls</span></a></span></span><span>
</span><span id="line-805"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681902782"><span class="annot"><span class="annottext">import_calls :: [CallInfoSet]
</span><a href="#local-6989586621681902782"><span class="hs-identifier hs-var hs-var">import_calls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallDetails -&gt; [CallInfoSet]
forall a. DVarEnv a -&gt; [a]
</span><a href="GHC.Types.Var.Env.html#dVarEnvElts"><span class="hs-identifier hs-var">dVarEnvElts</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681902781"><span class="hs-identifier hs-var">calls</span></a></span><span>
</span><span id="line-806"></span><span class="hs-comment">--       ; debugTraceMsg (text &quot;specImports {&quot; &lt;+&gt;</span><span>
</span><span id="line-807"></span><span class="hs-comment">--                         vcat [ text &quot;calls:&quot; &lt;+&gt; ppr import_calls</span><span>
</span><span id="line-808"></span><span class="hs-comment">--                              , text &quot;dict_binds:&quot; &lt;+&gt; ppr dict_binds ])</span><span>
</span><span id="line-809"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902784"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902784"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902785"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902785"><span class="hs-identifier hs-var">rules</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902786"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902786"><span class="hs-identifier hs-var">spec_binds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; [CallInfoSet] -&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
</span><a href="#local-6989586621681902787"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902778"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CallInfoSet]
</span><a href="#local-6989586621681902782"><span class="hs-identifier hs-var">import_calls</span></a></span><span>
</span><span id="line-810"></span><span class="hs-comment">--       ; debugTraceMsg (text &quot;End specImports }&quot; &lt;+&gt; ppr import_calls)</span><span>
</span><span id="line-811"></span><span>
</span><span id="line-812"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(SpecEnv, [CoreRule], CoreProgram)
-&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902784"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902785"><span class="hs-identifier hs-var">rules</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902786"><span class="hs-identifier hs-var">spec_binds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-813"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-814"></span><span>    </span><span class="annot"><a href="#local-6989586621681902787"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-815"></span><span>    </span><span id="local-6989586621681902787"><span class="annot"><span class="annottext">go :: SpecEnv
-&gt; [CallInfoSet] -&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
</span><a href="#local-6989586621681902787"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681902788"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902788"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SpecEnv, [CoreRule], CoreProgram)
-&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902788"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-816"></span><span>    </span><span class="annot"><a href="#local-6989586621681902787"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681902789"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902789"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902790"><span class="annot"><span class="annottext">CallInfoSet
</span><a href="#local-6989586621681902790"><span class="hs-identifier hs-var">cis</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681902791"><span class="annot"><span class="annottext">[CallInfoSet]
</span><a href="#local-6989586621681902791"><span class="hs-identifier hs-var">other_calls</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-817"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- debugTraceMsg (text &quot;specImport {&quot; &lt;+&gt; ppr cis)</span><span>
</span><span id="line-818"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902792"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902792"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902793"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902793"><span class="hs-identifier hs-var">rules1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902794"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902794"><span class="hs-identifier hs-var">spec_binds1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; [Id]
-&gt; FloatedDictBinds
-&gt; CallInfoSet
-&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
</span><a href="GHC.Core.Opt.Specialise.html#spec_import"><span class="hs-identifier hs-var">spec_import</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902789"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902779"><span class="hs-identifier hs-var">callers</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902780"><span class="hs-identifier hs-var">dict_binds</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfoSet
</span><a href="#local-6989586621681902790"><span class="hs-identifier hs-var">cis</span></a></span><span>
</span><span id="line-819"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- debugTraceMsg (text &quot;specImport }&quot; &lt;+&gt; ppr cis)</span><span>
</span><span id="line-820"></span><span>
</span><span id="line-821"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902796"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902796"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902797"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902797"><span class="hs-identifier hs-var">rules2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902798"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902798"><span class="hs-identifier hs-var">spec_binds2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; [CallInfoSet] -&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
</span><a href="#local-6989586621681902787"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902792"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[CallInfoSet]
</span><a href="#local-6989586621681902791"><span class="hs-identifier hs-var">other_calls</span></a></span><span>
</span><span id="line-822"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(SpecEnv, [CoreRule], CoreProgram)
-&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902796"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902793"><span class="hs-identifier hs-var">rules1</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; [CoreRule] -&gt; [CoreRule]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902797"><span class="hs-identifier hs-var">rules2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902794"><span class="hs-identifier hs-var">spec_binds1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; CoreProgram -&gt; CoreProgram
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902798"><span class="hs-identifier hs-var">spec_binds2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-823"></span><span>
</span><span id="line-824"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#spec_import"><span class="hs-identifier hs-type">spec_import</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>               </span><span class="hs-comment">-- Passed in so that all top-level Ids are in scope</span><span>
</span><span id="line-825"></span><span>                                     </span><span class="hs-comment">---In-scope set includes the FloatedDictBinds</span><span>
</span><span id="line-826"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span>                  </span><span class="hs-comment">-- Stack of imported functions being specialised</span><span>
</span><span id="line-827"></span><span>                                     </span><span class="hs-comment">-- See Note [specImport call stack]</span><span>
</span><span id="line-828"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span>      </span><span class="hs-comment">-- Dict bindings, used /only/ for filterCalls</span><span>
</span><span id="line-829"></span><span>                                     </span><span class="hs-comment">-- See Note [Avoiding loops in specImports]</span><span>
</span><span id="line-830"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a></span><span>           </span><span class="hs-comment">-- Imported function and calls for it</span><span>
</span><span id="line-831"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>
</span><span id="line-832"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- New rules</span><span>
</span><span id="line-833"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Specialised bindings</span><span>
</span><span id="line-834"></span><span id="spec_import"><span class="annot"><span class="annottext">spec_import :: SpecEnv
-&gt; [Id]
-&gt; FloatedDictBinds
-&gt; CallInfoSet
-&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
</span><a href="GHC.Core.Opt.Specialise.html#spec_import"><span class="hs-identifier hs-var hs-var">spec_import</span></a></span></span><span> </span><span id="local-6989586621681902799"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902799"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681902800"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902800"><span class="hs-identifier hs-var">callers</span></a></span></span><span> </span><span id="local-6989586621681902801"><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902801"><span class="hs-identifier hs-var">dict_binds</span></a></span></span><span> </span><span id="local-6989586621681902802"><span class="annot"><span class="annottext">cis :: CallInfoSet
</span><a href="#local-6989586621681902802"><span class="hs-identifier hs-var">cis</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CIS"><span class="hs-identifier hs-type">CIS</span></a></span><span> </span><span id="local-6989586621681902804"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902804"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bag CallInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-835"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String -&gt; Id -&gt; [Id] -&gt; Bool
forall a. Eq a =&gt; String -&gt; a -&gt; [a] -&gt; Bool
</span><a href="GHC.Data.List.SetOps.html#isIn"><span class="hs-identifier hs-var">isIn</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;specImport&quot;</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902804"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902800"><span class="hs-identifier hs-var">callers</span></a></span><span>
</span><span id="line-836"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SpecEnv, [CoreRule], CoreProgram)
-&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902799"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- No warning.  This actually happens all the time</span><span>
</span><span id="line-837"></span><span>                          </span><span class="hs-comment">-- when specialising a recursive function, because</span><span>
</span><span id="line-838"></span><span>                          </span><span class="hs-comment">-- the RHS of the specialised function contains a recursive</span><span>
</span><span id="line-839"></span><span>                          </span><span class="hs-comment">-- call to the original function</span><span>
</span><span id="line-840"></span><span>
</span><span id="line-841"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[CallInfo] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681902806"><span class="hs-identifier hs-var">good_calls</span></a></span><span>
</span><span id="line-842"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SpecEnv, [CoreRule], CoreProgram)
-&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902799"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-843"></span><span>
</span><span id="line-844"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681902807"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902807"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Id -&gt; Maybe OutExpr
</span><a href="GHC.Core.Opt.Specialise.html#canSpecImport"><span class="hs-identifier hs-var">canSpecImport</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681902809"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902804"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-845"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>     </span><span class="hs-comment">-- Get rules from the external package state</span><span>
</span><span id="line-846"></span><span>             </span><span class="hs-comment">-- We keep doing this in case we &quot;page-fault in&quot;</span><span>
</span><span id="line-847"></span><span>             </span><span class="hs-comment">-- more rules as we go along</span><span>
</span><span id="line-848"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681902810"><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621681902810"><span class="hs-identifier hs-var">eps_rules</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreM RuleBase
</span><a href="GHC.Core.Opt.Monad.html#getExternalRuleBase"><span class="hs-identifier hs-var">getExternalRuleBase</span></a></span><span>
</span><span id="line-849"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681902812"><span class="annot"><span class="annottext">rule_env :: RuleEnv
</span><a href="#local-6989586621681902812"><span class="hs-identifier hs-var hs-var">rule_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; RuleEnv
</span><a href="GHC.Core.Opt.Specialise.html#se_rules"><span class="hs-identifier hs-var">se_rules</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902799"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RuleEnv -&gt; RuleBase -&gt; RuleEnv
</span><a href="GHC.Core.Rules.html#updExternalPackageRules"><span class="hs-operator hs-var">`updExternalPackageRules`</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBase
</span><a href="#local-6989586621681902810"><span class="hs-identifier hs-var">eps_rules</span></a></span><span>
</span><span id="line-850"></span><span>
</span><span id="line-851"></span><span class="hs-comment">--       ; debugTraceMsg (text &quot;specImport1&quot; &lt;+&gt; vcat</span><span>
</span><span id="line-852"></span><span class="hs-comment">--           [ text &quot;function:&quot; &lt;+&gt; ppr fn</span><span>
</span><span id="line-853"></span><span class="hs-comment">--           , text &quot;good calls:&quot; &lt;+&gt; ppr good_calls</span><span>
</span><span id="line-854"></span><span class="hs-comment">--           , text &quot;existing rules:&quot; &lt;+&gt; ppr (getRules rule_env fn)</span><span>
</span><span id="line-855"></span><span class="hs-comment">--           , text &quot;rhs:&quot; &lt;+&gt; ppr rhs</span><span>
</span><span id="line-856"></span><span class="hs-comment">--           , text &quot;dict_binds:&quot; &lt;+&gt; ppr dict_binds ])</span><span>
</span><span id="line-857"></span><span>
</span><span id="line-858"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902814"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902814"><span class="hs-identifier hs-var">rules1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902815"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681902815"><span class="hs-identifier hs-var">spec_pairs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_binds :: UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681902816"><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902816"><span class="hs-identifier hs-var">dict_binds1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_calls :: UsageDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681902817"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681902817"><span class="hs-identifier hs-var">new_calls</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-859"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
-&gt; CoreM ([CoreRule], [(Id, OutExpr)], UsageDetails)
forall a. SpecM a -&gt; CoreM a
</span><a href="GHC.Core.Opt.Specialise.html#runSpecM"><span class="hs-identifier hs-var">runSpecM</span></a></span><span> </span><span class="annot"><span class="annottext">(SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
 -&gt; CoreM ([CoreRule], [(Id, OutExpr)], UsageDetails))
-&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
-&gt; CoreM ([CoreRule], [(Id, OutExpr)], UsageDetails)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SpecEnv
-&gt; [CoreRule]
-&gt; [CallInfo]
-&gt; Id
-&gt; OutExpr
-&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specCalls"><span class="hs-identifier hs-var">specCalls</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902799"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleEnv -&gt; Id -&gt; [CoreRule]
</span><a href="GHC.Core.Rules.html#getRules"><span class="hs-identifier hs-var">getRules</span></a></span><span> </span><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621681902812"><span class="hs-identifier hs-var">rule_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902804"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681902806"><span class="hs-identifier hs-var">good_calls</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902804"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902807"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-860"></span><span>
</span><span id="line-861"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681902820"><span class="annot"><span class="annottext">spec_binds1 :: CoreProgram
</span><a href="#local-6989586621681902820"><span class="hs-identifier hs-var hs-var">spec_binds1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; OutExpr -&gt; InBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902822"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902823"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902822"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902822"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681902823"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902823"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681902815"><span class="hs-identifier hs-var">spec_pairs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-862"></span><span>             </span><span class="hs-comment">-- After the rules kick in, via fireRewriteRules, we may get recursion,</span><span>
</span><span id="line-863"></span><span>             </span><span class="hs-comment">-- but we rely on a global GlomBinds to sort that out later</span><span>
</span><span id="line-864"></span><span>             </span><span class="hs-comment">-- See Note [Glom the bindings if imported functions are specialised]</span><span>
</span><span id="line-865"></span><span>             </span><span class="hs-comment">-- Meanwhile, though, bring the binders into scope</span><span>
</span><span id="line-866"></span><span>
</span><span id="line-867"></span><span>             </span><span id="local-6989586621681902824"><span class="annot"><span class="annottext">new_subst :: Subst
</span><a href="#local-6989586621681902824"><span class="hs-identifier hs-var hs-var">new_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902799"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [Id] -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendSubstInScopeList"><span class="hs-operator hs-var">`Core.extendSubstInScopeList`</span></a></span><span> </span><span class="annot"><span class="annottext">((Id, OutExpr) -&gt; Id) -&gt; [(Id, OutExpr)] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, OutExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.2.1/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681902815"><span class="hs-identifier hs-var">spec_pairs</span></a></span><span>
</span><span id="line-868"></span><span>             </span><span id="local-6989586621681902827"><span class="annot"><span class="annottext">new_env :: SpecEnv
</span><a href="#local-6989586621681902827"><span class="hs-identifier hs-var hs-var">new_env</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902799"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_rules"><span class="hs-identifier hs-var">se_rules</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681902812"><span class="hs-identifier hs-type">rule_env</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#addLocalRules"><span class="hs-operator hs-type">`addLocalRules`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681902814"><span class="hs-identifier hs-type">rules1</span></a></span><span>
</span><span id="line-869"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681902824"><span class="hs-identifier hs-type">new_subst</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-870"></span><span>                         </span><span class="annot"><span class="annottext">SpecEnv -&gt; FloatedDictBinds -&gt; SpecEnv
</span><a href="GHC.Core.Opt.Specialise.html#bringFloatedDictsIntoScope"><span class="hs-operator hs-var">`bringFloatedDictsIntoScope`</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902816"><span class="hs-identifier hs-var">dict_binds1</span></a></span><span>
</span><span id="line-871"></span><span>
</span><span id="line-872"></span><span>       </span><span class="hs-comment">-- Now specialise any cascaded calls</span><span>
</span><span id="line-873"></span><span class="hs-comment">--       ; debugTraceMsg (text &quot;specImport 2&quot; &lt;+&gt; vcat</span><span>
</span><span id="line-874"></span><span class="hs-comment">--           [ text &quot;function:&quot; &lt;+&gt; ppr fn</span><span>
</span><span id="line-875"></span><span class="hs-comment">--           , text &quot;rules1:&quot; &lt;+&gt; ppr rules1</span><span>
</span><span id="line-876"></span><span class="hs-comment">--           , text &quot;spec_binds1&quot; &lt;+&gt; ppr spec_binds1</span><span>
</span><span id="line-877"></span><span class="hs-comment">--           , text &quot;dict_binds1&quot; &lt;+&gt; ppr dict_binds1</span><span>
</span><span id="line-878"></span><span class="hs-comment">--           , text &quot;new_calls&quot; &lt;+&gt; ppr new_calls ])</span><span>
</span><span id="line-879"></span><span>
</span><span id="line-880"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902829"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902829"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902830"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902830"><span class="hs-identifier hs-var">rules2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902831"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902831"><span class="hs-identifier hs-var">spec_binds2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-881"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; [Id]
-&gt; FloatedDictBinds
-&gt; CallDetails
-&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
</span><a href="GHC.Core.Opt.Specialise.html#spec_imports"><span class="hs-identifier hs-var">spec_imports</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902827"><span class="hs-identifier hs-var">new_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902804"><span class="hs-identifier hs-var">fn</span></a></span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902800"><span class="hs-identifier hs-var">callers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-882"></span><span>                                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902801"><span class="hs-identifier hs-var">dict_binds</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds -&gt; FloatedDictBinds -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#thenFDBs"><span class="hs-operator hs-var">`thenFDBs`</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902816"><span class="hs-identifier hs-var">dict_binds1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-883"></span><span>                                    </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681902817"><span class="hs-identifier hs-var">new_calls</span></a></span><span>
</span><span id="line-884"></span><span>
</span><span id="line-885"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681902833"><span class="annot"><span class="annottext">final_binds :: CoreProgram
</span><a href="#local-6989586621681902833"><span class="hs-identifier hs-var hs-var">final_binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds -&gt; CoreProgram -&gt; CoreProgram
</span><a href="GHC.Core.Opt.Specialise.html#wrapDictBinds"><span class="hs-identifier hs-var">wrapDictBinds</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902816"><span class="hs-identifier hs-var">dict_binds1</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreProgram -&gt; CoreProgram) -&gt; CoreProgram -&gt; CoreProgram
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-886"></span><span>                           </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902831"><span class="hs-identifier hs-var">spec_binds2</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; CoreProgram -&gt; CoreProgram
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902820"><span class="hs-identifier hs-var">spec_binds1</span></a></span><span>
</span><span id="line-887"></span><span>
</span><span id="line-888"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(SpecEnv, [CoreRule], CoreProgram)
-&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902829"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902830"><span class="hs-identifier hs-var">rules2</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; [CoreRule] -&gt; [CoreRule]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681902814"><span class="hs-identifier hs-var">rules1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902833"><span class="hs-identifier hs-var">final_binds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-889"></span><span>
</span><span id="line-890"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-891"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; [Id] -&gt; Id -&gt; [CallInfo] -&gt; CoreM ()
</span><a href="GHC.Core.Opt.Specialise.html#tryWarnMissingSpecs"><span class="hs-identifier hs-var">tryWarnMissingSpecs</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681902809"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902800"><span class="hs-identifier hs-var">callers</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902804"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681902806"><span class="hs-identifier hs-var">good_calls</span></a></span><span>
</span><span id="line-892"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(SpecEnv, [CoreRule], CoreProgram)
-&gt; CoreM (SpecEnv, [CoreRule], CoreProgram)
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902799"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-893"></span><span>
</span><span id="line-894"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-895"></span><span>    </span><span id="local-6989586621681902809"><span class="annot"><span class="annottext">dflags :: DynFlags
</span><a href="#local-6989586621681902809"><span class="hs-identifier hs-var hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; DynFlags
</span><a href="GHC.Core.Opt.Specialise.html#se_dflags"><span class="hs-identifier hs-var">se_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902799"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-896"></span><span>    </span><span id="local-6989586621681902806"><span class="annot"><span class="annottext">good_calls :: [CallInfo]
</span><a href="#local-6989586621681902806"><span class="hs-identifier hs-var hs-var">good_calls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallInfoSet -&gt; FloatedDictBinds -&gt; [CallInfo]
</span><a href="GHC.Core.Opt.Specialise.html#filterCalls"><span class="hs-identifier hs-var">filterCalls</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfoSet
</span><a href="#local-6989586621681902802"><span class="hs-identifier hs-var">cis</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681902801"><span class="hs-identifier hs-var">dict_binds</span></a></span><span>
</span><span id="line-897"></span><span>       </span><span class="hs-comment">-- SUPER IMPORTANT!  Drop calls that (directly or indirectly) refer to fn</span><span>
</span><span id="line-898"></span><span>       </span><span class="hs-comment">-- See Note [Avoiding loops in specImports]</span><span>
</span><span id="line-899"></span><span>
</span><span id="line-900"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#canSpecImport"><span class="hs-identifier hs-type">canSpecImport</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-901"></span><span id="canSpecImport"><span class="annot"><span class="annottext">canSpecImport :: DynFlags -&gt; Id -&gt; Maybe OutExpr
</span><a href="GHC.Core.Opt.Specialise.html#canSpecImport"><span class="hs-identifier hs-var hs-var">canSpecImport</span></a></span></span><span> </span><span id="local-6989586621681902837"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681902837"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621681902838"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902838"><span class="hs-identifier hs-var">fn</span></a></span></span><span>
</span><span id="line-902"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDataConWrapId"><span class="hs-identifier hs-var">isDataConWrapId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902838"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-903"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe OutExpr
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>   </span><span class="hs-comment">-- Don't specialise data-con wrappers, even if they</span><span>
</span><span id="line-904"></span><span>              </span><span class="hs-comment">-- have dict args; there is no benefit.</span><span>
</span><span id="line-905"></span><span>
</span><span id="line-906"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreUnfolding"><span class="hs-identifier hs-type">CoreUnfolding</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">uf_tmpl :: Unfolding -&gt; OutExpr
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681902842"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902842"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681902843"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-907"></span><span>    </span><span class="hs-comment">-- CoreUnfolding: see Note [Specialising imported functions] point (1).</span><span>
</span><span id="line-908"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InlinePragma -&gt; Bool
</span><a href="GHC.Types.Basic.html#isAnyInlinePragma"><span class="hs-identifier hs-var">isAnyInlinePragma</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; InlinePragma
</span><a href="GHC.Types.Id.html#idInlinePragma"><span class="hs-identifier hs-var">idInlinePragma</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902838"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-909"></span><span>    </span><span class="hs-comment">-- See Note [Specialising imported functions] point (2).</span><span>
</span><span id="line-910"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Maybe OutExpr
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902842"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-911"></span><span>
</span><span id="line-912"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_SpecialiseAggressively"><span class="hs-identifier hs-var">Opt_SpecialiseAggressively</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681902837"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-913"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Maybe OutExpr
</span><a href="GHC.Core.html#maybeUnfoldingTemplate"><span class="hs-identifier hs-var">maybeUnfoldingTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681902843"><span class="hs-identifier hs-var">unf</span></a></span><span>
</span><span id="line-914"></span><span>    </span><span class="hs-comment">-- With -fspecialise-aggressively, specialise anything</span><span>
</span><span id="line-915"></span><span>    </span><span class="hs-comment">-- with an unfolding, stable or not, DFun or not</span><span>
</span><span id="line-916"></span><span>
</span><span id="line-917"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe OutExpr
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-918"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-919"></span><span>    </span><span id="local-6989586621681902843"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621681902843"><span class="hs-identifier hs-var hs-var">unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unfolding
</span><a href="GHC.Types.Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902838"><span class="hs-identifier hs-var">fn</span></a></span><span>   </span><span class="hs-comment">-- We want to see the unfolding even for loop breakers</span><span>
</span><span id="line-920"></span><span>
</span><span id="line-921"></span><span class="hs-comment">-- | Returns whether or not to show a missed-spec warning.</span><span>
</span><span id="line-922"></span><span class="hs-comment">-- If -Wall-missed-specializations is on, show the warning.</span><span>
</span><span id="line-923"></span><span class="hs-comment">-- Otherwise, if -Wmissed-specializations is on, only show a warning</span><span>
</span><span id="line-924"></span><span class="hs-comment">-- if there is at least one imported function being specialized,</span><span>
</span><span id="line-925"></span><span class="hs-comment">-- and if all imported functions are marked with an inline pragma</span><span>
</span><span id="line-926"></span><span class="hs-comment">-- Use the most specific warning as the reason.</span><span>
</span><span id="line-927"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#tryWarnMissingSpecs"><span class="hs-identifier hs-type">tryWarnMissingSpecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-928"></span><span class="hs-comment">-- See Note [Warning about missed specialisations]</span><span>
</span><span id="line-929"></span><span id="tryWarnMissingSpecs"><span class="annot"><span class="annottext">tryWarnMissingSpecs :: DynFlags -&gt; [Id] -&gt; Id -&gt; [CallInfo] -&gt; CoreM ()
</span><a href="GHC.Core.Opt.Specialise.html#tryWarnMissingSpecs"><span class="hs-identifier hs-var hs-var">tryWarnMissingSpecs</span></a></span></span><span> </span><span id="local-6989586621681902849"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681902849"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621681902850"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902850"><span class="hs-identifier hs-var">callers</span></a></span></span><span> </span><span id="local-6989586621681902851"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902851"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681902852"><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681902852"><span class="hs-identifier hs-var">calls_for_fn</span></a></span></span><span>
</span><span id="line-930"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isClassOpId"><span class="hs-identifier hs-var">isClassOpId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902851"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; CoreM ()
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Missed specialisation for ClassOps]</span><span>
</span><span id="line-931"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WarningFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#wopt"><span class="hs-identifier hs-var">wopt</span></a></span><span> </span><span class="annot"><span class="annottext">WarningFlag
</span><a href="GHC.Driver.Flags.html#Opt_WarnMissedSpecs"><span class="hs-identifier hs-var">Opt_WarnMissedSpecs</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681902849"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-932"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902850"><span class="hs-identifier hs-var">callers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-933"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681902857"><span class="hs-identifier hs-var">allCallersInlined</span></a></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiagnosticReason -&gt; CoreM ()
</span><a href="#local-6989586621681902858"><span class="hs-identifier hs-var">doWarn</span></a></span><span> </span><span class="annot"><span class="annottext">(DiagnosticReason -&gt; CoreM ()) -&gt; DiagnosticReason -&gt; CoreM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WarningFlag -&gt; DiagnosticReason
</span><a href="GHC.Types.Error.html#WarningWithFlag"><span class="hs-identifier hs-var">WarningWithFlag</span></a></span><span> </span><span class="annot"><span class="annottext">WarningFlag
</span><a href="GHC.Driver.Flags.html#Opt_WarnMissedSpecs"><span class="hs-identifier hs-var">Opt_WarnMissedSpecs</span></a></span><span>
</span><span id="line-934"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">WarningFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#wopt"><span class="hs-identifier hs-var">wopt</span></a></span><span> </span><span class="annot"><span class="annottext">WarningFlag
</span><a href="GHC.Driver.Flags.html#Opt_WarnAllMissedSpecs"><span class="hs-identifier hs-var">Opt_WarnAllMissedSpecs</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681902849"><span class="hs-identifier hs-var">dflags</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiagnosticReason -&gt; CoreM ()
</span><a href="#local-6989586621681902858"><span class="hs-identifier hs-var">doWarn</span></a></span><span> </span><span class="annot"><span class="annottext">(DiagnosticReason -&gt; CoreM ()) -&gt; DiagnosticReason -&gt; CoreM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WarningFlag -&gt; DiagnosticReason
</span><a href="GHC.Types.Error.html#WarningWithFlag"><span class="hs-identifier hs-var">WarningWithFlag</span></a></span><span> </span><span class="annot"><span class="annottext">WarningFlag
</span><a href="GHC.Driver.Flags.html#Opt_WarnAllMissedSpecs"><span class="hs-identifier hs-var">Opt_WarnAllMissedSpecs</span></a></span><span>
</span><span id="line-935"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; CoreM ()
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-936"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-937"></span><span>    </span><span id="local-6989586621681902857"><span class="annot"><span class="annottext">allCallersInlined :: Bool
</span><a href="#local-6989586621681902857"><span class="hs-identifier hs-var hs-var">allCallersInlined</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#all/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InlinePragma -&gt; Bool
</span><a href="GHC.Types.Basic.html#isAnyInlinePragma"><span class="hs-identifier hs-var">isAnyInlinePragma</span></a></span><span> </span><span class="annot"><span class="annottext">(InlinePragma -&gt; Bool) -&gt; (Id -&gt; InlinePragma) -&gt; Id -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; InlinePragma
</span><a href="GHC.Types.Id.html#idInlinePragma"><span class="hs-identifier hs-var">idInlinePragma</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902850"><span class="hs-identifier hs-var">callers</span></a></span><span>
</span><span id="line-938"></span><span>    </span><span id="local-6989586621681902863"><span class="annot"><span class="annottext">diag_opts :: DiagOpts
</span><a href="#local-6989586621681902863"><span class="hs-identifier hs-var hs-var">diag_opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; DiagOpts
</span><a href="GHC.Driver.Config.Diagnostic.html#initDiagOpts"><span class="hs-identifier hs-var">initDiagOpts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681902849"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-939"></span><span>    </span><span id="local-6989586621681902858"><span class="annot"><span class="annottext">doWarn :: DiagnosticReason -&gt; CoreM ()
</span><a href="#local-6989586621681902858"><span class="hs-identifier hs-var hs-var">doWarn</span></a></span></span><span> </span><span id="local-6989586621681902865"><span class="annot"><span class="annottext">DiagnosticReason
</span><a href="#local-6989586621681902865"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-940"></span><span>      </span><span class="annot"><span class="annottext">MessageClass -&gt; SDoc -&gt; CoreM ()
</span><a href="GHC.Core.Opt.Monad.html#msg"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiagOpts
-&gt; DiagnosticReason -&gt; Maybe DiagnosticCode -&gt; MessageClass
</span><a href="GHC.Utils.Error.html#mkMCDiagnostic"><span class="hs-identifier hs-var">mkMCDiagnostic</span></a></span><span> </span><span class="annot"><span class="annottext">DiagOpts
</span><a href="#local-6989586621681902863"><span class="hs-identifier hs-var">diag_opts</span></a></span><span> </span><span class="annot"><span class="annottext">DiagnosticReason
</span><a href="#local-6989586621681902865"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DiagnosticCode
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-941"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Could not specialise imported function&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902851"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-942"></span><span>                </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;when specialising&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902873"><span class="hs-identifier hs-var">caller</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-943"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681902873"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902873"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902850"><span class="hs-identifier hs-var">callers</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-944"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsOutput doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#whenPprDebug"><span class="hs-identifier hs-var">whenPprDebug</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;calls:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallInfo -&gt; SDoc) -&gt; [CallInfo] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CallInfo -&gt; SDoc
</span><a href="GHC.Core.Opt.Specialise.html#pprCallInfo"><span class="hs-identifier hs-var">pprCallInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902851"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681902852"><span class="hs-identifier hs-var">calls_for_fn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-945"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Probable fix: add INLINABLE pragma on&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902851"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-946"></span><span>
</span><span id="line-947"></span><span class="hs-comment">{- Note [Missed specialisation for ClassOps]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In #19592 I saw a number of missed specialisation warnings
which were the result of things like:

    case isJumpishInstr @X86.Instr $dInstruction_s7f8 eta3_a78C of { ...

where isJumpishInstr is part of the Instruction class and defined like
this:

    class Instruction instr where
        ...
        isJumpishInstr :: instr -&gt; Bool
        ...

isJumpishInstr is a ClassOp which will select the right method
from within the dictionary via our built in rules. See also
Note [ClassOp/DFun selection] in GHC.Tc.TyCl.Instance.

We don't give these unfoldings, and as a result the specialiser
complains. But usually this doesn't matter. The simplifier will
apply the rule and we end up with

    case isJumpishInstrImplX86 eta3_a78C of { ...

Since isJumpishInstrImplX86 is defined for a concrete instance (given
by the dictionary) it is usually already well specialised!
Theoretically the implementation of a method could still be overloaded
over a different type class than what it's a method of. But I wasn't able
to make this go wrong, and SPJ thinks this should be fine as well.

So I decided to remove the warnings for failed specialisations on ClassOps
alltogether as they do more harm than good.
-}</span><span>
</span><span id="line-981"></span><span>
</span><span id="line-982"></span><span class="hs-comment">{- Note [Do not specialise imported DFuns]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Ticket #18223 shows that specialising calls of DFuns is can cause a huge
and entirely unnecessary blowup in program size.  Consider a call to
    f @[[[[[[[[T]]]]]]]] d1 x
where df :: C a =&gt; C [a]
      d1 :: C [[[[[[[[T]]]]]]]] = dfC[] @[[[[[[[T]]]]]]] d1
      d2 :: C [[[[[[[T]]]]]]]   = dfC[] @[[[[[[T]]]]]] d3
      ...
Now we'll specialise f's RHS, which may give rise to calls to 'g',
also overloaded, which we will specialise, and so on.  However, if
we specialise the calls to dfC[], we'll generate specialised copies of
all methods of C, at all types; and the same for C's superclasses.

And many of these specialised functions will never be called.  We are
going to call the specialised 'f', and the specialised 'g', but DFuns
group functions into a tuple, many of whose elements may never be used.

With deeply-nested types this can lead to a simply overwhelming number
of specialisations: see #18223 for a simple example (from the wild).
I measured the number of specialisations for various numbers of calls
of `flip evalStateT ()`, and got this

                       Size after one simplification
  #calls    #SPEC rules    Terms     Types
      5         56          3100     10600
      9        108         13660     77206

The real tests case has 60+ calls, which blew GHC out of the water.

Solution: don't specialise DFuns.  The downside is that if we end
up with (h (dfun d)), /and/ we don't specialise 'h', then we won't
pass to 'h' a tuple of specialised functions.

However, the flag -fspecialise-aggressively (experimental, off by default)
allows DFuns to specialise as well.

Note [Avoiding loops in specImports]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We must take great care when specialising instance declarations
(DFuns like $fOrdList) lest we accidentally build a recursive
dictionary. See Note [Avoiding loops (DFuns)].

The basic strategy of Note [Avoiding loops (DFuns)] is to use filterCalls
to discard loopy specialisations.  But to do that we must ensure
that the in-scope dict-binds (passed to filterCalls) contains
all the needed dictionary bindings.  In particular, in the recursive
call to spec_imports in spec_import, we must include the dict-binds
from the parent.  Lacking this caused #17151, a really nasty bug.

Here is what happened.
* Class structure:
    Source is a superclass of Mut
    Index is a superclass of Source

* We started with these dict binds
    dSource = $fSourcePix @Int $fIndexInt
    dIndex  = sc_sel dSource
    dMut    = $fMutPix @Int dIndex
  and these calls to specialise
    $fMutPix @Int dIndex
    $fSourcePix @Int $fIndexInt

* We specialised the call ($fMutPix @Int dIndex)
  ==&gt; new call ($fSourcePix @Int dIndex)
      (because Source is a superclass of Mut)

* We specialised ($fSourcePix @Int dIndex)
  ==&gt; produces specialised dict $s$fSourcePix,
      a record with dIndex as a field
      plus RULE forall d. ($fSourcePix @Int d) = $s$fSourcePix
  *** This is the bogus step ***

* Now we decide not to specialise the call
    $fSourcePix @Int $fIndexInt
  because we alredy have a RULE that matches it

* Finally the simplifer rewrites
    dSource = $fSourcePix @Int $fIndexInt
    ==&gt;  dSource = $s$fSourcePix

Disaster. Now we have

Rewrite dSource's RHS to $s$fSourcePix   Disaster
    dSource = $s$fSourcePix
    dIndex  = sc_sel dSource
    $s$fSourcePix = MkSource dIndex ...

Solution: filterCalls should have stopped the bogus step,
by seeing that dIndex transitively uses $fSourcePix. But
it can only do that if it sees all the dict_binds.  Wow.

--------------
Here's another example (#13429).  Suppose we have
  class Monoid v =&gt; C v a where ...

We start with a call
   f @ [Integer] @ Integer $fC[]Integer

Specialising call to 'f' gives dict bindings
   $dMonoid_1 :: Monoid [Integer]
   $dMonoid_1 = M.$p1C @ [Integer] $fC[]Integer

   $dC_1 :: C [Integer] (Node [Integer] Integer)
   $dC_1 = M.$fCvNode @ [Integer] $dMonoid_1

...plus a recursive call to
   f @ [Integer] @ (Node [Integer] Integer) $dC_1

Specialising that call gives
   $dMonoid_2  :: Monoid [Integer]
   $dMonoid_2  = M.$p1C @ [Integer] $dC_1

   $dC_2 :: C [Integer] (Node [Integer] Integer)
   $dC_2 = M.$fCvNode @ [Integer] $dMonoid_2

Now we have two calls to the imported function
  M.$fCvNode :: Monoid v =&gt; C v a
  M.$fCvNode @v @a m = C m some_fun

But we must /not/ use the call (M.$fCvNode @ [Integer] $dMonoid_2)
for specialisation, else we get:

  $dC_1 = M.$fCvNode @ [Integer] $dMonoid_1
  $dMonoid_2 = M.$p1C @ [Integer] $dC_1
  $s$fCvNode = C $dMonoid_2 ...
    RULE M.$fCvNode [Integer] _ _ = $s$fCvNode

Now use the rule to rewrite the call in the RHS of $dC_1
and we get a loop!


Note [specImport call stack]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When specialising an imports function 'f', we may get new calls
of an imported function 'g', which we want to specialise in turn,
and similarly specialising 'g' might expose a new call to 'h'.

We track the stack of enclosing functions. So when specialising 'h' we
have a specImport call stack of [g,f]. We do this for two reasons:
* Note [Warning about missed specialisations]
* Note [Avoiding recursive specialisation]

Note [Warning about missed specialisations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose
 * In module Lib, you carefully mark a function 'foo' INLINABLE
 * Import Lib(foo) into another module M
 * Call 'foo' at some specialised type in M
Then you jolly well expect it to be specialised in M.  But what if
'foo' calls another function 'Lib.bar'.  Then you'd like 'bar' to be
specialised too.  But if 'bar' is not marked INLINABLE it may well
not be specialised.  The warning Opt_WarnMissedSpecs warns about this.

It's more noisy to warning about a missed specialisation opportunity
for /every/ overloaded imported function, but sometimes useful. That
is what Opt_WarnAllMissedSpecs does.

ToDo: warn about missed opportunities for local functions.

Note [Avoiding recursive specialisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we specialise 'f' we may find new overloaded calls to 'g', 'h' in
'f's RHS.  So we want to specialise g,h.  But we don't want to
specialise f any more!  It's possible that f's RHS might have a
recursive yet-more-specialised call, so we'd diverge in that case.
And if the call is to the same type, one specialisation is enough.
Avoiding this recursive specialisation loop is one reason for the
'callers' stack passed to specImports and specImport.


************************************************************************
*                                                                      *
\subsubsection{@specExpr@: the main function}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1159"></span><span>
</span><span id="line-1160"></span><span class="hs-keyword">data</span><span> </span><span id="SpecEnv"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-var">SpecEnv</span></a></span></span><span>
</span><span id="line-1161"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="SE"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SE"><span class="hs-identifier hs-var">SE</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="se_subst"><span class="annot"><span class="annottext">SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var hs-var">se_subst</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Core.Subst</span></a></span><span>
</span><span id="line-1162"></span><span>             </span><span class="hs-comment">-- We carry a substitution down:</span><span>
</span><span id="line-1163"></span><span>             </span><span class="hs-comment">-- a) we must clone any binding that might float outwards,</span><span>
</span><span id="line-1164"></span><span>             </span><span class="hs-comment">--    to avoid name clashes</span><span>
</span><span id="line-1165"></span><span>             </span><span class="hs-comment">-- b) we carry a type substitution to use when analysing</span><span>
</span><span id="line-1166"></span><span>             </span><span class="hs-comment">--    the RHS of specialised bindings (no type-let!)</span><span>
</span><span id="line-1167"></span><span>
</span><span id="line-1168"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="se_module"><span class="annot"><span class="annottext">SpecEnv -&gt; Module
</span><a href="GHC.Core.Opt.Specialise.html#se_module"><span class="hs-identifier hs-var hs-var">se_module</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span>
</span><span id="line-1169"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="se_rules"><span class="annot"><span class="annottext">SpecEnv -&gt; RuleEnv
</span><a href="GHC.Core.Opt.Specialise.html#se_rules"><span class="hs-identifier hs-var hs-var">se_rules</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span>  </span><span class="hs-comment">-- From the home package and this module</span><span>
</span><span id="line-1170"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="se_dflags"><span class="annot"><span class="annottext">SpecEnv -&gt; DynFlags
</span><a href="GHC.Core.Opt.Specialise.html#se_dflags"><span class="hs-identifier hs-var hs-var">se_dflags</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span>
</span><span id="line-1171"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-1172"></span><span>
</span><span id="line-1173"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1174"></span><span>  </span><span id="local-6989586621681902886"><span class="annot"><span class="annottext">ppr :: SpecEnv -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SE"><span class="hs-identifier hs-type">SE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">se_subst :: SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681902887"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681902887"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1175"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SE&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;subst =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681902887"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1176"></span><span>
</span><span id="line-1177"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specVar"><span class="hs-identifier hs-type">specVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1178"></span><span id="specVar"><span class="annot"><span class="annottext">specVar :: SpecEnv -&gt; Id -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specVar"><span class="hs-identifier hs-var hs-var">specVar</span></a></span></span><span> </span><span id="local-6989586621681902891"><span class="annot"><span class="annottext">env :: SpecEnv
</span><a href="#local-6989586621681902891"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SE"><span class="hs-identifier hs-type">SE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">se_subst :: SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Core.Subst</span></a></span><span> </span><span id="local-6989586621681902893"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681902893"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621681902894"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621681902894"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681902895"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902895"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-1179"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902895"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutExpr, UsageDetails) -&gt; SpecM (OutExpr, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902895"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1180"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681902898"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902898"><span class="hs-identifier hs-var">e</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IdSubstEnv -&gt; Id -&gt; Maybe OutExpr
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621681902894"><span class="hs-identifier hs-var">ids</span></a></span><span>       </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902895"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; SpecEnv
</span><a href="GHC.Core.Opt.Specialise.html#zapSubst"><span class="hs-identifier hs-var">zapSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902891"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902898"><span class="hs-identifier hs-var">e</span></a></span><span>  </span><span class="hs-comment">-- Note (1)</span><span>
</span><span id="line-1181"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681902902"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902902"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Id -&gt; Maybe Id
</span><a href="GHC.Types.Var.Env.html#lookupInScope"><span class="hs-identifier hs-var">lookupInScope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681902893"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902895"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutExpr, UsageDetails) -&gt; SpecM (OutExpr, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902902"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1182"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; SpecM (OutExpr, UsageDetails)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;specVar&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902895"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681902893"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1183"></span><span>  </span><span class="hs-comment">-- c.f. GHC.Core.Subst.lookupIdSubst</span><span>
</span><span id="line-1184"></span><span>  </span><span class="hs-comment">-- Note (1): we recurse so we do the lookupInScope thing on any Vars in e</span><span>
</span><span id="line-1185"></span><span>  </span><span class="hs-comment">--           probably has little effect, but it's the right thing.</span><span>
</span><span id="line-1186"></span><span>  </span><span class="hs-comment">--           We need zapSubst because `e` is an OutExpr</span><span>
</span><span id="line-1187"></span><span>
</span><span id="line-1188"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-type">specExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1189"></span><span>
</span><span id="line-1190"></span><span class="hs-comment">---------------- First the easy cases --------------------</span><span>
</span><span id="line-1191"></span><span id="specExpr"><span class="annot"><span class="annottext">specExpr :: SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var hs-var">specExpr</span></a></span></span><span> </span><span id="local-6989586621681902906"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902906"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681902907"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902907"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Id -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specVar"><span class="hs-identifier hs-var">specVar</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902906"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902907"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1192"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span id="local-6989586621681902908"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902908"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621681902910"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681902910"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutExpr, UsageDetails) -&gt; SpecM (OutExpr, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; OutExpr
forall b. Kind -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Opt.Specialise.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902908"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681902910"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1193"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span id="local-6989586621681902912"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902912"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621681902914"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681902914"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutExpr, UsageDetails) -&gt; SpecM (OutExpr, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; OutExpr
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Opt.Specialise.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902912"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681902914"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1194"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621681902917"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681902917"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutExpr, UsageDetails) -&gt; SpecM (OutExpr, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Literal -&gt; OutExpr
forall b. Literal -&gt; Expr b
</span><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-var">Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681902917"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">,</span><span>                   </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1195"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span id="local-6989586621681902918"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902918"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681902920"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902920"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681902921"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681902921"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1196"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902922"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902922"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902923"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902923"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902918"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902920"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1197"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(OutExpr, UsageDetails) -&gt; SpecM (OutExpr, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; OutExpr -&gt; Coercion -&gt; OutExpr
OutExpr -&gt; Coercion -&gt; OutExpr
</span><a href="GHC.Core.Utils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902922"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Opt.Specialise.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902918"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681902921"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902923"><span class="hs-identifier hs-var">uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1198"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span id="local-6989586621681902924"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902924"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621681902926"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681902926"><span class="hs-identifier hs-var">tickish</span></a></span></span><span> </span><span id="local-6989586621681902927"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902927"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1199"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902928"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902928"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902929"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902929"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902924"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902927"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1200"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(OutExpr, UsageDetails) -&gt; SpecM (OutExpr, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; OutExpr -&gt; OutExpr
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; CoreTickish -&gt; CoreTickish
</span><a href="GHC.Core.Opt.Specialise.html#specTickish"><span class="hs-identifier hs-var">specTickish</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902924"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681902926"><span class="hs-identifier hs-var">tickish</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902928"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902929"><span class="hs-identifier hs-var">uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1201"></span><span>
</span><span id="line-1202"></span><span class="hs-comment">---------------- Applications might generate a call instance --------------------</span><span>
</span><span id="line-1203"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span id="local-6989586621681902931"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902931"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681902932"><span class="annot"><span class="annottext">expr :: OutExpr
</span><a href="#local-6989586621681902932"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1204"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902934"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902934"><span class="hs-identifier hs-var">fun_in</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902935"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902935"><span class="hs-identifier hs-var">args_in</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; (OutExpr, [OutExpr])
forall b. Expr b -&gt; (Expr b, [Expr b])
</span><a href="GHC.Core.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902932"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1205"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902937"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902937"><span class="hs-identifier hs-var">args_out</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902938"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902938"><span class="hs-identifier hs-var">uds_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(OutExpr -&gt; SpecM (OutExpr, UsageDetails))
-&gt; [OutExpr] -&gt; SpecM ([OutExpr], UsageDetails)
forall a b.
(a -&gt; SpecM (b, UsageDetails)) -&gt; [a] -&gt; SpecM ([b], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#mapAndCombineSM"><span class="hs-identifier hs-var">mapAndCombineSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902931"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902935"><span class="hs-identifier hs-var">args_in</span></a></span><span>
</span><span id="line-1206"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681902940"><span class="annot"><span class="annottext">env_args :: SpecEnv
</span><a href="#local-6989586621681902940"><span class="hs-identifier hs-var hs-var">env_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902931"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; FloatedDictBinds -&gt; SpecEnv
</span><a href="GHC.Core.Opt.Specialise.html#bringFloatedDictsIntoScope"><span class="hs-operator hs-var">`bringFloatedDictsIntoScope`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902938"><span class="hs-identifier hs-var">uds_args</span></a></span><span>
</span><span id="line-1207"></span><span>                </span><span class="hs-comment">-- Some dicts may have floated out of args_in;</span><span>
</span><span id="line-1208"></span><span>                </span><span class="hs-comment">-- they should be in scope for fireRewriteRules (#21689)</span><span>
</span><span id="line-1209"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621681902941"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902941"><span class="hs-identifier hs-var">fun_in'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902942"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902942"><span class="hs-identifier hs-var">args_out'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; [OutExpr] -&gt; (OutExpr, [OutExpr])
</span><a href="GHC.Core.Opt.Specialise.html#fireRewriteRules"><span class="hs-identifier hs-var">fireRewriteRules</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902940"><span class="hs-identifier hs-var">env_args</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902934"><span class="hs-identifier hs-var">fun_in</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902937"><span class="hs-identifier hs-var">args_out</span></a></span><span>
</span><span id="line-1210"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902944"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902944"><span class="hs-identifier hs-var">fun_out'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902945"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902945"><span class="hs-identifier hs-var">uds_fun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902931"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902941"><span class="hs-identifier hs-var">fun_in'</span></a></span><span>
</span><span id="line-1211"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681902946"><span class="annot"><span class="annottext">uds_call :: UsageDetails
</span><a href="#local-6989586621681902946"><span class="hs-identifier hs-var hs-var">uds_call</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; [OutExpr] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#mkCallUDs"><span class="hs-identifier hs-var">mkCallUDs</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902931"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902944"><span class="hs-identifier hs-var">fun_out'</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902942"><span class="hs-identifier hs-var">args_out'</span></a></span><span>
</span><span id="line-1212"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(OutExpr, UsageDetails) -&gt; SpecM (OutExpr, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902944"><span class="hs-identifier hs-var">fun_out'</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; [OutExpr] -&gt; OutExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-operator hs-var">`mkApps`</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902942"><span class="hs-identifier hs-var">args_out'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902945"><span class="hs-identifier hs-var">uds_fun</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#thenUDs"><span class="hs-operator hs-var">`thenUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902946"><span class="hs-identifier hs-var">uds_call</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#thenUDs"><span class="hs-operator hs-var">`thenUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902938"><span class="hs-identifier hs-var">uds_args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1213"></span><span>
</span><span id="line-1214"></span><span class="hs-comment">---------------- Lambda/case require dumping of usage details --------------------</span><span>
</span><span id="line-1215"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span id="local-6989586621681902950"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902950"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681902951"><span class="annot"><span class="annottext">e :: OutExpr
</span><a href="#local-6989586621681902951"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1216"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; [Id] -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specLam"><span class="hs-identifier hs-var">specLam</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902954"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902955"><span class="hs-identifier hs-var">bndrs'</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902956"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1217"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1218"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681902957"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902957"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902956"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902956"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; ([Id], OutExpr)
forall b. Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902951"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1219"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681902954"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902954"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902955"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902955"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; [Id] -&gt; (SpecEnv, [Id])
</span><a href="GHC.Core.Opt.Specialise.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902950"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681902957"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1220"></span><span>        </span><span class="hs-comment">-- More efficient to collect a group of binders together all at once</span><span>
</span><span id="line-1221"></span><span>        </span><span class="hs-comment">-- and we don't want to split a lambda group with dumped bindings</span><span>
</span><span id="line-1222"></span><span>
</span><span id="line-1223"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span id="local-6989586621681902960"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902960"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621681902962"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902962"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621681902963"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902963"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621681902964"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681902964"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681902965"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681902965"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1224"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902966"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902966"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902967"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902967"><span class="hs-identifier hs-var">scrut_uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902960"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902962"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-1225"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902968"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902968"><span class="hs-identifier hs-var">scrut''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902969"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902969"><span class="hs-identifier hs-var">case_bndr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902970"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681902970"><span class="hs-identifier hs-var">alts'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902971"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902971"><span class="hs-identifier hs-var">alts_uds</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1226"></span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; OutExpr
-&gt; Id
-&gt; [Alt Id]
-&gt; SpecM (OutExpr, Id, [Alt Id], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specCase"><span class="hs-identifier hs-var">specCase</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902960"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902966"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902963"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681902965"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-1227"></span><span class="hs-comment">--       ; pprTrace &quot;specExpr:case&quot; (vcat</span><span>
</span><span id="line-1228"></span><span class="hs-comment">--            [ text &quot;scrut&quot; &lt;+&gt; ppr scrut, text &quot;scrut'&quot; &lt;+&gt; ppr scrut'</span><span>
</span><span id="line-1229"></span><span class="hs-comment">--            , text &quot;case_bndr'&quot; &lt;+&gt; ppr case_bndr'</span><span>
</span><span id="line-1230"></span><span class="hs-comment">--            , text &quot;alts_uds&quot; &lt;+&gt; ppr alts_uds</span><span>
</span><span id="line-1231"></span><span class="hs-comment">--            ])</span><span>
</span><span id="line-1232"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(OutExpr, UsageDetails) -&gt; SpecM (OutExpr, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr -&gt; Id -&gt; Kind -&gt; [Alt Id] -&gt; OutExpr
forall b. Expr b -&gt; b -&gt; Kind -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902968"><span class="hs-identifier hs-var">scrut''</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902969"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Opt.Specialise.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902960"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681902964"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681902970"><span class="hs-identifier hs-var">alts'</span></a></span><span>
</span><span id="line-1233"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902967"><span class="hs-identifier hs-var">scrut_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#thenUDs"><span class="hs-operator hs-var">`thenUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902971"><span class="hs-identifier hs-var">alts_uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1234"></span><span>
</span><span id="line-1235"></span><span class="hs-comment">---------------- Finally, let is the interesting case --------------------</span><span>
</span><span id="line-1236"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span id="local-6989586621681902973"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902973"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621681902975"><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681902975"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621681902976"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902976"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1237"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902977"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902977"><span class="hs-identifier hs-var">binds'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902978"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902978"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902979"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902979"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; SpecEnv
-&gt; InBind
-&gt; (SpecEnv -&gt; SpecM (OutExpr, UsageDetails))
-&gt; SpecM (CoreProgram, OutExpr, UsageDetails)
forall body.
TopLevelFlag
-&gt; SpecEnv
-&gt; InBind
-&gt; (SpecEnv -&gt; SpecM (body, UsageDetails))
-&gt; SpecM (CoreProgram, body, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specBind"><span class="hs-identifier hs-var">specBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902973"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681902975"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="annot"><span class="annottext">((SpecEnv -&gt; SpecM (OutExpr, UsageDetails))
 -&gt; SpecM (CoreProgram, OutExpr, UsageDetails))
-&gt; (SpecEnv -&gt; SpecM (OutExpr, UsageDetails))
-&gt; SpecM (CoreProgram, OutExpr, UsageDetails)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681902981"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902981"><span class="hs-identifier hs-var">body_env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1238"></span><span>                                 </span><span class="hs-comment">-- pprTrace &quot;specExpr:let&quot; (ppr (se_subst body_env) $$ ppr body) $</span><span>
</span><span id="line-1239"></span><span>                                 </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902981"><span class="hs-identifier hs-var">body_env</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902976"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1240"></span><span>         </span><span class="hs-comment">-- All done</span><span>
</span><span id="line-1241"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(OutExpr, UsageDetails) -&gt; SpecM (OutExpr, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(InBind -&gt; OutExpr -&gt; OutExpr) -&gt; OutExpr -&gt; CoreProgram -&gt; OutExpr
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">InBind -&gt; OutExpr -&gt; OutExpr
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902978"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681902977"><span class="hs-identifier hs-var">binds'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681902979"><span class="hs-identifier hs-var">uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1242"></span><span>
</span><span id="line-1243"></span><span class="hs-comment">-- See Note [Specialisation modulo dictionary selectors]</span><span>
</span><span id="line-1244"></span><span class="hs-comment">--     Note [ClassOp/DFun selection]</span><span>
</span><span id="line-1245"></span><span class="hs-comment">--     Note [Fire rules in the specialiser]</span><span>
</span><span id="line-1246"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#fireRewriteRules"><span class="hs-identifier hs-type">fireRewriteRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1247"></span><span id="fireRewriteRules"><span class="annot"><span class="annottext">fireRewriteRules :: SpecEnv -&gt; OutExpr -&gt; [OutExpr] -&gt; (OutExpr, [OutExpr])
</span><a href="GHC.Core.Opt.Specialise.html#fireRewriteRules"><span class="hs-identifier hs-var hs-var">fireRewriteRules</span></a></span></span><span> </span><span id="local-6989586621681902984"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902984"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681902985"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902985"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681902986"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902986"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-1248"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902987"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621681902987"><span class="hs-identifier hs-var">rule</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902988"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902988"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; Id
-&gt; [OutExpr]
-&gt; CompilerPhase
-&gt; [CoreRule]
-&gt; Maybe (CoreRule, OutExpr)
</span><a href="GHC.Core.Opt.Specialise.html#specLookupRule"><span class="hs-identifier hs-var">specLookupRule</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902984"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902985"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902986"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">CompilerPhase
</span><a href="GHC.Types.Basic.html#InitialPhase"><span class="hs-identifier hs-var">InitialPhase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RuleEnv -&gt; Id -&gt; [CoreRule]
</span><a href="GHC.Core.Rules.html#getRules"><span class="hs-identifier hs-var">getRules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; RuleEnv
</span><a href="GHC.Core.Opt.Specialise.html#se_rules"><span class="hs-identifier hs-var">se_rules</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902984"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681902985"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1249"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681902991"><span class="annot"><span class="annottext">rest_args :: [OutExpr]
</span><a href="#local-6989586621681902991"><span class="hs-identifier hs-var hs-var">rest_args</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [OutExpr] -&gt; [OutExpr]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#drop/GHC.List.html#drop"><span class="hs-identifier hs-var">drop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; Int
</span><a href="GHC.Core.html#ruleArity"><span class="hs-identifier hs-var">ruleArity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621681902987"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902986"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-comment">-- See Note [Extra args in the target]</span><span>
</span><span id="line-1250"></span><span>        </span><span id="local-6989586621681902994"><span class="annot"><span class="annottext">zapped_subst :: Subst
</span><a href="#local-6989586621681902994"><span class="hs-identifier hs-var hs-var">zapped_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#zapSubst"><span class="hs-identifier hs-var">Core.zapSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902984"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1251"></span><span>        </span><span id="local-6989586621681902995"><span class="annot"><span class="annottext">expr' :: OutExpr
</span><a href="#local-6989586621681902995"><span class="hs-identifier hs-var hs-var">expr'</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; SimpleOpts -&gt; Subst -&gt; OutExpr -&gt; OutExpr
SimpleOpts -&gt; Subst -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.SimpleOpt.html#simpleOptExprWith"><span class="hs-identifier hs-var">simpleOptExprWith</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="GHC.Core.SimpleOpt.html#defaultSimpleOpts"><span class="hs-identifier hs-var">defaultSimpleOpts</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681902994"><span class="hs-identifier hs-var">zapped_subst</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902988"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-1252"></span><span>                       </span><span class="hs-comment">-- simplOptExpr needed because lookupRule returns</span><span>
</span><span id="line-1253"></span><span>                       </span><span class="hs-comment">--   (\x y. rhs) arg1 arg2</span><span>
</span><span id="line-1254"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681902996"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902996"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681902997"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902997"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; (OutExpr, [OutExpr])
forall b. Expr b -&gt; (Expr b, [Expr b])
</span><a href="GHC.Core.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902995"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-1255"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; [OutExpr] -&gt; (OutExpr, [OutExpr])
</span><a href="GHC.Core.Opt.Specialise.html#fireRewriteRules"><span class="hs-identifier hs-var">fireRewriteRules</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681902984"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902996"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902997"><span class="hs-identifier hs-var">args</span></a></span><span class="annot"><span class="annottext">[OutExpr] -&gt; [OutExpr] -&gt; [OutExpr]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902991"><span class="hs-identifier hs-var">rest_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1256"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#fireRewriteRules"><span class="hs-identifier hs-var">fireRewriteRules</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681902998"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902998"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681902999"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902999"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681902998"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681902999"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1257"></span><span>
</span><span id="line-1258"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-1259"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specLam"><span class="hs-identifier hs-type">specLam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1260"></span><span class="hs-comment">-- The binders have been substituted, but the body has not</span><span>
</span><span id="line-1261"></span><span id="specLam"><span class="annot"><span class="annottext">specLam :: SpecEnv -&gt; [Id] -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specLam"><span class="hs-identifier hs-var hs-var">specLam</span></a></span></span><span> </span><span id="local-6989586621681903001"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903001"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903002"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903002"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621681903003"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903003"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-1262"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903002"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1263"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903001"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903003"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1264"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1265"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903004"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903004"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903005"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903005"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903001"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903003"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1266"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903006"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903006"><span class="hs-identifier hs-var">free_uds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903007"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903007"><span class="hs-identifier hs-var">dumped_dbs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; UsageDetails -&gt; (UsageDetails, OrdList DictBind)
</span><a href="GHC.Core.Opt.Specialise.html#dumpUDs"><span class="hs-identifier hs-var">dumpUDs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903002"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903005"><span class="hs-identifier hs-var">uds</span></a></span><span>
</span><span id="line-1267"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(OutExpr, UsageDetails) -&gt; SpecM (OutExpr, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; OutExpr -&gt; OutExpr
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903002"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList DictBind -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.Opt.Specialise.html#wrapDictBindsE"><span class="hs-identifier hs-var">wrapDictBindsE</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903007"><span class="hs-identifier hs-var">dumped_dbs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903004"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903006"><span class="hs-identifier hs-var">free_uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1268"></span><span>
</span><span id="line-1269"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-1270"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specTickish"><span class="hs-identifier hs-type">specTickish</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span>
</span><span id="line-1271"></span><span id="specTickish"><span class="annot"><span class="annottext">specTickish :: SpecEnv -&gt; CoreTickish -&gt; CoreTickish
</span><a href="GHC.Core.Opt.Specialise.html#specTickish"><span class="hs-identifier hs-var hs-var">specTickish</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SE"><span class="hs-identifier hs-type">SE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">se_subst :: SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903011"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903011"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Tickish.html#Breakpoint"><span class="hs-identifier hs-type">Breakpoint</span></a></span><span> </span><span id="local-6989586621681903013"><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
</span><a href="#local-6989586621681903013"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621681903014"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681903014"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span id="local-6989586621681903015"><span class="annot"><span class="annottext">[XTickishId 'TickishPassCore]
</span><a href="#local-6989586621681903015"><span class="hs-identifier hs-var">ids</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1272"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
-&gt; Int -&gt; [XTickishId 'TickishPassCore] -&gt; CoreTickish
forall (pass :: TickishPass).
XBreakpoint pass -&gt; Int -&gt; [XTickishId pass] -&gt; GenTickish pass
</span><a href="GHC.Types.Tickish.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a></span><span> </span><span class="annot"><span class="annottext">XBreakpoint 'TickishPassCore
</span><a href="#local-6989586621681903013"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681903014"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Id
XTickishId 'TickishPassCore
</span><a href="#local-6989586621681903016"><span class="hs-identifier hs-var">id'</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681903017"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903017"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
[XTickishId 'TickishPassCore]
</span><a href="#local-6989586621681903015"><span class="hs-identifier hs-var">ids</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681903016"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903016"><span class="hs-identifier hs-var">id'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; Id -&gt; OutExpr
Subst -&gt; Id -&gt; OutExpr
</span><a href="GHC.Core.Subst.html#lookupIdSubst"><span class="hs-identifier hs-var">Core.lookupIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903011"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903017"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-1273"></span><span>  </span><span class="hs-comment">-- drop vars from the list if they have a non-variable substitution.</span><span>
</span><span id="line-1274"></span><span>  </span><span class="hs-comment">-- should never happen, but it's harmless to drop them anyway.</span><span>
</span><span id="line-1275"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specTickish"><span class="hs-identifier hs-var">specTickish</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681903019"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681903019"><span class="hs-identifier hs-var">other_tickish</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681903019"><span class="hs-identifier hs-var">other_tickish</span></a></span><span>
</span><span id="line-1276"></span><span>
</span><span id="line-1277"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-1278"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specCase"><span class="hs-identifier hs-type">specCase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>
</span><span id="line-1279"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>             </span><span class="hs-comment">-- Scrutinee, already done</span><span>
</span><span id="line-1280"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1281"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>     </span><span class="hs-comment">-- New scrutinee</span><span>
</span><span id="line-1282"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>
</span><span id="line-1283"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutAlt"><span class="hs-identifier hs-type">OutAlt</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1284"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1285"></span><span id="specCase"><span class="annot"><span class="annottext">specCase :: SpecEnv
-&gt; OutExpr
-&gt; Id
-&gt; [Alt Id]
-&gt; SpecM (OutExpr, Id, [Alt Id], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specCase"><span class="hs-identifier hs-var hs-var">specCase</span></a></span></span><span> </span><span id="local-6989586621681903023"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903023"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903024"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903024"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span> </span><span id="local-6989586621681903025"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903025"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621681903027"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681903027"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621681903028"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903028"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681903029"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903029"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span>
</span><span id="line-1286"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- See Note [Floating dictionaries out of cases]</span><span>
</span><span id="line-1287"></span><span>    </span><span class="annot"><span class="annottext">OutExpr -&gt; Kind -&gt; Bool
</span><a href="GHC.Core.Opt.Specialise.html#interestingDict"><span class="hs-identifier hs-var">interestingDict</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903024"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903025"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1288"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903025"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903033"><span class="hs-identifier hs-var">sc_args'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1289"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681903034"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903034"><span class="hs-identifier hs-var">case_bndr_flt</span></a></span></span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Base.html#%3A%7C/GHC.Base.html#%3A%7C"><span class="hs-operator hs-type">:|</span></a></span><span> </span><span id="local-6989586621681903036"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903036"><span class="hs-identifier hs-var">sc_args_flt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; UniqSM Id) -&gt; NonEmpty Id -&gt; UniqSM (NonEmpty Id)
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; NonEmpty a -&gt; m (NonEmpty b)
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#mapM/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; UniqSM Id
forall {m :: * -&gt; *}. MonadUnique m =&gt; Id -&gt; m Id
</span><a href="#local-6989586621681903038"><span class="hs-identifier hs-var">clone_me</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903039"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; NonEmpty Id
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%3A%7C/GHC.Base.html#%3A%7C"><span class="hs-operator hs-var">:|</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903033"><span class="hs-identifier hs-var">sc_args'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1290"></span><span>
</span><span id="line-1291"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681903040"><span class="annot"><span class="annottext">case_bndr_flt' :: Id
</span><a href="#local-6989586621681903040"><span class="hs-identifier hs-var hs-var">case_bndr_flt'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903034"><span class="hs-identifier hs-var">case_bndr_flt</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr -&gt; Id
</span><a href="GHC.Core.Opt.Specialise.html#addDictUnfolding"><span class="hs-operator hs-var">`addDictUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903024"><span class="hs-identifier hs-var">scrut'</span></a></span><span>
</span><span id="line-1292"></span><span>             </span><span id="local-6989586621681903042"><span class="annot"><span class="annottext">scrut_bind :: DictBind
</span><a href="#local-6989586621681903042"><span class="hs-identifier hs-var hs-var">scrut_bind</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InBind -&gt; DictBind
</span><a href="GHC.Core.Opt.Specialise.html#mkDB"><span class="hs-identifier hs-var">mkDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutExpr -&gt; InBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903034"><span class="hs-identifier hs-var">case_bndr_flt</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903024"><span class="hs-identifier hs-var">scrut'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1293"></span><span>
</span><span id="line-1294"></span><span>             </span><span id="local-6989586621681903044"><span class="annot"><span class="annottext">sc_args_flt' :: [Id]
</span><a href="#local-6989586621681903044"><span class="hs-identifier hs-var hs-var">sc_args_flt'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; OutExpr -&gt; Id) -&gt; [Id] -&gt; [OutExpr] -&gt; [Id]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#zipWith/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr -&gt; Id
</span><a href="GHC.Core.Opt.Specialise.html#addDictUnfolding"><span class="hs-identifier hs-var">addDictUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903036"><span class="hs-identifier hs-var">sc_args_flt</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903046"><span class="hs-identifier hs-var">sc_rhss</span></a></span><span>
</span><span id="line-1295"></span><span>             </span><span id="local-6989586621681903046"><span class="annot"><span class="annottext">sc_rhss :: [OutExpr]
</span><a href="#local-6989586621681903046"><span class="hs-identifier hs-var hs-var">sc_rhss</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Id -&gt; Kind -&gt; [Alt Id] -&gt; OutExpr
forall b. Expr b -&gt; b -&gt; Kind -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903040"><span class="hs-identifier hs-var">case_bndr_flt'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903039"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903047"><span class="hs-identifier hs-var">sc_arg'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1296"></span><span>                                   </span><span class="hs-special">[</span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; OutExpr -&gt; Alt Id
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681903027"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903048"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903047"><span class="hs-identifier hs-var">sc_arg'</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1297"></span><span>                            </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681903047"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903047"><span class="hs-identifier hs-var">sc_arg'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903033"><span class="hs-identifier hs-var">sc_args'</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1298"></span><span>             </span><span id="local-6989586621681903049"><span class="annot"><span class="annottext">cb_set :: VarSet
</span><a href="#local-6989586621681903049"><span class="hs-identifier hs-var hs-var">cb_set</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unitVarSet"><span class="hs-identifier hs-var">unitVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903040"><span class="hs-identifier hs-var">case_bndr_flt'</span></a></span><span>
</span><span id="line-1299"></span><span>             </span><span id="local-6989586621681903051"><span class="annot"><span class="annottext">sc_binds :: [DictBind]
</span><a href="#local-6989586621681903051"><span class="hs-identifier hs-var hs-var">sc_binds</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">db_bind :: InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr -&gt; InBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903054"><span class="hs-identifier hs-var">sc_arg_flt</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903055"><span class="hs-identifier hs-var">sc_rhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">db_fvs :: VarSet
</span><a href="GHC.Core.Opt.Specialise.html#db_fvs"><span class="hs-identifier hs-var">db_fvs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903049"><span class="hs-identifier hs-var">cb_set</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1300"></span><span>                            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903054"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903054"><span class="hs-identifier hs-var">sc_arg_flt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903055"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903055"><span class="hs-identifier hs-var">sc_rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903044"><span class="hs-identifier hs-var">sc_args_flt'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [OutExpr] -&gt; [(Id, OutExpr)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#zip/GHC.List.html#zip"><span class="hs-operator hs-var">`zip`</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903046"><span class="hs-identifier hs-var">sc_rhss</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1301"></span><span>
</span><span id="line-1302"></span><span>             </span><span id="local-6989586621681903057"><span class="annot"><span class="annottext">flt_binds :: [DictBind]
</span><a href="#local-6989586621681903057"><span class="hs-identifier hs-var hs-var">flt_binds</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DictBind
</span><a href="#local-6989586621681903042"><span class="hs-identifier hs-var">scrut_bind</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind -&gt; [DictBind] -&gt; [DictBind]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903051"><span class="hs-identifier hs-var">sc_binds</span></a></span><span>
</span><span id="line-1303"></span><span>
</span><span id="line-1304"></span><span>             </span><span class="hs-comment">-- Extend the substitution for RHS to map the *original* binders</span><span>
</span><span id="line-1305"></span><span>             </span><span class="hs-comment">-- to their floated versions.</span><span>
</span><span id="line-1306"></span><span>             </span><span class="annot"><a href="#local-6989586621681903058"><span class="hs-identifier hs-type">mb_sc_flts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#DictId"><span class="hs-identifier hs-type">DictId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1307"></span><span>             </span><span id="local-6989586621681903058"><span class="annot"><span class="annottext">mb_sc_flts :: [Maybe Id]
</span><a href="#local-6989586621681903058"><span class="hs-identifier hs-var hs-var">mb_sc_flts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Maybe Id) -&gt; [Id] -&gt; [Maybe Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarEnv Id -&gt; Id -&gt; Maybe Id
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv Id
</span><a href="#local-6989586621681903060"><span class="hs-identifier hs-var">clone_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903048"><span class="hs-identifier hs-var">args'</span></a></span><span>
</span><span id="line-1308"></span><span>             </span><span id="local-6989586621681903060"><span class="annot"><span class="annottext">clone_env :: VarEnv Id
</span><a href="#local-6989586621681903060"><span class="hs-identifier hs-var hs-var">clone_env</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; VarEnv Id
forall a. [Id] -&gt; [a] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#zipVarEnv"><span class="hs-identifier hs-var">zipVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903033"><span class="hs-identifier hs-var">sc_args'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903044"><span class="hs-identifier hs-var">sc_args_flt'</span></a></span><span>
</span><span id="line-1309"></span><span>
</span><span id="line-1310"></span><span>             </span><span id="local-6989586621681903062"><span class="annot"><span class="annottext">subst_prs :: [(Id, OutExpr)]
</span><a href="#local-6989586621681903062"><span class="hs-identifier hs-var hs-var">subst_prs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903025"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903034"><span class="hs-identifier hs-var">case_bndr_flt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1311"></span><span>                        </span><span class="annot"><span class="annottext">(Id, OutExpr) -&gt; [(Id, OutExpr)] -&gt; [(Id, OutExpr)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903063"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903064"><span class="hs-identifier hs-var">sc_flt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1312"></span><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903063"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903063"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681903064"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903064"><span class="hs-identifier hs-var">sc_flt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903028"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Maybe Id] -&gt; [(Id, Maybe Id)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#zip/GHC.List.html#zip"><span class="hs-operator hs-var">`zip`</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Id]
</span><a href="#local-6989586621681903058"><span class="hs-identifier hs-var">mb_sc_flts</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1313"></span><span>             </span><span id="local-6989586621681903065"><span class="annot"><span class="annottext">subst' :: Subst
</span><a href="#local-6989586621681903065"><span class="hs-identifier hs-var hs-var">subst'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903066"><span class="hs-identifier hs-var">env_rhs</span></a></span><span>
</span><span id="line-1314"></span><span>                        </span><span class="annot"><span class="annottext">Subst -&gt; [Id] -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendSubstInScopeList"><span class="hs-operator hs-var">`Core.extendSubstInScopeList`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903040"><span class="hs-identifier hs-var">case_bndr_flt'</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903044"><span class="hs-identifier hs-var">sc_args_flt'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1315"></span><span>                        </span><span class="annot"><span class="annottext">Subst -&gt; [(Id, OutExpr)] -&gt; Subst
</span><a href="GHC.Core.Subst.html#extendIdSubstList"><span class="hs-operator hs-var">`Core.extendIdSubstList`</span></a></span><span>      </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903062"><span class="hs-identifier hs-var">subst_prs</span></a></span><span>
</span><span id="line-1316"></span><span>             </span><span id="local-6989586621681903068"><span class="annot"><span class="annottext">env_rhs' :: SpecEnv
</span><a href="#local-6989586621681903068"><span class="hs-identifier hs-var hs-var">env_rhs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903066"><span class="hs-identifier hs-var">env_rhs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903065"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1317"></span><span>
</span><span id="line-1318"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903069"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903069"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903070"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903070"><span class="hs-identifier hs-var">rhs_uds</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903068"><span class="hs-identifier hs-var">env_rhs'</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903029"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1319"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903071"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903071"><span class="hs-identifier hs-var">free_uds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903072"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903072"><span class="hs-identifier hs-var">dumped_dbs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; UsageDetails -&gt; (UsageDetails, OrdList DictBind)
</span><a href="GHC.Core.Opt.Specialise.html#dumpUDs"><span class="hs-identifier hs-var">dumpUDs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903039"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903048"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903070"><span class="hs-identifier hs-var">rhs_uds</span></a></span><span>
</span><span id="line-1320"></span><span>             </span><span id="local-6989586621681903073"><span class="annot"><span class="annottext">all_uds :: UsageDetails
</span><a href="#local-6989586621681903073"><span class="hs-identifier hs-var hs-var">all_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903057"><span class="hs-identifier hs-var">flt_binds</span></a></span><span> </span><span class="annot"><span class="annottext">[DictBind] -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#consDictBinds"><span class="hs-operator hs-var">`consDictBinds`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903071"><span class="hs-identifier hs-var">free_uds</span></a></span><span>
</span><span id="line-1321"></span><span>             </span><span id="local-6989586621681903075"><span class="annot"><span class="annottext">alt' :: Alt Id
</span><a href="#local-6989586621681903075"><span class="hs-identifier hs-var hs-var">alt'</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; OutExpr -&gt; Alt Id
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681903027"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903048"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList DictBind -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.Opt.Specialise.html#wrapDictBindsE"><span class="hs-identifier hs-var">wrapDictBindsE</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903072"><span class="hs-identifier hs-var">dumped_dbs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903069"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1322"></span><span class="hs-comment">--       ; pprTrace &quot;specCase&quot; (ppr case_bndr $$ ppr scrut_bind) $</span><span>
</span><span id="line-1323"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(OutExpr, Id, [Alt Id], UsageDetails)
-&gt; SpecM (OutExpr, Id, [Alt Id], UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903034"><span class="hs-identifier hs-var">case_bndr_flt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903039"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Alt Id
</span><a href="#local-6989586621681903075"><span class="hs-identifier hs-var">alt'</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903073"><span class="hs-identifier hs-var">all_uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1324"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1325"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681903066"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903066"><span class="hs-identifier hs-var">env_rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903039"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903039"><span class="hs-identifier hs-var">case_bndr'</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681903048"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903048"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; [Id] -&gt; (SpecEnv, [Id])
</span><a href="GHC.Core.Opt.Specialise.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903023"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903025"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903028"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1326"></span><span>    </span><span id="local-6989586621681903033"><span class="annot"><span class="annottext">sc_args' :: [Id]
</span><a href="#local-6989586621681903033"><span class="hs-identifier hs-var hs-var">sc_args'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; [Id]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#filter/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621681903076"><span class="hs-identifier hs-var">is_flt_sc_arg</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903048"><span class="hs-identifier hs-var">args'</span></a></span><span>
</span><span id="line-1327"></span><span>
</span><span id="line-1328"></span><span>    </span><span id="local-6989586621681903038"><span class="annot"><span class="annottext">clone_me :: Id -&gt; m Id
</span><a href="#local-6989586621681903038"><span class="hs-identifier hs-var hs-var">clone_me</span></a></span></span><span> </span><span id="local-6989586621681903093"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903093"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681903094"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681903094"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Unique
forall (m :: * -&gt; *). MonadUnique m =&gt; m Unique
</span><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a></span><span>
</span><span id="line-1329"></span><span>                       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; m Id
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccName -&gt; Unique -&gt; Kind -&gt; Kind -&gt; SrcSpan -&gt; Id
</span><a href="GHC.Types.Id.html#mkUserLocalOrCoVar"><span class="hs-identifier hs-var">mkUserLocalOrCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621681903097"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681903094"><span class="hs-identifier hs-var">uniq</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903098"><span class="hs-identifier hs-var">wght</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903099"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621681903100"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1330"></span><span>       </span><span class="hs-keyword">where</span><span>
</span><span id="line-1331"></span><span>         </span><span id="local-6989586621681903101"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681903101"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903093"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1332"></span><span>         </span><span id="local-6989586621681903098"><span class="annot"><span class="annottext">wght :: Kind
</span><a href="#local-6989586621681903098"><span class="hs-identifier hs-var hs-var">wght</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idMult"><span class="hs-identifier hs-var">idMult</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903093"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1333"></span><span>         </span><span id="local-6989586621681903099"><span class="annot"><span class="annottext">ty :: Kind
</span><a href="#local-6989586621681903099"><span class="hs-identifier hs-var hs-var">ty</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903093"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-1334"></span><span>         </span><span id="local-6989586621681903097"><span class="annot"><span class="annottext">occ :: OccName
</span><a href="#local-6989586621681903097"><span class="hs-identifier hs-var hs-var">occ</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OccName
</span><a href="GHC.Types.Name.html#nameOccName"><span class="hs-identifier hs-var">nameOccName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681903101"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1335"></span><span>         </span><span id="local-6989586621681903100"><span class="annot"><span class="annottext">loc :: SrcSpan
</span><a href="#local-6989586621681903100"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; SrcSpan
forall a. NamedThing a =&gt; a -&gt; SrcSpan
</span><a href="GHC.Types.Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681903101"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1336"></span><span>
</span><span id="line-1337"></span><span>    </span><span id="local-6989586621681903106"><span class="annot"><span class="annottext">arg_set :: VarSet
</span><a href="#local-6989586621681903106"><span class="hs-identifier hs-var hs-var">arg_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903048"><span class="hs-identifier hs-var">args'</span></a></span><span>
</span><span id="line-1338"></span><span>    </span><span id="local-6989586621681903076"><span class="annot"><span class="annottext">is_flt_sc_arg :: Id -&gt; Bool
</span><a href="#local-6989586621681903076"><span class="hs-identifier hs-var hs-var">is_flt_sc_arg</span></a></span></span><span> </span><span id="local-6989586621681903108"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903108"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903108"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-1339"></span><span>                      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903108"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1340"></span><span>                      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isDictTy"><span class="hs-identifier hs-var">isDictTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903111"><span class="hs-identifier hs-var">var_ty</span></a></span><span>
</span><span id="line-1341"></span><span>                      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903111"><span class="hs-identifier hs-var">var_ty</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#disjointVarSet"><span class="hs-operator hs-var">`disjointVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903106"><span class="hs-identifier hs-var">arg_set</span></a></span><span>
</span><span id="line-1342"></span><span>       </span><span class="hs-keyword">where</span><span>
</span><span id="line-1343"></span><span>         </span><span id="local-6989586621681903111"><span class="annot"><span class="annottext">var_ty :: Kind
</span><a href="#local-6989586621681903111"><span class="hs-identifier hs-var hs-var">var_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903108"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-1344"></span><span>
</span><span id="line-1345"></span><span>
</span><span id="line-1346"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specCase"><span class="hs-identifier hs-var">specCase</span></a></span><span> </span><span id="local-6989586621681903114"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903114"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903115"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903115"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621681903116"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903116"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621681903117"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681903117"><span class="hs-identifier hs-var">alts</span></a></span></span><span>
</span><span id="line-1347"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903118"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681903118"><span class="hs-identifier hs-var">alts'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903119"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903119"><span class="hs-identifier hs-var">uds_alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Alt Id -&gt; SpecM (Alt Id, UsageDetails))
-&gt; [Alt Id] -&gt; SpecM ([Alt Id], UsageDetails)
forall a b.
(a -&gt; SpecM (b, UsageDetails)) -&gt; [a] -&gt; SpecM ([b], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#mapAndCombineSM"><span class="hs-identifier hs-var">mapAndCombineSM</span></a></span><span> </span><span class="annot"><span class="annottext">Alt Id -&gt; SpecM (Alt Id, UsageDetails)
</span><a href="#local-6989586621681903120"><span class="hs-identifier hs-var">spec_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681903117"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-1348"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(OutExpr, Id, [Alt Id], UsageDetails)
-&gt; SpecM (OutExpr, Id, [Alt Id], UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903115"><span class="hs-identifier hs-var">scrut</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903121"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681903118"><span class="hs-identifier hs-var">alts'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903119"><span class="hs-identifier hs-var">uds_alts</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1349"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1350"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681903122"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903122"><span class="hs-identifier hs-var">env_alt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903121"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903121"><span class="hs-identifier hs-var">case_bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Id -&gt; (SpecEnv, Id)
</span><a href="GHC.Core.Opt.Specialise.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903114"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903116"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>
</span><span id="line-1351"></span><span>    </span><span id="local-6989586621681903120"><span class="annot"><span class="annottext">spec_alt :: Alt Id -&gt; SpecM (Alt Id, UsageDetails)
</span><a href="#local-6989586621681903120"><span class="hs-identifier hs-var hs-var">spec_alt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621681903124"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681903124"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621681903125"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903125"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681903126"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903126"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1352"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903127"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903127"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903128"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903128"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903129"><span class="hs-identifier hs-var">env_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903126"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1353"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903130"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903130"><span class="hs-identifier hs-var">free_uds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903131"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903131"><span class="hs-identifier hs-var">dumped_dbs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; UsageDetails -&gt; (UsageDetails, OrdList DictBind)
</span><a href="GHC.Core.Opt.Specialise.html#dumpUDs"><span class="hs-identifier hs-var">dumpUDs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903121"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903132"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903128"><span class="hs-identifier hs-var">uds</span></a></span><span>
</span><span id="line-1354"></span><span class="hs-comment">--           ; unless (isNilOL dumped_dbs) $</span><span>
</span><span id="line-1355"></span><span class="hs-comment">--             pprTrace &quot;specAlt&quot; (vcat</span><span>
</span><span id="line-1356"></span><span class="hs-comment">--                 [text &quot;case_bndr', args&quot; &lt;+&gt; (ppr case_bndr' $$ ppr args)</span><span>
</span><span id="line-1357"></span><span class="hs-comment">--                 ,text &quot;dumped&quot; &lt;+&gt; ppr dumped_dbs ]) return ()</span><span>
</span><span id="line-1358"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Alt Id, UsageDetails) -&gt; SpecM (Alt Id, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; OutExpr -&gt; Alt Id
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681903124"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903132"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList DictBind -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.Opt.Specialise.html#wrapDictBindsE"><span class="hs-identifier hs-var">wrapDictBindsE</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903131"><span class="hs-identifier hs-var">dumped_dbs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903127"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903130"><span class="hs-identifier hs-var">free_uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1359"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-1360"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621681903129"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903129"><span class="hs-identifier hs-var">env_rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903132"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903132"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; [Id] -&gt; (SpecEnv, [Id])
</span><a href="GHC.Core.Opt.Specialise.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903122"><span class="hs-identifier hs-var">env_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903125"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-1361"></span><span>
</span><span id="line-1362"></span><span class="hs-comment">{- Note [Fire rules in the specialiser]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (#21851)

    module A where
      f :: Num b =&gt; b -&gt; (b, b)
      f x = (x + 1, snd (f x))
      {-# SPECIALIZE f :: Int -&gt; (Int, Int) #-}

    module B (g') where
      import A

      g :: Num a =&gt; a -&gt; a
      g x = fst (f x)
      {-# NOINLINE[99] g #-}

      h :: Int -&gt; Int
      h = g

Note that `f` has the CPR property, and so will worker/wrapper.

The call to `g` in `h` will make us specialise `g @Int`. And the specialised
version of `g` will contain the call `f @Int`; but in the subsequent run of
the Simplifier, there will be a competition between:
* The user-supplied SPECIALISE rule for `f`
* The inlining of the wrapper for `f`
In fact, the latter wins -- see Note [Rewrite rules and inlining] in
GHC.Core.Opt.Simplify.Iteration.  However, it a bit fragile.

Moreover consider (test T21851_2):

    module A
      f :: (Ord a, Show b) =&gt; a -&gt; b -&gt; blah
      {-# RULE forall b. f @Int @b = wombat #-}

      wombat :: Show b =&gt; Int -&gt; b -&gt; blah
      wombat = blah

    module B
      import A
      g :: forall a. Ord a =&gt; blah
      g @a = ...g...f @a @Char....

      h = ....g @Int....

Now, in module B, GHC will specialise `g @Int`, which will lead to a
call `f @Int @Char`.  If we immediately (in the specialiser) rewrite
that to `womabat @Char`, we have a chance to specialise `wombat`.

Conclusion: it's treat if the Specialiser fires RULEs itself.
It's not hard to achieve: see `fireRewriteRules`. The only tricky bit is
making sure that we have a reasonably up to date EPS rule base. Currently
we load it up just once, in `initRuleEnv`, called at the beginning of
`specProgram`.

NB: you might wonder if running rules in the specialiser (this Note)
renders Note [Rewrite rules and inlining] in the Simplifier redundant.
That is, if we run rules in the specialiser, does it matter if we make
rules &quot;win&quot; over inlining in the Simplifier?  Yes, it does!  See the
discussion in #21851.

Note [Floating dictionaries out of cases]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   g = \d. case d of { MkD sc ... -&gt; ...(f sc)... }
Naively we can't float d2's binding out of the case expression,
because 'sc' is bound by the case, and that in turn means we can't
specialise f, which seems a pity.

So we invert the case, by floating out a binding
for 'sc_flt' thus:
    sc_flt = case d of { MkD sc ... -&gt; sc }
Now we can float the call instance for 'f'.  Indeed this is just
what'll happen if 'sc' was originally bound with a let binding,
but case is more efficient, and necessary with equalities. So it's
good to work with both.

You might think that this won't make any difference, because the
call instance will only get nuked by the \d.  BUT if 'g' itself is
specialised, then transitively we should be able to specialise f.

In general, given
   case e of cb { MkD sc ... -&gt; ...(f sc)... }
we transform to
   let cb_flt = e
       sc_flt = case cb_flt of { MkD sc ... -&gt; sc }
   in
   case cb_flt of bg { MkD sc ... -&gt; ....(f sc_flt)... }

The &quot;_flt&quot; things are the floated binds; we use the current substitution
to substitute sc -&gt; sc_flt in the RHS

************************************************************************
*                                                                      *
                     Dealing with a binding
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1460"></span><span>
</span><span id="line-1461"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#bringFloatedDictsIntoScope"><span class="hs-identifier hs-type">bringFloatedDictsIntoScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>
</span><span id="line-1462"></span><span id="bringFloatedDictsIntoScope"><span class="annot"><span class="annottext">bringFloatedDictsIntoScope :: SpecEnv -&gt; FloatedDictBinds -&gt; SpecEnv
</span><a href="GHC.Core.Opt.Specialise.html#bringFloatedDictsIntoScope"><span class="hs-identifier hs-var hs-var">bringFloatedDictsIntoScope</span></a></span></span><span> </span><span id="local-6989586621681903133"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903133"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fdb_bndrs :: FloatedDictBinds -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903136"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903136"><span class="hs-identifier hs-var">dx_bndrs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1463"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;brought into scope&quot; (ppr dx_bndrs) $</span><span>
</span><span id="line-1464"></span><span>    </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903133"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span class="hs-glyph">=</span><span class="annot"><a href="#local-6989586621681903137"><span class="hs-identifier hs-type">subst'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1465"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1466"></span><span>   </span><span id="local-6989586621681903137"><span class="annot"><span class="annottext">subst' :: Subst
</span><a href="#local-6989586621681903137"><span class="hs-identifier hs-var hs-var">subst'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903133"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; VarSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendSubstInScopeSet"><span class="hs-operator hs-var">`Core.extendSubstInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903136"><span class="hs-identifier hs-var">dx_bndrs</span></a></span><span>
</span><span id="line-1467"></span><span>
</span><span id="line-1468"></span><span id="local-6989586621681902282"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specBind"><span class="hs-identifier hs-type">specBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span>
</span><span id="line-1469"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>    </span><span class="hs-comment">-- At top-level only, this env already has the</span><span>
</span><span id="line-1470"></span><span>                       </span><span class="hs-comment">-- top level binders in scope</span><span>
</span><span id="line-1471"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InBind"><span class="hs-identifier hs-type">InBind</span></a></span><span>
</span><span id="line-1472"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681902282"><span class="hs-identifier hs-type">body</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Process the body</span><span>
</span><span id="line-1473"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutBind"><span class="hs-identifier hs-type">OutBind</span></a></span><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- New bindings</span><span>
</span><span id="line-1474"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681902282"><span class="hs-identifier hs-type">body</span></a></span><span>                </span><span class="hs-comment">-- Body</span><span>
</span><span id="line-1475"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">)</span></span><span>       </span><span class="hs-comment">-- And info to pass upstream</span><span>
</span><span id="line-1476"></span><span>
</span><span id="line-1477"></span><span class="hs-comment">-- Returned UsageDetails:</span><span>
</span><span id="line-1478"></span><span class="hs-comment">--    No calls for binders of this bind</span><span>
</span><span id="line-1479"></span><span id="specBind"><span class="annot"><span class="annottext">specBind :: forall body.
TopLevelFlag
-&gt; SpecEnv
-&gt; InBind
-&gt; (SpecEnv -&gt; SpecM (body, UsageDetails))
-&gt; SpecM (CoreProgram, body, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specBind"><span class="hs-identifier hs-var hs-var">specBind</span></a></span></span><span> </span><span id="local-6989586621681903160"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681903160"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681903161"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903161"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681903162"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903162"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681903163"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903163"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903164"><span class="annot"><span class="annottext">SpecEnv -&gt; SpecM (body, UsageDetails)
</span><a href="#local-6989586621681903164"><span class="hs-identifier hs-var">do_body</span></a></span></span><span>
</span><span id="line-1480"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903165"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903165"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903166"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903166"><span class="hs-identifier hs-var">rhs_uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903161"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903163"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1481"></span><span>
</span><span id="line-1482"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903167"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903167"><span class="hs-identifier hs-var">body_env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903168"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903168"><span class="hs-identifier hs-var">fn1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681903160"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1483"></span><span>                               </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SpecEnv, Id) -&gt; UniqSM (SpecEnv, Id)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903161"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903162"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1484"></span><span>                               </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Id -&gt; UniqSM (SpecEnv, Id)
</span><a href="GHC.Core.Opt.Specialise.html#cloneBndrSM"><span class="hs-identifier hs-var">cloneBndrSM</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903161"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903162"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1485"></span><span>
</span><span id="line-1486"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681903170"><span class="annot"><span class="annottext">fn2 :: Id
</span><a href="#local-6989586621681903170"><span class="hs-identifier hs-var hs-var">fn2</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Unfolding
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903168"><span class="hs-identifier hs-var">fn1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903168"><span class="hs-identifier hs-var">fn1</span></a></span><span>
</span><span id="line-1487"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903168"><span class="hs-identifier hs-var">fn1</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unfolding -&gt; Id
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; OutExpr -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkSimpleUnfolding"><span class="hs-identifier hs-var">mkSimpleUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="GHC.Core.Unfold.html#defaultUnfoldingOpts"><span class="hs-identifier hs-var">defaultUnfoldingOpts</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903165"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-1488"></span><span>             </span><span class="hs-comment">-- Update the unfolding with the perhaps-simpler or more specialised rhs'</span><span>
</span><span id="line-1489"></span><span>             </span><span class="hs-comment">-- This is important: see Note [Update unfolding after specialisation]</span><span>
</span><span id="line-1490"></span><span>             </span><span class="hs-comment">-- And in any case cloneBndrSM discards non-Stable unfoldings</span><span>
</span><span id="line-1491"></span><span>
</span><span id="line-1492"></span><span>             </span><span id="local-6989586621681903176"><span class="annot"><span class="annottext">fn3 :: Id
</span><a href="#local-6989586621681903176"><span class="hs-identifier hs-var hs-var">fn3</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="GHC.Types.Id.html#zapIdDemandInfo"><span class="hs-identifier hs-var">zapIdDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903170"><span class="hs-identifier hs-var">fn2</span></a></span><span>
</span><span id="line-1493"></span><span>             </span><span class="hs-comment">-- We zap the demand info because the binding may float,</span><span>
</span><span id="line-1494"></span><span>             </span><span class="hs-comment">-- which would invalidate the demand info (see #17810 for example).</span><span>
</span><span id="line-1495"></span><span>             </span><span class="hs-comment">-- Destroying demand info is not terrible; specialisation is</span><span>
</span><span id="line-1496"></span><span>             </span><span class="hs-comment">-- always followed soon by demand analysis.</span><span>
</span><span id="line-1497"></span><span>
</span><span id="line-1498"></span><span>             </span><span id="local-6989586621681903178"><span class="annot"><span class="annottext">body_env2 :: SpecEnv
</span><a href="#local-6989586621681903178"><span class="hs-identifier hs-var hs-var">body_env2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903167"><span class="hs-identifier hs-var">body_env1</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; FloatedDictBinds -&gt; SpecEnv
</span><a href="GHC.Core.Opt.Specialise.html#bringFloatedDictsIntoScope"><span class="hs-operator hs-var">`bringFloatedDictsIntoScope`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903166"><span class="hs-identifier hs-var">rhs_uds</span></a></span><span>
</span><span id="line-1499"></span><span>                                   </span><span class="annot"><span class="annottext">SpecEnv -&gt; Id -&gt; SpecEnv
</span><a href="GHC.Core.Opt.Specialise.html#extendInScope"><span class="hs-operator hs-var">`extendInScope`</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903176"><span class="hs-identifier hs-var">fn3</span></a></span><span>
</span><span id="line-1500"></span><span>                                   </span><span class="hs-comment">-- bringFloatedDictsIntoScope: see #23567</span><span>
</span><span id="line-1501"></span><span>
</span><span id="line-1502"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903180"><span class="annot"><span class="annottext">body
</span><a href="#local-6989586621681903180"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903181"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903181"><span class="hs-identifier hs-var">body_uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; SpecM (body, UsageDetails)
</span><a href="#local-6989586621681903164"><span class="hs-identifier hs-var">do_body</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903178"><span class="hs-identifier hs-var">body_env2</span></a></span><span>
</span><span id="line-1503"></span><span>
</span><span id="line-1504"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903182"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903182"><span class="hs-identifier hs-var">fn4</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903183"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903183"><span class="hs-identifier hs-var">spec_defns</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903184"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903184"><span class="hs-identifier hs-var">body_uds1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; UsageDetails
-&gt; Id
-&gt; OutExpr
-&gt; SpecM (Id, [(Id, OutExpr)], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specDefn"><span class="hs-identifier hs-var">specDefn</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903161"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903181"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903176"><span class="hs-identifier hs-var">fn3</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903163"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1505"></span><span>
</span><span id="line-1506"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903186"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903186"><span class="hs-identifier hs-var">free_uds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903187"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903187"><span class="hs-identifier hs-var">dump_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903188"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903188"><span class="hs-identifier hs-var">float_all</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; UsageDetails -&gt; (UsageDetails, OrdList DictBind, Bool)
</span><a href="GHC.Core.Opt.Specialise.html#dumpBindUDs"><span class="hs-identifier hs-var">dumpBindUDs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903182"><span class="hs-identifier hs-var">fn4</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903184"><span class="hs-identifier hs-var">body_uds1</span></a></span><span>
</span><span id="line-1507"></span><span>             </span><span id="local-6989586621681903190"><span class="annot"><span class="annottext">all_free_uds :: UsageDetails
</span><a href="#local-6989586621681903190"><span class="hs-identifier hs-var hs-var">all_free_uds</span></a></span></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903186"><span class="hs-identifier hs-var">free_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#thenUDs"><span class="hs-operator hs-var">`thenUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903166"><span class="hs-identifier hs-var">rhs_uds</span></a></span><span>
</span><span id="line-1508"></span><span>
</span><span id="line-1509"></span><span>             </span><span id="local-6989586621681903191"><span class="annot"><span class="annottext">pairs :: [(Id, OutExpr)]
</span><a href="#local-6989586621681903191"><span class="hs-identifier hs-var hs-var">pairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903183"><span class="hs-identifier hs-var">spec_defns</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; [(Id, OutExpr)] -&gt; [(Id, OutExpr)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903182"><span class="hs-identifier hs-var">fn4</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903165"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1510"></span><span>                        </span><span class="hs-comment">-- fn4 mentions the spec_defns in its rules,</span><span>
</span><span id="line-1511"></span><span>                        </span><span class="hs-comment">-- so put the latter first</span><span>
</span><span id="line-1512"></span><span>
</span><span id="line-1513"></span><span>             </span><span class="annot"><a href="#local-6989586621681903192"><span class="hs-identifier hs-type">final_binds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1514"></span><span>             </span><span class="hs-comment">-- See Note [From non-recursive to recursive]</span><span>
</span><span id="line-1515"></span><span>             </span><span id="local-6989586621681903192"><span class="annot"><span class="annottext">final_binds :: [DictBind]
</span><a href="#local-6989586621681903192"><span class="hs-identifier hs-var hs-var">final_binds</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList DictBind -&gt; Bool
forall a. OrdList a -&gt; Bool
</span><a href="GHC.Data.OrdList.html#isNilOL"><span class="hs-identifier hs-var">isNilOL</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903187"><span class="hs-identifier hs-var">dump_dbs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1516"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903183"><span class="hs-identifier hs-var">spec_defns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1517"></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; OrdList DictBind -&gt; DictBind
</span><a href="GHC.Core.Opt.Specialise.html#recWithDumpedDicts"><span class="hs-identifier hs-var">recWithDumpedDicts</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903191"><span class="hs-identifier hs-var">pairs</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903187"><span class="hs-identifier hs-var">dump_dbs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1518"></span><span>                         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1519"></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">InBind -&gt; DictBind
</span><a href="GHC.Core.Opt.Specialise.html#mkDB"><span class="hs-identifier hs-var">mkDB</span></a></span><span> </span><span class="annot"><span class="annottext">(InBind -&gt; DictBind) -&gt; InBind -&gt; DictBind
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr -&gt; InBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903195"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903196"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903195"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903195"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681903196"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903196"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903191"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1520"></span><span>                           </span><span class="annot"><span class="annottext">[DictBind] -&gt; [DictBind] -&gt; [DictBind]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind -&gt; [DictBind]
forall a. OrdList a -&gt; [a]
</span><a href="GHC.Data.OrdList.html#fromOL"><span class="hs-identifier hs-var">fromOL</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903187"><span class="hs-identifier hs-var">dump_dbs</span></a></span><span>
</span><span id="line-1521"></span><span>
</span><span id="line-1522"></span><span>             </span><span id="local-6989586621681903198"><span class="annot"><span class="annottext">can_float_this_one :: Bool
</span><a href="#local-6989586621681903198"><span class="hs-identifier hs-var hs-var">can_float_this_one</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Kind -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTopLevelBindable"><span class="hs-identifier hs-var">exprIsTopLevelBindable</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903163"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903162"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1523"></span><span>             </span><span class="hs-comment">-- exprIsTopLevelBindable: see Note [Care with unlifted bindings]</span><span>
</span><span id="line-1524"></span><span>
</span><span id="line-1525"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903188"><span class="hs-identifier hs-var">float_all</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903198"><span class="hs-identifier hs-var">can_float_this_one</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-1526"></span><span>             </span><span class="hs-comment">-- Rather than discard the calls mentioning the bound variables</span><span>
</span><span id="line-1527"></span><span>             </span><span class="hs-comment">-- we float this (dictionary) binding along with the others</span><span>
</span><span id="line-1528"></span><span>              </span><span class="annot"><span class="annottext">(CoreProgram, body, UsageDetails)
-&gt; SpecM (CoreProgram, body, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">body
</span><a href="#local-6989586621681903180"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903190"><span class="hs-identifier hs-var">all_free_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; [DictBind] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#snocDictBinds"><span class="hs-operator hs-var">`snocDictBinds`</span></a></span><span> </span><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903192"><span class="hs-identifier hs-var">final_binds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1529"></span><span>         </span><span class="hs-keyword">else</span><span>
</span><span id="line-1530"></span><span>             </span><span class="hs-comment">-- No call in final_uds mentions bound variables,</span><span>
</span><span id="line-1531"></span><span>             </span><span class="hs-comment">-- so we can just leave the binding here</span><span>
</span><span id="line-1532"></span><span>              </span><span class="annot"><span class="annottext">(CoreProgram, body, UsageDetails)
-&gt; SpecM (CoreProgram, body, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DictBind -&gt; InBind) -&gt; [DictBind] -&gt; CoreProgram
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span> </span><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903192"><span class="hs-identifier hs-var">final_binds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">body
</span><a href="#local-6989586621681903180"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903190"><span class="hs-identifier hs-var">all_free_uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1533"></span><span>
</span><span id="line-1534"></span><span>
</span><span id="line-1535"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specBind"><span class="hs-identifier hs-var">specBind</span></a></span><span> </span><span id="local-6989586621681903200"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681903200"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681903201"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903201"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681903202"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903202"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903203"><span class="annot"><span class="annottext">SpecEnv -&gt; SpecM (body, UsageDetails)
</span><a href="#local-6989586621681903203"><span class="hs-identifier hs-var">do_body</span></a></span></span><span>
</span><span id="line-1536"></span><span>       </span><span class="hs-comment">-- Note [Specialising a recursive group]</span><span>
</span><span id="line-1537"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903204"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903204"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681903205"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903205"><span class="hs-identifier hs-var">rhss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; ([Id], [OutExpr])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><a href="../../base-4.18.2.1/src/GHC.List.html#unzip/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903202"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-1538"></span><span>
</span><span id="line-1539"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903207"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903207"><span class="hs-identifier hs-var">rec_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903208"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903208"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681903200"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1540"></span><span>                                 </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SpecEnv, [Id]) -&gt; UniqSM (SpecEnv, [Id])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903201"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903204"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1541"></span><span>                                 </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; [Id] -&gt; UniqSM (SpecEnv, [Id])
</span><a href="GHC.Core.Opt.Specialise.html#cloneRecBndrsSM"><span class="hs-identifier hs-var">cloneRecBndrsSM</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903201"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903204"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1542"></span><span>
</span><span id="line-1543"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903210"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903210"><span class="hs-identifier hs-var">rhss'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903211"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903211"><span class="hs-identifier hs-var">rhs_uds</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(OutExpr -&gt; SpecM (OutExpr, UsageDetails))
-&gt; [OutExpr] -&gt; SpecM ([OutExpr], UsageDetails)
forall a b.
(a -&gt; SpecM (b, UsageDetails)) -&gt; [a] -&gt; SpecM ([b], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#mapAndCombineSM"><span class="hs-identifier hs-var">mapAndCombineSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903207"><span class="hs-identifier hs-var">rec_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903205"><span class="hs-identifier hs-var">rhss</span></a></span><span>
</span><span id="line-1544"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903212"><span class="annot"><span class="annottext">body
</span><a href="#local-6989586621681903212"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903213"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903213"><span class="hs-identifier hs-var">body_uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; SpecM (body, UsageDetails)
</span><a href="#local-6989586621681903203"><span class="hs-identifier hs-var">do_body</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903207"><span class="hs-identifier hs-var">rec_env</span></a></span><span>
</span><span id="line-1545"></span><span>
</span><span id="line-1546"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681903214"><span class="annot"><span class="annottext">scope_uds :: UsageDetails
</span><a href="#local-6989586621681903214"><span class="hs-identifier hs-var hs-var">scope_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903213"><span class="hs-identifier hs-var">body_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#thenUDs"><span class="hs-operator hs-var">`thenUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903211"><span class="hs-identifier hs-var">rhs_uds</span></a></span><span>
</span><span id="line-1547"></span><span>                       </span><span class="hs-comment">-- Includes binds and calls arising from rhss</span><span>
</span><span id="line-1548"></span><span>
</span><span id="line-1549"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903215"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903215"><span class="hs-identifier hs-var">bndrs2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903216"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903216"><span class="hs-identifier hs-var">spec_defns2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903217"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903217"><span class="hs-identifier hs-var">uds2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; UsageDetails
-&gt; [(Id, OutExpr)]
-&gt; SpecM ([Id], [(Id, OutExpr)], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specDefns"><span class="hs-identifier hs-var">specDefns</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903207"><span class="hs-identifier hs-var">rec_env</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903214"><span class="hs-identifier hs-var">scope_uds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903208"><span class="hs-identifier hs-var">bndrs1</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [OutExpr] -&gt; [(Id, OutExpr)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#zip/GHC.List.html#zip"><span class="hs-operator hs-var">`zip`</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903205"><span class="hs-identifier hs-var">rhss</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1550"></span><span>         </span><span class="hs-comment">-- bndrs2 is like bndrs1, but with RULES added</span><span>
</span><span id="line-1551"></span><span>
</span><span id="line-1552"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903219"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903219"><span class="hs-identifier hs-var">bndrs3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903220"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903220"><span class="hs-identifier hs-var">spec_defns3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903221"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903221"><span class="hs-identifier hs-var">uds3</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1553"></span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903216"><span class="hs-identifier hs-var">spec_defns2</span></a></span><span>  </span><span class="hs-comment">-- Common case: no specialisation</span><span>
</span><span id="line-1554"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">([Id], [(Id, OutExpr)], UsageDetails)
-&gt; SpecM ([Id], [(Id, OutExpr)], UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903215"><span class="hs-identifier hs-var">bndrs2</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903217"><span class="hs-identifier hs-var">uds2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1555"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>            </span><span class="hs-comment">-- Specialisation occurred; do it again</span><span>
</span><span id="line-1556"></span><span>                          </span><span class="hs-special">(</span><span id="local-6989586621681903222"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903222"><span class="hs-identifier hs-var">bndrs3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903223"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903223"><span class="hs-identifier hs-var">spec_defns3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903224"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903224"><span class="hs-identifier hs-var">uds3</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1557"></span><span>                              </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; UsageDetails
-&gt; [(Id, OutExpr)]
-&gt; SpecM ([Id], [(Id, OutExpr)], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specDefns"><span class="hs-identifier hs-var">specDefns</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903207"><span class="hs-identifier hs-var">rec_env</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903217"><span class="hs-identifier hs-var">uds2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903215"><span class="hs-identifier hs-var">bndrs2</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [OutExpr] -&gt; [(Id, OutExpr)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#zip/GHC.List.html#zip"><span class="hs-operator hs-var">`zip`</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903205"><span class="hs-identifier hs-var">rhss</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1558"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">([Id], [(Id, OutExpr)], UsageDetails)
-&gt; SpecM ([Id], [(Id, OutExpr)], UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903222"><span class="hs-identifier hs-var">bndrs3</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903223"><span class="hs-identifier hs-var">spec_defns3</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; [(Id, OutExpr)] -&gt; [(Id, OutExpr)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903216"><span class="hs-identifier hs-var">spec_defns2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903224"><span class="hs-identifier hs-var">uds3</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1559"></span><span>
</span><span id="line-1560"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903225"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903225"><span class="hs-identifier hs-var">final_uds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903226"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903226"><span class="hs-identifier hs-var">dumped_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903227"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903227"><span class="hs-identifier hs-var">float_all</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; UsageDetails -&gt; (UsageDetails, OrdList DictBind, Bool)
</span><a href="GHC.Core.Opt.Specialise.html#dumpBindUDs"><span class="hs-identifier hs-var">dumpBindUDs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903208"><span class="hs-identifier hs-var">bndrs1</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903221"><span class="hs-identifier hs-var">uds3</span></a></span><span>
</span><span id="line-1561"></span><span>             </span><span id="local-6989586621681903228"><span class="annot"><span class="annottext">final_bind :: DictBind
</span><a href="#local-6989586621681903228"><span class="hs-identifier hs-var hs-var">final_bind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; OrdList DictBind -&gt; DictBind
</span><a href="GHC.Core.Opt.Specialise.html#recWithDumpedDicts"><span class="hs-identifier hs-var">recWithDumpedDicts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903220"><span class="hs-identifier hs-var">spec_defns3</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; [(Id, OutExpr)] -&gt; [(Id, OutExpr)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [OutExpr] -&gt; [(Id, OutExpr)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#zip/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903219"><span class="hs-identifier hs-var">bndrs3</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903210"><span class="hs-identifier hs-var">rhss'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1562"></span><span>                                             </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903226"><span class="hs-identifier hs-var">dumped_dbs</span></a></span><span>
</span><span id="line-1563"></span><span>
</span><span id="line-1564"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903227"><span class="hs-identifier hs-var">float_all</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-1565"></span><span>              </span><span class="annot"><span class="annottext">(CoreProgram, body, UsageDetails)
-&gt; SpecM (CoreProgram, body, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">body
</span><a href="#local-6989586621681903212"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903225"><span class="hs-identifier hs-var">final_uds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; DictBind -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#snocDictBind"><span class="hs-operator hs-var">`snocDictBind`</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind
</span><a href="#local-6989586621681903228"><span class="hs-identifier hs-var">final_bind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1566"></span><span>         </span><span class="hs-keyword">else</span><span>
</span><span id="line-1567"></span><span>              </span><span class="annot"><span class="annottext">(CoreProgram, body, UsageDetails)
-&gt; SpecM (CoreProgram, body, UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind
</span><a href="#local-6989586621681903228"><span class="hs-identifier hs-var">final_bind</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">body
</span><a href="#local-6989586621681903212"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903225"><span class="hs-identifier hs-var">final_uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1568"></span><span>
</span><span id="line-1569"></span><span>
</span><span id="line-1570"></span><span class="hs-comment">---------------------------</span><span>
</span><span id="line-1571"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specDefns"><span class="hs-identifier hs-type">specDefns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>
</span><span id="line-1572"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>               </span><span class="hs-comment">-- Info on how it is used in its scope</span><span>
</span><span id="line-1573"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- The things being bound and their un-processed RHS</span><span>
</span><span id="line-1574"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>            </span><span class="hs-comment">-- Original Ids with RULES added</span><span>
</span><span id="line-1575"></span><span>                    </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- Extra, specialised bindings</span><span>
</span><span id="line-1576"></span><span>                    </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Stuff to fling upwards from the specialised versions</span><span>
</span><span id="line-1577"></span><span>
</span><span id="line-1578"></span><span class="hs-comment">-- Specialise a list of bindings (the contents of a Rec), but flowing usages</span><span>
</span><span id="line-1579"></span><span class="hs-comment">-- upwards binding by binding.  Example: { f = ...g ...; g = ...f .... }</span><span>
</span><span id="line-1580"></span><span class="hs-comment">-- Then if the input CallDetails has a specialised call for 'g', whose specialisation</span><span>
</span><span id="line-1581"></span><span class="hs-comment">-- in turn generates a specialised call for 'f', we catch that in this one sweep.</span><span>
</span><span id="line-1582"></span><span class="hs-comment">-- But not vice versa (it's a fixpoint problem).</span><span>
</span><span id="line-1583"></span><span>
</span><span id="line-1584"></span><span id="specDefns"><span class="annot"><span class="annottext">specDefns :: SpecEnv
-&gt; UsageDetails
-&gt; [(Id, OutExpr)]
-&gt; SpecM ([Id], [(Id, OutExpr)], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specDefns"><span class="hs-identifier hs-var hs-var">specDefns</span></a></span></span><span> </span><span id="local-6989586621681903230"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903230"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span id="local-6989586621681903231"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903231"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1585"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Id], [(Id, OutExpr)], UsageDetails)
-&gt; SpecM ([Id], [(Id, OutExpr)], UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903231"><span class="hs-identifier hs-var">uds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1586"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specDefns"><span class="hs-identifier hs-var">specDefns</span></a></span><span> </span><span id="local-6989586621681903232"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903232"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903233"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903233"><span class="hs-identifier hs-var">uds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621681903234"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903234"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681903235"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903235"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681903236"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903236"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1587"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903237"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903237"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903238"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903238"><span class="hs-identifier hs-var">spec_defns1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903239"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903239"><span class="hs-identifier hs-var">uds1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; UsageDetails
-&gt; [(Id, OutExpr)]
-&gt; SpecM ([Id], [(Id, OutExpr)], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specDefns"><span class="hs-identifier hs-var">specDefns</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903232"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903233"><span class="hs-identifier hs-var">uds</span></a></span><span>  </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903236"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-1588"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903240"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903240"><span class="hs-identifier hs-var">bndr1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903241"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903241"><span class="hs-identifier hs-var">spec_defns2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903242"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903242"><span class="hs-identifier hs-var">uds2</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; UsageDetails
-&gt; Id
-&gt; OutExpr
-&gt; SpecM (Id, [(Id, OutExpr)], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specDefn"><span class="hs-identifier hs-var">specDefn</span></a></span><span>  </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903232"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903239"><span class="hs-identifier hs-var">uds1</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903234"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903235"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1589"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">([Id], [(Id, OutExpr)], UsageDetails)
-&gt; SpecM ([Id], [(Id, OutExpr)], UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903240"><span class="hs-identifier hs-var">bndr1</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903237"><span class="hs-identifier hs-var">bndrs1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903238"><span class="hs-identifier hs-var">spec_defns1</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; [(Id, OutExpr)] -&gt; [(Id, OutExpr)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903241"><span class="hs-identifier hs-var">spec_defns2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903242"><span class="hs-identifier hs-var">uds2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1590"></span><span>
</span><span id="line-1591"></span><span class="hs-comment">---------------------------</span><span>
</span><span id="line-1592"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specDefn"><span class="hs-identifier hs-type">specDefn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>
</span><span id="line-1593"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>                </span><span class="hs-comment">-- Info on how it is used in its scope</span><span>
</span><span id="line-1594"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>             </span><span class="hs-comment">-- The thing being bound and its un-processed RHS</span><span>
</span><span id="line-1595"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span>                  </span><span class="hs-comment">-- Original Id with added RULES</span><span>
</span><span id="line-1596"></span><span>                   </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- Extra, specialised bindings</span><span>
</span><span id="line-1597"></span><span>                   </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- Stuff to fling upwards from the specialised versions</span><span>
</span><span id="line-1598"></span><span>
</span><span id="line-1599"></span><span id="specDefn"><span class="annot"><span class="annottext">specDefn :: SpecEnv
-&gt; UsageDetails
-&gt; Id
-&gt; OutExpr
-&gt; SpecM (Id, [(Id, OutExpr)], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specDefn"><span class="hs-identifier hs-var hs-var">specDefn</span></a></span></span><span> </span><span id="local-6989586621681903243"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903243"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903244"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903244"><span class="hs-identifier hs-var">body_uds</span></a></span></span><span> </span><span id="local-6989586621681903245"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903245"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681903246"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903246"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1600"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903247"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903247"><span class="hs-identifier hs-var">body_uds_without_me</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903248"><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903248"><span class="hs-identifier hs-var">calls_for_me</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; UsageDetails -&gt; (UsageDetails, [CallInfo])
</span><a href="GHC.Core.Opt.Specialise.html#callsForMe"><span class="hs-identifier hs-var">callsForMe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903245"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903244"><span class="hs-identifier hs-var">body_uds</span></a></span><span>
</span><span id="line-1601"></span><span>             </span><span id="local-6989586621681903250"><span class="annot"><span class="annottext">rules_for_me :: [CoreRule]
</span><a href="#local-6989586621681903250"><span class="hs-identifier hs-var hs-var">rules_for_me</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [CoreRule]
</span><a href="GHC.Types.Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903245"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1602"></span><span>             </span><span class="hs-comment">-- Bring into scope the binders from the floated dicts</span><span>
</span><span id="line-1603"></span><span>             </span><span id="local-6989586621681903252"><span class="annot"><span class="annottext">env_w_dict_bndrs :: SpecEnv
</span><a href="#local-6989586621681903252"><span class="hs-identifier hs-var hs-var">env_w_dict_bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; FloatedDictBinds -&gt; SpecEnv
</span><a href="GHC.Core.Opt.Specialise.html#bringFloatedDictsIntoScope"><span class="hs-identifier hs-var">bringFloatedDictsIntoScope</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903243"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903244"><span class="hs-identifier hs-var">body_uds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1604"></span><span>
</span><span id="line-1605"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903253"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681903253"><span class="hs-identifier hs-var">rules</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903254"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903254"><span class="hs-identifier hs-var">spec_defns</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903255"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903255"><span class="hs-identifier hs-var">spec_uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SpecEnv
-&gt; [CoreRule]
-&gt; [CallInfo]
-&gt; Id
-&gt; OutExpr
-&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specCalls"><span class="hs-identifier hs-var">specCalls</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903252"><span class="hs-identifier hs-var">env_w_dict_bndrs</span></a></span><span>
</span><span id="line-1606"></span><span>                                                    </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681903250"><span class="hs-identifier hs-var">rules_for_me</span></a></span><span> </span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903248"><span class="hs-identifier hs-var">calls_for_me</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903245"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903246"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1607"></span><span>
</span><span id="line-1608"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Id, [(Id, OutExpr)], UsageDetails)
-&gt; SpecM (Id, [(Id, OutExpr)], UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903245"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [CoreRule] -&gt; Id
</span><a href="GHC.Core.Rules.html#addIdSpecialisations"><span class="hs-operator hs-var">`addIdSpecialisations`</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681903253"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-1609"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903254"><span class="hs-identifier hs-var">spec_defns</span></a></span><span>
</span><span id="line-1610"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903247"><span class="hs-identifier hs-var">body_uds_without_me</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#thenUDs"><span class="hs-operator hs-var">`thenUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903255"><span class="hs-identifier hs-var">spec_uds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1611"></span><span>                </span><span class="hs-comment">-- It's important that the `thenUDs` is this way</span><span>
</span><span id="line-1612"></span><span>                </span><span class="hs-comment">-- round, because body_uds_without_me may bind</span><span>
</span><span id="line-1613"></span><span>                </span><span class="hs-comment">-- dictionaries that are used in calls_for_me passed</span><span>
</span><span id="line-1614"></span><span>                </span><span class="hs-comment">-- to specDefn.  So the dictionary bindings in</span><span>
</span><span id="line-1615"></span><span>                </span><span class="hs-comment">-- spec_uds may mention dictionaries bound in</span><span>
</span><span id="line-1616"></span><span>                </span><span class="hs-comment">-- body_uds_without_me</span><span>
</span><span id="line-1617"></span><span>
</span><span id="line-1618"></span><span class="hs-comment">---------------------------</span><span>
</span><span id="line-1619"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specCalls"><span class="hs-identifier hs-type">specCalls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>              </span><span class="hs-comment">-- True  =&gt;  specialising imported fn</span><span>
</span><span id="line-1620"></span><span>                               </span><span class="hs-comment">-- False =&gt;  specialising local fn</span><span>
</span><span id="line-1621"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>
</span><span id="line-1622"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Existing RULES for the fn</span><span>
</span><span id="line-1623"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1624"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span>
</span><span id="line-1625"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span>    </span><span class="hs-comment">-- New rules, specialised bindings, and usage details</span><span>
</span><span id="line-1626"></span><span>
</span><span id="line-1627"></span><span class="hs-comment">-- This function checks existing rules, and does not create</span><span>
</span><span id="line-1628"></span><span class="hs-comment">-- duplicate ones. So the caller does not need to do this filtering.</span><span>
</span><span id="line-1629"></span><span class="hs-comment">-- See 'already_covered'</span><span>
</span><span id="line-1630"></span><span>
</span><span id="line-1631"></span><span class="hs-keyword">type</span><span> </span><span id="SpecInfo"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecInfo"><span class="hs-identifier hs-var">SpecInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Specialisation rules</span><span>
</span><span id="line-1632"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Specialised definition</span><span>
</span><span id="line-1633"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Usage details from specialised RHSs</span><span>
</span><span id="line-1634"></span><span>
</span><span id="line-1635"></span><span id="specCalls"><span class="annot"><span class="annottext">specCalls :: Bool
-&gt; SpecEnv
-&gt; [CoreRule]
-&gt; [CallInfo]
-&gt; Id
-&gt; OutExpr
-&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specCalls"><span class="hs-identifier hs-var hs-var">specCalls</span></a></span></span><span> </span><span id="local-6989586621681903258"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903258"><span class="hs-identifier hs-var">spec_imp</span></a></span></span><span> </span><span id="local-6989586621681903259"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903259"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903260"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681903260"><span class="hs-identifier hs-var">existing_rules</span></a></span></span><span> </span><span id="local-6989586621681903261"><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903261"><span class="hs-identifier hs-var">calls_for_me</span></a></span></span><span> </span><span id="local-6989586621681903262"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681903263"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903263"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1636"></span><span>        </span><span class="hs-comment">-- The first case is the interesting one</span><span>
</span><span id="line-1637"></span><span>  </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">[CallInfo] -&gt; Bool
forall (f :: * -&gt; *) a. Foldable f =&gt; f a -&gt; Bool
</span><a href="GHC.Utils.Misc.html#notNull"><span class="hs-identifier hs-var">notNull</span></a></span><span> </span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903261"><span class="hs-identifier hs-var">calls_for_me</span></a></span><span>               </span><span class="hs-comment">-- And there are some calls to specialise</span><span>
</span><span id="line-1638"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#isNeverActive"><span class="hs-identifier hs-var">isNeverActive</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Activation
</span><a href="GHC.Types.Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1639"></span><span>        </span><span class="hs-comment">-- Don't specialise NOINLINE things</span><span>
</span><span id="line-1640"></span><span>        </span><span class="hs-comment">-- See Note [Auto-specialisation and RULES]</span><span>
</span><span id="line-1641"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1642"></span><span>        </span><span class="hs-comment">-- Don't specialise OPAQUE things, see Note [OPAQUE pragma].</span><span>
</span><span id="line-1643"></span><span>        </span><span class="hs-comment">-- Since OPAQUE things are always never-active (see</span><span>
</span><span id="line-1644"></span><span>        </span><span class="hs-comment">-- GHC.Parser.PostProcess.mkOpaquePragma) this guard never fires for</span><span>
</span><span id="line-1645"></span><span>        </span><span class="hs-comment">-- OPAQUE things.</span><span>
</span><span id="line-1646"></span><span>
</span><span id="line-1647"></span><span class="hs-comment">--   &amp;&amp; not (certainlyWillInline (idUnfolding fn))      -- And it's not small</span><span>
</span><span id="line-1648"></span><span class="hs-comment">--      See Note [Inline specialisations] for why we do not</span><span>
</span><span id="line-1649"></span><span class="hs-comment">--      switch off specialisation for inline functions</span><span>
</span><span id="line-1650"></span><span>
</span><span id="line-1651"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;specCalls: some&quot; (vcat</span><span>
</span><span id="line-1652"></span><span>    </span><span class="hs-comment">--   [ text &quot;function&quot; &lt;+&gt; ppr fn</span><span>
</span><span id="line-1653"></span><span>    </span><span class="hs-comment">--   , text &quot;calls:&quot; &lt;+&gt; ppr calls_for_me</span><span>
</span><span id="line-1654"></span><span>    </span><span class="hs-comment">--   , text &quot;subst&quot; &lt;+&gt; ppr (se_subst env) ]) $</span><span>
</span><span id="line-1655"></span><span>    </span><span class="annot"><span class="annottext">(([CoreRule], [(Id, OutExpr)], UsageDetails)
 -&gt; CallInfo -&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails))
-&gt; ([CoreRule], [(Id, OutExpr)], UsageDetails)
-&gt; [CallInfo]
-&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldlM/Data.Foldable.html#foldlM"><span class="hs-identifier hs-var">foldlM</span></a></span><span> </span><span class="annot"><span class="annottext">([CoreRule], [(Id, OutExpr)], UsageDetails)
-&gt; CallInfo -&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
</span><a href="#local-6989586621681903267"><span class="hs-identifier hs-var">spec_call</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903261"><span class="hs-identifier hs-var">calls_for_me</span></a></span><span>
</span><span id="line-1656"></span><span>
</span><span id="line-1657"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-comment">-- No calls or RHS doesn't fit our preconceptions</span><span>
</span><span id="line-1658"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; String
-&gt; SDoc
-&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
-&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903263"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[CallInfo] -&gt; Bool
forall (f :: * -&gt; *) a. Foldable f =&gt; f a -&gt; Bool
</span><a href="GHC.Utils.Misc.html#notNull"><span class="hs-identifier hs-var">notNull</span></a></span><span> </span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903261"><span class="hs-identifier hs-var">calls_for_me</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isClassOpId"><span class="hs-identifier hs-var">isClassOpId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1659"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Missed specialisation opportunity for&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621681903269"><span class="hs-identifier hs-var">trace_doc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
 -&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails))
-&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
-&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1660"></span><span>          </span><span class="hs-comment">-- isClassOpId: class-op Ids never inline; we specialise them</span><span>
</span><span id="line-1661"></span><span>          </span><span class="hs-comment">-- through fireRewriteRules. So don't complain about missed opportunities</span><span>
</span><span id="line-1662"></span><span>          </span><span class="hs-comment">-- Note [Specialisation shape]</span><span>
</span><span id="line-1663"></span><span>    </span><span class="hs-comment">-- pprTrace &quot;specCalls: none&quot; (ppr fn &lt;+&gt; ppr calls_for_me) $</span><span>
</span><span id="line-1664"></span><span>    </span><span class="annot"><span class="annottext">([CoreRule], [(Id, OutExpr)], UsageDetails)
-&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1665"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1666"></span><span>    </span><span id="local-6989586621681903269"><span class="annot"><span class="annottext">trace_doc :: SDoc
</span><a href="#local-6989586621681903269"><span class="hs-identifier hs-var hs-var">trace_doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903271"><span class="hs-identifier hs-var">rhs_bndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Activation -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Activation
</span><a href="GHC.Types.Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1667"></span><span>
</span><span id="line-1668"></span><span>    </span><span id="local-6989586621681903272"><span class="annot"><span class="annottext">fn_type :: Kind
</span><a href="#local-6989586621681903272"><span class="hs-identifier hs-var hs-var">fn_type</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1669"></span><span>    </span><span id="local-6989586621681903273"><span class="annot"><span class="annottext">fn_arity :: Int
</span><a href="#local-6989586621681903273"><span class="hs-identifier hs-var hs-var">fn_arity</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Int
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1670"></span><span>    </span><span id="local-6989586621681903275"><span class="annot"><span class="annottext">fn_unf :: Unfolding
</span><a href="#local-6989586621681903275"><span class="hs-identifier hs-var hs-var">fn_unf</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unfolding
</span><a href="GHC.Types.Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span>  </span><span class="hs-comment">-- Ignore loop-breaker-ness here</span><span>
</span><span id="line-1671"></span><span>    </span><span id="local-6989586621681903276"><span class="annot"><span class="annottext">inl_prag :: InlinePragma
</span><a href="#local-6989586621681903276"><span class="hs-identifier hs-var hs-var">inl_prag</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; InlinePragma
</span><a href="GHC.Types.Id.html#idInlinePragma"><span class="hs-identifier hs-var">idInlinePragma</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1672"></span><span>    </span><span id="local-6989586621681903277"><span class="annot"><span class="annottext">inl_act :: Activation
</span><a href="#local-6989586621681903277"><span class="hs-identifier hs-var hs-var">inl_act</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InlinePragma -&gt; Activation
</span><a href="GHC.Types.Basic.html#inlinePragmaActivation"><span class="hs-identifier hs-var">inlinePragmaActivation</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="#local-6989586621681903276"><span class="hs-identifier hs-var">inl_prag</span></a></span><span>
</span><span id="line-1673"></span><span>    </span><span id="local-6989586621681903279"><span class="annot"><span class="annottext">is_local :: Bool
</span><a href="#local-6989586621681903279"><span class="hs-identifier hs-var hs-var">is_local</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1674"></span><span>    </span><span id="local-6989586621681903280"><span class="annot"><span class="annottext">is_dfun :: Bool
</span><a href="#local-6989586621681903280"><span class="hs-identifier hs-var hs-var">is_dfun</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDFunId"><span class="hs-identifier hs-var">isDFunId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1675"></span><span>    </span><span id="local-6989586621681903282"><span class="annot"><span class="annottext">dflags :: DynFlags
</span><a href="#local-6989586621681903282"><span class="hs-identifier hs-var hs-var">dflags</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; DynFlags
</span><a href="GHC.Core.Opt.Specialise.html#se_dflags"><span class="hs-identifier hs-var">se_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903259"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1676"></span><span>    </span><span id="local-6989586621681903283"><span class="annot"><span class="annottext">this_mod :: Module
</span><a href="#local-6989586621681903283"><span class="hs-identifier hs-var hs-var">this_mod</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Module
</span><a href="GHC.Core.Opt.Specialise.html#se_module"><span class="hs-identifier hs-var">se_module</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903259"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1677"></span><span>        </span><span class="hs-comment">-- Figure out whether the function has an INLINE pragma</span><span>
</span><span id="line-1678"></span><span>        </span><span class="hs-comment">-- See Note [Inline specialisations]</span><span>
</span><span id="line-1679"></span><span>
</span><span id="line-1680"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681903271"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903271"><span class="hs-identifier hs-var">rhs_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903284"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903284"><span class="hs-identifier hs-var">rhs_body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; ([Id], OutExpr)
</span><a href="GHC.Core.Opt.Arity.html#collectBindersPushingCo"><span class="hs-identifier hs-var">collectBindersPushingCo</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903263"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1681"></span><span>                            </span><span class="hs-comment">-- See Note [Account for casts in binding]</span><span>
</span><span id="line-1682"></span><span>
</span><span id="line-1683"></span><span>    </span><span class="annot"><a href="#local-6989586621681903285"><span class="hs-identifier hs-type">already_covered</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1684"></span><span>    </span><span id="local-6989586621681903285"><span class="annot"><span class="annottext">already_covered :: SpecEnv -&gt; [CoreRule] -&gt; [OutExpr] -&gt; Bool
</span><a href="#local-6989586621681903285"><span class="hs-identifier hs-var hs-var">already_covered</span></a></span></span><span> </span><span id="local-6989586621681903286"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903286"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903287"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681903287"><span class="hs-identifier hs-var">new_rules</span></a></span></span><span> </span><span id="local-6989586621681903288"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903288"><span class="hs-identifier hs-var">args</span></a></span></span><span>      </span><span class="hs-comment">-- Note [Specialisations already covered]</span><span>
</span><span id="line-1685"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (CoreRule, OutExpr) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Maybe.html#isJust/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
-&gt; Id
-&gt; [OutExpr]
-&gt; CompilerPhase
-&gt; [CoreRule]
-&gt; Maybe (CoreRule, OutExpr)
</span><a href="GHC.Core.Opt.Specialise.html#specLookupRule"><span class="hs-identifier hs-var">specLookupRule</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903286"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903288"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Activation -&gt; CompilerPhase
</span><a href="GHC.Types.Basic.html#beginPhase"><span class="hs-identifier hs-var">beginPhase</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621681903277"><span class="hs-identifier hs-var">inl_act</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1686"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681903287"><span class="hs-identifier hs-var">new_rules</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; [CoreRule] -&gt; [CoreRule]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681903260"><span class="hs-identifier hs-var">existing_rules</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1687"></span><span>         </span><span class="hs-comment">-- Rules: we look both in the new_rules (generated by this invocation</span><span>
</span><span id="line-1688"></span><span>         </span><span class="hs-comment">--   of specCalls), and in existing_rules (passed in to specCalls)</span><span>
</span><span id="line-1689"></span><span>         </span><span class="hs-comment">-- inl_act: is the activation we are going to put in the new SPEC</span><span>
</span><span id="line-1690"></span><span>         </span><span class="hs-comment">--   rule; so we want to see if it is covered by another rule with</span><span>
</span><span id="line-1691"></span><span>         </span><span class="hs-comment">--   that same activation.</span><span>
</span><span id="line-1692"></span><span>
</span><span id="line-1693"></span><span>    </span><span class="hs-comment">----------------------------------------------------------</span><span>
</span><span id="line-1694"></span><span>        </span><span class="hs-comment">-- Specialise to one particular call pattern</span><span>
</span><span id="line-1695"></span><span>    </span><span class="annot"><a href="#local-6989586621681903267"><span class="hs-identifier hs-type">spec_call</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span>                         </span><span class="hs-comment">-- Accumulating parameter</span><span>
</span><span id="line-1696"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span>                         </span><span class="hs-comment">-- Call instance</span><span>
</span><span id="line-1697"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a></span><span>
</span><span id="line-1698"></span><span>    </span><span id="local-6989586621681903267"><span class="annot"><span class="annottext">spec_call :: ([CoreRule], [(Id, OutExpr)], UsageDetails)
-&gt; CallInfo -&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
</span><a href="#local-6989586621681903267"><span class="hs-identifier hs-var hs-var">spec_call</span></a></span></span><span> </span><span id="local-6989586621681903290"><span class="annot"><span class="annottext">spec_acc :: ([CoreRule], [(Id, OutExpr)], UsageDetails)
</span><a href="#local-6989586621681903290"><span class="hs-identifier hs-var">spec_acc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621681903291"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681903291"><span class="hs-identifier hs-var">rules_acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903292"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903292"><span class="hs-identifier hs-var">pairs_acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903293"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903293"><span class="hs-identifier hs-var">uds_acc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903294"><span class="annot"><span class="annottext">_ci :: CallInfo
</span><a href="#local-6989586621681903294"><span class="hs-identifier hs-var">_ci</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CI"><span class="hs-identifier hs-type">CI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ci_key :: CallInfo -&gt; [SpecArg]
</span><a href="GHC.Core.Opt.Specialise.html#ci_key"><span class="hs-identifier hs-var">ci_key</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903297"><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903297"><span class="hs-identifier hs-var">call_args</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1699"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [Specialising Calls]</span><span>
</span><span id="line-1700"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681903298"><span class="annot"><span class="annottext">all_call_args :: [SpecArg]
</span><a href="#local-6989586621681903298"><span class="hs-identifier hs-var hs-var">all_call_args</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903280"><span class="hs-identifier hs-var">is_dfun</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903299"><span class="hs-identifier hs-var">saturating_call_args</span></a></span><span> </span><span class="hs-comment">-- See Note [Specialising DFuns]</span><span>
</span><span id="line-1701"></span><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903297"><span class="hs-identifier hs-var">call_args</span></a></span><span>
</span><span id="line-1702"></span><span>                 </span><span id="local-6989586621681903299"><span class="annot"><span class="annottext">saturating_call_args :: [SpecArg]
</span><a href="#local-6989586621681903299"><span class="hs-identifier hs-var hs-var">saturating_call_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903297"><span class="hs-identifier hs-var">call_args</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg] -&gt; [SpecArg] -&gt; [SpecArg]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; SpecArg) -&gt; [Id] -&gt; [SpecArg]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SpecArg
</span><a href="#local-6989586621681903300"><span class="hs-identifier hs-var">mk_extra_dfun_arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SpecArg] -&gt; [Id] -&gt; [Id]
forall b a. [b] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#dropList"><span class="hs-identifier hs-var">dropList</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903297"><span class="hs-identifier hs-var">call_args</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903271"><span class="hs-identifier hs-var">rhs_bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1703"></span><span>                 </span><span id="local-6989586621681903300"><span class="annot"><span class="annottext">mk_extra_dfun_arg :: Id -&gt; SpecArg
</span><a href="#local-6989586621681903300"><span class="hs-identifier hs-var hs-var">mk_extra_dfun_arg</span></a></span></span><span> </span><span id="local-6989586621681903302"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903302"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903302"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecType"><span class="hs-identifier hs-var">UnspecType</span></a></span><span>
</span><span id="line-1704"></span><span>                                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecArg"><span class="hs-identifier hs-var">UnspecArg</span></a></span><span>
</span><span id="line-1705"></span><span>
</span><span id="line-1706"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span> </span><span id="local-6989586621681903306"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903306"><span class="hs-identifier hs-var">useful</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903307"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903307"><span class="hs-identifier hs-var">rhs_env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903308"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903308"><span class="hs-identifier hs-var">leftover_bndrs</span></a></span></span><span>
</span><span id="line-1707"></span><span>             </span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903309"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903309"><span class="hs-identifier hs-var">rule_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903310"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903310"><span class="hs-identifier hs-var">rule_lhs_args</span></a></span></span><span>
</span><span id="line-1708"></span><span>             </span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903311"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903311"><span class="hs-identifier hs-var">spec_bndrs1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903312"><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903312"><span class="hs-identifier hs-var">dx_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903313"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903313"><span class="hs-identifier hs-var">spec_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; [Id]
-&gt; [SpecArg]
-&gt; SpecM
     (Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
</span><a href="GHC.Core.Opt.Specialise.html#specHeader"><span class="hs-identifier hs-var">specHeader</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903259"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903271"><span class="hs-identifier hs-var">rhs_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903298"><span class="hs-identifier hs-var">all_call_args</span></a></span><span>
</span><span id="line-1709"></span><span>
</span><span id="line-1710"></span><span class="hs-comment">--           ; pprTrace &quot;spec_call&quot; (vcat</span><span>
</span><span id="line-1711"></span><span class="hs-comment">--                [ text &quot;fun:       &quot;  &lt;+&gt; ppr fn</span><span>
</span><span id="line-1712"></span><span class="hs-comment">--                , text &quot;call info: &quot;  &lt;+&gt; ppr _ci</span><span>
</span><span id="line-1713"></span><span class="hs-comment">--                , text &quot;useful:    &quot;  &lt;+&gt; ppr useful</span><span>
</span><span id="line-1714"></span><span class="hs-comment">--                , text &quot;rule_bndrs:&quot;  &lt;+&gt; ppr rule_bndrs</span><span>
</span><span id="line-1715"></span><span class="hs-comment">--                , text &quot;lhs_args:  &quot;  &lt;+&gt; ppr rule_lhs_args</span><span>
</span><span id="line-1716"></span><span class="hs-comment">--                , text &quot;spec_bndrs1:&quot; &lt;+&gt; ppr spec_bndrs1</span><span>
</span><span id="line-1717"></span><span class="hs-comment">--                , text &quot;leftover_bndrs:&quot; &lt;+&gt; pprIds leftover_bndrs</span><span>
</span><span id="line-1718"></span><span class="hs-comment">--                , text &quot;spec_args: &quot;  &lt;+&gt; ppr spec_args</span><span>
</span><span id="line-1719"></span><span class="hs-comment">--                , text &quot;dx_binds:  &quot;  &lt;+&gt; ppr dx_binds</span><span>
</span><span id="line-1720"></span><span class="hs-comment">--                , text &quot;rhs_bndrs&quot;     &lt;+&gt; ppr rhs_bndrs</span><span>
</span><span id="line-1721"></span><span class="hs-comment">--                , text &quot;rhs_body&quot;     &lt;+&gt; ppr rhs_body</span><span>
</span><span id="line-1722"></span><span class="hs-comment">--                , text &quot;rhs_env2:  &quot;  &lt;+&gt; ppr (se_subst rhs_env2)</span><span>
</span><span id="line-1723"></span><span class="hs-comment">--                , ppr dx_binds ]) $</span><span>
</span><span id="line-1724"></span><span class="hs-comment">--             return ()</span><span>
</span><span id="line-1725"></span><span>
</span><span id="line-1726"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903306"><span class="hs-identifier hs-var">useful</span></a></span><span>  </span><span class="hs-comment">-- No useful specialisation</span><span>
</span><span id="line-1727"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; [CoreRule] -&gt; [OutExpr] -&gt; Bool
</span><a href="#local-6989586621681903285"><span class="hs-identifier hs-var">already_covered</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903307"><span class="hs-identifier hs-var">rhs_env2</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681903291"><span class="hs-identifier hs-var">rules_acc</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903310"><span class="hs-identifier hs-var">rule_lhs_args</span></a></span><span>
</span><span id="line-1728"></span><span>             </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">([CoreRule], [(Id, OutExpr)], UsageDetails)
-&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">([CoreRule], [(Id, OutExpr)], UsageDetails)
</span><a href="#local-6989586621681903290"><span class="hs-identifier hs-var">spec_acc</span></a></span><span>
</span><span id="line-1729"></span><span>             </span><span class="hs-keyword">else</span><span>
</span><span id="line-1730"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Run the specialiser on the specialised RHS</span><span>
</span><span id="line-1731"></span><span>             </span><span class="hs-comment">-- The &quot;1&quot; suffix is before we maybe add the void arg</span><span>
</span><span id="line-1732"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903316"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903316"><span class="hs-identifier hs-var">rhs_body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903317"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903317"><span class="hs-identifier hs-var">rhs_uds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; OutExpr -&gt; SpecM (OutExpr, UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903307"><span class="hs-identifier hs-var">rhs_env2</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903284"><span class="hs-identifier hs-var">rhs_body</span></a></span><span>
</span><span id="line-1733"></span><span>                </span><span class="hs-comment">-- Add the { d1' = dx1; d2' = dx2 } usage stuff</span><span>
</span><span id="line-1734"></span><span>                </span><span class="hs-comment">-- to the rhs_uds; see Note [Specialising Calls]</span><span>
</span><span id="line-1735"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681903318"><span class="annot"><span class="annottext">rhs_uds_w_dx :: UsageDetails
</span><a href="#local-6989586621681903318"><span class="hs-identifier hs-var hs-var">rhs_uds_w_dx</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903312"><span class="hs-identifier hs-var">dx_binds</span></a></span><span> </span><span class="annot"><span class="annottext">[DictBind] -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#consDictBinds"><span class="hs-operator hs-var">`consDictBinds`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903317"><span class="hs-identifier hs-var">rhs_uds</span></a></span><span>
</span><span id="line-1736"></span><span>                 </span><span id="local-6989586621681903319"><span class="annot"><span class="annottext">spec_rhs_bndrs :: [Id]
</span><a href="#local-6989586621681903319"><span class="hs-identifier hs-var hs-var">spec_rhs_bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903311"><span class="hs-identifier hs-var">spec_bndrs1</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903308"><span class="hs-identifier hs-var">leftover_bndrs</span></a></span><span>
</span><span id="line-1737"></span><span>                 </span><span class="hs-special">(</span><span id="local-6989586621681903320"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903320"><span class="hs-identifier hs-var">spec_uds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903321"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903321"><span class="hs-identifier hs-var">dumped_dbs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; UsageDetails -&gt; (UsageDetails, OrdList DictBind)
</span><a href="GHC.Core.Opt.Specialise.html#dumpUDs"><span class="hs-identifier hs-var">dumpUDs</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903319"><span class="hs-identifier hs-var">spec_rhs_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903318"><span class="hs-identifier hs-var">rhs_uds_w_dx</span></a></span><span>
</span><span id="line-1738"></span><span>                 </span><span id="local-6989586621681903322"><span class="annot"><span class="annottext">spec_rhs1 :: OutExpr
</span><a href="#local-6989586621681903322"><span class="hs-identifier hs-var hs-var">spec_rhs1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; OutExpr -&gt; OutExpr
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903319"><span class="hs-identifier hs-var">spec_rhs_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">(OutExpr -&gt; OutExpr) -&gt; OutExpr -&gt; OutExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1739"></span><span>                             </span><span class="annot"><span class="annottext">OrdList DictBind -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.Opt.Specialise.html#wrapDictBindsE"><span class="hs-identifier hs-var">wrapDictBindsE</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903321"><span class="hs-identifier hs-var">dumped_dbs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903316"><span class="hs-identifier hs-var">rhs_body'</span></a></span><span>
</span><span id="line-1740"></span><span>
</span><span id="line-1741"></span><span>                 </span><span id="local-6989586621681903323"><span class="annot"><span class="annottext">spec_fn_ty1 :: Kind
</span><a href="#local-6989586621681903323"><span class="hs-identifier hs-var hs-var">spec_fn_ty1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; OutExpr -&gt; Kind
OutExpr -&gt; Kind
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903322"><span class="hs-identifier hs-var">spec_rhs1</span></a></span><span>
</span><span id="line-1742"></span><span>
</span><span id="line-1743"></span><span>                 </span><span class="hs-comment">-- Maybe add a void arg to the specialised function,</span><span>
</span><span id="line-1744"></span><span>                 </span><span class="hs-comment">-- to avoid unlifted bindings</span><span>
</span><span id="line-1745"></span><span>                 </span><span class="hs-comment">-- See Note [Specialisations Must Be Lifted]</span><span>
</span><span id="line-1746"></span><span>                 </span><span class="hs-comment">-- C.f. GHC.Core.Opt.WorkWrap.Utils.needsVoidWorkerArg</span><span>
</span><span id="line-1747"></span><span>                 </span><span id="local-6989586621681903324"><span class="annot"><span class="annottext">add_void_arg :: Bool
</span><a href="#local-6989586621681903324"><span class="hs-identifier hs-var hs-var">add_void_arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Kind -&gt; Bool
Kind -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903323"><span class="hs-identifier hs-var">spec_fn_ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1748"></span><span>                 </span><span class="hs-special">(</span><span id="local-6989586621681903327"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903327"><span class="hs-identifier hs-var">spec_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903328"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903328"><span class="hs-identifier hs-var">spec_rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903329"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903329"><span class="hs-identifier hs-var">spec_fn_ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1749"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903324"><span class="hs-identifier hs-var">add_void_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Types.Id.Make.html#voidPrimId"><span class="hs-identifier hs-var">voidPrimId</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903311"><span class="hs-identifier hs-var">spec_bndrs1</span></a></span><span>
</span><span id="line-1750"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr -&gt; OutExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="GHC.Types.Id.Make.html#voidArgId"><span class="hs-identifier hs-var">voidArgId</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903322"><span class="hs-identifier hs-var">spec_rhs1</span></a></span><span>
</span><span id="line-1751"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Kind -&gt; Kind -&gt; Kind
Kind -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.TyCo.Rep.html#mkVisFunTyMany"><span class="hs-identifier hs-var">mkVisFunTyMany</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Builtin.Types.html#unboxedUnitTy"><span class="hs-identifier hs-var">unboxedUnitTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903323"><span class="hs-identifier hs-var">spec_fn_ty1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1752"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903311"><span class="hs-identifier hs-var">spec_bndrs1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903322"><span class="hs-identifier hs-var">spec_rhs1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903323"><span class="hs-identifier hs-var">spec_fn_ty1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1753"></span><span>
</span><span id="line-1754"></span><span>                 </span><span id="local-6989586621681903331"><span class="annot"><span class="annottext">join_arity_decr :: Int
</span><a href="#local-6989586621681903331"><span class="hs-identifier hs-var hs-var">join_arity_decr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OutExpr] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903310"><span class="hs-identifier hs-var">rule_lhs_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.2.1/src/GHC.Num.html#-/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903327"><span class="hs-identifier hs-var">spec_bndrs</span></a></span><span>
</span><span id="line-1755"></span><span>
</span><span id="line-1756"></span><span>                 </span><span class="hs-comment">--------------------------------------</span><span>
</span><span id="line-1757"></span><span>                 </span><span class="hs-comment">-- Add a suitable unfolding; see Note [Inline specialisations]</span><span>
</span><span id="line-1758"></span><span>                 </span><span class="hs-comment">-- The wrap_unf_body applies the original unfolding to the specialised</span><span>
</span><span id="line-1759"></span><span>                 </span><span class="hs-comment">-- arguments, not forgetting to wrap the dx_binds around the outside (#22358)</span><span>
</span><span id="line-1760"></span><span>                 </span><span id="local-6989586621681903333"><span class="annot"><span class="annottext">simpl_opts :: SimpleOpts
</span><a href="#local-6989586621681903333"><span class="hs-identifier hs-var hs-var">simpl_opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; SimpleOpts
</span><a href="GHC.Driver.Config.html#initSimpleOpts"><span class="hs-identifier hs-var">initSimpleOpts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681903282"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-1761"></span><span>                 </span><span id="local-6989586621681903335"><span class="annot"><span class="annottext">wrap_unf_body :: OutExpr -&gt; OutExpr
</span><a href="#local-6989586621681903335"><span class="hs-identifier hs-var hs-var">wrap_unf_body</span></a></span></span><span> </span><span id="local-6989586621681903336"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903336"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DictBind -&gt; OutExpr -&gt; OutExpr)
-&gt; OutExpr -&gt; [DictBind] -&gt; OutExpr
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InBind -&gt; OutExpr -&gt; OutExpr
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">(InBind -&gt; OutExpr -&gt; OutExpr)
-&gt; (DictBind -&gt; InBind) -&gt; DictBind -&gt; OutExpr -&gt; OutExpr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903336"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; [OutExpr] -&gt; OutExpr
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-operator hs-var">`mkApps`</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903313"><span class="hs-identifier hs-var">spec_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903312"><span class="hs-identifier hs-var">dx_binds</span></a></span><span>
</span><span id="line-1762"></span><span>                 </span><span id="local-6989586621681903337"><span class="annot"><span class="annottext">spec_unf :: Unfolding
</span><a href="#local-6989586621681903337"><span class="hs-identifier hs-var hs-var">spec_unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimpleOpts
-&gt; [Id]
-&gt; (OutExpr -&gt; OutExpr)
-&gt; [OutExpr]
-&gt; Unfolding
-&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#specUnfolding"><span class="hs-identifier hs-var">specUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681903333"><span class="hs-identifier hs-var">simpl_opts</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903327"><span class="hs-identifier hs-var">spec_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; OutExpr
</span><a href="#local-6989586621681903335"><span class="hs-identifier hs-var">wrap_unf_body</span></a></span><span>
</span><span id="line-1763"></span><span>                                          </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903310"><span class="hs-identifier hs-var">rule_lhs_args</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681903275"><span class="hs-identifier hs-var">fn_unf</span></a></span><span>
</span><span id="line-1764"></span><span>
</span><span id="line-1765"></span><span>                 </span><span class="hs-comment">--------------------------------------</span><span>
</span><span id="line-1766"></span><span>                 </span><span class="hs-comment">-- Adding arity information just propagates it a bit faster</span><span>
</span><span id="line-1767"></span><span>                 </span><span class="hs-comment">--      See Note [Arity decrease] in GHC.Core.Opt.Simplify</span><span>
</span><span id="line-1768"></span><span>                 </span><span class="hs-comment">-- Copy InlinePragma information from the parent Id.</span><span>
</span><span id="line-1769"></span><span>                 </span><span class="hs-comment">-- So if f has INLINE[1] so does spec_fn</span><span>
</span><span id="line-1770"></span><span>                 </span><span id="local-6989586621681903338"><span class="annot"><span class="annottext">arity_decr :: Int
</span><a href="#local-6989586621681903338"><span class="hs-identifier hs-var hs-var">arity_decr</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutExpr -&gt; Bool) -&gt; [OutExpr] -&gt; Int
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Int
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isValArg"><span class="hs-identifier hs-var">isValArg</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903310"><span class="hs-identifier hs-var">rule_lhs_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.2.1/src/GHC.Num.html#-/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Int
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Int
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903327"><span class="hs-identifier hs-var">spec_bndrs</span></a></span><span>
</span><span id="line-1771"></span><span>
</span><span id="line-1772"></span><span>                 </span><span id="local-6989586621681903341"><span class="annot"><span class="annottext">spec_inl_prag :: InlinePragma
</span><a href="#local-6989586621681903341"><span class="hs-identifier hs-var hs-var">spec_inl_prag</span></a></span></span><span>
</span><span id="line-1773"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903279"><span class="hs-identifier hs-var">is_local</span></a></span><span>     </span><span class="hs-comment">-- See Note [Specialising imported functions]</span><span>
</span><span id="line-1774"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OccInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isStrongLoopBreaker"><span class="hs-identifier hs-var">isStrongLoopBreaker</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- in GHC.Core.Opt.OccurAnal</span><span>
</span><span id="line-1775"></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="GHC.Types.Basic.html#neverInlinePragma"><span class="hs-identifier hs-var">neverInlinePragma</span></a></span><span>
</span><span id="line-1776"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1777"></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="#local-6989586621681903276"><span class="hs-identifier hs-var">inl_prag</span></a></span><span>
</span><span id="line-1778"></span><span>
</span><span id="line-1779"></span><span>                 </span><span id="local-6989586621681903345"><span class="annot"><span class="annottext">spec_fn_info :: IdInfo
</span><a href="#local-6989586621681903345"><span class="hs-identifier hs-var hs-var">spec_fn_info</span></a></span></span><span>
</span><span id="line-1780"></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="GHC.Types.Id.Info.html#vanillaIdInfo"><span class="hs-identifier hs-var">vanillaIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Int -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setArityInfo"><span class="hs-operator hs-var">`setArityInfo`</span></a></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681903273"><span class="hs-identifier hs-var">fn_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.2.1/src/GHC.Num.html#-/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681903338"><span class="hs-identifier hs-var">arity_decr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1781"></span><span>                                   </span><span class="annot"><span class="annottext">IdInfo -&gt; InlinePragma -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setInlinePragInfo"><span class="hs-operator hs-var">`setInlinePragInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="#local-6989586621681903341"><span class="hs-identifier hs-var">spec_inl_prag</span></a></span><span>
</span><span id="line-1782"></span><span>                                   </span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setUnfoldingInfo"><span class="hs-operator hs-var">`setUnfoldingInfo`</span></a></span><span>  </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681903337"><span class="hs-identifier hs-var">spec_unf</span></a></span><span>
</span><span id="line-1783"></span><span>
</span><span id="line-1784"></span><span>                 </span><span class="hs-comment">-- Compute the IdDetails of the specialise Id</span><span>
</span><span id="line-1785"></span><span>                 </span><span class="hs-comment">-- See Note [Transfer IdDetails during specialisation]</span><span>
</span><span id="line-1786"></span><span>                 </span><span id="local-6989586621681903351"><span class="annot"><span class="annottext">spec_fn_details :: IdDetails
</span><a href="#local-6989586621681903351"><span class="hs-identifier hs-var hs-var">spec_fn_details</span></a></span></span><span>
</span><span id="line-1787"></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Id -&gt; IdDetails
</span><a href="GHC.Types.Var.html#idDetails"><span class="hs-identifier hs-var">idDetails</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1788"></span><span>                       </span><span class="annot"><a href="GHC.Types.Id.Info.html#JoinId"><span class="hs-identifier hs-type">JoinId</span></a></span><span> </span><span id="local-6989586621681903354"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681903354"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe [CbvMark]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe [CbvMark] -&gt; IdDetails
</span><a href="GHC.Types.Id.Info.html#JoinId"><span class="hs-identifier hs-var">JoinId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681903354"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.2.1/src/GHC.Num.html#-/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681903331"><span class="hs-identifier hs-var">join_arity_decr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe [CbvMark]
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1789"></span><span>                       </span><span class="annot"><a href="GHC.Types.Id.Info.html#DFunId"><span class="hs-identifier hs-type">DFunId</span></a></span><span> </span><span id="local-6989586621681903356"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903356"><span class="hs-identifier hs-var">is_nt</span></a></span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IdDetails
</span><a href="GHC.Types.Id.Info.html#DFunId"><span class="hs-identifier hs-var">DFunId</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903356"><span class="hs-identifier hs-var">is_nt</span></a></span><span>
</span><span id="line-1790"></span><span>                       </span><span class="annot"><span class="annottext">IdDetails
</span><span class="hs-identifier">_</span></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IdDetails
</span><a href="GHC.Types.Id.Info.html#VanillaId"><span class="hs-identifier hs-var">VanillaId</span></a></span><span>
</span><span id="line-1791"></span><span>
</span><span id="line-1792"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681903358"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903358"><span class="hs-identifier hs-var">spec_fn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Kind -&gt; IdDetails -&gt; IdInfo -&gt; UniqSM Id
</span><a href="GHC.Core.Opt.Specialise.html#newSpecIdSM"><span class="hs-identifier hs-var">newSpecIdSM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903329"><span class="hs-identifier hs-var">spec_fn_ty</span></a></span><span> </span><span class="annot"><span class="annottext">IdDetails
</span><a href="#local-6989586621681903351"><span class="hs-identifier hs-var">spec_fn_details</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681903345"><span class="hs-identifier hs-var">spec_fn_info</span></a></span><span>
</span><span id="line-1793"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-1794"></span><span>                </span><span class="hs-comment">-- The rule to put in the function's specialisation is:</span><span>
</span><span id="line-1795"></span><span>                </span><span class="hs-comment">--      forall x @b d1' d2'.</span><span>
</span><span id="line-1796"></span><span>                </span><span class="hs-comment">--          f x @T1 @b @T2 d1' d2' = f1 x @b</span><span>
</span><span id="line-1797"></span><span>                </span><span class="hs-comment">-- See Note [Specialising Calls]</span><span>
</span><span id="line-1798"></span><span>                </span><span id="local-6989586621681903360"><span class="annot"><span class="annottext">herald :: SDoc
</span><a href="#local-6989586621681903360"><span class="hs-identifier hs-var hs-var">herald</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903258"><span class="hs-identifier hs-var">spec_imp</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Specialising imported fn</span><span>
</span><span id="line-1799"></span><span>                                     </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SPEC/&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Module -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681903283"><span class="hs-identifier hs-var">this_mod</span></a></span><span>
</span><span id="line-1800"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Specialising local fn</span><span>
</span><span id="line-1801"></span><span>                                     </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SPEC&quot;</span></span><span>
</span><span id="line-1802"></span><span>
</span><span id="line-1803"></span><span>                </span><span id="local-6989586621681903362"><span class="annot"><span class="annottext">spec_rule :: CoreRule
</span><a href="#local-6989586621681903362"><span class="hs-identifier hs-var hs-var">spec_rule</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags
-&gt; Module
-&gt; Bool
-&gt; Activation
-&gt; SDoc
-&gt; Id
-&gt; [Id]
-&gt; [OutExpr]
-&gt; OutExpr
-&gt; CoreRule
</span><a href="GHC.Core.Rules.html#mkSpecRule"><span class="hs-identifier hs-var">mkSpecRule</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681903282"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681903283"><span class="hs-identifier hs-var">this_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621681903277"><span class="hs-identifier hs-var">inl_act</span></a></span><span>
</span><span id="line-1804"></span><span>                                    </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621681903360"><span class="hs-identifier hs-var">herald</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903309"><span class="hs-identifier hs-var">rule_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903310"><span class="hs-identifier hs-var">rule_lhs_args</span></a></span><span>
</span><span id="line-1805"></span><span>                                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr -&gt; [Id] -&gt; OutExpr
forall b. Expr b -&gt; [Id] -&gt; Expr b
</span><a href="GHC.Core.html#mkVarApps"><span class="hs-identifier hs-var">mkVarApps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903358"><span class="hs-identifier hs-var">spec_fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903327"><span class="hs-identifier hs-var">spec_bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1806"></span><span>
</span><span id="line-1807"></span><span>                </span><span id="local-6989586621681903365"><span class="annot"><span class="annottext">spec_f_w_arity :: Id
</span><a href="#local-6989586621681903365"><span class="hs-identifier hs-var hs-var">spec_f_w_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903358"><span class="hs-identifier hs-var">spec_fn</span></a></span><span>
</span><span id="line-1808"></span><span>
</span><span id="line-1809"></span><span>                </span><span id="local-6989586621681903366"><span class="annot"><span class="annottext">_rule_trace_doc :: SDoc
</span><a href="#local-6989586621681903366"><span class="hs-identifier hs-var hs-var">_rule_trace_doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903262"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="GHC.Utils.Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903272"><span class="hs-identifier hs-var">fn_type</span></a></span><span>
</span><span id="line-1810"></span><span>                                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903358"><span class="hs-identifier hs-var">spec_fn</span></a></span><span>  </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="GHC.Utils.Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903329"><span class="hs-identifier hs-var">spec_fn_ty</span></a></span><span>
</span><span id="line-1811"></span><span>                                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903271"><span class="hs-identifier hs-var">rhs_bndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SpecArg] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903297"><span class="hs-identifier hs-var">call_args</span></a></span><span>
</span><span id="line-1812"></span><span>                                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621681903362"><span class="hs-identifier hs-var">spec_rule</span></a></span><span>
</span><span id="line-1813"></span><span>                                       </span><span class="hs-special">]</span><span>
</span><span id="line-1814"></span><span>
</span><span id="line-1815"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- pprTrace &quot;spec_call: rule&quot; _rule_trace_doc</span><span>
</span><span id="line-1816"></span><span>             </span><span class="annot"><span class="annottext">([CoreRule], [(Id, OutExpr)], UsageDetails)
-&gt; SpecM ([CoreRule], [(Id, OutExpr)], UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621681903362"><span class="hs-identifier hs-var">spec_rule</span></a></span><span>                  </span><span class="annot"><span class="annottext">CoreRule -&gt; [CoreRule] -&gt; [CoreRule]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681903291"><span class="hs-identifier hs-var">rules_acc</span></a></span><span>
</span><span id="line-1817"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903365"><span class="hs-identifier hs-var">spec_f_w_arity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903328"><span class="hs-identifier hs-var">spec_rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Id, OutExpr) -&gt; [(Id, OutExpr)] -&gt; [(Id, OutExpr)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903292"><span class="hs-identifier hs-var">pairs_acc</span></a></span><span>
</span><span id="line-1818"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903320"><span class="hs-identifier hs-var">spec_uds</span></a></span><span>           </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#thenUDs"><span class="hs-operator hs-var">`thenUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903293"><span class="hs-identifier hs-var">uds_acc</span></a></span><span>
</span><span id="line-1819"></span><span>                    </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1820"></span><span>
</span><span id="line-1821"></span><span class="hs-comment">-- Convenience function for invoking lookupRule from Specialise</span><span>
</span><span id="line-1822"></span><span class="hs-comment">-- The SpecEnv's InScopeSet should include all the Vars in the [CoreExpr]</span><span>
</span><span id="line-1823"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specLookupRule"><span class="hs-identifier hs-type">specLookupRule</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1824"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#CompilerPhase"><span class="hs-identifier hs-type">CompilerPhase</span></a></span><span>  </span><span class="hs-comment">-- Look up rules as if we were in this phase</span><span>
</span><span id="line-1825"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1826"></span><span id="specLookupRule"><span class="annot"><span class="annottext">specLookupRule :: SpecEnv
-&gt; Id
-&gt; [OutExpr]
-&gt; CompilerPhase
-&gt; [CoreRule]
-&gt; Maybe (CoreRule, OutExpr)
</span><a href="GHC.Core.Opt.Specialise.html#specLookupRule"><span class="hs-identifier hs-var hs-var">specLookupRule</span></a></span></span><span> </span><span id="local-6989586621681903368"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903368"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903369"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903369"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681903370"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903370"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681903371"><span class="annot"><span class="annottext">CompilerPhase
</span><a href="#local-6989586621681903371"><span class="hs-identifier hs-var">phase</span></a></span></span><span> </span><span id="local-6989586621681903372"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681903372"><span class="hs-identifier hs-var">rules</span></a></span></span><span>
</span><span id="line-1827"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleOpts
-&gt; InScopeEnv
-&gt; (Activation -&gt; Bool)
-&gt; Id
-&gt; [OutExpr]
-&gt; [CoreRule]
-&gt; Maybe (CoreRule, OutExpr)
</span><a href="GHC.Core.Rules.html#lookupRule"><span class="hs-identifier hs-var">lookupRule</span></a></span><span> </span><span class="annot"><span class="annottext">RuleOpts
</span><a href="#local-6989586621681903374"><span class="hs-identifier hs-var">ropts</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeEnv
</span><a href="#local-6989586621681903375"><span class="hs-identifier hs-var">in_scope_env</span></a></span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621681903376"><span class="hs-identifier hs-var">is_active</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903369"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903370"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681903372"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-1828"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1829"></span><span>    </span><span id="local-6989586621681903377"><span class="annot"><span class="annottext">dflags :: DynFlags
</span><a href="#local-6989586621681903377"><span class="hs-identifier hs-var hs-var">dflags</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; DynFlags
</span><a href="GHC.Core.Opt.Specialise.html#se_dflags"><span class="hs-identifier hs-var">se_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903368"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1830"></span><span>    </span><span id="local-6989586621681903378"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621681903378"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; InScopeSet
</span><a href="GHC.Core.TyCo.Subst.html#getSubstInScope"><span class="hs-identifier hs-var">getSubstInScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903368"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1831"></span><span>    </span><span id="local-6989586621681903375"><span class="annot"><span class="annottext">in_scope_env :: InScopeEnv
</span><a href="#local-6989586621681903375"><span class="hs-identifier hs-var hs-var">in_scope_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; (Id -&gt; Unfolding) -&gt; InScopeEnv
</span><a href="GHC.Core.html#ISE"><span class="hs-identifier hs-var">ISE</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681903378"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Activation -&gt; Bool) -&gt; Id -&gt; Unfolding
</span><a href="GHC.Types.Id.html#whenActiveUnfoldingFun"><span class="hs-identifier hs-var">whenActiveUnfoldingFun</span></a></span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621681903376"><span class="hs-identifier hs-var">is_active</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1832"></span><span>    </span><span id="local-6989586621681903374"><span class="annot"><span class="annottext">ropts :: RuleOpts
</span><a href="#local-6989586621681903374"><span class="hs-identifier hs-var hs-var">ropts</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; RuleOpts
</span><a href="GHC.Driver.Config.Core.Rules.html#initRuleOpts"><span class="hs-identifier hs-var">initRuleOpts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681903377"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-1833"></span><span>    </span><span id="local-6989586621681903376"><span class="annot"><span class="annottext">is_active :: Activation -&gt; Bool
</span><a href="#local-6989586621681903376"><span class="hs-identifier hs-var hs-var">is_active</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompilerPhase -&gt; Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#isActive"><span class="hs-identifier hs-var">isActive</span></a></span><span> </span><span class="annot"><span class="annottext">CompilerPhase
</span><a href="#local-6989586621681903371"><span class="hs-identifier hs-var">phase</span></a></span><span>
</span><span id="line-1834"></span><span>
</span><span id="line-1835"></span><span class="hs-comment">{- Note [Specialising DFuns]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
DFuns have a special sort of unfolding (DFunUnfolding), and it is
hard to specialise a DFunUnfolding to give another DFunUnfolding
unless the DFun is fully applied (#18120).  So, in the case of DFunIds
we simply extend the CallKey with trailing UnspecTypes/UnspecArgs,
so that we'll generate a rule that completely saturates the DFun.

There is an ASSERT that checks this, in the DFunUnfolding case of
GHC.Core.Unfold.Make.specUnfolding.

Note [Transfer IdDetails during specialisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When specialising a function, `newSpecIdSM` comes up with a fresh Id the
specialised RHS will be bound to. It is critical that we get the `IdDetails` of
the specialised Id correct:

* JoinId: We want the specialised Id to be a join point, too.  But
  we have to carefully adjust the arity

* DFunId: It is crucial that we also make the new Id a DFunId.
  - First, because it obviously /is/ a DFun, having a DFunUnfolding and
    all that; see Note [Specialising DFuns]

  - Second, DFuns get very delicate special treatment in the demand analyser;
    see GHC.Core.Opt.DmdAnal.enterDFun.  If the specialised function isn't
    also a DFunId, this special treatment doesn't happen, so the demand
    analyser makes a too-strict DFun, and we get an infinite loop.  See Note
    [Do not strictify a DFun's parameter dictionaries] in GHC.Core.Opt.DmdAnal.
    #22549 describes the loop, and (lower down) a case where a /specialised/
    DFun caused a loop.

* WorkerLikeId: Introduced by WW, so after Specialise. Nevertheless, they come
  up when specialising imports. We must keep them as VanillaIds because WW
  will detect them as WorkerLikeIds again. That is, unless specialisation
  allows unboxing of all previous CBV args, in which case sticking to
  VanillaIds was the only correct choice to begin with.

* RecSelId, DataCon*Id, ClassOpId, PrimOpId, FCallId, CoVarId, TickBoxId:
  Never specialised.

Note [Specialisation Must Preserve Sharing]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider a function:

    f :: forall a. Eq a =&gt; a -&gt; blah
    f =
      if expensive
         then f1
         else f2

As written, all calls to 'f' will share 'expensive'. But if we specialise 'f'
at 'Int', eg:

    $sfInt = SUBST[a-&gt;Int,dict-&gt;dEqInt] (if expensive then f1 else f2)

    RULE &quot;SPEC f&quot;
      forall (d :: Eq Int).
        f Int _ = $sfIntf

We've now lost sharing between 'f' and '$sfInt' for 'expensive'. Yikes!

To avoid this, we only generate specialisations for functions whose arity is
enough to bind all of the arguments we need to specialise.  This ensures our
specialised functions don't do any work before receiving all of their dicts,
and thus avoids the 'f' case above.

Note [Specialisations Must Be Lifted]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider a function 'f':

    f = forall a. Eq a =&gt; Array# a

used like

    case x of
      True -&gt; ...f @Int dEqInt...
      False -&gt; 0

Naively, we might generate an (expensive) specialisation

    $sfInt :: Array# Int

even in the case that @x = False@! Instead, we add a dummy 'Void#' argument to
the specialisation '$sfInt' ($sfInt :: Void# -&gt; Array# Int) in order to
preserve laziness.

Note [Care with unlifted bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (#22998)
    f x = let x::ByteArray# = &lt;some literal&gt;
              n::Natural    = NB x
          in wombat @192827 (n |&gt; co)
where
  co :: Natural ~ KnownNat 192827
  wombat :: forall (n:Nat). KnownNat n =&gt; blah

Left to itself, the specialiser would float the bindings for `x` and `n` to top
level, so we can specialise `wombat`.  But we can't have a top-level ByteArray#
(see Note [Core letrec invariant] in GHC.Core).  Boo.

This is pretty exotic, so we take a simple way out: in specBind (the NonRec
case) do not float the binding itself unless it satisfies exprIsTopLevelBindable.
This is conservative: maybe the RHS of `x` has a free var that would stop it
floating to top level anyway; but that is hard to spot (since we don't know what
the non-top-level in-scope binders are) and rare (since the binding must satisfy
Note [Core let-can-float invariant] in GHC.Core).


Note [Specialising Calls]
~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have a function with a complicated type:

    f :: forall a b c. Int -&gt; Eq a =&gt; Show b =&gt; c -&gt; Blah
    f @a @b @c i dEqA dShowA x = blah

and suppose it is called at:

    f 7 @T1 @T2 @T3 dEqT1 ($dfShow dShowT2) t3

This call is described as a 'CallInfo' whose 'ci_key' is:

    [ SpecType T1, SpecType T2, UnspecType, UnspecArg, SpecDict dEqT1
    , SpecDict ($dfShow dShowT2), UnspecArg ]

Why are 'a' and 'b' identified as 'SpecType', while 'c' is 'UnspecType'?
Because we must specialise the function on type variables that appear
free in its *dictionary* arguments; but not on type variables that do not
appear in any dictionaries, i.e. are fully polymorphic.

Because this call has dictionaries applied, we'd like to specialise
the call on any type argument that appears free in those dictionaries.
In this case, those are [a :-&gt; T1, b :-&gt; T2].

We also need to substitute the dictionary binders with their
specialised dictionaries. The simplest substitution would be
[dEqA :-&gt; dEqT1, dShowA :-&gt; $dfShow dShowT2], but this duplicates
work, since `$dfShow dShowT2` is a function application. Therefore, we
also want to *float the dictionary out* (via bindAuxiliaryDict),
creating a new dict binding

    dShow1 = $dfShow dShowT2

and the substitution [dEqA :-&gt; dEqT1, dShowA :-&gt; dShow1].

With the substitutions in hand, we can generate a specialised function:

    $sf :: forall c. Int -&gt; c -&gt; Blah
    $sf = SUBST[a :-&gt; T1, b :-&gt; T2, dEqA :-&gt; dEqT1, dShowA :-&gt; dShow1] (\@c i x -&gt; blah)

Note that the substitution is applied to the whole thing.  This is
convenient, but just slightly fragile.  Notably:
  * There had better be no name clashes in a/b/c

We must construct a rewrite rule:

    RULE &quot;SPEC f @T1 @T2 _&quot;
      forall (@c :: Type) (i :: Int) (d1 :: Eq T1) (d2 :: Show T2).
        f @T1 @T2 @c i d1 d2 = $sf @c i

In the rule, d1 and d2 are just wildcards, not used in the RHS.  Note
additionally that 'x' isn't captured by this rule --- we bind only
enough etas in order to capture all of the *specialised* arguments.

Note [Drop dead args from specialisations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When specialising a function, it&#8217;s possible some of the arguments may
actually be dead. For example, consider:

    f :: forall a. () -&gt; Show a =&gt; a -&gt; String
    f x y = show y ++ &quot;!&quot;

We might generate the following CallInfo for `f @Int`:

    [SpecType Int, UnspecArg, SpecDict $dShowInt, UnspecArg]

Normally we&#8217;d include both the x and y arguments in the
specialisation, since we&#8217;re not specialising on either of them. But
that&#8217;s silly, since x is actually unused! So we might as well drop it
in the specialisation:

    $sf :: Int -&gt; String
    $sf y = show y ++ &quot;!&quot;

    {-# RULE &quot;SPEC f @Int&quot; forall x. f @Int x $dShow = $sf #-}

This doesn&#8217;t save us much, since the arg would be removed later by
worker/wrapper, anyway, but it&#8217;s easy to do.

Wrinkles

* Note that we only drop dead arguments if:
    1. We don&#8217;t specialise on them.
    2. They come before an argument we do specialise on.
  Doing the latter would require eta-expanding the RULE, which could
  make it match less often, so it&#8217;s not worth it. Doing the former could
  be more useful --- it would stop us from generating pointless
  specialisations --- but it&#8217;s more involved to implement and unclear if
  it actually provides much benefit in practice.

* If the function has a stable unfolding, specHeader has to come up with
  arguments to pass to that stable unfolding, when building the stable
  unfolding of the specialised function: this is the last field in specHeader's
  big result tuple.

  The right thing to do is to produce a LitRubbish; it should rapidly
  disappear.  Rather like GHC.Core.Opt.WorkWrap.Utils.mk_absent_let.

Note [Specialisation modulo dictionary selectors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In #19644, we discovered that the ClassOp/DFun rules from
Note [ClassOp/DFun selection] inhibit transitive specialisation.
Example, inspired by T17966:

  class C a where
    m :: Show b =&gt; a -&gt; b -&gt; String
    dummy :: a -&gt; () -- Force a datatype dictionary representation

  instance C Int where
    m a b = show a ++ show b
    dummy _ = ()

  f :: (C a, Show b) =&gt; a -&gt; b -&gt; String
  f a b = m a b ++ &quot;!&quot;
  {-# INLINABLE[0] f #-}

  main = putStrLn (f (42::Int) (True::Bool))

Here, we specialise `f` at `Int` and `Bool`, giving

  $dC = $fCInt
  $dShow = GHC.Show.$fShowBool
  $sf (a::Int) (b::Bool) =
        ... (m @Int $dC @Bool $dShow a b) ...

Here `m` is just a DictSel, so there is (apparently) nothing to specialise!
However, the next Simplifier run will expose the rewritten instance method:

  ... $fCInt_$cm @Bool $fShowBool a b ...

where $fCInt_$cm is the instance method for `m` in `instance C Int`:

   $fCInt_$cm :: forall b. Show b =&gt; Int -&gt; b -&gt; String
   $fCInt_$cm b d x y = show @Int $dShowInt x ++ show @b d y

We want to specialise this! How? By doing the method-selection rewrite in
the Specialiser. Hence

1. In the App case of 'specExpr', try to apply the ClassOp/DFun rule on the
   head of the application, repeatedly, via 'fireRewriteRules'.
2. Attach an unfolding to freshly-bound dictionary ids such as `$dC` and
   `$dShow` in `bindAuxiliaryDict`, so that we can exploit the unfolding
   in 'fireRewriteRules' to do the ClassOp/DFun rewrite.

NB: Without (2), (1) would be pointless, because 'lookupRule' wouldn't be able
to look into the RHS of `$dC` to see the DFun.

Note [Zap occ info in rule binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we generate a specialisation RULE, we need to drop occurrence
info on the binders. If we don&#8217;t, things go wrong when we specialise a
function like

    f :: forall a. () -&gt; Show a =&gt; a -&gt; String
    f x y = show y ++ &quot;!&quot;

since we&#8217;ll generate a RULE like

    RULE &quot;SPEC f @Int&quot; forall x [Occ=Dead].
      f @Int x $dShow = $sf

and Core Lint complains, even though x only appears on the LHS (due to
Note [Drop dead args from specialisations]).

Why is that a Lint error? Because the arguments on the LHS of a rule
are syntactically expressions, not patterns, so Lint treats the
appearance of x as a use rather than a binding. Fortunately, the
solution is simple: we just make sure to zap the occ info before
using ids as wildcard binders in a rule.

Note [Account for casts in binding]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f :: Eq a =&gt; a -&gt; IO ()
   {-# INLINABLE f
       StableUnf = (/\a \(d:Eq a) (x:a). blah) |&gt; g
     #-}
   f = ...

In f's stable unfolding we have done some modest simplification which
has pushed the cast to the outside.  (I wonder if this is the Right
Thing, but it's what happens now; see GHC.Core.Opt.Simplify.Utils Note [Casts and
lambdas].)  Now that stable unfolding must be specialised, so we want
to push the cast back inside. It would be terrible if the cast
defeated specialisation!  Hence the use of collectBindersPushingCo.

Note [Evidence foralls]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose (#12212) that we are specialising
   f :: forall a b. (Num a, F a ~ F b) =&gt; blah
with a=b=Int. Then the RULE will be something like
   RULE forall (d:Num Int) (g :: F Int ~ F Int).
        f Int Int d g = f_spec
But both varToCoreExpr (when constructing the LHS args), and the
simplifier (when simplifying the LHS args), will transform to
   RULE forall (d:Num Int) (g :: F Int ~ F Int).
        f Int Int d &lt;F Int&gt; = f_spec
by replacing g with Refl.  So now 'g' is unbound, which results in a later
crash. So we use Refl right off the bat, and do not forall-quantify 'g':
 * varToCoreExpr generates a Refl
 * exprsFreeIdsList returns the Ids bound by the args,
   which won't include g

You might wonder if this will match as often, but the simplifier replaces
complicated Refl coercions with Refl pretty aggressively.

Note [Orphans and auto-generated rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we specialise an INLINABLE function, or when we have
-fspecialise-aggressively, we auto-generate RULES that are orphans.
We don't want to warn about these, or we'd generate a lot of warnings.
Thus, we only warn about user-specified orphan rules.

Indeed, we don't even treat the module as an orphan module if it has
auto-generated *rule* orphans.  Orphan modules are read every time we
compile, so they are pretty obtrusive and slow down every compilation,
even non-optimised ones.  (Reason: for type class instances it's a
type correctness issue.)  But specialisation rules are strictly for
*optimisation* only so it's fine not to read the interface.

What this means is that a SPEC rules from auto-specialisation in
module M will be used in other modules only if M.hi has been read for
some other reason, which is actually pretty likely.

Note [From non-recursive to recursive]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Even in the non-recursive case, if any dict-binds depend on 'fn' we might
have built a recursive knot

      f a d x = &lt;blah&gt;
      MkUD { ud_binds = NonRec d7  (MkD ..f..)
           , ud_calls = ...(f T d7)... }

The we generate

     Rec { fs x = &lt;blah&gt;[T/a, d7/d]
           f a d x = &lt;blah&gt;
               RULE f T _ = fs
           d7 = ...f... }

Here the recursion is only through the RULE.

However we definitely should /not/ make the Rec in this wildly common
case:
      d = ...
      MkUD { ud_binds = NonRec d7 (...d...)
           , ud_calls = ...(f T d7)... }

Here we want simply to add d to the floats, giving
      MkUD { ud_binds = NonRec d (...)
                        NonRec d7 (...d...)
           , ud_calls = ...(f T d7)... }

In general, we need only make this Rec if
  - there are some specialisations (spec_binds non-empty)
  - there are some dict_binds that depend on f (dump_dbs non-empty)

Note [Avoiding loops (DFuns)]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When specialising /dictionary functions/ we must be very careful to
avoid building loops. Here is an example that bit us badly, on
several distinct occasions.

Here is one: #3591
     class Eq a =&gt; C a
     instance Eq [a] =&gt; C [a]

This translates to
     dfun :: Eq [a] -&gt; C [a]
     dfun a d = MkD a d (meth d)

     d4 :: Eq [T] = &lt;blah&gt;
     d2 ::  C [T] = dfun T d4
     d1 :: Eq [T] = $p1 d2
     d3 ::  C [T] = dfun T d1

None of these definitions is recursive. What happened was that we
generated a specialisation:
     RULE forall d. dfun T d = dT  :: C [T]
     dT = (MkD a d (meth d)) [T/a, d1/d]
        = MkD T d1 (meth d1)

But now we use the RULE on the RHS of d2, to get
    d2 = dT = MkD d1 (meth d1)
    d1 = $p1 d2

and now d1 is bottom!  The problem is that when specialising 'dfun' we
should first dump &quot;below&quot; the binding all floated dictionary bindings
that mention 'dfun' itself.  So d2 and d3 (and hence d1) must be
placed below 'dfun', and thus unavailable to it when specialising
'dfun'.  That in turn means that the call (dfun T d1) must be
discarded.  On the other hand, the call (dfun T d4) is fine, assuming
d4 doesn't mention dfun.

Solution:
  Discard all calls that mention dictionaries that depend
  (directly or indirectly) on the dfun we are specialising.
  This is done by 'filterCalls'

Note [Avoiding loops (non-DFuns)]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The whole Note [Avoiding loops (DFuns)] things applies only to DFuns.
It's important /not/ to apply filterCalls to non-DFuns. For example:

  class C a where { foo,bar :: [a] -&gt; [a] }

  instance C Int where
     foo x = r_bar x
     bar xs = reverse xs

  r_bar :: C a =&gt; [a] -&gt; [a]
  r_bar xs = bar (xs ++ xs)

That translates to:

    r_bar a (c::C a) (xs::[a]) = bar a d (xs ++ xs)

    Rec { $fCInt :: C Int = MkC foo_help reverse
          foo_help (xs::[Int]) = r_bar Int $fCInt xs }

The call (r_bar $fCInt) mentions $fCInt,
                        which mentions foo_help,
                        which mentions r_bar

But we DO want to specialise r_bar at Int:
    Rec { $fCInt :: C Int = MkC foo_help reverse
          foo_help (xs::[Int]) = r_bar Int $fCInt xs

          r_bar a (c::C a) (xs::[a]) = bar a d (xs ++ xs)
            RULE r_bar Int _ = r_bar_Int

          r_bar_Int xs = bar Int $fCInt (xs ++ xs)
           }

Note that, because of its RULE, r_bar joins the recursive
group.  (In this case it'll unravel a short moment later.)
See test simplCore/should_compile/T19599a.

Another example is #19599, which looked like this:

   class (Show a, Enum a) =&gt; MyShow a where
      myShow :: a -&gt; String

   myShow_impl :: MyShow a =&gt; a -&gt; String

   foo :: Int -&gt; String
   foo = myShow_impl @Int $fMyShowInt

   Rec { $fMyShowInt = MkMyShowD $fEnumInt $fShowInt $cmyShow
       ; $cmyShow = myShow_impl @Int $fMyShowInt }

Here, we really do want to specialise `myShow_impl @Int $fMyShowInt`.


Note [Specialising a recursive group]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    let rec { f x = ...g x'...
            ; g y = ...f y'.... }
    in f 'a'
Here we specialise 'f' at Char; but that is very likely to lead to
a specialisation of 'g' at Char.  We must do the latter, else the
whole point of specialisation is lost.

But we do not want to keep iterating to a fixpoint, because in the
presence of polymorphic recursion we might generate an infinite number
of specialisations.

So we use the following heuristic:
  * Arrange the rec block in dependency order, so far as possible
    (the occurrence analyser already does this)

  * Specialise it much like a sequence of lets

  * Then go through the block a second time, feeding call-info from
    the RHSs back in the bottom, as it were

In effect, the ordering maxmimises the effectiveness of each sweep,
and we do just two sweeps.   This should catch almost every case of
monomorphic recursion -- the exception could be a very knotted-up
recursion with multiple cycles tied up together.

This plan is implemented in the Rec case of specBindItself.

Note [Specialisations already covered]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We obviously don't want to generate two specialisations for the same
argument pattern.  There are two wrinkles

1. We do the already-covered test in specDefn, not when we generate
the CallInfo in mkCallUDs.  We used to test in the latter place, but
we now iterate the specialiser somewhat, and the Id at the call site
might therefore not have all the RULES that we can see in specDefn

2. What about two specialisations where the second is an *instance*
of the first?  If the more specific one shows up first, we'll generate
specialisations for both.  If the *less* specific one shows up first,
we *don't* currently generate a specialisation for the more specific
one.  (See the call to lookupRule in already_covered.)  Reasons:
  (a) lookupRule doesn't say which matches are exact (bad reason)
  (b) if the earlier specialisation is user-provided, it's
      far from clear that we should auto-specialise further

Note [Auto-specialisation and RULES]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider:
   g :: Num a =&gt; a -&gt; a
   g = ...

   f :: (Int -&gt; Int) -&gt; Int
   f w = ...
   {-# RULE f g = 0 #-}

Suppose that auto-specialisation makes a specialised version of
g::Int-&gt;Int. That version won't appear in the LHS of the RULE for f.
So if the specialisation rule fires too early, the rule for f may
never fire.

It might be possible to add new rules, to &quot;complete&quot; the rewrite system.
Thus when adding
        RULE forall d. g Int d = g_spec
also add
        RULE f g_spec = 0

But that's a bit complicated.  For now we ask the programmer's help,
by *copying the INLINE activation pragma* to the auto-specialised
rule.  So if g says {-# NOINLINE[2] g #-}, then the auto-spec rule
will also not be active until phase 2.  And that's what programmers
should jolly well do anyway, even aside from specialisation, to ensure
that g doesn't inline too early.

This in turn means that the RULE would never fire for a NOINLINE
thing so not much point in generating a specialisation at all.

Note [Specialisation shape]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
We only specialise a function if it has visible top-level lambdas
corresponding to its overloading.  E.g. if
        f :: forall a. Eq a =&gt; ....
then its body must look like
        f = /\a. \d. ...

Reason: when specialising the body for a call (f ty dexp), we want to
substitute dexp for d, and pick up specialised calls in the body of f.

We do allow casts, however; see Note [Account for casts in binding].

This doesn't always work.  One example I came across was this:
        newtype Gen a = MkGen{ unGen :: Int -&gt; a }

        choose :: Eq a =&gt; a -&gt; Gen a
        choose n = MkGen (\r -&gt; n)

        oneof = choose (1::Int)

It's a silly example, but we get
        choose = /\a. g `cast` co
where choose doesn't have any dict arguments.  Thus far I have not
tried to fix this (wait till there's a real example).

Mind you, then 'choose' will be inlined (since RHS is trivial) so
it doesn't matter.  This comes up with single-method classes

   class C a where { op :: a -&gt; a }
   instance C a =&gt; C [a] where ....
==&gt;
   $fCList :: C a =&gt; C [a]
   $fCList = $copList |&gt; (...coercion&gt;...)
   ....(uses of $fCList at particular types)...

So we suppress the WARN if the rhs is trivial.

Note [Inline specialisations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here is what we do with the InlinePragma of the original function

  * Activation/RuleMatchInfo: both inherited from the original function

  * InlineSpec: inherit from original function

  * Unfolding: transfer a StableUnfolding iff it is UnfWhen
               See GHC.Core.Unfold.Make.specUnfolding
               and its Note [Specialising unfoldings]

InlineSpec: you might wonder why we specialise INLINE functions at all.
After all they should be inlined, right?  Two reasons:

 * Even INLINE functions are sometimes not inlined, when they aren't
   applied to interesting arguments.  But perhaps the type arguments
   alone are enough to specialise (even though the args are too boring
   to trigger inlining), and it's certainly better to call the
   specialised version.

 * The RHS of an INLINE function might call another overloaded function,
   and we'd like to generate a specialised version of that function too.
   This actually happens a lot. Consider
      replicateM_ :: (Monad m) =&gt; Int -&gt; m a -&gt; m ()
      {-# INLINABLE replicateM_ #-}
      replicateM_ d x ma = ...
   The strictness analyser may transform to
      replicateM_ :: (Monad m) =&gt; Int -&gt; m a -&gt; m ()
      {-# INLINE replicateM_ #-}
      replicateM_ d x ma = case x of I# x' -&gt; $wreplicateM_ d x' ma

      $wreplicateM_ :: (Monad m) =&gt; Int# -&gt; m a -&gt; m ()
      {-# INLINABLE $wreplicateM_ #-}
      $wreplicateM_ = ...
   Now an importing module has a specialised call to replicateM_, say
   (replicateM_ dMonadIO).  We certainly want to specialise $wreplicateM_!
   This particular example had a huge effect on the call to replicateM_
   in nofib/shootout/n-body.
-}</span><span>
</span><span id="line-2457"></span><span>
</span><span id="line-2458"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   SpecArg, and specHeader
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-2463"></span><span>
</span><span id="line-2464"></span><span class="hs-comment">-- | An argument that we might want to specialise.</span><span>
</span><span id="line-2465"></span><span class="hs-comment">-- See Note [Specialising Calls] for the nitty gritty details.</span><span>
</span><span id="line-2466"></span><span class="hs-keyword">data</span><span> </span><span id="SpecArg"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecArg"><span class="hs-identifier hs-var">SpecArg</span></a></span></span><span>
</span><span id="line-2467"></span><span>  </span><span class="hs-glyph">=</span><span>
</span><span id="line-2468"></span><span>    </span><span class="hs-comment">-- | Type arguments that should be specialised, due to appearing</span><span>
</span><span id="line-2469"></span><span>    </span><span class="hs-comment">-- free in the type of a 'SpecDict'.</span><span>
</span><span id="line-2470"></span><span>    </span><span id="SpecType"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecType"><span class="hs-identifier hs-var">SpecType</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-2471"></span><span>
</span><span id="line-2472"></span><span>    </span><span class="annot"><span class="hs-comment">-- | Type arguments that should remain polymorphic.</span></span><span>
</span><span id="line-2473"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="UnspecType"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UnspecType"><span class="hs-identifier hs-var">UnspecType</span></a></span></span><span>
</span><span id="line-2474"></span><span>
</span><span id="line-2475"></span><span>    </span><span class="hs-comment">-- | Dictionaries that should be specialised. mkCallUDs ensures</span><span>
</span><span id="line-2476"></span><span>    </span><span class="hs-comment">-- that only &quot;interesting&quot; dictionary arguments get a SpecDict;</span><span>
</span><span id="line-2477"></span><span>    </span><span class="hs-comment">-- see Note [Interesting dictionary arguments]</span><span>
</span><span id="line-2478"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="SpecDict"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecDict"><span class="hs-identifier hs-var">SpecDict</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictExpr"><span class="hs-identifier hs-type">DictExpr</span></a></span><span>
</span><span id="line-2479"></span><span>
</span><span id="line-2480"></span><span>    </span><span class="annot"><span class="hs-comment">-- | Value arguments that should not be specialised.</span></span><span>
</span><span id="line-2481"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="UnspecArg"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UnspecArg"><span class="hs-identifier hs-var">UnspecArg</span></a></span></span><span>
</span><span id="line-2482"></span><span>
</span><span id="line-2483"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecArg"><span class="hs-identifier hs-type">SpecArg</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2484"></span><span>  </span><span id="local-6989586621681903396"><span class="annot"><span class="annottext">ppr :: SpecArg -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecType"><span class="hs-identifier hs-type">SpecType</span></a></span><span> </span><span id="local-6989586621681903397"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903397"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SpecType&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903397"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-2485"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecType"><span class="hs-identifier hs-var">UnspecType</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;UnspecType&quot;</span></span><span>
</span><span id="line-2486"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecDict"><span class="hs-identifier hs-type">SpecDict</span></a></span><span> </span><span id="local-6989586621681903398"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903398"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SpecDict&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903398"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-2487"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecArg"><span class="hs-identifier hs-var">UnspecArg</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;UnspecArg&quot;</span></span><span>
</span><span id="line-2488"></span><span>
</span><span id="line-2489"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specArgFreeIds"><span class="hs-identifier hs-type">specArgFreeIds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecArg"><span class="hs-identifier hs-type">SpecArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a></span><span>
</span><span id="line-2490"></span><span id="specArgFreeIds"><span class="annot"><span class="annottext">specArgFreeIds :: SpecArg -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#specArgFreeIds"><span class="hs-identifier hs-var hs-var">specArgFreeIds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecType"><span class="hs-identifier hs-type">SpecType</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span>
</span><span id="line-2491"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specArgFreeIds"><span class="hs-identifier hs-var">specArgFreeIds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecDict"><span class="hs-identifier hs-type">SpecDict</span></a></span><span> </span><span id="local-6989586621681903402"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903402"><span class="hs-identifier hs-var">dx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeIds"><span class="hs-identifier hs-var">exprFreeIds</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903402"><span class="hs-identifier hs-var">dx</span></a></span><span>
</span><span id="line-2492"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specArgFreeIds"><span class="hs-identifier hs-var">specArgFreeIds</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecType"><span class="hs-identifier hs-var">UnspecType</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span>
</span><span id="line-2493"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specArgFreeIds"><span class="hs-identifier hs-var">specArgFreeIds</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecArg"><span class="hs-identifier hs-var">UnspecArg</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span>
</span><span id="line-2494"></span><span>
</span><span id="line-2495"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specArgFreeVars"><span class="hs-identifier hs-type">specArgFreeVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecArg"><span class="hs-identifier hs-type">SpecArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-2496"></span><span id="specArgFreeVars"><span class="annot"><span class="annottext">specArgFreeVars :: SpecArg -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#specArgFreeVars"><span class="hs-identifier hs-var hs-var">specArgFreeVars</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecType"><span class="hs-identifier hs-type">SpecType</span></a></span><span> </span><span id="local-6989586621681903405"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903405"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903405"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2497"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specArgFreeVars"><span class="hs-identifier hs-var">specArgFreeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecDict"><span class="hs-identifier hs-type">SpecDict</span></a></span><span> </span><span id="local-6989586621681903406"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903406"><span class="hs-identifier hs-var">dx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903406"><span class="hs-identifier hs-var">dx</span></a></span><span>
</span><span id="line-2498"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specArgFreeVars"><span class="hs-identifier hs-var">specArgFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecType"><span class="hs-identifier hs-var">UnspecType</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span>
</span><span id="line-2499"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specArgFreeVars"><span class="hs-identifier hs-var">specArgFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecArg"><span class="hs-identifier hs-var">UnspecArg</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span>
</span><span id="line-2500"></span><span>
</span><span id="line-2501"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#isSpecDict"><span class="hs-identifier hs-type">isSpecDict</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecArg"><span class="hs-identifier hs-type">SpecArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2502"></span><span id="isSpecDict"><span class="annot"><span class="annottext">isSpecDict :: SpecArg -&gt; Bool
</span><a href="GHC.Core.Opt.Specialise.html#isSpecDict"><span class="hs-identifier hs-var hs-var">isSpecDict</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecDict"><span class="hs-identifier hs-type">SpecDict</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2503"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#isSpecDict"><span class="hs-identifier hs-var">isSpecDict</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><span class="hs-identifier">_</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2504"></span><span>
</span><span id="line-2505"></span><span class="hs-comment">-- | Given binders from an original function 'f', and the 'SpecArg's</span><span>
</span><span id="line-2506"></span><span class="hs-comment">-- corresponding to its usage, compute everything necessary to build</span><span>
</span><span id="line-2507"></span><span class="hs-comment">-- a specialisation.</span><span>
</span><span id="line-2508"></span><span class="hs-comment">--</span><span>
</span><span id="line-2509"></span><span class="hs-comment">-- We will use the running example from Note [Specialising Calls]:</span><span>
</span><span id="line-2510"></span><span class="hs-comment">--</span><span>
</span><span id="line-2511"></span><span class="hs-comment">--     f :: forall a b c. Int -&gt; Eq a =&gt; Show b =&gt; c -&gt; Blah</span><span>
</span><span id="line-2512"></span><span class="hs-comment">--     f @a @b @c i dEqA dShowB x = blah</span><span>
</span><span id="line-2513"></span><span class="hs-comment">--</span><span>
</span><span id="line-2514"></span><span class="hs-comment">-- Suppose we decide to specialise it at the following pattern:</span><span>
</span><span id="line-2515"></span><span class="hs-comment">--</span><span>
</span><span id="line-2516"></span><span class="hs-comment">--     [ SpecType T1, SpecType T2, UnspecType, UnspecArg</span><span>
</span><span id="line-2517"></span><span class="hs-comment">--     , SpecDict dEqT1, SpecDict ($dfShow dShowT2), UnspecArg ]</span><span>
</span><span id="line-2518"></span><span class="hs-comment">--</span><span>
</span><span id="line-2519"></span><span class="hs-comment">-- We'd eventually like to build the RULE</span><span>
</span><span id="line-2520"></span><span class="hs-comment">--</span><span>
</span><span id="line-2521"></span><span class="hs-comment">--     RULE &quot;SPEC f @T1 @T2 _&quot;</span><span>
</span><span id="line-2522"></span><span class="hs-comment">--       forall (@c :: Type) (i :: Int) (d1 :: Eq T1) (d2 :: Show T2).</span><span>
</span><span id="line-2523"></span><span class="hs-comment">--         f @T1 @T2 @c i d1 d2 = $sf @c i</span><span>
</span><span id="line-2524"></span><span class="hs-comment">--</span><span>
</span><span id="line-2525"></span><span class="hs-comment">-- and the specialisation '$sf'</span><span>
</span><span id="line-2526"></span><span class="hs-comment">--</span><span>
</span><span id="line-2527"></span><span class="hs-comment">--     $sf :: forall c. Int -&gt; c -&gt; Blah</span><span>
</span><span id="line-2528"></span><span class="hs-comment">--     $sf = SUBST[a :-&gt; T1, b :-&gt; T2, dEqA :-&gt; dEqT1, dShowB :-&gt; dShow1] (\@c i x -&gt; blah)</span><span>
</span><span id="line-2529"></span><span class="hs-comment">--</span><span>
</span><span id="line-2530"></span><span class="hs-comment">-- where dShow1 is a floated binding created by bindAuxiliaryDict.</span><span>
</span><span id="line-2531"></span><span class="hs-comment">--</span><span>
</span><span id="line-2532"></span><span class="hs-comment">-- The cases for 'specHeader' below are presented in the same order as this</span><span>
</span><span id="line-2533"></span><span class="hs-comment">-- running example. The result of 'specHeader' for this example is as follows:</span><span>
</span><span id="line-2534"></span><span class="hs-comment">--</span><span>
</span><span id="line-2535"></span><span class="hs-comment">--    ( -- Returned arguments</span><span>
</span><span id="line-2536"></span><span class="hs-comment">--      env + [a :-&gt; T1, b :-&gt; T2, dEqA :-&gt; dEqT1, dShowB :-&gt; dShow1]</span><span>
</span><span id="line-2537"></span><span class="hs-comment">--    , [x]</span><span>
</span><span id="line-2538"></span><span class="hs-comment">--</span><span>
</span><span id="line-2539"></span><span class="hs-comment">--      -- RULE helpers</span><span>
</span><span id="line-2540"></span><span class="hs-comment">--    , [c, i, d1, d2]</span><span>
</span><span id="line-2541"></span><span class="hs-comment">--    , [T1, T2, c, i, d1, d2]</span><span>
</span><span id="line-2542"></span><span class="hs-comment">--</span><span>
</span><span id="line-2543"></span><span class="hs-comment">--      -- Specialised function helpers</span><span>
</span><span id="line-2544"></span><span class="hs-comment">--    , [c, i, x]</span><span>
</span><span id="line-2545"></span><span class="hs-comment">--    , [dShow1 = $dfShow dShowT2]</span><span>
</span><span id="line-2546"></span><span class="hs-comment">--    , [T1, T2, c, i, dEqT1, dShow1]</span><span>
</span><span id="line-2547"></span><span class="hs-comment">--    )</span><span>
</span><span id="line-2548"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specHeader"><span class="hs-identifier hs-type">specHeader</span></a></span><span>
</span><span id="line-2549"></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>
</span><span id="line-2550"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- The binders from the original function 'f'</span><span>
</span><span id="line-2551"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecArg"><span class="hs-identifier hs-type">SpecArg</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- From the CallInfo</span><span>
</span><span id="line-2552"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>     </span><span class="hs-comment">-- True &lt;=&gt; some useful specialisation happened</span><span>
</span><span id="line-2553"></span><span>                         </span><span class="hs-comment">-- Not the same as any (isSpecDict args) because</span><span>
</span><span id="line-2554"></span><span>                         </span><span class="hs-comment">-- the args might be longer than bndrs</span><span>
</span><span id="line-2555"></span><span>
</span><span id="line-2556"></span><span>                </span><span class="hs-comment">-- Returned arguments</span><span>
</span><span id="line-2557"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>      </span><span class="hs-comment">-- Substitution to apply to the body of 'f'</span><span>
</span><span id="line-2558"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Leftover binders from the original function 'f'</span><span>
</span><span id="line-2559"></span><span>                             </span><span class="hs-comment">--   that don&#8217;t have a corresponding SpecArg</span><span>
</span><span id="line-2560"></span><span>
</span><span id="line-2561"></span><span>                </span><span class="hs-comment">-- RULE helpers</span><span>
</span><span id="line-2562"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Binders for the RULE</span><span>
</span><span id="line-2563"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Args for the LHS of the rule</span><span>
</span><span id="line-2564"></span><span>
</span><span id="line-2565"></span><span>                </span><span class="hs-comment">-- Specialised function helpers</span><span>
</span><span id="line-2566"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Binders for $sf</span><span>
</span><span id="line-2567"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Auxiliary dictionary bindings</span><span>
</span><span id="line-2568"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Specialised arguments for unfolding</span><span>
</span><span id="line-2569"></span><span>                             </span><span class="hs-comment">-- Same length as &quot;Args for LHS of rule&quot;</span><span>
</span><span id="line-2570"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-2571"></span><span>
</span><span id="line-2572"></span><span class="hs-comment">-- We want to specialise on type 'T1', and so we must construct a substitution</span><span>
</span><span id="line-2573"></span><span class="hs-comment">-- 'a-&gt;T1', as well as a LHS argument for the resulting RULE and unfolding</span><span>
</span><span id="line-2574"></span><span class="hs-comment">-- details.</span><span>
</span><span id="line-2575"></span><span id="specHeader"><span class="annot"><span class="annottext">specHeader :: SpecEnv
-&gt; [Id]
-&gt; [SpecArg]
-&gt; SpecM
     (Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
</span><a href="GHC.Core.Opt.Specialise.html#specHeader"><span class="hs-identifier hs-var hs-var">specHeader</span></a></span></span><span> </span><span id="local-6989586621681903410"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903410"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903411"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903411"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681903412"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903412"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecType"><span class="hs-identifier hs-type">SpecType</span></a></span><span> </span><span id="local-6989586621681903413"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903413"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681903414"><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903414"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2576"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Find qvars, the type variables to add to the binders for the rule</span><span>
</span><span id="line-2577"></span><span>         </span><span class="hs-comment">-- Namely those free in `ty` that aren't in scope</span><span>
</span><span id="line-2578"></span><span>         </span><span class="hs-comment">-- See (MP2) in Note [Specialising polymorphic dictionaries]</span><span>
</span><span id="line-2579"></span><span>         </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681903415"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621681903415"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; InScopeSet
</span><a href="GHC.Core.TyCo.Subst.html#getSubstInScope"><span class="hs-identifier hs-var">Core.getSubstInScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903410"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2580"></span><span>             </span><span id="local-6989586621681903416"><span class="annot"><span class="annottext">qvars :: [Id]
</span><a href="#local-6989586621681903416"><span class="hs-identifier hs-var hs-var">qvars</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id]
</span><a href="GHC.Core.TyCo.FVs.html#scopedSort"><span class="hs-identifier hs-var">scopedSort</span></a></span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; [Id]) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2581"></span><span>                        </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; [Id]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; InScopeSet -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemInScopeSet"><span class="hs-operator hs-var">`elemInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681903415"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; [Id]) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2582"></span><span>                        </span><span class="annot"><span class="annottext">Kind -&gt; [Id]
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypeList"><span class="hs-identifier hs-var">tyCoVarsOfTypeList</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903413"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2583"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621681903420"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903420"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903421"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903421"><span class="hs-identifier hs-var">qvars'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; [Id] -&gt; (SpecEnv, [Id])
</span><a href="GHC.Core.Opt.Specialise.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903410"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903416"><span class="hs-identifier hs-var">qvars</span></a></span><span>
</span><span id="line-2584"></span><span>             </span><span id="local-6989586621681903422"><span class="annot"><span class="annottext">ty' :: Kind
</span><a href="#local-6989586621681903422"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Opt.Specialise.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903420"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903413"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2585"></span><span>             </span><span id="local-6989586621681903423"><span class="annot"><span class="annottext">env2 :: SpecEnv
</span><a href="#local-6989586621681903423"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Id -&gt; Kind -&gt; SpecEnv
</span><a href="GHC.Core.Opt.Specialise.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903420"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903411"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903422"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-2586"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903425"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903425"><span class="hs-identifier hs-var">useful</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903426"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903426"><span class="hs-identifier hs-var">env3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903427"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903427"><span class="hs-identifier hs-var">leftover_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903428"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903428"><span class="hs-identifier hs-var">rule_bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903429"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903429"><span class="hs-identifier hs-var">rule_es</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903430"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903430"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903431"><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903431"><span class="hs-identifier hs-var">dx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903432"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903432"><span class="hs-identifier hs-var">spec_args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2587"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; [Id]
-&gt; [SpecArg]
-&gt; SpecM
     (Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
</span><a href="GHC.Core.Opt.Specialise.html#specHeader"><span class="hs-identifier hs-var">specHeader</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903423"><span class="hs-identifier hs-var">env2</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903412"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903414"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2588"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
-&gt; SpecM
     (Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
forall a. a -&gt; UniqSM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903425"><span class="hs-identifier hs-var">useful</span></a></span><span>
</span><span id="line-2589"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903426"><span class="hs-identifier hs-var">env3</span></a></span><span>
</span><span id="line-2590"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903427"><span class="hs-identifier hs-var">leftover_bndrs</span></a></span><span>
</span><span id="line-2591"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903421"><span class="hs-identifier hs-var">qvars'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903428"><span class="hs-identifier hs-var">rule_bs</span></a></span><span>
</span><span id="line-2592"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; OutExpr
forall b. Kind -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903422"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; [OutExpr] -&gt; [OutExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903429"><span class="hs-identifier hs-var">rule_es</span></a></span><span>
</span><span id="line-2593"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903421"><span class="hs-identifier hs-var">qvars'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903430"><span class="hs-identifier hs-var">bs'</span></a></span><span>
</span><span id="line-2594"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903431"><span class="hs-identifier hs-var">dx</span></a></span><span>
</span><span id="line-2595"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; OutExpr
forall b. Kind -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903422"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; [OutExpr] -&gt; [OutExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903432"><span class="hs-identifier hs-var">spec_args</span></a></span><span>
</span><span id="line-2596"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-2597"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-2598"></span><span>
</span><span id="line-2599"></span><span class="hs-comment">-- Next we have a type that we don't want to specialise. We need to perform</span><span>
</span><span id="line-2600"></span><span class="hs-comment">-- a substitution on it (in case the type refers to 'a'). Additionally, we need</span><span>
</span><span id="line-2601"></span><span class="hs-comment">-- to produce a binder, LHS argument and RHS argument for the resulting rule,</span><span>
</span><span id="line-2602"></span><span class="hs-comment">-- /and/ a binder for the specialised body.</span><span>
</span><span id="line-2603"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specHeader"><span class="hs-identifier hs-var">specHeader</span></a></span><span> </span><span id="local-6989586621681903433"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903433"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903434"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903434"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681903435"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903435"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecType"><span class="hs-identifier hs-var">UnspecType</span></a></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681903436"><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903436"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2604"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903437"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903437"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903438"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903438"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Id -&gt; (SpecEnv, Id)
</span><a href="GHC.Core.Opt.Specialise.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903433"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903434"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2605"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903439"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903439"><span class="hs-identifier hs-var">useful</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903440"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903440"><span class="hs-identifier hs-var">env''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903441"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903441"><span class="hs-identifier hs-var">leftover_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903442"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903442"><span class="hs-identifier hs-var">rule_bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903443"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903443"><span class="hs-identifier hs-var">rule_es</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903444"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903444"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903445"><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903445"><span class="hs-identifier hs-var">dx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903446"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903446"><span class="hs-identifier hs-var">spec_args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2606"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; [Id]
-&gt; [SpecArg]
-&gt; SpecM
     (Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
</span><a href="GHC.Core.Opt.Specialise.html#specHeader"><span class="hs-identifier hs-var">specHeader</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903437"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903435"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903436"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2607"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
-&gt; SpecM
     (Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
forall a. a -&gt; UniqSM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903439"><span class="hs-identifier hs-var">useful</span></a></span><span>
</span><span id="line-2608"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903440"><span class="hs-identifier hs-var">env''</span></a></span><span>
</span><span id="line-2609"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903441"><span class="hs-identifier hs-var">leftover_bndrs</span></a></span><span>
</span><span id="line-2610"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903438"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903442"><span class="hs-identifier hs-var">rule_bs</span></a></span><span>
</span><span id="line-2611"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903438"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; [OutExpr] -&gt; [OutExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903443"><span class="hs-identifier hs-var">rule_es</span></a></span><span>
</span><span id="line-2612"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903438"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903444"><span class="hs-identifier hs-var">bs'</span></a></span><span>
</span><span id="line-2613"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903445"><span class="hs-identifier hs-var">dx</span></a></span><span>
</span><span id="line-2614"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903438"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; [OutExpr] -&gt; [OutExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903446"><span class="hs-identifier hs-var">spec_args</span></a></span><span>
</span><span id="line-2615"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-2616"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-2617"></span><span>
</span><span id="line-2618"></span><span class="hs-comment">-- Next we want to specialise the 'Eq a' dict away. We need to construct</span><span>
</span><span id="line-2619"></span><span class="hs-comment">-- a wildcard binder to match the dictionary (See Note [Specialising Calls] for</span><span>
</span><span id="line-2620"></span><span class="hs-comment">-- the nitty-gritty), as a LHS rule and unfolding details.</span><span>
</span><span id="line-2621"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specHeader"><span class="hs-identifier hs-var">specHeader</span></a></span><span> </span><span id="local-6989586621681903448"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903448"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903449"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903449"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681903450"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903450"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecDict"><span class="hs-identifier hs-type">SpecDict</span></a></span><span> </span><span id="local-6989586621681903451"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903451"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681903452"><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903452"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2622"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903449"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2623"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#allVarSet"><span class="hs-identifier hs-var">allVarSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; InScopeSet -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemInScopeSet"><span class="hs-operator hs-var">`elemInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681903454"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903451"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2624"></span><span>    </span><span class="hs-comment">-- See Note [Weird special case for SpecDict]</span><span>
</span><span id="line-2625"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903455"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903455"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903456"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903456"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Id -&gt; UniqSM (SpecEnv, Id)
</span><a href="GHC.Core.Opt.Specialise.html#newDictBndr"><span class="hs-identifier hs-var">newDictBndr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903448"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903449"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-comment">-- See Note [Zap occ info in rule binders]</span><span>
</span><span id="line-2626"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903458"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903458"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903459"><span class="annot"><span class="annottext">Maybe DictBind
</span><a href="#local-6989586621681903459"><span class="hs-identifier hs-var">dx_bind</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903460"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903460"><span class="hs-identifier hs-var">spec_dict</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; Id -&gt; Id -&gt; OutExpr -&gt; (SpecEnv, Maybe DictBind, OutExpr)
</span><a href="GHC.Core.Opt.Specialise.html#bindAuxiliaryDict"><span class="hs-identifier hs-var">bindAuxiliaryDict</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903455"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903449"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903456"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903451"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-2627"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903462"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903462"><span class="hs-identifier hs-var">env3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903463"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903463"><span class="hs-identifier hs-var">leftover_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903464"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903464"><span class="hs-identifier hs-var">rule_bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903465"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903465"><span class="hs-identifier hs-var">rule_es</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903466"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903466"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903467"><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903467"><span class="hs-identifier hs-var">dx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903468"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903468"><span class="hs-identifier hs-var">spec_args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2628"></span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; [Id]
-&gt; [SpecArg]
-&gt; SpecM
     (Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
</span><a href="GHC.Core.Opt.Specialise.html#specHeader"><span class="hs-identifier hs-var">specHeader</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903458"><span class="hs-identifier hs-var">env2</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903450"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903452"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2629"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
-&gt; SpecM
     (Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
forall a. a -&gt; UniqSM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>      </span><span class="hs-comment">-- Ha!  A useful specialisation!</span><span>
</span><span id="line-2630"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903462"><span class="hs-identifier hs-var">env3</span></a></span><span>
</span><span id="line-2631"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903463"><span class="hs-identifier hs-var">leftover_bndrs</span></a></span><span>
</span><span id="line-2632"></span><span>              </span><span class="hs-comment">-- See Note [Evidence foralls]</span><span>
</span><span id="line-2633"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; [Id]
</span><a href="GHC.Core.FVs.html#exprFreeIdsList"><span class="hs-identifier hs-var">exprFreeIdsList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903456"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903464"><span class="hs-identifier hs-var">rule_bs</span></a></span><span>
</span><span id="line-2634"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903456"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; [OutExpr] -&gt; [OutExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903465"><span class="hs-identifier hs-var">rule_es</span></a></span><span>
</span><span id="line-2635"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903466"><span class="hs-identifier hs-var">bs'</span></a></span><span>
</span><span id="line-2636"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe DictBind -&gt; [DictBind]
forall a. Maybe a -&gt; [a]
</span><a href="../../base-4.18.2.1/src/Data.Maybe.html#maybeToList/Data.Maybe.html#maybeToList"><span class="hs-identifier hs-var">maybeToList</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DictBind
</span><a href="#local-6989586621681903459"><span class="hs-identifier hs-var">dx_bind</span></a></span><span> </span><span class="annot"><span class="annottext">[DictBind] -&gt; [DictBind] -&gt; [DictBind]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903467"><span class="hs-identifier hs-var">dx</span></a></span><span>
</span><span id="line-2637"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903460"><span class="hs-identifier hs-var">spec_dict</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; [OutExpr] -&gt; [OutExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903468"><span class="hs-identifier hs-var">spec_args</span></a></span><span>
</span><span id="line-2638"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-2639"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-2640"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-2641"></span><span>     </span><span id="local-6989586621681903454"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621681903454"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; InScopeSet
</span><a href="GHC.Core.TyCo.Subst.html#getSubstInScope"><span class="hs-identifier hs-var">Core.getSubstInScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903448"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2642"></span><span>
</span><span id="line-2643"></span><span class="hs-comment">-- Finally, we don't want to specialise on this argument 'i':</span><span>
</span><span id="line-2644"></span><span class="hs-comment">--   - It's an UnSpecArg, or</span><span>
</span><span id="line-2645"></span><span class="hs-comment">--   - It's a dead dictionary</span><span>
</span><span id="line-2646"></span><span class="hs-comment">-- We need to produce a binder, LHS and RHS argument for the RULE, and</span><span>
</span><span id="line-2647"></span><span class="hs-comment">-- a binder for the specialised body.</span><span>
</span><span id="line-2648"></span><span class="hs-comment">--</span><span>
</span><span id="line-2649"></span><span class="hs-comment">-- NB: Calls to 'specHeader' will trim off any trailing 'UnspecArg's, which is</span><span>
</span><span id="line-2650"></span><span class="hs-comment">-- why 'i' doesn't appear in our RULE above. But we have no guarantee that</span><span>
</span><span id="line-2651"></span><span class="hs-comment">-- there aren't 'UnspecArg's which come /before/ all of the dictionaries, so</span><span>
</span><span id="line-2652"></span><span class="hs-comment">-- this case must be here.</span><span>
</span><span id="line-2653"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specHeader"><span class="hs-identifier hs-var">specHeader</span></a></span><span> </span><span id="local-6989586621681903470"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903470"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903471"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903471"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681903472"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903472"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecArg
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681903473"><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903473"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2654"></span><span>    </span><span class="hs-comment">-- The &quot;_&quot; can be UnSpecArg, or SpecDict where the bndr is dead</span><span>
</span><span id="line-2655"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- see Note [Zap occ info in rule binders]</span><span>
</span><span id="line-2656"></span><span>         </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903474"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903474"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903475"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903475"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Id -&gt; (SpecEnv, Id)
</span><a href="GHC.Core.Opt.Specialise.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903470"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="GHC.Types.Id.html#zapIdOccInfo"><span class="hs-identifier hs-var">zapIdOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903471"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2657"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903477"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903477"><span class="hs-identifier hs-var">useful</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903478"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903478"><span class="hs-identifier hs-var">env''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903479"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903479"><span class="hs-identifier hs-var">leftover_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903480"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903480"><span class="hs-identifier hs-var">rule_bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903481"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903481"><span class="hs-identifier hs-var">rule_es</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903482"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903482"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903483"><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903483"><span class="hs-identifier hs-var">dx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903484"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903484"><span class="hs-identifier hs-var">spec_args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2658"></span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SpecEnv
-&gt; [Id]
-&gt; [SpecArg]
-&gt; SpecM
     (Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
</span><a href="GHC.Core.Opt.Specialise.html#specHeader"><span class="hs-identifier hs-var">specHeader</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903474"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903472"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903473"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-2659"></span><span>
</span><span id="line-2660"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681903485"><span class="annot"><span class="annottext">bndr_ty :: Kind
</span><a href="#local-6989586621681903485"><span class="hs-identifier hs-var hs-var">bndr_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903475"><span class="hs-identifier hs-var">bndr'</span></a></span><span>
</span><span id="line-2661"></span><span>
</span><span id="line-2662"></span><span>             </span><span class="hs-comment">-- See Note [Drop dead args from specialisations]</span><span>
</span><span id="line-2663"></span><span>             </span><span class="hs-comment">-- C.f. GHC.Core.Opt.WorkWrap.Utils.mk_absent_let</span><span>
</span><span id="line-2664"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621681903486"><span class="annot"><span class="annottext">Maybe Id
</span><a href="#local-6989586621681903486"><span class="hs-identifier hs-var">mb_spec_bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903487"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903487"><span class="hs-identifier hs-var">spec_arg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2665"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903471"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2666"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681903488"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903488"><span class="hs-identifier hs-var">lit_expr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; Maybe OutExpr
</span><a href="GHC.Core.Make.html#mkLitRubbish"><span class="hs-identifier hs-var">mkLitRubbish</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903485"><span class="hs-identifier hs-var">bndr_ty</span></a></span><span>
</span><span id="line-2667"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Id
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903488"><span class="hs-identifier hs-var">lit_expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2668"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2669"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Maybe Id
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903475"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903475"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2670"></span><span>
</span><span id="line-2671"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
-&gt; SpecM
     (Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
forall a. a -&gt; UniqSM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903477"><span class="hs-identifier hs-var">useful</span></a></span><span>
</span><span id="line-2672"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903478"><span class="hs-identifier hs-var">env''</span></a></span><span>
</span><span id="line-2673"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903479"><span class="hs-identifier hs-var">leftover_bndrs</span></a></span><span>
</span><span id="line-2674"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903475"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903480"><span class="hs-identifier hs-var">rule_bs</span></a></span><span>
</span><span id="line-2675"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903475"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; [OutExpr] -&gt; [OutExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903481"><span class="hs-identifier hs-var">rule_es</span></a></span><span>
</span><span id="line-2676"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Id
</span><a href="#local-6989586621681903486"><span class="hs-identifier hs-var">mb_spec_bndr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2677"></span><span>                  </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681903489"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903489"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903489"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903482"><span class="hs-identifier hs-var">bs'</span></a></span><span>
</span><span id="line-2678"></span><span>                  </span><span class="annot"><span class="annottext">Maybe Id
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903482"><span class="hs-identifier hs-var">bs'</span></a></span><span>
</span><span id="line-2679"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903483"><span class="hs-identifier hs-var">dx</span></a></span><span>
</span><span id="line-2680"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903487"><span class="hs-identifier hs-var">spec_arg</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; [OutExpr] -&gt; [OutExpr]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903484"><span class="hs-identifier hs-var">spec_args</span></a></span><span>
</span><span id="line-2681"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-2682"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-2683"></span><span>
</span><span id="line-2684"></span><span class="hs-comment">-- If we run out of binders, stop immediately</span><span>
</span><span id="line-2685"></span><span class="hs-comment">-- See Note [Specialisation Must Preserve Sharing]</span><span>
</span><span id="line-2686"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specHeader"><span class="hs-identifier hs-var">specHeader</span></a></span><span> </span><span id="local-6989586621681903490"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903490"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
-&gt; SpecM
     (Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
forall a. a -&gt; UniqSM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903490"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2687"></span><span>
</span><span id="line-2688"></span><span class="hs-comment">-- Return all remaining binders from the original function. These have the</span><span>
</span><span id="line-2689"></span><span class="hs-comment">-- invariant that they should all correspond to unspecialised arguments, so</span><span>
</span><span id="line-2690"></span><span class="hs-comment">-- it's safe to stop processing at this point.</span><span>
</span><span id="line-2691"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#specHeader"><span class="hs-identifier hs-var">specHeader</span></a></span><span> </span><span id="local-6989586621681903491"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903491"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903492"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903492"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2692"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
-&gt; SpecM
     (Bool, SpecEnv, [Id], [Id], [OutExpr], [Id], [DictBind], [OutExpr])
forall a. a -&gt; UniqSM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903493"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903494"><span class="hs-identifier hs-var">bndrs'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2693"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2694"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681903493"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903493"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903494"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903494"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; [Id] -&gt; (SpecEnv, [Id])
</span><a href="GHC.Core.Opt.Specialise.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903491"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903492"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-2695"></span><span>
</span><span id="line-2696"></span><span>
</span><span id="line-2697"></span><span class="annot"><span class="hs-comment">-- | Binds a dictionary argument to a fresh name, to preserve sharing</span></span><span>
</span><span id="line-2698"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#bindAuxiliaryDict"><span class="hs-identifier hs-type">bindAuxiliaryDict</span></a></span><span>
</span><span id="line-2699"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>
</span><span id="line-2700"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-comment">-- Original dict binder, and the witnessing expression</span><span>
</span><span id="line-2701"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>        </span><span class="hs-comment">-- Substitutes for orig_dict_id</span><span>
</span><span id="line-2702"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span> </span><span class="hs-comment">-- Auxiliary dict binding, if any</span><span>
</span><span id="line-2703"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Witnessing expression (always trivial)</span><span>
</span><span id="line-2704"></span><span id="bindAuxiliaryDict"><span class="annot"><span class="annottext">bindAuxiliaryDict :: SpecEnv
-&gt; Id -&gt; Id -&gt; OutExpr -&gt; (SpecEnv, Maybe DictBind, OutExpr)
</span><a href="GHC.Core.Opt.Specialise.html#bindAuxiliaryDict"><span class="hs-identifier hs-var hs-var">bindAuxiliaryDict</span></a></span></span><span> </span><span id="local-6989586621681903495"><span class="annot"><span class="annottext">env :: SpecEnv
</span><a href="#local-6989586621681903495"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SE"><span class="hs-identifier hs-type">SE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">se_subst :: SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903496"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903496"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2705"></span><span>                  </span><span id="local-6989586621681903497"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903497"><span class="hs-identifier hs-var">orig_dict_id</span></a></span></span><span> </span><span id="local-6989586621681903498"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903498"><span class="hs-identifier hs-var">fresh_dict_id</span></a></span></span><span> </span><span id="local-6989586621681903499"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903499"><span class="hs-identifier hs-var">dict_expr</span></a></span></span><span>
</span><span id="line-2706"></span><span>
</span><span id="line-2707"></span><span>  </span><span class="hs-comment">-- If the dictionary argument is trivial,</span><span>
</span><span id="line-2708"></span><span>  </span><span class="hs-comment">-- don&#8217;t bother creating a new dict binding; just substitute</span><span>
</span><span id="line-2709"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903499"><span class="hs-identifier hs-var">dict_expr</span></a></span><span>
</span><span id="line-2710"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681903500"><span class="annot"><span class="annottext">env' :: SpecEnv
</span><a href="#local-6989586621681903500"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903495"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#extendSubst"><span class="hs-identifier hs-type">Core.extendSubst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903496"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903497"><span class="hs-identifier hs-type">orig_dict_id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903499"><span class="hs-identifier hs-type">dict_expr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2711"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">-- pprTrace &quot;bindAuxiliaryDict:trivial&quot; (ppr orig_dict_id &lt;+&gt; ppr dict_id) $</span><span>
</span><span id="line-2712"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903500"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe DictBind
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903499"><span class="hs-identifier hs-var">dict_expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2713"></span><span>
</span><span id="line-2714"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>  </span><span class="hs-comment">-- Non-trivial dictionary arg; make an auxiliary binding</span><span>
</span><span id="line-2715"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681903502"><span class="annot"><span class="annottext">fresh_dict_id' :: Id
</span><a href="#local-6989586621681903502"><span class="hs-identifier hs-var hs-var">fresh_dict_id'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903498"><span class="hs-identifier hs-var">fresh_dict_id</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr -&gt; Id
</span><a href="GHC.Core.Opt.Specialise.html#addDictUnfolding"><span class="hs-operator hs-var">`addDictUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903499"><span class="hs-identifier hs-var">dict_expr</span></a></span><span>
</span><span id="line-2716"></span><span>
</span><span id="line-2717"></span><span>        </span><span id="local-6989586621681903503"><span class="annot"><span class="annottext">dict_bind :: DictBind
</span><a href="#local-6989586621681903503"><span class="hs-identifier hs-var hs-var">dict_bind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InBind -&gt; DictBind
</span><a href="GHC.Core.Opt.Specialise.html#mkDB"><span class="hs-identifier hs-var">mkDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OutExpr -&gt; InBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903502"><span class="hs-identifier hs-var">fresh_dict_id'</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903499"><span class="hs-identifier hs-var">dict_expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2718"></span><span>        </span><span id="local-6989586621681903504"><span class="annot"><span class="annottext">env' :: SpecEnv
</span><a href="#local-6989586621681903504"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903495"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#extendSubst"><span class="hs-identifier hs-type">Core.extendSubst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903496"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903497"><span class="hs-identifier hs-type">orig_dict_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903502"><span class="hs-identifier hs-type">fresh_dict_id'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2719"></span><span>                                </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendSubstInScope"><span class="hs-operator hs-type">`Core.extendSubstInScope`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903502"><span class="hs-identifier hs-type">fresh_dict_id'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2720"></span><span>                                </span><span class="hs-comment">-- Ensure the new unfolding is in the in-scope set</span><span>
</span><span id="line-2721"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">-- pprTrace &quot;bindAuxiliaryDict:non-trivial&quot; (ppr orig_dict_id &lt;+&gt; ppr fresh_dict_id') $</span><span>
</span><span id="line-2722"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903504"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DictBind -&gt; Maybe DictBind
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind
</span><a href="#local-6989586621681903503"><span class="hs-identifier hs-var">dict_bind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; OutExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903502"><span class="hs-identifier hs-var">fresh_dict_id'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2723"></span><span>
</span><span id="line-2724"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#addDictUnfolding"><span class="hs-identifier hs-type">addDictUnfolding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-2725"></span><span class="hs-comment">-- Add unfolding for freshly-bound Ids: see Note [Make the new dictionaries interesting]</span><span>
</span><span id="line-2726"></span><span class="hs-comment">-- and Note [Specialisation modulo dictionary selectors]</span><span>
</span><span id="line-2727"></span><span id="addDictUnfolding"><span class="annot"><span class="annottext">addDictUnfolding :: Id -&gt; OutExpr -&gt; Id
</span><a href="GHC.Core.Opt.Specialise.html#addDictUnfolding"><span class="hs-identifier hs-var hs-var">addDictUnfolding</span></a></span></span><span> </span><span id="local-6989586621681903506"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903506"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681903507"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903507"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2728"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903506"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unfolding -&gt; Id
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; OutExpr -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkSimpleUnfolding"><span class="hs-identifier hs-var">mkSimpleUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="GHC.Core.Unfold.html#defaultUnfoldingOpts"><span class="hs-identifier hs-var">defaultUnfoldingOpts</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903507"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2729"></span><span>
</span><span id="line-2730"></span><span class="hs-comment">{-
Note [Make the new dictionaries interesting]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Important!  We're going to substitute dx_id1 for d
and we want it to look &quot;interesting&quot;, else we won't gather *any*
consequential calls. E.g.
    f d = ...g d....
If we specialise f for a call (f (dfun dNumInt)), we'll get
a consequent call (g d') with an auxiliary definition
    d' = df dNumInt
We want that consequent call to look interesting; so we add an unfolding
in the dictionary Id.
-}</span><span>
</span><span id="line-2743"></span><span>
</span><span id="line-2744"></span><span>
</span><span id="line-2745"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
            UsageDetails and suchlike
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-2750"></span><span>
</span><span id="line-2751"></span><span class="hs-keyword">data</span><span> </span><span id="UsageDetails"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-var">UsageDetails</span></a></span></span><span>
</span><span id="line-2752"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="MkUD"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="ud_binds"><span class="annot"><span class="annottext">UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var hs-var">ud_binds</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span>
</span><span id="line-2753"></span><span>         </span><span class="hs-special">,</span><span> </span><span id="ud_calls"><span class="annot"><span class="annottext">UsageDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var hs-var">ud_calls</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2754"></span><span>    </span><span class="hs-comment">-- INVARIANT: suppose bs = fdb_bndrs ud_binds</span><span>
</span><span id="line-2755"></span><span>    </span><span class="hs-comment">-- Then 'calls' may *mention* 'bs',</span><span>
</span><span id="line-2756"></span><span>    </span><span class="hs-comment">-- but there should be no calls *for* bs</span><span>
</span><span id="line-2757"></span><span>
</span><span id="line-2758"></span><span class="hs-keyword">data</span><span> </span><span id="FloatedDictBinds"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-var">FloatedDictBinds</span></a></span></span><span>  </span><span class="hs-comment">-- See Note [Floated dictionary bindings]</span><span>
</span><span id="line-2759"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="FDB"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-var">FDB</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="fdb_binds"><span class="annot"><span class="annottext">FloatedDictBinds -&gt; OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var hs-var">fdb_binds</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2760"></span><span>               </span><span class="hs-comment">-- The order is important;</span><span>
</span><span id="line-2761"></span><span>               </span><span class="hs-comment">-- in ds1 `appOL` ds2, bindings in ds2 can depend on those in ds1</span><span>
</span><span id="line-2762"></span><span>
</span><span id="line-2763"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="fdb_bndrs"><span class="annot"><span class="annottext">FloatedDictBinds -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var hs-var">fdb_bndrs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Types.Var.Set.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a></span><span>
</span><span id="line-2764"></span><span>    </span><span class="hs-special">}</span><span>          </span><span class="hs-comment">-- ^ The binders of 'fdb_binds'.</span><span>
</span><span id="line-2765"></span><span>               </span><span class="hs-comment">-- Caches a superset of the expression</span><span>
</span><span id="line-2766"></span><span>               </span><span class="hs-comment">--   `mkVarSet (bindersOfDictBinds fdb_binds))`</span><span>
</span><span id="line-2767"></span><span>               </span><span class="hs-comment">-- for later addition to an InScopeSet</span><span>
</span><span id="line-2768"></span><span>
</span><span id="line-2769"></span><span class="hs-comment">-- | A 'DictBind' is a binding along with a cached set containing its free</span><span>
</span><span id="line-2770"></span><span class="hs-comment">-- variables (both type variables and dictionaries). We need this set</span><span>
</span><span id="line-2771"></span><span class="hs-comment">-- in splitDictBinds, when filtering bindings to decide which are</span><span>
</span><span id="line-2772"></span><span class="hs-comment">-- captured by a binder</span><span>
</span><span id="line-2773"></span><span class="hs-keyword">data</span><span> </span><span id="DictBind"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-var">DictBind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DB"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DB"><span class="hs-identifier hs-var">DB</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="db_bind"><span class="annot"><span class="annottext">DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var hs-var">db_bind</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">,</span><span> </span><span id="db_fvs"><span class="annot"><span class="annottext">DictBind -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#db_fvs"><span class="hs-identifier hs-var hs-var">db_fvs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2774"></span><span>
</span><span id="line-2775"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#bindersOfDictBind"><span class="hs-identifier hs-type">bindersOfDictBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2776"></span><span id="bindersOfDictBind"><span class="annot"><span class="annottext">bindersOfDictBind :: DictBind -&gt; [Id]
</span><a href="GHC.Core.Opt.Specialise.html#bindersOfDictBind"><span class="hs-identifier hs-var hs-var">bindersOfDictBind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InBind -&gt; [Id]
forall b. Bind b -&gt; [b]
</span><a href="GHC.Core.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a></span><span> </span><span class="annot"><span class="annottext">(InBind -&gt; [Id]) -&gt; (DictBind -&gt; InBind) -&gt; DictBind -&gt; [Id]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span>
</span><span id="line-2777"></span><span>
</span><span id="line-2778"></span><span id="local-6989586621681902407"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#bindersOfDictBinds"><span class="hs-identifier hs-type">bindersOfDictBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Foldable.html#Foldable/Data.Foldable.html#Foldable"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681902407"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681902407"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-2779"></span><span id="bindersOfDictBinds"><span class="annot"><span class="annottext">bindersOfDictBinds :: forall (f :: * -&gt; *). Foldable f =&gt; f DictBind -&gt; [Id]
</span><a href="GHC.Core.Opt.Specialise.html#bindersOfDictBinds"><span class="hs-identifier hs-var hs-var">bindersOfDictBinds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; [Id]
forall b. [Bind b] -&gt; [b]
</span><a href="GHC.Core.html#bindersOfBinds"><span class="hs-identifier hs-var">bindersOfBinds</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreProgram -&gt; [Id])
-&gt; (f DictBind -&gt; CoreProgram) -&gt; f DictBind -&gt; [Id]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(DictBind -&gt; CoreProgram -&gt; CoreProgram)
-&gt; CoreProgram -&gt; f DictBind -&gt; CoreProgram
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; f a -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InBind -&gt; CoreProgram -&gt; CoreProgram)
-&gt; (DictBind -&gt; InBind) -&gt; DictBind -&gt; CoreProgram -&gt; CoreProgram
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2780"></span><span>
</span><span id="line-2781"></span><span class="hs-comment">{- Note [Floated dictionary bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We float out dictionary bindings for the reasons described under
&quot;Dictionary floating&quot; above.  But not /just/ dictionary bindings.
Consider

   f :: Eq a =&gt; blah
   f a d = rhs

   $c== :: T -&gt; T -&gt; Bool
   $c== x y = ...

   $df :: Eq T
   $df = Eq $c== ...

   gurgle = ...(f @T $df)...

We gather the call info for (f @T $df), and we don't want to drop it
when we come across the binding for $df.  So we add $df to the floats
and continue.  But then we have to add $c== to the floats, and so on.
These all float above the binding for 'f', and now we can
successfully specialise 'f'.

So the DictBinds in (ud_binds :: OrdList DictBind) may contain
non-dictionary bindings too.

Note [Specialising polymorphic dictionaries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Note June 2023: This has proved to be quite a tricky optimisation to get right
see (#23469, #23109, #21229, #23445) so it is now guarded by a flag
`-fpolymorphic-specialisation`.


Consider
    class M a where { foo :: a -&gt; Int }

    instance M (ST s) where ...
    -- dMST :: forall s. M (ST s)

    wimwam :: forall a. M a =&gt; a -&gt; Int
    wimwam = /\a \(d::M a). body

    f :: ST s -&gt; Int
    f = /\s \(x::ST s). wimwam @(ST s) (dMST @s) dx + 1

We'd like to specialise wimwam at (ST s), thus
    $swimwam :: forall s. ST s -&gt; Int
    $swimwam = /\s. body[ST s/a, (dMST @s)/d]

    RULE forall s (d :: M (ST s)).
         wimwam @(ST s) d = $swimwam @s

Here are the moving parts:

(MP1) We must /not/ dump the CallInfo
        CIS wimwam (CI { ci_key = [@(ST s), dMST @s]
                       , ci_fvs = {dMST} })
      when we come to the /\s.  Instead, we simply let it continue to float
      upwards. Hence ci_fvs is an IdSet, listing the /Ids/ that
      are free in the call, but not the /TyVars/.  Hence using specArgFreeIds
      in singleCall.

  NB to be fully kosher we should explicitly quantifying the CallInfo
  over 's', but we don't bother.  This would matter if there was an
  enclosing binding of the same 's', which I don't expect to happen.

(MP2) When we come to specialise the call, we must remember to quantify
      over 's'.  That is done in the SpecType case of specHeader, where
      we add 's' (called qvars) to the binders of the RULE and the specialised
      function.

(MP3) If we have f :: forall m. Monoid m =&gt; blah, and two calls
        (f @(Endo b)      (d :: Monoid (Endo b))
        (f @(Endo (c-&gt;c)) (d :: Monoid (Endo (c-&gt;c)))
      we want to generate a specialisation only for the first.  The second
      is just a substitution instance of the first, with no greater specialisation.
      Hence the call to `remove_dups` in `filterCalls`.

All this arose in #13873, in the unexpected form that a SPECIALISE
pragma made the program slower!  The reason was that the specialised
function $sinsertWith arising from the pragma looked rather like `f`
above, and failed to specialise a call in its body like wimwam.
Without the pragma, the original call to `insertWith` was completely
monomorpic, and specialised in one go.

Wrinkles.

* See Note [Weird special case for SpecDict]

* With -XOverlappingInstances you might worry about this:
    class C a where ...
    instance C (Maybe Int) where ...   -- $df1 :: C (Maybe Int)
    instance C (Maybe a)   where ...   -- $df2 :: forall a. C (Maybe a)

    f :: C a =&gt; blah
    f = rhs

    g = /\a.  ...(f @(Maybe a) ($df2 a))...
    h = ...f @(Maybe Int) $df1

  There are two calls to f, but with different evidence.  This patch will
  combine them into one.  But it's OK: this code will never arise unless you
  use -XIncoherentInstances.  Even with -XOverlappingInstances, GHC tries hard
  to keep dictionaries as singleton types.  But that goes out of the window
  with -XIncoherentInstances -- and that is true even with ordianry type-class
  specialisation (at least if any inlining has taken place).

  GHC makes very few guarantees when you use -XIncoherentInstances, and its
  not worth crippling the normal case for the incoherent corner.  (The best
  thing might be to switch off specialisation altogether if incoherence is
  involved... but incoherence is a property of an instance, not a class, so
  it's a hard test to make.)

  But see Note [Specialisation and overlapping instances].

Note [Weird special case for SpecDict]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we are trying to specialise for this this call:
   $wsplit @T (mkD @k @(a::k) :: C T)
where
   mkD :: forall k (a::k). C T
is a top-level dictionary-former.  This actually happened in #22459,
because of (MP1) of Note [Specialising polymorphic dictionaries].

How can we speicalise $wsplit?  We might try

   RULE &quot;SPEC&quot; forall (d :: C T). $wsplit @T d = $s$wsplit

but then in the body of $s$wsplit what will we use for the dictionary
evidence?  We can't use (mkD @k @(a::k)) because k and a aren't in scope.
We could zap `k` to (Any @Type) and `a` to (Any @(Any @Type)), but that
is a lot of hard work for a very strange case.

So we simply refrain from specialising in this case; hence the guard
   allVarSet (`elemInScopeSet` in_scope) (exprFreeVars d)
in the SpecDict cased of specHeader.

How did this strange polymorphic mkD arise in the first place?
From GHC.Core.Opt.Utils.abstractFloats, which was abstracting
over too many type variables. But that too is now fixed;
see Note [Which type variables to abstract over] in that module.
-}</span><span>
</span><span id="line-2924"></span><span>
</span><span id="line-2925"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2926"></span><span>  </span><span id="local-6989586621681903529"><span class="annot"><span class="annottext">ppr :: DictBind -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">db_bind :: DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903530"><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903530"><span class="hs-identifier hs-var">bind</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">db_fvs :: DictBind -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#db_fvs"><span class="hs-identifier hs-var">db_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903531"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903531"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2927"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;DB&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fvs: &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903531"><span class="hs-identifier hs-var">fvs</span></a></span><span>
</span><span id="line-2928"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bind:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">InBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903530"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2929"></span><span>
</span><span id="line-2930"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2931"></span><span>  </span><span id="local-6989586621681903554"><span class="annot"><span class="annottext">ppr :: UsageDetails -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_binds :: UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903555"><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903555"><span class="hs-identifier hs-var">dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_calls :: UsageDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903556"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903556"><span class="hs-identifier hs-var">calls</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2932"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;MkUD&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span>
</span><span id="line-2933"></span><span>                </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;binds&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#equals"><span class="hs-identifier hs-var">equals</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903555"><span class="hs-identifier hs-var">dbs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-2934"></span><span>                 </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;calls&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#equals"><span class="hs-identifier hs-var">equals</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903556"><span class="hs-identifier hs-var">calls</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2935"></span><span>
</span><span id="line-2936"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2937"></span><span>  </span><span id="local-6989586621681903564"><span class="annot"><span class="annottext">ppr :: FloatedDictBinds -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fdb_binds :: FloatedDictBinds -&gt; OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903565"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903565"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903565"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-2938"></span><span>
</span><span id="line-2939"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-type">emptyUDs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-2940"></span><span id="emptyUDs"><span class="annot"><span class="annottext">emptyUDs :: UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-var hs-var">emptyUDs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_binds :: FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#emptyFDBs"><span class="hs-identifier hs-var">emptyFDBs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_calls :: CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallDetails
forall a. DVarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyDVarEnv"><span class="hs-identifier hs-var">emptyDVarEnv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2941"></span><span>
</span><span id="line-2942"></span><span>
</span><span id="line-2943"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#emptyFDBs"><span class="hs-identifier hs-type">emptyFDBs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span>
</span><span id="line-2944"></span><span id="emptyFDBs"><span class="annot"><span class="annottext">emptyFDBs :: FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#emptyFDBs"><span class="hs-identifier hs-var hs-var">emptyFDBs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fdb_binds :: OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
forall a. OrdList a
</span><a href="GHC.Data.OrdList.html#nilOL"><span class="hs-identifier hs-var">nilOL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fdb_bndrs :: VarSet
</span><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2945"></span><span>
</span><span id="line-2946"></span><span class="hs-comment">------------------------------------------------------------</span><span>
</span><span id="line-2947"></span><span class="hs-keyword">type</span><span> </span><span id="CallDetails"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallDetails"><span class="hs-identifier hs-var">CallDetails</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#DIdEnv"><span class="hs-identifier hs-type">DIdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a></span><span>
</span><span id="line-2948"></span><span>  </span><span class="hs-comment">-- The order of specialized binds and rules depends on how we linearize</span><span>
</span><span id="line-2949"></span><span>  </span><span class="hs-comment">-- CallDetails, so to get determinism we must use a deterministic set here.</span><span>
</span><span id="line-2950"></span><span>  </span><span class="hs-comment">-- See Note [Deterministic UniqFM] in GHC.Types.Unique.DFM</span><span>
</span><span id="line-2951"></span><span>
</span><span id="line-2952"></span><span class="hs-keyword">data</span><span> </span><span id="CallInfoSet"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfoSet"><span class="hs-identifier hs-var">CallInfoSet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CIS"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2953"></span><span>  </span><span class="hs-comment">-- The list of types and dictionaries is guaranteed to</span><span>
</span><span id="line-2954"></span><span>  </span><span class="hs-comment">-- match the type of f</span><span>
</span><span id="line-2955"></span><span>  </span><span class="hs-comment">-- The Bag may contain duplicate calls (i.e. f @T and another f @T)</span><span>
</span><span id="line-2956"></span><span>  </span><span class="hs-comment">-- These dups are eliminated by already_covered in specCalls</span><span>
</span><span id="line-2957"></span><span>
</span><span id="line-2958"></span><span class="hs-keyword">data</span><span> </span><span id="CallInfo"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-var">CallInfo</span></a></span></span><span>
</span><span id="line-2959"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="CI"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CI"><span class="hs-identifier hs-var">CI</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="ci_key"><span class="annot"><span class="annottext">CallInfo -&gt; [SpecArg]
</span><a href="GHC.Core.Opt.Specialise.html#ci_key"><span class="hs-identifier hs-var hs-var">ci_key</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecArg"><span class="hs-identifier hs-type">SpecArg</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- All arguments</span><span>
</span><span id="line-2960"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="ci_fvs"><span class="annot"><span class="annottext">CallInfo -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#ci_fvs"><span class="hs-identifier hs-var hs-var">ci_fvs</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a></span><span>       </span><span class="hs-comment">-- Free Ids of the ci_key call</span><span>
</span><span id="line-2961"></span><span>                                </span><span class="hs-comment">-- /not/ including the main id itself, of course</span><span>
</span><span id="line-2962"></span><span>                                </span><span class="hs-comment">-- NB: excluding tyvars:</span><span>
</span><span id="line-2963"></span><span>                                </span><span class="hs-comment">--     See Note [Specialising polymorphic dictionaries]</span><span>
</span><span id="line-2964"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-2965"></span><span>
</span><span id="line-2966"></span><span class="hs-keyword">type</span><span> </span><span id="DictExpr"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictExpr"><span class="hs-identifier hs-var">DictExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2967"></span><span>
</span><span id="line-2968"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#ciSetFilter"><span class="hs-identifier hs-type">ciSetFilter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a></span><span>
</span><span id="line-2969"></span><span id="ciSetFilter"><span class="annot"><span class="annottext">ciSetFilter :: (CallInfo -&gt; Bool) -&gt; CallInfoSet -&gt; CallInfoSet
</span><a href="GHC.Core.Opt.Specialise.html#ciSetFilter"><span class="hs-identifier hs-var hs-var">ciSetFilter</span></a></span></span><span> </span><span id="local-6989586621681903572"><span class="annot"><span class="annottext">CallInfo -&gt; Bool
</span><a href="#local-6989586621681903572"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CIS"><span class="hs-identifier hs-type">CIS</span></a></span><span> </span><span id="local-6989586621681903573"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903573"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681903574"><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903574"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bag CallInfo -&gt; CallInfoSet
</span><a href="GHC.Core.Opt.Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903573"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallInfo -&gt; Bool) -&gt; Bag CallInfo -&gt; Bag CallInfo
forall a. (a -&gt; Bool) -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#filterBag"><span class="hs-identifier hs-var">filterBag</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfo -&gt; Bool
</span><a href="#local-6989586621681903572"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903574"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2970"></span><span>
</span><span id="line-2971"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2972"></span><span>  </span><span id="local-6989586621681903584"><span class="annot"><span class="annottext">ppr :: CallInfoSet -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CIS"><span class="hs-identifier hs-type">CIS</span></a></span><span> </span><span id="local-6989586621681903585"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903585"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681903586"><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903586"><span class="hs-identifier hs-var">map</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CIS&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903585"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2973"></span><span>                        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag CallInfo -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903586"><span class="hs-identifier hs-var">map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2974"></span><span>
</span><span id="line-2975"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#pprCallInfo"><span class="hs-identifier hs-type">pprCallInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-2976"></span><span id="pprCallInfo"><span class="annot"><span class="annottext">pprCallInfo :: Id -&gt; CallInfo -&gt; SDoc
</span><a href="GHC.Core.Opt.Specialise.html#pprCallInfo"><span class="hs-identifier hs-var hs-var">pprCallInfo</span></a></span></span><span> </span><span id="local-6989586621681903587"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903587"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CI"><span class="hs-identifier hs-type">CI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ci_key :: CallInfo -&gt; [SpecArg]
</span><a href="GHC.Core.Opt.Specialise.html#ci_key"><span class="hs-identifier hs-var">ci_key</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903588"><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903588"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2977"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903587"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903588"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-2978"></span><span>
</span><span id="line-2979"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2980"></span><span>  </span><span id="local-6989586621681903595"><span class="annot"><span class="annottext">ppr :: CallInfo -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CI"><span class="hs-identifier hs-type">CI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ci_key :: CallInfo -&gt; [SpecArg]
</span><a href="GHC.Core.Opt.Specialise.html#ci_key"><span class="hs-identifier hs-var">ci_key</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903596"><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903596"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ci_fvs :: CallInfo -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#ci_fvs"><span class="hs-identifier hs-var">ci_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903597"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903597"><span class="hs-identifier hs-var">_fvs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2981"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CI&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SpecArg -&gt; SDoc) -&gt; [SpecArg] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903596"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2982"></span><span>
</span><span id="line-2983"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#unionCalls"><span class="hs-identifier hs-type">unionCalls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a></span><span>
</span><span id="line-2984"></span><span id="unionCalls"><span class="annot"><span class="annottext">unionCalls :: CallDetails -&gt; CallDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#unionCalls"><span class="hs-identifier hs-var hs-var">unionCalls</span></a></span></span><span> </span><span id="local-6989586621681903599"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903599"><span class="hs-identifier hs-var">c1</span></a></span></span><span> </span><span id="local-6989586621681903600"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903600"><span class="hs-identifier hs-var">c2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CallInfoSet -&gt; CallInfoSet -&gt; CallInfoSet)
-&gt; CallDetails -&gt; CallDetails -&gt; CallDetails
forall a. (a -&gt; a -&gt; a) -&gt; DVarEnv a -&gt; DVarEnv a -&gt; DVarEnv a
</span><a href="GHC.Types.Var.Env.html#plusDVarEnv_C"><span class="hs-identifier hs-var">plusDVarEnv_C</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfoSet -&gt; CallInfoSet -&gt; CallInfoSet
</span><a href="GHC.Core.Opt.Specialise.html#unionCallInfoSet"><span class="hs-identifier hs-var">unionCallInfoSet</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903599"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903600"><span class="hs-identifier hs-var">c2</span></a></span><span>
</span><span id="line-2985"></span><span>
</span><span id="line-2986"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#unionCallInfoSet"><span class="hs-identifier hs-type">unionCallInfoSet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a></span><span>
</span><span id="line-2987"></span><span id="unionCallInfoSet"><span class="annot"><span class="annottext">unionCallInfoSet :: CallInfoSet -&gt; CallInfoSet -&gt; CallInfoSet
</span><a href="GHC.Core.Opt.Specialise.html#unionCallInfoSet"><span class="hs-identifier hs-var hs-var">unionCallInfoSet</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CIS"><span class="hs-identifier hs-type">CIS</span></a></span><span> </span><span id="local-6989586621681903603"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903603"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621681903604"><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903604"><span class="hs-identifier hs-var">calls1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CIS"><span class="hs-identifier hs-type">CIS</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681903605"><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903605"><span class="hs-identifier hs-var">calls2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2988"></span><span>  </span><span class="annot"><span class="annottext">Id -&gt; Bag CallInfo -&gt; CallInfoSet
</span><a href="GHC.Core.Opt.Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903603"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903604"><span class="hs-identifier hs-var">calls1</span></a></span><span> </span><span class="annot"><span class="annottext">Bag CallInfo -&gt; Bag CallInfo -&gt; Bag CallInfo
forall a. Bag a -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-var">`unionBags`</span></a></span><span> </span><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903605"><span class="hs-identifier hs-var">calls2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2989"></span><span>
</span><span id="line-2990"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#callDetailsFVs"><span class="hs-identifier hs-type">callDetailsFVs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-2991"></span><span id="callDetailsFVs"><span class="annot"><span class="annottext">callDetailsFVs :: CallDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#callDetailsFVs"><span class="hs-identifier hs-var hs-var">callDetailsFVs</span></a></span></span><span> </span><span id="local-6989586621681903608"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903608"><span class="hs-identifier hs-var">calls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2992"></span><span>  </span><span class="annot"><span class="annottext">(CallInfoSet -&gt; VarSet -&gt; VarSet)
-&gt; VarSet -&gt; CallDetails -&gt; VarSet
forall elt a key. (elt -&gt; a -&gt; a) -&gt; a -&gt; UniqDFM key elt -&gt; a
</span><a href="GHC.Types.Unique.DFM.html#nonDetStrictFoldUDFM"><span class="hs-identifier hs-var">nonDetStrictFoldUDFM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; VarSet -&gt; VarSet)
-&gt; (CallInfoSet -&gt; VarSet) -&gt; CallInfoSet -&gt; VarSet -&gt; VarSet
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfoSet -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#callInfoFVs"><span class="hs-identifier hs-var">callInfoFVs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903608"><span class="hs-identifier hs-var">calls</span></a></span><span>
</span><span id="line-2993"></span><span>  </span><span class="hs-comment">-- It's OK to use nonDetStrictFoldUDFM here because we forget the ordering</span><span>
</span><span id="line-2994"></span><span>  </span><span class="hs-comment">-- immediately by converting to a nondeterministic set.</span><span>
</span><span id="line-2995"></span><span>
</span><span id="line-2996"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#callInfoFVs"><span class="hs-identifier hs-type">callInfoFVs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-2997"></span><span id="callInfoFVs"><span class="annot"><span class="annottext">callInfoFVs :: CallInfoSet -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#callInfoFVs"><span class="hs-identifier hs-var hs-var">callInfoFVs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CIS"><span class="hs-identifier hs-type">CIS</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681903612"><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903612"><span class="hs-identifier hs-var">call_info</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2998"></span><span>  </span><span class="annot"><span class="annottext">(CallInfo -&gt; VarSet -&gt; VarSet) -&gt; VarSet -&gt; Bag CallInfo -&gt; VarSet
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; Bag a -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CI"><span class="hs-identifier hs-type">CI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ci_fvs :: CallInfo -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#ci_fvs"><span class="hs-identifier hs-var">ci_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903613"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903613"><span class="hs-identifier hs-var">fv</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903614"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903614"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903613"><span class="hs-identifier hs-var">fv</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903614"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903612"><span class="hs-identifier hs-var">call_info</span></a></span><span>
</span><span id="line-2999"></span><span>
</span><span id="line-3000"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#getTheta"><span class="hs-identifier hs-type">getTheta</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#PiTyBinder"><span class="hs-identifier hs-type">PiTyBinder</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3001"></span><span id="getTheta"><span class="annot"><span class="annottext">getTheta :: [PiTyBinder] -&gt; [Kind]
</span><a href="GHC.Core.Opt.Specialise.html#getTheta"><span class="hs-identifier hs-var hs-var">getTheta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PiTyBinder -&gt; Kind) -&gt; [PiTyBinder] -&gt; [Kind]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#fmap/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">PiTyBinder -&gt; Kind
</span><a href="GHC.Types.Var.html#piTyBinderType"><span class="hs-identifier hs-var">piTyBinderType</span></a></span><span> </span><span class="annot"><span class="annottext">([PiTyBinder] -&gt; [Kind])
-&gt; ([PiTyBinder] -&gt; [PiTyBinder]) -&gt; [PiTyBinder] -&gt; [Kind]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(PiTyBinder -&gt; Bool) -&gt; [PiTyBinder] -&gt; [PiTyBinder]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#filter/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">PiTyBinder -&gt; Bool
</span><a href="GHC.Types.Var.html#isInvisiblePiTyBinder"><span class="hs-identifier hs-var">isInvisiblePiTyBinder</span></a></span><span> </span><span class="annot"><span class="annottext">([PiTyBinder] -&gt; [PiTyBinder])
-&gt; ([PiTyBinder] -&gt; [PiTyBinder]) -&gt; [PiTyBinder] -&gt; [PiTyBinder]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(PiTyBinder -&gt; Bool) -&gt; [PiTyBinder] -&gt; [PiTyBinder]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#filter/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">PiTyBinder -&gt; Bool
</span><a href="GHC.Types.Var.html#isAnonPiTyBinder"><span class="hs-identifier hs-var">isAnonPiTyBinder</span></a></span><span>
</span><span id="line-3002"></span><span>
</span><span id="line-3003"></span><span>
</span><span id="line-3004"></span><span class="hs-comment">------------------------------------------------------------</span><span>
</span><span id="line-3005"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#singleCall"><span class="hs-identifier hs-type">singleCall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecArg"><span class="hs-identifier hs-type">SpecArg</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3006"></span><span id="singleCall"><span class="annot"><span class="annottext">singleCall :: SpecEnv -&gt; Id -&gt; [SpecArg] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#singleCall"><span class="hs-identifier hs-var hs-var">singleCall</span></a></span></span><span> </span><span id="local-6989586621681903621"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903621"><span class="hs-identifier hs-var">spec_env</span></a></span></span><span> </span><span id="local-6989586621681903622"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903622"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681903623"><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903623"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-3007"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ud_binds :: FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#emptyFDBs"><span class="hs-identifier hs-var">emptyFDBs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3008"></span><span>          </span><span class="annot"><span class="annottext">ud_calls :: CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CallInfoSet -&gt; CallDetails
forall a. Id -&gt; a -&gt; DVarEnv a
</span><a href="GHC.Types.Var.Env.html#unitDVarEnv"><span class="hs-identifier hs-var">unitDVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903622"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">(CallInfoSet -&gt; CallDetails) -&gt; CallInfoSet -&gt; CallDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bag CallInfo -&gt; CallInfoSet
</span><a href="GHC.Core.Opt.Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903622"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">(Bag CallInfo -&gt; CallInfoSet) -&gt; Bag CallInfo -&gt; CallInfoSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-3009"></span><span>                     </span><span class="annot"><span class="annottext">CallInfo -&gt; Bag CallInfo
forall a. a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unitBag"><span class="hs-identifier hs-var">unitBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CI"><span class="hs-identifier hs-type">CI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ci_key :: [SpecArg]
</span><a href="GHC.Core.Opt.Specialise.html#ci_key"><span class="hs-identifier hs-var">ci_key</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903623"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-3010"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ci_fvs :: VarSet
</span><a href="GHC.Core.Opt.Specialise.html#ci_fvs"><span class="hs-identifier hs-var">ci_fvs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903626"><span class="hs-identifier hs-var">call_fvs</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3011"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3012"></span><span>    </span><span id="local-6989586621681903626"><span class="annot"><span class="annottext">call_fvs :: VarSet
</span><a href="#local-6989586621681903626"><span class="hs-identifier hs-var hs-var">call_fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3013"></span><span>      </span><span class="annot"><span class="annottext">(SpecArg -&gt; VarSet -&gt; VarSet) -&gt; VarSet -&gt; [SpecArg] -&gt; VarSet
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; VarSet -&gt; VarSet)
-&gt; (SpecArg -&gt; VarSet) -&gt; SpecArg -&gt; VarSet -&gt; VarSet
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg -&gt; VarSet
</span><a href="#local-6989586621681903627"><span class="hs-identifier hs-var">free_var_fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903623"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-3014"></span><span>
</span><span id="line-3015"></span><span>    </span><span id="local-6989586621681903627"><span class="annot"><span class="annottext">free_var_fn :: SpecArg -&gt; VarSet
</span><a href="#local-6989586621681903627"><span class="hs-identifier hs-var hs-var">free_var_fn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-3016"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_PolymorphicSpecialisation"><span class="hs-identifier hs-var">Opt_PolymorphicSpecialisation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; DynFlags
</span><a href="GHC.Core.Opt.Specialise.html#se_dflags"><span class="hs-identifier hs-var">se_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903621"><span class="hs-identifier hs-var">spec_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3017"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SpecArg -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#specArgFreeIds"><span class="hs-identifier hs-var">specArgFreeIds</span></a></span><span>
</span><span id="line-3018"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SpecArg -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#specArgFreeVars"><span class="hs-identifier hs-var">specArgFreeVars</span></a></span><span>
</span><span id="line-3019"></span><span>
</span><span id="line-3020"></span><span>
</span><span id="line-3021"></span><span>
</span><span id="line-3022"></span><span>        </span><span class="hs-comment">-- specArgFreeIds: we specifically look for free Ids, not TyVars</span><span>
</span><span id="line-3023"></span><span>        </span><span class="hs-comment">--    see (MP1) in Note [Specialising polymorphic dictionaries]</span><span>
</span><span id="line-3024"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-3025"></span><span>        </span><span class="hs-comment">-- We don't include the 'id' itself.</span><span>
</span><span id="line-3026"></span><span>
</span><span id="line-3027"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#mkCallUDs"><span class="hs-identifier hs-type">mkCallUDs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3028"></span><span id="mkCallUDs"><span class="annot"><span class="annottext">mkCallUDs :: SpecEnv -&gt; OutExpr -&gt; [OutExpr] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#mkCallUDs"><span class="hs-identifier hs-var hs-var">mkCallUDs</span></a></span></span><span> </span><span id="local-6989586621681903629"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903629"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903630"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903630"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681903631"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903631"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-3029"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreTickish]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681903632"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903632"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; OutExpr -&gt; ([CoreTickish], OutExpr)
forall b.
(CoreTickish -&gt; Bool) -&gt; Expr b -&gt; ([CoreTickish], Expr b)
</span><a href="GHC.Core.Utils.html#stripTicksTop"><span class="hs-identifier hs-var">stripTicksTop</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903630"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-comment">-- See Note [Ticks on applications]</span><span>
</span><span id="line-3030"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTraceWith &quot;mkCallUDs&quot; (\res -&gt; vcat [ ppr f, ppr args, ppr res ]) $</span><span>
</span><span id="line-3031"></span><span>    </span><span class="annot"><span class="annottext">SpecEnv -&gt; Id -&gt; [OutExpr] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#mkCallUDs%27"><span class="hs-identifier hs-var">mkCallUDs'</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903629"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903632"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903631"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-3032"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-3033"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a></span><span>
</span><span id="line-3034"></span><span>
</span><span id="line-3035"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#mkCallUDs%27"><span class="hs-identifier hs-type">mkCallUDs'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3036"></span><span id="mkCallUDs%27"><span class="annot"><span class="annottext">mkCallUDs' :: SpecEnv -&gt; Id -&gt; [OutExpr] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#mkCallUDs%27"><span class="hs-identifier hs-var hs-var">mkCallUDs'</span></a></span></span><span> </span><span id="local-6989586621681903635"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903635"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903636"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903636"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621681903637"><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903637"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-3037"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SpecEnv -&gt; Id -&gt; Bool
</span><a href="GHC.Core.Opt.Specialise.html#wantCallsFor"><span class="hs-identifier hs-var">wantCallsFor</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903635"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903636"><span class="hs-identifier hs-var">f</span></a></span><span>    </span><span class="hs-comment">-- We want it, and...</span><span>
</span><span id="line-3038"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SpecArg] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903639"><span class="hs-identifier hs-var">ci_key</span></a></span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- this call site has a useful specialisation</span><span>
</span><span id="line-3039"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;mkCallUDs: keeping&quot; _trace_doc</span><span>
</span><span id="line-3040"></span><span>    </span><span class="annot"><span class="annottext">SpecEnv -&gt; Id -&gt; [SpecArg] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#singleCall"><span class="hs-identifier hs-var">singleCall</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903635"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903636"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903639"><span class="hs-identifier hs-var">ci_key</span></a></span><span>
</span><span id="line-3041"></span><span>
</span><span id="line-3042"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>  </span><span class="hs-comment">-- See also Note [Specialisations already covered]</span><span>
</span><span id="line-3043"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;mkCallUDs: discarding&quot; _trace_doc</span><span>
</span><span id="line-3044"></span><span>    </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a></span><span>
</span><span id="line-3045"></span><span>
</span><span id="line-3046"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3047"></span><span>    </span><span id="local-6989586621681903640"><span class="annot"><span class="annottext">_trace_doc :: SDoc
</span><a href="#local-6989586621681903640"><span class="hs-identifier hs-var hs-var">_trace_doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903636"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[OutExpr] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903637"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SpecArg] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903639"><span class="hs-identifier hs-var">ci_key</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3048"></span><span>    </span><span id="local-6989586621681903641"><span class="annot"><span class="annottext">pis :: [PiTyBinder]
</span><a href="#local-6989586621681903641"><span class="hs-identifier hs-var hs-var">pis</span></a></span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([PiTyBinder], Kind) -&gt; [PiTyBinder]
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.2.1/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">(([PiTyBinder], Kind) -&gt; [PiTyBinder])
-&gt; ([PiTyBinder], Kind) -&gt; [PiTyBinder]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Kind -&gt; ([PiTyBinder], Kind)
</span><a href="GHC.Core.Type.html#splitPiTys"><span class="hs-identifier hs-var">splitPiTys</span></a></span><span> </span><span class="annot"><span class="annottext">(Kind -&gt; ([PiTyBinder], Kind)) -&gt; Kind -&gt; ([PiTyBinder], Kind)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903636"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-3049"></span><span>    </span><span id="local-6989586621681903643"><span class="annot"><span class="annottext">constrained_tyvars :: VarSet
</span><a href="#local-6989586621681903643"><span class="hs-identifier hs-var hs-var">constrained_tyvars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Kind] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">([Kind] -&gt; VarSet) -&gt; [Kind] -&gt; VarSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder] -&gt; [Kind]
</span><a href="GHC.Core.Opt.Specialise.html#getTheta"><span class="hs-identifier hs-var">getTheta</span></a></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621681903641"><span class="hs-identifier hs-var">pis</span></a></span><span>
</span><span id="line-3050"></span><span>
</span><span id="line-3051"></span><span>    </span><span class="annot"><a href="#local-6989586621681903639"><span class="hs-identifier hs-type">ci_key</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecArg"><span class="hs-identifier hs-type">SpecArg</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3052"></span><span>    </span><span id="local-6989586621681903639"><span class="annot"><span class="annottext">ci_key :: [SpecArg]
</span><a href="#local-6989586621681903639"><span class="hs-identifier hs-var hs-var">ci_key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SpecArg -&gt; Bool) -&gt; [SpecArg] -&gt; [SpecArg]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#dropWhileEndLE"><span class="hs-identifier hs-var">dropWhileEndLE</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (SpecArg -&gt; Bool) -&gt; SpecArg -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg -&gt; Bool
</span><a href="GHC.Core.Opt.Specialise.html#isSpecDict"><span class="hs-identifier hs-var">isSpecDict</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SpecArg] -&gt; [SpecArg]) -&gt; [SpecArg] -&gt; [SpecArg]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-3053"></span><span>             </span><span class="annot"><span class="annottext">(OutExpr -&gt; PiTyBinder -&gt; SpecArg)
-&gt; [OutExpr] -&gt; [PiTyBinder] -&gt; [SpecArg]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#zipWith/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; PiTyBinder -&gt; SpecArg
</span><a href="#local-6989586621681903646"><span class="hs-identifier hs-var">mk_spec_arg</span></a></span><span> </span><span class="annot"><span class="annottext">[OutExpr]
</span><a href="#local-6989586621681903637"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621681903641"><span class="hs-identifier hs-var">pis</span></a></span><span>
</span><span id="line-3054"></span><span>             </span><span class="hs-comment">-- Drop trailing args until we get to a SpecDict</span><span>
</span><span id="line-3055"></span><span>             </span><span class="hs-comment">-- In this way the RULE has as few args as possible,</span><span>
</span><span id="line-3056"></span><span>             </span><span class="hs-comment">-- which broadens its applicability, since rules only</span><span>
</span><span id="line-3057"></span><span>             </span><span class="hs-comment">-- fire when saturated</span><span>
</span><span id="line-3058"></span><span>
</span><span id="line-3059"></span><span>    </span><span class="annot"><a href="#local-6989586621681903646"><span class="hs-identifier hs-type">mk_spec_arg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#PiTyBinder"><span class="hs-identifier hs-type">PiTyBinder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecArg"><span class="hs-identifier hs-type">SpecArg</span></a></span><span>
</span><span id="line-3060"></span><span>    </span><span id="local-6989586621681903646"><span class="annot"><span class="annottext">mk_spec_arg :: OutExpr -&gt; PiTyBinder -&gt; SpecArg
</span><a href="#local-6989586621681903646"><span class="hs-identifier hs-var hs-var">mk_spec_arg</span></a></span></span><span> </span><span id="local-6989586621681903647"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903647"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Named"><span class="hs-identifier hs-type">Named</span></a></span><span> </span><span id="local-6989586621681903649"><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621681903649"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3061"></span><span>      </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">ForAllTyBinder -&gt; Id
forall tv argf. VarBndr tv argf -&gt; tv
</span><a href="GHC.Types.Var.html#binderVar"><span class="hs-identifier hs-var">binderVar</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyBinder
</span><a href="#local-6989586621681903649"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903643"><span class="hs-identifier hs-var">constrained_tyvars</span></a></span><span>
</span><span id="line-3062"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903647"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3063"></span><span>          </span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621681903652"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903652"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Kind -&gt; SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#SpecType"><span class="hs-identifier hs-var">SpecType</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903652"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-3064"></span><span>          </span><span class="annot"><span class="annottext">OutExpr
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; SpecArg
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ci_key&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SpecArg) -&gt; SDoc -&gt; SpecArg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903647"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-3065"></span><span>      </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecType"><span class="hs-identifier hs-var">UnspecType</span></a></span><span>
</span><span id="line-3066"></span><span>
</span><span id="line-3067"></span><span>    </span><span class="hs-comment">-- For &quot;invisibleFunArg&quot;, which are the type-class dictionaries,</span><span>
</span><span id="line-3068"></span><span>    </span><span class="hs-comment">-- we decide on a case by case basis if we want to specialise</span><span>
</span><span id="line-3069"></span><span>    </span><span class="hs-comment">-- on this argument; if so, SpecDict, if not UnspecArg</span><span>
</span><span id="line-3070"></span><span>    </span><span class="annot"><a href="#local-6989586621681903646"><span class="hs-identifier hs-var">mk_spec_arg</span></a></span><span> </span><span id="local-6989586621681903653"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903653"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Anon"><span class="hs-identifier hs-type">Anon</span></a></span><span> </span><span id="local-6989586621681903655"><span class="annot"><span class="annottext">Scaled Kind
</span><a href="#local-6989586621681903655"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span id="local-6989586621681903656"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621681903656"><span class="hs-identifier hs-var">af</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3071"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FunTyFlag -&gt; Bool
</span><a href="GHC.Types.Var.html#isInvisibleFunArg"><span class="hs-identifier hs-var">isInvisibleFunArg</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621681903656"><span class="hs-identifier hs-var">af</span></a></span><span>
</span><span id="line-3072"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Kind -&gt; Bool
</span><a href="GHC.Core.Opt.Specialise.html#interestingDict"><span class="hs-identifier hs-var">interestingDict</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903653"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scaled Kind -&gt; Kind
forall a. Scaled a -&gt; a
</span><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-var">scaledThing</span></a></span><span> </span><span class="annot"><span class="annottext">Scaled Kind
</span><a href="#local-6989586621681903655"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3073"></span><span>              </span><span class="hs-comment">-- See Note [Interesting dictionary arguments]</span><span>
</span><span id="line-3074"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#SpecDict"><span class="hs-identifier hs-var">SpecDict</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903653"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-3075"></span><span>
</span><span id="line-3076"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecArg"><span class="hs-identifier hs-var">UnspecArg</span></a></span><span>
</span><span id="line-3077"></span><span>
</span><span id="line-3078"></span><span class="hs-comment">{-
Note [Ticks on applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Ticks such as source location annotations can sometimes make their way
onto applications (see e.g. #21697). So if we see something like

    App (Tick _ f) e

we need to descend below the tick to find what the real function being
applied is.

The resulting RULE also has to be able to match this annotated use
site, so we only look through ticks that RULE matching looks through
(see Note [Tick annotations in RULE matching] in GHC.Core.Rules).
-}</span><span>
</span><span id="line-3093"></span><span>
</span><span id="line-3094"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#wantCallsFor"><span class="hs-identifier hs-type">wantCallsFor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3095"></span><span id="wantCallsFor"><span class="annot"><span class="annottext">wantCallsFor :: SpecEnv -&gt; Id -&gt; Bool
</span><a href="GHC.Core.Opt.Specialise.html#wantCallsFor"><span class="hs-identifier hs-var hs-var">wantCallsFor</span></a></span></span><span> </span><span id="local-6989586621681903658"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903658"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span id="local-6989586621681903659"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903659"><span class="hs-identifier hs-var">_f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3096"></span><span> </span><span class="hs-comment">-- We could reduce the size of the UsageDetails by being less eager</span><span>
</span><span id="line-3097"></span><span> </span><span class="hs-comment">-- about collecting calls for LocalIds: there is no point for</span><span>
</span><span id="line-3098"></span><span> </span><span class="hs-comment">-- ones that are lambda-bound.  We can't decide this by looking at</span><span>
</span><span id="line-3099"></span><span> </span><span class="hs-comment">-- the (absence of an) unfolding, because unfoldings for local</span><span>
</span><span id="line-3100"></span><span> </span><span class="hs-comment">-- functions are discarded by cloneBindSM, so no local binder will</span><span>
</span><span id="line-3101"></span><span> </span><span class="hs-comment">-- have an unfolding at this stage.  We'd have to keep a candidate</span><span>
</span><span id="line-3102"></span><span> </span><span class="hs-comment">-- set of let-binders.</span><span>
</span><span id="line-3103"></span><span> </span><span class="hs-comment">--</span><span>
</span><span id="line-3104"></span><span> </span><span class="hs-comment">-- Not many lambda-bound variables have dictionary arguments, so</span><span>
</span><span id="line-3105"></span><span> </span><span class="hs-comment">-- this would make little difference anyway.</span><span>
</span><span id="line-3106"></span><span> </span><span class="hs-comment">--</span><span>
</span><span id="line-3107"></span><span> </span><span class="hs-comment">-- For imported Ids we could check for an unfolding, but we have to</span><span>
</span><span id="line-3108"></span><span> </span><span class="hs-comment">-- do so anyway in canSpecImport, and it seems better to have it</span><span>
</span><span id="line-3109"></span><span> </span><span class="hs-comment">-- all in one place.  So we simply collect usage info for imported</span><span>
</span><span id="line-3110"></span><span> </span><span class="hs-comment">-- overloaded functions.</span><span>
</span><span id="line-3111"></span><span>
</span><span id="line-3112"></span><span class="hs-comment">{- Note [Interesting dictionary arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this
         \a.\d:Eq a.  let f = ... in ...(f d)...
There really is not much point in specialising f wrt the dictionary d,
because the code for the specialised f is not improved at all, because
d is lambda-bound.  We simply get junk specialisations.

What is &quot;interesting&quot;?  Just that it has *some* structure.  But what about
variables?  We look in the variable's /unfolding/.  And that means
that we must be careful to ensure that dictionaries have unfoldings,

* cloneBndrSM discards non-Stable unfoldings
* specBind updates the unfolding after specialisation
  See Note [Update unfolding after specialisation]
* bindAuxiliaryDict adds an unfolding for an aux dict
  see Note [Specialisation modulo dictionary selectors]
* specCase adds unfoldings for the new bindings it creates

We accidentally lost accurate tracking of local variables for a long
time, because cloned variables didn't have unfoldings. But makes a
massive difference in a few cases, eg #5113. For nofib as a
whole it's only a small win: 2.2% improvement in allocation for ansi,
1.2% for bspt, but mostly 0.0!  Average 0.1% increase in binary size.

Note [Update unfolding after specialisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (#21848)

  wombat :: Show b =&gt; Int -&gt; b -&gt; String
  wombat a b | a&gt;0       = wombat (a-1) b
             | otherwise = show a ++ wombat a b

  class C a where
    meth :: Show b =&gt; a -&gt; b -&gt; String
    dummy :: a -&gt; () -- Force a datatype dictionary representation

  instance C Int where
    meth = wombat
    dummy _ = ()

  class C a =&gt; D a   -- D has C as a superclass
  instance D Int

  f :: (D a, Show b) =&gt; a -&gt; b -&gt; String
  {-# INLINABLE[0] f #-}
  f a b = meth a b ++ &quot;!&quot; ++ meth a b

Now `f` turns into:

  f @a @b (dd :: D a) (ds :: Show b) a b
     = let dc :: D a = %p1 dd  -- Superclass selection
       in meth @a dc ....
          meth @a dc ....

When we specialise `f`, at a=Int say, that superclass selection can
nfire (via rewiteClassOps), but that info (that 'dc' is now a
particular dictionary `C`, of type `C Int`) must be available to
the call `meth @a dc`, so that we can fire the `meth` class-op, and
thence specialise `wombat`.

We deliver on this idea by updating the unfolding for the binder
in the NonRec case of specBind.  (This is too exotic to trouble with
the Rec case.)
-}</span><span>
</span><span id="line-3177"></span><span>
</span><span id="line-3178"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#interestingDict"><span class="hs-identifier hs-type">interestingDict</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3179"></span><span class="hs-comment">-- A dictionary argument is interesting if it has *some* structure,</span><span>
</span><span id="line-3180"></span><span class="hs-comment">-- see Note [Interesting dictionary arguments]</span><span>
</span><span id="line-3181"></span><span class="hs-comment">-- NB: &quot;dictionary&quot; arguments include constraints of all sorts,</span><span>
</span><span id="line-3182"></span><span class="hs-comment">--     including equality constraints; hence the Coercion case</span><span>
</span><span id="line-3183"></span><span class="hs-comment">-- To make this work, we need to ensure that dictionaries have</span><span>
</span><span id="line-3184"></span><span class="hs-comment">-- unfoldings in them.</span><span>
</span><span id="line-3185"></span><span id="interestingDict"><span class="annot"><span class="annottext">interestingDict :: OutExpr -&gt; Kind -&gt; Bool
</span><a href="GHC.Core.Opt.Specialise.html#interestingDict"><span class="hs-identifier hs-var hs-var">interestingDict</span></a></span></span><span> </span><span id="local-6989586621681903660"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903660"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621681903661"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903661"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span>
</span><span id="line-3186"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; Bool
</span><a href="GHC.Core.Predicate.html#typeDeterminesValue"><span class="hs-identifier hs-var">typeDeterminesValue</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903661"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>   </span><span class="hs-comment">-- See Note [Type determines value]</span><span>
</span><span id="line-3187"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutExpr -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="#local-6989586621681903663"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903660"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-3188"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3189"></span><span>    </span><span id="local-6989586621681903663"><span class="annot"><span class="annottext">go :: Expr b -&gt; Bool
</span><a href="#local-6989586621681903663"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681903664"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903664"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#hasSomeUnfolding"><span class="hs-identifier hs-var">hasSomeUnfolding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Unfolding
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903664"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3190"></span><span>                             </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDataConWorkId"><span class="hs-identifier hs-var">isDataConWorkId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903664"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-3191"></span><span>    </span><span class="annot"><a href="#local-6989586621681903663"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3192"></span><span>    </span><span class="annot"><a href="#local-6989586621681903663"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3193"></span><span>    </span><span class="annot"><a href="#local-6989586621681903663"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681903667"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621681903667"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Bool
</span><a href="#local-6989586621681903663"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621681903667"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-3194"></span><span>    </span><span class="annot"><a href="#local-6989586621681903663"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681903668"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621681903668"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Bool
</span><a href="#local-6989586621681903663"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621681903668"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-3195"></span><span>    </span><span class="annot"><a href="#local-6989586621681903663"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681903669"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621681903669"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Bool
</span><a href="#local-6989586621681903663"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621681903669"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-3196"></span><span>    </span><span class="annot"><a href="#local-6989586621681903663"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681903670"><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621681903670"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr b -&gt; Bool
</span><a href="#local-6989586621681903663"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><a href="#local-6989586621681903670"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-3197"></span><span>    </span><span class="annot"><a href="#local-6989586621681903663"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr b
</span><span class="hs-identifier">_</span></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3198"></span><span>
</span><span id="line-3199"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#thenUDs"><span class="hs-identifier hs-type">thenUDs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3200"></span><span id="thenUDs"><span class="annot"><span class="annottext">thenUDs :: UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#thenUDs"><span class="hs-identifier hs-var hs-var">thenUDs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ud_binds :: UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903671"><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903671"><span class="hs-identifier hs-var">db1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_calls :: UsageDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903672"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903672"><span class="hs-identifier hs-var">calls1</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3201"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ud_binds :: UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903673"><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903673"><span class="hs-identifier hs-var">db2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_calls :: UsageDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903674"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903674"><span class="hs-identifier hs-var">calls2</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3202"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_binds :: FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903671"><span class="hs-identifier hs-var">db1</span></a></span><span>    </span><span class="annot"><span class="annottext">FloatedDictBinds -&gt; FloatedDictBinds -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#thenFDBs"><span class="hs-operator hs-var">`thenFDBs`</span></a></span><span>   </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903673"><span class="hs-identifier hs-var">db2</span></a></span><span>
</span><span id="line-3203"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_calls :: CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903672"><span class="hs-identifier hs-var">calls1</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails -&gt; CallDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#unionCalls"><span class="hs-operator hs-var">`unionCalls`</span></a></span><span>  </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903674"><span class="hs-identifier hs-var">calls2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3204"></span><span>
</span><span id="line-3205"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#thenFDBs"><span class="hs-identifier hs-type">thenFDBs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span>
</span><span id="line-3206"></span><span class="hs-comment">-- Combine FloatedDictBinds</span><span>
</span><span id="line-3207"></span><span class="hs-comment">-- In (dbs1 `thenFDBs` dbs2), dbs2 may mention dbs1 but not vice versa</span><span>
</span><span id="line-3208"></span><span id="thenFDBs"><span class="annot"><span class="annottext">thenFDBs :: FloatedDictBinds -&gt; FloatedDictBinds -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#thenFDBs"><span class="hs-identifier hs-var hs-var">thenFDBs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fdb_binds :: FloatedDictBinds -&gt; OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903675"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903675"><span class="hs-identifier hs-var">dbs1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fdb_bndrs :: FloatedDictBinds -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903676"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903676"><span class="hs-identifier hs-var">bs1</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3209"></span><span>         </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fdb_binds :: FloatedDictBinds -&gt; OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903677"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903677"><span class="hs-identifier hs-var">dbs2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fdb_bndrs :: FloatedDictBinds -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903678"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903678"><span class="hs-identifier hs-var">bs2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3210"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fdb_binds :: OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903675"><span class="hs-identifier hs-var">dbs1</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind -&gt; OrdList DictBind -&gt; OrdList DictBind
forall a. OrdList a -&gt; OrdList a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#appOL"><span class="hs-operator hs-var">`appOL`</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903677"><span class="hs-identifier hs-var">dbs2</span></a></span><span>
</span><span id="line-3211"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fdb_bndrs :: VarSet
</span><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903676"><span class="hs-identifier hs-var">bs1</span></a></span><span>  </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903678"><span class="hs-identifier hs-var">bs2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3212"></span><span>
</span><span id="line-3213"></span><span class="hs-comment">-----------------------------</span><span>
</span><span id="line-3214"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#_dictBindBndrs"><span class="hs-identifier hs-type">_dictBindBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3215"></span><span id="_dictBindBndrs"><span class="annot"><span class="annottext">_dictBindBndrs :: OrdList DictBind -&gt; [Id]
</span><a href="GHC.Core.Opt.Specialise.html#_dictBindBndrs"><span class="hs-identifier hs-var hs-var">_dictBindBndrs</span></a></span></span><span> </span><span id="local-6989586621681903681"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903681"><span class="hs-identifier hs-var">dbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DictBind -&gt; [Id] -&gt; [Id]) -&gt; [Id] -&gt; OrdList DictBind -&gt; [Id]
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">(++)</span></a></span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; [Id] -&gt; [Id])
-&gt; (DictBind -&gt; [Id]) -&gt; DictBind -&gt; [Id] -&gt; [Id]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">InBind -&gt; [Id]
forall b. Bind b -&gt; [b]
</span><a href="GHC.Core.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a></span><span> </span><span class="annot"><span class="annottext">(InBind -&gt; [Id]) -&gt; (DictBind -&gt; InBind) -&gt; DictBind -&gt; [Id]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903681"><span class="hs-identifier hs-var">dbs</span></a></span><span>
</span><span id="line-3216"></span><span>
</span><span id="line-3217"></span><span class="annot"><span class="hs-comment">-- | Construct a 'DictBind' from a 'CoreBind'</span></span><span>
</span><span id="line-3218"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#mkDB"><span class="hs-identifier hs-type">mkDB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span>
</span><span id="line-3219"></span><span id="mkDB"><span class="annot"><span class="annottext">mkDB :: InBind -&gt; DictBind
</span><a href="GHC.Core.Opt.Specialise.html#mkDB"><span class="hs-identifier hs-var hs-var">mkDB</span></a></span></span><span> </span><span id="local-6989586621681903682"><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903682"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">db_bind :: InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903682"><span class="hs-identifier hs-var">bind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">db_fvs :: VarSet
</span><a href="GHC.Core.Opt.Specialise.html#db_fvs"><span class="hs-identifier hs-var">db_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InBind -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#bind_fvs"><span class="hs-identifier hs-var">bind_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903682"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3220"></span><span>
</span><span id="line-3221"></span><span class="annot"><span class="hs-comment">-- | Identify the free variables of a 'CoreBind'</span></span><span>
</span><span id="line-3222"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#bind_fvs"><span class="hs-identifier hs-type">bind_fvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-3223"></span><span id="bind_fvs"><span class="annot"><span class="annottext">bind_fvs :: InBind -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#bind_fvs"><span class="hs-identifier hs-var hs-var">bind_fvs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681903684"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903684"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681903685"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903685"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id, OutExpr) -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#pair_fvs"><span class="hs-identifier hs-var">pair_fvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903684"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903685"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3224"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#bind_fvs"><span class="hs-identifier hs-var">bind_fvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681903687"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903687"><span class="hs-identifier hs-var">prs</span></a></span></span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903688"><span class="hs-identifier hs-var">rhs_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#delVarSetList"><span class="hs-operator hs-var">`delVarSetList`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Id, OutExpr) -&gt; Id) -&gt; [(Id, OutExpr)] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, OutExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.2.1/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903687"><span class="hs-identifier hs-var">prs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3225"></span><span>                           </span><span class="hs-keyword">where</span><span>
</span><span id="line-3226"></span><span>                             </span><span id="local-6989586621681903688"><span class="annot"><span class="annottext">rhs_fvs :: VarSet
</span><a href="#local-6989586621681903688"><span class="hs-identifier hs-var hs-var">rhs_fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VarSet] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSets"><span class="hs-identifier hs-var">unionVarSets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Id, OutExpr) -&gt; VarSet) -&gt; [(Id, OutExpr)] -&gt; [VarSet]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, OutExpr) -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#pair_fvs"><span class="hs-identifier hs-var">pair_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903687"><span class="hs-identifier hs-var">prs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3227"></span><span>
</span><span id="line-3228"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#pair_fvs"><span class="hs-identifier hs-type">pair_fvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span>
</span><span id="line-3229"></span><span id="pair_fvs"><span class="annot"><span class="annottext">pair_fvs :: (Id, OutExpr) -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#pair_fvs"><span class="hs-identifier hs-var hs-var">pair_fvs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903691"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903691"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903692"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903692"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; OutExpr -&gt; VarSet
</span><a href="GHC.Core.FVs.html#exprSomeFreeVars"><span class="hs-identifier hs-var">exprSomeFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621681903694"><span class="hs-identifier hs-var">interesting</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903692"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-3230"></span><span>                       </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarSet
</span><a href="GHC.Core.FVs.html#idFreeVars"><span class="hs-identifier hs-var">idFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903691"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-3231"></span><span>        </span><span class="hs-comment">-- idFreeVars: don't forget variables mentioned in</span><span>
</span><span id="line-3232"></span><span>        </span><span class="hs-comment">-- the rules of the bndr.  C.f. OccAnal.addRuleUsage</span><span>
</span><span id="line-3233"></span><span>        </span><span class="hs-comment">-- Also tyvars mentioned in its type; they may not appear</span><span>
</span><span id="line-3234"></span><span>        </span><span class="hs-comment">-- in the RHS</span><span>
</span><span id="line-3235"></span><span>        </span><span class="hs-comment">--      type T a = Int</span><span>
</span><span id="line-3236"></span><span>        </span><span class="hs-comment">--      x :: T a = 3</span><span>
</span><span id="line-3237"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3238"></span><span>    </span><span class="annot"><a href="#local-6989586621681903694"><span class="hs-identifier hs-type">interesting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.FV.html#InterestingVarFun"><span class="hs-identifier hs-type">InterestingVarFun</span></a></span><span>
</span><span id="line-3239"></span><span>    </span><span id="local-6989586621681903694"><span class="annot"><span class="annottext">interesting :: Id -&gt; Bool
</span><a href="#local-6989586621681903694"><span class="hs-identifier hs-var hs-var">interesting</span></a></span></span><span> </span><span id="local-6989586621681903697"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903697"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalVar"><span class="hs-identifier hs-var">isLocalVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903697"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903697"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDFunId"><span class="hs-identifier hs-var">isDFunId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903697"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3240"></span><span>        </span><span class="hs-comment">-- Very important: include DFunIds /even/ if it is imported</span><span>
</span><span id="line-3241"></span><span>        </span><span class="hs-comment">-- Reason: See Note [Avoiding loops in specImports], the #13429</span><span>
</span><span id="line-3242"></span><span>        </span><span class="hs-comment">--         example involving an imported dfun.  We must know</span><span>
</span><span id="line-3243"></span><span>        </span><span class="hs-comment">--         whether a dictionary binding depends on an imported</span><span>
</span><span id="line-3244"></span><span>        </span><span class="hs-comment">--         DFun in case we try to specialise that imported DFun</span><span>
</span><span id="line-3245"></span><span>
</span><span id="line-3246"></span><span class="hs-comment">-- | Flatten a set of &quot;dumped&quot; 'DictBind's, and some other binding</span><span>
</span><span id="line-3247"></span><span class="hs-comment">-- pairs, into a single recursive binding.</span><span>
</span><span id="line-3248"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#recWithDumpedDicts"><span class="hs-identifier hs-type">recWithDumpedDicts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span>
</span><span id="line-3249"></span><span id="recWithDumpedDicts"><span class="annot"><span class="annottext">recWithDumpedDicts :: [(Id, OutExpr)] -&gt; OrdList DictBind -&gt; DictBind
</span><a href="GHC.Core.Opt.Specialise.html#recWithDumpedDicts"><span class="hs-identifier hs-var hs-var">recWithDumpedDicts</span></a></span></span><span> </span><span id="local-6989586621681903698"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903698"><span class="hs-identifier hs-var">pairs</span></a></span></span><span> </span><span id="local-6989586621681903699"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903699"><span class="hs-identifier hs-var">dbs</span></a></span></span><span>
</span><span id="line-3250"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">db_bind :: InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; InBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903700"><span class="hs-identifier hs-var">bindings</span></a></span><span>
</span><span id="line-3251"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">db_fvs :: VarSet
</span><a href="GHC.Core.Opt.Specialise.html#db_fvs"><span class="hs-identifier hs-var">db_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903701"><span class="hs-identifier hs-var">fvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#delVarSetList"><span class="hs-operator hs-var">`delVarSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">((Id, OutExpr) -&gt; Id) -&gt; [(Id, OutExpr)] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, OutExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.2.1/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903700"><span class="hs-identifier hs-var">bindings</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3252"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3253"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681903700"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903700"><span class="hs-identifier hs-var">bindings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903701"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903701"><span class="hs-identifier hs-var">fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DictBind
 -&gt; ([(Id, OutExpr)], VarSet) -&gt; ([(Id, OutExpr)], VarSet))
-&gt; ([(Id, OutExpr)], VarSet)
-&gt; OrdList DictBind
-&gt; ([(Id, OutExpr)], VarSet)
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind -&gt; ([(Id, OutExpr)], VarSet) -&gt; ([(Id, OutExpr)], VarSet)
</span><a href="#local-6989586621681903702"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3254"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903699"><span class="hs-identifier hs-var">dbs</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind -&gt; DictBind -&gt; OrdList DictBind
forall a. OrdList a -&gt; a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#snocOL"><span class="hs-operator hs-var">`snocOL`</span></a></span><span> </span><span class="annot"><span class="annottext">InBind -&gt; DictBind
</span><a href="GHC.Core.Opt.Specialise.html#mkDB"><span class="hs-identifier hs-var">mkDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; InBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903698"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3255"></span><span>    </span><span id="local-6989586621681903702"><span class="annot"><span class="annottext">add :: DictBind -&gt; ([(Id, OutExpr)], VarSet) -&gt; ([(Id, OutExpr)], VarSet)
</span><a href="#local-6989586621681903702"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">db_bind :: DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903704"><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903704"><span class="hs-identifier hs-var">bind</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">db_fvs :: DictBind -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#db_fvs"><span class="hs-identifier hs-var">db_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903705"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903705"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903706"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903706"><span class="hs-identifier hs-var">prs_acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903707"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903707"><span class="hs-identifier hs-var">fvs_acc</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3256"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903704"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3257"></span><span>          </span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681903708"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903708"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681903709"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903709"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903708"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903709"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Id, OutExpr) -&gt; [(Id, OutExpr)] -&gt; [(Id, OutExpr)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903706"><span class="hs-identifier hs-var">prs_acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903710"><span class="hs-identifier hs-var">fvs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3258"></span><span>          </span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681903711"><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903711"><span class="hs-identifier hs-var">prs1</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903711"><span class="hs-identifier hs-var">prs1</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)] -&gt; [(Id, OutExpr)] -&gt; [(Id, OutExpr)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, OutExpr)]
</span><a href="#local-6989586621681903706"><span class="hs-identifier hs-var">prs_acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903710"><span class="hs-identifier hs-var">fvs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3259"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-3260"></span><span>        </span><span id="local-6989586621681903710"><span class="annot"><span class="annottext">fvs' :: VarSet
</span><a href="#local-6989586621681903710"><span class="hs-identifier hs-var hs-var">fvs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903707"><span class="hs-identifier hs-var">fvs_acc</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903705"><span class="hs-identifier hs-var">fvs</span></a></span><span>
</span><span id="line-3261"></span><span>
</span><span id="line-3262"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#snocDictBind"><span class="hs-identifier hs-type">snocDictBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3263"></span><span id="snocDictBind"><span class="annot"><span class="annottext">snocDictBind :: UsageDetails -&gt; DictBind -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#snocDictBind"><span class="hs-identifier hs-var hs-var">snocDictBind</span></a></span></span><span> </span><span id="local-6989586621681903712"><span class="annot"><span class="annottext">uds :: UsageDetails
</span><a href="#local-6989586621681903712"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ud_binds :: UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fdb_binds :: FloatedDictBinds -&gt; OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903713"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903713"><span class="hs-identifier hs-var">dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fdb_bndrs :: FloatedDictBinds -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903714"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903714"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span> </span><span id="local-6989586621681903715"><span class="annot"><span class="annottext">DictBind
</span><a href="#local-6989586621681903715"><span class="hs-identifier hs-var">db</span></a></span></span><span>
</span><span id="line-3264"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903712"><span class="hs-identifier hs-var">uds</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903713"><span class="hs-identifier hs-type">dbs</span></a></span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#snocOL"><span class="hs-operator hs-type">`snocOL`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903715"><span class="hs-identifier hs-type">db</span></a></span><span>
</span><span id="line-3265"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903714"><span class="hs-identifier hs-type">bs</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#extendVarSetList"><span class="hs-operator hs-type">`extendVarSetList`</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#bindersOfDictBind"><span class="hs-identifier hs-type">bindersOfDictBind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903715"><span class="hs-identifier hs-type">db</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3266"></span><span>
</span><span id="line-3267"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#snocDictBinds"><span class="hs-identifier hs-type">snocDictBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3268"></span><span class="hs-comment">-- Add ud_binds to the tail end of the bindings in uds</span><span>
</span><span id="line-3269"></span><span id="snocDictBinds"><span class="annot"><span class="annottext">snocDictBinds :: UsageDetails -&gt; [DictBind] -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#snocDictBinds"><span class="hs-identifier hs-var hs-var">snocDictBinds</span></a></span></span><span> </span><span id="local-6989586621681903717"><span class="annot"><span class="annottext">uds :: UsageDetails
</span><a href="#local-6989586621681903717"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ud_binds :: UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span class="hs-glyph">=</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fdb_binds :: FloatedDictBinds -&gt; OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903718"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903718"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fdb_bndrs :: FloatedDictBinds -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903719"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903719"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span> </span><span id="local-6989586621681903720"><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903720"><span class="hs-identifier hs-var">dbs</span></a></span></span><span>
</span><span id="line-3270"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903717"><span class="hs-identifier hs-var">uds</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903718"><span class="hs-identifier hs-type">binds</span></a></span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#appOL"><span class="hs-operator hs-type">`appOL`</span></a></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.OrdList.html#toOL"><span class="hs-identifier hs-type">toOL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903720"><span class="hs-identifier hs-type">dbs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3271"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903719"><span class="hs-identifier hs-type">bs</span></a></span><span>    </span><span class="annot"><a href="GHC.Types.Var.Set.html#extendVarSetList"><span class="hs-operator hs-type">`extendVarSetList`</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#bindersOfDictBinds"><span class="hs-identifier hs-type">bindersOfDictBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903720"><span class="hs-identifier hs-type">dbs</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3272"></span><span>
</span><span id="line-3273"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#consDictBinds"><span class="hs-identifier hs-type">consDictBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span>
</span><span id="line-3274"></span><span id="consDictBinds"><span class="annot"><span class="annottext">consDictBinds :: [DictBind] -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#consDictBinds"><span class="hs-identifier hs-var hs-var">consDictBinds</span></a></span></span><span> </span><span id="local-6989586621681903722"><span class="annot"><span class="annottext">[DictBind]
</span><a href="#local-6989586621681903722"><span class="hs-identifier hs-var">dbs</span></a></span></span><span> </span><span id="local-6989586621681903723"><span class="annot"><span class="annottext">uds :: UsageDetails
</span><a href="#local-6989586621681903723"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ud_binds :: UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span class="hs-glyph">=</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">fdb_binds :: FloatedDictBinds -&gt; OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903724"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903724"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fdb_bndrs :: FloatedDictBinds -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903725"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903725"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-3275"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903723"><span class="hs-identifier hs-var">uds</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#toOL"><span class="hs-identifier hs-type">toOL</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903722"><span class="hs-identifier hs-type">dbs</span></a></span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#appOL"><span class="hs-operator hs-type">`appOL`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903724"><span class="hs-identifier hs-type">binds</span></a></span><span>
</span><span id="line-3276"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903725"><span class="hs-identifier hs-type">bs</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#extendVarSetList"><span class="hs-operator hs-type">`extendVarSetList`</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#bindersOfDictBinds"><span class="hs-identifier hs-type">bindersOfDictBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903722"><span class="hs-identifier hs-type">dbs</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3277"></span><span>
</span><span id="line-3278"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#wrapDictBinds"><span class="hs-identifier hs-type">wrapDictBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3279"></span><span id="wrapDictBinds"><span class="annot"><span class="annottext">wrapDictBinds :: FloatedDictBinds -&gt; CoreProgram -&gt; CoreProgram
</span><a href="GHC.Core.Opt.Specialise.html#wrapDictBinds"><span class="hs-identifier hs-var hs-var">wrapDictBinds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fdb_binds :: FloatedDictBinds -&gt; OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903726"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903726"><span class="hs-identifier hs-var">dbs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903727"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681903727"><span class="hs-identifier hs-var">binds</span></a></span></span><span>
</span><span id="line-3280"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DictBind -&gt; CoreProgram -&gt; CoreProgram)
-&gt; CoreProgram -&gt; OrdList DictBind -&gt; CoreProgram
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind -&gt; CoreProgram -&gt; CoreProgram
</span><a href="#local-6989586621681903728"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681903727"><span class="hs-identifier hs-var">binds</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903726"><span class="hs-identifier hs-var">dbs</span></a></span><span>
</span><span id="line-3281"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3282"></span><span>    </span><span id="local-6989586621681903728"><span class="annot"><span class="annottext">add :: DictBind -&gt; CoreProgram -&gt; CoreProgram
</span><a href="#local-6989586621681903728"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">db_bind :: DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903729"><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903729"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903730"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681903730"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903729"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="annot"><span class="annottext">InBind -&gt; CoreProgram -&gt; CoreProgram
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681903730"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-3283"></span><span>
</span><span id="line-3284"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#wrapDictBindsE"><span class="hs-identifier hs-type">wrapDictBindsE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-3285"></span><span id="wrapDictBindsE"><span class="annot"><span class="annottext">wrapDictBindsE :: OrdList DictBind -&gt; OutExpr -&gt; OutExpr
</span><a href="GHC.Core.Opt.Specialise.html#wrapDictBindsE"><span class="hs-identifier hs-var hs-var">wrapDictBindsE</span></a></span></span><span> </span><span id="local-6989586621681903731"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903731"><span class="hs-identifier hs-var">dbs</span></a></span></span><span> </span><span id="local-6989586621681903732"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903732"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-3286"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DictBind -&gt; OutExpr -&gt; OutExpr)
-&gt; OutExpr -&gt; OrdList DictBind -&gt; OutExpr
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind -&gt; OutExpr -&gt; OutExpr
</span><a href="#local-6989586621681903733"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903732"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903731"><span class="hs-identifier hs-var">dbs</span></a></span><span>
</span><span id="line-3287"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3288"></span><span>    </span><span id="local-6989586621681903733"><span class="annot"><span class="annottext">add :: DictBind -&gt; OutExpr -&gt; OutExpr
</span><a href="#local-6989586621681903733"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">db_bind :: DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903734"><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903734"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903735"><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903735"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InBind -&gt; OutExpr -&gt; OutExpr
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903734"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="annot"><span class="annottext">OutExpr
</span><a href="#local-6989586621681903735"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-3289"></span><span>
</span><span id="line-3290"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-3291"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#dumpUDs"><span class="hs-identifier hs-type">dumpUDs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3292"></span><span class="hs-comment">-- Used at a lambda or case binder; just dump anything mentioning the binder</span><span>
</span><span id="line-3293"></span><span id="dumpUDs"><span class="annot"><span class="annottext">dumpUDs :: [Id] -&gt; UsageDetails -&gt; (UsageDetails, OrdList DictBind)
</span><a href="GHC.Core.Opt.Specialise.html#dumpUDs"><span class="hs-identifier hs-var hs-var">dumpUDs</span></a></span></span><span> </span><span id="local-6989586621681903737"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903737"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621681903738"><span class="annot"><span class="annottext">uds :: UsageDetails
</span><a href="#local-6989586621681903738"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_binds :: UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903739"><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903739"><span class="hs-identifier hs-var">orig_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_calls :: UsageDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903740"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903740"><span class="hs-identifier hs-var">orig_calls</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3294"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903737"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903738"><span class="hs-identifier hs-var">uds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
forall a. OrdList a
</span><a href="GHC.Data.OrdList.html#nilOL"><span class="hs-identifier hs-var">nilOL</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Common in case alternatives</span><span>
</span><span id="line-3295"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dumpUDs&quot; (ppr bndrs $$ ppr free_uds $$ ppr dump_dbs) $</span><span>
</span><span id="line-3296"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903741"><span class="hs-identifier hs-var">free_uds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903742"><span class="hs-identifier hs-var">dump_dbs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3297"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3298"></span><span>    </span><span id="local-6989586621681903741"><span class="annot"><span class="annottext">free_uds :: UsageDetails
</span><a href="#local-6989586621681903741"><span class="hs-identifier hs-var hs-var">free_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903738"><span class="hs-identifier hs-var">uds</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903743"><span class="hs-identifier hs-type">free_dbs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903744"><span class="hs-identifier hs-type">free_calls</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3299"></span><span>    </span><span id="local-6989586621681903745"><span class="annot"><span class="annottext">bndr_set :: VarSet
</span><a href="#local-6989586621681903745"><span class="hs-identifier hs-var hs-var">bndr_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903737"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-3300"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681903743"><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903743"><span class="hs-identifier hs-var">free_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903742"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903742"><span class="hs-identifier hs-var">dump_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903746"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903746"><span class="hs-identifier hs-var">dump_set</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
-&gt; VarSet -&gt; (FloatedDictBinds, OrdList DictBind, VarSet)
</span><a href="GHC.Core.Opt.Specialise.html#splitDictBinds"><span class="hs-identifier hs-var">splitDictBinds</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903739"><span class="hs-identifier hs-var">orig_dbs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903745"><span class="hs-identifier hs-var">bndr_set</span></a></span><span>
</span><span id="line-3301"></span><span>    </span><span id="local-6989586621681903744"><span class="annot"><span class="annottext">free_calls :: CallDetails
</span><a href="#local-6989586621681903744"><span class="hs-identifier hs-var hs-var">free_calls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; CallDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#deleteCallsMentioning"><span class="hs-identifier hs-var">deleteCallsMentioning</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903746"><span class="hs-identifier hs-var">dump_set</span></a></span><span> </span><span class="annot"><span class="annottext">(CallDetails -&gt; CallDetails) -&gt; CallDetails -&gt; CallDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>   </span><span class="hs-comment">-- Drop calls mentioning bndr_set on the floor</span><span>
</span><span id="line-3302"></span><span>                 </span><span class="annot"><span class="annottext">[Id] -&gt; CallDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#deleteCallsFor"><span class="hs-identifier hs-var">deleteCallsFor</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903737"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903740"><span class="hs-identifier hs-var">orig_calls</span></a></span><span>    </span><span class="hs-comment">-- Discard calls for bndr_set; there should be</span><span>
</span><span id="line-3303"></span><span>                                                    </span><span class="hs-comment">-- no calls for any of the dicts in dump_dbs</span><span>
</span><span id="line-3304"></span><span>
</span><span id="line-3305"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#dumpBindUDs"><span class="hs-identifier hs-type">dumpBindUDs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-3306"></span><span class="hs-comment">-- Used at a let(rec) binding.</span><span>
</span><span id="line-3307"></span><span class="hs-comment">-- We return a boolean indicating whether the binding itself is mentioned,</span><span>
</span><span id="line-3308"></span><span class="hs-comment">-- directly or indirectly, by any of the ud_calls; in that case we want to</span><span>
</span><span id="line-3309"></span><span class="hs-comment">-- float the binding itself;</span><span>
</span><span id="line-3310"></span><span class="hs-comment">-- See Note [Floated dictionary bindings]</span><span>
</span><span id="line-3311"></span><span id="dumpBindUDs"><span class="annot"><span class="annottext">dumpBindUDs :: [Id] -&gt; UsageDetails -&gt; (UsageDetails, OrdList DictBind, Bool)
</span><a href="GHC.Core.Opt.Specialise.html#dumpBindUDs"><span class="hs-identifier hs-var hs-var">dumpBindUDs</span></a></span></span><span> </span><span id="local-6989586621681903750"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903750"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_binds :: UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903751"><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903751"><span class="hs-identifier hs-var">orig_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_calls :: UsageDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903752"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903752"><span class="hs-identifier hs-var">orig_calls</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3312"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dumpBindUDs&quot; (ppr bndrs $$ ppr free_uds $$ ppr dump_dbs $$ ppr float_all) $</span><span>
</span><span id="line-3313"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903753"><span class="hs-identifier hs-var">free_uds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903754"><span class="hs-identifier hs-var">dump_dbs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681903755"><span class="hs-identifier hs-var">float_all</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3314"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3315"></span><span>    </span><span id="local-6989586621681903753"><span class="annot"><span class="annottext">free_uds :: UsageDetails
</span><a href="#local-6989586621681903753"><span class="hs-identifier hs-var hs-var">free_uds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_binds :: FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903756"><span class="hs-identifier hs-var">free_dbs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_calls :: CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903757"><span class="hs-identifier hs-var">free_calls</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3316"></span><span>    </span><span id="local-6989586621681903758"><span class="annot"><span class="annottext">bndr_set :: VarSet
</span><a href="#local-6989586621681903758"><span class="hs-identifier hs-var hs-var">bndr_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903750"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-3317"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681903756"><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903756"><span class="hs-identifier hs-var">free_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903754"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903754"><span class="hs-identifier hs-var">dump_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903759"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903759"><span class="hs-identifier hs-var">dump_set</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
-&gt; VarSet -&gt; (FloatedDictBinds, OrdList DictBind, VarSet)
</span><a href="GHC.Core.Opt.Specialise.html#splitDictBinds"><span class="hs-identifier hs-var">splitDictBinds</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903751"><span class="hs-identifier hs-var">orig_dbs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903758"><span class="hs-identifier hs-var">bndr_set</span></a></span><span>
</span><span id="line-3318"></span><span>    </span><span id="local-6989586621681903757"><span class="annot"><span class="annottext">free_calls :: CallDetails
</span><a href="#local-6989586621681903757"><span class="hs-identifier hs-var hs-var">free_calls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; CallDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#deleteCallsFor"><span class="hs-identifier hs-var">deleteCallsFor</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903750"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903752"><span class="hs-identifier hs-var">orig_calls</span></a></span><span>
</span><span id="line-3319"></span><span>    </span><span id="local-6989586621681903755"><span class="annot"><span class="annottext">float_all :: Bool
</span><a href="#local-6989586621681903755"><span class="hs-identifier hs-var hs-var">float_all</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903759"><span class="hs-identifier hs-var">dump_set</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#intersectsVarSet"><span class="hs-operator hs-var">`intersectsVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#callDetailsFVs"><span class="hs-identifier hs-var">callDetailsFVs</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903757"><span class="hs-identifier hs-var">free_calls</span></a></span><span>
</span><span id="line-3320"></span><span>
</span><span id="line-3321"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#callsForMe"><span class="hs-identifier hs-type">callsForMe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-3322"></span><span id="callsForMe"><span class="annot"><span class="annottext">callsForMe :: Id -&gt; UsageDetails -&gt; (UsageDetails, [CallInfo])
</span><a href="GHC.Core.Opt.Specialise.html#callsForMe"><span class="hs-identifier hs-var hs-var">callsForMe</span></a></span></span><span> </span><span id="local-6989586621681903761"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903761"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681903762"><span class="annot"><span class="annottext">uds :: UsageDetails
</span><a href="#local-6989586621681903762"><span class="hs-identifier hs-var">uds</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#MkUD"><span class="hs-identifier hs-type">MkUD</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ud_binds :: UsageDetails -&gt; FloatedDictBinds
</span><a href="GHC.Core.Opt.Specialise.html#ud_binds"><span class="hs-identifier hs-var">ud_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903763"><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903763"><span class="hs-identifier hs-var">orig_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ud_calls :: UsageDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903764"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903764"><span class="hs-identifier hs-var">orig_calls</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3323"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace (&quot;callsForMe&quot;)</span><span>
</span><span id="line-3324"></span><span>    </span><span class="hs-comment">--          (vcat [ppr fn,</span><span>
</span><span id="line-3325"></span><span>    </span><span class="hs-comment">--                 text &quot;Orig dbs =&quot;     &lt;+&gt; ppr (_dictBindBndrs orig_dbs),</span><span>
</span><span id="line-3326"></span><span>    </span><span class="hs-comment">--                 text &quot;Orig calls =&quot;   &lt;+&gt; ppr orig_calls,</span><span>
</span><span id="line-3327"></span><span>    </span><span class="hs-comment">--                 text &quot;Calls for me =&quot; &lt;+&gt; ppr calls_for_me]) $</span><span>
</span><span id="line-3328"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903765"><span class="hs-identifier hs-var">uds_without_me</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903766"><span class="hs-identifier hs-var">calls_for_me</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3329"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3330"></span><span>    </span><span id="local-6989586621681903765"><span class="annot"><span class="annottext">uds_without_me :: UsageDetails
</span><a href="#local-6989586621681903765"><span class="hs-identifier hs-var hs-var">uds_without_me</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903762"><span class="hs-identifier hs-var">uds</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#ud_calls"><span class="hs-identifier hs-var">ud_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#delDVarEnv"><span class="hs-identifier hs-type">delDVarEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903764"><span class="hs-identifier hs-type">orig_calls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903761"><span class="hs-identifier hs-type">fn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3331"></span><span>    </span><span id="local-6989586621681903766"><span class="annot"><span class="annottext">calls_for_me :: [CallInfo]
</span><a href="#local-6989586621681903766"><span class="hs-identifier hs-var hs-var">calls_for_me</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CallDetails -&gt; Id -&gt; Maybe CallInfoSet
forall a. DVarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupDVarEnv"><span class="hs-identifier hs-var">lookupDVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903764"><span class="hs-identifier hs-var">orig_calls</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903761"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3332"></span><span>                        </span><span class="annot"><span class="annottext">Maybe CallInfoSet
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-3333"></span><span>                        </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681903769"><span class="annot"><span class="annottext">CallInfoSet
</span><a href="#local-6989586621681903769"><span class="hs-identifier hs-var">cis</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CallInfoSet -&gt; FloatedDictBinds -&gt; [CallInfo]
</span><a href="GHC.Core.Opt.Specialise.html#filterCalls"><span class="hs-identifier hs-var">filterCalls</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfoSet
</span><a href="#local-6989586621681903769"><span class="hs-identifier hs-var">cis</span></a></span><span> </span><span class="annot"><span class="annottext">FloatedDictBinds
</span><a href="#local-6989586621681903763"><span class="hs-identifier hs-var">orig_dbs</span></a></span><span>
</span><span id="line-3334"></span><span>         </span><span class="hs-comment">-- filterCalls: drop calls that (directly or indirectly)</span><span>
</span><span id="line-3335"></span><span>         </span><span class="hs-comment">-- refer to fn.  See Note [Avoiding loops (DFuns)]</span><span>
</span><span id="line-3336"></span><span>
</span><span id="line-3337"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-3338"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#filterCalls"><span class="hs-identifier hs-type">filterCalls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3339"></span><span class="hs-comment">-- Remove dominated calls (Note [Specialising polymorphic dictionaries])</span><span>
</span><span id="line-3340"></span><span class="hs-comment">-- and loopy DFuns (Note [Avoiding loops (DFuns)])</span><span>
</span><span id="line-3341"></span><span id="filterCalls"><span class="annot"><span class="annottext">filterCalls :: CallInfoSet -&gt; FloatedDictBinds -&gt; [CallInfo]
</span><a href="GHC.Core.Opt.Specialise.html#filterCalls"><span class="hs-identifier hs-var hs-var">filterCalls</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CIS"><span class="hs-identifier hs-type">CIS</span></a></span><span> </span><span id="local-6989586621681903770"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903770"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681903771"><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903771"><span class="hs-identifier hs-var">call_bag</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fdb_binds :: FloatedDictBinds -&gt; OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903772"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903772"><span class="hs-identifier hs-var">dbs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3342"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDFunId"><span class="hs-identifier hs-var">isDFunId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903770"><span class="hs-identifier hs-var">fn</span></a></span><span>  </span><span class="hs-comment">-- Note [Avoiding loops (DFuns)] applies only to DFuns</span><span>
</span><span id="line-3343"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CallInfo -&gt; Bool) -&gt; [CallInfo] -&gt; [CallInfo]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#filter/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfo -&gt; Bool
</span><a href="#local-6989586621681903773"><span class="hs-identifier hs-var">ok_call</span></a></span><span> </span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903774"><span class="hs-identifier hs-var">de_dupd_calls</span></a></span><span>
</span><span id="line-3344"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>         </span><span class="hs-comment">-- Do not apply it to non-DFuns</span><span>
</span><span id="line-3345"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903774"><span class="hs-identifier hs-var">de_dupd_calls</span></a></span><span>  </span><span class="hs-comment">-- See Note [Avoiding loops (non-DFuns)]</span><span>
</span><span id="line-3346"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3347"></span><span>    </span><span id="local-6989586621681903774"><span class="annot"><span class="annottext">de_dupd_calls :: [CallInfo]
</span><a href="#local-6989586621681903774"><span class="hs-identifier hs-var hs-var">de_dupd_calls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag CallInfo -&gt; [CallInfo]
</span><a href="GHC.Core.Opt.Specialise.html#remove_dups"><span class="hs-identifier hs-var">remove_dups</span></a></span><span> </span><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903771"><span class="hs-identifier hs-var">call_bag</span></a></span><span>
</span><span id="line-3348"></span><span>
</span><span id="line-3349"></span><span>    </span><span id="local-6989586621681903776"><span class="annot"><span class="annottext">dump_set :: VarSet
</span><a href="#local-6989586621681903776"><span class="hs-identifier hs-var hs-var">dump_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; DictBind -&gt; VarSet)
-&gt; VarSet -&gt; OrdList DictBind -&gt; VarSet
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldl%27/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; DictBind -&gt; VarSet
</span><a href="#local-6989586621681903778"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unitVarSet"><span class="hs-identifier hs-var">unitVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903770"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903772"><span class="hs-identifier hs-var">dbs</span></a></span><span>
</span><span id="line-3350"></span><span>      </span><span class="hs-comment">-- This dump-set could also be computed by splitDictBinds</span><span>
</span><span id="line-3351"></span><span>      </span><span class="hs-comment">--   (_,_,dump_set) = splitDictBinds dbs {fn}</span><span>
</span><span id="line-3352"></span><span>      </span><span class="hs-comment">-- But this variant is shorter</span><span>
</span><span id="line-3353"></span><span>
</span><span id="line-3354"></span><span>    </span><span id="local-6989586621681903778"><span class="annot"><span class="annottext">go :: VarSet -&gt; DictBind -&gt; VarSet
</span><a href="#local-6989586621681903778"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681903779"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903779"><span class="hs-identifier hs-var">so_far</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">db_bind :: DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903780"><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903780"><span class="hs-identifier hs-var">bind</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">db_fvs :: DictBind -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#db_fvs"><span class="hs-identifier hs-var">db_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903781"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903781"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3355"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903781"><span class="hs-identifier hs-var">fvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#intersectsVarSet"><span class="hs-operator hs-var">`intersectsVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903779"><span class="hs-identifier hs-var">so_far</span></a></span><span>
</span><span id="line-3356"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; [Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#extendVarSetList"><span class="hs-identifier hs-var">extendVarSetList</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903779"><span class="hs-identifier hs-var">so_far</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InBind -&gt; [Id]
forall b. Bind b -&gt; [b]
</span><a href="GHC.Core.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a></span><span> </span><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903780"><span class="hs-identifier hs-var">bind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3357"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903779"><span class="hs-identifier hs-var">so_far</span></a></span><span>
</span><span id="line-3358"></span><span>
</span><span id="line-3359"></span><span>    </span><span id="local-6989586621681903773"><span class="annot"><span class="annottext">ok_call :: CallInfo -&gt; Bool
</span><a href="#local-6989586621681903773"><span class="hs-identifier hs-var hs-var">ok_call</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CI"><span class="hs-identifier hs-type">CI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ci_fvs :: CallInfo -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#ci_fvs"><span class="hs-identifier hs-var">ci_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903782"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903782"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903782"><span class="hs-identifier hs-var">fvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#disjointVarSet"><span class="hs-operator hs-var">`disjointVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903776"><span class="hs-identifier hs-var">dump_set</span></a></span><span>
</span><span id="line-3360"></span><span>
</span><span id="line-3361"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#remove_dups"><span class="hs-identifier hs-type">remove_dups</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3362"></span><span class="hs-comment">-- Calls involving more generic instances beat more specific ones.</span><span>
</span><span id="line-3363"></span><span class="hs-comment">-- See (MP3) in Note [Specialising polymorphic dictionaries]</span><span>
</span><span id="line-3364"></span><span id="remove_dups"><span class="annot"><span class="annottext">remove_dups :: Bag CallInfo -&gt; [CallInfo]
</span><a href="GHC.Core.Opt.Specialise.html#remove_dups"><span class="hs-identifier hs-var hs-var">remove_dups</span></a></span></span><span> </span><span id="local-6989586621681903783"><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903783"><span class="hs-identifier hs-var">calls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CallInfo -&gt; [CallInfo] -&gt; [CallInfo])
-&gt; [CallInfo] -&gt; Bag CallInfo -&gt; [CallInfo]
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; Bag a -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfo -&gt; [CallInfo] -&gt; [CallInfo]
</span><a href="#local-6989586621681903784"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Bag CallInfo
</span><a href="#local-6989586621681903783"><span class="hs-identifier hs-var">calls</span></a></span><span>
</span><span id="line-3365"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3366"></span><span>    </span><span class="annot"><a href="#local-6989586621681903784"><span class="hs-identifier hs-type">add</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3367"></span><span>    </span><span id="local-6989586621681903784"><span class="annot"><span class="annottext">add :: CallInfo -&gt; [CallInfo] -&gt; [CallInfo]
</span><a href="#local-6989586621681903784"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span id="local-6989586621681903785"><span class="annot"><span class="annottext">CallInfo
</span><a href="#local-6989586621681903785"><span class="hs-identifier hs-var">ci</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CallInfo
</span><a href="#local-6989586621681903785"><span class="hs-identifier hs-var">ci</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-3368"></span><span>    </span><span class="annot"><a href="#local-6989586621681903784"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span id="local-6989586621681903786"><span class="annot"><span class="annottext">CallInfo
</span><a href="#local-6989586621681903786"><span class="hs-identifier hs-var">ci1</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903787"><span class="annot"><span class="annottext">CallInfo
</span><a href="#local-6989586621681903787"><span class="hs-identifier hs-var">ci2</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681903788"><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903788"><span class="hs-identifier hs-var">cis</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CallInfo
</span><a href="#local-6989586621681903787"><span class="hs-identifier hs-var">ci2</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfo -&gt; CallInfo -&gt; Bool
</span><a href="GHC.Core.Opt.Specialise.html#beats_or_same"><span class="hs-operator hs-var">`beats_or_same`</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfo
</span><a href="#local-6989586621681903786"><span class="hs-identifier hs-var">ci1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallInfo
</span><a href="#local-6989586621681903787"><span class="hs-identifier hs-var">ci2</span></a></span><span class="annot"><span class="annottext">CallInfo -&gt; [CallInfo] -&gt; [CallInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903788"><span class="hs-identifier hs-var">cis</span></a></span><span>
</span><span id="line-3369"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CallInfo
</span><a href="#local-6989586621681903786"><span class="hs-identifier hs-var">ci1</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfo -&gt; CallInfo -&gt; Bool
</span><a href="GHC.Core.Opt.Specialise.html#beats_or_same"><span class="hs-operator hs-var">`beats_or_same`</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfo
</span><a href="#local-6989586621681903787"><span class="hs-identifier hs-var">ci2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallInfo
</span><a href="#local-6989586621681903786"><span class="hs-identifier hs-var">ci1</span></a></span><span class="annot"><span class="annottext">CallInfo -&gt; [CallInfo] -&gt; [CallInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903788"><span class="hs-identifier hs-var">cis</span></a></span><span>
</span><span id="line-3370"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallInfo
</span><a href="#local-6989586621681903787"><span class="hs-identifier hs-var">ci2</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfo -&gt; [CallInfo] -&gt; [CallInfo]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">CallInfo -&gt; [CallInfo] -&gt; [CallInfo]
</span><a href="#local-6989586621681903784"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfo
</span><a href="#local-6989586621681903786"><span class="hs-identifier hs-var">ci1</span></a></span><span> </span><span class="annot"><span class="annottext">[CallInfo]
</span><a href="#local-6989586621681903788"><span class="hs-identifier hs-var">cis</span></a></span><span>
</span><span id="line-3371"></span><span>
</span><span id="line-3372"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#beats_or_same"><span class="hs-identifier hs-type">beats_or_same</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-3373"></span><span id="beats_or_same"><span class="annot"><span class="annottext">beats_or_same :: CallInfo -&gt; CallInfo -&gt; Bool
</span><a href="GHC.Core.Opt.Specialise.html#beats_or_same"><span class="hs-identifier hs-var hs-var">beats_or_same</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CI"><span class="hs-identifier hs-type">CI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ci_key :: CallInfo -&gt; [SpecArg]
</span><a href="GHC.Core.Opt.Specialise.html#ci_key"><span class="hs-identifier hs-var">ci_key</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903790"><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903790"><span class="hs-identifier hs-var">args1</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CI"><span class="hs-identifier hs-type">CI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ci_key :: CallInfo -&gt; [SpecArg]
</span><a href="GHC.Core.Opt.Specialise.html#ci_key"><span class="hs-identifier hs-var">ci_key</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903791"><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903791"><span class="hs-identifier hs-var">args2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3374"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SpecArg] -&gt; [SpecArg] -&gt; Bool
</span><a href="#local-6989586621681903792"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903790"><span class="hs-identifier hs-var">args1</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903791"><span class="hs-identifier hs-var">args2</span></a></span><span>
</span><span id="line-3375"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3376"></span><span>    </span><span id="local-6989586621681903792"><span class="annot"><span class="annottext">go :: [SpecArg] -&gt; [SpecArg] -&gt; Bool
</span><a href="#local-6989586621681903792"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3377"></span><span>    </span><span class="annot"><a href="#local-6989586621681903792"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903793"><span class="annot"><span class="annottext">SpecArg
</span><a href="#local-6989586621681903793"><span class="hs-identifier hs-var">arg1</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681903794"><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903794"><span class="hs-identifier hs-var">args1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903795"><span class="annot"><span class="annottext">SpecArg
</span><a href="#local-6989586621681903795"><span class="hs-identifier hs-var">arg2</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681903796"><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903796"><span class="hs-identifier hs-var">args2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecArg -&gt; SpecArg -&gt; Bool
</span><a href="#local-6989586621681903797"><span class="hs-identifier hs-var">go_arg</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="#local-6989586621681903793"><span class="hs-identifier hs-var">arg1</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="#local-6989586621681903795"><span class="hs-identifier hs-var">arg2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[SpecArg] -&gt; [SpecArg] -&gt; Bool
</span><a href="#local-6989586621681903792"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903794"><span class="hs-identifier hs-var">args1</span></a></span><span> </span><span class="annot"><span class="annottext">[SpecArg]
</span><a href="#local-6989586621681903796"><span class="hs-identifier hs-var">args2</span></a></span><span>
</span><span id="line-3378"></span><span>    </span><span class="annot"><a href="#local-6989586621681903792"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecArg
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[SpecArg]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3379"></span><span>
</span><span id="line-3380"></span><span>    </span><span id="local-6989586621681903797"><span class="annot"><span class="annottext">go_arg :: SpecArg -&gt; SpecArg -&gt; Bool
</span><a href="#local-6989586621681903797"><span class="hs-identifier hs-var hs-var">go_arg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecType"><span class="hs-identifier hs-type">SpecType</span></a></span><span> </span><span id="local-6989586621681903798"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903798"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecType"><span class="hs-identifier hs-type">SpecType</span></a></span><span> </span><span id="local-6989586621681903799"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903799"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Subst -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Maybe.html#isJust/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; Kind -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTy"><span class="hs-identifier hs-var">tcMatchTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903798"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903799"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3381"></span><span>    </span><span class="annot"><a href="#local-6989586621681903797"><span class="hs-identifier hs-var">go_arg</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecType"><span class="hs-identifier hs-var">UnspecType</span></a></span><span>     </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecType"><span class="hs-identifier hs-var">UnspecType</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3382"></span><span>    </span><span class="annot"><a href="#local-6989586621681903797"><span class="hs-identifier hs-var">go_arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecDict"><span class="hs-identifier hs-type">SpecDict</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecDict"><span class="hs-identifier hs-type">SpecDict</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3383"></span><span>    </span><span class="annot"><a href="#local-6989586621681903797"><span class="hs-identifier hs-var">go_arg</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecArg"><span class="hs-identifier hs-var">UnspecArg</span></a></span><span>      </span><span class="annot"><span class="annottext">SpecArg
</span><a href="GHC.Core.Opt.Specialise.html#UnspecArg"><span class="hs-identifier hs-var">UnspecArg</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-3384"></span><span>    </span><span class="annot"><a href="#local-6989586621681903797"><span class="hs-identifier hs-var">go_arg</span></a></span><span> </span><span class="annot"><span class="annottext">SpecArg
</span><span class="hs-identifier">_</span></span><span>              </span><span class="annot"><span class="annottext">SpecArg
</span><span class="hs-identifier">_</span></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-3385"></span><span>
</span><span id="line-3386"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-3387"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#splitDictBinds"><span class="hs-identifier hs-type">splitDictBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FloatedDictBinds"><span class="hs-identifier hs-type">FloatedDictBinds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3388"></span><span class="hs-comment">-- splitDictBinds dbs bndrs returns</span><span>
</span><span id="line-3389"></span><span class="hs-comment">--   (free_dbs, dump_dbs, dump_set)</span><span>
</span><span id="line-3390"></span><span class="hs-comment">-- where</span><span>
</span><span id="line-3391"></span><span class="hs-comment">--   * dump_dbs depends, transitively on bndrs</span><span>
</span><span id="line-3392"></span><span class="hs-comment">--   * free_dbs does not depend on bndrs</span><span>
</span><span id="line-3393"></span><span class="hs-comment">--   * dump_set = bndrs `union` bndrs(dump_dbs)</span><span>
</span><span id="line-3394"></span><span id="splitDictBinds"><span class="annot"><span class="annottext">splitDictBinds :: FloatedDictBinds
-&gt; VarSet -&gt; (FloatedDictBinds, OrdList DictBind, VarSet)
</span><a href="GHC.Core.Opt.Specialise.html#splitDictBinds"><span class="hs-identifier hs-var hs-var">splitDictBinds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fdb_binds :: FloatedDictBinds -&gt; OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903800"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903800"><span class="hs-identifier hs-var">dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fdb_bndrs :: FloatedDictBinds -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903801"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903801"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903802"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903802"><span class="hs-identifier hs-var">bndr_set</span></a></span></span><span>
</span><span id="line-3395"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#FDB"><span class="hs-identifier hs-type">FDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fdb_binds :: OrdList DictBind
</span><a href="GHC.Core.Opt.Specialise.html#fdb_binds"><span class="hs-identifier hs-var">fdb_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903803"><span class="hs-identifier hs-var">free_dbs</span></a></span><span>
</span><span id="line-3396"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fdb_bndrs :: VarSet
</span><a href="GHC.Core.Opt.Specialise.html#fdb_bndrs"><span class="hs-identifier hs-var">fdb_bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903801"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#minusVarSet"><span class="hs-operator hs-var">`minusVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903805"><span class="hs-identifier hs-var">dump_set</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3397"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903806"><span class="hs-identifier hs-var">dump_dbs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903805"><span class="hs-identifier hs-var">dump_set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3398"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-3399"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681903803"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903803"><span class="hs-identifier hs-var">free_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903806"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903806"><span class="hs-identifier hs-var">dump_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903805"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903805"><span class="hs-identifier hs-var">dump_set</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-3400"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((OrdList DictBind, OrdList DictBind, VarSet)
 -&gt; DictBind -&gt; (OrdList DictBind, OrdList DictBind, VarSet))
-&gt; (OrdList DictBind, OrdList DictBind, VarSet)
-&gt; OrdList DictBind
-&gt; (OrdList DictBind, OrdList DictBind, VarSet)
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; OrdList a -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldl%27/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">(OrdList DictBind, OrdList DictBind, VarSet)
-&gt; DictBind -&gt; (OrdList DictBind, OrdList DictBind, VarSet)
</span><a href="#local-6989586621681903807"><span class="hs-identifier hs-var">split_db</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList DictBind
forall a. OrdList a
</span><a href="GHC.Data.OrdList.html#nilOL"><span class="hs-identifier hs-var">nilOL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
forall a. OrdList a
</span><a href="GHC.Data.OrdList.html#nilOL"><span class="hs-identifier hs-var">nilOL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903802"><span class="hs-identifier hs-var">bndr_set</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903800"><span class="hs-identifier hs-var">dbs</span></a></span><span>
</span><span id="line-3401"></span><span>                </span><span class="hs-comment">-- Important that it's foldl' not foldr;</span><span>
</span><span id="line-3402"></span><span>                </span><span class="hs-comment">-- we're accumulating the set of dumped ids in dump_set</span><span>
</span><span id="line-3403"></span><span>
</span><span id="line-3404"></span><span>    </span><span id="local-6989586621681903807"><span class="annot"><span class="annottext">split_db :: (OrdList DictBind, OrdList DictBind, VarSet)
-&gt; DictBind -&gt; (OrdList DictBind, OrdList DictBind, VarSet)
</span><a href="#local-6989586621681903807"><span class="hs-identifier hs-var hs-var">split_db</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903808"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903808"><span class="hs-identifier hs-var">free_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903809"><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903809"><span class="hs-identifier hs-var">dump_dbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903810"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903810"><span class="hs-identifier hs-var">dump_idset</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903811"><span class="annot"><span class="annottext">DictBind
</span><a href="#local-6989586621681903811"><span class="hs-identifier hs-var">db</span></a></span></span><span>
</span><span id="line-3405"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#DB"><span class="hs-identifier hs-type">DB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">db_bind :: DictBind -&gt; InBind
</span><a href="GHC.Core.Opt.Specialise.html#db_bind"><span class="hs-identifier hs-var">db_bind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903812"><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903812"><span class="hs-identifier hs-var">bind</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">db_fvs :: DictBind -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#db_fvs"><span class="hs-identifier hs-var">db_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903813"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903813"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DictBind
</span><a href="#local-6989586621681903811"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-3406"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903810"><span class="hs-identifier hs-var">dump_idset</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#intersectsVarSet"><span class="hs-operator hs-var">`intersectsVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903813"><span class="hs-identifier hs-var">fvs</span></a></span><span>     </span><span class="hs-comment">-- Dump it</span><span>
</span><span id="line-3407"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903808"><span class="hs-identifier hs-var">free_dbs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903809"><span class="hs-identifier hs-var">dump_dbs</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind -&gt; DictBind -&gt; OrdList DictBind
forall a. OrdList a -&gt; a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#snocOL"><span class="hs-operator hs-var">`snocOL`</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind
</span><a href="#local-6989586621681903811"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3408"></span><span>           </span><span class="annot"><span class="annottext">VarSet -&gt; [Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#extendVarSetList"><span class="hs-identifier hs-var">extendVarSetList</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903810"><span class="hs-identifier hs-var">dump_idset</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InBind -&gt; [Id]
forall b. Bind b -&gt; [b]
</span><a href="GHC.Core.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a></span><span> </span><span class="annot"><span class="annottext">InBind
</span><a href="#local-6989586621681903812"><span class="hs-identifier hs-var">bind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-3409"></span><span>
</span><span id="line-3410"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>     </span><span class="hs-comment">-- Don't dump it</span><span>
</span><span id="line-3411"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903808"><span class="hs-identifier hs-var">free_dbs</span></a></span><span> </span><span class="annot"><span class="annottext">OrdList DictBind -&gt; DictBind -&gt; OrdList DictBind
forall a. OrdList a -&gt; a -&gt; OrdList a
</span><a href="GHC.Data.OrdList.html#snocOL"><span class="hs-operator hs-var">`snocOL`</span></a></span><span> </span><span class="annot"><span class="annottext">DictBind
</span><a href="#local-6989586621681903811"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OrdList DictBind
</span><a href="#local-6989586621681903809"><span class="hs-identifier hs-var">dump_dbs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903810"><span class="hs-identifier hs-var">dump_idset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3412"></span><span>
</span><span id="line-3413"></span><span>
</span><span id="line-3414"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-3415"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#deleteCallsMentioning"><span class="hs-identifier hs-type">deleteCallsMentioning</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a></span><span>
</span><span id="line-3416"></span><span class="hs-comment">-- Remove calls mentioning any Id in bndrs</span><span>
</span><span id="line-3417"></span><span class="hs-comment">-- NB: The call is allowed to mention TyVars in bndrs</span><span>
</span><span id="line-3418"></span><span class="hs-comment">--     Note [Specialising polymorphic dictionaries]</span><span>
</span><span id="line-3419"></span><span class="hs-comment">--     ci_fvs are just the free /Ids/</span><span>
</span><span id="line-3420"></span><span id="deleteCallsMentioning"><span class="annot"><span class="annottext">deleteCallsMentioning :: VarSet -&gt; CallDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#deleteCallsMentioning"><span class="hs-identifier hs-var hs-var">deleteCallsMentioning</span></a></span></span><span> </span><span id="local-6989586621681903814"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903814"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621681903815"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903815"><span class="hs-identifier hs-var">calls</span></a></span></span><span>
</span><span id="line-3421"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CallInfoSet -&gt; CallInfoSet) -&gt; CallDetails -&gt; CallDetails
forall a b. (a -&gt; b) -&gt; DVarEnv a -&gt; DVarEnv b
</span><a href="GHC.Types.Var.Env.html#mapDVarEnv"><span class="hs-identifier hs-var">mapDVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CallInfo -&gt; Bool) -&gt; CallInfoSet -&gt; CallInfoSet
</span><a href="GHC.Core.Opt.Specialise.html#ciSetFilter"><span class="hs-identifier hs-var">ciSetFilter</span></a></span><span> </span><span class="annot"><span class="annottext">CallInfo -&gt; Bool
</span><a href="#local-6989586621681903817"><span class="hs-identifier hs-var">keep_call</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903815"><span class="hs-identifier hs-var">calls</span></a></span><span>
</span><span id="line-3422"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-3423"></span><span>    </span><span id="local-6989586621681903817"><span class="annot"><span class="annottext">keep_call :: CallInfo -&gt; Bool
</span><a href="#local-6989586621681903817"><span class="hs-identifier hs-var hs-var">keep_call</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CI"><span class="hs-identifier hs-type">CI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ci_fvs :: CallInfo -&gt; VarSet
</span><a href="GHC.Core.Opt.Specialise.html#ci_fvs"><span class="hs-identifier hs-var">ci_fvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903818"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903818"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903818"><span class="hs-identifier hs-var">fvs</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#disjointVarSet"><span class="hs-operator hs-var">`disjointVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681903814"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-3424"></span><span>
</span><span id="line-3425"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#deleteCallsFor"><span class="hs-identifier hs-type">deleteCallsFor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a></span><span>
</span><span id="line-3426"></span><span class="hs-comment">-- Remove calls *for* bndrs</span><span>
</span><span id="line-3427"></span><span id="deleteCallsFor"><span class="annot"><span class="annottext">deleteCallsFor :: [Id] -&gt; CallDetails -&gt; CallDetails
</span><a href="GHC.Core.Opt.Specialise.html#deleteCallsFor"><span class="hs-identifier hs-var hs-var">deleteCallsFor</span></a></span></span><span> </span><span id="local-6989586621681903819"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903819"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621681903820"><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903820"><span class="hs-identifier hs-var">calls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallDetails -&gt; [Id] -&gt; CallDetails
forall a. DVarEnv a -&gt; [Id] -&gt; DVarEnv a
</span><a href="GHC.Types.Var.Env.html#delDVarEnvList"><span class="hs-identifier hs-var">delDVarEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">CallDetails
</span><a href="#local-6989586621681903820"><span class="hs-identifier hs-var">calls</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903819"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-3428"></span><span>
</span><span id="line-3429"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsubsection{Boring helper functions}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-3436"></span><span>
</span><span id="line-3437"></span><span class="hs-keyword">type</span><span> </span><span id="SpecM"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-var">SpecM</span></a></span></span><span> </span><span id="local-6989586621681903822"><span class="annot"><a href="#local-6989586621681903822"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903822"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-3438"></span><span>
</span><span id="line-3439"></span><span id="local-6989586621681902284"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#runSpecM"><span class="hs-identifier hs-type">runSpecM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681902284"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681902284"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-3440"></span><span id="runSpecM"><span class="annot"><span class="annottext">runSpecM :: forall a. SpecM a -&gt; CoreM a
</span><a href="GHC.Core.Opt.Specialise.html#runSpecM"><span class="hs-identifier hs-var hs-var">runSpecM</span></a></span></span><span> </span><span id="local-6989586621681903827"><span class="annot"><span class="annottext">SpecM a
</span><a href="#local-6989586621681903827"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-3441"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681903828"><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621681903828"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreM UniqSupply
forall (m :: * -&gt; *). MonadUnique m =&gt; m UniqSupply
</span><a href="GHC.Types.Unique.Supply.html#getUniqueSupplyM"><span class="hs-identifier hs-var">getUniqueSupplyM</span></a></span><span>
</span><span id="line-3442"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">a -&gt; CoreM a
forall a. a -&gt; CoreM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UniqSupply -&gt; SpecM a -&gt; a
forall a. UniqSupply -&gt; UniqSM a -&gt; a
</span><a href="GHC.Types.Unique.Supply.html#initUs_"><span class="hs-identifier hs-var">initUs_</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621681903828"><span class="hs-identifier hs-var">us</span></a></span><span> </span><span class="annot"><span class="annottext">SpecM a
</span><a href="#local-6989586621681903827"><span class="hs-identifier hs-var">thing_inside</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3443"></span><span>
</span><span id="line-3444"></span><span id="local-6989586621681902336"><span id="local-6989586621681902337"><span class="annot"><a href="GHC.Core.Opt.Specialise.html#mapAndCombineSM"><span class="hs-identifier hs-type">mapAndCombineSM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681902336"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681902337"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681902336"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681902337"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-3445"></span><span id="mapAndCombineSM"><span class="annot"><span class="annottext">mapAndCombineSM :: forall a b.
(a -&gt; SpecM (b, UsageDetails)) -&gt; [a] -&gt; SpecM ([b], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#mapAndCombineSM"><span class="hs-identifier hs-var hs-var">mapAndCombineSM</span></a></span></span><span> </span><span class="annot"><span class="annottext">a -&gt; SpecM (b, UsageDetails)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([b], UsageDetails) -&gt; UniqSM ([b], UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3446"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#mapAndCombineSM"><span class="hs-identifier hs-var">mapAndCombineSM</span></a></span><span> </span><span id="local-6989586621681903835"><span class="annot"><span class="annottext">a -&gt; SpecM (b, UsageDetails)
</span><a href="#local-6989586621681903835"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903836"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681903836"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681903837"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621681903837"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903838"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681903838"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903839"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903839"><span class="hs-identifier hs-var">uds1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; SpecM (b, UsageDetails)
</span><a href="#local-6989586621681903835"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681903836"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-3447"></span><span>                              </span><span class="hs-special">(</span><span id="local-6989586621681903840"><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621681903840"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903841"><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903841"><span class="hs-identifier hs-var">uds2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(a -&gt; SpecM (b, UsageDetails)) -&gt; [a] -&gt; UniqSM ([b], UsageDetails)
forall a b.
(a -&gt; SpecM (b, UsageDetails)) -&gt; [a] -&gt; SpecM ([b], UsageDetails)
</span><a href="GHC.Core.Opt.Specialise.html#mapAndCombineSM"><span class="hs-identifier hs-var">mapAndCombineSM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; SpecM (b, UsageDetails)
</span><a href="#local-6989586621681903835"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621681903837"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-3448"></span><span>                              </span><span class="annot"><span class="annottext">([b], UsageDetails) -&gt; UniqSM ([b], UsageDetails)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681903838"><span class="hs-identifier hs-var">y</span></a></span><span class="annot"><span class="annottext">b -&gt; [b] -&gt; [b]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621681903840"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903839"><span class="hs-identifier hs-var">uds1</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails -&gt; UsageDetails -&gt; UsageDetails
</span><a href="GHC.Core.Opt.Specialise.html#thenUDs"><span class="hs-operator hs-var">`thenUDs`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageDetails
</span><a href="#local-6989586621681903841"><span class="hs-identifier hs-var">uds2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3449"></span><span>
</span><span id="line-3450"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#extendTvSubst"><span class="hs-identifier hs-type">extendTvSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>
</span><span id="line-3451"></span><span id="extendTvSubst"><span class="annot"><span class="annottext">extendTvSubst :: SpecEnv -&gt; Id -&gt; Kind -&gt; SpecEnv
</span><a href="GHC.Core.Opt.Specialise.html#extendTvSubst"><span class="hs-identifier hs-var hs-var">extendTvSubst</span></a></span></span><span> </span><span id="local-6989586621681903843"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903843"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903844"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903844"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621681903845"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903845"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-3452"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903843"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendTvSubst"><span class="hs-identifier hs-type">Core.extendTvSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903843"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681903844"><span class="hs-identifier hs-type">tv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903845"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3453"></span><span>
</span><span id="line-3454"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#extendInScope"><span class="hs-identifier hs-type">extendInScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>
</span><span id="line-3455"></span><span id="extendInScope"><span class="annot"><span class="annottext">extendInScope :: SpecEnv -&gt; Id -&gt; SpecEnv
</span><a href="GHC.Core.Opt.Specialise.html#extendInScope"><span class="hs-identifier hs-var hs-var">extendInScope</span></a></span></span><span> </span><span id="local-6989586621681903846"><span class="annot"><span class="annottext">env :: SpecEnv
</span><a href="#local-6989586621681903846"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SE"><span class="hs-identifier hs-type">SE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">se_subst :: SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903847"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903847"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903848"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903848"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-3456"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903846"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903847"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendSubstInScope"><span class="hs-operator hs-type">`Core.extendSubstInScope`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903848"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3457"></span><span>
</span><span id="line-3458"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#zapSubst"><span class="hs-identifier hs-type">zapSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span>
</span><span id="line-3459"></span><span id="zapSubst"><span class="annot"><span class="annottext">zapSubst :: SpecEnv -&gt; SpecEnv
</span><a href="GHC.Core.Opt.Specialise.html#zapSubst"><span class="hs-identifier hs-var hs-var">zapSubst</span></a></span></span><span> </span><span id="local-6989586621681903849"><span class="annot"><span class="annottext">env :: SpecEnv
</span><a href="#local-6989586621681903849"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SE"><span class="hs-identifier hs-type">SE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">se_subst :: SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903850"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903850"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-3460"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903849"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#zapSubst"><span class="hs-identifier hs-type">Core.zapSubst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903850"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3461"></span><span>
</span><span id="line-3462"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#substTy"><span class="hs-identifier hs-type">substTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-3463"></span><span id="substTy"><span class="annot"><span class="annottext">substTy :: SpecEnv -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.Opt.Specialise.html#substTy"><span class="hs-identifier hs-var hs-var">substTy</span></a></span></span><span> </span><span id="local-6989586621681903851"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903851"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903852"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903852"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903851"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903852"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-3464"></span><span>
</span><span id="line-3465"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#substCo"><span class="hs-identifier hs-type">substCo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-3466"></span><span id="substCo"><span class="annot"><span class="annottext">substCo :: SpecEnv -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Opt.Specialise.html#substCo"><span class="hs-identifier hs-var hs-var">substCo</span></a></span></span><span> </span><span id="local-6989586621681903854"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903854"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903855"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681903855"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">Core.substCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903854"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681903855"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-3467"></span><span>
</span><span id="line-3468"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#substBndr"><span class="hs-identifier hs-type">substBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3469"></span><span id="substBndr"><span class="annot"><span class="annottext">substBndr :: SpecEnv -&gt; Id -&gt; (SpecEnv, Id)
</span><a href="GHC.Core.Opt.Specialise.html#substBndr"><span class="hs-identifier hs-var hs-var">substBndr</span></a></span></span><span> </span><span id="local-6989586621681903856"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903856"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903857"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903857"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-var">Core.substBndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903856"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903857"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3470"></span><span>                      </span><span class="hs-special">(</span><span id="local-6989586621681903859"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903859"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903860"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903860"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903856"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903859"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903860"><span class="hs-identifier hs-var">bs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3471"></span><span>
</span><span id="line-3472"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#substBndrs"><span class="hs-identifier hs-type">substBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-3473"></span><span id="substBndrs"><span class="annot"><span class="annottext">substBndrs :: SpecEnv -&gt; [Id] -&gt; (SpecEnv, [Id])
</span><a href="GHC.Core.Opt.Specialise.html#substBndrs"><span class="hs-identifier hs-var hs-var">substBndrs</span></a></span></span><span> </span><span id="local-6989586621681903861"><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903861"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681903862"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903862"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [Id] -&gt; (Subst, [Id])
forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f Id -&gt; (Subst, f Id)
</span><a href="GHC.Core.Subst.html#substBndrs"><span class="hs-identifier hs-var">Core.substBndrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903861"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903862"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-3474"></span><span>                      </span><span class="hs-special">(</span><span id="local-6989586621681903864"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903864"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903865"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903865"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903861"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903864"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903865"><span class="hs-identifier hs-var">bs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3475"></span><span>
</span><span id="line-3476"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#cloneBndrSM"><span class="hs-identifier hs-type">cloneBndrSM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3477"></span><span class="hs-comment">-- Clone the binders of the bind; return new bind with the cloned binders</span><span>
</span><span id="line-3478"></span><span class="hs-comment">-- Return the substitution to use for RHSs, and the one to use for the body</span><span>
</span><span id="line-3479"></span><span class="hs-comment">-- Discards non-Stable unfoldings</span><span>
</span><span id="line-3480"></span><span id="cloneBndrSM"><span class="annot"><span class="annottext">cloneBndrSM :: SpecEnv -&gt; Id -&gt; UniqSM (SpecEnv, Id)
</span><a href="GHC.Core.Opt.Specialise.html#cloneBndrSM"><span class="hs-identifier hs-var hs-var">cloneBndrSM</span></a></span></span><span> </span><span id="local-6989586621681903866"><span class="annot"><span class="annottext">env :: SpecEnv
</span><a href="#local-6989586621681903866"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SE"><span class="hs-identifier hs-type">SE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">se_subst :: SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903867"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903867"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903868"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903868"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-3481"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681903869"><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621681903869"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqSM UniqSupply
forall (m :: * -&gt; *). MonadUnique m =&gt; m UniqSupply
</span><a href="GHC.Types.Unique.Supply.html#getUniqueSupplyM"><span class="hs-identifier hs-var">getUniqueSupplyM</span></a></span><span>
</span><span id="line-3482"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903870"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903870"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903871"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903871"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; UniqSupply -&gt; Id -&gt; (Subst, Id)
</span><a href="GHC.Core.Subst.html#cloneIdBndr"><span class="hs-identifier hs-var">Core.cloneIdBndr</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903867"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621681903869"><span class="hs-identifier hs-var">us</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903868"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-3483"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(SpecEnv, Id) -&gt; UniqSM (SpecEnv, Id)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903866"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903870"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903871"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3484"></span><span>
</span><span id="line-3485"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#cloneRecBndrsSM"><span class="hs-identifier hs-type">cloneRecBndrsSM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-3486"></span><span id="cloneRecBndrsSM"><span class="annot"><span class="annottext">cloneRecBndrsSM :: SpecEnv -&gt; [Id] -&gt; UniqSM (SpecEnv, [Id])
</span><a href="GHC.Core.Opt.Specialise.html#cloneRecBndrsSM"><span class="hs-identifier hs-var hs-var">cloneRecBndrsSM</span></a></span></span><span> </span><span id="local-6989586621681903873"><span class="annot"><span class="annottext">env :: SpecEnv
</span><a href="#local-6989586621681903873"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SE"><span class="hs-identifier hs-type">SE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">se_subst :: SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903874"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903874"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903875"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903875"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span>
</span><span id="line-3487"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681903876"><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621681903876"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqSM UniqSupply
forall (m :: * -&gt; *). MonadUnique m =&gt; m UniqSupply
</span><a href="GHC.Types.Unique.Supply.html#getUniqueSupplyM"><span class="hs-identifier hs-var">getUniqueSupplyM</span></a></span><span>
</span><span id="line-3488"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681903877"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903877"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681903878"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903878"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; UniqSupply -&gt; [Id] -&gt; (Subst, [Id])
</span><a href="GHC.Core.Subst.html#cloneRecIdBndrs"><span class="hs-identifier hs-var">Core.cloneRecIdBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903874"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621681903876"><span class="hs-identifier hs-var">us</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903875"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-3489"></span><span>             </span><span id="local-6989586621681903880"><span class="annot"><span class="annottext">env' :: SpecEnv
</span><a href="#local-6989586621681903880"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903877"><span class="hs-identifier hs-type">subst'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3490"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(SpecEnv, [Id]) -&gt; UniqSM (SpecEnv, [Id])
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903880"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681903878"><span class="hs-identifier hs-var">bndrs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3491"></span><span>
</span><span id="line-3492"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#newDictBndr"><span class="hs-identifier hs-type">newDictBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3493"></span><span class="hs-comment">-- Make up completely fresh binders for the dictionaries</span><span>
</span><span id="line-3494"></span><span class="hs-comment">-- Their bindings are going to float outwards</span><span>
</span><span id="line-3495"></span><span id="newDictBndr"><span class="annot"><span class="annottext">newDictBndr :: SpecEnv -&gt; Id -&gt; UniqSM (SpecEnv, Id)
</span><a href="GHC.Core.Opt.Specialise.html#newDictBndr"><span class="hs-identifier hs-var hs-var">newDictBndr</span></a></span></span><span> </span><span id="local-6989586621681903881"><span class="annot"><span class="annottext">env :: SpecEnv
</span><a href="#local-6989586621681903881"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SE"><span class="hs-identifier hs-type">SE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">se_subst :: SpecEnv -&gt; Subst
</span><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681903882"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903882"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681903883"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903883"><span class="hs-identifier hs-var">b</span></a></span></span><span>
</span><span id="line-3496"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681903884"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681903884"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqSM Unique
forall (m :: * -&gt; *). MonadUnique m =&gt; m Unique
</span><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a></span><span>
</span><span id="line-3497"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681903885"><span class="annot"><span class="annottext">n :: Name
</span><a href="#local-6989586621681903885"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903883"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-3498"></span><span>             </span><span id="local-6989586621681903886"><span class="annot"><span class="annottext">ty' :: Kind
</span><a href="#local-6989586621681903886"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Kind -&gt; Kind
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681903882"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Kind
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903883"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3499"></span><span>             </span><span id="local-6989586621681903887"><span class="annot"><span class="annottext">b' :: Id
</span><a href="#local-6989586621681903887"><span class="hs-identifier hs-var hs-var">b'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; Unique -&gt; Kind -&gt; Kind -&gt; SrcSpan -&gt; Id
</span><a href="GHC.Types.Id.html#mkUserLocal"><span class="hs-identifier hs-var">mkUserLocal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; OccName
</span><a href="GHC.Types.Name.html#nameOccName"><span class="hs-identifier hs-var">nameOccName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681903885"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681903884"><span class="hs-identifier hs-var">uniq</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903886"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SrcSpan
forall a. NamedThing a =&gt; a -&gt; SrcSpan
</span><a href="GHC.Types.Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681903885"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3500"></span><span>             </span><span id="local-6989586621681903890"><span class="annot"><span class="annottext">env' :: SpecEnv
</span><a href="#local-6989586621681903890"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903881"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#se_subst"><span class="hs-identifier hs-var">se_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681903882"><span class="hs-identifier hs-type">subst</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#extendSubstInScope"><span class="hs-operator hs-type">`Core.extendSubstInScope`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681903887"><span class="hs-identifier hs-type">b'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3501"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(SpecEnv, Id) -&gt; UniqSM (SpecEnv, Id)
forall a. a -&gt; UniqSM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpecEnv
</span><a href="#local-6989586621681903890"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681903887"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3502"></span><span>
</span><span id="line-3503"></span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#newSpecIdSM"><span class="hs-identifier hs-type">newSpecIdSM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#IdDetails"><span class="hs-identifier hs-type">IdDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#IdInfo"><span class="hs-identifier hs-type">IdInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-3504"></span><span>    </span><span class="hs-comment">-- Give the new Id a similar occurrence name to the old one</span><span>
</span><span id="line-3505"></span><span id="newSpecIdSM"><span class="annot"><span class="annottext">newSpecIdSM :: Name -&gt; Kind -&gt; IdDetails -&gt; IdInfo -&gt; UniqSM Id
</span><a href="GHC.Core.Opt.Specialise.html#newSpecIdSM"><span class="hs-identifier hs-var hs-var">newSpecIdSM</span></a></span></span><span> </span><span id="local-6989586621681903891"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681903891"><span class="hs-identifier hs-var">old_name</span></a></span></span><span> </span><span id="local-6989586621681903892"><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903892"><span class="hs-identifier hs-var">new_ty</span></a></span></span><span> </span><span id="local-6989586621681903893"><span class="annot"><span class="annottext">IdDetails
</span><a href="#local-6989586621681903893"><span class="hs-identifier hs-var">details</span></a></span></span><span> </span><span id="local-6989586621681903894"><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681903894"><span class="hs-identifier hs-var">info</span></a></span></span><span>
</span><span id="line-3506"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681903895"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681903895"><span class="hs-identifier hs-var">uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqSM Unique
forall (m :: * -&gt; *). MonadUnique m =&gt; m Unique
</span><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a></span><span>
</span><span id="line-3507"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681903896"><span class="annot"><span class="annottext">new_occ :: OccName
</span><a href="#local-6989586621681903896"><span class="hs-identifier hs-var hs-var">new_occ</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; OccName
</span><a href="GHC.Types.Name.Occurrence.html#mkSpecOcc"><span class="hs-identifier hs-var">mkSpecOcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; OccName
</span><a href="GHC.Types.Name.html#nameOccName"><span class="hs-identifier hs-var">nameOccName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681903891"><span class="hs-identifier hs-var">old_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3508"></span><span>              </span><span id="local-6989586621681903898"><span class="annot"><span class="annottext">new_name :: Name
</span><a href="#local-6989586621681903898"><span class="hs-identifier hs-var hs-var">new_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; OccName -&gt; SrcSpan -&gt; Name
</span><a href="GHC.Types.Name.html#mkInternalName"><span class="hs-identifier hs-var">mkInternalName</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681903895"><span class="hs-identifier hs-var">uniq</span></a></span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621681903896"><span class="hs-identifier hs-var">new_occ</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SrcSpan
forall a. NamedThing a =&gt; a -&gt; SrcSpan
</span><a href="GHC.Types.Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681903891"><span class="hs-identifier hs-var">old_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-3509"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; UniqSM Id
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Id -&gt; Id
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Kind -&gt; Bool
</span><a href="GHC.Core.Type.html#isCoVarType"><span class="hs-identifier hs-var">isCoVarType</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903892"><span class="hs-identifier hs-var">new_ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; Id -&gt; Id
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-3510"></span><span>                  </span><span class="annot"><span class="annottext">IdDetails -&gt; Name -&gt; Kind -&gt; Kind -&gt; IdInfo -&gt; Id
</span><a href="GHC.Types.Var.html#mkLocalVar"><span class="hs-identifier hs-var">mkLocalVar</span></a></span><span> </span><span class="annot"><span class="annottext">IdDetails
</span><a href="#local-6989586621681903893"><span class="hs-identifier hs-var">details</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681903898"><span class="hs-identifier hs-var">new_name</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="GHC.Core.Type.html#ManyTy"><span class="hs-identifier hs-var">ManyTy</span></a></span><span> </span><span class="annot"><span class="annottext">Kind
</span><a href="#local-6989586621681903892"><span class="hs-identifier hs-var">new_ty</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681903894"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-3511"></span><span>
</span><span id="line-3512"></span><span class="hs-comment">{-
                Old (but interesting) stuff about unboxed bindings
                ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

What should we do when a value is specialised to a *strict* unboxed value?

        map_*_* f (x:xs) = let h = f x
                               t = map f xs
                           in h:t

Could convert let to case:

        map_*_Int# f (x:xs) = case f x of h# -&gt;
                              let t = map f xs
                              in h#:t

This may be undesirable since it forces evaluation here, but the value
may not be used in all branches of the body. In the general case this
transformation is impossible since the mutual recursion in a letrec
cannot be expressed as a case.

There is also a problem with top-level unboxed values, since our
implementation cannot handle unboxed values at the top level.

Solution: Lift the binding of the unboxed value and extract it when it
is used:

        map_*_Int# f (x:xs) = let h = case (f x) of h# -&gt; _Lift h#
                                  t = map f xs
                              in case h of
                                 _Lift h# -&gt; h#:t

Now give it to the simplifier and the _Lifting will be optimised away.

The benefit is that we have given the specialised &quot;unboxed&quot; values a
very simple lifted semantics and then leave it up to the simplifier to
optimise it --- knowing that the overheads will be removed in nearly
all cases.

In particular, the value will only be evaluated in the branches of the
program which use it, rather than being forced at the point where the
value is bound. For example:

        filtermap_*_* p f (x:xs)
          = let h = f x
                t = ...
            in case p x of
                True  -&gt; h:t
                False -&gt; t
   ==&gt;
        filtermap_*_Int# p f (x:xs)
          = let h = case (f x) of h# -&gt; _Lift h#
                t = ...
            in case p x of
                True  -&gt; case h of _Lift h#
                           -&gt; h#:t
                False -&gt; t

The binding for h can still be inlined in the one branch and the
_Lifting eliminated.


Question: When won't the _Lifting be eliminated?

Answer: When they at the top-level (where it is necessary) or when
inlining would duplicate work (or possibly code depending on
options). However, the _Lifting will still be eliminated if the
strictness analyser deems the lifted binding strict.
-}</span><span>
</span><span id="line-3581"></span></pre></body></html>