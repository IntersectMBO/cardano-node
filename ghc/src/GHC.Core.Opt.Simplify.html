<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Core.Opt.Simplify</span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#SimplifyExprOpts"><span class="hs-identifier">SimplifyExprOpts</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#SimplifyOpts"><span class="hs-identifier">SimplifyOpts</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#simplifyExpr"><span class="hs-identifier">simplifyExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#simplifyPgm"><span class="hs-identifier">simplifyPgm</span></a></span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html"><span class="hs-identifier">GHC.Driver.Flags</span></a></span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html"><span class="hs-identifier">GHC.Core.Rules</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html"><span class="hs-identifier">GHC.Core.Ppr</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html#pprCoreBindings"><span class="hs-identifier">pprCoreBindings</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Ppr.html#pprCoreExpr"><span class="hs-identifier">pprCoreExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html"><span class="hs-identifier">GHC.Core.Opt.OccurAnal</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occurAnalysePgm"><span class="hs-identifier">occurAnalysePgm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier">occurAnalyseExpr</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Stats.html"><span class="hs-identifier">GHC.Core.Stats</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Stats.html#coreBindsSize"><span class="hs-identifier">coreBindsSize</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Stats.html#coreBindsStats"><span class="hs-identifier">coreBindsStats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Stats.html#exprSize"><span class="hs-identifier">exprSize</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkTicks"><span class="hs-identifier">mkTicks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#stripTicksTop"><span class="hs-identifier">stripTicksTop</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Lint.html"><span class="hs-identifier">GHC.Core.Lint</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Lint.html#LintPassResultConfig"><span class="hs-identifier">LintPassResultConfig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Lint.html#dumpPassResult"><span class="hs-identifier">dumpPassResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Lint.html#lintPassResult"><span class="hs-identifier">lintPassResult</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Iteration</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTopBinds"><span class="hs-identifier">simplTopBinds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExpr"><span class="hs-identifier">simplExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Iteration.html#simplImpRules"><span class="hs-identifier">simplImpRules</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Utils</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#activeRule"><span class="hs-identifier">activeRule</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Utils.html#activeUnfolding"><span class="hs-identifier">activeUnfolding</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Env</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html"><span class="hs-identifier">GHC.Core.Opt.Simplify.Monad</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Stats.html"><span class="hs-identifier">GHC.Core.Opt.Stats</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Stats.html#simplCountN"><span class="hs-identifier">simplCountN</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html"><span class="hs-identifier">GHC.Core.FamInstEnv</span></a></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Error.html"><span class="hs-identifier">GHC.Utils.Error</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.Error.html#withTiming"><span class="hs-identifier">withTiming</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html"><span class="hs-identifier">GHC.Utils.Logger</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Logger</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Constants.html"><span class="hs-identifier">GHC.Utils.Constants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier">debugIsOn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Env.html"><span class="hs-identifier">GHC.Unit.Env</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Unit.Env.html#UnitEnv"><span class="hs-identifier">UnitEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Unit.Env.html#ueEPS"><span class="hs-identifier">ueEPS</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.External.html"><span class="hs-identifier">GHC.Unit.External</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html"><span class="hs-identifier">GHC.Unit.Module.ModGuts</span></a></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html"><span class="hs-identifier">GHC.Types.Unique.FM</span></a></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Control.Monad.html#/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Foldable.html#/Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Foldable.html#for_/Data.Foldable.html#for_"><span class="hs-identifier">for_</span></a></span><span> </span><span class="hs-special">)</span><span class="hs-cpp">

#if __GLASGOW_HASKELL__ &lt;= 810
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Utils.Panic</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">panic</span><span> </span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-50"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Gentle simplification
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-comment">-- | Configuration record for `simplifyExpr`.</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- The values of this datatype are /only/ driven by the demands of that function.</span><span>
</span><span id="line-60"></span><span class="hs-keyword">data</span><span> </span><span id="SimplifyExprOpts"><span class="annot"><a href="GHC.Core.Opt.Simplify.html#SimplifyExprOpts"><span class="hs-identifier hs-var">SimplifyExprOpts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SimplifyExprOpts"><span class="annot"><a href="GHC.Core.Opt.Simplify.html#SimplifyExprOpts"><span class="hs-identifier hs-var">SimplifyExprOpts</span></a></span></span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="se_fam_inst"><span class="annot"><span class="annottext">SimplifyExprOpts -&gt; [FamInst]
</span><a href="GHC.Core.Opt.Simplify.html#se_fam_inst"><span class="hs-identifier hs-var hs-var">se_fam_inst</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="se_mode"><span class="annot"><span class="annottext">SimplifyExprOpts -&gt; SimplMode
</span><a href="GHC.Core.Opt.Simplify.html#se_mode"><span class="hs-identifier hs-var hs-var">se_mode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplMode"><span class="hs-identifier hs-type">SimplMode</span></a></span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="se_top_env_cfg"><span class="annot"><span class="annottext">SimplifyExprOpts -&gt; TopEnvConfig
</span><a href="GHC.Core.Opt.Simplify.html#se_top_env_cfg"><span class="hs-identifier hs-var hs-var">se_top_env_cfg</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#TopEnvConfig"><span class="hs-identifier hs-type">TopEnvConfig</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#simplifyExpr"><span class="hs-identifier hs-type">simplifyExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span>
</span><span id="line-67"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.External.html#ExternalUnitCache"><span class="hs-identifier hs-type">ExternalUnitCache</span></a></span><span>
</span><span id="line-68"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#SimplifyExprOpts"><span class="hs-identifier hs-type">SimplifyExprOpts</span></a></span><span>
</span><span id="line-69"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-70"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-71"></span><span class="hs-comment">-- simplifyExpr is called by the driver to simplify an</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- expression typed in at the interactive prompt</span><span>
</span><span id="line-73"></span><span id="simplifyExpr"><span class="annot"><span class="annottext">simplifyExpr :: Logger
-&gt; ExternalUnitCache -&gt; SimplifyExprOpts -&gt; CoreExpr -&gt; IO CoreExpr
</span><a href="GHC.Core.Opt.Simplify.html#simplifyExpr"><span class="hs-identifier hs-var hs-var">simplifyExpr</span></a></span></span><span> </span><span id="local-6989586621681917115"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917115"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681917116"><span class="annot"><span class="annottext">ExternalUnitCache
</span><a href="#local-6989586621681917116"><span class="hs-identifier hs-var">euc</span></a></span></span><span> </span><span id="local-6989586621681917117"><span class="annot"><span class="annottext">SimplifyExprOpts
</span><a href="#local-6989586621681917117"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681917118"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917118"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; SDoc -&gt; (CoreExpr -&gt; ()) -&gt; IO CoreExpr -&gt; IO CoreExpr
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Logger -&gt; SDoc -&gt; (a -&gt; ()) -&gt; m a -&gt; m a
</span><a href="GHC.Utils.Error.html#withTiming"><span class="hs-identifier hs-var">withTiming</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917115"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Simplify [expr]&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; CoreExpr -&gt; ()
forall a b. a -&gt; b -&gt; a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#const/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO CoreExpr -&gt; IO CoreExpr) -&gt; IO CoreExpr -&gt; IO CoreExpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681917121"><span class="annot"><span class="annottext">ExternalPackageState
</span><a href="#local-6989586621681917121"><span class="hs-identifier hs-var">eps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExternalUnitCache -&gt; IO ExternalPackageState
</span><a href="GHC.Unit.External.html#eucEPS"><span class="hs-identifier hs-var">eucEPS</span></a></span><span> </span><span class="annot"><span class="annottext">ExternalUnitCache
</span><a href="#local-6989586621681917116"><span class="hs-identifier hs-var">euc</span></a></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-76"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681917123"><span class="annot"><span class="annottext">fam_envs :: (PackageFamInstEnv, PackageFamInstEnv)
</span><a href="#local-6989586621681917123"><span class="hs-identifier hs-var hs-var">fam_envs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ExternalPackageState -&gt; PackageFamInstEnv
</span><a href="GHC.Unit.External.html#eps_fam_inst_env"><span class="hs-identifier hs-var">eps_fam_inst_env</span></a></span><span> </span><span class="annot"><span class="annottext">ExternalPackageState
</span><a href="#local-6989586621681917121"><span class="hs-identifier hs-var">eps</span></a></span><span>
</span><span id="line-77"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PackageFamInstEnv -&gt; [FamInst] -&gt; PackageFamInstEnv
</span><a href="GHC.Core.FamInstEnv.html#extendFamInstEnvList"><span class="hs-identifier hs-var">extendFamInstEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">PackageFamInstEnv
</span><a href="GHC.Core.FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier hs-var">emptyFamInstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">([FamInst] -&gt; PackageFamInstEnv) -&gt; [FamInst] -&gt; PackageFamInstEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SimplifyExprOpts -&gt; [FamInst]
</span><a href="GHC.Core.Opt.Simplify.html#se_fam_inst"><span class="hs-identifier hs-var">se_fam_inst</span></a></span><span> </span><span class="annot"><span class="annottext">SimplifyExprOpts
</span><a href="#local-6989586621681917117"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-78"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>              </span><span id="local-6989586621681917127"><span class="annot"><span class="annottext">simpl_env :: SimplEnv
</span><a href="#local-6989586621681917127"><span class="hs-identifier hs-var hs-var">simpl_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplMode -&gt; (PackageFamInstEnv, PackageFamInstEnv) -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#mkSimplEnv"><span class="hs-identifier hs-var">mkSimplEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplifyExprOpts -&gt; SimplMode
</span><a href="GHC.Core.Opt.Simplify.html#se_mode"><span class="hs-identifier hs-var">se_mode</span></a></span><span> </span><span class="annot"><span class="annottext">SimplifyExprOpts
</span><a href="#local-6989586621681917117"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PackageFamInstEnv, PackageFamInstEnv)
</span><a href="#local-6989586621681917123"><span class="hs-identifier hs-var">fam_envs</span></a></span><span>
</span><span id="line-80"></span><span>              </span><span id="local-6989586621681917129"><span class="annot"><span class="annottext">top_env_cfg :: TopEnvConfig
</span><a href="#local-6989586621681917129"><span class="hs-identifier hs-var hs-var">top_env_cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifyExprOpts -&gt; TopEnvConfig
</span><a href="GHC.Core.Opt.Simplify.html#se_top_env_cfg"><span class="hs-identifier hs-var">se_top_env_cfg</span></a></span><span> </span><span class="annot"><span class="annottext">SimplifyExprOpts
</span><a href="#local-6989586621681917117"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-81"></span><span>              </span><span id="local-6989586621681917130"><span class="annot"><span class="annottext">read_eps_rules :: IO PackageRuleBase
</span><a href="#local-6989586621681917130"><span class="hs-identifier hs-var hs-var">read_eps_rules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExternalPackageState -&gt; PackageRuleBase
</span><a href="GHC.Unit.External.html#eps_rule_base"><span class="hs-identifier hs-var">eps_rule_base</span></a></span><span> </span><span class="annot"><span class="annottext">(ExternalPackageState -&gt; PackageRuleBase)
-&gt; IO ExternalPackageState -&gt; IO PackageRuleBase
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.2.1/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ExternalUnitCache -&gt; IO ExternalPackageState
</span><a href="GHC.Unit.External.html#eucEPS"><span class="hs-identifier hs-var">eucEPS</span></a></span><span> </span><span class="annot"><span class="annottext">ExternalUnitCache
</span><a href="#local-6989586621681917116"><span class="hs-identifier hs-var">euc</span></a></span><span>
</span><span id="line-82"></span><span>              </span><span id="local-6989586621681917133"><span class="annot"><span class="annottext">read_ruleenv :: IO RuleEnv
</span><a href="#local-6989586621681917133"><span class="hs-identifier hs-var hs-var">read_ruleenv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleEnv -&gt; PackageRuleBase -&gt; RuleEnv
</span><a href="GHC.Core.Rules.html#updExternalPackageRules"><span class="hs-identifier hs-var">updExternalPackageRules</span></a></span><span> </span><span class="annot"><span class="annottext">RuleEnv
</span><a href="GHC.Core.Rules.html#emptyRuleEnv"><span class="hs-identifier hs-var">emptyRuleEnv</span></a></span><span> </span><span class="annot"><span class="annottext">(PackageRuleBase -&gt; RuleEnv) -&gt; IO PackageRuleBase -&gt; IO RuleEnv
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.2.1/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO PackageRuleBase
</span><a href="#local-6989586621681917130"><span class="hs-identifier hs-var">read_eps_rules</span></a></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681917136"><span class="annot"><span class="annottext">sz :: Int
</span><a href="#local-6989586621681917136"><span class="hs-identifier hs-var hs-var">sz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Int
</span><a href="GHC.Core.Stats.html#exprSize"><span class="hs-identifier hs-var">exprSize</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917118"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681917137"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917137"><span class="hs-identifier hs-var">expr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681917138"><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917138"><span class="hs-identifier hs-var">counts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Logger
-&gt; IO RuleEnv
-&gt; TopEnvConfig
-&gt; Int
-&gt; SimplM CoreExpr
-&gt; IO (CoreExpr, SimplCount)
forall a.
Logger
-&gt; IO RuleEnv
-&gt; TopEnvConfig
-&gt; Int
-&gt; SimplM a
-&gt; IO (a, SimplCount)
</span><a href="GHC.Core.Opt.Simplify.Monad.html#initSmpl"><span class="hs-identifier hs-var">initSmpl</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917115"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">IO RuleEnv
</span><a href="#local-6989586621681917133"><span class="hs-identifier hs-var">read_ruleenv</span></a></span><span> </span><span class="annot"><span class="annottext">TopEnvConfig
</span><a href="#local-6989586621681917129"><span class="hs-identifier hs-var">top_env_cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917136"><span class="hs-identifier hs-var">sz</span></a></span><span> </span><span class="annot"><span class="annottext">(SimplM CoreExpr -&gt; IO (CoreExpr, SimplCount))
-&gt; SimplM CoreExpr -&gt; IO (CoreExpr, SimplCount)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-87"></span><span>                             </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.html#simplExprGently"><span class="hs-identifier hs-var">simplExprGently</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621681917127"><span class="hs-identifier hs-var">simpl_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917118"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; String -&gt; DumpFormat -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#putDumpFileMaybe"><span class="hs-identifier hs-var">Logger.putDumpFileMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917115"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_simpl_stats"><span class="hs-identifier hs-var">Opt_D_dump_simpl_stats</span></a></span><span>
</span><span id="line-90"></span><span>                  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Simplifier statistics&quot;</span></span><span> </span><span class="annot"><span class="annottext">DumpFormat
</span><a href="GHC.Utils.Logger.html#FormatText"><span class="hs-identifier hs-var">FormatText</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCount -&gt; SDoc
</span><a href="GHC.Core.Opt.Stats.html#pprSimplCount"><span class="hs-identifier hs-var">pprSimplCount</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917138"><span class="hs-identifier hs-var">counts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; String -&gt; DumpFormat -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#putDumpFileMaybe"><span class="hs-identifier hs-var">Logger.putDumpFileMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917115"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_simpl"><span class="hs-identifier hs-var">Opt_D_dump_simpl</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Simplified expression&quot;</span></span><span>
</span><span id="line-93"></span><span>                        </span><span class="annot"><span class="annottext">DumpFormat
</span><a href="GHC.Utils.Logger.html#FormatCore"><span class="hs-identifier hs-var">FormatCore</span></a></span><span>
</span><span id="line-94"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall b. OutputableBndr b =&gt; Expr b -&gt; SDoc
</span><a href="GHC.Core.Ppr.html#pprCoreExpr"><span class="hs-identifier hs-var">pprCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917137"><span class="hs-identifier hs-var">expr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; IO CoreExpr
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917137"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-97"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#simplExprGently"><span class="hs-identifier hs-type">simplExprGently</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- Simplifies an expression</span><span>
</span><span id="line-101"></span><span class="hs-comment">--      does occurrence analysis, then simplification</span><span>
</span><span id="line-102"></span><span class="hs-comment">--      and repeats (twice currently) because one pass</span><span>
</span><span id="line-103"></span><span class="hs-comment">--      alone leaves tons of crud.</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- Used (a) for user expressions typed in at the interactive prompt</span><span>
</span><span id="line-105"></span><span class="hs-comment">--      (b) the LHS and RHS of a RULE</span><span>
</span><span id="line-106"></span><span class="hs-comment">--      (c) Template Haskell splices</span><span>
</span><span id="line-107"></span><span class="hs-comment">--</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- The name 'Gently' suggests that the SimplMode is InitialPhase,</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- and in fact that is so.... but the 'Gently' in simplExprGently doesn't</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- enforce that; it just simplifies the expression twice</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-comment">-- It's important that simplExprGently does eta reduction; see</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- Note [Simplify rule LHS] above.  The</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- simplifier does indeed do eta reduction (it's in GHC.Core.Opt.Simplify.completeLam)</span><span>
</span><span id="line-115"></span><span class="hs-comment">-- but only if -O is on.</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span id="simplExprGently"><span class="annot"><span class="annottext">simplExprGently :: SimplEnv -&gt; CoreExpr -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.html#simplExprGently"><span class="hs-identifier hs-var hs-var">simplExprGently</span></a></span></span><span> </span><span id="local-6989586621681917147"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621681917147"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681917148"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917148"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>    </span><span id="local-6989586621681917149"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917149"><span class="hs-identifier hs-var">expr1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621681917147"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917148"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>    </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreExpr -&gt; SimplM CoreExpr
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621681917147"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917149"><span class="hs-identifier hs-var">expr1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{The driver for the simplifier}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-comment">-- | Configuration record for `simplifyPgm`.</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- The values of this datatype are /only/ driven by the demands of that function.</span><span>
</span><span id="line-131"></span><span class="hs-keyword">data</span><span> </span><span id="SimplifyOpts"><span class="annot"><a href="GHC.Core.Opt.Simplify.html#SimplifyOpts"><span class="hs-identifier hs-var">SimplifyOpts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SimplifyOpts"><span class="annot"><a href="GHC.Core.Opt.Simplify.html#SimplifyOpts"><span class="hs-identifier hs-var">SimplifyOpts</span></a></span></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="so_dump_core_sizes"><span class="annot"><span class="annottext">SimplifyOpts -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.html#so_dump_core_sizes"><span class="hs-identifier hs-var hs-var">so_dump_core_sizes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="so_iterations"><span class="annot"><span class="annottext">SimplifyOpts -&gt; Int
</span><a href="GHC.Core.Opt.Simplify.html#so_iterations"><span class="hs-identifier hs-var hs-var">so_iterations</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="so_mode"><span class="annot"><span class="annottext">SimplifyOpts -&gt; SimplMode
</span><a href="GHC.Core.Opt.Simplify.html#so_mode"><span class="hs-identifier hs-var hs-var">so_mode</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Env.html#SimplMode"><span class="hs-identifier hs-type">SimplMode</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="so_pass_result_cfg"><span class="annot"><span class="annottext">SimplifyOpts -&gt; Maybe LintPassResultConfig
</span><a href="GHC.Core.Opt.Simplify.html#so_pass_result_cfg"><span class="hs-identifier hs-var hs-var">so_pass_result_cfg</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Lint.html#LintPassResultConfig"><span class="hs-identifier hs-type">LintPassResultConfig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>                          </span><span class="hs-comment">-- Nothing =&gt; Do not Lint</span><span>
</span><span id="line-138"></span><span>                          </span><span class="hs-comment">-- Just cfg =&gt; Lint like this</span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="so_hpt_rules"><span class="annot"><span class="annottext">SimplifyOpts -&gt; PackageRuleBase
</span><a href="GHC.Core.Opt.Simplify.html#so_hpt_rules"><span class="hs-identifier hs-var hs-var">so_hpt_rules</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Rules.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a></span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="so_top_env_cfg"><span class="annot"><span class="annottext">SimplifyOpts -&gt; TopEnvConfig
</span><a href="GHC.Core.Opt.Simplify.html#so_top_env_cfg"><span class="hs-identifier hs-var hs-var">so_top_env_cfg</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.Simplify.Monad.html#TopEnvConfig"><span class="hs-identifier hs-type">TopEnvConfig</span></a></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#simplifyPgm"><span class="hs-identifier hs-type">simplifyPgm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span>
</span><span id="line-145"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Env.html#UnitEnv"><span class="hs-identifier hs-type">UnitEnv</span></a></span><span>
</span><span id="line-146"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#NamePprCtx"><span class="hs-identifier hs-type">NamePprCtx</span></a></span><span>                </span><span class="hs-comment">-- For dumping</span><span>
</span><span id="line-147"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#SimplifyOpts"><span class="hs-identifier hs-type">SimplifyOpts</span></a></span><span>
</span><span id="line-148"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span>
</span><span id="line-149"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.Stats.html#SimplCount"><span class="hs-identifier hs-type">SimplCount</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- New bindings</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span id="simplifyPgm"><span class="annot"><span class="annottext">simplifyPgm :: Logger
-&gt; UnitEnv
-&gt; NamePprCtx
-&gt; SimplifyOpts
-&gt; ModGuts
-&gt; IO (SimplCount, ModGuts)
</span><a href="GHC.Core.Opt.Simplify.html#simplifyPgm"><span class="hs-identifier hs-var hs-var">simplifyPgm</span></a></span></span><span> </span><span id="local-6989586621681917158"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917158"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681917159"><span class="annot"><span class="annottext">UnitEnv
</span><a href="#local-6989586621681917159"><span class="hs-identifier hs-var">unit_env</span></a></span></span><span> </span><span id="local-6989586621681917160"><span class="annot"><span class="annottext">NamePprCtx
</span><a href="#local-6989586621681917160"><span class="hs-identifier hs-var">name_ppr_ctx</span></a></span></span><span> </span><span id="local-6989586621681917161"><span class="annot"><span class="annottext">SimplifyOpts
</span><a href="#local-6989586621681917161"><span class="hs-identifier hs-var">opts</span></a></span></span><span>
</span><span id="line-152"></span><span>            </span><span id="local-6989586621681917162"><span class="annot"><span class="annottext">guts :: ModGuts
</span><a href="#local-6989586621681917162"><span class="hs-identifier hs-var">guts</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mg_module :: ModGuts -&gt; Module
</span><a href="GHC.Unit.Module.ModGuts.html#mg_module"><span class="hs-identifier hs-var">mg_module</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681917165"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681917165"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span>
</span><span id="line-153"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mg_binds :: ModGuts -&gt; CoreProgram
</span><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681917167"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917167"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mg_rules :: ModGuts -&gt; [CoreRule]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_rules"><span class="hs-identifier hs-var">mg_rules</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681917169"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917169"><span class="hs-identifier hs-var">local_rules</span></a></span></span><span>
</span><span id="line-154"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mg_fam_inst_env :: ModGuts -&gt; PackageFamInstEnv
</span><a href="GHC.Unit.Module.ModGuts.html#mg_fam_inst_env"><span class="hs-identifier hs-var">mg_fam_inst_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681917171"><span class="annot"><span class="annottext">PackageFamInstEnv
</span><a href="#local-6989586621681917171"><span class="hs-identifier hs-var">fam_inst_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681917172"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681917172"><span class="hs-identifier hs-var">termination_msg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681917173"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917173"><span class="hs-identifier hs-var">it_count</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681917174"><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917174"><span class="hs-identifier hs-var">counts_out</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681917175"><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621681917175"><span class="hs-identifier hs-var">guts'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [SimplCount]
-&gt; CoreProgram
-&gt; [CoreRule]
-&gt; IO (String, Int, SimplCount, ModGuts)
</span><a href="#local-6989586621681917176"><span class="hs-identifier hs-var">do_iteration</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917167"><span class="hs-identifier hs-var">binds</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917169"><span class="hs-identifier hs-var">local_rules</span></a></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#when/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; Bool
</span><a href="GHC.Utils.Logger.html#logHasDumpFlag"><span class="hs-identifier hs-var">logHasDumpFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917158"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_verbose_core2core"><span class="hs-identifier hs-var">Opt_D_verbose_core2core</span></a></span><span>
</span><span id="line-159"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; Bool
</span><a href="GHC.Utils.Logger.html#logHasDumpFlag"><span class="hs-identifier hs-var">logHasDumpFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917158"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_simpl_stats"><span class="hs-identifier hs-var">Opt_D_dump_simpl_stats</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-160"></span><span>          </span><span class="annot"><span class="annottext">Logger -&gt; String -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#logDumpMsg"><span class="hs-identifier hs-var">logDumpMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917158"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-161"></span><span>                  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Simplifier statistics for following pass&quot;</span></span><span>
</span><span id="line-162"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681917172"><span class="hs-identifier hs-var">termination_msg</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;after&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917173"><span class="hs-identifier hs-var">it_count</span></a></span><span>
</span><span id="line-163"></span><span>                                              </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iterations&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-164"></span><span>                         </span><span class="annot"><span class="annottext">SDoc
</span><a href="GHC.Utils.Outputable.html#blankLine"><span class="hs-identifier hs-var">blankLine</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-165"></span><span>                         </span><span class="annot"><span class="annottext">SimplCount -&gt; SDoc
</span><a href="GHC.Core.Opt.Stats.html#pprSimplCount"><span class="hs-identifier hs-var">pprSimplCount</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917174"><span class="hs-identifier hs-var">counts_out</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(SimplCount, ModGuts) -&gt; IO (SimplCount, ModGuts)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917174"><span class="hs-identifier hs-var">counts_out</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621681917175"><span class="hs-identifier hs-var">guts'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-170"></span><span>    </span><span id="local-6989586621681917186"><span class="annot"><span class="annottext">dump_core_sizes :: Bool
</span><a href="#local-6989586621681917186"><span class="hs-identifier hs-var hs-var">dump_core_sizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifyOpts -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.html#so_dump_core_sizes"><span class="hs-identifier hs-var">so_dump_core_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">SimplifyOpts
</span><a href="#local-6989586621681917161"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span id="local-6989586621681917187"><span class="annot"><span class="annottext">mode :: SimplMode
</span><a href="#local-6989586621681917187"><span class="hs-identifier hs-var hs-var">mode</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifyOpts -&gt; SimplMode
</span><a href="GHC.Core.Opt.Simplify.html#so_mode"><span class="hs-identifier hs-var">so_mode</span></a></span><span> </span><span class="annot"><span class="annottext">SimplifyOpts
</span><a href="#local-6989586621681917161"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-172"></span><span>    </span><span id="local-6989586621681917188"><span class="annot"><span class="annottext">max_iterations :: Int
</span><a href="#local-6989586621681917188"><span class="hs-identifier hs-var hs-var">max_iterations</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifyOpts -&gt; Int
</span><a href="GHC.Core.Opt.Simplify.html#so_iterations"><span class="hs-identifier hs-var">so_iterations</span></a></span><span> </span><span class="annot"><span class="annottext">SimplifyOpts
</span><a href="#local-6989586621681917161"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span id="local-6989586621681917189"><span class="annot"><span class="annottext">top_env_cfg :: TopEnvConfig
</span><a href="#local-6989586621681917189"><span class="hs-identifier hs-var hs-var">top_env_cfg</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifyOpts -&gt; TopEnvConfig
</span><a href="GHC.Core.Opt.Simplify.html#so_top_env_cfg"><span class="hs-identifier hs-var">so_top_env_cfg</span></a></span><span> </span><span class="annot"><span class="annottext">SimplifyOpts
</span><a href="#local-6989586621681917161"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-174"></span><span>    </span><span id="local-6989586621681917190"><span class="annot"><span class="annottext">active_rule :: Activation -&gt; Bool
</span><a href="#local-6989586621681917190"><span class="hs-identifier hs-var hs-var">active_rule</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplMode -&gt; Activation -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#activeRule"><span class="hs-identifier hs-var">activeRule</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621681917187"><span class="hs-identifier hs-var">mode</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span id="local-6989586621681917191"><span class="annot"><span class="annottext">active_unf :: Id -&gt; Bool
</span><a href="#local-6989586621681917191"><span class="hs-identifier hs-var hs-var">active_unf</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplMode -&gt; Id -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.Utils.html#activeUnfolding"><span class="hs-identifier hs-var">activeUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621681917187"><span class="hs-identifier hs-var">mode</span></a></span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-comment">-- Note the bang in !guts_no_binds.  If you don't force `guts_no_binds`</span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-comment">-- the old bindings are retained until the end of all simplifier iterations</span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681917192"><span class="annot"><span class="annottext">guts_no_binds :: ModGuts
</span><a href="#local-6989586621681917192"><span class="hs-identifier hs-var hs-var">guts_no_binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621681917162"><span class="hs-identifier hs-var">guts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_rules"><span class="hs-identifier hs-var">mg_rules</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><a href="#local-6989586621681917193"><span class="hs-identifier hs-type">hpt_rule_env</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span id="local-6989586621681917193"><span class="annot"><span class="annottext">hpt_rule_env :: RuleEnv
</span><a href="#local-6989586621681917193"><span class="hs-identifier hs-var hs-var">hpt_rule_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModGuts -&gt; PackageRuleBase -&gt; PackageRuleBase -&gt; RuleEnv
</span><a href="GHC.Core.Rules.html#mkRuleEnv"><span class="hs-identifier hs-var">mkRuleEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621681917162"><span class="hs-identifier hs-var">guts</span></a></span><span> </span><span class="annot"><span class="annottext">PackageRuleBase
</span><a href="GHC.Core.Rules.html#emptyRuleBase"><span class="hs-identifier hs-var">emptyRuleBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplifyOpts -&gt; PackageRuleBase
</span><a href="GHC.Core.Opt.Simplify.html#so_hpt_rules"><span class="hs-identifier hs-var">so_hpt_rules</span></a></span><span> </span><span class="annot"><span class="annottext">SimplifyOpts
</span><a href="#local-6989586621681917161"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>                   </span><span class="hs-comment">-- emptyRuleBase: no EPS rules yet; we will update</span><span>
</span><span id="line-183"></span><span>                   </span><span class="hs-comment">-- them on each iteration to pick up the most up to date set</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>    </span><span class="annot"><a href="#local-6989586621681917176"><span class="hs-identifier hs-type">do_iteration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- Counts iterations</span><span>
</span><span id="line-186"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Stats.html#SimplCount"><span class="hs-identifier hs-type">SimplCount</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Counts from earlier iterations, reversed</span><span>
</span><span id="line-187"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span>  </span><span class="hs-comment">-- Bindings</span><span>
</span><span id="line-188"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Local rules for imported Ids</span><span>
</span><span id="line-189"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Base.html#String/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Stats.html#SimplCount"><span class="hs-identifier hs-type">SimplCount</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621681917176"><span class="annot"><span class="annottext">do_iteration :: Int
-&gt; [SimplCount]
-&gt; CoreProgram
-&gt; [CoreRule]
-&gt; IO (String, Int, SimplCount, ModGuts)
</span><a href="#local-6989586621681917176"><span class="hs-identifier hs-var hs-var">do_iteration</span></a></span></span><span> </span><span id="local-6989586621681917196"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917196"><span class="hs-identifier hs-var">iteration_no</span></a></span></span><span> </span><span id="local-6989586621681917197"><span class="annot"><span class="annottext">[SimplCount]
</span><a href="#local-6989586621681917197"><span class="hs-identifier hs-var">counts_so_far</span></a></span></span><span> </span><span id="local-6989586621681917198"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917198"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span id="local-6989586621681917199"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917199"><span class="hs-identifier hs-var">local_rules</span></a></span></span><span>
</span><span id="line-192"></span><span>        </span><span class="hs-comment">-- iteration_no is the number of the iteration we are</span><span>
</span><span id="line-193"></span><span>        </span><span class="hs-comment">-- about to begin, with '1' for the first</span><span>
</span><span id="line-194"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917196"><span class="hs-identifier hs-var">iteration_no</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917188"><span class="hs-identifier hs-var">max_iterations</span></a></span><span>   </span><span class="hs-comment">-- Stop if we've run out of iterations</span><span>
</span><span id="line-195"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; String
-&gt; SDoc
-&gt; IO (String, Int, SimplCount, ModGuts)
-&gt; IO (String, Int, SimplCount, ModGuts)
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Utils.Constants.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917188"><span class="hs-identifier hs-var">max_iterations</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Simplifier bailing out&quot;</span></span><span>
</span><span id="line-197"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Int -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681917165"><span class="hs-identifier hs-var">this_mod</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, after&quot;</span></span><span>
</span><span id="line-198"></span><span>                    </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917188"><span class="hs-identifier hs-var">max_iterations</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iterations&quot;</span></span><span>
</span><span id="line-199"></span><span>                    </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; SDoc) -&gt; SDoc -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span> </span><span class="annot"><span class="annottext">([SDoc] -&gt; SDoc) -&gt; [SDoc] -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; [SDoc] -&gt; [SDoc]
forall doc. IsLine doc =&gt; doc -&gt; [doc] -&gt; [doc]
</span><a href="GHC.Utils.Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a></span><span> </span><span class="annot"><span class="annottext">([SDoc] -&gt; [SDoc]) -&gt; [SDoc] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-200"></span><span>                         </span><span class="annot"><span class="annottext">(SimplCount -&gt; SDoc) -&gt; [SimplCount] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; SDoc
forall doc. IsLine doc =&gt; Int -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; SDoc) -&gt; (SimplCount -&gt; Int) -&gt; SimplCount -&gt; SDoc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCount -&gt; Int
</span><a href="GHC.Core.Opt.Stats.html#simplCountN"><span class="hs-identifier hs-var">simplCountN</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SimplCount] -&gt; [SimplCount]
forall a. [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#reverse/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[SimplCount]
</span><a href="#local-6989586621681917197"><span class="hs-identifier hs-var">counts_so_far</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>                 </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Size =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoreStats -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreProgram -&gt; CoreStats
</span><a href="GHC.Core.Stats.html#coreBindsStats"><span class="hs-identifier hs-var">coreBindsStats</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917198"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (String, Int, SimplCount, ModGuts)
 -&gt; IO (String, Int, SimplCount, ModGuts))
-&gt; IO (String, Int, SimplCount, ModGuts)
-&gt; IO (String, Int, SimplCount, ModGuts)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span>                </span><span class="hs-comment">-- Subtract 1 from iteration_no to get the</span><span>
</span><span id="line-204"></span><span>                </span><span class="hs-comment">-- number of iterations we actually completed</span><span>
</span><span id="line-205"></span><span>        </span><span class="annot"><span class="annottext">(String, Int, SimplCount, ModGuts)
-&gt; IO (String, Int, SimplCount, ModGuts)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Simplifier baled out&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917196"><span class="hs-identifier hs-var">iteration_no</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.2.1/src/GHC.Num.html#-/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-206"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SimplCount] -&gt; SimplCount
</span><a href="#local-6989586621681917211"><span class="hs-identifier hs-var">totalise</span></a></span><span> </span><span class="annot"><span class="annottext">[SimplCount]
</span><a href="#local-6989586621681917197"><span class="hs-identifier hs-var">counts_so_far</span></a></span><span>
</span><span id="line-207"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621681917192"><span class="hs-identifier hs-var">guts_no_binds</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681917198"><span class="hs-identifier hs-type">binds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_rules"><span class="hs-identifier hs-var">mg_rules</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681917199"><span class="hs-identifier hs-type">local_rules</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span>      </span><span class="hs-comment">-- Try and force thunks off the binds; significantly reduces</span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-comment">-- space usage, especially with -O.  JRS, 000620.</span><span>
</span><span id="line-211"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681917212"><span class="annot"><span class="annottext">sz :: Int
</span><a href="#local-6989586621681917212"><span class="hs-identifier hs-var hs-var">sz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; Int
</span><a href="GHC.Core.Stats.html#coreBindsSize"><span class="hs-identifier hs-var">coreBindsSize</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917198"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-212"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917212"><span class="hs-identifier hs-var">sz</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; () -&gt; ()
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Force it</span><span>
</span><span id="line-213"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-214"></span><span>                </span><span class="hs-comment">-- Occurrence analysis</span><span>
</span><span id="line-215"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681917213"><span class="annot"><span class="annottext">tagged_binds :: CoreProgram
</span><a href="#local-6989586621681917213"><span class="hs-identifier hs-var hs-var">tagged_binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;OccAnal&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-216"></span><span>                     </span><span class="annot"><span class="annottext">Module
-&gt; (Id -&gt; Bool)
-&gt; (Activation -&gt; Bool)
-&gt; [CoreRule]
-&gt; CoreProgram
-&gt; CoreProgram
</span><a href="GHC.Core.Opt.OccurAnal.html#occurAnalysePgm"><span class="hs-identifier hs-var">occurAnalysePgm</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681917165"><span class="hs-identifier hs-var">this_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621681917191"><span class="hs-identifier hs-var">active_unf</span></a></span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="#local-6989586621681917190"><span class="hs-identifier hs-var">active_rule</span></a></span><span>
</span><span id="line-217"></span><span>                                     </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917199"><span class="hs-identifier hs-var">local_rules</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917198"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-218"></span><span>               </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-219"></span><span>           </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; String -&gt; DumpFormat -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#putDumpFileMaybe"><span class="hs-identifier hs-var">Logger.putDumpFileMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917158"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_occur_anal"><span class="hs-identifier hs-var">Opt_D_dump_occur_anal</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Occurrence analysis&quot;</span></span><span>
</span><span id="line-220"></span><span>                     </span><span class="annot"><span class="annottext">DumpFormat
</span><a href="GHC.Utils.Logger.html#FormatCore"><span class="hs-identifier hs-var">FormatCore</span></a></span><span>
</span><span id="line-221"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreProgram -&gt; SDoc
forall b. OutputableBndr b =&gt; [Bind b] -&gt; SDoc
</span><a href="GHC.Core.Ppr.html#pprCoreBindings"><span class="hs-identifier hs-var">pprCoreBindings</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917213"><span class="hs-identifier hs-var">tagged_binds</span></a></span><span class="hs-special">)</span><span class="hs-special">;</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>                </span><span class="hs-comment">-- read_eps_rules:</span><span>
</span><span id="line-224"></span><span>                </span><span class="hs-comment">-- We need to read rules from the EPS regularly because simplification can</span><span>
</span><span id="line-225"></span><span>                </span><span class="hs-comment">-- poke on IdInfo thunks, which in turn brings in new rules</span><span>
</span><span id="line-226"></span><span>                </span><span class="hs-comment">-- behind the scenes.  Otherwise there's a danger we'll simply</span><span>
</span><span id="line-227"></span><span>                </span><span class="hs-comment">-- miss the rules for Ids hidden inside imported inlinings</span><span>
</span><span id="line-228"></span><span>                </span><span class="hs-comment">-- Hence just before attempting to match a rule we read the EPS</span><span>
</span><span id="line-229"></span><span>                </span><span class="hs-comment">-- value (via read_rule_env) and then combine it with the existing rule base.</span><span>
</span><span id="line-230"></span><span>                </span><span class="hs-comment">-- See `GHC.Core.Opt.Simplify.Monad.getSimplRules`.</span><span>
</span><span id="line-231"></span><span>          </span><span id="local-6989586621681917215"><span class="annot"><span class="annottext">ExternalPackageState
</span><a href="#local-6989586621681917215"><span class="hs-identifier hs-var">eps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnitEnv -&gt; IO ExternalPackageState
</span><a href="GHC.Unit.Env.html#ueEPS"><span class="hs-identifier hs-var">ueEPS</span></a></span><span> </span><span class="annot"><span class="annottext">UnitEnv
</span><a href="#local-6989586621681917159"><span class="hs-identifier hs-var">unit_env</span></a></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-232"></span><span>           </span><span class="hs-keyword">let</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- base_rule_env contains</span><span>
</span><span id="line-233"></span><span>                  </span><span class="hs-comment">--    (a) home package rules, fixed across all iterations</span><span>
</span><span id="line-234"></span><span>                  </span><span class="hs-comment">--    (b) local rules (substituted) from `local_rules` arg to do_iteration</span><span>
</span><span id="line-235"></span><span>                  </span><span class="hs-comment">-- Forcing base_rule_env to avoid unnecessary allocations.</span><span>
</span><span id="line-236"></span><span>                  </span><span class="hs-comment">-- Not doing so results in +25.6% allocations of LargeRecord.</span><span>
</span><span id="line-237"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681917216"><span class="annot"><span class="annottext">base_rule_env :: RuleEnv
</span><a href="#local-6989586621681917216"><span class="hs-identifier hs-var hs-var">base_rule_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleEnv -&gt; [CoreRule] -&gt; RuleEnv
</span><a href="GHC.Core.Rules.html#updLocalRules"><span class="hs-identifier hs-var">updLocalRules</span></a></span><span> </span><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621681917193"><span class="hs-identifier hs-var">hpt_rule_env</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917199"><span class="hs-identifier hs-var">local_rules</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="#local-6989586621681917218"><span class="hs-identifier hs-type">read_eps_rules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Unit.External.html#PackageRuleBase"><span class="hs-identifier hs-type">PackageRuleBase</span></a></span><span>
</span><span id="line-240"></span><span>                </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681917218"><span class="annot"><span class="annottext">read_eps_rules :: IO PackageRuleBase
</span><a href="#local-6989586621681917218"><span class="hs-identifier hs-var hs-var">read_eps_rules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExternalPackageState -&gt; PackageRuleBase
</span><a href="GHC.Unit.External.html#eps_rule_base"><span class="hs-identifier hs-var">eps_rule_base</span></a></span><span> </span><span class="annot"><span class="annottext">(ExternalPackageState -&gt; PackageRuleBase)
-&gt; IO ExternalPackageState -&gt; IO PackageRuleBase
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.2.1/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UnitEnv -&gt; IO ExternalPackageState
</span><a href="GHC.Unit.Env.html#ueEPS"><span class="hs-identifier hs-var">ueEPS</span></a></span><span> </span><span class="annot"><span class="annottext">UnitEnv
</span><a href="#local-6989586621681917159"><span class="hs-identifier hs-var">unit_env</span></a></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="#local-6989586621681917219"><span class="hs-identifier hs-type">read_rule_env</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Core.Rules.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a></span><span>
</span><span id="line-243"></span><span>                </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681917219"><span class="annot"><span class="annottext">read_rule_env :: IO RuleEnv
</span><a href="#local-6989586621681917219"><span class="hs-identifier hs-var hs-var">read_rule_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleEnv -&gt; PackageRuleBase -&gt; RuleEnv
</span><a href="GHC.Core.Rules.html#updExternalPackageRules"><span class="hs-identifier hs-var">updExternalPackageRules</span></a></span><span> </span><span class="annot"><span class="annottext">RuleEnv
</span><a href="#local-6989586621681917216"><span class="hs-identifier hs-var">base_rule_env</span></a></span><span> </span><span class="annot"><span class="annottext">(PackageRuleBase -&gt; RuleEnv) -&gt; IO PackageRuleBase -&gt; IO RuleEnv
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.2.1/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO PackageRuleBase
</span><a href="#local-6989586621681917218"><span class="hs-identifier hs-var">read_eps_rules</span></a></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span>                </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681917220"><span class="annot"><span class="annottext">fam_envs :: (PackageFamInstEnv, PackageFamInstEnv)
</span><a href="#local-6989586621681917220"><span class="hs-identifier hs-var hs-var">fam_envs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExternalPackageState -&gt; PackageFamInstEnv
</span><a href="GHC.Unit.External.html#eps_fam_inst_env"><span class="hs-identifier hs-var">eps_fam_inst_env</span></a></span><span> </span><span class="annot"><span class="annottext">ExternalPackageState
</span><a href="#local-6989586621681917215"><span class="hs-identifier hs-var">eps</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PackageFamInstEnv
</span><a href="#local-6989586621681917171"><span class="hs-identifier hs-var">fam_inst_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>                </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681917221"><span class="annot"><span class="annottext">simpl_env :: SimplEnv
</span><a href="#local-6989586621681917221"><span class="hs-identifier hs-var hs-var">simpl_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplMode -&gt; (PackageFamInstEnv, PackageFamInstEnv) -&gt; SimplEnv
</span><a href="GHC.Core.Opt.Simplify.Env.html#mkSimplEnv"><span class="hs-identifier hs-var">mkSimplEnv</span></a></span><span> </span><span class="annot"><span class="annottext">SimplMode
</span><a href="#local-6989586621681917187"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">(PackageFamInstEnv, PackageFamInstEnv)
</span><a href="#local-6989586621681917220"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span>                </span><span class="hs-comment">-- Simplify the program</span><span>
</span><span id="line-249"></span><span>           </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621681917222"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917222"><span class="hs-identifier hs-var">binds1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681917223"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917223"><span class="hs-identifier hs-var">rules1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681917224"><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917224"><span class="hs-identifier hs-var">counts1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-250"></span><span>             </span><span class="annot"><span class="annottext">Logger
-&gt; IO RuleEnv
-&gt; TopEnvConfig
-&gt; Int
-&gt; SimplM (CoreProgram, [CoreRule])
-&gt; IO ((CoreProgram, [CoreRule]), SimplCount)
forall a.
Logger
-&gt; IO RuleEnv
-&gt; TopEnvConfig
-&gt; Int
-&gt; SimplM a
-&gt; IO (a, SimplCount)
</span><a href="GHC.Core.Opt.Simplify.Monad.html#initSmpl"><span class="hs-identifier hs-var">initSmpl</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917158"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">IO RuleEnv
</span><a href="#local-6989586621681917219"><span class="hs-identifier hs-var">read_rule_env</span></a></span><span> </span><span class="annot"><span class="annottext">TopEnvConfig
</span><a href="#local-6989586621681917189"><span class="hs-identifier hs-var">top_env_cfg</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917212"><span class="hs-identifier hs-var">sz</span></a></span><span> </span><span class="annot"><span class="annottext">(SimplM (CoreProgram, [CoreRule])
 -&gt; IO ((CoreProgram, [CoreRule]), SimplCount))
-&gt; SimplM (CoreProgram, [CoreRule])
-&gt; IO ((CoreProgram, [CoreRule]), SimplCount)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-251"></span><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681917225"><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621681917225"><span class="hs-identifier hs-var">floats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681917226"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621681917226"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;SimplTopBinds&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-252"></span><span>                                      </span><span class="annot"><span class="annottext">SimplEnv -&gt; CoreProgram -&gt; SimplM (SimplFloats, SimplEnv)
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplTopBinds"><span class="hs-identifier hs-var">simplTopBinds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621681917221"><span class="hs-identifier hs-var">simpl_env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917213"><span class="hs-identifier hs-var">tagged_binds</span></a></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span>                      </span><span class="hs-comment">-- Apply the substitution to rules defined in this module</span><span>
</span><span id="line-255"></span><span>                      </span><span class="hs-comment">-- for imported Ids.  Eg  RULE map my_f = blah</span><span>
</span><span id="line-256"></span><span>                      </span><span class="hs-comment">-- If we have a substitution my_f :-&gt; other_f, we'd better</span><span>
</span><span id="line-257"></span><span>                      </span><span class="hs-comment">-- apply it to the rule to, or it'll never match</span><span>
</span><span id="line-258"></span><span>                  </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681917227"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917227"><span class="hs-identifier hs-var">rules1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; [CoreRule] -&gt; SimplM [CoreRule]
</span><a href="GHC.Core.Opt.Simplify.Iteration.html#simplImpRules"><span class="hs-identifier hs-var">simplImpRules</span></a></span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621681917226"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917199"><span class="hs-identifier hs-var">local_rules</span></a></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(CoreProgram, [CoreRule]) -&gt; SimplM (CoreProgram, [CoreRule])
forall a. a -&gt; SimplM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplFloats -&gt; CoreProgram
</span><a href="GHC.Core.Opt.Simplify.Env.html#getTopFloatBinds"><span class="hs-identifier hs-var">getTopFloatBinds</span></a></span><span> </span><span class="annot"><span class="annottext">SimplFloats
</span><a href="#local-6989586621681917225"><span class="hs-identifier hs-var">floats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917227"><span class="hs-identifier hs-var">rules1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>                </span><span class="hs-comment">-- Stop if nothing happened; don't dump output</span><span>
</span><span id="line-263"></span><span>                </span><span class="hs-comment">-- See Note [Which transformations are innocuous] in GHC.Core.Opt.Stats</span><span>
</span><span id="line-264"></span><span>           </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SimplCount -&gt; Bool
</span><a href="GHC.Core.Opt.Stats.html#isZeroSimplCount"><span class="hs-identifier hs-var">isZeroSimplCount</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917224"><span class="hs-identifier hs-var">counts1</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-265"></span><span>                </span><span class="annot"><span class="annottext">(String, Int, SimplCount, ModGuts)
-&gt; IO (String, Int, SimplCount, ModGuts)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Simplifier reached fixed point&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917196"><span class="hs-identifier hs-var">iteration_no</span></a></span><span>
</span><span id="line-266"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SimplCount] -&gt; SimplCount
</span><a href="#local-6989586621681917211"><span class="hs-identifier hs-var">totalise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917224"><span class="hs-identifier hs-var">counts1</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCount -&gt; [SimplCount] -&gt; [SimplCount]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[SimplCount]
</span><a href="#local-6989586621681917197"><span class="hs-identifier hs-var">counts_so_far</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Include &quot;free&quot; ticks</span><span>
</span><span id="line-267"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621681917192"><span class="hs-identifier hs-var">guts_no_binds</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681917222"><span class="hs-identifier hs-type">binds1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_rules"><span class="hs-identifier hs-var">mg_rules</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681917223"><span class="hs-identifier hs-type">rules1</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-269"></span><span>                </span><span class="hs-comment">-- Short out indirections</span><span>
</span><span id="line-270"></span><span>                </span><span class="hs-comment">-- We do this *after* at least one run of the simplifier</span><span>
</span><span id="line-271"></span><span>                </span><span class="hs-comment">-- because indirection-shorting uses the export flag on *occurrences*</span><span>
</span><span id="line-272"></span><span>                </span><span class="hs-comment">-- and that isn't guaranteed to be ok until after the first run propagates</span><span>
</span><span id="line-273"></span><span>                </span><span class="hs-comment">-- stuff from the binding site to its occurrences</span><span>
</span><span id="line-274"></span><span>                </span><span class="hs-comment">--</span><span>
</span><span id="line-275"></span><span>                </span><span class="hs-comment">-- ToDo: alas, this means that indirection-shorting does not happen at all</span><span>
</span><span id="line-276"></span><span>                </span><span class="hs-comment">--       if the simplifier does nothing (not common, I know, but unsavoury)</span><span>
</span><span id="line-277"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681917230"><span class="annot"><span class="annottext">binds2 :: CoreProgram
</span><a href="#local-6989586621681917230"><span class="hs-identifier hs-var hs-var">binds2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;ZapInd&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; CoreProgram
</span><a href="GHC.Core.Opt.Simplify.html#shortOutIndirections"><span class="hs-identifier hs-var">shortOutIndirections</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917222"><span class="hs-identifier hs-var">binds1</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span>                </span><span class="hs-comment">-- Dump the result of this iteration</span><span>
</span><span id="line-280"></span><span>           </span><span class="annot"><span class="annottext">Logger
-&gt; Bool
-&gt; NamePprCtx
-&gt; Int
-&gt; SimplCount
-&gt; CoreProgram
-&gt; [CoreRule]
-&gt; IO ()
</span><a href="GHC.Core.Opt.Simplify.html#dump_end_iteration"><span class="hs-identifier hs-var">dump_end_iteration</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917158"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681917186"><span class="hs-identifier hs-var">dump_core_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">NamePprCtx
</span><a href="#local-6989586621681917160"><span class="hs-identifier hs-var">name_ppr_ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917196"><span class="hs-identifier hs-var">iteration_no</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917224"><span class="hs-identifier hs-var">counts1</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917230"><span class="hs-identifier hs-var">binds2</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917223"><span class="hs-identifier hs-var">rules1</span></a></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span>           </span><span class="annot"><span class="annottext">Maybe LintPassResultConfig
-&gt; (LintPassResultConfig -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#for_/Data.Foldable.html#for_"><span class="hs-identifier hs-var">for_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplifyOpts -&gt; Maybe LintPassResultConfig
</span><a href="GHC.Core.Opt.Simplify.html#so_pass_result_cfg"><span class="hs-identifier hs-var">so_pass_result_cfg</span></a></span><span> </span><span class="annot"><span class="annottext">SimplifyOpts
</span><a href="#local-6989586621681917161"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((LintPassResultConfig -&gt; IO ()) -&gt; IO ())
-&gt; (LintPassResultConfig -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681917233"><span class="annot"><span class="annottext">LintPassResultConfig
</span><a href="#local-6989586621681917233"><span class="hs-identifier hs-var">pass_result_cfg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-283"></span><span>             </span><span class="annot"><span class="annottext">Logger -&gt; LintPassResultConfig -&gt; CoreProgram -&gt; IO ()
</span><a href="GHC.Core.Lint.html#lintPassResult"><span class="hs-identifier hs-var">lintPassResult</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917158"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LintPassResultConfig
</span><a href="#local-6989586621681917233"><span class="hs-identifier hs-var">pass_result_cfg</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917230"><span class="hs-identifier hs-var">binds2</span></a></span><span> </span><span class="hs-special">;</span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span>                </span><span class="hs-comment">-- Loop</span><span>
</span><span id="line-286"></span><span>           </span><span class="annot"><span class="annottext">Int
-&gt; [SimplCount]
-&gt; CoreProgram
-&gt; [CoreRule]
-&gt; IO (String, Int, SimplCount, ModGuts)
</span><a href="#local-6989586621681917176"><span class="hs-identifier hs-var">do_iteration</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917196"><span class="hs-identifier hs-var">iteration_no</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.2.1/src/GHC.Num.html#%2B/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917224"><span class="hs-identifier hs-var">counts1</span></a></span><span class="annot"><span class="annottext">SimplCount -&gt; [SimplCount] -&gt; [SimplCount]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[SimplCount]
</span><a href="#local-6989586621681917197"><span class="hs-identifier hs-var">counts_so_far</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917230"><span class="hs-identifier hs-var">binds2</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917223"><span class="hs-identifier hs-var">rules1</span></a></span><span>
</span><span id="line-287"></span><span>           </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-cpp">
#if __GLASGOW_HASKELL__ &lt;= 810
</span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">panic</span><span> </span><span class="hs-string">&quot;do_iteration&quot;</span><span class="hs-cpp">
#endif
</span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-292"></span><span>        </span><span class="hs-comment">-- Remember the counts_so_far are reversed</span><span>
</span><span id="line-293"></span><span>        </span><span class="annot"><a href="#local-6989586621681917211"><span class="hs-identifier hs-type">totalise</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Opt.Stats.html#SimplCount"><span class="hs-identifier hs-type">SimplCount</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Stats.html#SimplCount"><span class="hs-identifier hs-type">SimplCount</span></a></span><span>
</span><span id="line-294"></span><span>        </span><span id="local-6989586621681917211"><span class="annot"><span class="annottext">totalise :: [SimplCount] -&gt; SimplCount
</span><a href="#local-6989586621681917211"><span class="hs-identifier hs-var hs-var">totalise</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SimplCount -&gt; SimplCount -&gt; SimplCount)
-&gt; SimplCount -&gt; [SimplCount] -&gt; SimplCount
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681917236"><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917236"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621681917237"><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917237"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917237"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCount -&gt; SimplCount -&gt; SimplCount
</span><a href="GHC.Core.Opt.Stats.html#plusSimplCount"><span class="hs-operator hs-var">`plusSimplCount`</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917236"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; SimplCount
</span><a href="GHC.Core.Opt.Stats.html#zeroSimplCount"><span class="hs-identifier hs-var">zeroSimplCount</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; SimplCount) -&gt; Bool -&gt; SimplCount
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; Bool
</span><a href="GHC.Utils.Logger.html#logHasDumpFlag"><span class="hs-identifier hs-var">logHasDumpFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917158"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_simpl_stats"><span class="hs-identifier hs-var">Opt_D_dump_simpl_stats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#dump_end_iteration"><span class="hs-identifier hs-type">dump_end_iteration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#NamePprCtx"><span class="hs-identifier hs-type">NamePprCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-298"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Stats.html#SimplCount"><span class="hs-identifier hs-type">SimplCount</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span id="dump_end_iteration"><span class="annot"><span class="annottext">dump_end_iteration :: Logger
-&gt; Bool
-&gt; NamePprCtx
-&gt; Int
-&gt; SimplCount
-&gt; CoreProgram
-&gt; [CoreRule]
-&gt; IO ()
</span><a href="GHC.Core.Opt.Simplify.html#dump_end_iteration"><span class="hs-identifier hs-var hs-var">dump_end_iteration</span></a></span></span><span> </span><span id="local-6989586621681917240"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917240"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681917241"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681917241"><span class="hs-identifier hs-var">dump_core_sizes</span></a></span></span><span> </span><span id="local-6989586621681917242"><span class="annot"><span class="annottext">NamePprCtx
</span><a href="#local-6989586621681917242"><span class="hs-identifier hs-var">name_ppr_ctx</span></a></span></span><span> </span><span id="local-6989586621681917243"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917243"><span class="hs-identifier hs-var">iteration_no</span></a></span></span><span> </span><span id="local-6989586621681917244"><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917244"><span class="hs-identifier hs-var">counts</span></a></span></span><span> </span><span id="local-6989586621681917245"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917245"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span id="local-6989586621681917246"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917246"><span class="hs-identifier hs-var">rules</span></a></span></span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger
-&gt; Bool
-&gt; NamePprCtx
-&gt; Maybe DumpFlag
-&gt; String
-&gt; SDoc
-&gt; CoreProgram
-&gt; [CoreRule]
-&gt; IO ()
</span><a href="GHC.Core.Lint.html#dumpPassResult"><span class="hs-identifier hs-var">dumpPassResult</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917240"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681917241"><span class="hs-identifier hs-var">dump_core_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">NamePprCtx
</span><a href="#local-6989586621681917242"><span class="hs-identifier hs-var">name_ppr_ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DumpFlag
</span><a href="#local-6989586621681917247"><span class="hs-identifier hs-var">mb_flag</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681917248"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621681917249"><span class="hs-identifier hs-var">pp_counts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917245"><span class="hs-identifier hs-var">binds</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681917246"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-302"></span><span>    </span><span id="local-6989586621681917247"><span class="annot"><span class="annottext">mb_flag :: Maybe DumpFlag
</span><a href="#local-6989586621681917247"><span class="hs-identifier hs-var hs-var">mb_flag</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; Bool
</span><a href="GHC.Utils.Logger.html#logHasDumpFlag"><span class="hs-identifier hs-var">logHasDumpFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681917240"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_simpl_iterations"><span class="hs-identifier hs-var">Opt_D_dump_simpl_iterations</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DumpFlag -&gt; Maybe DumpFlag
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_simpl_iterations"><span class="hs-identifier hs-var">Opt_D_dump_simpl_iterations</span></a></span><span>
</span><span id="line-303"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DumpFlag
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-304"></span><span>            </span><span class="hs-comment">-- Show details if Opt_D_dump_simpl_iterations is on</span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621681917248"><span class="annot"><span class="annottext">hdr :: String
</span><a href="#local-6989586621681917248"><span class="hs-identifier hs-var hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Simplifier iteration=&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../../base-4.18.2.1/src/GHC.Show.html#show/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681917243"><span class="hs-identifier hs-var">iteration_no</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span id="local-6989586621681917249"><span class="annot"><span class="annottext">pp_counts :: SDoc
</span><a href="#local-6989586621681917249"><span class="hs-identifier hs-var hs-var">pp_counts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;---- Simplifier counts for&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681917248"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-308"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SimplCount -&gt; SDoc
</span><a href="GHC.Core.Opt.Stats.html#pprSimplCount"><span class="hs-identifier hs-var">pprSimplCount</span></a></span><span> </span><span class="annot"><span class="annottext">SimplCount
</span><a href="#local-6989586621681917244"><span class="hs-identifier hs-var">counts</span></a></span><span>
</span><span id="line-309"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;---- End of simplifier counts for&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681917248"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Shorting out indirections
*                                                                      *
************************************************************************

If we have this:

        x_local = &lt;expression&gt;
        ...bindings...
        x_exported = x_local

where x_exported is exported, and x_local is not, then we replace it with this:

        x_exported = &lt;expression&gt;
        x_local = x_exported
        ...bindings...

Without this we never get rid of the x_exported = x_local thing.  This
save a gratuitous jump (from \tr{x_exported} to \tr{x_local}), and
makes strictness information propagate better.  This used to happen in
the final phase, but it's tidier to do it here.

Note [Messing up the exported Id's RULES]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We must be careful about discarding (obviously) or even merging the
RULES on the exported Id. The example that went bad on me at one stage
was this one:

    iterate :: (a -&gt; a) -&gt; a -&gt; [a]
        [Exported]
    iterate = iterateList

    iterateFB c f x = x `c` iterateFB c f (f x)
    iterateList f x =  x : iterateList f (f x)
        [Not exported]

    {-# RULES
    &quot;iterate&quot;   forall f x.     iterate f x = build (\c _n -&gt; iterateFB c f x)
    &quot;iterateFB&quot;                 iterateFB (:) = iterateList
     #-}

This got shorted out to:

    iterateList :: (a -&gt; a) -&gt; a -&gt; [a]
    iterateList = iterate

    iterateFB c f x = x `c` iterateFB c f (f x)
    iterate f x =  x : iterate f (f x)

    {-# RULES
    &quot;iterate&quot;   forall f x.     iterate f x = build (\c _n -&gt; iterateFB c f x)
    &quot;iterateFB&quot;                 iterateFB (:) = iterate
     #-}

And now we get an infinite loop in the rule system
        iterate f x -&gt; build (\cn -&gt; iterateFB c f x)
                    -&gt; iterateFB (:) f x
                    -&gt; iterate f x

Old &quot;solution&quot;:
        use rule switching-off pragmas to get rid
        of iterateList in the first place

But in principle the user *might* want rules that only apply to the Id
they say.  And inline pragmas are similar
   {-# NOINLINE f #-}
   f = local
   local = &lt;stuff&gt;
Then we do not want to get rid of the NOINLINE.

Hence hasShortableIdinfo.


Note [Rules and indirection-zapping]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Problem: what if x_exported has a RULE that mentions something in ...bindings...?
Then the things mentioned can be out of scope!  Solution
 a) Make sure that in this pass the usage-info from x_exported is
        available for ...bindings...
 b) If there are any such RULES, rec-ify the entire top-level.
    It'll get sorted out next time round

Other remarks
~~~~~~~~~~~~~
If more than one exported thing is equal to a local thing (i.e., the
local thing really is shared), then we do one only:
\begin{verbatim}
        x_local = ....
        x_exported1 = x_local
        x_exported2 = x_local
==&gt;
        x_exported1 = ....

        x_exported2 = x_exported1
\end{verbatim}

We rely on prior eta reduction to simplify things like
\begin{verbatim}
        x_exported = /\ tyvars -&gt; x_local tyvars
==&gt;
        x_exported = x_local
\end{verbatim}
Hence,there's a possibility of leaving unchanged something like this:
\begin{verbatim}
        x_local = ....
        x_exported1 = x_local Int
\end{verbatim}
By the time we've thrown away the types in STG land this
could be eliminated.  But I don't think it's very common
and it's dangerous to do this fiddling in STG land
because we might eliminate a binding that's mentioned in the
unfolding for something.

Note [Indirection zapping and ticks]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Unfortunately this is another place where we need a special case for
ticks. The following happens quite regularly:

        x_local = &lt;expression&gt;
        x_exported = tick&lt;x&gt; x_local

Which we want to become:

        x_exported =  tick&lt;x&gt; &lt;expression&gt;

As it makes no sense to keep the tick and the expression on separate
bindings. Note however that this might increase the ticks scoping
over the execution of x_local, so we can only do this for floatable
ticks. More often than not, other references will be unfoldings of
x_exported, and therefore carry the tick anyway.
-}</span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span class="hs-keyword">type</span><span> </span><span id="IndEnv"><span class="annot"><a href="GHC.Core.Opt.Simplify.html#IndEnv"><span class="hs-identifier hs-var">IndEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Tickish.html#CoreTickish"><span class="hs-identifier hs-type">CoreTickish</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Maps local_id -&gt; exported_id, ticks</span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#shortOutIndirections"><span class="hs-identifier hs-type">shortOutIndirections</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span>
</span><span id="line-448"></span><span id="shortOutIndirections"><span class="annot"><span class="annottext">shortOutIndirections :: CoreProgram -&gt; CoreProgram
</span><a href="GHC.Core.Opt.Simplify.html#shortOutIndirections"><span class="hs-identifier hs-var hs-var">shortOutIndirections</span></a></span></span><span> </span><span id="local-6989586621681917254"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917254"><span class="hs-identifier hs-var">binds</span></a></span></span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish]) -&gt; Bool
forall a. VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917256"><span class="hs-identifier hs-var">ind_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917254"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681917257"><span class="hs-identifier hs-var">no_need_to_flatten</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917258"><span class="hs-identifier hs-var">binds'</span></a></span><span>                      </span><span class="hs-comment">-- See Note [Rules and indirection-zapping]</span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; Bind Id
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreProgram -&gt; [(Id, CoreExpr)]
forall b. [Bind b] -&gt; [(b, Expr b)]
</span><a href="GHC.Core.html#flattenBinds"><span class="hs-identifier hs-var">flattenBinds</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917258"><span class="hs-identifier hs-var">binds'</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- for this no_need_to_flatten stuff</span><span>
</span><span id="line-452"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-453"></span><span>    </span><span id="local-6989586621681917256"><span class="annot"><span class="annottext">ind_env :: VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917256"><span class="hs-identifier hs-var hs-var">ind_env</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; VarEnv (Id, [CoreTickish])
</span><a href="GHC.Core.Opt.Simplify.html#makeIndEnv"><span class="hs-identifier hs-var">makeIndEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917254"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-comment">-- These exported Ids are the subjects  of the indirection-elimination</span><span>
</span><span id="line-455"></span><span>    </span><span id="local-6989586621681917262"><span class="annot"><span class="annottext">exp_ids :: [Id]
</span><a href="#local-6989586621681917262"><span class="hs-identifier hs-var hs-var">exp_ids</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Id, [CoreTickish]) -&gt; Id) -&gt; [(Id, [CoreTickish])] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, [CoreTickish]) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.2.1/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">([(Id, [CoreTickish])] -&gt; [Id]) -&gt; [(Id, [CoreTickish])] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish]) -&gt; [(Id, [CoreTickish])]
forall key elt. UniqFM key elt -&gt; [elt]
</span><a href="GHC.Types.Unique.FM.html#nonDetEltsUFM"><span class="hs-identifier hs-var">nonDetEltsUFM</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917256"><span class="hs-identifier hs-var">ind_env</span></a></span><span>
</span><span id="line-456"></span><span>      </span><span class="hs-comment">-- It's OK to use nonDetEltsUFM here because we forget the ordering</span><span>
</span><span id="line-457"></span><span>      </span><span class="hs-comment">-- by immediately converting to a set or check if all the elements</span><span>
</span><span id="line-458"></span><span>      </span><span class="hs-comment">-- satisfy a predicate.</span><span>
</span><span id="line-459"></span><span>    </span><span id="local-6989586621681917265"><span class="annot"><span class="annottext">exp_id_set :: VarSet
</span><a href="#local-6989586621681917265"><span class="hs-identifier hs-var hs-var">exp_id_set</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681917262"><span class="hs-identifier hs-var">exp_ids</span></a></span><span>
</span><span id="line-460"></span><span>    </span><span id="local-6989586621681917257"><span class="annot"><span class="annottext">no_need_to_flatten :: Bool
</span><a href="#local-6989586621681917257"><span class="hs-identifier hs-var hs-var">no_need_to_flatten</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#all/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreRule] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">([CoreRule] -&gt; Bool) -&gt; (Id -&gt; [CoreRule]) -&gt; Id -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">RuleInfo -&gt; [CoreRule]
</span><a href="GHC.Types.Id.Info.html#ruleInfoRules"><span class="hs-identifier hs-var">ruleInfoRules</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleInfo -&gt; [CoreRule]) -&gt; (Id -&gt; RuleInfo) -&gt; Id -&gt; [CoreRule]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; RuleInfo
</span><a href="GHC.Types.Id.html#idSpecialisation"><span class="hs-identifier hs-var">idSpecialisation</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681917262"><span class="hs-identifier hs-var">exp_ids</span></a></span><span>
</span><span id="line-461"></span><span>    </span><span id="local-6989586621681917258"><span class="annot"><span class="annottext">binds' :: CoreProgram
</span><a href="#local-6989586621681917258"><span class="hs-identifier hs-var hs-var">binds'</span></a></span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bind Id -&gt; CoreProgram) -&gt; CoreProgram -&gt; CoreProgram
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#concatMap/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id -&gt; CoreProgram
</span><a href="#local-6989586621681917272"><span class="hs-identifier hs-var">zap</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917254"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span>    </span><span id="local-6989586621681917272"><span class="annot"><span class="annottext">zap :: Bind Id -&gt; CoreProgram
</span><a href="#local-6989586621681917272"><span class="hs-identifier hs-var hs-var">zap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681917274"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917274"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681917275"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917275"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; Bind Id
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917276"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917277"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681917276"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917276"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681917277"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917277"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; [(Id, CoreExpr)]
</span><a href="#local-6989586621681917278"><span class="hs-identifier hs-var">zapPair</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917274"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917275"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-464"></span><span>    </span><span class="annot"><a href="#local-6989586621681917272"><span class="hs-identifier hs-var">zap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681917279"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681917279"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; Bind Id
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; [(Id, CoreExpr)])
-&gt; [(Id, CoreExpr)] -&gt; [(Id, CoreExpr)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#concatMap/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; [(Id, CoreExpr)]
</span><a href="#local-6989586621681917278"><span class="hs-identifier hs-var">zapPair</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681917279"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-465"></span><span>
</span><span id="line-466"></span><span>    </span><span id="local-6989586621681917278"><span class="annot"><span class="annottext">zapPair :: (Id, CoreExpr) -&gt; [(Id, CoreExpr)]
</span><a href="#local-6989586621681917278"><span class="hs-identifier hs-var hs-var">zapPair</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681917280"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917280"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681917281"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917281"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917280"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681917265"><span class="hs-identifier hs-var">exp_id_set</span></a></span><span>
</span><span id="line-468"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Kill the exported-id binding</span><span>
</span><span id="line-469"></span><span>
</span><span id="line-470"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681917283"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917283"><span class="hs-identifier hs-var">exp_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681917284"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681917284"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish]) -&gt; Id -&gt; Maybe (Id, [CoreTickish])
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917256"><span class="hs-identifier hs-var">ind_env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917280"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-471"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681917286"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917286"><span class="hs-identifier hs-var">exp_id'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681917287"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917287"><span class="hs-identifier hs-var">lcl_id'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id -&gt; (Id, Id)
</span><a href="GHC.Core.Opt.Simplify.html#transferIdInfo"><span class="hs-identifier hs-var">transferIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917283"><span class="hs-identifier hs-var">exp_id</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917280"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-472"></span><span>        </span><span class="hs-glyph">=</span><span>      </span><span class="hs-comment">-- Turn a local-id binding into two bindings</span><span>
</span><span id="line-473"></span><span>               </span><span class="hs-comment">--    exp_id = rhs; lcl_id = exp_id</span><span>
</span><span id="line-474"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917286"><span class="hs-identifier hs-var">exp_id'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreTickish] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.Utils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681917284"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917281"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-475"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917287"><span class="hs-identifier hs-var">lcl_id'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917286"><span class="hs-identifier hs-var">exp_id'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-478"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917280"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917281"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#makeIndEnv"><span class="hs-identifier hs-type">makeIndEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#IndEnv"><span class="hs-identifier hs-type">IndEnv</span></a></span><span>
</span><span id="line-481"></span><span id="makeIndEnv"><span class="annot"><span class="annottext">makeIndEnv :: CoreProgram -&gt; VarEnv (Id, [CoreTickish])
</span><a href="GHC.Core.Opt.Simplify.html#makeIndEnv"><span class="hs-identifier hs-var hs-var">makeIndEnv</span></a></span></span><span> </span><span id="local-6989586621681917291"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917291"><span class="hs-identifier hs-var">binds</span></a></span></span><span>
</span><span id="line-482"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarEnv (Id, [CoreTickish])
 -&gt; Bind Id -&gt; VarEnv (Id, [CoreTickish]))
-&gt; VarEnv (Id, [CoreTickish])
-&gt; CoreProgram
-&gt; VarEnv (Id, [CoreTickish])
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldl%27/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish]) -&gt; Bind Id -&gt; VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917293"><span class="hs-identifier hs-var">add_bind</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681917291"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-483"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-484"></span><span>    </span><span class="annot"><a href="#local-6989586621681917293"><span class="hs-identifier hs-type">add_bind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#IndEnv"><span class="hs-identifier hs-type">IndEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#IndEnv"><span class="hs-identifier hs-type">IndEnv</span></a></span><span>
</span><span id="line-485"></span><span>    </span><span id="local-6989586621681917293"><span class="annot"><span class="annottext">add_bind :: VarEnv (Id, [CoreTickish]) -&gt; Bind Id -&gt; VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917293"><span class="hs-identifier hs-var hs-var">add_bind</span></a></span></span><span> </span><span id="local-6989586621681917295"><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917295"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681917296"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917296"><span class="hs-identifier hs-var">exported_id</span></a></span></span><span> </span><span id="local-6989586621681917297"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917297"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
-&gt; (Id, CoreExpr) -&gt; VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917298"><span class="hs-identifier hs-var">add_pair</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917295"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917296"><span class="hs-identifier hs-var">exported_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917297"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>    </span><span class="annot"><a href="#local-6989586621681917293"><span class="hs-identifier hs-var">add_bind</span></a></span><span> </span><span id="local-6989586621681917299"><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917299"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681917300"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681917300"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarEnv (Id, [CoreTickish])
 -&gt; (Id, CoreExpr) -&gt; VarEnv (Id, [CoreTickish]))
-&gt; VarEnv (Id, [CoreTickish])
-&gt; [(Id, CoreExpr)]
-&gt; VarEnv (Id, [CoreTickish])
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldl%27/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
-&gt; (Id, CoreExpr) -&gt; VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917298"><span class="hs-identifier hs-var">add_pair</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917299"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681917300"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span>    </span><span class="annot"><a href="#local-6989586621681917298"><span class="hs-identifier hs-type">add_pair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#IndEnv"><span class="hs-identifier hs-type">IndEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#IndEnv"><span class="hs-identifier hs-type">IndEnv</span></a></span><span>
</span><span id="line-489"></span><span>    </span><span id="local-6989586621681917298"><span class="annot"><span class="annottext">add_pair :: VarEnv (Id, [CoreTickish])
-&gt; (Id, CoreExpr) -&gt; VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917298"><span class="hs-identifier hs-var hs-var">add_pair</span></a></span></span><span> </span><span id="local-6989586621681917301"><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917301"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681917302"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917302"><span class="hs-identifier hs-var">exported_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681917303"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917303"><span class="hs-identifier hs-var">exported</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681917304"><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681917304"><span class="hs-identifier hs-var">ticks</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681917305"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917305"><span class="hs-identifier hs-var">local_id</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; CoreExpr -&gt; ([CoreTickish], CoreExpr)
forall b.
(CoreTickish -&gt; Bool) -&gt; Expr b -&gt; ([CoreTickish], Expr b)
</span><a href="GHC.Core.Utils.html#stripTicksTop"><span class="hs-identifier hs-var">stripTicksTop</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681917303"><span class="hs-identifier hs-var">exported</span></a></span><span>
</span><span id="line-491"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish]) -&gt; Id -&gt; Id -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.html#shortMeOut"><span class="hs-identifier hs-var">shortMeOut</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917301"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917302"><span class="hs-identifier hs-var">exported_id</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917305"><span class="hs-identifier hs-var">local_id</span></a></span><span>
</span><span id="line-492"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
-&gt; Id -&gt; (Id, [CoreTickish]) -&gt; VarEnv (Id, [CoreTickish])
forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917301"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917305"><span class="hs-identifier hs-var">local_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917302"><span class="hs-identifier hs-var">exported_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681917304"><span class="hs-identifier hs-var">ticks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span>    </span><span class="annot"><a href="#local-6989586621681917298"><span class="hs-identifier hs-var">add_pair</span></a></span><span> </span><span id="local-6989586621681917309"><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917309"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917309"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#shortMeOut"><span class="hs-identifier hs-type">shortMeOut</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#IndEnv"><span class="hs-identifier hs-type">IndEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-496"></span><span id="shortMeOut"><span class="annot"><span class="annottext">shortMeOut :: VarEnv (Id, [CoreTickish]) -&gt; Id -&gt; Id -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.html#shortMeOut"><span class="hs-identifier hs-var hs-var">shortMeOut</span></a></span></span><span> </span><span id="local-6989586621681917310"><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917310"><span class="hs-identifier hs-var">ind_env</span></a></span></span><span> </span><span id="local-6989586621681917311"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917311"><span class="hs-identifier hs-var">exported_id</span></a></span></span><span> </span><span id="local-6989586621681917312"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917312"><span class="hs-identifier hs-var">local_id</span></a></span></span><span>
</span><span id="line-497"></span><span class="hs-comment">-- The if-then-else stuff is just so I can get a pprTrace to see</span><span>
</span><span id="line-498"></span><span class="hs-comment">-- how often I don't get shorting out because of IdInfo stuff</span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isExportedId"><span class="hs-identifier hs-var">isExportedId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917311"><span class="hs-identifier hs-var">exported_id</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>              </span><span class="hs-comment">-- Only if this is exported</span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span>       </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917312"><span class="hs-identifier hs-var">local_id</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>                    </span><span class="hs-comment">-- Only if this one is defined in this</span><span>
</span><span id="line-502"></span><span>                                                </span><span class="hs-comment">--      module, so that we *can* change its</span><span>
</span><span id="line-503"></span><span>                                                </span><span class="hs-comment">--      binding to be the exported thing!</span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isExportedId"><span class="hs-identifier hs-var">isExportedId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917312"><span class="hs-identifier hs-var">local_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>           </span><span class="hs-comment">-- Only if this one is not itself exported,</span><span>
</span><span id="line-506"></span><span>                                                </span><span class="hs-comment">--      since the transformation will nuke it</span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917312"><span class="hs-identifier hs-var">local_id</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarEnv (Id, [CoreTickish]) -&gt; Bool
forall a. Id -&gt; VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemVarEnv"><span class="hs-operator hs-var">`elemVarEnv`</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv (Id, [CoreTickish])
</span><a href="#local-6989586621681917310"><span class="hs-identifier hs-var">ind_env</span></a></span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Only if not already substituted for</span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-keyword">then</span><span>
</span><span id="line-510"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.html#hasShortableIdInfo"><span class="hs-identifier hs-var">hasShortableIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917311"><span class="hs-identifier hs-var">exported_id</span></a></span><span>
</span><span id="line-511"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>       </span><span class="hs-comment">-- See Note [Messing up the exported Id's RULES]</span><span>
</span><span id="line-512"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; String -&gt; SDoc -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Not shorting out&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917311"><span class="hs-identifier hs-var">exported_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-513"></span><span>    </span><span class="hs-keyword">else</span><span>
</span><span id="line-514"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-515"></span><span>
</span><span id="line-516"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#hasShortableIdInfo"><span class="hs-identifier hs-type">hasShortableIdInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-517"></span><span class="hs-comment">-- True if there is no user-attached IdInfo on exported_id,</span><span>
</span><span id="line-518"></span><span class="hs-comment">-- so we can safely discard it</span><span>
</span><span id="line-519"></span><span class="hs-comment">-- See Note [Messing up the exported Id's RULES]</span><span>
</span><span id="line-520"></span><span id="hasShortableIdInfo"><span class="annot"><span class="annottext">hasShortableIdInfo :: Id -&gt; Bool
</span><a href="GHC.Core.Opt.Simplify.html#hasShortableIdInfo"><span class="hs-identifier hs-var hs-var">hasShortableIdInfo</span></a></span></span><span> </span><span id="local-6989586621681917318"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917318"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-521"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">RuleInfo -&gt; Bool
</span><a href="GHC.Types.Id.Info.html#isEmptyRuleInfo"><span class="hs-identifier hs-var">isEmptyRuleInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; RuleInfo
</span><a href="GHC.Types.Id.Info.html#ruleInfo"><span class="hs-identifier hs-var">ruleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917321"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-522"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">InlinePragma -&gt; Bool
</span><a href="GHC.Types.Basic.html#isDefaultInlinePragma"><span class="hs-identifier hs-var">isDefaultInlinePragma</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; InlinePragma
</span><a href="GHC.Types.Id.Info.html#inlinePragInfo"><span class="hs-identifier hs-var">inlinePragInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917321"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding
</span><a href="GHC.Types.Id.Info.html#realUnfoldingInfo"><span class="hs-identifier hs-var">realUnfoldingInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917321"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-524"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-525"></span><span>     </span><span id="local-6989586621681917321"><span class="annot"><span class="annottext">info :: IdInfo
</span><a href="#local-6989586621681917321"><span class="hs-identifier hs-var hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Id -&gt; IdInfo
Id -&gt; IdInfo
</span><a href="GHC.Types.Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917318"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span class="hs-comment">{- Note [Transferring IdInfo]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have
     lcl_id = e; exp_id = lcl_id

and lcl_id has useful IdInfo, we don't want to discard it by going
     gbl_id = e; lcl_id = gbl_id

Instead, transfer IdInfo from lcl_id to exp_id, specifically
* (Stable) unfolding
* Strictness
* Rules
* Inline pragma

Overwriting, rather than merging, seems to work ok.

For the lcl_id we

* Zap the InlinePragma. It might originally have had a NOINLINE, which
  we have now transferred; and we really want the lcl_id to inline now
  that its RHS is trivial!

* Zap any Stable unfolding.  agian, we want lcl_id = gbl_id to inline,
  replacing lcl_id by gbl_id. That won't happen if lcl_id has its original
  great big Stable unfolding
-}</span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span class="annot"><a href="GHC.Core.Opt.Simplify.html#transferIdInfo"><span class="hs-identifier hs-type">transferIdInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-555"></span><span class="hs-comment">-- See Note [Transferring IdInfo]</span><span>
</span><span id="line-556"></span><span id="transferIdInfo"><span class="annot"><span class="annottext">transferIdInfo :: Id -&gt; Id -&gt; (Id, Id)
</span><a href="GHC.Core.Opt.Simplify.html#transferIdInfo"><span class="hs-identifier hs-var hs-var">transferIdInfo</span></a></span></span><span> </span><span id="local-6989586621681917327"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917327"><span class="hs-identifier hs-var">exported_id</span></a></span></span><span> </span><span id="local-6989586621681917328"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917328"><span class="hs-identifier hs-var">local_id</span></a></span></span><span>
</span><span id="line-557"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; (IdInfo -&gt; IdInfo) -&gt; Id -&gt; Id
(IdInfo -&gt; IdInfo) -&gt; Id -&gt; Id
</span><a href="GHC.Types.Id.html#modifyIdInfo"><span class="hs-identifier hs-var">modifyIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; IdInfo
</span><a href="#local-6989586621681917330"><span class="hs-identifier hs-var">transfer</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917327"><span class="hs-identifier hs-var">exported_id</span></a></span><span>
</span><span id="line-558"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; (IdInfo -&gt; IdInfo) -&gt; Id -&gt; Id
(IdInfo -&gt; IdInfo) -&gt; Id -&gt; Id
</span><a href="GHC.Types.Id.html#modifyIdInfo"><span class="hs-identifier hs-var">modifyIdInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; IdInfo
</span><a href="#local-6989586621681917331"><span class="hs-identifier hs-var">zap_info</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917328"><span class="hs-identifier hs-var">local_id</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-559"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-560"></span><span>    </span><span id="local-6989586621681917332"><span class="annot"><span class="annottext">local_info :: IdInfo
</span><a href="#local-6989586621681917332"><span class="hs-identifier hs-var hs-var">local_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Id -&gt; IdInfo
Id -&gt; IdInfo
</span><a href="GHC.Types.Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917328"><span class="hs-identifier hs-var">local_id</span></a></span><span>
</span><span id="line-561"></span><span>    </span><span id="local-6989586621681917330"><span class="annot"><span class="annottext">transfer :: IdInfo -&gt; IdInfo
</span><a href="#local-6989586621681917330"><span class="hs-identifier hs-var hs-var">transfer</span></a></span></span><span> </span><span id="local-6989586621681917333"><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917333"><span class="hs-identifier hs-var">exp_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917333"><span class="hs-identifier hs-var">exp_info</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; DmdSig -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setDmdSigInfo"><span class="hs-operator hs-var">`setDmdSigInfo`</span></a></span><span>     </span><span class="annot"><span class="annottext">IdInfo -&gt; DmdSig
</span><a href="GHC.Types.Id.Info.html#dmdSigInfo"><span class="hs-identifier hs-var">dmdSigInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917332"><span class="hs-identifier hs-var">local_info</span></a></span><span>
</span><span id="line-562"></span><span>                                 </span><span class="annot"><span class="annottext">IdInfo -&gt; CprSig -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setCprSigInfo"><span class="hs-operator hs-var">`setCprSigInfo`</span></a></span><span>     </span><span class="annot"><span class="annottext">IdInfo -&gt; CprSig
</span><a href="GHC.Types.Id.Info.html#cprSigInfo"><span class="hs-identifier hs-var">cprSigInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917332"><span class="hs-identifier hs-var">local_info</span></a></span><span>
</span><span id="line-563"></span><span>                                 </span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setUnfoldingInfo"><span class="hs-operator hs-var">`setUnfoldingInfo`</span></a></span><span>  </span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding
</span><a href="GHC.Types.Id.Info.html#realUnfoldingInfo"><span class="hs-identifier hs-var">realUnfoldingInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917332"><span class="hs-identifier hs-var">local_info</span></a></span><span>
</span><span id="line-564"></span><span>                                 </span><span class="annot"><span class="annottext">IdInfo -&gt; InlinePragma -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setInlinePragInfo"><span class="hs-operator hs-var">`setInlinePragInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; InlinePragma
</span><a href="GHC.Types.Id.Info.html#inlinePragInfo"><span class="hs-identifier hs-var">inlinePragInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917332"><span class="hs-identifier hs-var">local_info</span></a></span><span>
</span><span id="line-565"></span><span>                                 </span><span class="annot"><span class="annottext">IdInfo -&gt; RuleInfo -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setRuleInfo"><span class="hs-operator hs-var">`setRuleInfo`</span></a></span><span>       </span><span class="annot"><span class="annottext">RuleInfo -&gt; RuleInfo -&gt; RuleInfo
</span><a href="GHC.Core.Rules.html#addRuleInfo"><span class="hs-identifier hs-var">addRuleInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; RuleInfo
</span><a href="GHC.Types.Id.Info.html#ruleInfo"><span class="hs-identifier hs-var">ruleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917333"><span class="hs-identifier hs-var">exp_info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RuleInfo
</span><a href="#local-6989586621681917342"><span class="hs-identifier hs-var">new_info</span></a></span><span>
</span><span id="line-566"></span><span>    </span><span id="local-6989586621681917342"><span class="annot"><span class="annottext">new_info :: RuleInfo
</span><a href="#local-6989586621681917342"><span class="hs-identifier hs-var hs-var">new_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; RuleInfo -&gt; RuleInfo
</span><a href="GHC.Types.Id.Info.html#setRuleInfoHead"><span class="hs-identifier hs-var">setRuleInfoHead</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681917327"><span class="hs-identifier hs-var">exported_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-567"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; RuleInfo
</span><a href="GHC.Types.Id.Info.html#ruleInfo"><span class="hs-identifier hs-var">ruleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917332"><span class="hs-identifier hs-var">local_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>        </span><span class="hs-comment">-- Remember to set the function-name field of the</span><span>
</span><span id="line-569"></span><span>        </span><span class="hs-comment">-- rules as we transfer them from one function to another</span><span>
</span><span id="line-570"></span><span>
</span><span id="line-571"></span><span>    </span><span id="local-6989586621681917331"><span class="annot"><span class="annottext">zap_info :: IdInfo -&gt; IdInfo
</span><a href="#local-6989586621681917331"><span class="hs-identifier hs-var hs-var">zap_info</span></a></span></span><span> </span><span id="local-6989586621681917345"><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917345"><span class="hs-identifier hs-var">lcl_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681917345"><span class="hs-identifier hs-var">lcl_info</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; InlinePragma -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setInlinePragInfo"><span class="hs-operator hs-var">`setInlinePragInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="GHC.Types.Basic.html#defaultInlinePragma"><span class="hs-identifier hs-var">defaultInlinePragma</span></a></span><span>
</span><span id="line-572"></span><span>                                 </span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding -&gt; IdInfo
</span><a href="GHC.Types.Id.Info.html#setUnfoldingInfo"><span class="hs-operator hs-var">`setUnfoldingInfo`</span></a></span><span>  </span><span class="annot"><span class="annottext">Unfolding
</span><a href="GHC.Core.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a></span><span>
</span><span id="line-573"></span></pre></body></html>