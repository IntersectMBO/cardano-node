<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span>
</span><span id="line-2"></span><span class="hs-comment">-- | Constructed Product Result analysis. Identifies functions that surely</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- return heap-allocated records on every code path, so that we can eliminate</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- said heap allocation by performing a worker/wrapper split.</span><span>
</span><span id="line-5"></span><span class="hs-comment">--</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- See https://www.microsoft.com/en-us/research/publication/constructed-product-result-analysis-haskell/.</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- CPR analysis should happen after strictness analysis.</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- See Note [Phase ordering].</span><span>
</span><span id="line-9"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Core.Opt.CprAnal</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnalProgram"><span class="hs-identifier">cprAnalProgram</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html"><span class="hs-identifier">GHC.Driver.Flags</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.Flags.html#DumpFlag"><span class="hs-identifier">DumpFlag</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#runRWKey"><span class="hs-identifier">runRWKey</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html"><span class="hs-identifier">GHC.Types.Cpr</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.MemoFun.html"><span class="hs-identifier">GHC.Types.Unique.MemoFun</span></a></span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html"><span class="hs-identifier">GHC.Core.FamInstEnv</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Seq.html"><span class="hs-identifier">GHC.Core.Seq</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html"><span class="hs-identifier">GHC.Core.Opt.WorkWrap.Utils</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Graph.UnVar.html"><span class="hs-identifier">GHC.Data.Graph.UnVar</span></a></span><span> </span><span class="hs-comment">-- for UnVarSet</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html"><span class="hs-identifier">GHC.Utils.Logger</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier">Logger</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#putDumpFileMaybe"><span class="hs-identifier">putDumpFileMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#DumpFormat"><span class="hs-identifier">DumpFormat</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.List.html#/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapAccumL/Data.Traversable.html#mapAccumL"><span class="hs-identifier">mapAccumL</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-comment">{- Note [Constructed Product Result]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The goal of Constructed Product Result analysis is to identify functions that
surely return heap-allocated records on every code path, so that we can
eliminate said heap allocation by performing a worker/wrapper split
(via 'GHC.Core.Opt.WorkWrap.Utils.mkWWcpr_entry').

`swap` below is such a function:
```
  swap (a, b) = (b, a)
```
A `case` on an application of `swap`, like
`case swap (10, 42) of (a, b) -&gt; a + b` could cancel away
(by case-of-known-constructor) if we \&quot;inlined\&quot; `swap` and simplified. We then
say that `swap` has the CPR property.

We can't inline recursive functions, but similar reasoning applies there:
```
  f x n = case n of
    0 -&gt; (x, 0)
    _ -&gt; f (x+1) (n-1)
```
Inductively, `case f 1 2 of (a, b) -&gt; a + b` could cancel away the constructed
product with the case. So `f`, too, has the CPR property. But we can't really
&quot;inline&quot; `f`, because it's recursive. Also, non-recursive functions like `swap`
might be too big to inline (or even marked NOINLINE). We still want to exploit
the CPR property, and that is exactly what the worker/wrapper transformation
can do for us:
```
  $wf x n = case n of
    0 -&gt; case (x, 0) of -&gt; (a, b) -&gt; (# a, b #)
    _ -&gt; case f (x+1) (n-1) of (a, b) -&gt; (# a, b #)
  f x n = case $wf x n of (# a, b #) -&gt; (a, b)
```
where $wf readily simplifies (by case-of-known-constructor and inlining `f`) to:
```
  $wf x n = case n of
    0 -&gt; (# x, 0 #)
    _ -&gt; $wf (x+1) (n-1)
```
Now, a call site like `case f 1 2 of (a, b) -&gt; a + b` can inline `f` and
eliminate the heap-allocated pair constructor.

Note [Nested CPR]
~~~~~~~~~~~~~~~~~
We can apply Note [Constructed Product Result] deeper than just the top-level
result constructor of a function, e.g.,
```
  g x
    | even x = (x+1,x+2) :: (Int, Int)
    | odd  x = (x+2,x+3)
```
Not only does `g` return a constructed pair, the pair components /also/ have the
CPR property. We can split `g` for its /nested/ CPR property, as follows:
```
  $wg (x :: Int#)
    | .. x .. = (# x +# 1#, x +# 2# #) :: (# Int#, Int# #)
    | .. x .. = (# x +# 2#, x +# 3# #)
  g (I# x) = case $wf x of (# y, z #) -&gt; (I# y, I# z)
```
Note however that in the following we will only unbox the second component,
even if `foo` has the CPR property:
```
  h x
    | even x = (foo x, x+2) :: (Int, Int)
    | odd  x = (x+2,   x+3)
    -- where `foo` has the CPR property
```
Why can't we also unbox `foo x`? Because in order to do so, we have to evaluate
it and that might diverge, so we cannot give `h` the nested CPR property in the
first component of the result.

The Right Thing is to do a termination analysis, to see if we can guarantee that
`foo` terminates quickly, in which case we can speculatively evaluate `foo x` and
hence give `h` a nested CPR property.  That is done in !1866.  But for now we
have an incredibly simple termination analysis; an expression terminates fast
iff it is in HNF: see `exprTerminates`. We call `exprTerminates` in
`cprTransformDataConWork`, which is the main function figuring out whether it's
OK to propagate nested CPR info (in `extract_nested_cpr`).

In addition to `exprTerminates`, `extract_nested_cpr` also looks at the
`StrictnessMark` of the corresponding constructor field. Example:
```
  data T a = MkT !a
  h2 x
    | even x = MkT (foo x) :: T Int
    | odd  x = MkT (x+2)
    -- where `foo` has the CPR property
```
Regardless of whether or not `foo` terminates, we may unbox the strict field,
because it has to be evaluated (the Core for `MkT (foo x)` will look more like
`case foo x of y { __DEFAULT -&gt; MkT y }`).

Surprisingly, there are local binders with a strict demand that *do not*
terminate quickly in a sense that is useful to us! The following function
demonstrates that:
```
  j x = (let t = x+1 in t+t, 42)
```
Here, `t` is used strictly, *but only within its scope in the first pair
component*. `t` satisfies Note [CPR for binders that will be unboxed], so it has
the CPR property, nevertheless we may not unbox `j` deeply lest evaluation of
`x` diverges. The termination analysis must say &quot;Might diverge&quot; for `t` and we
won't unbox the first pair component.
There are a couple of tests in T18174 that show case Nested CPR. Some of them
only work with the termination analysis from !1866.

Giving the (Nested) CPR property to deep data structures can lead to loss of
sharing; see Note [CPR for data structures can destroy sharing].

Note [Phase ordering]
~~~~~~~~~~~~~~~~~~~~~
We need to perform strictness analysis before CPR analysis, because that might
unbox some arguments, in turn leading to more constructed products.
Ideally, we would want the following pipeline:

1. Strictness
2. worker/wrapper (for strictness)
3. CPR
4. worker/wrapper (for CPR)

Currently, we omit 2. and anticipate the results of worker/wrapper.
See Note [CPR for binders that will be unboxed].
An additional w/w pass would simplify things, but probably add slight overhead.
So currently we have

1. Strictness
2. CPR
3. worker/wrapper (for strictness and CPR)
-}</span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="hs-comment">--</span><span>
</span><span id="line-174"></span><span class="annot"><span class="hs-comment">-- * Analysing programs</span></span><span>
</span><span id="line-175"></span><span class="hs-comment">--</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnalProgram"><span class="hs-identifier hs-type">cprAnalProgram</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span>
</span><span id="line-178"></span><span id="cprAnalProgram"><span class="annot"><span class="annottext">cprAnalProgram :: Logger -&gt; FamInstEnvs -&gt; CoreProgram -&gt; IO CoreProgram
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalProgram"><span class="hs-identifier hs-var hs-var">cprAnalProgram</span></a></span></span><span> </span><span id="local-6989586621681825532"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681825532"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681825533"><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681825533"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span id="local-6989586621681825534"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681825534"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681825535"><span class="annot"><span class="annottext">env :: AnalEnv
</span><a href="#local-6989586621681825535"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#emptyAnalEnv"><span class="hs-identifier hs-var">emptyAnalEnv</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681825533"><span class="hs-identifier hs-var">fam_envs</span></a></span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681825537"><span class="annot"><span class="annottext">binds_plus_cpr :: CoreProgram
</span><a href="#local-6989586621681825537"><span class="hs-identifier hs-var hs-var">binds_plus_cpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AnalEnv, CoreProgram) -&gt; CoreProgram
forall a b. (a, b) -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#snd/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">((AnalEnv, CoreProgram) -&gt; CoreProgram)
-&gt; (AnalEnv, CoreProgram) -&gt; CoreProgram
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(AnalEnv -&gt; CoreBind -&gt; (AnalEnv, CoreBind))
-&gt; AnalEnv -&gt; CoreProgram -&gt; (AnalEnv, CoreProgram)
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapAccumL/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; CoreBind -&gt; (AnalEnv, CoreBind)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalTopBind"><span class="hs-identifier hs-var">cprAnalTopBind</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825535"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681825534"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><span class="annottext">Logger -&gt; DumpFlag -&gt; String -&gt; DumpFormat -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Logger.html#putDumpFileMaybe"><span class="hs-identifier hs-var">putDumpFileMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681825532"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DumpFlag
</span><a href="GHC.Driver.Flags.html#Opt_D_dump_cpr_signatures"><span class="hs-identifier hs-var">Opt_D_dump_cpr_signatures</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cpr signatures&quot;</span></span><span> </span><span class="annot"><span class="annottext">DumpFormat
</span><a href="GHC.Utils.Logger.html#FormatText"><span class="hs-identifier hs-var">FormatText</span></a></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; IO ()) -&gt; SDoc -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-182"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; (IdInfo -&gt; SDoc) -&gt; CoreProgram -&gt; SDoc
</span><a href="GHC.Core.Utils.html#dumpIdInfoOfProgram"><span class="hs-identifier hs-var">dumpIdInfoOfProgram</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprSig -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">(CprSig -&gt; SDoc) -&gt; (IdInfo -&gt; CprSig) -&gt; IdInfo -&gt; SDoc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; CprSig
</span><a href="GHC.Types.Id.Info.html#cprSigInfo"><span class="hs-identifier hs-var">cprSigInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681825537"><span class="hs-identifier hs-var">binds_plus_cpr</span></a></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-comment">-- See Note [Stamp out space leaks in demand analysis] in GHC.Core.Opt.DmdAnal</span><span>
</span><span id="line-184"></span><span>  </span><span class="annot"><span class="annottext">CoreProgram -&gt; ()
</span><a href="GHC.Core.Seq.html#seqBinds"><span class="hs-identifier hs-var">seqBinds</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681825537"><span class="hs-identifier hs-var">binds_plus_cpr</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; IO CoreProgram -&gt; IO CoreProgram
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; IO CoreProgram
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681825537"><span class="hs-identifier hs-var">binds_plus_cpr</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">-- Analyse a (group of) top-level binding(s)</span><span>
</span><span id="line-187"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnalTopBind"><span class="hs-identifier hs-type">cprAnalTopBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-188"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span>
</span><span id="line-189"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span id="cprAnalTopBind"><span class="annot"><span class="annottext">cprAnalTopBind :: AnalEnv -&gt; CoreBind -&gt; (AnalEnv, CoreBind)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalTopBind"><span class="hs-identifier hs-var hs-var">cprAnalTopBind</span></a></span></span><span> </span><span id="local-6989586621681825547"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825547"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681825549"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825549"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681825550"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825550"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825551"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Expr Id -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825552"><span class="hs-identifier hs-var">id'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825553"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825552"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825552"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825553"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825553"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825551"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825551"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; Expr Id -&gt; (Id, Expr Id, AnalEnv)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalBind"><span class="hs-identifier hs-var">cprAnalBind</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825547"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825549"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825550"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnalTopBind"><span class="hs-identifier hs-var">cprAnalTopBind</span></a></span><span> </span><span id="local-6989586621681825555"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825555"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681825557"><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825557"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825558"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825559"><span class="hs-identifier hs-var">pairs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825558"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825558"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825559"><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825559"><span class="hs-identifier hs-var">pairs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; [(Id, Expr Id)] -&gt; (AnalEnv, [(Id, Expr Id)])
</span><a href="GHC.Core.Opt.CprAnal.html#cprFix"><span class="hs-identifier hs-var">cprFix</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825555"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825557"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span class="hs-comment">--</span><span>
</span><span id="line-201"></span><span class="annot"><span class="hs-comment">-- * Analysing expressions</span></span><span>
</span><span id="line-202"></span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span class="hs-comment">-- | The abstract semantic function &#10214;_&#10215; : Expr -&gt; Env -&gt; A from</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- &quot;Constructed Product Result Analysis for Haskell&quot;</span><span>
</span><span id="line-206"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-type">cprAnal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-type">cprAnal'</span></a></span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>            </span><span class="annot"><span class="hs-comment">-- ^ expression to be denoted by a 'CprType'</span></span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ the updated expression and its 'CprType'</span></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span id="cprAnal"><span class="annot"><span class="annottext">cprAnal :: AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var hs-var">cprAnal</span></a></span></span><span> </span><span id="local-6989586621681825565"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825565"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825566"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825566"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTraceWith &quot;cprAnal&quot; (\res -&gt; ppr (fst (res)) $$ ppr e) $</span><span>
</span><span id="line-212"></span><span>                  </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-var">cprAnal'</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825565"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825566"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span id="cprAnal%27"><span class="annot"><span class="annottext">cprAnal' :: AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-var hs-var">cprAnal'</span></a></span></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621681825568"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681825568"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType
</span><a href="GHC.Types.Cpr.html#topCprType"><span class="hs-identifier hs-var">topCprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Expr Id
forall b. Literal -&gt; Expr b
</span><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-var">Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681825568"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-var">cprAnal'</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621681825571"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681825571"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType
</span><a href="GHC.Types.Cpr.html#topCprType"><span class="hs-identifier hs-var">topCprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Expr Id
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681825571"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Doesn't happen, in fact</span><span>
</span><span id="line-216"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-var">cprAnal'</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621681825573"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681825573"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType
</span><a href="GHC.Types.Cpr.html#topCprType"><span class="hs-identifier hs-var">topCprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Expr Id
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681825573"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-var">cprAnal'</span></a></span><span> </span><span id="local-6989586621681825574"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825574"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681825576"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825576"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681825577"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681825577"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825578"><span class="hs-identifier hs-var">cpr_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Coercion -&gt; Expr Id
forall b. Expr b -&gt; Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825579"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681825577"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825578"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825578"><span class="hs-identifier hs-var">cpr_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825579"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825579"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var">cprAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825574"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825576"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-var">cprAnal'</span></a></span><span> </span><span id="local-6989586621681825580"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825580"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621681825582"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681825582"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621681825583"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825583"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825584"><span class="hs-identifier hs-var">cpr_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Expr Id -&gt; Expr Id
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681825582"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825585"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825584"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825584"><span class="hs-identifier hs-var">cpr_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825585"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825585"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var">cprAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825580"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825583"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-var">cprAnal'</span></a></span><span> </span><span id="local-6989586621681825586"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825586"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825587"><span class="annot"><span class="annottext">e :: Expr Id
</span><a href="#local-6989586621681825587"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; [(CprType, Expr Id)] -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalApp"><span class="hs-identifier hs-var">cprAnalApp</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825586"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825587"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-230"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-var">cprAnal'</span></a></span><span> </span><span id="local-6989586621681825590"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825590"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825591"><span class="annot"><span class="annottext">e :: Expr Id
</span><a href="#local-6989586621681825591"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; [(CprType, Expr Id)] -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalApp"><span class="hs-identifier hs-var">cprAnalApp</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825590"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825591"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-var">cprAnal'</span></a></span><span> </span><span id="local-6989586621681825593"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825593"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681825595"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825595"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621681825596"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825596"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825595"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681825598"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825598"><span class="hs-identifier hs-var">body_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825599"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825599"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var">cprAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825593"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825596"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825598"><span class="hs-identifier hs-var">body_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Expr Id -&gt; Expr Id
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825595"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825599"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825600"><span class="hs-identifier hs-var">lam_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Expr Id -&gt; Expr Id
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825595"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825601"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-comment">-- See Note [CPR for binders that will be unboxed]</span><span>
</span><span id="line-241"></span><span>    </span><span id="local-6989586621681825602"><span class="annot"><span class="annottext">env' :: AnalEnv
</span><a href="#local-6989586621681825602"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvForArg"><span class="hs-identifier hs-var">extendSigEnvForArg</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825593"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825595"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825604"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825604"><span class="hs-identifier hs-var">body_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825601"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825601"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var">cprAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825602"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825596"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-243"></span><span>    </span><span id="local-6989586621681825600"><span class="annot"><span class="annottext">lam_ty :: CprType
</span><a href="#local-6989586621681825600"><span class="hs-identifier hs-var hs-var">lam_ty</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprType -&gt; CprType
</span><a href="GHC.Types.Cpr.html#abstractCprTy"><span class="hs-identifier hs-var">abstractCprTy</span></a></span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825604"><span class="hs-identifier hs-var">body_ty</span></a></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-var">cprAnal'</span></a></span><span> </span><span id="local-6989586621681825606"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825606"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621681825608"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825608"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621681825609"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825609"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621681825610"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681825610"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681825611"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681825611"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825612"><span class="hs-identifier hs-var">res_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Id -&gt; Type -&gt; [Alt Id] -&gt; Expr Id
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825613"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825609"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681825610"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681825614"><span class="hs-identifier hs-var">alts'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-248"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825615"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825615"><span class="hs-identifier hs-var">scrut_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825613"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825613"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var">cprAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825606"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825608"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-249"></span><span>    </span><span id="local-6989586621681825616"><span class="annot"><span class="annottext">env' :: AnalEnv
</span><a href="#local-6989586621681825616"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; CprSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825606"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825609"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType -&gt; CprSig
</span><a href="GHC.Types.Cpr.html#CprSig"><span class="hs-identifier hs-var">CprSig</span></a></span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825615"><span class="hs-identifier hs-var">scrut_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825619"><span class="annot"><span class="annottext">[CprType]
</span><a href="#local-6989586621681825619"><span class="hs-identifier hs-var">alt_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825614"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681825614"><span class="hs-identifier hs-var">alts'</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Alt Id -&gt; (CprType, Alt Id)) -&gt; [Alt Id] -&gt; ([CprType], [Alt Id])
forall a b c. (a -&gt; (b, c)) -&gt; [a] -&gt; ([b], [c])
</span><a href="GHC.Utils.Misc.html#mapAndUnzip"><span class="hs-identifier hs-var">mapAndUnzip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; CprType -&gt; Alt Id -&gt; (CprType, Alt Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalAlt"><span class="hs-identifier hs-var">cprAnalAlt</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825616"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825615"><span class="hs-identifier hs-var">scrut_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681825611"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-251"></span><span>    </span><span id="local-6989586621681825612"><span class="annot"><span class="annottext">res_ty :: CprType
</span><a href="#local-6989586621681825612"><span class="hs-identifier hs-var hs-var">res_ty</span></a></span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CprType -&gt; CprType -&gt; CprType) -&gt; CprType -&gt; [CprType] -&gt; CprType
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldl%27/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">CprType -&gt; CprType -&gt; CprType
</span><a href="GHC.Types.Cpr.html#lubCprType"><span class="hs-identifier hs-var">lubCprType</span></a></span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="GHC.Types.Cpr.html#botCprType"><span class="hs-identifier hs-var">botCprType</span></a></span><span> </span><span class="annot"><span class="annottext">[CprType]
</span><a href="#local-6989586621681825619"><span class="hs-identifier hs-var">alt_tys</span></a></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-var">cprAnal'</span></a></span><span> </span><span id="local-6989586621681825625"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825625"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681825627"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825627"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681825628"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825628"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681825629"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825629"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825630"><span class="hs-identifier hs-var">body_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; Expr Id -&gt; Expr Id
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Expr Id -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825631"><span class="hs-identifier hs-var">id'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825632"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825633"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825631"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825631"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825632"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825632"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825634"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825634"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; Expr Id -&gt; (Id, Expr Id, AnalEnv)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalBind"><span class="hs-identifier hs-var">cprAnalBind</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825625"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825627"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825628"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825630"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825630"><span class="hs-identifier hs-var">body_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825633"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825633"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var">cprAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825634"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825629"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnal%27"><span class="hs-identifier hs-var">cprAnal'</span></a></span><span> </span><span id="local-6989586621681825635"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825635"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681825636"><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825636"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681825637"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825637"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825638"><span class="hs-identifier hs-var">body_ty</span></a></span><span> </span><span class="annot"><span class="annottext">CprType -&gt; (CprType, Expr Id) -&gt; (CprType, Expr Id)
forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825638"><span class="hs-identifier hs-var">body_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; Expr Id -&gt; Expr Id
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, Expr Id)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825639"><span class="hs-identifier hs-var">pairs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825640"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825641"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825641"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825639"><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825639"><span class="hs-identifier hs-var">pairs'</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; [(Id, Expr Id)] -&gt; (AnalEnv, [(Id, Expr Id)])
</span><a href="GHC.Core.Opt.CprAnal.html#cprFix"><span class="hs-identifier hs-var">cprFix</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825635"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825636"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-263"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825638"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825638"><span class="hs-identifier hs-var">body_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825640"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825640"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var">cprAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825641"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825637"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnalAlt"><span class="hs-identifier hs-type">cprAnalAlt</span></a></span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ CPR type of the scrutinee</span></span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ current alternative</span></span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span id="cprAnalAlt"><span class="annot"><span class="annottext">cprAnalAlt :: AnalEnv -&gt; CprType -&gt; Alt Id -&gt; (CprType, Alt Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalAlt"><span class="hs-identifier hs-var hs-var">cprAnalAlt</span></a></span></span><span> </span><span id="local-6989586621681825643"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825643"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825644"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825644"><span class="hs-identifier hs-var">scrut_ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621681825646"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681825646"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621681825647"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681825647"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621681825648"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825648"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825649"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; Expr Id -&gt; Alt Id
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681825646"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681825647"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825650"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-273"></span><span>    </span><span id="local-6989586621681825651"><span class="annot"><span class="annottext">ids :: [Id]
</span><a href="#local-6989586621681825651"><span class="hs-identifier hs-var hs-var">ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; [Id]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#filter/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681825647"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-274"></span><span>    </span><span id="local-6989586621681825653"><span class="annot"><span class="annottext">env_alt :: AnalEnv
</span><a href="#local-6989586621681825653"><span class="hs-identifier hs-var hs-var">env_alt</span></a></span></span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621681825655"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681825655"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681825646"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-276"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span> </span><span id="local-6989586621681825656"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681825656"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span id="local-6989586621681825657"><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621681825657"><span class="hs-identifier hs-var">cpr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825644"><span class="hs-identifier hs-var">scrut_ty</span></a></span><span>
</span><span id="line-277"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681825656"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">0</span></span><span> </span><span class="hs-comment">-- See Note [Dead code may contain type confusions]</span><span>
</span><span id="line-278"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Cpr -&gt; UnpackConFieldsResult
</span><a href="GHC.Types.Cpr.html#unpackConFieldsCpr"><span class="hs-identifier hs-var">unpackConFieldsCpr</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681825655"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621681825657"><span class="hs-identifier hs-var">cpr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-279"></span><span>          </span><span class="annot"><a href="GHC.Types.Cpr.html#AllFieldsSame"><span class="hs-identifier hs-type">AllFieldsSame</span></a></span><span> </span><span id="local-6989586621681825660"><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621681825660"><span class="hs-identifier hs-var">field_cpr</span></a></span></span><span>
</span><span id="line-280"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681825661"><span class="annot"><span class="annottext">sig :: CprSig
</span><a href="#local-6989586621681825661"><span class="hs-identifier hs-var hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Cpr -&gt; CprSig
</span><a href="GHC.Types.Cpr.html#mkCprSig"><span class="hs-identifier hs-var">mkCprSig</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621681825660"><span class="hs-identifier hs-var">field_cpr</span></a></span><span>
</span><span id="line-281"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; [Id] -&gt; CprSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvAllSame"><span class="hs-identifier hs-var">extendSigEnvAllSame</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825643"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681825651"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621681825661"><span class="hs-identifier hs-var">sig</span></a></span><span>
</span><span id="line-282"></span><span>          </span><span class="annot"><a href="GHC.Types.Cpr.html#ForeachField"><span class="hs-identifier hs-type">ForeachField</span></a></span><span> </span><span id="local-6989586621681825665"><span class="annot"><span class="annottext">[Cpr]
</span><a href="#local-6989586621681825665"><span class="hs-identifier hs-var">field_cprs</span></a></span></span><span>
</span><span id="line-283"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681825666"><span class="annot"><span class="annottext">sigs :: [CprSig]
</span><a href="#local-6989586621681825666"><span class="hs-identifier hs-var hs-var">sigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Cpr -&gt; CprSig) -&gt; [Id] -&gt; [Cpr] -&gt; [CprSig]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#zipWith/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity -&gt; Cpr -&gt; CprSig
</span><a href="GHC.Types.Cpr.html#mkCprSig"><span class="hs-identifier hs-var">mkCprSig</span></a></span><span> </span><span class="annot"><span class="annottext">(Arity -&gt; Cpr -&gt; CprSig) -&gt; (Id -&gt; Arity) -&gt; Id -&gt; Cpr -&gt; CprSig
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Arity
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681825651"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">[Cpr]
</span><a href="#local-6989586621681825665"><span class="hs-identifier hs-var">field_cprs</span></a></span><span>
</span><span id="line-284"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; [(Id, CprSig)] -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvList"><span class="hs-identifier hs-var">extendSigEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825643"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; [Id] -&gt; [CprSig] -&gt; [(Id, CprSig)]
forall a b. (() :: Constraint) =&gt; String -&gt; [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="GHC.Utils.Misc.html#zipEqual"><span class="hs-identifier hs-var">zipEqual</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cprAnalAlt&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681825651"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">[CprSig]
</span><a href="#local-6989586621681825666"><span class="hs-identifier hs-var">sigs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-286"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; [Id] -&gt; CprSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvAllSame"><span class="hs-identifier hs-var">extendSigEnvAllSame</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825643"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681825651"><span class="hs-identifier hs-var">ids</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="GHC.Types.Cpr.html#topCprSig"><span class="hs-identifier hs-var">topCprSig</span></a></span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825649"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825649"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825650"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825650"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var">cprAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825653"><span class="hs-identifier hs-var">env_alt</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825648"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span class="hs-comment">--</span><span>
</span><span id="line-290"></span><span class="annot"><span class="hs-comment">-- * CPR transformer</span></span><span>
</span><span id="line-291"></span><span class="hs-comment">--</span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="hs-keyword">data</span><span> </span><span id="TermFlag"><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#TermFlag"><span class="hs-identifier hs-var">TermFlag</span></a></span></span><span> </span><span class="hs-comment">-- Better than using a Bool</span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Terminates"><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#Terminates"><span class="hs-identifier hs-var">Terminates</span></a></span></span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MightDiverge"><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#MightDiverge"><span class="hs-identifier hs-var">MightDiverge</span></a></span></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-comment">-- See Note [Nested CPR]</span><span>
</span><span id="line-298"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#exprTerminates"><span class="hs-identifier hs-type">exprTerminates</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#TermFlag"><span class="hs-identifier hs-type">TermFlag</span></a></span><span>
</span><span id="line-299"></span><span id="exprTerminates"><span class="annot"><span class="annottext">exprTerminates :: Expr Id -&gt; TermFlag
</span><a href="GHC.Core.Opt.CprAnal.html#exprTerminates"><span class="hs-identifier hs-var hs-var">exprTerminates</span></a></span></span><span> </span><span id="local-6989586621681825675"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825675"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825675"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermFlag
</span><a href="GHC.Core.Opt.CprAnal.html#Terminates"><span class="hs-identifier hs-var">Terminates</span></a></span><span> </span><span class="hs-comment">-- A /very/ simple termination analysis.</span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermFlag
</span><a href="GHC.Core.Opt.CprAnal.html#MightDiverge"><span class="hs-identifier hs-var">MightDiverge</span></a></span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnalApp"><span class="hs-identifier hs-type">cprAnalApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span class="hs-comment">-- Main function that takes care of /nested/ CPR. See Note [Nested CPR]</span><span>
</span><span id="line-305"></span><span id="cprAnalApp"><span class="annot"><span class="annottext">cprAnalApp :: AnalEnv -&gt; Expr Id -&gt; [(CprType, Expr Id)] -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalApp"><span class="hs-identifier hs-var hs-var">cprAnalApp</span></a></span></span><span> </span><span id="local-6989586621681825678"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825678"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825679"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825679"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681825680"><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825680"><span class="hs-identifier hs-var">arg_infos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; [(CprType, Expr Id)] -&gt; [Expr Id] -&gt; (CprType, Expr Id)
</span><a href="#local-6989586621681825681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825679"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825680"><span class="hs-identifier hs-var">arg_infos</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-307"></span><span>    </span><span id="local-6989586621681825681"><span class="annot"><span class="annottext">go :: Expr Id -&gt; [(CprType, Expr Id)] -&gt; [Expr Id] -&gt; (CprType, Expr Id)
</span><a href="#local-6989586621681825681"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681825682"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825682"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681825683"><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825683"><span class="hs-identifier hs-var">arg_infos</span></a></span></span><span> </span><span id="local-6989586621681825684"><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621681825684"><span class="hs-identifier hs-var">args'</span></a></span></span><span>
</span><span id="line-308"></span><span>      </span><span class="hs-comment">-- Collect CprTypes for (value) args (inlined collectArgs):</span><span>
</span><span id="line-309"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681825685"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825685"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681825686"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825686"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825682"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; Bool
forall b. Expr b -&gt; Bool
</span><a href="GHC.Core.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825686"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-comment">-- Don't analyse Type args</span><span>
</span><span id="line-310"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; [(CprType, Expr Id)] -&gt; [Expr Id] -&gt; (CprType, Expr Id)
</span><a href="#local-6989586621681825681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825685"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825683"><span class="hs-identifier hs-var">arg_infos</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825686"><span class="hs-identifier hs-var">arg</span></a></span><span class="annot"><span class="annottext">Expr Id -&gt; [Expr Id] -&gt; [Expr Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621681825684"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681825688"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825688"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681825689"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825689"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825682"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-312"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825690"><span class="annot"><span class="annottext">arg_info :: (CprType, Expr Id)
</span><a href="#local-6989586621681825690"><span class="hs-identifier hs-var">arg_info</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621681825691"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825691"><span class="hs-identifier hs-var">_arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825692"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825692"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var">cprAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825678"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825689"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-313"></span><span>      </span><span class="hs-comment">-- See Note [Nested CPR] on the need for termination analysis</span><span>
</span><span id="line-314"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; [(CprType, Expr Id)] -&gt; [Expr Id] -&gt; (CprType, Expr Id)
</span><a href="#local-6989586621681825681"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825688"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CprType, Expr Id)
</span><a href="#local-6989586621681825690"><span class="hs-identifier hs-var">arg_info</span></a></span><span class="annot"><span class="annottext">(CprType, Expr Id) -&gt; [(CprType, Expr Id)] -&gt; [(CprType, Expr Id)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825683"><span class="hs-identifier hs-var">arg_infos</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825692"><span class="hs-identifier hs-var">arg'</span></a></span><span class="annot"><span class="annottext">Expr Id -&gt; [Expr Id] -&gt; [Expr Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621681825684"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681825693"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825693"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825682"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-317"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; [(CprType, Expr Id)] -&gt; CprType
</span><a href="GHC.Core.Opt.CprAnal.html#cprTransform"><span class="hs-identifier hs-var">cprTransform</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825678"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825693"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825683"><span class="hs-identifier hs-var">arg_infos</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; [Expr Id] -&gt; Expr Id
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825682"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621681825684"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681825696"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825696"><span class="hs-identifier hs-var">e_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825697"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825697"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var">cprAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825678"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825682"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-comment">-- e is not an App and not a Var</span><span>
</span><span id="line-320"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType -&gt; Arity -&gt; CprType
</span><a href="GHC.Types.Cpr.html#applyCprTy"><span class="hs-identifier hs-var">applyCprTy</span></a></span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825696"><span class="hs-identifier hs-var">e_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(CprType, Expr Id)] -&gt; Arity
forall a. [a] -&gt; Arity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Arity
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825683"><span class="hs-identifier hs-var">arg_infos</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; [Expr Id] -&gt; Expr Id
forall b. Expr b -&gt; [Expr b] -&gt; Expr b
</span><a href="GHC.Core.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825697"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Id]
</span><a href="#local-6989586621681825684"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprTransform"><span class="hs-identifier hs-type">cprTransform</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>               </span><span class="annot"><span class="hs-comment">-- ^ The analysis environment</span></span><span>
</span><span id="line-323"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>                    </span><span class="annot"><span class="hs-comment">-- ^ The function</span></span><span>
</span><span id="line-324"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ info about incoming /value/ arguments</span></span><span>
</span><span id="line-325"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span>               </span><span class="annot"><span class="hs-comment">-- ^ The demand type of the application</span></span><span>
</span><span id="line-326"></span><span id="cprTransform"><span class="annot"><span class="annottext">cprTransform :: AnalEnv -&gt; Id -&gt; [(CprType, Expr Id)] -&gt; CprType
</span><a href="GHC.Core.Opt.CprAnal.html#cprTransform"><span class="hs-identifier hs-var hs-var">cprTransform</span></a></span></span><span> </span><span id="local-6989586621681825700"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825700"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825701"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825701"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681825702"><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825702"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-327"></span><span>  </span><span class="hs-comment">-- Any local binding, except for data structure bindings</span><span>
</span><span id="line-328"></span><span>  </span><span class="hs-comment">-- See Note [Efficient Top sigs in SigEnv]</span><span>
</span><span id="line-329"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681825703"><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621681825703"><span class="hs-identifier hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; Maybe CprSig
</span><a href="GHC.Core.Opt.CprAnal.html#lookupSigEnv"><span class="hs-identifier hs-var">lookupSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825700"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825701"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-330"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprType -&gt; Arity -&gt; CprType
</span><a href="GHC.Types.Cpr.html#applyCprTy"><span class="hs-identifier hs-var">applyCprTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprSig -&gt; CprType
</span><a href="GHC.Types.Cpr.html#getCprSig"><span class="hs-identifier hs-var">getCprSig</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621681825703"><span class="hs-identifier hs-var">sig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(CprType, Expr Id)] -&gt; Arity
forall a. [a] -&gt; Arity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Arity
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825702"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-comment">-- See Note [CPR for data structures]</span><span>
</span><span id="line-332"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681825706"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825706"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Maybe (Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprDataStructureUnfolding_maybe"><span class="hs-identifier hs-var">cprDataStructureUnfolding_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825701"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-333"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CprType, Expr Id) -&gt; CprType
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">((CprType, Expr Id) -&gt; CprType) -&gt; (CprType, Expr Id) -&gt; CprType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var">cprAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825700"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825706"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-334"></span><span>  </span><span class="hs-comment">-- Some (mostly global, known-key) Ids have bespoke CPR transformers</span><span>
</span><span id="line-335"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681825709"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825709"><span class="hs-identifier hs-var">cpr_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; [(CprType, Expr Id)] -&gt; Maybe CprType
</span><a href="GHC.Core.Opt.CprAnal.html#cprTransformBespoke"><span class="hs-identifier hs-var">cprTransformBespoke</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825701"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825702"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825709"><span class="hs-identifier hs-var">cpr_ty</span></a></span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-comment">-- Other local Ids that respond True to 'isDataStructure' but don't have an</span><span>
</span><span id="line-338"></span><span>  </span><span class="hs-comment">-- expandable unfolding, such as NOINLINE bindings. They all get a top sig</span><span>
</span><span id="line-339"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825701"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; CprType -&gt; CprType
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.Opt.CprAnal.html#isDataStructure"><span class="hs-identifier hs-var">isDataStructure</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825701"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825701"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="GHC.Types.Cpr.html#topCprType"><span class="hs-identifier hs-var">topCprType</span></a></span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-comment">-- See Note [CPR for DataCon wrappers]</span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDataConWrapId"><span class="hs-identifier hs-var">isDataConWrapId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825701"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681825715"><span class="annot"><span class="annottext">rhs :: Expr Id
</span><a href="#local-6989586621681825715"><span class="hs-identifier hs-var hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Expr Id
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Unfolding
</span><a href="GHC.Types.Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825701"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CprType, Expr Id) -&gt; CprType
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">((CprType, Expr Id) -&gt; CprType) -&gt; (CprType, Expr Id) -&gt; CprType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; [(CprType, Expr Id)] -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalApp"><span class="hs-identifier hs-var">cprAnalApp</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825700"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825715"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825702"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-comment">-- DataCon worker</span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681825718"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681825718"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Maybe DataCon
</span><a href="GHC.Types.Id.html#isDataConWorkId_maybe"><span class="hs-identifier hs-var">isDataConWorkId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825701"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-346"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DataCon -&gt; [(CprType, Expr Id)] -&gt; CprType
</span><a href="GHC.Core.Opt.CprAnal.html#cprTransformDataConWork"><span class="hs-identifier hs-var">cprTransformDataConWork</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825700"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681825718"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825702"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-347"></span><span>  </span><span class="hs-comment">-- Imported function</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprType -&gt; Arity -&gt; CprType
</span><a href="GHC.Types.Cpr.html#applyCprTy"><span class="hs-identifier hs-var">applyCprTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprSig -&gt; CprType
</span><a href="GHC.Types.Cpr.html#getCprSig"><span class="hs-identifier hs-var">getCprSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CprSig
</span><a href="GHC.Types.Id.html#idCprSig"><span class="hs-identifier hs-var">idCprSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825701"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(CprType, Expr Id)] -&gt; Arity
forall a. [a] -&gt; Arity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Arity
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825702"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span class="annot"><span class="hs-comment">-- | Precise, hand-written CPR transformers for select Ids</span></span><span>
</span><span id="line-352"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprTransformBespoke"><span class="hs-identifier hs-type">cprTransformBespoke</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span>
</span><span id="line-353"></span><span id="cprTransformBespoke"><span class="annot"><span class="annottext">cprTransformBespoke :: Id -&gt; [(CprType, Expr Id)] -&gt; Maybe CprType
</span><a href="GHC.Core.Opt.CprAnal.html#cprTransformBespoke"><span class="hs-identifier hs-var hs-var">cprTransformBespoke</span></a></span></span><span> </span><span id="local-6989586621681825722"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825722"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681825723"><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825723"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-354"></span><span>  </span><span class="hs-comment">-- See Note [Simplification of runRW#] in GHC.CoreToStg.Prep</span><span>
</span><span id="line-355"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Unique
</span><a href="GHC.Types.Id.html#idUnique"><span class="hs-identifier hs-var">idUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825722"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Unique -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#runRWKey"><span class="hs-identifier hs-var">runRWKey</span></a></span><span>    </span><span class="hs-comment">-- `runRW (\s -&gt; e)`</span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span id="local-6989586621681825725"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825725"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825726"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825726"><span class="hs-identifier hs-var">_arg</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825723"><span class="hs-identifier hs-var">args</span></a></span><span>   </span><span class="hs-comment">-- `\s -&gt; e` has CPR type `arg` (e.g. `. -&gt; 2`)</span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprType -&gt; Maybe CprType
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(CprType -&gt; Maybe CprType) -&gt; CprType -&gt; Maybe CprType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CprType -&gt; Arity -&gt; CprType
</span><a href="GHC.Types.Cpr.html#applyCprTy"><span class="hs-identifier hs-var">applyCprTy</span></a></span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825725"><span class="hs-identifier hs-var">arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span> </span><span class="hs-comment">-- `e` has CPR type `2`</span><span>
</span><span id="line-358"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-359"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CprType
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-360"></span><span>
</span><span id="line-361"></span><span class="hs-comment">-- | Get a (possibly nested) 'CprType' for an application of a 'DataCon' worker,</span><span>
</span><span id="line-362"></span><span class="hs-comment">-- given a saturated number of 'CprType's for its field expressions.</span><span>
</span><span id="line-363"></span><span class="hs-comment">-- Implements the Nested part of Note [Nested CPR].</span><span>
</span><span id="line-364"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprTransformDataConWork"><span class="hs-identifier hs-type">cprTransformDataConWork</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span>
</span><span id="line-365"></span><span id="cprTransformDataConWork"><span class="annot"><span class="annottext">cprTransformDataConWork :: AnalEnv -&gt; DataCon -&gt; [(CprType, Expr Id)] -&gt; CprType
</span><a href="GHC.Core.Opt.CprAnal.html#cprTransformDataConWork"><span class="hs-identifier hs-var hs-var">cprTransformDataConWork</span></a></span></span><span> </span><span id="local-6989586621681825727"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825727"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825728"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681825728"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621681825729"><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825729"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-366"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [Id]
</span><a href="GHC.Core.DataCon.html#dataConExTyCoVars"><span class="hs-identifier hs-var">dataConExTyCoVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681825728"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- No existentials</span><span>
</span><span id="line-367"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681825732"><span class="hs-identifier hs-var">wkr_arity</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="GHC.Core.Opt.CprAnal.html#mAX_CPR_SIZE"><span class="hs-identifier hs-var">mAX_CPR_SIZE</span></a></span><span> </span><span class="hs-comment">-- See Note [Trimming to mAX_CPR_SIZE]</span><span>
</span><span id="line-368"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825729"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)] -&gt; Arity -&gt; Bool
forall a. [a] -&gt; Arity -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthIs"><span class="hs-operator hs-var">`lengthIs`</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681825732"><span class="hs-identifier hs-var">wkr_arity</span></a></span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DataCon -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.CprAnal.html#ae_rec_dc"><span class="hs-identifier hs-var">ae_rec_dc</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825727"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681825728"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult -&gt; IsRecDataConResult -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DefinitelyRecursive"><span class="hs-identifier hs-var">DefinitelyRecursive</span></a></span><span> </span><span class="hs-comment">-- See Note [CPR for recursive data constructors]</span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-comment">-- , pprTrace &quot;cprTransformDataConWork&quot; (ppr con &lt;+&gt; ppr wkr_arity &lt;+&gt; ppr args) True</span><span>
</span><span id="line-371"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Cpr -&gt; CprType
</span><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-var">CprType</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity -&gt; [Cpr] -&gt; Cpr
</span><a href="GHC.Types.Cpr.html#ConCpr"><span class="hs-identifier hs-var">ConCpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; Arity
</span><a href="GHC.Core.DataCon.html#dataConTag"><span class="hs-identifier hs-var">dataConTag</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681825728"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CprType, Expr Id) -&gt; StrictnessMark -&gt; Cpr)
-&gt; [(CprType, Expr Id)] -&gt; [StrictnessMark] -&gt; [Cpr]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="GHC.Utils.Misc.html#strictZipWith"><span class="hs-identifier hs-var">strictZipWith</span></a></span><span> </span><span class="annot"><span class="annottext">(CprType, Expr Id) -&gt; StrictnessMark -&gt; Cpr
</span><a href="#local-6989586621681825742"><span class="hs-identifier hs-var">extract_nested_cpr</span></a></span><span> </span><span class="annot"><span class="annottext">[(CprType, Expr Id)]
</span><a href="#local-6989586621681825729"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[StrictnessMark]
</span><a href="#local-6989586621681825743"><span class="hs-identifier hs-var">wkr_str_marks</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="GHC.Types.Cpr.html#topCprType"><span class="hs-identifier hs-var">topCprType</span></a></span><span>
</span><span id="line-374"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-375"></span><span>    </span><span id="local-6989586621681825732"><span class="annot"><span class="annottext">wkr_arity :: Arity
</span><a href="#local-6989586621681825732"><span class="hs-identifier hs-var hs-var">wkr_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Arity
</span><a href="GHC.Core.DataCon.html#dataConRepArity"><span class="hs-identifier hs-var">dataConRepArity</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681825728"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-376"></span><span>    </span><span id="local-6989586621681825743"><span class="annot"><span class="annottext">wkr_str_marks :: [StrictnessMark]
</span><a href="#local-6989586621681825743"><span class="hs-identifier hs-var hs-var">wkr_str_marks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [StrictnessMark]
</span><a href="GHC.Core.DataCon.html#dataConRepStrictness"><span class="hs-identifier hs-var">dataConRepStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681825728"><span class="hs-identifier hs-var">con</span></a></span><span>
</span><span id="line-377"></span><span>    </span><span class="hs-comment">-- See Note [Nested CPR]</span><span>
</span><span id="line-378"></span><span>    </span><span id="local-6989586621681825742"><span class="annot"><span class="annottext">extract_nested_cpr :: (CprType, Expr Id) -&gt; StrictnessMark -&gt; Cpr
</span><a href="#local-6989586621681825742"><span class="hs-identifier hs-var hs-var">extract_nested_cpr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621681825748"><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621681825748"><span class="hs-identifier hs-var">cpr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825749"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825749"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681825750"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621681825750"><span class="hs-identifier hs-var">str</span></a></span></span><span>
</span><span id="line-379"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#MarkedStrict"><span class="hs-identifier hs-var">MarkedStrict</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621681825750"><span class="hs-identifier hs-var">str</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621681825748"><span class="hs-identifier hs-var">cpr</span></a></span><span>
</span><span id="line-380"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TermFlag
</span><a href="GHC.Core.Opt.CprAnal.html#Terminates"><span class="hs-identifier hs-var">Terminates</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Id -&gt; TermFlag
</span><a href="GHC.Core.Opt.CprAnal.html#exprTerminates"><span class="hs-identifier hs-var">exprTerminates</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825749"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621681825748"><span class="hs-identifier hs-var">cpr</span></a></span><span>
</span><span id="line-381"></span><span>    </span><span class="annot"><a href="#local-6989586621681825742"><span class="hs-identifier hs-var">extract_nested_cpr</span></a></span><span> </span><span class="annot"><span class="annottext">(CprType, Expr Id)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><span class="hs-identifier">_</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="GHC.Types.Cpr.html#topCpr"><span class="hs-identifier hs-var">topCpr</span></a></span><span> </span><span class="hs-comment">-- intervening lambda or doesn't terminate</span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span class="annot"><span class="hs-comment">-- | See Note [Trimming to mAX_CPR_SIZE].</span></span><span>
</span><span id="line-384"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#mAX_CPR_SIZE"><span class="hs-identifier hs-type">mAX_CPR_SIZE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-385"></span><span id="mAX_CPR_SIZE"><span class="annot"><span class="annottext">mAX_CPR_SIZE :: Arity
</span><a href="GHC.Core.Opt.CprAnal.html#mAX_CPR_SIZE"><span class="hs-identifier hs-var hs-var">mAX_CPR_SIZE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">10</span></span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span class="hs-comment">--</span><span>
</span><span id="line-388"></span><span class="annot"><span class="hs-comment">-- * Bindings</span></span><span>
</span><span id="line-389"></span><span class="hs-comment">--</span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span class="hs-comment">-- Recursive bindings</span><span>
</span><span id="line-392"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprFix"><span class="hs-identifier hs-type">cprFix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>                    </span><span class="hs-comment">-- Does not include bindings for this binding</span><span>
</span><span id="line-393"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-394"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Binders annotated with CPR info</span><span>
</span><span id="line-395"></span><span id="cprFix"><span class="annot"><span class="annottext">cprFix :: AnalEnv -&gt; [(Id, Expr Id)] -&gt; (AnalEnv, [(Id, Expr Id)])
</span><a href="GHC.Core.Opt.CprAnal.html#cprFix"><span class="hs-identifier hs-var hs-var">cprFix</span></a></span></span><span> </span><span id="local-6989586621681825753"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825753"><span class="hs-identifier hs-var">orig_env</span></a></span></span><span> </span><span id="local-6989586621681825754"><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825754"><span class="hs-identifier hs-var">orig_pairs</span></a></span></span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; AnalEnv -&gt; [(Id, Expr Id)] -&gt; (AnalEnv, [(Id, Expr Id)])
</span><a href="#local-6989586621681825755"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825756"><span class="hs-identifier hs-var">init_env</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825757"><span class="hs-identifier hs-var">init_pairs</span></a></span><span>
</span><span id="line-397"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-398"></span><span>    </span><span id="local-6989586621681825758"><span class="annot"><span class="annottext">init_sig :: Id -&gt; CprSig
</span><a href="#local-6989586621681825758"><span class="hs-identifier hs-var hs-var">init_sig</span></a></span></span><span> </span><span id="local-6989586621681825759"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825759"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-399"></span><span>      </span><span class="hs-comment">-- See Note [CPR for data structures]</span><span>
</span><span id="line-400"></span><span>      </span><span class="hs-comment">-- Don't set the sig to bottom in this case, because cprAnalBind won't</span><span>
</span><span id="line-401"></span><span>      </span><span class="hs-comment">-- update it to something reasonable. Result: Assertion error in WW</span><span>
</span><span id="line-402"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.Opt.CprAnal.html#isDataStructure"><span class="hs-identifier hs-var">isDataStructure</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825759"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDFunId"><span class="hs-identifier hs-var">isDFunId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825759"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="GHC.Types.Cpr.html#topCprSig"><span class="hs-identifier hs-var">topCprSig</span></a></span><span>
</span><span id="line-403"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Cpr -&gt; CprSig
</span><a href="GHC.Types.Cpr.html#mkCprSig"><span class="hs-identifier hs-var">mkCprSig</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="GHC.Types.Cpr.html#botCpr"><span class="hs-identifier hs-var">botCpr</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-comment">-- See Note [Initialising strictness] in GHC.Core.Opt.DmdAnal</span><span>
</span><span id="line-405"></span><span>    </span><span id="local-6989586621681825763"><span class="annot"><span class="annottext">orig_virgin :: Bool
</span><a href="#local-6989586621681825763"><span class="hs-identifier hs-var hs-var">orig_virgin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Bool
</span><a href="GHC.Core.Opt.CprAnal.html#ae_virgin"><span class="hs-identifier hs-var">ae_virgin</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825753"><span class="hs-identifier hs-var">orig_env</span></a></span><span>
</span><span id="line-406"></span><span>    </span><span id="local-6989586621681825757"><span class="annot"><span class="annottext">init_pairs :: [(Id, Expr Id)]
</span><a href="#local-6989586621681825757"><span class="hs-identifier hs-var hs-var">init_pairs</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681825763"><span class="hs-identifier hs-var">orig_virgin</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CprSig -&gt; Id
</span><a href="GHC.Types.Id.html#setIdCprSig"><span class="hs-identifier hs-var">setIdCprSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825766"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CprSig
</span><a href="#local-6989586621681825758"><span class="hs-identifier hs-var">init_sig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825766"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825767"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681825766"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825766"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825767"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825767"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825754"><span class="hs-identifier hs-var">orig_pairs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-407"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825754"><span class="hs-identifier hs-var">orig_pairs</span></a></span><span>
</span><span id="line-408"></span><span>    </span><span id="local-6989586621681825756"><span class="annot"><span class="annottext">init_env :: AnalEnv
</span><a href="#local-6989586621681825756"><span class="hs-identifier hs-var hs-var">init_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; [Id] -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvFromIds"><span class="hs-identifier hs-var">extendSigEnvFromIds</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825753"><span class="hs-identifier hs-var">orig_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Id, Expr Id) -&gt; Id) -&gt; [(Id, Expr Id)] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, Expr Id) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825757"><span class="hs-identifier hs-var">init_pairs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span>    </span><span class="hs-comment">-- The fixed-point varies the idCprSig field of the binders and and their</span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-comment">-- entries in the AnalEnv, and terminates if that annotation does not change</span><span>
</span><span id="line-412"></span><span>    </span><span class="hs-comment">-- any more.</span><span>
</span><span id="line-413"></span><span>    </span><span class="annot"><a href="#local-6989586621681825755"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>    </span><span id="local-6989586621681825755"><span class="annot"><span class="annottext">loop :: Arity -&gt; AnalEnv -&gt; [(Id, Expr Id)] -&gt; (AnalEnv, [(Id, Expr Id)])
</span><a href="#local-6989586621681825755"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621681825769"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681825769"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681825770"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825770"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825771"><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825771"><span class="hs-identifier hs-var">pairs</span></a></span></span><span>
</span><span id="line-415"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681825772"><span class="hs-identifier hs-var">found_fixpoint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825773"><span class="hs-identifier hs-var">reset_env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825774"><span class="hs-identifier hs-var">pairs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-416"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; AnalEnv -&gt; [(Id, Expr Id)] -&gt; (AnalEnv, [(Id, Expr Id)])
</span><a href="#local-6989586621681825755"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681825769"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Arity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#%2B/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825776"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825774"><span class="hs-identifier hs-var">pairs'</span></a></span><span>
</span><span id="line-417"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-418"></span><span>        </span><span class="hs-comment">-- In all but the first iteration, delete the virgin flag</span><span>
</span><span id="line-419"></span><span>        </span><span class="hs-comment">-- See Note [Initialising strictness] in GHC.Core.Opt.DmdAnal</span><span>
</span><span id="line-420"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681825776"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825776"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825774"><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825774"><span class="hs-identifier hs-var">pairs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; [(Id, Expr Id)] -&gt; (AnalEnv, [(Id, Expr Id)])
</span><a href="#local-6989586621681825777"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; (AnalEnv -&gt; AnalEnv) -&gt; AnalEnv -&gt; AnalEnv
forall a. Bool -&gt; (a -&gt; a) -&gt; a -&gt; a
</span><a href="GHC.Utils.Misc.html#applyWhen"><span class="hs-identifier hs-var">applyWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681825769"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#nonVirgin"><span class="hs-identifier hs-var">nonVirgin</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825770"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825771"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-comment">-- Make sure we reset the virgin flag to what it was when we are stable</span><span>
</span><span id="line-422"></span><span>        </span><span id="local-6989586621681825773"><span class="annot"><span class="annottext">reset_env' :: AnalEnv
</span><a href="#local-6989586621681825773"><span class="hs-identifier hs-var hs-var">reset_env'</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825776"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#ae_virgin"><span class="hs-identifier hs-var">ae_virgin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681825763"><span class="hs-identifier hs-type">orig_virgin</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-423"></span><span>        </span><span id="local-6989586621681825772"><span class="annot"><span class="annottext">found_fixpoint :: Bool
</span><a href="#local-6989586621681825772"><span class="hs-identifier hs-var hs-var">found_fixpoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Id, Expr Id) -&gt; CprSig) -&gt; [(Id, Expr Id)] -&gt; [CprSig]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CprSig
</span><a href="GHC.Types.Id.html#idCprSig"><span class="hs-identifier hs-var">idCprSig</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; CprSig) -&gt; ((Id, Expr Id) -&gt; Id) -&gt; (Id, Expr Id) -&gt; CprSig
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, Expr Id) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825774"><span class="hs-identifier hs-var">pairs'</span></a></span><span> </span><span class="annot"><span class="annottext">[CprSig] -&gt; [CprSig] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">((Id, Expr Id) -&gt; CprSig) -&gt; [(Id, Expr Id)] -&gt; [CprSig]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CprSig
</span><a href="GHC.Types.Id.html#idCprSig"><span class="hs-identifier hs-var">idCprSig</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; CprSig) -&gt; ((Id, Expr Id) -&gt; Id) -&gt; (Id, Expr Id) -&gt; CprSig
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, Expr Id) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825771"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span>    </span><span class="annot"><a href="#local-6989586621681825777"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>    </span><span id="local-6989586621681825777"><span class="annot"><span class="annottext">step :: AnalEnv -&gt; [(Id, Expr Id)] -&gt; (AnalEnv, [(Id, Expr Id)])
</span><a href="#local-6989586621681825777"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621681825780"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825780"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825781"><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825781"><span class="hs-identifier hs-var">pairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AnalEnv -&gt; (Id, Expr Id) -&gt; (AnalEnv, (Id, Expr Id)))
-&gt; AnalEnv -&gt; [(Id, Expr Id)] -&gt; (AnalEnv, [(Id, Expr Id)])
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapAccumL/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; (Id, Expr Id) -&gt; (AnalEnv, (Id, Expr Id))
</span><a href="#local-6989586621681825782"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825780"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, Expr Id)]
</span><a href="#local-6989586621681825781"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-427"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-428"></span><span>        </span><span id="local-6989586621681825782"><span class="annot"><span class="annottext">go :: AnalEnv -&gt; (Id, Expr Id) -&gt; (AnalEnv, (Id, Expr Id))
</span><a href="#local-6989586621681825782"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681825783"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825783"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681825784"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825784"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825785"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825785"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825786"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825787"><span class="hs-identifier hs-var">id'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825788"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-430"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621681825787"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825787"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825788"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825788"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825786"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825786"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; Expr Id -&gt; (Id, Expr Id, AnalEnv)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalBind"><span class="hs-identifier hs-var">cprAnalBind</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825783"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825784"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825785"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span class="hs-comment">{-
Note [Dead code may contain type confusions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In T23862, we have a nested case match that looks like this

  data CheckSingleton (check :: Bool) where
    Checked :: CheckSingleton True
    Unchecked :: CheckSingleton False
  data family Result (check :: Bool) a
  data instance Result True a = CheckedResult a
  newtype instance Result True a = UncheckedResult a

  case m () of Checked co1 -&gt;
    case m () of Unchecked co2 -&gt;
      case ((\_ -&gt; True)
             |&gt; .. UncheckedResult ..
             |&gt; sym co2
             |&gt; co1) :: Result True (Bool -&gt; Bool) of
        CheckedResult f -&gt; CheckedResult (f True)

Clearly, the innermost case is dead code, because the `Checked` and `Unchecked`
cases are apart.
However, both constructors introduce mutually contradictory coercions `co1` and
`co2` along which GHC generates a type confusion:

  1. (\_ -&gt; True) :: Bool -&gt; Bool
  2. newtype coercion UncheckedResult (\_ -&gt; True) :: Result False (Bool -&gt; Bool)
  3. |&gt; ... sym co1 ... :: Result check (Bool -&gt; Bool)
  4. |&gt; ... co2 ... :: Result True (Bool -&gt; Bool)

Note that we started with a function, injected into `Result` via a newtype
instance and then match on it with a datatype instance.

We have to handle this case gracefully in `cprAnalAlt`, where for the innermost
case we see a `DataAlt` for `CheckedResult`, yet have a scrutinee type that
abstracts the function `(\_ -&gt; True)` with arity 1.
In this case, don't pretend we know anything about the fields of `CheckedResult`!

Note [The OPAQUE pragma and avoiding the reboxing of results]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider:

  {-# OPAQUE f #-}
  f x = (x,y)

  g True  = f 2 x
  g False = (0,0)

Where if we didn't strip the CPR info from 'f' we would end up with the
following W/W pair for 'g':

  $wg True  = case f 2 of (x, y) -&gt; (# x, y #)
  $wg False = (# 0, 0 #)

  g b = case wg$ b of (# x, y #) -&gt; (x, y)

Where the worker unboxes the result of 'f', only for wrapper to box it again.
That's because the non-stripped CPR signature of 'f' is saying to W/W-transform
'f'. However, OPAQUE-annotated binders aren't W/W transformed (see
Note [OPAQUE pragma]), so we should strip 'f's CPR signature.
-}</span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span class="hs-comment">-- | Process the RHS of the binding for a sensible arity, add the CPR signature</span><span>
</span><span id="line-495"></span><span class="hs-comment">-- to the Id, and augment the environment with the signature as well.</span><span>
</span><span id="line-496"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprAnalBind"><span class="hs-identifier hs-type">cprAnalBind</span></a></span><span>
</span><span id="line-497"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-498"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-500"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span id="cprAnalBind"><span class="annot"><span class="annottext">cprAnalBind :: AnalEnv -&gt; Id -&gt; Expr Id -&gt; (Id, Expr Id, AnalEnv)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnalBind"><span class="hs-identifier hs-var hs-var">cprAnalBind</span></a></span></span><span> </span><span id="local-6989586621681825789"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825789"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825790"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825790"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681825791"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825791"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-502"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDFunId"><span class="hs-identifier hs-var">isDFunId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825790"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-comment">-- Never give DFuns the CPR property; we'll never save allocs.</span><span>
</span><span id="line-503"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825790"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">,</span><span>  </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825791"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">,</span><span>  </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; CprSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825789"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825790"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="GHC.Types.Cpr.html#topCprSig"><span class="hs-identifier hs-var">topCprSig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-504"></span><span>  </span><span class="hs-comment">-- See Note [CPR for data structures]</span><span>
</span><span id="line-505"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.Opt.CprAnal.html#isDataStructure"><span class="hs-identifier hs-var">isDataStructure</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825790"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-comment">-- Data structure =&gt; no code =&gt; no need to analyse rhs</span><span>
</span><span id="line-506"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825790"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">,</span><span>  </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825791"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">,</span><span>  </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825789"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825790"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; CprSig -&gt; Id
</span><a href="GHC.Types.Id.html#setIdCprSig"><span class="hs-operator hs-var">`setIdCprSig`</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621681825792"><span class="hs-identifier hs-var">sig'</span></a></span><span class="hs-special">,</span><span>       </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825793"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825794"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-510"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681825795"><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825795"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825793"><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825793"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Expr Id -&gt; (CprType, Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprAnal"><span class="hs-identifier hs-var">cprAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825789"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825791"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-511"></span><span>    </span><span class="hs-comment">-- possibly trim thunk CPR info</span><span>
</span><span id="line-512"></span><span>    </span><span id="local-6989586621681825796"><span class="annot"><span class="annottext">rhs_ty' :: CprType
</span><a href="#local-6989586621681825796"><span class="hs-identifier hs-var hs-var">rhs_ty'</span></a></span></span><span>
</span><span id="line-513"></span><span>      </span><span class="hs-comment">-- See Note [CPR for thunks]</span><span>
</span><span id="line-514"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681825797"><span class="hs-identifier hs-var">stays_thunk</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprType -&gt; CprType
</span><a href="GHC.Types.Cpr.html#trimCprTy"><span class="hs-identifier hs-var">trimCprTy</span></a></span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825795"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-515"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825795"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-516"></span><span>    </span><span class="hs-comment">-- See Note [Arity trimming for CPR signatures]</span><span>
</span><span id="line-517"></span><span>    </span><span id="local-6989586621681825799"><span class="annot"><span class="annottext">sig :: CprSig
</span><a href="#local-6989586621681825799"><span class="hs-identifier hs-var hs-var">sig</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; CprType -&gt; CprSig
</span><a href="GHC.Types.Cpr.html#mkCprSigForArity"><span class="hs-identifier hs-var">mkCprSigForArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Arity
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825790"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681825796"><span class="hs-identifier hs-var">rhs_ty'</span></a></span><span>
</span><span id="line-518"></span><span>    </span><span class="hs-comment">-- See Note [OPAQUE pragma]</span><span>
</span><span id="line-519"></span><span>    </span><span class="hs-comment">-- See Note [The OPAQUE pragma and avoiding the reboxing of results]</span><span>
</span><span id="line-520"></span><span>    </span><span id="local-6989586621681825792"><span class="annot"><span class="annottext">sig' :: CprSig
</span><a href="#local-6989586621681825792"><span class="hs-identifier hs-var hs-var">sig'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InlinePragma -&gt; Bool
</span><a href="GHC.Types.Basic.html#isOpaquePragma"><span class="hs-identifier hs-var">isOpaquePragma</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; InlinePragma
</span><a href="GHC.Types.Id.html#idInlinePragma"><span class="hs-identifier hs-var">idInlinePragma</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825790"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="GHC.Types.Cpr.html#topCprSig"><span class="hs-identifier hs-var">topCprSig</span></a></span><span>
</span><span id="line-521"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621681825799"><span class="hs-identifier hs-var">sig</span></a></span><span>
</span><span id="line-522"></span><span>    </span><span id="local-6989586621681825794"><span class="annot"><span class="annottext">env' :: AnalEnv
</span><a href="#local-6989586621681825794"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; CprSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825789"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825790"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621681825792"><span class="hs-identifier hs-var">sig'</span></a></span><span>
</span><span id="line-523"></span><span>
</span><span id="line-524"></span><span>    </span><span class="hs-comment">-- See Note [CPR for thunks]</span><span>
</span><span id="line-525"></span><span>    </span><span id="local-6989586621681825797"><span class="annot"><span class="annottext">stays_thunk :: Bool
</span><a href="#local-6989586621681825797"><span class="hs-identifier hs-var hs-var">stays_thunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681825803"><span class="hs-identifier hs-var">is_thunk</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681825805"><span class="hs-identifier hs-var">not_strict</span></a></span><span>
</span><span id="line-526"></span><span>    </span><span id="local-6989586621681825803"><span class="annot"><span class="annottext">is_thunk :: Bool
</span><a href="#local-6989586621681825803"><span class="hs-identifier hs-var hs-var">is_thunk</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Id -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Id
</span><a href="#local-6989586621681825791"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825790"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-527"></span><span>    </span><span id="local-6989586621681825805"><span class="annot"><span class="annottext">not_strict :: Bool
</span><a href="#local-6989586621681825805"><span class="hs-identifier hs-var hs-var">not_strict</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isStrUsedDmd"><span class="hs-identifier hs-var">isStrUsedDmd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825790"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#isDataStructure"><span class="hs-identifier hs-type">isDataStructure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-530"></span><span class="hs-comment">-- See Note [CPR for data structures]</span><span>
</span><span id="line-531"></span><span id="isDataStructure"><span class="annot"><span class="annottext">isDataStructure :: Id -&gt; Bool
</span><a href="GHC.Core.Opt.CprAnal.html#isDataStructure"><span class="hs-identifier hs-var hs-var">isDataStructure</span></a></span></span><span> </span><span id="local-6989586621681825810"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825810"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-532"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825810"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Arity
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825810"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isEvaldUnfolding"><span class="hs-identifier hs-var">isEvaldUnfolding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Unfolding
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825810"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span class="hs-comment">-- | Returns an expandable unfolding</span><span>
</span><span id="line-535"></span><span class="hs-comment">-- (See Note [exprIsExpandable] in &quot;GHC.Core.Utils&quot;) that has</span><span>
</span><span id="line-536"></span><span class="hs-comment">-- So effectively is a constructor application.</span><span>
</span><span id="line-537"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#cprDataStructureUnfolding_maybe"><span class="hs-identifier hs-type">cprDataStructureUnfolding_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-538"></span><span id="cprDataStructureUnfolding_maybe"><span class="annot"><span class="annottext">cprDataStructureUnfolding_maybe :: Id -&gt; Maybe (Expr Id)
</span><a href="GHC.Core.Opt.CprAnal.html#cprDataStructureUnfolding_maybe"><span class="hs-identifier hs-var hs-var">cprDataStructureUnfolding_maybe</span></a></span></span><span> </span><span id="local-6989586621681825813"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825813"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-539"></span><span>  </span><span class="hs-comment">-- There are only FinalPhase Simplifier runs after CPR analysis</span><span>
</span><span id="line-540"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#activeInFinalPhase"><span class="hs-identifier hs-var">activeInFinalPhase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Activation
</span><a href="GHC.Types.Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825813"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.Opt.CprAnal.html#isDataStructure"><span class="hs-identifier hs-var">isDataStructure</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825813"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Maybe (Expr Id)
</span><a href="GHC.Core.html#expandUnfolding_maybe"><span class="hs-identifier hs-var">expandUnfolding_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Unfolding
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825813"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-543"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-544"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Expr Id)
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span class="hs-comment">{- Note [Arity trimming for CPR signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Although it doesn't affect correctness of the analysis per se, we have to trim
CPR signatures to idArity. Here's what might happen if we don't:

  f x = if expensive
          then \y. Box y
          else \z. Box z
  g a b = f a b

The two lambdas will have a CPR type of @1m@ (so construct a product after
applied to one argument). Thus, @f@ will have a CPR signature of @2m@
(constructs a product after applied to two arguments).
But WW will never eta-expand @f@! In this case that would amount to possibly
duplicating @expensive@ work.

(Side note: Even if @f@'s 'idArity' happened to be 2, it would not do so, see
Note [Don't eta expand in w/w].)

So @f@ will not be worker/wrappered. But @g@ also inherited its CPR signature
from @f@'s, so it *will* be WW'd:

  f x = if expensive
          then \y. Box y
          else \z. Box z
  $wg a b = case f a b of Box x -&gt; x
  g a b = Box ($wg a b)

And the case in @g@ can never cancel away, thus we introduced extra reboxing.
Hence we always trim the CPR signature of a binding to idArity.

Note [CPR for DataCon wrappers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used to give DataCon wrappers a (necessarily flat) CPR signature in
'GHC.Types.Id.Make.mkDataConRep'. Now we transform DataCon wrappers simply by
analysing their unfolding. A few reasons for the change:

  1. DataCon wrappers are generally inlined in the Final phase (so before CPR),
     all leftover occurrences are in a boring context like `f x y = $WMkT y x`.
     It's simpler to analyse the unfolding anew at every such call site, and the
     unfolding will be pretty cheap to analyse. Also they occur seldom enough
     that performance-wise it doesn't matter.
  2. 'GHC.Types.Id.Make' no longer precomputes CPR signatures for DataCon
     *workers*, because their transformers need to adapt to CPR for their
     arguments in 'cprTransformDataConWork' to enable Note [Nested CPR].
     Better keep it all in this module! The alternative would be that
     'GHC.Types.Id.Make' depends on CprAnal.
  3. In the future, Nested CPR could take a better account of incoming args
     in cprAnalApp and do some beta-reduction on the fly, like !1866 did. If
     any of those args had the CPR property, then we'd even get Nested CPR for
     DataCon wrapper calls, for free. Not so if we simply give the wrapper a
     single CPR sig in 'GHC.Types.Id.Make.mkDataConRep'!

DmdAnal also looks through the wrapper's unfolding:
See Note [DmdAnal for DataCon wrappers].

Note [Trimming to mAX_CPR_SIZE]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We do not treat very big tuples as CPR-ish:

  a) For a start, we get into trouble because there aren't
     &quot;enough&quot; unboxed tuple types (a tiresome restriction,
     but hard to fix),
  b) More importantly, big unboxed tuples get returned mainly
     on the stack, and are often then allocated in the heap
     by the caller. So doing CPR for them may in fact make
     things worse, especially if the wrapper doesn't cancel away
     and we move to the stack in the worker and then to the heap
     in the wrapper.

So we (nested) CPR for functions that would otherwise pass more than than
'mAX_CPR_SIZE' fields.
That effect is exacerbated for the unregisterised backend, where we
don't have any hardware registers to return the fields in. Returning
everything on the stack results in much churn and increases compiler
allocation by 15% for T15164 in a validate build.
-}</span><span>
</span><span id="line-623"></span><span>
</span><span id="line-624"></span><span class="hs-keyword">data</span><span> </span><span id="AnalEnv"><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-var">AnalEnv</span></a></span></span><span>
</span><span id="line-625"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="AE"><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AE"><span class="hs-identifier hs-var">AE</span></a></span></span><span>
</span><span id="line-626"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ae_sigs"><span class="annot"><span class="annottext">AnalEnv -&gt; SigEnv
</span><a href="GHC.Core.Opt.CprAnal.html#ae_sigs"><span class="hs-identifier hs-var hs-var">ae_sigs</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a></span><span>
</span><span id="line-627"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Current approximation of signatures for local ids</span></span><span>
</span><span id="line-628"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ae_virgin"><span class="annot"><span class="annottext">AnalEnv -&gt; Bool
</span><a href="GHC.Core.Opt.CprAnal.html#ae_virgin"><span class="hs-identifier hs-var hs-var">ae_virgin</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-629"></span><span>  </span><span class="hs-comment">-- ^ True only on every first iteration in a fixed-point</span><span>
</span><span id="line-630"></span><span>  </span><span class="hs-comment">-- iteration. See Note [Initialising strictness] in &quot;GHC.Core.Opt.DmdAnal&quot;</span><span>
</span><span id="line-631"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ae_fam_envs"><span class="annot"><span class="annottext">AnalEnv -&gt; FamInstEnvs
</span><a href="GHC.Core.Opt.CprAnal.html#ae_fam_envs"><span class="hs-identifier hs-var hs-var">ae_fam_envs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-632"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Needed when expanding type families and synonyms of product types.</span></span><span>
</span><span id="line-633"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ae_rec_dc"><span class="annot"><span class="annottext">AnalEnv -&gt; DataCon -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.CprAnal.html#ae_rec_dc"><span class="hs-identifier hs-var hs-var">ae_rec_dc</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-type">IsRecDataConResult</span></a></span><span>
</span><span id="line-634"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Memoised result of 'GHC.Core.Opt.WorkWrap.Utils.isRecDataCon'</span></span><span>
</span><span id="line-635"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-638"></span><span>  </span><span id="local-6989586621681825838"><span class="annot"><span class="annottext">ppr :: AnalEnv -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ae_sigs :: AnalEnv -&gt; SigEnv
</span><a href="GHC.Core.Opt.CprAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681825839"><span class="annot"><span class="annottext">SigEnv
</span><a href="#local-6989586621681825839"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ae_virgin :: AnalEnv -&gt; Bool
</span><a href="GHC.Core.Opt.CprAnal.html#ae_virgin"><span class="hs-identifier hs-var">ae_virgin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681825840"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681825840"><span class="hs-identifier hs-var">virgin</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-639"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;AE&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-640"></span><span>         </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ae_virgin =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681825840"><span class="hs-identifier hs-var">virgin</span></a></span><span>
</span><span id="line-641"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ae_sigs =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SigEnv -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SigEnv
</span><a href="#local-6989586621681825839"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-642"></span><span>
</span><span id="line-643"></span><span class="hs-comment">-- | An environment storing 'CprSig's for local Ids.</span><span>
</span><span id="line-644"></span><span class="hs-comment">-- Puts binders with 'topCprSig' in a space-saving 'IntSet'.</span><span>
</span><span id="line-645"></span><span class="hs-comment">-- See Note [Efficient Top sigs in SigEnv].</span><span>
</span><span id="line-646"></span><span class="hs-keyword">data</span><span> </span><span id="SigEnv"><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#SigEnv"><span class="hs-identifier hs-var">SigEnv</span></a></span></span><span>
</span><span id="line-647"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="SE"><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#SE"><span class="hs-identifier hs-var">SE</span></a></span></span><span>
</span><span id="line-648"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="se_tops"><span class="annot"><span class="annottext">SigEnv -&gt; UnVarSet
</span><a href="GHC.Core.Opt.CprAnal.html#se_tops"><span class="hs-identifier hs-var hs-var">se_tops</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Data.Graph.UnVar.html#UnVarSet"><span class="hs-identifier hs-type">UnVarSet</span></a></span><span>
</span><span id="line-649"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ All these Ids have 'topCprSig'. Like a 'VarSet', but more efficient.</span></span><span>
</span><span id="line-650"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="se_sigs"><span class="annot"><span class="annottext">SigEnv -&gt; VarEnv CprSig
</span><a href="GHC.Core.Opt.CprAnal.html#se_sigs"><span class="hs-identifier hs-var hs-var">se_sigs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprSig"><span class="hs-identifier hs-type">CprSig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-651"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Ids that have something other than 'topCprSig'.</span></span><span>
</span><span id="line-652"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-653"></span><span>
</span><span id="line-654"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-655"></span><span>  </span><span id="local-6989586621681825861"><span class="annot"><span class="annottext">ppr :: SigEnv -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#SE"><span class="hs-identifier hs-type">SE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">se_tops :: SigEnv -&gt; UnVarSet
</span><a href="GHC.Core.Opt.CprAnal.html#se_tops"><span class="hs-identifier hs-var">se_tops</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681825862"><span class="annot"><span class="annottext">UnVarSet
</span><a href="#local-6989586621681825862"><span class="hs-identifier hs-var">tops</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">se_sigs :: SigEnv -&gt; VarEnv CprSig
</span><a href="GHC.Core.Opt.CprAnal.html#se_sigs"><span class="hs-identifier hs-var">se_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681825863"><span class="annot"><span class="annottext">VarEnv CprSig
</span><a href="#local-6989586621681825863"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SE&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-657"></span><span>         </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;se_tops =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UnVarSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">UnVarSet
</span><a href="#local-6989586621681825862"><span class="hs-identifier hs-var">tops</span></a></span><span>
</span><span id="line-658"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;se_sigs =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv CprSig -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv CprSig
</span><a href="#local-6989586621681825863"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-659"></span><span>
</span><span id="line-660"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#emptyAnalEnv"><span class="hs-identifier hs-type">emptyAnalEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-661"></span><span id="emptyAnalEnv"><span class="annot"><span class="annottext">emptyAnalEnv :: FamInstEnvs -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#emptyAnalEnv"><span class="hs-identifier hs-var hs-var">emptyAnalEnv</span></a></span></span><span> </span><span id="local-6989586621681825864"><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681825864"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span>
</span><span id="line-663"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ae_sigs :: SigEnv
</span><a href="GHC.Core.Opt.CprAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnVarSet -&gt; VarEnv CprSig -&gt; SigEnv
</span><a href="GHC.Core.Opt.CprAnal.html#SE"><span class="hs-identifier hs-var">SE</span></a></span><span> </span><span class="annot"><span class="annottext">UnVarSet
</span><a href="GHC.Data.Graph.UnVar.html#emptyUnVarSet"><span class="hs-identifier hs-var">emptyUnVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv CprSig
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-664"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ae_virgin :: Bool
</span><a href="GHC.Core.Opt.CprAnal.html#ae_virgin"><span class="hs-identifier hs-var">ae_virgin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-665"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ae_fam_envs :: FamInstEnvs
</span><a href="GHC.Core.Opt.CprAnal.html#ae_fam_envs"><span class="hs-identifier hs-var">ae_fam_envs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681825864"><span class="hs-identifier hs-var">fam_envs</span></a></span><span>
</span><span id="line-666"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ae_rec_dc :: DataCon -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.CprAnal.html#ae_rec_dc"><span class="hs-identifier hs-var">ae_rec_dc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DataCon -&gt; IsRecDataConResult) -&gt; DataCon -&gt; IsRecDataConResult
forall k a. Uniquable k =&gt; (k -&gt; a) -&gt; k -&gt; a
</span><a href="GHC.Types.Unique.MemoFun.html#memoiseUniqueFun"><span class="hs-identifier hs-var">memoiseUniqueFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FamInstEnvs -&gt; IntWithInf -&gt; DataCon -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#isRecDataCon"><span class="hs-identifier hs-var">isRecDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681825864"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621681825868"><span class="hs-identifier hs-var">fuel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-667"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-668"></span><span>    </span><span id="local-6989586621681825868"><span class="annot"><span class="annottext">fuel :: IntWithInf
</span><a href="#local-6989586621681825868"><span class="hs-identifier hs-var hs-var">fuel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><span class="hs-number">3</span></span><span> </span><span class="hs-comment">-- If we can unbox more than 3 constructors to find a</span><span>
</span><span id="line-669"></span><span>             </span><span class="hs-comment">-- recursive occurrence, then we can just as well unbox it</span><span>
</span><span id="line-670"></span><span>             </span><span class="hs-comment">-- See Note [CPR for recursive data constructors], point (4)</span><span>
</span><span id="line-671"></span><span>
</span><span id="line-672"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#modifySigEnv"><span class="hs-identifier hs-type">modifySigEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-673"></span><span id="modifySigEnv"><span class="annot"><span class="annottext">modifySigEnv :: (SigEnv -&gt; SigEnv) -&gt; AnalEnv -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#modifySigEnv"><span class="hs-identifier hs-var hs-var">modifySigEnv</span></a></span></span><span> </span><span id="local-6989586621681825872"><span class="annot"><span class="annottext">SigEnv -&gt; SigEnv
</span><a href="#local-6989586621681825872"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621681825873"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825873"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825873"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681825872"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681825873"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#lookupSigEnv"><span class="hs-identifier hs-type">lookupSigEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprSig"><span class="hs-identifier hs-type">CprSig</span></a></span><span>
</span><span id="line-676"></span><span class="hs-comment">-- See Note [Efficient Top sigs in SigEnv]</span><span>
</span><span id="line-677"></span><span id="lookupSigEnv"><span class="annot"><span class="annottext">lookupSigEnv :: AnalEnv -&gt; Id -&gt; Maybe CprSig
</span><a href="GHC.Core.Opt.CprAnal.html#lookupSigEnv"><span class="hs-identifier hs-var hs-var">lookupSigEnv</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ae_sigs :: AnalEnv -&gt; SigEnv
</span><a href="GHC.Core.Opt.CprAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#SE"><span class="hs-identifier hs-type">SE</span></a></span><span> </span><span id="local-6989586621681825874"><span class="annot"><span class="annottext">UnVarSet
</span><a href="#local-6989586621681825874"><span class="hs-identifier hs-var">tops</span></a></span></span><span> </span><span id="local-6989586621681825875"><span class="annot"><span class="annottext">VarEnv CprSig
</span><a href="#local-6989586621681825875"><span class="hs-identifier hs-var">sigs</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621681825876"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825876"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-678"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825876"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; UnVarSet -&gt; Bool
</span><a href="GHC.Data.Graph.UnVar.html#elemUnVarSet"><span class="hs-operator hs-var">`elemUnVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">UnVarSet
</span><a href="#local-6989586621681825874"><span class="hs-identifier hs-var">tops</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprSig -&gt; Maybe CprSig
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="GHC.Types.Cpr.html#topCprSig"><span class="hs-identifier hs-var">topCprSig</span></a></span><span>
</span><span id="line-679"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarEnv CprSig -&gt; Id -&gt; Maybe CprSig
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv CprSig
</span><a href="#local-6989586621681825875"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825876"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-680"></span><span>
</span><span id="line-681"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#extendSigEnv"><span class="hs-identifier hs-type">extendSigEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprSig"><span class="hs-identifier hs-type">CprSig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-682"></span><span class="hs-comment">-- See Note [Efficient Top sigs in SigEnv]</span><span>
</span><span id="line-683"></span><span id="extendSigEnv"><span class="annot"><span class="annottext">extendSigEnv :: AnalEnv -&gt; Id -&gt; CprSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnv"><span class="hs-identifier hs-var hs-var">extendSigEnv</span></a></span></span><span> </span><span id="local-6989586621681825879"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825879"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825880"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825880"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681825881"><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621681825881"><span class="hs-identifier hs-var">sig</span></a></span></span><span>
</span><span id="line-684"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CprSig -&gt; Bool
</span><a href="GHC.Types.Cpr.html#isTopCprSig"><span class="hs-identifier hs-var">isTopCprSig</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621681825881"><span class="hs-identifier hs-var">sig</span></a></span><span>
</span><span id="line-685"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SigEnv -&gt; SigEnv) -&gt; AnalEnv -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#modifySigEnv"><span class="hs-identifier hs-var">modifySigEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681825883"><span class="annot"><span class="annottext">SigEnv
</span><a href="#local-6989586621681825883"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SigEnv
</span><a href="#local-6989586621681825883"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">{</span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#se_tops"><span class="hs-identifier hs-var">se_tops</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.Graph.UnVar.html#extendUnVarSet"><span class="hs-identifier hs-type">extendUnVarSet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681825880"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#se_tops"><span class="hs-identifier hs-var">se_tops</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681825883"><span class="hs-identifier hs-type">se</span></a></span><span class="hs-special">)</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825879"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-686"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-687"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SigEnv -&gt; SigEnv) -&gt; AnalEnv -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#modifySigEnv"><span class="hs-identifier hs-var">modifySigEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681825885"><span class="annot"><span class="annottext">SigEnv
</span><a href="#local-6989586621681825885"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SigEnv
</span><a href="#local-6989586621681825885"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">{</span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#se_sigs"><span class="hs-identifier hs-var">se_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-type">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#se_sigs"><span class="hs-identifier hs-var">se_sigs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681825885"><span class="hs-identifier hs-type">se</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681825880"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681825881"><span class="hs-identifier hs-type">sig</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825879"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-688"></span><span>
</span><span id="line-689"></span><span class="annot"><span class="hs-comment">-- | Extend an environment with the (Id, CPR sig) pairs</span></span><span>
</span><span id="line-690"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvList"><span class="hs-identifier hs-type">extendSigEnvList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprSig"><span class="hs-identifier hs-type">CprSig</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-691"></span><span id="extendSigEnvList"><span class="annot"><span class="annottext">extendSigEnvList :: AnalEnv -&gt; [(Id, CprSig)] -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvList"><span class="hs-identifier hs-var hs-var">extendSigEnvList</span></a></span></span><span> </span><span id="local-6989586621681825887"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825887"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825888"><span class="annot"><span class="annottext">[(Id, CprSig)]
</span><a href="#local-6989586621681825888"><span class="hs-identifier hs-var">ids_cprs</span></a></span></span><span>
</span><span id="line-692"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AnalEnv -&gt; (Id, CprSig) -&gt; AnalEnv)
-&gt; AnalEnv -&gt; [(Id, CprSig)] -&gt; AnalEnv
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldl%27/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681825889"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825889"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681825890"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825890"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681825891"><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621681825891"><span class="hs-identifier hs-var">sig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; CprSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825889"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825890"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621681825891"><span class="hs-identifier hs-var">sig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825887"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CprSig)]
</span><a href="#local-6989586621681825888"><span class="hs-identifier hs-var">ids_cprs</span></a></span><span>
</span><span id="line-693"></span><span>
</span><span id="line-694"></span><span class="annot"><span class="hs-comment">-- | Extend an environment with the CPR sigs attached to the ids</span></span><span>
</span><span id="line-695"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvFromIds"><span class="hs-identifier hs-type">extendSigEnvFromIds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-696"></span><span id="extendSigEnvFromIds"><span class="annot"><span class="annottext">extendSigEnvFromIds :: AnalEnv -&gt; [Id] -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvFromIds"><span class="hs-identifier hs-var hs-var">extendSigEnvFromIds</span></a></span></span><span> </span><span id="local-6989586621681825892"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825892"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825893"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681825893"><span class="hs-identifier hs-var">ids</span></a></span></span><span>
</span><span id="line-697"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AnalEnv -&gt; Id -&gt; AnalEnv) -&gt; AnalEnv -&gt; [Id] -&gt; AnalEnv
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldl%27/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681825894"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825894"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825895"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825895"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; CprSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825894"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825895"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CprSig
</span><a href="GHC.Types.Id.html#idCprSig"><span class="hs-identifier hs-var">idCprSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825895"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825892"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681825893"><span class="hs-identifier hs-var">ids</span></a></span><span>
</span><span id="line-698"></span><span>
</span><span id="line-699"></span><span class="annot"><span class="hs-comment">-- | Extend an environment with the same CPR sig for all ids</span></span><span>
</span><span id="line-700"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvAllSame"><span class="hs-identifier hs-type">extendSigEnvAllSame</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprSig"><span class="hs-identifier hs-type">CprSig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-701"></span><span id="extendSigEnvAllSame"><span class="annot"><span class="annottext">extendSigEnvAllSame :: AnalEnv -&gt; [Id] -&gt; CprSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvAllSame"><span class="hs-identifier hs-var hs-var">extendSigEnvAllSame</span></a></span></span><span> </span><span id="local-6989586621681825896"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825896"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825897"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681825897"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span id="local-6989586621681825898"><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621681825898"><span class="hs-identifier hs-var">sig</span></a></span></span><span>
</span><span id="line-702"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AnalEnv -&gt; Id -&gt; AnalEnv) -&gt; AnalEnv -&gt; [Id] -&gt; AnalEnv
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldl%27/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681825899"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825899"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825900"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825900"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; CprSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825899"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825900"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="#local-6989586621681825898"><span class="hs-identifier hs-var">sig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825896"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681825897"><span class="hs-identifier hs-var">ids</span></a></span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#nonVirgin"><span class="hs-identifier hs-type">nonVirgin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-705"></span><span id="nonVirgin"><span class="annot"><span class="annottext">nonVirgin :: AnalEnv -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#nonVirgin"><span class="hs-identifier hs-var hs-var">nonVirgin</span></a></span></span><span> </span><span id="local-6989586621681825901"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825901"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825901"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#ae_virgin"><span class="hs-identifier hs-var">ae_virgin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-706"></span><span>
</span><span id="line-707"></span><span class="hs-comment">-- | A version of 'extendSigEnv' for a binder of which we don't see the RHS</span><span>
</span><span id="line-708"></span><span class="hs-comment">-- needed to compute a 'CprSig' (e.g. lambdas and DataAlt field binders).</span><span>
</span><span id="line-709"></span><span class="hs-comment">-- In this case, we can still look at their demand to attach CPR signatures</span><span>
</span><span id="line-710"></span><span class="hs-comment">-- anticipating the unboxing done by worker/wrapper.</span><span>
</span><span id="line-711"></span><span class="hs-comment">-- See Note [CPR for binders that will be unboxed].</span><span>
</span><span id="line-712"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvForArg"><span class="hs-identifier hs-type">extendSigEnvForArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-713"></span><span id="extendSigEnvForArg"><span class="annot"><span class="annottext">extendSigEnvForArg :: AnalEnv -&gt; Id -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnvForArg"><span class="hs-identifier hs-var hs-var">extendSigEnvForArg</span></a></span></span><span> </span><span id="local-6989586621681825902"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825902"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681825903"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825903"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-714"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; CprSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.CprAnal.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681825902"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825903"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType -&gt; CprSig
</span><a href="GHC.Types.Cpr.html#CprSig"><span class="hs-identifier hs-var">CprSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand -&gt; CprType
</span><a href="GHC.Core.Opt.CprAnal.html#argCprType"><span class="hs-identifier hs-var">argCprType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681825903"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-715"></span><span>
</span><span id="line-716"></span><span class="hs-comment">-- | Produces a 'CprType' according to how a strict argument will be unboxed.</span><span>
</span><span id="line-717"></span><span class="hs-comment">-- Examples:</span><span>
</span><span id="line-718"></span><span class="hs-comment">--</span><span>
</span><span id="line-719"></span><span class="hs-comment">--   * A head-strict demand @1!L@ would translate to @1@</span><span>
</span><span id="line-720"></span><span class="hs-comment">--   * A product demand @1!P(1!L,L)@ would translate to @1(1,)@</span><span>
</span><span id="line-721"></span><span class="hs-comment">--   * A product demand @1!P(1L,L)@ would translate to @1(,)@,</span><span>
</span><span id="line-722"></span><span class="hs-comment">--     because the first field will not be unboxed.</span><span>
</span><span id="line-723"></span><span class="annot"><a href="GHC.Core.Opt.CprAnal.html#argCprType"><span class="hs-identifier hs-type">argCprType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-type">CprType</span></a></span><span>
</span><span id="line-724"></span><span id="argCprType"><span class="annot"><span class="annottext">argCprType :: Demand -&gt; CprType
</span><a href="GHC.Core.Opt.CprAnal.html#argCprType"><span class="hs-identifier hs-var hs-var">argCprType</span></a></span></span><span> </span><span id="local-6989586621681825905"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681825905"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Cpr -&gt; CprType
</span><a href="GHC.Types.Cpr.html#CprType"><span class="hs-identifier hs-var">CprType</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand -&gt; Cpr
</span><a href="#local-6989586621681825906"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681825905"><span class="hs-identifier hs-var">dmd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-725"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-726"></span><span>    </span><span id="local-6989586621681825906"><span class="annot"><span class="annottext">go :: Demand -&gt; Cpr
</span><a href="#local-6989586621681825906"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681825908"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681825908"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-type">:*</span></a></span><span> </span><span id="local-6989586621681825910"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681825910"><span class="hs-identifier hs-var">sd</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-727"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Card -&gt; Bool
</span><a href="GHC.Types.Demand.html#isAbs"><span class="hs-identifier hs-var">isAbs</span></a></span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681825908"><span class="hs-identifier hs-var">n</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="GHC.Types.Cpr.html#topCpr"><span class="hs-identifier hs-var">topCpr</span></a></span><span>
</span><span id="line-728"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Prod"><span class="hs-identifier hs-type">Prod</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span> </span><span id="local-6989586621681825914"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681825914"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681825910"><span class="hs-identifier hs-var">sd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; [Cpr] -&gt; Cpr
</span><a href="GHC.Types.Cpr.html#ConCpr"><span class="hs-identifier hs-var">ConCpr</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="GHC.Types.Basic.html#fIRST_TAG"><span class="hs-identifier hs-var">fIRST_TAG</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Demand -&gt; Cpr) -&gt; [Demand] -&gt; [Cpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="GHC.Utils.Misc.html#strictMap"><span class="hs-identifier hs-var">strictMap</span></a></span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Cpr
</span><a href="#local-6989586621681825906"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681825914"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-729"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Poly"><span class="hs-identifier hs-type">Poly</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span> </span><span class="annot"><span class="annottext">Card
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681825910"><span class="hs-identifier hs-var">sd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; [Cpr] -&gt; Cpr
</span><a href="GHC.Types.Cpr.html#ConCpr"><span class="hs-identifier hs-var">ConCpr</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="GHC.Types.Basic.html#fIRST_TAG"><span class="hs-identifier hs-var">fIRST_TAG</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-730"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="GHC.Types.Cpr.html#topCpr"><span class="hs-identifier hs-var">topCpr</span></a></span><span>
</span><span id="line-731"></span><span>
</span><span id="line-732"></span><span class="hs-comment">{- Note [Safe abortion in the fixed-point iteration]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Fixed-point iteration may fail to terminate. But we cannot simply give up and
return the environment and code unchanged! We still need to do one additional
round, to ensure that all expressions have been traversed at least once, and any
unsound CPR annotations have been updated.

Note [Efficient Top sigs in SigEnv]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's pretty common for binders in the SigEnv to have a 'topCprSig'.
Wide records with 100 fields like in T9675 even will generate code where the
majority of binders has Top signature. To save some allocations, we store
those binders with a Top signature in a separate UnVarSet (which is an IntSet
with a convenient Var-tailored API).

Why store top signatures at all in the SigEnv? After all, when 'cprTransform'
encounters a locally-bound Id without an entry in the SigEnv, it should behave
as if that binder has a Top signature!
Well, the problem is when case binders should have a Top signatures. They always
have an unfolding and thus look to 'cprTransform' as if they bind a data
structure, Note [CPR for data structures], and thus would always have the CPR
property. So we need some mechanism to separate data structures from case
binders with a Top signature, and the UnVarSet provides that in the least
convoluted way I can think of.

Note [CPR for binders that will be unboxed]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If a lambda-bound variable will be unboxed by worker/wrapper (so it must be
demanded strictly), then give it a CPR signature. Here's a concrete example
('f1' in test T10482a), assuming h is strict:

  f1 :: Int -&gt; Int
  f1 x = case h x of
          A -&gt; x
          B -&gt; f1 (x-1)
          C -&gt; x+1

If we notice that 'x' is used strictly, we can give it the CPR
property; and hence f1 gets the CPR property too.  It's sound (doesn't
change strictness) to give it the CPR property because by the time 'x'
is returned (case A above), it'll have been evaluated (by the wrapper
of 'h' in the example).

Moreover, if f itself is strict in x, then we'll pass x unboxed to
f1, and so the boxed version *won't* be available; in that case it's
very helpful to give 'x' the CPR property.

This is all done in 'extendSigEnvForArg'.

Note that

  * Whether or not something unboxes is decided by 'canUnboxArg', else we may
    get over-optimistic CPR results (e.g., from \(x :: a) -&gt; x!).

  * If the demand unboxes deeply, we can give the binder a /nested/ CPR
    property, e.g.

      g :: (Int, Int) -&gt; Int
      g p = case p of
        (x, y) | x &lt; 0     -&gt; 0
               | otherwise -&gt; x

    `x` should have the CPR property because it will be unboxed. We do so
    by giving `p` the Nested CPR property `1(1,)`, indicating that we not only
    have `p` available unboxed, but also its field `x`. Analysis of the Case
    will then transfer the CPR property to `x`.

    Before we were able to express Nested CPR, we used to guess which field
    binders should get the CPR property.
    See Historic Note [Optimistic field binder CPR].

  * See Note [CPR examples]

Note [CPR for thunks]
~~~~~~~~~~~~~~~~~~~~~
If the rhs is a thunk, we usually forget the CPR info, because
it is presumably shared (else it would have been inlined, and
so we'd lose sharing if w/w'd it into a function).  E.g.

        let r = case expensive of
                  (a,b) -&gt; (b,a)
        in ...

If we marked r as having the CPR property, then we'd w/w into

        let $wr = \() -&gt; case expensive of
                            (a,b) -&gt; (# b, a #)
            r = case $wr () of
                  (# b,a #) -&gt; (b,a)
        in ...

But now r is a thunk, which won't be inlined, so we are no further ahead.
But consider

        f x = let r = case expensive of (a,b) -&gt; (b,a)
              in if foo r then r else (x,x)

Does f have the CPR property?  Well, no.

However, if the strictness analyser has figured out (in a previous
iteration) that it's strict, then we DON'T need to forget the CPR info.
Instead we can retain the CPR info and do the thunk-splitting transform
(see WorkWrap.splitThunk).

This made a big difference to PrelBase.modInt, which had something like
        modInt = \ x -&gt; let r = ... -&gt; I# v in
                        ...body strict in r...
r's RHS isn't a value yet; but modInt returns r in various branches, so
if r doesn't have the CPR property then neither does modInt
Another case I found in practice (in Complex.magnitude), looks like this:
                let k = if ... then I# a else I# b
                in ... body strict in k ....
(For this example, it doesn't matter whether k is returned as part of
the overall result; but it does matter that k's RHS has the CPR property.)
Left to itself, the simplifier will make a join point thus:
                let $j k = ...body strict in k...
                if ... then $j (I# a) else $j (I# b)
With thunk-splitting, we get instead
                let $j x = let k = I#x in ...body strict in k...
                in if ... then $j a else $j b
This is much better; there's a good chance the I# won't get allocated.

But what about botCpr? Consider
    lvl = error &quot;boom&quot;
    fac -1 = lvl
    fac 0 = 1
    fac n = n * fac (n-1)
fac won't have the CPR property here when we trim every thunk! But the
assumption is that error cases are rarely entered and we are diverging anyway,
so WW doesn't hurt.

Should we also trim CPR on DataCon application bindings?
See Note [CPR for data structures]!

Note [CPR for data structures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Long static data structures (whether top-level or not) like

  xs = x1 : xs1
  xs1 = x2 : xs2
  xs2 = x3 : xs3

should not get (nested) CPR signatures (#18154), because they

  * Never get WW'd, so their CPR signature should be irrelevant after analysis
    (in fact the signature might even be harmful for that reason)
  * Would need to be inlined/expanded to see their constructed product
  * BUT MOST IMPORTANTLY, Problem P1:
    Recording CPR on them blows up interface file sizes and is redundant with
    their unfolding. In case of Nested CPR, this blow-up can be quadratic!
    Reason: the CPR info for xs1 contains the CPR info for xs; the CPR info
    for xs2 contains that for xs1. And so on.
    By contrast, the size of unfoldings and types stays linear. That's why
    quadratic blowup is problematic; it makes an asymptotic difference.

Hence (Solution S1) we don't give data structure bindings a CPR *signature* and
hence don't to analyse them in 'cprAnalBind'.
What do we mean by &quot;data structure binding&quot;? Answer:

  (1) idArity id == 0    (otherwise it's a function)
  (2) is eval'd          (otherwise it's a thunk, Note [CPR for thunks] applies)
  (3) not (isJoinId id)  (otherwise it's a function and its more efficient to
                          analyse it just once rather than at each call site)

But (S1) leads to a new Problem P2: We can't just stop giving DataCon application
bindings the CPR *property*, for example the factorial function after FloatOut

  lvl = I# 1#
  fac 0 = lvl
  fac n = n * fac (n-1)

lvl is a data structure, and hence (see above) will not have a CPR *signature*.
But if lvl doesn't have the CPR *property*, fac won't either and we allocate a
box for the result on every iteration of the loop.

So (Solution S2) when 'cprAnal' meets a variable lacking a CPR signature to
extrapolate into a CPR transformer, 'cprTransform' tries to get its unfolding
(via 'cprDataStructureUnfolding_maybe'), and analyses that instead.

The Result R1: Everything behaves as if there was a CPR signature, but without
the blowup in interface files.

There is one exception to (R1):

  x   = (y, z); {-# NOINLINE x #-}
  f p = (y, z); {-# NOINLINE f #-}

While we still give the NOINLINE *function* 'f' the CPR property (and WW
accordingly, see Note [Worker/wrapper for NOINLINE functions]), we won't
give the NOINLINE *data structure* 'x' the CPR property, because it lacks an
unfolding. In particular, KindRep bindings are NOINLINE data structures (see
the noinline wrinkle in Note [Grand plan for Typeable]). We'll behave as if the
bindings had 'topCprSig', and that is fine, as a case on the binding would never
cancel away after WW!

It's also worth pointing out how ad-hoc (S1) is: If we instead had

    f1 x = x:[]
    f2 x = x : f1 x
    f3 x = x : f2 x
    ...

we still give every function an ever deepening CPR signature. But it's very
uncommon to find code like this, whereas the long static data structures from
the beginning of this Note are very common because of GHC's strategy of ANF'ing
data structure RHSs.

Note [CPR for data structures can destroy sharing]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In Note [CPR for data structures], we argued that giving data structure bindings
the CPR property is useful to give functions like fac the CPR property:

  lvl = I# 1#
  fac 0 = lvl
  fac n = n * fac (n-1)

Worker/wrappering fac for its CPR property means we get a very fast worker
function with type Int# -&gt; Int#, without any heap allocation at all.

But consider what happens if we call `map fac (replicate n 0)`, where the
wrapper doesn't cancel away: Then we rebox the result of $wfac *on each call*,
n times, instead of reusing the static thunk for 1, e.g. an asymptotic increase
in allocations. If you twist it just right, you can actually write programs that
that take O(n) space if you do CPR and O(1) if you don't:

  fac :: Int -&gt; Int
  fac 0 = 1 -- this clause will trigger CPR and destroy sharing for O(n) space
  -- fac 0 = lazy 1 -- this clause will prevent CPR and run in O(1) space
  fac n = n * fac (n-1)

  const0 :: Int -&gt; Int
  const0 n = signum n - 1 -- will return 0 for [1..n]
  {-# NOINLINE const0 #-}

  main = print $ foldl' (\acc n -&gt; acc + lazy n) 0 $ map (fac . const0) [1..100000000]

Generally, this kind of asymptotic increase in allocation can happen whenever we
give a data structure the CPR property that is bound outside of a recursive
function. So far we don't have a convincing remedy; giving fac the CPR property
is just too attractive. #19309 documents a futile idea. #13331 tracks the
general issue of WW destroying sharing and also contains above reproducer.
#19326 is about CPR destroying sharing in particular.

With Nested CPR, sharing can also be lost within the same &quot;lambda level&quot;, for
example:

  f (I# x) = let y = I# (x*#x) in (y, y)

Nestedly unboxing would destroy the box shared through 'y'. (Perhaps we can call
this &quot;internal sharing&quot;, in contrast to &quot;external sharing&quot; beyond lambda or even
loop levels above.) But duplicate occurrences like that are pretty rare and may
never lead to an asymptotic difference in allocations of 'f'.

Note [CPR for recursive data constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note [CPR for data structures can destroy sharing] gives good reasons not to
give shared data structure bindings the CPR property. But we shouldn't even
give *functions* that return *recursive* data constructor applications the CPR
property. Here's an example for why:

  c = C# 'a'
  replicateC :: Int -&gt; [Int]
  replicateC 1 = [c]
  replicateC n = c : replicateC (n-1)

What happens if we give `replicateC` the (nested) CPR property? We get a WW
split for 'replicateC', the wrapper of which is certain to inline, like this:

  replicateC (I# n) = case $wreplicateC n of (# x, xs #) -&gt; C# x : xs
  $wreplicateC 1# = (# 'a', [] #)
  $wreplicateC n  = (# 'a', replicateC (I# (n -# 1#)) #)

Eliminating the shared 'c' binding in the process. And then

  * We *might* save allocation of the topmost (of most likely several) (:)
    constructor if it cancels away at the call site. Similarly for the 'C#'
    constructor.
  * But we will now re-allocate the C# box on every iteration of the loop,
    because we separated the character literal from the C# application.
    That means n times as many C# allocations as before. Yikes!!
  * We make all other call sites where the wrapper inlines a bit larger, most of
    them for no gain. But this shouldn't matter much.
  * The inlined wrapper may inhibit eta-expansion in some cases. Here's how:
    If the wrapper is inlined in a strict arg position, the Simplifier will
    transform as follows

      f (replicateC n)
      ==&gt; { inline }
      f (case $wreplicateC n of (# x, xs #) -&gt; (C# x, xs))
      ==&gt; { strict arg }
      case $wreplicateC n of (# x, xs #) -&gt; f (C# x, xs)

    Now we can't float out the case anymore. In fact, we can't even float out
    `$wreplicateC n`, because it returns an unboxed tuple.
    This can inhibit eta-expansion if we later find out that `f` has arity &gt; 1
    (such as when we define `foldl` in terms of `foldr`). #19970 shows how
    abstaining from worker/wrappering made a difference of -20% in reptile. So
    while WW'ing for CPR didn't make the program slower directly, the resulting
    program got much harder to optimise because of the returned unboxed tuple
    (which can't easily float because unlifted).

`replicateC` comes up in T5536, which regresses significantly if CPR'd nestedly.

What can we do about it?

 A. Don't CPR functions that return a *recursive data type* (the list in this
    case). This is the solution we adopt. Rationale: the benefit of CPR on
    recursive data structures is slight, because it only affects the outer layer
    of a potentially massive data structure.
 B. Don't CPR any *recursive function*. That would be quite conservative, as it
    would also affect e.g. the factorial function.
 C. Flat CPR only for recursive functions. This prevents the asymptotic
    worsening part arising through unsharing the C# box, but it's still quite
    conservative.
 D. No CPR at occurrences of shared data structure in hot paths (e.g. the use of
    `c` in the second eqn of `replicateC`). But we'd need to know which paths
    were hot. We want such static branch frequency estimates in #20378.

We adopt solution (A) It is ad-hoc, but appears to work reasonably well.
Deciding what a &quot;recursive data constructor&quot; is is quite tricky and ad-hoc, too:
See Note [Detecting recursive data constructors]. We don't have to be perfect
and can simply keep on unboxing if unsure.

Note [Detecting recursive data constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
What qualifies as a &quot;recursive data constructor&quot; as per
Note [CPR for recursive data constructors]? That is up to
'GHC.Core.Opt.WorkWrapW.Utils.isRecDataCon' to decide. It does a DFS search over
the field types of the DataCon and looks for term-level recursion into the data
constructor's type constructor. Assuming infinite fuel (point (4) below), it
looks inside the following class of types, represented by `ty` (and responds
`NonRecursiveOrUnsure` in all other cases):

 A. If `ty = forall v. ty'`, then look into `ty'`
 B. If `ty = Tc tc_args` and `Tc` is an `AlgTyCon`, look into the arg
    types of its data constructors and check `tc_args` for recursion.
 C. If `ty = F tc_args`, `F` is a `FamTyCon` and we can reduce `F tc_args` to
    `rhs`, look into the `rhs` type.

A few perhaps surprising points:

  1. It deems any function type as non-recursive, because it's unlikely that
     a recursion through a function type builds up a recursive data structure.
  2. It doesn't look into kinds or coercion types because there's nothing to unbox.
     Same for promoted data constructors.
  3. We don't care whether an AlgTyCon app `T tc_args` is fully saturated or not;
     we simply look at its definition/DataCons and its field tys and look for
     recursive occs in the `tc_args` we are given. This is so that we expand
     the `ST` in `StateT Int (ST s) a`.
  4. We don't recurse deeper than 3 (at the moment of this writing) TyCons and
     assume the DataCon is non-recursive after that. One reason for this &quot;fuel&quot;
     approach is guaranteed constant-time efficiency; the other is that it's
     fair to say that a recursion over 3 or more TyCons doesn't really count as
     a list-like data structure anymore and a bit of unboxing doesn't hurt much.
  5. It checks AlgTyCon apps like `T tc_args` by eagerly checking the `tc_args`
     *before* it looks into the expanded DataCons/NewTyCon, so that it
     terminates before doing a deep nest of expansions only to discover that the
     first level already contained a recursion.
  6. As a result of keeping the implementation simple, it says &quot;recursive&quot;
     for `data T = MkT [T]`, even though we could argue that the inner recursion
     (through the `[]` TyCon) by way of which `T` is recursive will already be
     &quot;broken&quot; and thus never unboxed. Consequently, it might be OK to CPR a
     function returning `T`. Lacking arguments for or against the current simple
     behavior, we stick to it.
  7. When the search hits an abstract TyCon (algebraic, but without visible
     DataCons, e.g., from an .hs-boot file), it returns 'NonRecursiveOrUnsure',
     the same as when we run out of fuel. If there is ever a recursion through
     an abstract TyCon, then it's not part of the same function we are looking
     at in CPR, so we can treat it as if it wasn't recursive.
     We handle stuck type and data families much the same.

Here are a few examples of data constructors or data types with a single data
con and the answers of our function:

  data T = T (Int, (Bool, Char))               NonRec
  (:)                                          Rec
  []                                           NonRec
  data U = U [Int]                             NonRec
  data U2 = U2 [U2]                            Rec     (see point (6))
  data T1 = T1 T2; data T2 = T2 T1             Rec
  newtype Fix f = Fix (f (Fix f))              Rec
  data N = N (Fix (Either Int))                NonRec
  data M = M (Fix (Either M))                  Rec
  data F = F (F -&gt; Int)                        NonRec  (see point (1))
  data G = G (Int -&gt; G)                        NonRec  (see point (1))
  newtype MyM s a = MyM (StateT Int (ST s) a   NonRec
  type S = (Int, Bool)                         NonRec

  { type family E a where
      E Int = Char
      E (a,b) = (E a, E b)
      E Char = Blub
    data Blah = Blah (E (Int, (Int, Int)))     NonRec
    data Blub = Blub (E (Char, Int))           Rec
    data Blub2 = Blub2 (E (Bool, Int))     }   Unsure, because stuck (see point (7))

  { data T1 = T1 T2; data T2 = T2 T3;
    ... data T5 = T5 T1                    }   Unsure (out of fuel)  (see point (4))

  { module A where -- A.hs-boot
      data T
    module B where
      import {-# SOURCE #-} A
      data U = MkU T
      f :: T -&gt; U
      f t = MkU t                              Unsure (T is abstract)  (see point (7))
    module A where -- A.hs
      import B
      data T = MkT U }

These examples are tested by the testcase RecDataConCPR.

I've played with the idea to make points (1) through (3) of 'isRecDataCon'
configurable like (4) to enable more re-use throughout the compiler, but haven't
found a killer app for that yet, so ultimately didn't do that.

Note [CPR examples]
~~~~~~~~~~~~~~~~~~~
Here are some examples (stranal/should_compile/T10482a) of the
usefulness of Note [Optimistic field binder CPR].  The main
point: all of these functions can have the CPR property.

    ------- f1 -----------
    -- x is used strictly by h, so it'll be available
    -- unboxed before it is returned in the True branch

    f1 :: Int -&gt; Int
    f1 x = case h x x of
            True  -&gt; x
            False -&gt; f1 (x-1)

    ------- f3 -----------
    -- h is strict in x, so x will be unboxed before it
    -- is rerturned in the otherwise case.

    data T3 = MkT3 Int Int

    f1 :: T3 -&gt; Int
    f1 (MkT3 x y) | h x y     = f3 (MkT3 x (y-1))
                  | otherwise = x

Historic Note [Optimistic field binder CPR]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This Note describes how we used to guess whether fields have the CPR property
before we were able to express Nested CPR for arguments.

Consider

  data T a = MkT a
  f :: T Int -&gt; Int
  f x = ... (case x of
    MkT y -&gt; y) ...

And assume we know from strictness analysis that `f` is strict in `x` and its
field `y` and we unbox both. Then we give `x` the CPR property according
to Note [CPR for binders that will be unboxed]. But `x`'s sole field `y`
likewise will be unboxed and it should also get the CPR property. We'd
need a *nested* CPR property here for `x` to express that and unwrap one level
when we analyse the Case to give the CPR property to `y`.

Lacking Nested CPR (hence this Note is historic now that we have Nested CPR), we
have to guess a bit, by looking for

  (A) Flat CPR on the scrutinee
  (B) A variable scrutinee. Otherwise surely it can't be a parameter.
  (C) Strict demand on the field binder `y` (or it binds a strict field)

While (A) is a necessary condition to give a field the CPR property, there are
ways in which (B) and (C) are too lax, leading to unsound analysis results and
thus reboxing in the wrapper:

  (b) We could scrutinise some other variable than a parameter, like in

        g :: T Int -&gt; Int
        g x = let z = foo x in -- assume `z` has CPR property
              case z of MkT y -&gt; y

      Lacking Nested CPR and multiple levels of unboxing, only the outer box
      of `z` will be available and a case on `y` won't actually cancel away.
      But it's simple, and nothing terrible happens if we get it wrong. e.g.
      #10694.

  (c) A strictly used field binder doesn't mean the function is strict in it.

        h :: T Int -&gt; Int -&gt; Int
        h !x 0 = 0
        h  x 0 = case x of MkT y -&gt; y

      Here, `y` is used strictly, but the field of `x` certainly is not and
      consequently will not be available unboxed.
      Why not look at the demand of `x` instead to determine whether `y` is
      unboxed? Because the 'idDemandInfo' on `x` will not have been propagated
      to its occurrence in the scrutinee when CprAnal runs directly after
      DmdAnal.

We used to give the case binder the CPR property unconditionally instead of
deriving it from the case scrutinee.
See Historic Note [Optimistic case binder CPR].

Historic Note [Optimistic case binder CPR]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used to give the case binder the CPR property unconditionally, which is too
optimistic (#19232). Here are the details:

Inside the alternative, the case binder always has the CPR property, meaning
that a case on it will successfully cancel.
Example:
  f True  x = case x of y { I# x' -&gt; if x' ==# 3
                                     then y
                                     else I# 8 }
  f False x = I# 3
By giving 'y' the CPR property, we ensure that 'f' does too, so we get
  f b x = case fw b x of { r -&gt; I# r }
  fw True  x = case x of y { I# x' -&gt; if x' ==# 3 then x' else 8 }
  fw False x = 3
Of course there is the usual risk of re-boxing: we have 'x' available boxed
and unboxed, but we return the unboxed version for the wrapper to box. If the
wrapper doesn't cancel with its caller, we'll end up re-boxing something that
we did have available in boxed form.

-}</span><span>
</span><span id="line-1253"></span></pre></body></html>