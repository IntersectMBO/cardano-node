<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- (c) The University of Glasgow 2006</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables, PatternSynonyms, MultiWayIf #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE DeriveFunctor #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Core.Unify</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-8"></span><span>        </span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTy"><span class="hs-identifier">tcMatchTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTyKi"><span class="hs-identifier">tcMatchTyKi</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>        </span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTys"><span class="hs-identifier">tcMatchTys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTyKis"><span class="hs-identifier">tcMatchTyKis</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>        </span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTyX"><span class="hs-identifier">tcMatchTyX</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTysX"><span class="hs-identifier">tcMatchTysX</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTyKisX"><span class="hs-identifier">tcMatchTyKisX</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>        </span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTyX_BM"><span class="hs-identifier">tcMatchTyX_BM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#ruleMatchTyKiX"><span class="hs-identifier">ruleMatchTyKiX</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span>        </span><span class="hs-comment">-- Side-effect free unification</span><span>
</span><span id="line-14"></span><span>        </span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTy"><span class="hs-identifier">tcUnifyTy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTyKi"><span class="hs-identifier">tcUnifyTyKi</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTys"><span class="hs-identifier">tcUnifyTys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTyKis"><span class="hs-identifier">tcUnifyTyKis</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>        </span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTysFG"><span class="hs-identifier">tcUnifyTysFG</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTyWithTFs"><span class="hs-identifier">tcUnifyTyWithTFs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>        </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier">BindFun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFlag"><span class="hs-identifier">BindFlag</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#matchBindFun"><span class="hs-identifier">matchBindFun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier">alwaysBindFun</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>        </span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResult"><span class="hs-identifier">UnifyResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResultM"><span class="hs-identifier">UnifyResultM</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#MaybeApartReason"><span class="hs-identifier">MaybeApartReason</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>        </span><span class="annot"><a href="GHC.Core.Unify.html#typesCantMatch"><span class="hs-identifier">typesCantMatch</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#typesAreApart"><span class="hs-identifier">typesAreApart</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span>        </span><span class="hs-comment">-- Matching a type against a lifted type (coercion)</span><span>
</span><span id="line-21"></span><span>        </span><span class="annot"><a href="GHC.Core.Unify.html#liftCoMatch"><span class="hs-identifier">liftCoMatch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span>        </span><span class="hs-comment">-- The core flattening algorithm</span><span>
</span><span id="line-24"></span><span>        </span><span class="annot"><a href="GHC.Core.Unify.html#flattenTys"><span class="hs-identifier">flattenTys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#flattenTysX"><span class="hs-identifier">flattenTysX</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#mkSysTvName"><span class="hs-identifier">mkSysTvName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#mkSystemVarName"><span class="hs-identifier">mkSystemVarName</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#tYPETyConKey"><span class="hs-identifier">tYPETyConKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#cONSTRAINTTyConKey"><span class="hs-identifier">cONSTRAINTTyConKey</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>     </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#getTvSubstEnv"><span class="hs-identifier">getTvSubstEnv</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#getCvSubstEnv"><span class="hs-identifier">getCvSubstEnv</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html"><span class="hs-identifier">GHC.Core.TyCo.Rep</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html"><span class="hs-identifier">GHC.Core.TyCo.Compare</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-identifier">eqType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-identifier">tcEqType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html"><span class="hs-identifier">GHC.Core.TyCo.FVs</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfCoList"><span class="hs-identifier">tyCoVarsOfCoList</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html#tyCoFVsOfTypes"><span class="hs-identifier">tyCoFVsOfTypes</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html"><span class="hs-identifier">GHC.Core.TyCo.Subst</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#mkTvSubst"><span class="hs-identifier">mkTvSubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#emptyIdSubstEnv"><span class="hs-identifier">emptyIdSubstEnv</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Map.Type.html"><span class="hs-identifier">GHC.Core.Map.Type</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.FV.html"><span class="hs-identifier">GHC.Utils.FV</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.FV.html#FV"><span class="hs-identifier">FV</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.FV.html#fvVarList"><span class="hs-identifier">fvVarList</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html"><span class="hs-identifier">GHC.Data.Pair</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html"><span class="hs-identifier">GHC.Types.Unique</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html"><span class="hs-identifier">GHC.Types.Unique.FM</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Set.html"><span class="hs-identifier">GHC.Types.Unique.Set</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Exts.html#/GHC.Exts.html"><span class="hs-identifier">GHC.Exts</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">oneShot</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html"><span class="hs-identifier">GHC.Utils.Panic.Plain</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.List.html#/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapAccumL/Data.Traversable.html#mapAccumL"><span class="hs-identifier">mapAccumL</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Control.Monad.html#/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Semigroup.html#/Data.Semigroup.html"><span class="hs-identifier">Data.Semigroup</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-comment">{-

Unification is much tricker than you might think.

1. The substitution we generate binds the *template type variables*
   which are given to us explicitly.

2. We want to match in the presence of foralls;
        e.g     (forall a. t1) ~ (forall b. t2)

   That is what the RnEnv2 is for; it does the alpha-renaming
   that makes it as if a and b were the same variable.
   Initialising the RnEnv2, so that it can generate a fresh
   binder when necessary, entails knowing the free variables of
   both types.

3. We must be careful not to bind a template type variable to a
   locally bound variable.  E.g.
        (forall a. x) ~ (forall b. b)
   where x is the template type variable.  Then we do not want to
   bind x to a/b!  This is a kind of occurs check.
   The necessary locals accumulate in the RnEnv2.

Note [tcMatchTy vs tcMatchTyKi]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This module offers two variants of matching: with kinds and without.
The TyKi variant takes two types, of potentially different kinds,
and matches them. Along the way, it necessarily also matches their
kinds. The Ty variant instead assumes that the kinds are already
eqType and so skips matching up the kinds.

How do you choose between them?

1. If you know that the kinds of the two types are eqType, use
   the Ty variant. It is more efficient, as it does less work.

2. If the kinds of variables in the template type might mention type families,
   use the Ty variant (and do other work to make sure the kinds
   work out). These pure unification functions do a straightforward
   syntactic unification and do no complex reasoning about type
   families. Note that the types of the variables in instances can indeed
   mention type families, so instance lookup must use the Ty variant.

   (Nothing goes terribly wrong -- no panics -- if there might be type
   families in kinds in the TyKi variant. You just might get match
   failure even though a reducing a type family would lead to success.)

3. Otherwise, if you're sure that the variable kinds do not mention
   type families and you're not already sure that the kind of the template
   equals the kind of the target, then use the TyKi version.
-}</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- | Some unification functions are parameterised by a 'BindFun', which</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- says whether or not to allow a certain unification to take place.</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- A 'BindFun' takes the 'TyVar' involved along with the 'Type' it will</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- potentially be bound to.</span><span>
</span><span id="line-115"></span><span class="hs-comment">--</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- It is possible for the variable to actually be a coercion variable</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- (Note [Matching coercion variables]), but only when one-way matching.</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- In this case, the 'Type' will be a 'CoercionTy'.</span><span>
</span><span id="line-119"></span><span class="hs-keyword">type</span><span> </span><span id="BindFun"><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-var">BindFun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFlag"><span class="hs-identifier hs-type">BindFlag</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- | @tcMatchTy t1 t2@ produces a substitution (over fvs(t1))</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- @s@ such that @s(t1)@ equals @t2@.</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- The returned substitution might bind coercion variables,</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- if the variable is an argument to a GADT constructor.</span><span>
</span><span id="line-125"></span><span class="hs-comment">--</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- Precondition: typeKind ty1 `eqType` typeKind ty2</span><span>
</span><span id="line-127"></span><span class="hs-comment">--</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- We don't pass in a set of &quot;template variables&quot; to be bound</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- by the match, because tcMatchTy (and similar functions) are</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- always used on top-level types, so we can bind any of the</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- free variables of the LHS.</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- See also Note [tcMatchTy vs tcMatchTyKi]</span><span>
</span><span id="line-133"></span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTy"><span class="hs-identifier hs-type">tcMatchTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-134"></span><span id="tcMatchTy"><span class="annot"><span class="annottext">tcMatchTy :: Type -&gt; Type -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTy"><span class="hs-identifier hs-var hs-var">tcMatchTy</span></a></span></span><span> </span><span id="local-6989586621681626850"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626850"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681626851"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626851"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTys"><span class="hs-identifier hs-var">tcMatchTys</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626850"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626851"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTyX_BM"><span class="hs-identifier hs-type">tcMatchTyX_BM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-type">BindFun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-137"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-138"></span><span id="tcMatchTyX_BM"><span class="annot"><span class="annottext">tcMatchTyX_BM :: BindFun -&gt; Subst -&gt; Type -&gt; Type -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTyX_BM"><span class="hs-identifier hs-var hs-var">tcMatchTyX_BM</span></a></span></span><span> </span><span id="local-6989586621681626852"><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681626852"><span class="hs-identifier hs-var">bind_me</span></a></span></span><span> </span><span id="local-6989586621681626853"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681626853"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681626854"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626854"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681626855"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626855"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; Bool -&gt; Subst -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tc_match_tys_x"><span class="hs-identifier hs-var">tc_match_tys_x</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681626852"><span class="hs-identifier hs-var">bind_me</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681626853"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626854"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626855"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-comment">-- | Like 'tcMatchTy', but allows the kinds of the types to differ,</span><span>
</span><span id="line-142"></span><span class="hs-comment">-- and thus matches them as well.</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- See also Note [tcMatchTy vs tcMatchTyKi]</span><span>
</span><span id="line-144"></span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTyKi"><span class="hs-identifier hs-type">tcMatchTyKi</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-145"></span><span id="tcMatchTyKi"><span class="annot"><span class="annottext">tcMatchTyKi :: Type -&gt; Type -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTyKi"><span class="hs-identifier hs-var hs-var">tcMatchTyKi</span></a></span></span><span> </span><span id="local-6989586621681626857"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626857"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681626858"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626858"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; Bool -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tc_match_tys"><span class="hs-identifier hs-var">tc_match_tys</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var">alwaysBindFun</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626857"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626858"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span class="hs-comment">-- | This is similar to 'tcMatchTy', but extends a substitution</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- See also Note [tcMatchTy vs tcMatchTyKi]</span><span>
</span><span id="line-150"></span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTyX"><span class="hs-identifier hs-type">tcMatchTyX</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>            </span><span class="annot"><span class="hs-comment">-- ^ Substitution to extend</span></span><span>
</span><span id="line-151"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>                </span><span class="annot"><span class="hs-comment">-- ^ Template</span></span><span>
</span><span id="line-152"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>                </span><span class="annot"><span class="hs-comment">-- ^ Target</span></span><span>
</span><span id="line-153"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-154"></span><span id="tcMatchTyX"><span class="annot"><span class="annottext">tcMatchTyX :: Subst -&gt; Type -&gt; Type -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTyX"><span class="hs-identifier hs-var hs-var">tcMatchTyX</span></a></span></span><span> </span><span id="local-6989586621681626860"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681626860"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681626861"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626861"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681626862"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626862"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; Bool -&gt; Subst -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tc_match_tys_x"><span class="hs-identifier hs-var">tc_match_tys_x</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var">alwaysBindFun</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681626860"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626861"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626862"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="hs-comment">-- | Like 'tcMatchTy' but over a list of types.</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- See also Note [tcMatchTy vs tcMatchTyKi]</span><span>
</span><span id="line-159"></span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTys"><span class="hs-identifier hs-type">tcMatchTys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>         </span><span class="annot"><span class="hs-comment">-- ^ Template</span></span><span>
</span><span id="line-160"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>         </span><span class="annot"><span class="hs-comment">-- ^ Target</span></span><span>
</span><span id="line-161"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>    </span><span class="hs-comment">-- ^ One-shot; in principle the template</span><span>
</span><span id="line-162"></span><span>                             </span><span class="hs-comment">-- variables could be free in the target</span><span>
</span><span id="line-163"></span><span id="tcMatchTys"><span class="annot"><span class="annottext">tcMatchTys :: [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTys"><span class="hs-identifier hs-var hs-var">tcMatchTys</span></a></span></span><span> </span><span id="local-6989586621681626863"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626863"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681626864"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626864"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; Bool -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tc_match_tys"><span class="hs-identifier hs-var">tc_match_tys</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var">alwaysBindFun</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626863"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626864"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="hs-comment">-- | Like 'tcMatchTyKi' but over a list of types.</span><span>
</span><span id="line-167"></span><span class="hs-comment">-- See also Note [tcMatchTy vs tcMatchTyKi]</span><span>
</span><span id="line-168"></span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTyKis"><span class="hs-identifier hs-type">tcMatchTyKis</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>         </span><span class="annot"><span class="hs-comment">-- ^ Template</span></span><span>
</span><span id="line-169"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>         </span><span class="annot"><span class="hs-comment">-- ^ Target</span></span><span>
</span><span id="line-170"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ One-shot substitution</span></span><span>
</span><span id="line-171"></span><span id="tcMatchTyKis"><span class="annot"><span class="annottext">tcMatchTyKis :: [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTyKis"><span class="hs-identifier hs-var hs-var">tcMatchTyKis</span></a></span></span><span> </span><span id="local-6989586621681626865"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626865"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681626866"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626866"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; Bool -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tc_match_tys"><span class="hs-identifier hs-var">tc_match_tys</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var">alwaysBindFun</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626865"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626866"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="hs-comment">-- | Like 'tcMatchTys', but extending a substitution</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- See also Note [tcMatchTy vs tcMatchTyKi]</span><span>
</span><span id="line-176"></span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTysX"><span class="hs-identifier hs-type">tcMatchTysX</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>       </span><span class="annot"><span class="hs-comment">-- ^ Substitution to extend</span></span><span>
</span><span id="line-177"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>         </span><span class="annot"><span class="hs-comment">-- ^ Template</span></span><span>
</span><span id="line-178"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>         </span><span class="annot"><span class="hs-comment">-- ^ Target</span></span><span>
</span><span id="line-179"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ One-shot substitution</span></span><span>
</span><span id="line-180"></span><span id="tcMatchTysX"><span class="annot"><span class="annottext">tcMatchTysX :: Subst -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTysX"><span class="hs-identifier hs-var hs-var">tcMatchTysX</span></a></span></span><span> </span><span id="local-6989586621681626867"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681626867"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681626868"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626868"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681626869"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626869"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; Bool -&gt; Subst -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tc_match_tys_x"><span class="hs-identifier hs-var">tc_match_tys_x</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var">alwaysBindFun</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681626867"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626868"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626869"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span class="hs-comment">-- | Like 'tcMatchTyKis', but extending a substitution</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- See also Note [tcMatchTy vs tcMatchTyKi]</span><span>
</span><span id="line-185"></span><span class="annot"><a href="GHC.Core.Unify.html#tcMatchTyKisX"><span class="hs-identifier hs-type">tcMatchTyKisX</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>        </span><span class="annot"><span class="hs-comment">-- ^ Substitution to extend</span></span><span>
</span><span id="line-186"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>          </span><span class="annot"><span class="hs-comment">-- ^ Template</span></span><span>
</span><span id="line-187"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>          </span><span class="annot"><span class="hs-comment">-- ^ Target</span></span><span>
</span><span id="line-188"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ One-shot substitution</span></span><span>
</span><span id="line-189"></span><span id="tcMatchTyKisX"><span class="annot"><span class="annottext">tcMatchTyKisX :: Subst -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcMatchTyKisX"><span class="hs-identifier hs-var hs-var">tcMatchTyKisX</span></a></span></span><span> </span><span id="local-6989586621681626870"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681626870"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681626871"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626871"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681626872"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626872"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; Bool -&gt; Subst -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tc_match_tys_x"><span class="hs-identifier hs-var">tc_match_tys_x</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var">alwaysBindFun</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681626870"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626871"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626872"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span class="annot"><span class="hs-comment">-- | Same as tc_match_tys_x, but starts with an empty substitution</span></span><span>
</span><span id="line-193"></span><span class="annot"><a href="GHC.Core.Unify.html#tc_match_tys"><span class="hs-identifier hs-type">tc_match_tys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-type">BindFun</span></a></span><span>
</span><span id="line-194"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>          </span><span class="annot"><span class="hs-comment">-- ^ match kinds?</span></span><span>
</span><span id="line-195"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-196"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-197"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-198"></span><span id="tc_match_tys"><span class="annot"><span class="annottext">tc_match_tys :: BindFun -&gt; Bool -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tc_match_tys"><span class="hs-identifier hs-var hs-var">tc_match_tys</span></a></span></span><span> </span><span id="local-6989586621681626873"><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681626873"><span class="hs-identifier hs-var">bind_me</span></a></span></span><span> </span><span id="local-6989586621681626874"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681626874"><span class="hs-identifier hs-var">match_kis</span></a></span></span><span> </span><span id="local-6989586621681626875"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626875"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681626876"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626876"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; Bool -&gt; Subst -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tc_match_tys_x"><span class="hs-identifier hs-var">tc_match_tys_x</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681626873"><span class="hs-identifier hs-var">bind_me</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681626874"><span class="hs-identifier hs-var">match_kis</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681626878"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626875"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626876"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-201"></span><span>    </span><span id="local-6989586621681626878"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621681626878"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626875"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626876"><span class="hs-identifier hs-var">tys2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="annot"><span class="hs-comment">-- | Worker for 'tcMatchTysX' and 'tcMatchTyKisX'</span></span><span>
</span><span id="line-204"></span><span class="annot"><a href="GHC.Core.Unify.html#tc_match_tys_x"><span class="hs-identifier hs-type">tc_match_tys_x</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-type">BindFun</span></a></span><span>
</span><span id="line-205"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>          </span><span class="annot"><span class="hs-comment">-- ^ match kinds?</span></span><span>
</span><span id="line-206"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-207"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-208"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-209"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-210"></span><span id="tc_match_tys_x"><span class="annot"><span class="annottext">tc_match_tys_x :: BindFun -&gt; Bool -&gt; Subst -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tc_match_tys_x"><span class="hs-identifier hs-var hs-var">tc_match_tys_x</span></a></span></span><span> </span><span id="local-6989586621681626882"><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681626882"><span class="hs-identifier hs-var">bind_me</span></a></span></span><span> </span><span id="local-6989586621681626883"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681626883"><span class="hs-identifier hs-var">match_kis</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span id="local-6989586621681626885"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681626885"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621681626886"><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621681626886"><span class="hs-identifier hs-var">id_env</span></a></span></span><span> </span><span id="local-6989586621681626887"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681626887"><span class="hs-identifier hs-var">tv_env</span></a></span></span><span> </span><span id="local-6989586621681626888"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681626888"><span class="hs-identifier hs-var">cv_env</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681626889"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626889"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681626890"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626890"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BindFun
-&gt; Bool
-&gt; Bool
-&gt; Bool
-&gt; RnEnv2
-&gt; TvSubstEnv
-&gt; CvSubstEnv
-&gt; [Type]
-&gt; [Type]
-&gt; UnifyResultM (TvSubstEnv, CvSubstEnv)
</span><a href="GHC.Core.Unify.html#tc_unify_tys"><span class="hs-identifier hs-var">tc_unify_tys</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681626882"><span class="hs-identifier hs-var">bind_me</span></a></span><span>
</span><span id="line-212"></span><span>                      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- Matching, not unifying</span><span>
</span><span id="line-213"></span><span>                      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- Not an injectivity check</span><span>
</span><span id="line-214"></span><span>                      </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681626883"><span class="hs-identifier hs-var">match_kis</span></a></span><span>
</span><span id="line-215"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; RnEnv2
</span><a href="GHC.Types.Var.Env.html#mkRnEnv2"><span class="hs-identifier hs-var">mkRnEnv2</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681626885"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681626887"><span class="hs-identifier hs-var">tv_env</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681626888"><span class="hs-identifier hs-var">cv_env</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626889"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626890"><span class="hs-identifier hs-var">tys2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-216"></span><span>      </span><span class="annot"><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-type">Unifiable</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681626894"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681626894"><span class="hs-identifier hs-var">tv_env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681626895"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681626895"><span class="hs-identifier hs-var">cv_env'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Maybe Subst
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Maybe Subst) -&gt; Subst -&gt; Maybe Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdSubstEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681626885"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="#local-6989586621681626886"><span class="hs-identifier hs-var">id_env</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681626894"><span class="hs-identifier hs-var">tv_env'</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681626895"><span class="hs-identifier hs-var">cv_env'</span></a></span><span>
</span><span id="line-218"></span><span>      </span><span class="annot"><span class="annottext">UnifyResultM (TvSubstEnv, CvSubstEnv)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Subst
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="hs-comment">-- | This one is called from the expression matcher,</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- which already has a MatchEnv in hand</span><span>
</span><span id="line-222"></span><span class="annot"><a href="GHC.Core.Unify.html#ruleMatchTyKiX"><span class="hs-identifier hs-type">ruleMatchTyKiX</span></a></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a></span><span>          </span><span class="annot"><span class="hs-comment">-- ^ template variables</span></span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a></span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span>          </span><span class="annot"><span class="hs-comment">-- ^ type substitution to extend</span></span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>                </span><span class="annot"><span class="hs-comment">-- ^ Template</span></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>                </span><span class="annot"><span class="hs-comment">-- ^ Target</span></span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span>
</span><span id="line-229"></span><span id="ruleMatchTyKiX"><span class="annot"><span class="annottext">ruleMatchTyKiX :: VarSet -&gt; RnEnv2 -&gt; TvSubstEnv -&gt; Type -&gt; Type -&gt; Maybe TvSubstEnv
</span><a href="GHC.Core.Unify.html#ruleMatchTyKiX"><span class="hs-identifier hs-var hs-var">ruleMatchTyKiX</span></a></span></span><span> </span><span id="local-6989586621681626897"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681626897"><span class="hs-identifier hs-var">tmpl_tvs</span></a></span></span><span> </span><span id="local-6989586621681626898"><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621681626898"><span class="hs-identifier hs-var">rn_env</span></a></span></span><span> </span><span id="local-6989586621681626899"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681626899"><span class="hs-identifier hs-var">tenv</span></a></span></span><span> </span><span id="local-6989586621681626900"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626900"><span class="hs-identifier hs-var">tmpl</span></a></span></span><span> </span><span id="local-6989586621681626901"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626901"><span class="hs-identifier hs-var">target</span></a></span></span><span>
</span><span id="line-230"></span><span class="hs-comment">-- See Note [Kind coercions in Unify]</span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BindFun
-&gt; Bool
-&gt; Bool
-&gt; Bool
-&gt; RnEnv2
-&gt; TvSubstEnv
-&gt; CvSubstEnv
-&gt; [Type]
-&gt; [Type]
-&gt; UnifyResultM (TvSubstEnv, CvSubstEnv)
</span><a href="GHC.Core.Unify.html#tc_unify_tys"><span class="hs-identifier hs-var">tc_unify_tys</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; BindFun
</span><a href="GHC.Core.Unify.html#matchBindFun"><span class="hs-identifier hs-var">matchBindFun</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681626897"><span class="hs-identifier hs-var">tmpl_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-232"></span><span>                      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- &lt;-- this means to match the kinds</span><span>
</span><span id="line-233"></span><span>                      </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621681626898"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681626899"><span class="hs-identifier hs-var">tenv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="GHC.Core.TyCo.Subst.html#emptyCvSubstEnv"><span class="hs-identifier hs-var">emptyCvSubstEnv</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626900"><span class="hs-identifier hs-var">tmpl</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626901"><span class="hs-identifier hs-var">target</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-234"></span><span>      </span><span class="annot"><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-type">Unifiable</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681626903"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681626903"><span class="hs-identifier hs-var">tenv'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; Maybe TvSubstEnv
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681626903"><span class="hs-identifier hs-var">tenv'</span></a></span><span>
</span><span id="line-235"></span><span>      </span><span class="annot"><span class="annottext">UnifyResultM (TvSubstEnv, CvSubstEnv)
</span><span class="hs-identifier">_</span></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe TvSubstEnv
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span class="hs-comment">-- | Allow binding only for any variable in the set. Variables may</span><span>
</span><span id="line-238"></span><span class="hs-comment">-- be bound to any type.</span><span>
</span><span id="line-239"></span><span class="hs-comment">-- Used when doing simple matching; e.g. can we find a substitution</span><span>
</span><span id="line-240"></span><span class="hs-comment">--</span><span>
</span><span id="line-241"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- S = [a :-&gt; t1, b :-&gt; t2] such that</span><span>
</span><span id="line-243"></span><span class="hs-comment">--     S( Maybe (a, b-&gt;Int )  =   Maybe (Bool, Char -&gt; Int)</span><span>
</span><span id="line-244"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-245"></span><span class="annot"><a href="GHC.Core.Unify.html#matchBindFun"><span class="hs-identifier hs-type">matchBindFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-type">BindFun</span></a></span><span>
</span><span id="line-246"></span><span id="matchBindFun"><span class="annot"><span class="annottext">matchBindFun :: VarSet -&gt; BindFun
</span><a href="GHC.Core.Unify.html#matchBindFun"><span class="hs-identifier hs-var hs-var">matchBindFun</span></a></span></span><span> </span><span id="local-6989586621681626904"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681626904"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621681626905"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681626905"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621681626906"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626906"><span class="hs-identifier hs-var">_ty</span></a></span></span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681626905"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681626904"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFlag
</span><a href="GHC.Core.Unify.html#BindMe"><span class="hs-identifier hs-var">BindMe</span></a></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFlag
</span><a href="GHC.Core.Unify.html#Apart"><span class="hs-identifier hs-var">Apart</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="annot"><span class="hs-comment">-- | Allow the binding of any variable to any type</span></span><span>
</span><span id="line-251"></span><span class="annot"><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-type">alwaysBindFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-type">BindFun</span></a></span><span>
</span><span id="line-252"></span><span id="alwaysBindFun"><span class="annot"><span class="annottext">alwaysBindFun :: BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var hs-var">alwaysBindFun</span></a></span></span><span> </span><span id="local-6989586621681626910"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681626910"><span class="hs-identifier hs-var">_tv</span></a></span></span><span> </span><span id="local-6989586621681626911"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626911"><span class="hs-identifier hs-var">_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFlag
</span><a href="GHC.Core.Unify.html#BindMe"><span class="hs-identifier hs-var">BindMe</span></a></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                GADTs
*                                                                      *
************************************************************************

Note [Pruning dead case alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider        data T a where
                   T1 :: T Int
                   T2 :: T a

                newtype X = MkX Int
                newtype Y = MkY Char

                type family F a
                type instance F Bool = Int

Now consider    case x of { T1 -&gt; e1; T2 -&gt; e2 }

The question before the house is this: if I know something about the type
of x, can I prune away the T1 alternative?

Suppose x::T Char.  It's impossible to construct a (T Char) using T1,
        Answer = YES we can prune the T1 branch (clearly)

Suppose x::T (F a), where 'a' is in scope.  Then 'a' might be instantiated
to 'Bool', in which case x::T Int, so
        ANSWER = NO (clearly)

We see here that we want precisely the apartness check implemented within
tcUnifyTysFG. So that's what we do! Two types cannot match if they are surely
apart. Note that since we are simply dropping dead code, a conservative test
suffices.
-}</span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="hs-comment">-- | Given a list of pairs of types, are any two members of a pair surely</span><span>
</span><span id="line-292"></span><span class="hs-comment">-- apart, even after arbitrary type function evaluation and substitution?</span><span>
</span><span id="line-293"></span><span class="annot"><a href="GHC.Core.Unify.html#typesCantMatch"><span class="hs-identifier hs-type">typesCantMatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-294"></span><span class="hs-comment">-- See Note [Pruning dead case alternatives]</span><span>
</span><span id="line-295"></span><span id="typesCantMatch"><span class="annot"><span class="annottext">typesCantMatch :: [(Type, Type)] -&gt; Bool
</span><a href="GHC.Core.Unify.html#typesCantMatch"><span class="hs-identifier hs-var hs-var">typesCantMatch</span></a></span></span><span> </span><span id="local-6989586621681626912"><span class="annot"><span class="annottext">[(Type, Type)]
</span><a href="#local-6989586621681626912"><span class="hs-identifier hs-var">prs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Type, Type) -&gt; Bool) -&gt; [(Type, Type)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#any/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Type -&gt; Type -&gt; Bool) -&gt; (Type, Type) -&gt; Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#uncurry/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.Unify.html#typesAreApart"><span class="hs-identifier hs-var">typesAreApart</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Type, Type)]
</span><a href="#local-6989586621681626912"><span class="hs-identifier hs-var">prs</span></a></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="annot"><a href="GHC.Core.Unify.html#typesAreApart"><span class="hs-identifier hs-type">typesAreApart</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-298"></span><span id="typesAreApart"><span class="annot"><span class="annottext">typesAreApart :: Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.Unify.html#typesAreApart"><span class="hs-identifier hs-var hs-var">typesAreApart</span></a></span></span><span> </span><span id="local-6989586621681626915"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626915"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621681626916"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626916"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; [Type] -&gt; [Type] -&gt; UnifyResult
</span><a href="GHC.Core.Unify.html#tcUnifyTysFG"><span class="hs-identifier hs-var">tcUnifyTysFG</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var">alwaysBindFun</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626915"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626916"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-299"></span><span>                        </span><span class="annot"><span class="annottext">UnifyResult
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-300"></span><span>                        </span><span class="annot"><span class="annottext">UnifyResult
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-301"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
             Unification
*                                                                      *
************************************************************************

Note [Fine-grained unification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Do the types (x, x) and ([y], y) unify? The answer is seemingly &quot;no&quot; --
no substitution to finite types makes these match. But, a substitution to
*infinite* types can unify these two types: [x |-&gt; [[[...]]], y |-&gt; [[[...]]] ].
Why do we care? Consider these two type family instances:

type instance F x x   = Int
type instance F [y] y = Bool

If we also have

type instance Looper = [Looper]

then the instances potentially overlap. The solution is to use unification
over infinite terms. This is possible (see [1] for lots of gory details), but
a full algorithm is a little more power than we need. Instead, we make a
conservative approximation and just omit the occurs check.

[1]: http://research.microsoft.com/en-us/um/people/simonpj/papers/ext-f/axioms-extended.pdf

tcUnifyTys considers an occurs-check problem as the same as general unification
failure.

tcUnifyTysFG (&quot;fine-grained&quot;) returns one of three results: success, occurs-check
failure (&quot;MaybeApart&quot;), or general failure (&quot;SurelyApart&quot;).

See also #8162.

It's worth noting that unification in the presence of infinite types is not
complete. This means that, sometimes, a closed type family does not reduce
when it should. See test case indexed-types/should_fail/Overlap15 for an
example.

Note [Unification result]
~~~~~~~~~~~~~~~~~~~~~~~~~
When unifying t1 ~ t2, we return
* Unifiable s, if s is a substitution such that s(t1) is syntactically the
  same as s(t2), modulo type-synonym expansion.
* SurelyApart, if there is no substitution s such that s(t1) = s(t2),
  where &quot;=&quot; includes type-family reductions.
* MaybeApart mar s, when we aren't sure. `mar` is a MaybeApartReason.

Examples
* [a] ~ Maybe b: SurelyApart, because [] and Maybe can't unify
* [(a,Int)] ~ [(Bool,b)]:  Unifiable
* [F Int] ~ [Bool]: MaybeApart MARTypeFamily, because F Int might reduce to Bool (the unifier
                    does not try this)
* a ~ Maybe a: MaybeApart MARInfinite. Not Unifiable clearly, but not SurelyApart either; consider
       a := Loop
       where  type family Loop where Loop = Maybe Loop

There is the possibility that two types are MaybeApart for *both* reasons:

* (a, F Int) ~ (Maybe a, Bool)

What reason should we use? The *only* consumer of the reason is described
in Note [Infinitary substitution in lookup] in GHC.Core.InstEnv. The goal
there is identify which instances might match a target later (but don't
match now) -- except that we want to ignore the possibility of infinitary
substitutions. So let's examine a concrete scenario:

  class C a b c
  instance C a (Maybe a) Bool
  -- other instances, including one that will actually match
  [W] C b b (F Int)

Do we want the instance as a future possibility? No. The only way that
instance can match is in the presence of an infinite type (infinitely
nested Maybes). We thus say that MARInfinite takes precedence, so that
InstEnv treats this case as an infinitary substitution case; the fact
that a type family is involved is only incidental. We thus define
the Semigroup instance for MaybeApartReason to prefer MARInfinite.

Note [The substitution in MaybeApart]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The constructor MaybeApart carries data with it, typically a TvSubstEnv. Why?
Because consider unifying these:

(a, a, Int) ~ (b, [b], Bool)

If we go left-to-right, we start with [a |-&gt; b]. Then, on the middle terms, we
apply the subst we have so far and discover that we need [b |-&gt; [b]]. Because
this fails the occurs check, we say that the types are MaybeApart (see above
Note [Fine-grained unification]). But, we can't stop there! Because if we
continue, we discover that Int is SurelyApart from Bool, and therefore the
types are apart. This has practical consequences for the ability for closed
type family applications to reduce. See test case
indexed-types/should_compile/Overlap14.

-}</span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span class="hs-comment">-- | Simple unification of two types; all type variables are bindable</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- Precondition: the kinds are already equal</span><span>
</span><span id="line-402"></span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTy"><span class="hs-identifier hs-type">tcUnifyTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>       </span><span class="hs-comment">-- All tyvars are bindable</span><span>
</span><span id="line-403"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-404"></span><span>                       </span><span class="hs-comment">-- A regular one-shot (idempotent) substitution</span><span>
</span><span id="line-405"></span><span id="tcUnifyTy"><span class="annot"><span class="annottext">tcUnifyTy :: Type -&gt; Type -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcUnifyTy"><span class="hs-identifier hs-var hs-var">tcUnifyTy</span></a></span></span><span> </span><span id="local-6989586621681626918"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626918"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621681626919"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626919"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcUnifyTys"><span class="hs-identifier hs-var">tcUnifyTys</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var">alwaysBindFun</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626918"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626919"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span class="annot"><span class="hs-comment">-- | Like 'tcUnifyTy', but also unifies the kinds</span></span><span>
</span><span id="line-408"></span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTyKi"><span class="hs-identifier hs-type">tcUnifyTyKi</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-409"></span><span id="tcUnifyTyKi"><span class="annot"><span class="annottext">tcUnifyTyKi :: Type -&gt; Type -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcUnifyTyKi"><span class="hs-identifier hs-var hs-var">tcUnifyTyKi</span></a></span></span><span> </span><span id="local-6989586621681626920"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626920"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621681626921"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626921"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcUnifyTyKis"><span class="hs-identifier hs-var">tcUnifyTyKis</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var">alwaysBindFun</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626920"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626921"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span class="hs-comment">-- | Unify two types, treating type family applications as possibly unifying</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- with anything and looking through injective type family applications.</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- Precondition: kinds are the same</span><span>
</span><span id="line-414"></span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTyWithTFs"><span class="hs-identifier hs-type">tcUnifyTyWithTFs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>  </span><span class="hs-comment">-- ^ True &lt;=&gt; do two-way unification;</span><span>
</span><span id="line-415"></span><span>                          </span><span class="hs-comment">--   False &lt;=&gt; do one-way matching.</span><span>
</span><span id="line-416"></span><span>                          </span><span class="hs-comment">--   See end of sec 5.2 from the paper</span><span>
</span><span id="line-417"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span>     </span><span class="hs-comment">-- Should include the free tyvars of both Type args</span><span>
</span><span id="line-418"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>   </span><span class="hs-comment">-- Types to unify</span><span>
</span><span id="line-419"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-420"></span><span class="hs-comment">-- This algorithm is an implementation of the &quot;Algorithm U&quot; presented in</span><span>
</span><span id="line-421"></span><span class="hs-comment">-- the paper &quot;Injective type families for Haskell&quot;, Figures 2 and 3.</span><span>
</span><span id="line-422"></span><span class="hs-comment">-- The code is incorporated with the standard unifier for convenience, but</span><span>
</span><span id="line-423"></span><span class="hs-comment">-- its operation should match the specification in the paper.</span><span>
</span><span id="line-424"></span><span id="tcUnifyTyWithTFs"><span class="annot"><span class="annottext">tcUnifyTyWithTFs :: Bool -&gt; InScopeSet -&gt; Type -&gt; Type -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcUnifyTyWithTFs"><span class="hs-identifier hs-var hs-var">tcUnifyTyWithTFs</span></a></span></span><span> </span><span id="local-6989586621681626922"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681626922"><span class="hs-identifier hs-var">twoWay</span></a></span></span><span> </span><span id="local-6989586621681626923"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681626923"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621681626924"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626924"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621681626925"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626925"><span class="hs-identifier hs-var">t2</span></a></span></span><span>
</span><span id="line-425"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BindFun
-&gt; Bool
-&gt; Bool
-&gt; Bool
-&gt; RnEnv2
-&gt; TvSubstEnv
-&gt; CvSubstEnv
-&gt; [Type]
-&gt; [Type]
-&gt; UnifyResultM (TvSubstEnv, CvSubstEnv)
</span><a href="GHC.Core.Unify.html#tc_unify_tys"><span class="hs-identifier hs-var">tc_unify_tys</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="GHC.Core.Unify.html#alwaysBindFun"><span class="hs-identifier hs-var">alwaysBindFun</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681626922"><span class="hs-identifier hs-var">twoWay</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-426"></span><span>                       </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621681626926"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="GHC.Core.TyCo.Subst.html#emptyTvSubstEnv"><span class="hs-identifier hs-var">emptyTvSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="GHC.Core.TyCo.Subst.html#emptyCvSubstEnv"><span class="hs-identifier hs-var">emptyCvSubstEnv</span></a></span><span>
</span><span id="line-427"></span><span>                       </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626924"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681626925"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-428"></span><span>      </span><span class="annot"><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-type">Unifiable</span></a></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621681626928"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681626928"><span class="hs-identifier hs-var">tv_subst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681626929"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681626929"><span class="hs-identifier hs-var">_cv_subst</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Maybe Subst
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Maybe Subst) -&gt; Subst -&gt; Maybe Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; Subst
</span><a href="#local-6989586621681626930"><span class="hs-identifier hs-var">maybe_fix</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681626928"><span class="hs-identifier hs-var">tv_subst</span></a></span><span>
</span><span id="line-429"></span><span>      </span><span class="annot"><a href="GHC.Core.Unify.html#MaybeApart"><span class="hs-identifier hs-type">MaybeApart</span></a></span><span> </span><span id="local-6989586621681626932"><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681626932"><span class="hs-identifier hs-var">_reason</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681626933"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681626933"><span class="hs-identifier hs-var">tv_subst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681626934"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681626934"><span class="hs-identifier hs-var">_cv_subst</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Maybe Subst
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Maybe Subst) -&gt; Subst -&gt; Maybe Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; Subst
</span><a href="#local-6989586621681626930"><span class="hs-identifier hs-var">maybe_fix</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681626933"><span class="hs-identifier hs-var">tv_subst</span></a></span><span>
</span><span id="line-430"></span><span>      </span><span class="hs-comment">-- we want to *succeed* in questionable cases. This is a</span><span>
</span><span id="line-431"></span><span>      </span><span class="hs-comment">-- pre-unification algorithm.</span><span>
</span><span id="line-432"></span><span>      </span><span class="annot"><span class="annottext">UnifyResultM (TvSubstEnv, CvSubstEnv)
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Subst
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-433"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-434"></span><span>    </span><span id="local-6989586621681626926"><span class="annot"><span class="annottext">rn_env :: RnEnv2
</span><a href="#local-6989586621681626926"><span class="hs-identifier hs-var hs-var">rn_env</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; RnEnv2
</span><a href="GHC.Types.Var.Env.html#mkRnEnv2"><span class="hs-identifier hs-var">mkRnEnv2</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681626923"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span>    </span><span id="local-6989586621681626930"><span class="annot"><span class="annottext">maybe_fix :: TvSubstEnv -&gt; Subst
</span><a href="#local-6989586621681626930"><span class="hs-identifier hs-var hs-var">maybe_fix</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681626922"><span class="hs-identifier hs-var">twoWay</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TvSubstEnv -&gt; Subst
</span><a href="GHC.Core.Unify.html#niFixSubst"><span class="hs-identifier hs-var">niFixSubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681626923"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-437"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkTvSubst"><span class="hs-identifier hs-var">mkTvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681626923"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-comment">-- when matching, don't confuse</span><span>
</span><span id="line-438"></span><span>                                               </span><span class="hs-comment">-- domain with range</span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span class="hs-comment">-----------------</span><span>
</span><span id="line-441"></span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTys"><span class="hs-identifier hs-type">tcUnifyTys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-type">BindFun</span></a></span><span>
</span><span id="line-442"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-443"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-444"></span><span>                                </span><span class="hs-comment">-- ^ A regular one-shot (idempotent) substitution</span><span>
</span><span id="line-445"></span><span>                                </span><span class="hs-comment">-- that unifies the erased types. See comments</span><span>
</span><span id="line-446"></span><span>                                </span><span class="hs-comment">-- for 'tcUnifyTysFG'</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span class="hs-comment">-- The two types may have common type variables, and indeed do so in the</span><span>
</span><span id="line-449"></span><span class="hs-comment">-- second call to tcUnifyTys in GHC.Tc.Instance.FunDeps.checkClsFD</span><span>
</span><span id="line-450"></span><span id="tcUnifyTys"><span class="annot"><span class="annottext">tcUnifyTys :: BindFun -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcUnifyTys"><span class="hs-identifier hs-var hs-var">tcUnifyTys</span></a></span></span><span> </span><span id="local-6989586621681626936"><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681626936"><span class="hs-identifier hs-var">bind_fn</span></a></span></span><span> </span><span id="local-6989586621681626937"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626937"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681626938"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626938"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; [Type] -&gt; [Type] -&gt; UnifyResult
</span><a href="GHC.Core.Unify.html#tcUnifyTysFG"><span class="hs-identifier hs-var">tcUnifyTysFG</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681626936"><span class="hs-identifier hs-var">bind_fn</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626937"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626938"><span class="hs-identifier hs-var">tys2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-452"></span><span>      </span><span class="annot"><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-type">Unifiable</span></a></span><span> </span><span id="local-6989586621681626939"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681626939"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Maybe Subst
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681626939"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-453"></span><span>      </span><span class="annot"><span class="annottext">UnifyResult
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Subst
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span class="annot"><span class="hs-comment">-- | Like 'tcUnifyTys' but also unifies the kinds</span></span><span>
</span><span id="line-456"></span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTyKis"><span class="hs-identifier hs-type">tcUnifyTyKis</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-type">BindFun</span></a></span><span>
</span><span id="line-457"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-458"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-459"></span><span id="tcUnifyTyKis"><span class="annot"><span class="annottext">tcUnifyTyKis :: BindFun -&gt; [Type] -&gt; [Type] -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcUnifyTyKis"><span class="hs-identifier hs-var hs-var">tcUnifyTyKis</span></a></span></span><span> </span><span id="local-6989586621681626940"><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681626940"><span class="hs-identifier hs-var">bind_fn</span></a></span></span><span> </span><span id="local-6989586621681626941"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626941"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681626942"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626942"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-460"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BindFun -&gt; [Type] -&gt; [Type] -&gt; UnifyResult
</span><a href="GHC.Core.Unify.html#tcUnifyTyKisFG"><span class="hs-identifier hs-var">tcUnifyTyKisFG</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681626940"><span class="hs-identifier hs-var">bind_fn</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626941"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681626942"><span class="hs-identifier hs-var">tys2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-461"></span><span>      </span><span class="annot"><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-type">Unifiable</span></a></span><span> </span><span id="local-6989586621681626944"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681626944"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Maybe Subst
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681626944"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-462"></span><span>      </span><span class="annot"><span class="annottext">UnifyResult
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Subst
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span class="hs-comment">-- This type does double-duty. It is used in the UM (unifier monad) and to</span><span>
</span><span id="line-465"></span><span class="hs-comment">-- return the final result. See Note [Fine-grained unification]</span><span>
</span><span id="line-466"></span><span class="hs-keyword">type</span><span> </span><span id="UnifyResult"><span class="annot"><a href="GHC.Core.Unify.html#UnifyResult"><span class="hs-identifier hs-var">UnifyResult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResultM"><span class="hs-identifier hs-type">UnifyResultM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span class="annot"><span class="hs-comment">-- | See Note [Unification result]</span></span><span>
</span><span id="line-469"></span><span class="hs-keyword">data</span><span> </span><span id="UnifyResultM"><span class="annot"><a href="GHC.Core.Unify.html#UnifyResultM"><span class="hs-identifier hs-var">UnifyResultM</span></a></span></span><span> </span><span id="local-6989586621681626591"><span class="annot"><a href="#local-6989586621681626591"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Unifiable"><span class="annot"><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-var">Unifiable</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621681626591"><span class="hs-identifier hs-type">a</span></a></span><span>        </span><span class="hs-comment">-- the subst that unifies the types</span><span>
</span><span id="line-470"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span id="MaybeApart"><span class="annot"><a href="GHC.Core.Unify.html#MaybeApart"><span class="hs-identifier hs-var">MaybeApart</span></a></span></span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#MaybeApartReason"><span class="hs-identifier hs-type">MaybeApartReason</span></a></span><span>
</span><span id="line-471"></span><span>                                 </span><span class="annot"><a href="#local-6989586621681626591"><span class="hs-identifier hs-type">a</span></a></span><span>       </span><span class="hs-comment">-- the subst has as much as we know</span><span>
</span><span id="line-472"></span><span>                                         </span><span class="hs-comment">-- it must be part of a most general unifier</span><span>
</span><span id="line-473"></span><span>                                         </span><span class="hs-comment">-- See Note [The substitution in MaybeApart]</span><span>
</span><span id="line-474"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span id="SurelyApart"><span class="annot"><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span></span><span>
</span><span id="line-475"></span><span>                    </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621681626946"><span id="local-6989586621681626948"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; UnifyResultM a -&gt; UnifyResultM b)
-&gt; (forall a b. a -&gt; UnifyResultM b -&gt; UnifyResultM a)
-&gt; Functor UnifyResultM
forall a b. a -&gt; UnifyResultM b -&gt; UnifyResultM a
forall a b. (a -&gt; b) -&gt; UnifyResultM a -&gt; UnifyResultM b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
$cfmap :: forall a b. (a -&gt; b) -&gt; UnifyResultM a -&gt; UnifyResultM b
fmap :: forall a b. (a -&gt; b) -&gt; UnifyResultM a -&gt; UnifyResultM b
$c&lt;$ :: forall a b. a -&gt; UnifyResultM b -&gt; UnifyResultM a
&lt;$ :: forall a b. a -&gt; UnifyResultM b -&gt; UnifyResultM a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#Functor/GHC.Base.html#Functor"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></a></span></span></span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span class="hs-comment">-- | Why are two types 'MaybeApart'? 'MARInfinite' takes precedence:</span><span>
</span><span id="line-478"></span><span class="hs-comment">-- This is used (only) in Note [Infinitary substitution in lookup] in GHC.Core.InstEnv</span><span>
</span><span id="line-479"></span><span class="hs-comment">-- As of Feb 2022, we never differentiate between MARTypeFamily and MARTypeVsConstraint;</span><span>
</span><span id="line-480"></span><span class="hs-comment">-- it's really only MARInfinite that's interesting here.</span><span>
</span><span id="line-481"></span><span class="hs-keyword">data</span><span> </span><span id="MaybeApartReason"><span class="annot"><a href="GHC.Core.Unify.html#MaybeApartReason"><span class="hs-identifier hs-var">MaybeApartReason</span></a></span></span><span>
</span><span id="line-482"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="MARTypeFamily"><span class="annot"><a href="GHC.Core.Unify.html#MARTypeFamily"><span class="hs-identifier hs-var">MARTypeFamily</span></a></span></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ matching e.g. F Int ~? Bool</span></span><span>
</span><span id="line-483"></span><span>
</span><span id="line-484"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MARInfinite"><span class="annot"><a href="GHC.Core.Unify.html#MARInfinite"><span class="hs-identifier hs-var">MARInfinite</span></a></span></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ matching e.g. a ~? Maybe a</span></span><span>
</span><span id="line-485"></span><span>
</span><span id="line-486"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MARTypeVsConstraint"><span class="annot"><a href="GHC.Core.Unify.html#MARTypeVsConstraint"><span class="hs-identifier hs-var">MARTypeVsConstraint</span></a></span></span><span>  </span><span class="hs-comment">-- ^ matching Type ~? Constraint or the arrow types</span><span>
</span><span id="line-487"></span><span>    </span><span class="hs-comment">-- See Note [Type and Constraint are not apart] in GHC.Builtin.Types.Prim</span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#MaybeApartReason"><span class="hs-identifier hs-type">MaybeApartReason</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-490"></span><span>  </span><span id="local-6989586621681626961"><span class="annot"><span class="annottext">ppr :: MaybeApartReason -&gt; SDoc
</span><a href="#local-6989586621681626961"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARTypeFamily"><span class="hs-identifier hs-var">MARTypeFamily</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;MARTypeFamily&quot;</span></span><span>
</span><span id="line-491"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARInfinite"><span class="hs-identifier hs-var">MARInfinite</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;MARInfinite&quot;</span></span><span>
</span><span id="line-492"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARTypeVsConstraint"><span class="hs-identifier hs-var">MARTypeVsConstraint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;MARTypeVsConstraint&quot;</span></span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681626966"><span id="local-6989586621681626970"><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#Semigroup/GHC.Base.html#Semigroup"><span class="hs-identifier hs-type">Semigroup</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#MaybeApartReason"><span class="hs-identifier hs-type">MaybeApartReason</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-495"></span><span>  </span><span class="hs-comment">-- see end of Note [Unification result] for why</span><span>
</span><span id="line-496"></span><span>  </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARTypeFamily"><span class="hs-identifier hs-var">MARTypeFamily</span></a></span><span>       </span><span id="local-6989586621681626975"><span class="annot"><span class="annottext">&lt;&gt; :: MaybeApartReason -&gt; MaybeApartReason -&gt; MaybeApartReason
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3C%3E/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;&gt;</span></a></span></span><span> </span><span id="local-6989586621681626976"><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681626976"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681626976"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-497"></span><span>  </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARInfinite"><span class="hs-identifier hs-var">MARInfinite</span></a></span><span>         </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#%3C%3E/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARInfinite"><span class="hs-identifier hs-var">MARInfinite</span></a></span><span>
</span><span id="line-498"></span><span>  </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARTypeVsConstraint"><span class="hs-identifier hs-var">MARTypeVsConstraint</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#%3C%3E/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span id="local-6989586621681626977"><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681626977"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681626977"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681626983"><span id="local-6989586621681626987"><span id="local-6989586621681626990"><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#Applicative/GHC.Base.html#Applicative"><span class="hs-identifier hs-type">Applicative</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResultM"><span class="hs-identifier hs-type">UnifyResultM</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-501"></span><span>  </span><span id="local-6989586621681626993"><span class="annot"><span class="annottext">pure :: forall a. a -&gt; UnifyResultM a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var hs-var hs-var hs-var">pure</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; UnifyResultM a
forall a. a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-var">Unifiable</span></a></span><span>
</span><span id="line-502"></span><span>  </span><span id="local-6989586621681626995"><span class="annot"><span class="annottext">&lt;*&gt; :: forall a b.
UnifyResultM (a -&gt; b) -&gt; UnifyResultM a -&gt; UnifyResultM b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3C%2A%3E/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var hs-var hs-var hs-var">(&lt;*&gt;)</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyResultM (a -&gt; b) -&gt; UnifyResultM a -&gt; UnifyResultM b
forall (m :: * -&gt; *) a b. Monad m =&gt; m (a -&gt; b) -&gt; m a -&gt; m b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#ap/GHC.Base.html#ap"><span class="hs-identifier hs-var">ap</span></a></span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681627001"><span id="local-6989586621681627004"><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#Monad/GHC.Base.html#Monad"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResultM"><span class="hs-identifier hs-type">UnifyResultM</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-505"></span><span>  </span><span class="annot"><span class="annottext">UnifyResultM a
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span>  </span><span id="local-6989586621681627008"><span class="annot"><span class="annottext">&gt;&gt;= :: forall a b.
UnifyResultM a -&gt; (a -&gt; UnifyResultM b) -&gt; UnifyResultM b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3E%3E%3D/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var hs-var hs-var hs-var">&gt;&gt;=</span></a></span></span><span> </span><span class="annot"><span class="annottext">a -&gt; UnifyResultM b
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnifyResultM b
forall a. UnifyResultM a
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span>
</span><span id="line-506"></span><span>  </span><span class="annot"><a href="GHC.Core.Unify.html#MaybeApart"><span class="hs-identifier hs-type">MaybeApart</span></a></span><span> </span><span id="local-6989586621681627009"><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627009"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621681627010"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627010"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#%3E%3E%3D/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span id="local-6989586621681627011"><span class="annot"><span class="annottext">a -&gt; UnifyResultM b
</span><a href="#local-6989586621681627011"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">a -&gt; UnifyResultM b
</span><a href="#local-6989586621681627011"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627010"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-507"></span><span>                            </span><span class="annot"><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-type">Unifiable</span></a></span><span> </span><span id="local-6989586621681627012"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681627012"><span class="hs-identifier hs-var">y</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; b -&gt; UnifyResultM b
forall a. MaybeApartReason -&gt; a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#MaybeApart"><span class="hs-identifier hs-var">MaybeApart</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627009"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681627012"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-508"></span><span>                            </span><span class="annot"><a href="GHC.Core.Unify.html#MaybeApart"><span class="hs-identifier hs-type">MaybeApart</span></a></span><span> </span><span id="local-6989586621681627013"><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627013"><span class="hs-identifier hs-var">r2</span></a></span></span><span> </span><span id="local-6989586621681627014"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681627014"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; b -&gt; UnifyResultM b
forall a. MaybeApartReason -&gt; a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#MaybeApart"><span class="hs-identifier hs-var">MaybeApart</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627009"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; MaybeApartReason -&gt; MaybeApartReason
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3C%3E/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">S.&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627013"><span class="hs-identifier hs-var">r2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681627014"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-509"></span><span>                            </span><span class="annot"><span class="annottext">UnifyResultM b
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnifyResultM b
forall a. UnifyResultM a
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span>
</span><span id="line-510"></span><span>  </span><span class="annot"><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-type">Unifiable</span></a></span><span> </span><span id="local-6989586621681627015"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627015"><span class="hs-identifier hs-var">x</span></a></span></span><span>  </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#%3E%3E%3D/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span id="local-6989586621681627016"><span class="annot"><span class="annottext">a -&gt; UnifyResultM b
</span><a href="#local-6989586621681627016"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; UnifyResultM b
</span><a href="#local-6989586621681627016"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627015"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span class="hs-comment">-- | @tcUnifyTysFG bind_tv tys1 tys2@ attempts to find a substitution @s@ (whose</span><span>
</span><span id="line-513"></span><span class="hs-comment">-- domain elements all respond 'BindMe' to @bind_tv@) such that</span><span>
</span><span id="line-514"></span><span class="hs-comment">-- @s(tys1)@ and that of @s(tys2)@ are equal, as witnessed by the returned</span><span>
</span><span id="line-515"></span><span class="hs-comment">-- Coercions. This version requires that the kinds of the types are the same,</span><span>
</span><span id="line-516"></span><span class="hs-comment">-- if you unify left-to-right.</span><span>
</span><span id="line-517"></span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTysFG"><span class="hs-identifier hs-type">tcUnifyTysFG</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-type">BindFun</span></a></span><span>
</span><span id="line-518"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-519"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResult"><span class="hs-identifier hs-type">UnifyResult</span></a></span><span>
</span><span id="line-520"></span><span id="tcUnifyTysFG"><span class="annot"><span class="annottext">tcUnifyTysFG :: BindFun -&gt; [Type] -&gt; [Type] -&gt; UnifyResult
</span><a href="GHC.Core.Unify.html#tcUnifyTysFG"><span class="hs-identifier hs-var hs-var">tcUnifyTysFG</span></a></span></span><span> </span><span id="local-6989586621681627017"><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681627017"><span class="hs-identifier hs-var">bind_fn</span></a></span></span><span> </span><span id="local-6989586621681627018"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627018"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681627019"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627019"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-521"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; BindFun -&gt; [Type] -&gt; [Type] -&gt; UnifyResult
</span><a href="GHC.Core.Unify.html#tc_unify_tys_fg"><span class="hs-identifier hs-var">tc_unify_tys_fg</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681627017"><span class="hs-identifier hs-var">bind_fn</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627018"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627019"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTyKisFG"><span class="hs-identifier hs-type">tcUnifyTyKisFG</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-type">BindFun</span></a></span><span>
</span><span id="line-524"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-525"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResult"><span class="hs-identifier hs-type">UnifyResult</span></a></span><span>
</span><span id="line-526"></span><span id="tcUnifyTyKisFG"><span class="annot"><span class="annottext">tcUnifyTyKisFG :: BindFun -&gt; [Type] -&gt; [Type] -&gt; UnifyResult
</span><a href="GHC.Core.Unify.html#tcUnifyTyKisFG"><span class="hs-identifier hs-var hs-var">tcUnifyTyKisFG</span></a></span></span><span> </span><span id="local-6989586621681627021"><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681627021"><span class="hs-identifier hs-var">bind_fn</span></a></span></span><span> </span><span id="local-6989586621681627022"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627022"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681627023"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627023"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-527"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; BindFun -&gt; [Type] -&gt; [Type] -&gt; UnifyResult
</span><a href="GHC.Core.Unify.html#tc_unify_tys_fg"><span class="hs-identifier hs-var">tc_unify_tys_fg</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681627021"><span class="hs-identifier hs-var">bind_fn</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627022"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627023"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span class="annot"><a href="GHC.Core.Unify.html#tc_unify_tys_fg"><span class="hs-identifier hs-type">tc_unify_tys_fg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-530"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-type">BindFun</span></a></span><span>
</span><span id="line-531"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-532"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResult"><span class="hs-identifier hs-type">UnifyResult</span></a></span><span>
</span><span id="line-533"></span><span id="tc_unify_tys_fg"><span class="annot"><span class="annottext">tc_unify_tys_fg :: Bool -&gt; BindFun -&gt; [Type] -&gt; [Type] -&gt; UnifyResult
</span><a href="GHC.Core.Unify.html#tc_unify_tys_fg"><span class="hs-identifier hs-var hs-var">tc_unify_tys_fg</span></a></span></span><span> </span><span id="local-6989586621681627024"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681627024"><span class="hs-identifier hs-var">match_kis</span></a></span></span><span> </span><span id="local-6989586621681627025"><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681627025"><span class="hs-identifier hs-var">bind_fn</span></a></span></span><span> </span><span id="local-6989586621681627026"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627026"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681627027"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627027"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-534"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627028"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627028"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BindFun
-&gt; Bool
-&gt; Bool
-&gt; Bool
-&gt; RnEnv2
-&gt; TvSubstEnv
-&gt; CvSubstEnv
-&gt; [Type]
-&gt; [Type]
-&gt; UnifyResultM (TvSubstEnv, CvSubstEnv)
</span><a href="GHC.Core.Unify.html#tc_unify_tys"><span class="hs-identifier hs-var">tc_unify_tys</span></a></span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681627025"><span class="hs-identifier hs-var">bind_fn</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681627024"><span class="hs-identifier hs-var">match_kis</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621681627029"><span class="hs-identifier hs-var">rn_env</span></a></span><span>
</span><span id="line-535"></span><span>                                  </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="GHC.Core.TyCo.Subst.html#emptyTvSubstEnv"><span class="hs-identifier hs-var">emptyTvSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="GHC.Core.TyCo.Subst.html#emptyCvSubstEnv"><span class="hs-identifier hs-var">emptyCvSubstEnv</span></a></span><span>
</span><span id="line-536"></span><span>                                  </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627026"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627027"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-537"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; UnifyResult
forall a. a -&gt; UnifyResultM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; UnifyResult) -&gt; Subst -&gt; UnifyResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TvSubstEnv -&gt; Subst
</span><a href="GHC.Core.Unify.html#niFixSubst"><span class="hs-identifier hs-var">niFixSubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627030"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627028"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-538"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-539"></span><span>    </span><span id="local-6989586621681627030"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621681627030"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; InScopeSet) -&gt; VarSet -&gt; InScopeSet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627026"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627027"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-540"></span><span>    </span><span id="local-6989586621681627029"><span class="annot"><span class="annottext">rn_env :: RnEnv2
</span><a href="#local-6989586621681627029"><span class="hs-identifier hs-var hs-var">rn_env</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; RnEnv2
</span><a href="GHC.Types.Var.Env.html#mkRnEnv2"><span class="hs-identifier hs-var">mkRnEnv2</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627030"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-541"></span><span>
</span><span id="line-542"></span><span class="hs-comment">-- | This function is actually the one to call the unifier -- a little</span><span>
</span><span id="line-543"></span><span class="hs-comment">-- too general for outside clients, though.</span><span>
</span><span id="line-544"></span><span class="annot"><a href="GHC.Core.Unify.html#tc_unify_tys"><span class="hs-identifier hs-type">tc_unify_tys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-type">BindFun</span></a></span><span>
</span><span id="line-545"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#AmIUnifying"><span class="hs-identifier hs-type">AmIUnifying</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ True &lt;=&gt; unify; False &lt;=&gt; match</span></span><span>
</span><span id="line-546"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>        </span><span class="annot"><span class="hs-comment">-- ^ True &lt;=&gt; doing an injectivity check</span></span><span>
</span><span id="line-547"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>        </span><span class="annot"><span class="hs-comment">-- ^ True &lt;=&gt; treat the kinds as well</span></span><span>
</span><span id="line-548"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a></span><span>
</span><span id="line-549"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ substitution to extend</span></span><span>
</span><span id="line-550"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#CvSubstEnv"><span class="hs-identifier hs-type">CvSubstEnv</span></a></span><span>
</span><span id="line-551"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-552"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResultM"><span class="hs-identifier hs-type">UnifyResultM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#CvSubstEnv"><span class="hs-identifier hs-type">CvSubstEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span class="hs-comment">-- NB: It's tempting to ASSERT here that, if we're not matching kinds, then</span><span>
</span><span id="line-554"></span><span class="hs-comment">-- the kinds of the types should be the same. However, this doesn't work,</span><span>
</span><span id="line-555"></span><span class="hs-comment">-- as the types may be a dependent telescope, where later types have kinds</span><span>
</span><span id="line-556"></span><span class="hs-comment">-- that mention variables occurring earlier in the list of types. Here's an</span><span>
</span><span id="line-557"></span><span class="hs-comment">-- example (from typecheck/should_fail/T12709):</span><span>
</span><span id="line-558"></span><span class="hs-comment">--   template: [rep :: RuntimeRep,       a :: TYPE rep]</span><span>
</span><span id="line-559"></span><span class="hs-comment">--   target:   [LiftedRep :: RuntimeRep, Int :: TYPE LiftedRep]</span><span>
</span><span id="line-560"></span><span class="hs-comment">-- We can see that matching the first pair will make the kinds of the second</span><span>
</span><span id="line-561"></span><span class="hs-comment">-- pair equal. Yet, we still don't need a separate pass to unify the kinds</span><span>
</span><span id="line-562"></span><span class="hs-comment">-- of these types, so it's appropriate to use the Ty variant of unification.</span><span>
</span><span id="line-563"></span><span class="hs-comment">-- See also Note [tcMatchTy vs tcMatchTyKi].</span><span>
</span><span id="line-564"></span><span id="tc_unify_tys"><span class="annot"><span class="annottext">tc_unify_tys :: BindFun
-&gt; Bool
-&gt; Bool
-&gt; Bool
-&gt; RnEnv2
-&gt; TvSubstEnv
-&gt; CvSubstEnv
-&gt; [Type]
-&gt; [Type]
-&gt; UnifyResultM (TvSubstEnv, CvSubstEnv)
</span><a href="GHC.Core.Unify.html#tc_unify_tys"><span class="hs-identifier hs-var hs-var">tc_unify_tys</span></a></span></span><span> </span><span id="local-6989586621681627032"><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681627032"><span class="hs-identifier hs-var">bind_fn</span></a></span></span><span> </span><span id="local-6989586621681627033"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681627033"><span class="hs-identifier hs-var">unif</span></a></span></span><span> </span><span id="local-6989586621681627034"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681627034"><span class="hs-identifier hs-var">inj_check</span></a></span></span><span> </span><span id="local-6989586621681627035"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681627035"><span class="hs-identifier hs-var">match_kis</span></a></span></span><span> </span><span id="local-6989586621681627036"><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621681627036"><span class="hs-identifier hs-var">rn_env</span></a></span></span><span> </span><span id="local-6989586621681627037"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627037"><span class="hs-identifier hs-var">tv_env</span></a></span></span><span> </span><span id="local-6989586621681627038"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627038"><span class="hs-identifier hs-var">cv_env</span></a></span></span><span> </span><span id="local-6989586621681627039"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627039"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681627040"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627040"><span class="hs-identifier hs-var">tys2</span></a></span></span><span>
</span><span id="line-565"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
-&gt; CvSubstEnv
-&gt; UM (TvSubstEnv, CvSubstEnv)
-&gt; UnifyResultM (TvSubstEnv, CvSubstEnv)
forall a. TvSubstEnv -&gt; CvSubstEnv -&gt; UM a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#initUM"><span class="hs-identifier hs-var">initUM</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627037"><span class="hs-identifier hs-var">tv_env</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627038"><span class="hs-identifier hs-var">cv_env</span></a></span><span> </span><span class="annot"><span class="annottext">(UM (TvSubstEnv, CvSubstEnv)
 -&gt; UnifyResultM (TvSubstEnv, CvSubstEnv))
-&gt; UM (TvSubstEnv, CvSubstEnv)
-&gt; UnifyResultM (TvSubstEnv, CvSubstEnv)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-566"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UM () -&gt; UM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#when/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681627035"><span class="hs-identifier hs-var">match_kis</span></a></span><span> </span><span class="annot"><span class="annottext">(UM () -&gt; UM ()) -&gt; UM () -&gt; UM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-567"></span><span>         </span><span class="annot"><span class="annottext">UMEnv -&gt; [Type] -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_tys"><span class="hs-identifier hs-var">unify_tys</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627044"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627045"><span class="hs-identifier hs-var">kis1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627046"><span class="hs-identifier hs-var">kis2</span></a></span><span>
</span><span id="line-568"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; [Type] -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_tys"><span class="hs-identifier hs-var">unify_tys</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627044"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627039"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627040"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-569"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TvSubstEnv -&gt; CvSubstEnv -&gt; (TvSubstEnv, CvSubstEnv))
-&gt; UM TvSubstEnv -&gt; UM (CvSubstEnv -&gt; (TvSubstEnv, CvSubstEnv))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UM TvSubstEnv
</span><a href="GHC.Core.Unify.html#getTvSubstEnv"><span class="hs-identifier hs-var">getTvSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">UM (CvSubstEnv -&gt; (TvSubstEnv, CvSubstEnv))
-&gt; UM CvSubstEnv -&gt; UM (TvSubstEnv, CvSubstEnv)
forall a b. UM (a -&gt; b) -&gt; UM a -&gt; UM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3C%2A%3E/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UM CvSubstEnv
</span><a href="GHC.Core.Unify.html#getCvSubstEnv"><span class="hs-identifier hs-var">getCvSubstEnv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-570"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-571"></span><span>    </span><span id="local-6989586621681627044"><span class="annot"><span class="annottext">env :: UMEnv
</span><a href="#local-6989586621681627044"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">um_bind_fun :: BindFun
</span><a href="GHC.Core.Unify.html#um_bind_fun"><span class="hs-identifier hs-var">um_bind_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFun
</span><a href="#local-6989586621681627032"><span class="hs-identifier hs-var">bind_fn</span></a></span><span>
</span><span id="line-572"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">um_skols :: VarSet
</span><a href="GHC.Core.Unify.html#um_skols"><span class="hs-identifier hs-var">um_skols</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span>
</span><span id="line-573"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">um_unif :: Bool
</span><a href="GHC.Core.Unify.html#um_unif"><span class="hs-identifier hs-var">um_unif</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681627033"><span class="hs-identifier hs-var">unif</span></a></span><span>
</span><span id="line-574"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">um_inj_tf :: Bool
</span><a href="GHC.Core.Unify.html#um_inj_tf"><span class="hs-identifier hs-var">um_inj_tf</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681627034"><span class="hs-identifier hs-var">inj_check</span></a></span><span>
</span><span id="line-575"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">um_rn_env :: RnEnv2
</span><a href="GHC.Core.Unify.html#um_rn_env"><span class="hs-identifier hs-var">um_rn_env</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621681627036"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-576"></span><span>
</span><span id="line-577"></span><span>    </span><span id="local-6989586621681627045"><span class="annot"><span class="annottext">kis1 :: [Type]
</span><a href="#local-6989586621681627045"><span class="hs-identifier hs-var hs-var">kis1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627039"><span class="hs-identifier hs-var">tys1</span></a></span><span>
</span><span id="line-578"></span><span>    </span><span id="local-6989586621681627046"><span class="annot"><span class="annottext">kis2 :: [Type]
</span><a href="#local-6989586621681627046"><span class="hs-identifier hs-var hs-var">kis2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627040"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681626602"><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681626602"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResultM"><span class="hs-identifier hs-type">UnifyResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681626602"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-581"></span><span>  </span><span id="local-6989586621681627070"><span class="annot"><span class="annottext">ppr :: UnifyResultM a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">UnifyResultM a
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SurelyApart&quot;</span></span><span>
</span><span id="line-582"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-type">Unifiable</span></a></span><span> </span><span id="local-6989586621681627071"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627071"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unifiable&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627071"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-583"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#MaybeApart"><span class="hs-identifier hs-type">MaybeApart</span></a></span><span> </span><span id="local-6989586621681627073"><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627073"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621681627074"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627074"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;MaybeApart&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627073"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627074"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-584"></span><span>
</span><span id="line-585"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Non-idempotent substitution
*                                                                      *
************************************************************************

Note [Non-idempotent substitution]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
During unification we use a TvSubstEnv/CvSubstEnv pair that is
  (a) non-idempotent
  (b) loop-free; ie repeatedly applying it yields a fixed point

Note [Finding the substitution fixpoint]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Finding the fixpoint of a non-idempotent substitution arising from a
unification is much trickier than it looks, because of kinds.  Consider
   T k (H k (f:k)) ~ T * (g:*)
If we unify, we get the substitution
   [ k -&gt; *
   , g -&gt; H k (f:k) ]
To make it idempotent we don't want to get just
   [ k -&gt; *
   , g -&gt; H * (f:k) ]
We also want to substitute inside f's kind, to get
   [ k -&gt; *
   , g -&gt; H k (f:*) ]
If we don't do this, we may apply the substitution to something,
and get an ill-formed type, i.e. one where typeKind will fail.
This happened, for example, in #9106.

It gets worse.  In #14164 we wanted to take the fixpoint of
this substitution
   [ xs_asV :-&gt; F a_aY6 (z_aY7 :: a_aY6)
                        (rest_aWF :: G a_aY6 (z_aY7 :: a_aY6))
   , a_aY6  :-&gt; a_aXQ ]

We have to apply the substitution for a_aY6 two levels deep inside
the invocation of F!  We don't have a function that recursively
applies substitutions inside the kinds of variable occurrences (and
probably rightly so).

So, we work as follows:

 1. Start with the current substitution (which we are
    trying to fixpoint
       [ xs :-&gt; F a (z :: a) (rest :: G a (z :: a))
       , a  :-&gt; b ]

 2. Take all the free vars of the range of the substitution:
       {a, z, rest, b}
    NB: the free variable finder closes over
    the kinds of variable occurrences

 3. If none are in the domain of the substitution, stop.
    We have found a fixpoint.

 4. Remove the variables that are bound by the substitution, leaving
       {z, rest, b}

 5. Do a topo-sort to put them in dependency order:
       [ b :: *, z :: a, rest :: G a z ]

 6. Apply the substitution left-to-right to the kinds of these
    tyvars, extending it each time with a new binding, so we
    finish up with
       [ xs   :-&gt; ..as before..
       , a    :-&gt; b
       , b    :-&gt; b    :: *
       , z    :-&gt; z    :: b
       , rest :-&gt; rest :: G b (z :: b) ]
    Note that rest now has the right kind

 7. Apply this extended substitution (once) to the range of
    the /original/ substitution.  (Note that we do the
    extended substitution would go on forever if you tried
    to find its fixpoint, because it maps z to z.)

 8. And go back to step 1

In Step 6 we use the free vars from Step 2 as the initial
in-scope set, because all of those variables appear in the
range of the substitution, so they must all be in the in-scope
set.  But NB that the type substitution engine does not look up
variables in the in-scope set; it is used only to ensure no
shadowing.
-}</span><span>
</span><span id="line-672"></span><span>
</span><span id="line-673"></span><span class="annot"><a href="GHC.Core.Unify.html#niFixSubst"><span class="hs-identifier hs-type">niFixSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-674"></span><span class="hs-comment">-- Find the idempotent fixed point of the non-idempotent substitution</span><span>
</span><span id="line-675"></span><span class="hs-comment">-- This is surprisingly tricky:</span><span>
</span><span id="line-676"></span><span class="hs-comment">--   see Note [Finding the substitution fixpoint]</span><span>
</span><span id="line-677"></span><span class="hs-comment">-- ToDo: use laziness instead of iteration?</span><span>
</span><span id="line-678"></span><span id="niFixSubst"><span class="annot"><span class="annottext">niFixSubst :: InScopeSet -&gt; TvSubstEnv -&gt; Subst
</span><a href="GHC.Core.Unify.html#niFixSubst"><span class="hs-identifier hs-var hs-var">niFixSubst</span></a></span></span><span> </span><span id="local-6989586621681627075"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627075"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621681627076"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627076"><span class="hs-identifier hs-var">tenv</span></a></span></span><span>
</span><span id="line-679"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681627077"><span class="hs-identifier hs-var">not_fixpoint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; TvSubstEnv -&gt; Subst
</span><a href="GHC.Core.Unify.html#niFixSubst"><span class="hs-identifier hs-var">niFixSubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627075"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; TvSubstEnv -&gt; TvSubstEnv
forall a b. (a -&gt; b) -&gt; VarEnv a -&gt; VarEnv b
</span><a href="GHC.Types.Var.Env.html#mapVarEnv"><span class="hs-identifier hs-var">mapVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; Type -&gt; Type
Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681627080"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627076"><span class="hs-identifier hs-var">tenv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-680"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681627080"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-681"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-682"></span><span>    </span><span class="annot"><a href="#local-6989586621681627081"><span class="hs-identifier hs-type">range_fvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.FV.html#FV"><span class="hs-identifier hs-type">FV</span></a></span><span>
</span><span id="line-683"></span><span>    </span><span id="local-6989586621681627081"><span class="annot"><span class="annottext">range_fvs :: FV
</span><a href="#local-6989586621681627081"><span class="hs-identifier hs-var hs-var">range_fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; FV
</span><a href="GHC.Core.TyCo.FVs.html#tyCoFVsOfTypes"><span class="hs-identifier hs-var">tyCoFVsOfTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TvSubstEnv -&gt; [Type]
forall key elt. UniqFM key elt -&gt; [elt]
</span><a href="GHC.Types.Unique.FM.html#nonDetEltsUFM"><span class="hs-identifier hs-var">nonDetEltsUFM</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627076"><span class="hs-identifier hs-var">tenv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-684"></span><span>          </span><span class="hs-comment">-- It's OK to use nonDetEltsUFM here because the</span><span>
</span><span id="line-685"></span><span>          </span><span class="hs-comment">-- order of range_fvs, range_tvs is immaterial</span><span>
</span><span id="line-686"></span><span>
</span><span id="line-687"></span><span>    </span><span class="annot"><a href="#local-6989586621681627083"><span class="hs-identifier hs-type">range_tvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-688"></span><span>    </span><span id="local-6989586621681627083"><span class="annot"><span class="annottext">range_tvs :: [OutTyVar]
</span><a href="#local-6989586621681627083"><span class="hs-identifier hs-var hs-var">range_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FV -&gt; [OutTyVar]
</span><a href="GHC.Utils.FV.html#fvVarList"><span class="hs-identifier hs-var">fvVarList</span></a></span><span> </span><span class="annot"><span class="annottext">FV
</span><a href="#local-6989586621681627081"><span class="hs-identifier hs-var">range_fvs</span></a></span><span>
</span><span id="line-689"></span><span>
</span><span id="line-690"></span><span>    </span><span id="local-6989586621681627077"><span class="annot"><span class="annottext">not_fixpoint :: Bool
</span><a href="#local-6989586621681627077"><span class="hs-identifier hs-var hs-var">not_fixpoint</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutTyVar -&gt; Bool) -&gt; [OutTyVar] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#any/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; Bool
</span><a href="#local-6989586621681627084"><span class="hs-identifier hs-var">in_domain</span></a></span><span> </span><span class="annot"><span class="annottext">[OutTyVar]
</span><a href="#local-6989586621681627083"><span class="hs-identifier hs-var">range_tvs</span></a></span><span>
</span><span id="line-691"></span><span>    </span><span id="local-6989586621681627084"><span class="annot"><span class="annottext">in_domain :: OutTyVar -&gt; Bool
</span><a href="#local-6989586621681627084"><span class="hs-identifier hs-var hs-var">in_domain</span></a></span></span><span> </span><span id="local-6989586621681627085"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627085"><span class="hs-identifier hs-var">tv</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627085"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; TvSubstEnv -&gt; Bool
forall a. OutTyVar -&gt; VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemVarEnv"><span class="hs-operator hs-var">`elemVarEnv`</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627076"><span class="hs-identifier hs-var">tenv</span></a></span><span>
</span><span id="line-692"></span><span>
</span><span id="line-693"></span><span>    </span><span id="local-6989586621681627087"><span class="annot"><span class="annottext">free_tvs :: [OutTyVar]
</span><a href="#local-6989586621681627087"><span class="hs-identifier hs-var hs-var">free_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OutTyVar] -&gt; [OutTyVar]
</span><a href="GHC.Core.TyCo.FVs.html#scopedSort"><span class="hs-identifier hs-var">scopedSort</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(OutTyVar -&gt; Bool) -&gt; [OutTyVar] -&gt; [OutTyVar]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; Bool
</span><a href="#local-6989586621681627084"><span class="hs-identifier hs-var">in_domain</span></a></span><span> </span><span class="annot"><span class="annottext">[OutTyVar]
</span><a href="#local-6989586621681627083"><span class="hs-identifier hs-var">range_tvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-694"></span><span>
</span><span id="line-695"></span><span>    </span><span class="hs-comment">-- See Note [Finding the substitution fixpoint], Step 6</span><span>
</span><span id="line-696"></span><span>    </span><span id="local-6989586621681627080"><span class="annot"><span class="annottext">subst :: Subst
</span><a href="#local-6989586621681627080"><span class="hs-identifier hs-var hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; OutTyVar -&gt; Subst) -&gt; Subst -&gt; [OutTyVar] -&gt; Subst
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldl%27/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; OutTyVar -&gt; Subst
</span><a href="#local-6989586621681627091"><span class="hs-identifier hs-var">add_free_tv</span></a></span><span>
</span><span id="line-697"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; TvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkTvSubst"><span class="hs-identifier hs-var">mkTvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627075"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627076"><span class="hs-identifier hs-var">tenv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-698"></span><span>                  </span><span class="annot"><span class="annottext">[OutTyVar]
</span><a href="#local-6989586621681627087"><span class="hs-identifier hs-var">free_tvs</span></a></span><span>
</span><span id="line-699"></span><span>
</span><span id="line-700"></span><span>    </span><span class="annot"><a href="#local-6989586621681627091"><span class="hs-identifier hs-type">add_free_tv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-701"></span><span>    </span><span id="local-6989586621681627091"><span class="annot"><span class="annottext">add_free_tv :: Subst -&gt; OutTyVar -&gt; Subst
</span><a href="#local-6989586621681627091"><span class="hs-identifier hs-var hs-var">add_free_tv</span></a></span></span><span> </span><span id="local-6989586621681627092"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681627092"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681627093"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627093"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-702"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; OutTyVar -&gt; Type -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681627092"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627093"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627096"><span class="hs-identifier hs-var">tv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-703"></span><span>     </span><span class="hs-keyword">where</span><span>
</span><span id="line-704"></span><span>        </span><span id="local-6989586621681627096"><span class="annot"><span class="annottext">tv' :: OutTyVar
</span><a href="#local-6989586621681627096"><span class="hs-identifier hs-var hs-var">tv'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; OutTyVar -&gt; OutTyVar
</span><a href="GHC.Types.Var.html#updateTyVarKind"><span class="hs-identifier hs-var">updateTyVarKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; Type -&gt; Type
Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681627092"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627093"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-705"></span><span>
</span><span id="line-706"></span><span class="annot"><a href="GHC.Core.Unify.html#niSubstTvSet"><span class="hs-identifier hs-type">niSubstTvSet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a></span><span>
</span><span id="line-707"></span><span class="hs-comment">-- Apply the non-idempotent substitution to a set of type variables,</span><span>
</span><span id="line-708"></span><span class="hs-comment">-- remembering that the substitution isn't necessarily idempotent</span><span>
</span><span id="line-709"></span><span class="hs-comment">-- This is used in the occurs check, before extending the substitution</span><span>
</span><span id="line-710"></span><span id="niSubstTvSet"><span class="annot"><span class="annottext">niSubstTvSet :: TvSubstEnv -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Core.Unify.html#niSubstTvSet"><span class="hs-identifier hs-var hs-var">niSubstTvSet</span></a></span></span><span> </span><span id="local-6989586621681627099"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627099"><span class="hs-identifier hs-var">tsubst</span></a></span></span><span> </span><span id="local-6989586621681627100"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627100"><span class="hs-identifier hs-var">tvs</span></a></span></span><span>
</span><span id="line-711"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutTyVar -&gt; VarSet -&gt; VarSet) -&gt; VarSet -&gt; VarSet -&gt; VarSet
forall elt a. (elt -&gt; a -&gt; a) -&gt; a -&gt; UniqSet elt -&gt; a
</span><a href="GHC.Types.Unique.Set.html#nonDetStrictFoldUniqSet"><span class="hs-identifier hs-var">nonDetStrictFoldUniqSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; VarSet -&gt; VarSet)
-&gt; (OutTyVar -&gt; VarSet) -&gt; OutTyVar -&gt; VarSet -&gt; VarSet
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; VarSet
</span><a href="#local-6989586621681627103"><span class="hs-identifier hs-var">get</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627100"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-712"></span><span>  </span><span class="hs-comment">-- It's OK to use a non-deterministic fold here because we immediately forget</span><span>
</span><span id="line-713"></span><span>  </span><span class="hs-comment">-- the ordering by creating a set.</span><span>
</span><span id="line-714"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-715"></span><span>    </span><span id="local-6989586621681627103"><span class="annot"><span class="annottext">get :: OutTyVar -&gt; VarSet
</span><a href="#local-6989586621681627103"><span class="hs-identifier hs-var hs-var">get</span></a></span></span><span> </span><span id="local-6989586621681627104"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627104"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-716"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681627105"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627105"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; OutTyVar -&gt; Maybe Type
forall a. VarEnv a -&gt; OutTyVar -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627099"><span class="hs-identifier hs-var">tsubst</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627104"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-717"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Core.Unify.html#niSubstTvSet"><span class="hs-identifier hs-var">niSubstTvSet</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627099"><span class="hs-identifier hs-var">tsubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627105"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-718"></span><span>
</span><span id="line-719"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-720"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unitVarSet"><span class="hs-identifier hs-var">unitVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627104"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-721"></span><span>
</span><span id="line-722"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                unify_ty: the main workhorse
*                                                                      *
************************************************************************

Note [Specification of unification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The pure unifier, unify_ty, defined in this module, tries to work out
a substitution to make two types say True to eqType. NB: eqType is
itself not purely syntactic; it accounts for CastTys;
see Note [Non-trivial definitional equality] in GHC.Core.TyCo.Rep

Unlike the &quot;impure unifiers&quot; in the typechecker (the eager unifier in
GHC.Tc.Utils.Unify, and the constraint solver itself in GHC.Tc.Solver.Canonical), the pure
unifier does /not/ work up to ~.

The algorithm implemented here is rather delicate, and we depend on it
to uphold certain properties. This is a summary of these required
properties.

Notation:
 &#952;,&#966;  substitutions
 &#958;    type-function-free types
 &#964;,&#963;  other types
 &#964;&#9837;   type &#964;, flattened

 &#8801;    eqType

(U1) Soundness.
     If (unify &#964;&#8321; &#964;&#8322;) = Unifiable &#952;, then &#952;(&#964;&#8321;) &#8801; &#952;(&#964;&#8322;).
     &#952; is a most general unifier for &#964;&#8321; and &#964;&#8322;.

(U2) Completeness.
     If (unify &#958;&#8321; &#958;&#8322;) = SurelyApart,
     then there exists no substitution &#952; such that &#952;(&#958;&#8321;) &#8801; &#952;(&#958;&#8322;).

These two properties are stated as Property 11 in the &quot;Closed Type Families&quot;
paper (POPL'14). Below, this paper is called [CTF].

(U3) Apartness under substitution.
     If (unify &#958; &#964;&#9837;) = SurelyApart, then (unify &#958; &#952;(&#964;)&#9837;) = SurelyApart,
     for any &#952;. (Property 12 from [CTF])

(U4) Apart types do not unify.
     If (unify &#958; &#964;&#9837;) = SurelyApart, then there exists no &#952;
     such that &#952;(&#958;) = &#952;(&#964;). (Property 13 from [CTF])

THEOREM. Completeness w.r.t ~
    If (unify &#964;&#8321;&#9837; &#964;&#8322;&#9837;) = SurelyApart,
    then there exists no proof that (&#964;&#8321; ~ &#964;&#8322;).

PROOF. See appendix of [CTF].


The unification algorithm is used for type family injectivity, as described
in the &quot;Injective Type Families&quot; paper (Haskell'15), called [ITF]. When run
in this mode, it has the following properties.

(I1) If (unify &#963; &#964;) = SurelyApart, then &#963; and &#964; are not unifiable, even
     after arbitrary type family reductions. Note that &#963; and &#964; are
     not flattened here.

(I2) If (unify &#963; &#964;) = MaybeApart &#952;, and if some
     &#966; exists such that &#966;(&#963;) ~ &#966;(&#964;), then &#966; extends &#952;.


Furthermore, the RULES matching algorithm requires this property,
but only when using this algorithm for matching:

(M1) If (match &#963; &#964;) succeeds with &#952;, then all matchable tyvars
     in &#963; are bound in &#952;.

     Property M1 means that we must extend the substitution with,
     say (a &#8614; a) when appropriate during matching.
     See also Note [Self-substitution when matching].

(M2) Completeness of matching.
     If &#952;(&#963;) = &#964;, then (match &#963; &#964;) = Unifiable &#966;,
     where &#952; is an extension of &#966;.

Sadly, property M2 and I2 conflict. Consider

type family F1 a b where
  F1 Int    Bool   = Char
  F1 Double String = Char

Consider now two matching problems:

P1. match (F1 a Bool) (F1 Int Bool)
P2. match (F1 a Bool) (F1 Double String)

In case P1, we must find (a &#8614; Int) to satisfy M2.
In case P2, we must /not/ find (a &#8614; Double), in order to satisfy I2. (Note
that the correct mapping for I2 is (a &#8614; Int). There is no way to discover
this, but we mustn't map a to anything else!)

We thus must parameterize the algorithm over whether it's being used
for an injectivity check (refrain from looking at non-injective arguments
to type families) or not (do indeed look at those arguments).  This is
implemented  by the um_inj_tf field of UMEnv.

(It's all a question of whether or not to include equation (7) from Fig. 2
of [ITF].)

This extra parameter is a bit fiddly, perhaps, but seemingly less so than
having two separate, almost-identical algorithms.

Note [Self-substitution when matching]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
What should happen when we're *matching* (not unifying) a1 with a1? We
should get a substitution [a1 |-&gt; a1]. A successful match should map all
the template variables (except ones that disappear when expanding synonyms).
But when unifying, we don't want to do this, because we'll then fall into
a loop.

This arrangement affects the code in three places:
 - If we're matching a refined template variable, don't recur. Instead, just
   check for equality. That is, if we know [a |-&gt; Maybe a] and are matching
   (a ~? Maybe Int), we want to just fail.

 - Skip the occurs check when matching. This comes up in two places, because
   matching against variables is handled separately from matching against
   full-on types.

Note that this arrangement was provoked by a real failure, where the same
unique ended up in the template as in the target. (It was a rule firing when
compiling Data.List.NonEmpty.)

Note [Matching coercion variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this:

   type family F a

   data G a where
     MkG :: F a ~ Bool =&gt; G a

   type family Foo (x :: G a) :: F a
   type instance Foo MkG = False

We would like that to be accepted. For that to work, we need to introduce
a coercion variable on the left and then use it on the right. Accordingly,
at use sites of Foo, we need to be able to use matching to figure out the
value for the coercion. (See the desugared version:

   axFoo :: [a :: *, c :: F a ~ Bool]. Foo (MkG c) = False |&gt; (sym c)

) We never want this action to happen during *unification* though, when
all bets are off.

Note [Kind coercions in Unify]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We wish to match/unify while ignoring casts. But, we can't just ignore
them completely, or we'll end up with ill-kinded substitutions. For example,
say we're matching `a` with `ty |&gt; co`. If we just drop the cast, we'll
return [a |-&gt; ty], but `a` and `ty` might have different kinds. We can't
just match/unify their kinds, either, because this might gratuitously
fail. After all, `co` is the witness that the kinds are the same -- they
may look nothing alike.

So, we pass a kind coercion to the match/unify worker. This coercion witnesses
the equality between the substed kind of the left-hand type and the substed
kind of the right-hand type. Note that we do not unify kinds at the leaves
(as we did previously). We thus have

Hence: (Unification Kind Invariant)
-----------------------------------
In the call
     unify_ty ty1 ty2 kco
it must be that
     subst(kco) :: subst(kind(ty1)) ~N subst(kind(ty2))
where `subst` is the ambient substitution in the UM monad.  And in the call
     unify_tys tys1 tys2
(which has no kco), after we unify any prefix of tys1,tys2, the kinds of the
head of the remaining tys1,tys2 are identical after substitution.  This
implies, for example, that the kinds of the head of tys1,tys2 are identical
after substitution.

To get this coercion, we first have to match/unify
the kinds before looking at the types. Happily, we need look only one level
up, as all kinds are guaranteed to have kind *.

When we're working with type applications (either TyConApp or AppTy) we
need to worry about establishing INVARIANT, as the kinds of the function
&amp; arguments aren't (necessarily) included in the kind of the result.
When unifying two TyConApps, this is easy, because the two TyCons are
the same. Their kinds are thus the same. As long as we unify left-to-right,
we'll be sure to unify types' kinds before the types themselves. (For example,
think about Proxy :: forall k. k -&gt; *. Unifying the first args matches up
the kinds of the second args.)

For AppTy, we must unify the kinds of the functions, but once these are
unified, we can continue unifying arguments without worrying further about
kinds.

The interface to this module includes both &quot;...Ty&quot; functions and
&quot;...TyKi&quot; functions. The former assume that INVARIANT is already
established, either because the kinds are the same or because the
list of types being passed in are the well-typed arguments to some
type constructor (see two paragraphs above). The latter take a separate
pre-pass over the kinds to establish INVARIANT. Sometimes, it's important
not to take the second pass, as it caused #12442.

We thought, at one point, that this was all unnecessary: why should
casts be in types in the first place? But they are sometimes. In
dependent/should_compile/KindEqualities2, we see, for example the
constraint Num (Int |&gt; (blah ; sym blah)).  We naturally want to find
a dictionary for that constraint, which requires dealing with
coercions in this manner.

Note [Matching in the presence of casts (1)]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When matching, it is crucial that no variables from the template
end up in the range of the matching substitution (obviously!).
When unifying, that's not a constraint; instead we take the fixpoint
of the substitution at the end.

So what should we do with this, when matching?
   unify_ty (tmpl |&gt; co) tgt kco

Previously, wrongly, we pushed 'co' in the (horrid) accumulating
'kco' argument like this:
   unify_ty (tmpl |&gt; co) tgt kco
     = unify_ty tmpl tgt (kco ; co)

But that is obviously wrong because 'co' (from the template) ends
up in 'kco', which in turn ends up in the range of the substitution.

This all came up in #13910.  Because we match tycon arguments
left-to-right, the ambient substitution will already have a matching
substitution for any kinds; so there is an easy fix: just apply
the substitution-so-far to the coercion from the LHS.

Note that

* When matching, the first arg of unify_ty is always the template;
  we never swap round.

* The above argument is distressingly indirect. We seek a
  better way.

* One better way is to ensure that type patterns (the template
  in the matching process) have no casts.  See #14119.

Note [Matching in the presence of casts (2)]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There is another wrinkle (#17395).  Suppose (T :: forall k. k -&gt; Type)
and we are matching
   tcMatchTy (T k (a::k))  (T j (b::j))

Then we'll match k :-&gt; j, as expected. But then in unify_tys
we invoke
   unify_tys env (a::k) (b::j) (Refl j)

Although we have unified k and j, it's very important that we put
(Refl j), /not/ (Refl k) as the fourth argument to unify_tys.
If we put (Refl k) we'd end up with the substitution
  a :-&gt; b |&gt; Refl k
which is bogus because one of the template variables, k,
appears in the range of the substitution.  Eek.

Similar care is needed in unify_ty_app.


Note [Polykinded tycon applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose  T :: forall k. Type -&gt; K
and we are unifying
  ty1:  T @Type         Int       :: Type
  ty2:  T @(Type-&gt;Type) Int Int   :: Type

These two TyConApps have the same TyCon at the front but they
(legitimately) have different numbers of arguments.  They
are surelyApart, so we can report that without looking any
further (see #15704).

Note [Unifying type applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Unifying type applications is quite subtle, as we found
in #23134 and #22647, when type families are involved.

Suppose
   type family F a :: Type -&gt; Type
   type family G k :: k = r | r -&gt; k

and consider these examples:

* F Int ~ F Char, where F is injective
  Since F is injective, we can reduce this to Int ~ Char,
  therefore SurelyApart.

* F Int ~ F Char, where F is not injective
  Without injectivity, return MaybeApart.

* G Type ~ G (Type -&gt; Type) Int
  Even though G is injective and the arguments to G are different,
  we cannot deduce apartness because the RHS is oversaturated.
  For example, G might be defined as
    G Type = Maybe Int
    G (Type -&gt; Type) = Maybe
  So we return MaybeApart.

* F Int Bool ~ F Int Char       -- SurelyApart (since Bool is apart from Char)
  F Int Bool ~ Maybe a          -- MaybeApart
  F Int Bool ~ a b              -- MaybeApart
  F Int Bool ~ Char -&gt; Bool     -- MaybeApart
  An oversaturated type family can match an application,
  whether it's a TyConApp, AppTy or FunTy. Decompose.

* F Int ~ a b
  We cannot decompose a saturated, or under-saturated
  type family application. We return MaybeApart.

To handle all those conditions, unify_ty goes through
the following checks in sequence, where Fn is a type family
of arity n:

* (C1) Fn x_1 ... x_n ~ Fn y_1 .. y_n
  A saturated application.
  Here we can unify arguments in which Fn is injective.
* (C2) Fn x_1 ... x_n ~ anything, anything ~ Fn x_1 ... x_n
  A saturated type family can match anything - we return MaybeApart.
* (C3) Fn x_1 ... x_m ~ a b, a b ~ Fn x_1 ... x_m where m &gt; n
  An oversaturated type family can be decomposed.
* (C4) Fn x_1 ... x_m ~ anything, anything ~ Fn x_1 ... x_m, where m &gt; n
  If we couldn't decompose in the previous step, we return SurelyApart.

Afterwards, the rest of the code doesn't have to worry about type families.
-}</span><span>
</span><span id="line-1053"></span><span>
</span><span id="line-1054"></span><span class="hs-comment">-------------- unify_ty: the main workhorse -----------</span><span>
</span><span id="line-1055"></span><span>
</span><span id="line-1056"></span><span class="hs-keyword">type</span><span> </span><span id="AmIUnifying"><span class="annot"><a href="GHC.Core.Unify.html#AmIUnifying"><span class="hs-identifier hs-var">AmIUnifying</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>   </span><span class="hs-comment">-- True  &lt;=&gt; Unifying</span><span>
</span><span id="line-1057"></span><span>                          </span><span class="hs-comment">-- False &lt;=&gt; Matching</span><span>
</span><span id="line-1058"></span><span>
</span><span id="line-1059"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-type">unify_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span>
</span><span id="line-1060"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>  </span><span class="hs-comment">-- Types to be unified and a co</span><span>
</span><span id="line-1061"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a></span><span>     </span><span class="hs-comment">-- A coercion between their kinds</span><span>
</span><span id="line-1062"></span><span>                          </span><span class="hs-comment">-- See Note [Kind coercions in Unify]</span><span>
</span><span id="line-1063"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1064"></span><span class="hs-comment">-- Precondition: see (Unification Kind Invariant)</span><span>
</span><span id="line-1065"></span><span class="hs-comment">--</span><span>
</span><span id="line-1066"></span><span class="hs-comment">-- See Note [Specification of unification]</span><span>
</span><span id="line-1067"></span><span class="hs-comment">-- Respects newtypes, PredTypes</span><span>
</span><span id="line-1068"></span><span class="hs-comment">-- See Note [Computing equality on types] in GHC.Core.Type</span><span>
</span><span id="line-1069"></span><span id="unify_ty"><span class="annot"><span class="annottext">unify_ty :: UMEnv -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var hs-var">unify_ty</span></a></span></span><span> </span><span id="local-6989586621681627110"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627110"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621681627112"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627112"><span class="hs-identifier hs-var">tc1</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621681627113"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627113"><span class="hs-identifier hs-var">tc2</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627114"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627114"><span class="hs-identifier hs-var">_kco</span></a></span></span><span>
</span><span id="line-1070"></span><span>  </span><span class="hs-comment">-- See Note [Comparing nullary type synonyms] in GHC.Core.Type.</span><span>
</span><span id="line-1071"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627112"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627113"><span class="hs-identifier hs-var">tc2</span></a></span><span>
</span><span id="line-1072"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; UM ()
forall a. a -&gt; UM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1073"></span><span>
</span><span id="line-1074"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span id="local-6989586621681627115"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627115"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627116"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627116"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681627117"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627117"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621681627118"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627118"><span class="hs-identifier hs-var">kco</span></a></span></span><span>
</span><span id="line-1075"></span><span>    </span><span class="hs-comment">-- Now handle the cases we can &quot;look through&quot;: synonyms and casts.</span><span>
</span><span id="line-1076"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681627119"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627119"><span class="hs-identifier hs-var">ty1'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627116"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627115"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627119"><span class="hs-identifier hs-var">ty1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627117"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627118"><span class="hs-identifier hs-var">kco</span></a></span><span>
</span><span id="line-1077"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681627121"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627121"><span class="hs-identifier hs-var">ty2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627117"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627115"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627116"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627121"><span class="hs-identifier hs-var">ty2'</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627118"><span class="hs-identifier hs-var">kco</span></a></span><span>
</span><span id="line-1078"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621681627123"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627123"><span class="hs-identifier hs-var">ty1'</span></a></span></span><span> </span><span id="local-6989586621681627124"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627124"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627116"><span class="hs-identifier hs-var">ty1</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Bool
</span><a href="GHC.Core.Unify.html#um_unif"><span class="hs-identifier hs-var">um_unif</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627115"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1079"></span><span>                                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627115"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627123"><span class="hs-identifier hs-var">ty1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627117"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627124"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627118"><span class="hs-identifier hs-var">kco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1080"></span><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- See Note [Matching in the presence of casts (1)]</span><span>
</span><span id="line-1081"></span><span>                                     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681627126"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681627126"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; UM Subst
</span><a href="GHC.Core.Unify.html#getSubst"><span class="hs-identifier hs-var">getSubst</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627115"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1082"></span><span>                                        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627128"><span class="annot"><span class="annottext">co' :: CoercionN
</span><a href="#local-6989586621681627128"><span class="hs-identifier hs-var hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; CoercionN -&gt; CoercionN
Subst -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681627126"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627124"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1083"></span><span>                                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627115"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627123"><span class="hs-identifier hs-var">ty1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627117"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627128"><span class="hs-identifier hs-var">co'</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627118"><span class="hs-identifier hs-var">kco</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1084"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621681627130"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627130"><span class="hs-identifier hs-var">ty2'</span></a></span></span><span> </span><span id="local-6989586621681627131"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627131"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627117"><span class="hs-identifier hs-var">ty2</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627115"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627116"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627130"><span class="hs-identifier hs-var">ty2'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627118"><span class="hs-identifier hs-var">kco</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627131"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1085"></span><span>
</span><span id="line-1086"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span id="local-6989586621681627133"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627133"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621681627135"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627135"><span class="hs-identifier hs-var">tv1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627136"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627136"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621681627137"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627137"><span class="hs-identifier hs-var">kco</span></a></span></span><span>
</span><span id="line-1087"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; OutTyVar -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#uVar"><span class="hs-identifier hs-var">uVar</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627133"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627135"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627136"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627137"><span class="hs-identifier hs-var">kco</span></a></span><span>
</span><span id="line-1088"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span id="local-6989586621681627139"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627139"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627140"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627140"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621681627141"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627141"><span class="hs-identifier hs-var">tv2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627142"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627142"><span class="hs-identifier hs-var">kco</span></a></span></span><span>
</span><span id="line-1089"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Bool
</span><a href="GHC.Core.Unify.html#um_unif"><span class="hs-identifier hs-var">um_unif</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627139"><span class="hs-identifier hs-var">env</span></a></span><span>  </span><span class="hs-comment">-- If unifying, can swap args</span><span>
</span><span id="line-1090"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; OutTyVar -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#uVar"><span class="hs-identifier hs-var">uVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMEnv -&gt; UMEnv
</span><a href="GHC.Core.Unify.html#umSwapRn"><span class="hs-identifier hs-var">umSwapRn</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627139"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627141"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627140"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627142"><span class="hs-identifier hs-var">kco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1091"></span><span>
</span><span id="line-1092"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span id="local-6989586621681627144"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627144"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627145"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627145"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681627146"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627146"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621681627147"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627147"><span class="hs-identifier hs-var">_kco</span></a></span></span><span>
</span><span id="line-1093"></span><span>
</span><span id="line-1094"></span><span>  </span><span class="hs-comment">-- Handle non-oversaturated type families first</span><span>
</span><span id="line-1095"></span><span>  </span><span class="hs-comment">-- See Note [Unifying type applications]</span><span>
</span><span id="line-1096"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-1097"></span><span>  </span><span class="hs-comment">-- (C1) If we have T x1 ... xn ~ T y1 ... yn, use injectivity information of T</span><span>
</span><span id="line-1098"></span><span>  </span><span class="hs-comment">-- Note that both sides must not be oversaturated</span><span>
</span><span id="line-1099"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627148"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627148"><span class="hs-identifier hs-var">tc1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627149"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627149"><span class="hs-identifier hs-var">tys1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type]) -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Unify.html#isSatTyFamApp"><span class="hs-identifier hs-var">isSatTyFamApp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627151"><span class="hs-identifier hs-var">mb_tc_app1</span></a></span><span>
</span><span id="line-1100"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627152"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627152"><span class="hs-identifier hs-var">tc2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627153"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627153"><span class="hs-identifier hs-var">tys2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type]) -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Unify.html#isSatTyFamApp"><span class="hs-identifier hs-var">isSatTyFamApp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627154"><span class="hs-identifier hs-var">mb_tc_app2</span></a></span><span>
</span><span id="line-1101"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627148"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627152"><span class="hs-identifier hs-var">tc2</span></a></span><span>
</span><span id="line-1102"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627155"><span class="annot"><span class="annottext">inj :: [Bool]
</span><a href="#local-6989586621681627155"><span class="hs-identifier hs-var hs-var">inj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Injectivity
</span><a href="GHC.Core.TyCon.html#tyConInjectivityInfo"><span class="hs-identifier hs-var">tyConInjectivityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627148"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1103"></span><span>                          </span><span class="annot"><span class="annottext">Injectivity
</span><a href="GHC.Core.TyCon.html#NotInjective"><span class="hs-identifier hs-var">NotInjective</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Bool]
forall a. a -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#repeat/GHC.List.html#repeat"><span class="hs-identifier hs-var">repeat</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1104"></span><span>                          </span><span class="annot"><a href="GHC.Core.TyCon.html#Injective"><span class="hs-identifier hs-type">Injective</span></a></span><span> </span><span id="local-6989586621681627160"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681627160"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681627160"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-1105"></span><span>
</span><span id="line-1106"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621681627161"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627161"><span class="hs-identifier hs-var">inj_tys1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627162"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627162"><span class="hs-identifier hs-var">noninj_tys1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; [Type] -&gt; ([Type], [Type])
forall a. [Bool] -&gt; [a] -&gt; ([a], [a])
</span><a href="GHC.Utils.Misc.html#partitionByList"><span class="hs-identifier hs-var">partitionByList</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681627155"><span class="hs-identifier hs-var">inj</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627149"><span class="hs-identifier hs-var">tys1</span></a></span><span>
</span><span id="line-1107"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621681627164"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627164"><span class="hs-identifier hs-var">inj_tys2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627165"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627165"><span class="hs-identifier hs-var">noninj_tys2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; [Type] -&gt; ([Type], [Type])
forall a. [Bool] -&gt; [a] -&gt; ([a], [a])
</span><a href="GHC.Utils.Misc.html#partitionByList"><span class="hs-identifier hs-var">partitionByList</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681627155"><span class="hs-identifier hs-var">inj</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627153"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-1108"></span><span>
</span><span id="line-1109"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; [Type] -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_tys"><span class="hs-identifier hs-var">unify_tys</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627144"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627161"><span class="hs-identifier hs-var">inj_tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627164"><span class="hs-identifier hs-var">inj_tys2</span></a></span><span>
</span><span id="line-1110"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UM () -&gt; UM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../base-4.18.3.0/src/Control.Monad.html#unless/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMEnv -&gt; Bool
</span><a href="GHC.Core.Unify.html#um_inj_tf"><span class="hs-identifier hs-var">um_inj_tf</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627144"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UM () -&gt; UM ()) -&gt; UM () -&gt; UM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-comment">-- See (end of) Note [Specification of unification]</span><span>
</span><span id="line-1111"></span><span>         </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; UM () -&gt; UM ()
</span><a href="GHC.Core.Unify.html#don%27tBeSoSure"><span class="hs-identifier hs-var">don'tBeSoSure</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARTypeFamily"><span class="hs-identifier hs-var">MARTypeFamily</span></a></span><span> </span><span class="annot"><span class="annottext">(UM () -&gt; UM ()) -&gt; UM () -&gt; UM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; [Type] -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_tys"><span class="hs-identifier hs-var">unify_tys</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627144"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627162"><span class="hs-identifier hs-var">noninj_tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627165"><span class="hs-identifier hs-var">noninj_tys2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1112"></span><span>
</span><span id="line-1113"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(TyCon, [Type])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type]) -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Unify.html#isSatTyFamApp"><span class="hs-identifier hs-var">isSatTyFamApp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627151"><span class="hs-identifier hs-var">mb_tc_app1</span></a></span><span>  </span><span class="hs-comment">-- (C2) A (not-over-saturated) type-family application</span><span>
</span><span id="line-1114"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; UM ()
</span><a href="GHC.Core.Unify.html#maybeApart"><span class="hs-identifier hs-var">maybeApart</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARTypeFamily"><span class="hs-identifier hs-var">MARTypeFamily</span></a></span><span>            </span><span class="hs-comment">-- behaves like a type variable; might match</span><span>
</span><span id="line-1115"></span><span>
</span><span id="line-1116"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(TyCon, [Type])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type]) -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Unify.html#isSatTyFamApp"><span class="hs-identifier hs-var">isSatTyFamApp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627154"><span class="hs-identifier hs-var">mb_tc_app2</span></a></span><span>  </span><span class="hs-comment">-- (C2) A (not-over-saturated) type-family application</span><span>
</span><span id="line-1117"></span><span>                                        </span><span class="hs-comment">-- behaves like a type variable; might unify</span><span>
</span><span id="line-1118"></span><span>                                        </span><span class="hs-comment">-- but doesn't match (as in the TyVarTy case)</span><span>
</span><span id="line-1119"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Bool
</span><a href="GHC.Core.Unify.html#um_unif"><span class="hs-identifier hs-var">um_unif</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627144"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; UM ()
</span><a href="GHC.Core.Unify.html#maybeApart"><span class="hs-identifier hs-var">maybeApart</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARTypeFamily"><span class="hs-identifier hs-var">MARTypeFamily</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">UM ()
forall a. UM a
</span><a href="GHC.Core.Unify.html#surelyApart"><span class="hs-identifier hs-var">surelyApart</span></a></span><span>
</span><span id="line-1120"></span><span>
</span><span id="line-1121"></span><span>  </span><span class="hs-comment">-- Handle oversaturated type families.</span><span>
</span><span id="line-1122"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-1123"></span><span>  </span><span class="hs-comment">-- They can match an application (TyConApp/FunTy/AppTy), this is handled</span><span>
</span><span id="line-1124"></span><span>  </span><span class="hs-comment">-- the same way as in the AppTy case below.</span><span>
</span><span id="line-1125"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-1126"></span><span>  </span><span class="hs-comment">-- If there is no application, an oversaturated type family can only</span><span>
</span><span id="line-1127"></span><span>  </span><span class="hs-comment">-- match a type variable or a saturated type family,</span><span>
</span><span id="line-1128"></span><span>  </span><span class="hs-comment">-- both of which we handled earlier. So we can say surelyApart.</span><span>
</span><span id="line-1129"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627170"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627170"><span class="hs-identifier hs-var">tc1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627151"><span class="hs-identifier hs-var">mb_tc_app1</span></a></span><span>
</span><span id="line-1130"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627170"><span class="hs-identifier hs-var">tc1</span></a></span><span>
</span><span id="line-1131"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627172"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627172"><span class="hs-identifier hs-var">ty1a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627173"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627173"><span class="hs-identifier hs-var">ty1b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type)
</span><a href="GHC.Core.Type.html#tcSplitAppTyNoView_maybe"><span class="hs-identifier hs-var">tcSplitAppTyNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627145"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1132"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627175"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627175"><span class="hs-identifier hs-var">ty2a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627176"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627176"><span class="hs-identifier hs-var">ty2b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type)
</span><a href="GHC.Core.Type.html#tcSplitAppTyNoView_maybe"><span class="hs-identifier hs-var">tcSplitAppTyNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627146"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1133"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; [Type] -&gt; Type -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty_app"><span class="hs-identifier hs-var">unify_ty_app</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627144"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627172"><span class="hs-identifier hs-var">ty1a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627173"><span class="hs-identifier hs-var">ty1b</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627175"><span class="hs-identifier hs-var">ty2a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627176"><span class="hs-identifier hs-var">ty2b</span></a></span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- (C3)</span><span>
</span><span id="line-1134"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UM ()
forall a. UM a
</span><a href="GHC.Core.Unify.html#surelyApart"><span class="hs-identifier hs-var">surelyApart</span></a></span><span>                             </span><span class="hs-comment">-- (C4)</span><span>
</span><span id="line-1135"></span><span>
</span><span id="line-1136"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627178"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627178"><span class="hs-identifier hs-var">tc2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627154"><span class="hs-identifier hs-var">mb_tc_app2</span></a></span><span>
</span><span id="line-1137"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627178"><span class="hs-identifier hs-var">tc2</span></a></span><span>
</span><span id="line-1138"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627179"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627179"><span class="hs-identifier hs-var">ty1a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627180"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627180"><span class="hs-identifier hs-var">ty1b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type)
</span><a href="GHC.Core.Type.html#tcSplitAppTyNoView_maybe"><span class="hs-identifier hs-var">tcSplitAppTyNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627145"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1139"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627181"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627181"><span class="hs-identifier hs-var">ty2a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627182"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627182"><span class="hs-identifier hs-var">ty2b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type)
</span><a href="GHC.Core.Type.html#tcSplitAppTyNoView_maybe"><span class="hs-identifier hs-var">tcSplitAppTyNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627146"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1140"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; [Type] -&gt; Type -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty_app"><span class="hs-identifier hs-var">unify_ty_app</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627144"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627179"><span class="hs-identifier hs-var">ty1a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627180"><span class="hs-identifier hs-var">ty1b</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627181"><span class="hs-identifier hs-var">ty2a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627182"><span class="hs-identifier hs-var">ty2b</span></a></span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- (C3)</span><span>
</span><span id="line-1141"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UM ()
forall a. UM a
</span><a href="GHC.Core.Unify.html#surelyApart"><span class="hs-identifier hs-var">surelyApart</span></a></span><span>                             </span><span class="hs-comment">-- (C4)</span><span>
</span><span id="line-1142"></span><span>
</span><span id="line-1143"></span><span>  </span><span class="hs-comment">-- At this point, neither tc1 nor tc2 can be a type family.</span><span>
</span><span id="line-1144"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627183"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627183"><span class="hs-identifier hs-var">tc1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627184"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627184"><span class="hs-identifier hs-var">tys1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627151"><span class="hs-identifier hs-var">mb_tc_app1</span></a></span><span>
</span><span id="line-1145"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627185"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627185"><span class="hs-identifier hs-var">tc2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627186"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627186"><span class="hs-identifier hs-var">tys2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627154"><span class="hs-identifier hs-var">mb_tc_app2</span></a></span><span>
</span><span id="line-1146"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627183"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627185"><span class="hs-identifier hs-var">tc2</span></a></span><span>
</span><span id="line-1147"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; UM ()
forall (m :: * -&gt; *).
(HasCallStack, Applicative m) =&gt;
Bool -&gt; SDoc -&gt; m ()
</span><a href="GHC.Utils.Panic.html#massertPpr"><span class="hs-identifier hs-var">massertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Role -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isInjectiveTyCon"><span class="hs-identifier hs-var">isInjectiveTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627183"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627183"><span class="hs-identifier hs-var">tc1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1148"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; [Type] -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_tys"><span class="hs-identifier hs-var">unify_tys</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627144"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627184"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627186"><span class="hs-identifier hs-var">tys2</span></a></span><span>
</span><span id="line-1149"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-1150"></span><span>
</span><span id="line-1151"></span><span>  </span><span class="hs-comment">-- TYPE and CONSTRAINT are not Apart</span><span>
</span><span id="line-1152"></span><span>  </span><span class="hs-comment">-- See Note [Type and Constraint are not apart] in GHC.Builtin.Types.Prim</span><span>
</span><span id="line-1153"></span><span>  </span><span class="hs-comment">-- NB: at this point we know that the two TyCons do not match</span><span>
</span><span id="line-1154"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627190"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627190"><span class="hs-identifier hs-var">tc1</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627151"><span class="hs-identifier hs-var">mb_tc_app1</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627191"><span class="annot"><span class="annottext">u1 :: Unique
</span><a href="#local-6989586621681627191"><span class="hs-identifier hs-var hs-var">u1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique
</span><a href="GHC.Core.TyCon.html#tyConUnique"><span class="hs-identifier hs-var">tyConUnique</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627190"><span class="hs-identifier hs-var">tc1</span></a></span><span>
</span><span id="line-1155"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627193"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627193"><span class="hs-identifier hs-var">tc2</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627154"><span class="hs-identifier hs-var">mb_tc_app2</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627194"><span class="annot"><span class="annottext">u2 :: Unique
</span><a href="#local-6989586621681627194"><span class="hs-identifier hs-var hs-var">u2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Unique
</span><a href="GHC.Core.TyCon.html#tyConUnique"><span class="hs-identifier hs-var">tyConUnique</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627193"><span class="hs-identifier hs-var">tc2</span></a></span><span>
</span><span id="line-1156"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681627191"><span class="hs-identifier hs-var">u1</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Unique -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#tYPETyConKey"><span class="hs-identifier hs-var">tYPETyConKey</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681627194"><span class="hs-identifier hs-var">u2</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Unique -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#cONSTRAINTTyConKey"><span class="hs-identifier hs-var">cONSTRAINTTyConKey</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-1157"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681627194"><span class="hs-identifier hs-var">u2</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Unique -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#tYPETyConKey"><span class="hs-identifier hs-var">tYPETyConKey</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681627191"><span class="hs-identifier hs-var">u1</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Unique -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#cONSTRAINTTyConKey"><span class="hs-identifier hs-var">cONSTRAINTTyConKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1158"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; UM ()
</span><a href="GHC.Core.Unify.html#maybeApart"><span class="hs-identifier hs-var">maybeApart</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARTypeVsConstraint"><span class="hs-identifier hs-var">MARTypeVsConstraint</span></a></span><span>
</span><span id="line-1159"></span><span>    </span><span class="hs-comment">-- We don't bother to look inside; wrinkle (W3) in GHC.Builtin.Types.Prim</span><span>
</span><span id="line-1160"></span><span>    </span><span class="hs-comment">-- Note [Type and Constraint are not apart]</span><span>
</span><span id="line-1161"></span><span>
</span><span id="line-1162"></span><span>  </span><span class="hs-comment">-- The arrow types are not Apart</span><span>
</span><span id="line-1163"></span><span>  </span><span class="hs-comment">-- See Note [Type and Constraint are not apart] in GHC.Builtin.Types.Prim</span><span>
</span><span id="line-1164"></span><span>  </span><span class="hs-comment">--     wrinkle (W2)</span><span>
</span><span id="line-1165"></span><span>  </span><span class="hs-comment">-- NB1: at this point we know that the two TyCons do not match</span><span>
</span><span id="line-1166"></span><span>  </span><span class="hs-comment">-- NB2: In the common FunTy/FunTy case you might wonder if we want to go via</span><span>
</span><span id="line-1167"></span><span>  </span><span class="hs-comment">--      splitTyConApp_maybe.  But yes we do: we need to look at those implied</span><span>
</span><span id="line-1168"></span><span>  </span><span class="hs-comment">--      kind argument in order to satisfy (Unification Kind Invariant)</span><span>
</span><span id="line-1169"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627145"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1170"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627146"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1171"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; UM ()
</span><a href="GHC.Core.Unify.html#maybeApart"><span class="hs-identifier hs-var">maybeApart</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARTypeVsConstraint"><span class="hs-identifier hs-var">MARTypeVsConstraint</span></a></span><span>
</span><span id="line-1172"></span><span>    </span><span class="hs-comment">-- We don't bother to look inside; wrinkle (W3) in GHC.Builtin.Types.Prim</span><span>
</span><span id="line-1173"></span><span>    </span><span class="hs-comment">-- Note [Type and Constraint are not apart]</span><span>
</span><span id="line-1174"></span><span>
</span><span id="line-1175"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1176"></span><span>    </span><span id="local-6989586621681627151"><span class="annot"><span class="annottext">mb_tc_app1 :: Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627151"><span class="hs-identifier hs-var hs-var">mb_tc_app1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Maybe (TyCon, [Type])
Type -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627145"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1177"></span><span>    </span><span id="local-6989586621681627154"><span class="annot"><span class="annottext">mb_tc_app2 :: Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627154"><span class="hs-identifier hs-var hs-var">mb_tc_app2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Maybe (TyCon, [Type])
Type -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627146"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1178"></span><span>
</span><span id="line-1179"></span><span>        </span><span class="hs-comment">-- Applications need a bit of care!</span><span>
</span><span id="line-1180"></span><span>        </span><span class="hs-comment">-- They can match FunTy and TyConApp, so use splitAppTy_maybe</span><span>
</span><span id="line-1181"></span><span>        </span><span class="hs-comment">-- NB: we've already dealt with type variables,</span><span>
</span><span id="line-1182"></span><span>        </span><span class="hs-comment">-- so if one type is an App the other one jolly well better be too</span><span>
</span><span id="line-1183"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span id="local-6989586621681627199"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627199"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621681627201"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627201"><span class="hs-identifier hs-var">ty1a</span></a></span></span><span> </span><span id="local-6989586621681627202"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627202"><span class="hs-identifier hs-var">ty1b</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627203"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627203"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621681627204"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627204"><span class="hs-identifier hs-var">_kco</span></a></span></span><span>
</span><span id="line-1184"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627205"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627205"><span class="hs-identifier hs-var">ty2a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627206"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627206"><span class="hs-identifier hs-var">ty2b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type)
</span><a href="GHC.Core.Type.html#tcSplitAppTyNoView_maybe"><span class="hs-identifier hs-var">tcSplitAppTyNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627203"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1185"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; [Type] -&gt; Type -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty_app"><span class="hs-identifier hs-var">unify_ty_app</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627199"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627201"><span class="hs-identifier hs-var">ty1a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627202"><span class="hs-identifier hs-var">ty1b</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627205"><span class="hs-identifier hs-var">ty2a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627206"><span class="hs-identifier hs-var">ty2b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1186"></span><span>
</span><span id="line-1187"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span id="local-6989586621681627207"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627207"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627208"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627208"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621681627209"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627209"><span class="hs-identifier hs-var">ty2a</span></a></span></span><span> </span><span id="local-6989586621681627210"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627210"><span class="hs-identifier hs-var">ty2b</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627211"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627211"><span class="hs-identifier hs-var">_kco</span></a></span></span><span>
</span><span id="line-1188"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627212"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627212"><span class="hs-identifier hs-var">ty1a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627213"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627213"><span class="hs-identifier hs-var">ty1b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe (Type, Type)
</span><a href="GHC.Core.Type.html#tcSplitAppTyNoView_maybe"><span class="hs-identifier hs-var">tcSplitAppTyNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627208"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1189"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; [Type] -&gt; Type -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty_app"><span class="hs-identifier hs-var">unify_ty_app</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627207"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627212"><span class="hs-identifier hs-var">ty1a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627213"><span class="hs-identifier hs-var">ty1b</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627209"><span class="hs-identifier hs-var">ty2a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627210"><span class="hs-identifier hs-var">ty2b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1190"></span><span>
</span><span id="line-1191"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span id="local-6989586621681627215"><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621681627215"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span id="local-6989586621681627216"><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621681627216"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627217"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627217"><span class="hs-identifier hs-var">_kco</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621681627215"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; TyLit -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyLit
</span><a href="#local-6989586621681627216"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; UM ()
forall a. a -&gt; UM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1192"></span><span>
</span><span id="line-1193"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span id="local-6989586621681627218"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627218"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621681627221"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627221"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627222"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627222"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621681627223"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627223"><span class="hs-identifier hs-var">tv2</span></a></span></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627224"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627224"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627225"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627225"><span class="hs-identifier hs-var">kco</span></a></span></span><span>
</span><span id="line-1194"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627218"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar -&gt; Type
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627221"><span class="hs-identifier hs-var">tv1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar -&gt; Type
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627223"><span class="hs-identifier hs-var">tv2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1195"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627229"><span class="annot"><span class="annottext">env' :: UMEnv
</span><a href="#local-6989586621681627229"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; OutTyVar -&gt; OutTyVar -&gt; UMEnv
</span><a href="GHC.Core.Unify.html#umRnBndr2"><span class="hs-identifier hs-var">umRnBndr2</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627218"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627221"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627223"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-1196"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627229"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627222"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627224"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627225"><span class="hs-identifier hs-var">kco</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1197"></span><span>
</span><span id="line-1198"></span><span class="hs-comment">-- See Note [Matching coercion variables]</span><span>
</span><span id="line-1199"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span id="local-6989586621681627231"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627231"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span id="local-6989586621681627232"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627232"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span id="local-6989586621681627233"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627233"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627234"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627234"><span class="hs-identifier hs-var">kco</span></a></span></span><span>
</span><span id="line-1200"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681627235"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627235"><span class="hs-identifier hs-var">c_subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UM CvSubstEnv
</span><a href="GHC.Core.Unify.html#getCvSubstEnv"><span class="hs-identifier hs-var">getCvSubstEnv</span></a></span><span>
</span><span id="line-1201"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627232"><span class="hs-identifier hs-var">co1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1202"></span><span>           </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoVarCo"><span class="hs-identifier hs-type">CoVarCo</span></a></span><span> </span><span id="local-6989586621681627237"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627237"><span class="hs-identifier hs-var">cv</span></a></span></span><span>
</span><span id="line-1203"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMEnv -&gt; Bool
</span><a href="GHC.Core.Unify.html#um_unif"><span class="hs-identifier hs-var">um_unif</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627231"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1204"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627237"><span class="hs-identifier hs-var">cv</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; CvSubstEnv -&gt; Bool
forall a. OutTyVar -&gt; VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemVarEnv"><span class="hs-operator hs-var">`elemVarEnv`</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627235"><span class="hs-identifier hs-var">c_subst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1205"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627239"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627239"><span class="hs-identifier hs-var">co_l</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627240"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627240"><span class="hs-identifier hs-var">co_r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt;
CoercionN -&gt; (CoercionN, CoercionN, CoercionN)
CoercionN -&gt; (CoercionN, CoercionN, CoercionN)
</span><a href="GHC.Core.Coercion.html#decomposeFunCo"><span class="hs-identifier hs-var">decomposeFunCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627234"><span class="hs-identifier hs-var">kco</span></a></span><span>
</span><span id="line-1206"></span><span>                     </span><span class="hs-comment">-- Because the coercion is used in a type, it should be safe to</span><span>
</span><span id="line-1207"></span><span>                     </span><span class="hs-comment">-- ignore the multiplicity coercion.</span><span>
</span><span id="line-1208"></span><span>                      </span><span class="hs-comment">-- cv :: t1 ~ t2</span><span>
</span><span id="line-1209"></span><span>                      </span><span class="hs-comment">-- co2 :: s1 ~ s2</span><span>
</span><span id="line-1210"></span><span>                      </span><span class="hs-comment">-- co_l :: t1 ~ s1</span><span>
</span><span id="line-1211"></span><span>                      </span><span class="hs-comment">-- co_r :: t2 ~ s2</span><span>
</span><span id="line-1212"></span><span>                   </span><span id="local-6989586621681627242"><span class="annot"><span class="annottext">rhs_co :: CoercionN
</span><a href="#local-6989586621681627242"><span class="hs-identifier hs-var hs-var">rhs_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627239"><span class="hs-identifier hs-var">co_l</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627233"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627240"><span class="hs-identifier hs-var">co_r</span></a></span><span>
</span><span id="line-1213"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BindFlag
</span><a href="GHC.Core.Unify.html#BindMe"><span class="hs-identifier hs-var">BindMe</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; BindFun
</span><a href="GHC.Core.Unify.html#tvBindFlag"><span class="hs-identifier hs-var">tvBindFlag</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627231"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627237"><span class="hs-identifier hs-var">cv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627242"><span class="hs-identifier hs-var">rhs_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1214"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; VarSet -&gt; UM ()
</span><a href="GHC.Core.Unify.html#checkRnEnv"><span class="hs-identifier hs-var">checkRnEnv</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627231"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627233"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1215"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#extendCvEnv"><span class="hs-identifier hs-var">extendCvEnv</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627237"><span class="hs-identifier hs-var">cv</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627242"><span class="hs-identifier hs-var">rhs_co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1216"></span><span>           </span><span class="annot"><span class="annottext">CoercionN
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; UM ()
forall a. a -&gt; UM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1217"></span><span>
</span><span id="line-1218"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UM ()
forall a. UM a
</span><a href="GHC.Core.Unify.html#surelyApart"><span class="hs-identifier hs-var">surelyApart</span></a></span><span>
</span><span id="line-1219"></span><span>
</span><span id="line-1220"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_ty_app"><span class="hs-identifier hs-type">unify_ty_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1221"></span><span id="unify_ty_app"><span class="annot"><span class="annottext">unify_ty_app :: UMEnv -&gt; Type -&gt; [Type] -&gt; Type -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty_app"><span class="hs-identifier hs-var hs-var">unify_ty_app</span></a></span></span><span> </span><span id="local-6989586621681627247"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627247"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627248"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627248"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681627249"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627249"><span class="hs-identifier hs-var">ty1args</span></a></span></span><span> </span><span id="local-6989586621681627250"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627250"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621681627251"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627251"><span class="hs-identifier hs-var">ty2args</span></a></span></span><span>
</span><span id="line-1222"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627252"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627252"><span class="hs-identifier hs-var">ty1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627253"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627253"><span class="hs-identifier hs-var">ty1a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Maybe (Type, Type)
Type -&gt; Maybe (Type, Type)
</span><a href="GHC.Core.Type.html#splitAppTyNoView_maybe"><span class="hs-identifier hs-var">splitAppTyNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627248"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1223"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627255"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627255"><span class="hs-identifier hs-var">ty2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627256"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627256"><span class="hs-identifier hs-var">ty2a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Maybe (Type, Type)
Type -&gt; Maybe (Type, Type)
</span><a href="GHC.Core.Type.html#splitAppTyNoView_maybe"><span class="hs-identifier hs-var">splitAppTyNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627250"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1224"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; [Type] -&gt; Type -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty_app"><span class="hs-identifier hs-var">unify_ty_app</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627247"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627252"><span class="hs-identifier hs-var">ty1'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627253"><span class="hs-identifier hs-var">ty1a</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; [Type]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627249"><span class="hs-identifier hs-var">ty1args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627255"><span class="hs-identifier hs-var">ty2'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627256"><span class="hs-identifier hs-var">ty2a</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; [Type]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627251"><span class="hs-identifier hs-var">ty2args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1225"></span><span>
</span><span id="line-1226"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1227"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627257"><span class="annot"><span class="annottext">ki1 :: Type
</span><a href="#local-6989586621681627257"><span class="hs-identifier hs-var hs-var">ki1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627248"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1228"></span><span>             </span><span id="local-6989586621681627258"><span class="annot"><span class="annottext">ki2 :: Type
</span><a href="#local-6989586621681627258"><span class="hs-identifier hs-var hs-var">ki2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627250"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1229"></span><span>           </span><span class="hs-comment">-- See Note [Kind coercions in Unify]</span><span>
</span><span id="line-1230"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span>  </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627247"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627257"><span class="hs-identifier hs-var">ki1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627258"><span class="hs-identifier hs-var">ki2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1231"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span>  </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627247"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627248"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627250"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627258"><span class="hs-identifier hs-var">ki2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1232"></span><span>                 </span><span class="hs-comment">-- Very important: 'ki2' not 'ki1'</span><span>
</span><span id="line-1233"></span><span>                 </span><span class="hs-comment">-- See Note [Matching in the presence of casts (2)]</span><span>
</span><span id="line-1234"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; [Type] -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_tys"><span class="hs-identifier hs-var">unify_tys</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627247"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627249"><span class="hs-identifier hs-var">ty1args</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627251"><span class="hs-identifier hs-var">ty2args</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1235"></span><span>
</span><span id="line-1236"></span><span class="annot"><a href="GHC.Core.Unify.html#unify_tys"><span class="hs-identifier hs-type">unify_tys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1237"></span><span class="hs-comment">-- Precondition: see (Unification Kind Invariant)</span><span>
</span><span id="line-1238"></span><span id="unify_tys"><span class="annot"><span class="annottext">unify_tys :: UMEnv -&gt; [Type] -&gt; [Type] -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_tys"><span class="hs-identifier hs-var hs-var">unify_tys</span></a></span></span><span> </span><span id="local-6989586621681627259"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627259"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627260"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627260"><span class="hs-identifier hs-var">orig_xs</span></a></span></span><span> </span><span id="local-6989586621681627261"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627261"><span class="hs-identifier hs-var">orig_ys</span></a></span></span><span>
</span><span id="line-1239"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; UM ()
</span><a href="#local-6989586621681627262"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627260"><span class="hs-identifier hs-var">orig_xs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627261"><span class="hs-identifier hs-var">orig_ys</span></a></span><span>
</span><span id="line-1240"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1241"></span><span>    </span><span id="local-6989586621681627262"><span class="annot"><span class="annottext">go :: [Type] -&gt; [Type] -&gt; UM ()
</span><a href="#local-6989586621681627262"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; UM ()
forall a. a -&gt; UM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1242"></span><span>    </span><span class="annot"><a href="#local-6989586621681627262"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627263"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627263"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681627264"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627264"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627265"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627265"><span class="hs-identifier hs-var">y</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681627266"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627266"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1243"></span><span>      </span><span class="hs-comment">-- See Note [Kind coercions in Unify]</span><span>
</span><span id="line-1244"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627259"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627263"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627265"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; CoercionN) -&gt; Type -&gt; CoercionN
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627265"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1245"></span><span>                 </span><span class="hs-comment">-- Very important: 'y' not 'x'</span><span>
</span><span id="line-1246"></span><span>                 </span><span class="hs-comment">-- See Note [Matching in the presence of casts (2)]</span><span>
</span><span id="line-1247"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; UM ()
</span><a href="#local-6989586621681627262"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627264"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627266"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1248"></span><span>    </span><span class="annot"><a href="#local-6989586621681627262"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UM ()
forall a. UM a
</span><a href="GHC.Core.Unify.html#surelyApart"><span class="hs-identifier hs-var">surelyApart</span></a></span><span>
</span><span id="line-1249"></span><span>      </span><span class="hs-comment">-- Possibly different saturations of a polykinded tycon</span><span>
</span><span id="line-1250"></span><span>      </span><span class="hs-comment">-- See Note [Polykinded tycon applications]</span><span>
</span><span id="line-1251"></span><span>
</span><span id="line-1252"></span><span class="annot"><a href="GHC.Core.Unify.html#isSatTyFamApp"><span class="hs-identifier hs-type">isSatTyFamApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1253"></span><span class="hs-comment">-- Return the argument if we have a saturated type family application</span><span>
</span><span id="line-1254"></span><span class="hs-comment">-- If it is /over/ saturated then we return False.  E.g.</span><span>
</span><span id="line-1255"></span><span class="hs-comment">--     unify_ty (F a b) (c d)    where F has arity 1</span><span>
</span><span id="line-1256"></span><span class="hs-comment">-- we definitely want to decompose that type application! (#22647)</span><span>
</span><span id="line-1257"></span><span id="isSatTyFamApp"><span class="annot"><span class="annottext">isSatTyFamApp :: Maybe (TyCon, [Type]) -&gt; Maybe (TyCon, [Type])
</span><a href="GHC.Core.Unify.html#isSatTyFamApp"><span class="hs-identifier hs-var hs-var">isSatTyFamApp</span></a></span></span><span> </span><span id="local-6989586621681627267"><span class="annot"><span class="annottext">tapp :: Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627267"><span class="hs-identifier hs-var">tapp</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627268"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627268"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627269"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627269"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1258"></span><span>  </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627268"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1259"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627269"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Arity -&gt; Bool
forall a. [a] -&gt; Arity -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthExceeds"><span class="hs-operator hs-var">`lengthExceeds`</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Arity
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627268"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Not over-saturated</span><span>
</span><span id="line-1260"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><a href="#local-6989586621681627267"><span class="hs-identifier hs-var">tapp</span></a></span><span>
</span><span id="line-1261"></span><span class="annot"><a href="GHC.Core.Unify.html#isSatTyFamApp"><span class="hs-identifier hs-var">isSatTyFamApp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TyCon, [Type])
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1262"></span><span>
</span><span id="line-1263"></span><span class="hs-comment">---------------------------------</span><span>
</span><span id="line-1264"></span><span class="annot"><a href="GHC.Core.Unify.html#uVar"><span class="hs-identifier hs-type">uVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span>
</span><span id="line-1265"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InTyVar"><span class="hs-identifier hs-type">InTyVar</span></a></span><span>         </span><span class="hs-comment">-- Variable to be unified</span><span>
</span><span id="line-1266"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>            </span><span class="hs-comment">-- with this Type</span><span>
</span><span id="line-1267"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>        </span><span class="hs-comment">-- :: kind tv ~N kind ty</span><span>
</span><span id="line-1268"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1269"></span><span>
</span><span id="line-1270"></span><span id="uVar"><span class="annot"><span class="annottext">uVar :: UMEnv -&gt; OutTyVar -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#uVar"><span class="hs-identifier hs-var hs-var">uVar</span></a></span></span><span> </span><span id="local-6989586621681627274"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627274"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627275"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627275"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span id="local-6989586621681627276"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627276"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681627277"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627277"><span class="hs-identifier hs-var">kco</span></a></span></span><span>
</span><span id="line-1271"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Apply the ambient renaming</span><span>
</span><span id="line-1272"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627278"><span class="annot"><span class="annottext">tv1' :: OutTyVar
</span><a href="#local-6989586621681627278"><span class="hs-identifier hs-var hs-var">tv1'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; OutTyVar -&gt; OutTyVar
</span><a href="GHC.Core.Unify.html#umRnOccL"><span class="hs-identifier hs-var">umRnOccL</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627274"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627275"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-1273"></span><span>
</span><span id="line-1274"></span><span>        </span><span class="hs-comment">-- Check to see whether tv1 is refined by the substitution</span><span>
</span><span id="line-1275"></span><span>      </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681627280"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627280"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UM TvSubstEnv
</span><a href="GHC.Core.Unify.html#getTvSubstEnv"><span class="hs-identifier hs-var">getTvSubstEnv</span></a></span><span>
</span><span id="line-1276"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TvSubstEnv -&gt; OutTyVar -&gt; Maybe Type
forall a. VarEnv a -&gt; OutTyVar -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627280"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627278"><span class="hs-identifier hs-var">tv1'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1277"></span><span>          </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681627281"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627281"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Bool
</span><a href="GHC.Core.Unify.html#um_unif"><span class="hs-identifier hs-var">um_unif</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627274"><span class="hs-identifier hs-var">env</span></a></span><span>                </span><span class="hs-comment">-- Unifying, so call</span><span>
</span><span id="line-1278"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#unify_ty"><span class="hs-identifier hs-var">unify_ty</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627274"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627281"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627276"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627277"><span class="hs-identifier hs-var">kco</span></a></span><span>   </span><span class="hs-comment">-- back into unify</span><span>
</span><span id="line-1279"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1280"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- Matching, we don't want to just recur here.</span><span>
</span><span id="line-1281"></span><span>                      </span><span class="hs-comment">-- this is because the range of the subst is the target</span><span>
</span><span id="line-1282"></span><span>                      </span><span class="hs-comment">-- type, not the template type. So, just check for</span><span>
</span><span id="line-1283"></span><span>                      </span><span class="hs-comment">-- normal type equality.</span><span>
</span><span id="line-1284"></span><span>                      </span><span class="annot"><span class="annottext">Bool -&gt; UM () -&gt; UM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../base-4.18.3.0/src/Control.Monad.html#unless/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627281"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoercionN -&gt; Type
</span><a href="GHC.Core.Type.html#mkCastTy"><span class="hs-operator hs-var">`mkCastTy`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627277"><span class="hs-identifier hs-var">kco</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type -&gt; Bool
Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627276"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UM () -&gt; UM ()) -&gt; UM () -&gt; UM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1285"></span><span>                        </span><span class="annot"><span class="annottext">UM ()
forall a. UM a
</span><a href="GHC.Core.Unify.html#surelyApart"><span class="hs-identifier hs-var">surelyApart</span></a></span><span>
</span><span id="line-1286"></span><span>                      </span><span class="hs-comment">-- NB: it's important to use `tcEqType` instead of `eqType` here,</span><span>
</span><span id="line-1287"></span><span>                      </span><span class="hs-comment">-- otherwise we might not reject a substitution</span><span>
</span><span id="line-1288"></span><span>                      </span><span class="hs-comment">-- which unifies `Type` with `Constraint`, e.g.</span><span>
</span><span id="line-1289"></span><span>                      </span><span class="hs-comment">-- a call to tc_unify_tys with arguments</span><span>
</span><span id="line-1290"></span><span>                      </span><span class="hs-comment">--</span><span>
</span><span id="line-1291"></span><span>                      </span><span class="hs-comment">--   tys1 = [k,k]</span><span>
</span><span id="line-1292"></span><span>                      </span><span class="hs-comment">--   tys2 = [Type, Constraint]</span><span>
</span><span id="line-1293"></span><span>                      </span><span class="hs-comment">--</span><span>
</span><span id="line-1294"></span><span>                      </span><span class="hs-comment">-- See test cases: T11715b, T20521.</span><span>
</span><span id="line-1295"></span><span>          </span><span class="annot"><span class="annottext">Maybe Type
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; OutTyVar -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#uUnrefined"><span class="hs-identifier hs-var">uUnrefined</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627274"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627278"><span class="hs-identifier hs-var">tv1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627276"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627276"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627277"><span class="hs-identifier hs-var">kco</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-comment">-- No, continue</span><span>
</span><span id="line-1296"></span><span>
</span><span id="line-1297"></span><span class="annot"><a href="GHC.Core.Unify.html#uUnrefined"><span class="hs-identifier hs-type">uUnrefined</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span>
</span><span id="line-1298"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutTyVar"><span class="hs-identifier hs-type">OutTyVar</span></a></span><span>          </span><span class="hs-comment">-- variable to be unified</span><span>
</span><span id="line-1299"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>              </span><span class="hs-comment">-- with this Type</span><span>
</span><span id="line-1300"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>              </span><span class="hs-comment">-- (version w/ expanded synonyms)</span><span>
</span><span id="line-1301"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>          </span><span class="hs-comment">-- :: kind tv ~N kind ty</span><span>
</span><span id="line-1302"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1303"></span><span>
</span><span id="line-1304"></span><span class="hs-comment">-- We know that tv1 isn't refined</span><span>
</span><span id="line-1305"></span><span>
</span><span id="line-1306"></span><span id="uUnrefined"><span class="annot"><span class="annottext">uUnrefined :: UMEnv -&gt; OutTyVar -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#uUnrefined"><span class="hs-identifier hs-var hs-var">uUnrefined</span></a></span></span><span> </span><span id="local-6989586621681627284"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627284"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627285"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627285"><span class="hs-identifier hs-var">tv1'</span></a></span></span><span> </span><span id="local-6989586621681627286"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627286"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621681627287"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627287"><span class="hs-identifier hs-var">ty2'</span></a></span></span><span> </span><span id="local-6989586621681627288"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627288"><span class="hs-identifier hs-var">kco</span></a></span></span><span>
</span><span id="line-1307"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681627289"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627289"><span class="hs-identifier hs-var">ty2''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627287"><span class="hs-identifier hs-var">ty2'</span></a></span><span>
</span><span id="line-1308"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; OutTyVar -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#uUnrefined"><span class="hs-identifier hs-var">uUnrefined</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627284"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627285"><span class="hs-identifier hs-var">tv1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627286"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627289"><span class="hs-identifier hs-var">ty2''</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627288"><span class="hs-identifier hs-var">kco</span></a></span><span>    </span><span class="hs-comment">-- Unwrap synonyms</span><span>
</span><span id="line-1309"></span><span>                </span><span class="hs-comment">-- This is essential, in case we have</span><span>
</span><span id="line-1310"></span><span>                </span><span class="hs-comment">--      type Foo a = a</span><span>
</span><span id="line-1311"></span><span>                </span><span class="hs-comment">-- and then unify a ~ Foo a</span><span>
</span><span id="line-1312"></span><span>
</span><span id="line-1313"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621681627290"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627290"><span class="hs-identifier hs-var">tv2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627287"><span class="hs-identifier hs-var">ty2'</span></a></span><span>
</span><span id="line-1314"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627291"><span class="annot"><span class="annottext">tv2' :: OutTyVar
</span><a href="#local-6989586621681627291"><span class="hs-identifier hs-var hs-var">tv2'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; OutTyVar -&gt; OutTyVar
</span><a href="GHC.Core.Unify.html#umRnOccR"><span class="hs-identifier hs-var">umRnOccR</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627284"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627290"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-1315"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UM () -&gt; UM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../base-4.18.3.0/src/Control.Monad.html#unless/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627285"><span class="hs-identifier hs-var">tv1'</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; OutTyVar -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627291"><span class="hs-identifier hs-var">tv2'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Bool
</span><a href="GHC.Core.Unify.html#um_unif"><span class="hs-identifier hs-var">um_unif</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627284"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UM () -&gt; UM ()) -&gt; UM () -&gt; UM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1316"></span><span>           </span><span class="hs-comment">-- If we are unifying a ~ a, just return immediately</span><span>
</span><span id="line-1317"></span><span>           </span><span class="hs-comment">-- Do not extend the substitution</span><span>
</span><span id="line-1318"></span><span>           </span><span class="hs-comment">-- See Note [Self-substitution when matching]</span><span>
</span><span id="line-1319"></span><span>
</span><span id="line-1320"></span><span>          </span><span class="hs-comment">-- Check to see whether tv2 is refined</span><span>
</span><span id="line-1321"></span><span>       </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681627293"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627293"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UM TvSubstEnv
</span><a href="GHC.Core.Unify.html#getTvSubstEnv"><span class="hs-identifier hs-var">getTvSubstEnv</span></a></span><span>
</span><span id="line-1322"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; OutTyVar -&gt; Maybe Type
forall a. VarEnv a -&gt; OutTyVar -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627293"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627290"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1323"></span><span>         </span><span class="hs-special">{</span><span>  </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681627294"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627294"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Bool
</span><a href="GHC.Core.Unify.html#um_unif"><span class="hs-identifier hs-var">um_unif</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627284"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; OutTyVar -&gt; Type -&gt; Type -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#uUnrefined"><span class="hs-identifier hs-var">uUnrefined</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627284"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627285"><span class="hs-identifier hs-var">tv1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627294"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627294"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627288"><span class="hs-identifier hs-var">kco</span></a></span><span>
</span><span id="line-1324"></span><span>         </span><span class="hs-special">;</span><span>  </span><span class="annot"><span class="annottext">Maybe Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1325"></span><span>
</span><span id="line-1326"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">-- So both are unrefined</span><span>
</span><span id="line-1327"></span><span>           </span><span class="hs-comment">-- Bind one or the other, depending on which is bindable</span><span>
</span><span id="line-1328"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627295"><span class="annot"><span class="annottext">rhs1 :: Type
</span><a href="#local-6989586621681627295"><span class="hs-identifier hs-var hs-var">rhs1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627286"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoercionN -&gt; Type
</span><a href="GHC.Core.Type.html#mkCastTy"><span class="hs-operator hs-var">`mkCastTy`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627288"><span class="hs-identifier hs-var">kco</span></a></span><span>
</span><span id="line-1329"></span><span>             </span><span id="local-6989586621681627296"><span class="annot"><span class="annottext">rhs2 :: Type
</span><a href="#local-6989586621681627296"><span class="hs-identifier hs-var hs-var">rhs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627297"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoercionN -&gt; Type
</span><a href="GHC.Core.Type.html#mkCastTy"><span class="hs-operator hs-var">`mkCastTy`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627288"><span class="hs-identifier hs-var">kco</span></a></span><span>
</span><span id="line-1330"></span><span>             </span><span id="local-6989586621681627298"><span class="annot"><span class="annottext">b1 :: BindFlag
</span><a href="#local-6989586621681627298"><span class="hs-identifier hs-var hs-var">b1</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; BindFun
</span><a href="GHC.Core.Unify.html#tvBindFlag"><span class="hs-identifier hs-var">tvBindFlag</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627284"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627285"><span class="hs-identifier hs-var">tv1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627295"><span class="hs-identifier hs-var">rhs1</span></a></span><span>
</span><span id="line-1331"></span><span>             </span><span id="local-6989586621681627299"><span class="annot"><span class="annottext">b2 :: BindFlag
</span><a href="#local-6989586621681627299"><span class="hs-identifier hs-var hs-var">b2</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; BindFun
</span><a href="GHC.Core.Unify.html#tvBindFlag"><span class="hs-identifier hs-var">tvBindFlag</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627284"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627291"><span class="hs-identifier hs-var">tv2'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627296"><span class="hs-identifier hs-var">rhs2</span></a></span><span>
</span><span id="line-1332"></span><span>             </span><span id="local-6989586621681627297"><span class="annot"><span class="annottext">ty1 :: Type
</span><a href="#local-6989586621681627297"><span class="hs-identifier hs-var hs-var">ty1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627285"><span class="hs-identifier hs-var">tv1'</span></a></span><span>
</span><span id="line-1333"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindFlag
</span><a href="#local-6989586621681627298"><span class="hs-identifier hs-var">b1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BindFlag
</span><a href="#local-6989586621681627299"><span class="hs-identifier hs-var">b2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1334"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindFlag
</span><a href="GHC.Core.Unify.html#BindMe"><span class="hs-identifier hs-var">BindMe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BindFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; OutTyVar -&gt; Type -&gt; UM ()
</span><a href="GHC.Core.Unify.html#bindTv"><span class="hs-identifier hs-var">bindTv</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627284"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627285"><span class="hs-identifier hs-var">tv1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627295"><span class="hs-identifier hs-var">rhs1</span></a></span><span>
</span><span id="line-1335"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BindFlag
</span><a href="GHC.Core.Unify.html#BindMe"><span class="hs-identifier hs-var">BindMe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Bool
</span><a href="GHC.Core.Unify.html#um_unif"><span class="hs-identifier hs-var">um_unif</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627284"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1336"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; OutTyVar -&gt; Type -&gt; UM ()
</span><a href="GHC.Core.Unify.html#bindTv"><span class="hs-identifier hs-var">bindTv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMEnv -&gt; UMEnv
</span><a href="GHC.Core.Unify.html#umSwapRn"><span class="hs-identifier hs-var">umSwapRn</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627284"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627290"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627296"><span class="hs-identifier hs-var">rhs2</span></a></span><span>
</span><span id="line-1337"></span><span>
</span><span id="line-1338"></span><span>           </span><span class="annot"><span class="annottext">(BindFlag, BindFlag)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627285"><span class="hs-identifier hs-var">tv1'</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; OutTyVar -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627291"><span class="hs-identifier hs-var">tv2'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; UM ()
forall a. a -&gt; UM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1339"></span><span>             </span><span class="hs-comment">-- How could this happen? If we're only matching and if</span><span>
</span><span id="line-1340"></span><span>             </span><span class="hs-comment">-- we're comparing forall-bound variables.</span><span>
</span><span id="line-1341"></span><span>
</span><span id="line-1342"></span><span>           </span><span class="annot"><span class="annottext">(BindFlag, BindFlag)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UM ()
forall a. UM a
</span><a href="GHC.Core.Unify.html#surelyApart"><span class="hs-identifier hs-var">surelyApart</span></a></span><span>
</span><span id="line-1343"></span><span>  </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-1344"></span><span>
</span><span id="line-1345"></span><span class="annot"><a href="GHC.Core.Unify.html#uUnrefined"><span class="hs-identifier hs-var">uUnrefined</span></a></span><span> </span><span id="local-6989586621681627301"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627301"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627302"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627302"><span class="hs-identifier hs-var">tv1'</span></a></span></span><span> </span><span id="local-6989586621681627303"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627303"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681627304"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627304"><span class="hs-identifier hs-var">kco</span></a></span></span><span> </span><span class="hs-comment">-- ty2 is not a type variable</span><span>
</span><span id="line-1346"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; BindFun
</span><a href="GHC.Core.Unify.html#tvBindFlag"><span class="hs-identifier hs-var">tvBindFlag</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627301"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627302"><span class="hs-identifier hs-var">tv1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627305"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1347"></span><span>      </span><span class="annot"><span class="annottext">BindFlag
</span><a href="GHC.Core.Unify.html#Apart"><span class="hs-identifier hs-var">Apart</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UM ()
forall a. UM a
</span><a href="GHC.Core.Unify.html#surelyApart"><span class="hs-identifier hs-var">surelyApart</span></a></span><span>
</span><span id="line-1348"></span><span>      </span><span class="annot"><span class="annottext">BindFlag
</span><a href="GHC.Core.Unify.html#BindMe"><span class="hs-identifier hs-var">BindMe</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; OutTyVar -&gt; Type -&gt; UM ()
</span><a href="GHC.Core.Unify.html#bindTv"><span class="hs-identifier hs-var">bindTv</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627301"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627302"><span class="hs-identifier hs-var">tv1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627305"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1349"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1350"></span><span>    </span><span id="local-6989586621681627305"><span class="annot"><span class="annottext">rhs :: Type
</span><a href="#local-6989586621681627305"><span class="hs-identifier hs-var hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627303"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoercionN -&gt; Type
</span><a href="GHC.Core.Type.html#mkCastTy"><span class="hs-operator hs-var">`mkCastTy`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627304"><span class="hs-identifier hs-var">kco</span></a></span><span>
</span><span id="line-1351"></span><span>
</span><span id="line-1352"></span><span class="annot"><a href="GHC.Core.Unify.html#bindTv"><span class="hs-identifier hs-type">bindTv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutTyVar"><span class="hs-identifier hs-type">OutTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1353"></span><span class="hs-comment">-- OK, so we want to extend the substitution with tv := ty</span><span>
</span><span id="line-1354"></span><span class="hs-comment">-- But first, we must do a couple of checks</span><span>
</span><span id="line-1355"></span><span id="bindTv"><span class="annot"><span class="annottext">bindTv :: UMEnv -&gt; OutTyVar -&gt; Type -&gt; UM ()
</span><a href="GHC.Core.Unify.html#bindTv"><span class="hs-identifier hs-var hs-var">bindTv</span></a></span></span><span> </span><span id="local-6989586621681627306"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627306"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627307"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627307"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span id="local-6989586621681627308"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627308"><span class="hs-identifier hs-var">ty2</span></a></span></span><span>
</span><span id="line-1356"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627309"><span class="annot"><span class="annottext">free_tvs2 :: VarSet
</span><a href="#local-6989586621681627309"><span class="hs-identifier hs-var hs-var">free_tvs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627308"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1357"></span><span>
</span><span id="line-1358"></span><span>        </span><span class="hs-comment">-- Make sure tys mentions no local variables</span><span>
</span><span id="line-1359"></span><span>        </span><span class="hs-comment">-- E.g.  (forall a. b) ~ (forall a. [a])</span><span>
</span><span id="line-1360"></span><span>        </span><span class="hs-comment">-- We should not unify b := [a]!</span><span>
</span><span id="line-1361"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; VarSet -&gt; UM ()
</span><a href="GHC.Core.Unify.html#checkRnEnv"><span class="hs-identifier hs-var">checkRnEnv</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627306"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627309"><span class="hs-identifier hs-var">free_tvs2</span></a></span><span>
</span><span id="line-1362"></span><span>
</span><span id="line-1363"></span><span>        </span><span class="hs-comment">-- Occurs check, see Note [Fine-grained unification]</span><span>
</span><span id="line-1364"></span><span>        </span><span class="hs-comment">-- Make sure you include 'kco' (which ty2 does) #14846</span><span>
</span><span id="line-1365"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681627310"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681627310"><span class="hs-identifier hs-var">occurs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; OutTyVar -&gt; VarSet -&gt; UM Bool
</span><a href="GHC.Core.Unify.html#occursCheck"><span class="hs-identifier hs-var">occursCheck</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627306"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627307"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627309"><span class="hs-identifier hs-var">free_tvs2</span></a></span><span>
</span><span id="line-1366"></span><span>
</span><span id="line-1367"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681627310"><span class="hs-identifier hs-var">occurs</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; UM ()
</span><a href="GHC.Core.Unify.html#maybeApart"><span class="hs-identifier hs-var">maybeApart</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="GHC.Core.Unify.html#MARInfinite"><span class="hs-identifier hs-var">MARInfinite</span></a></span><span>
</span><span id="line-1368"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; Type -&gt; UM ()
</span><a href="GHC.Core.Unify.html#extendTvEnv"><span class="hs-identifier hs-var">extendTvEnv</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627307"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627308"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1369"></span><span>
</span><span id="line-1370"></span><span class="annot"><a href="GHC.Core.Unify.html#occursCheck"><span class="hs-identifier hs-type">occursCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1371"></span><span id="occursCheck"><span class="annot"><span class="annottext">occursCheck :: UMEnv -&gt; OutTyVar -&gt; VarSet -&gt; UM Bool
</span><a href="GHC.Core.Unify.html#occursCheck"><span class="hs-identifier hs-var hs-var">occursCheck</span></a></span></span><span> </span><span id="local-6989586621681627313"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627313"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627314"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627314"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621681627315"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627315"><span class="hs-identifier hs-var">free_tvs</span></a></span></span><span>
</span><span id="line-1372"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; Bool
</span><a href="GHC.Core.Unify.html#um_unif"><span class="hs-identifier hs-var">um_unif</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627313"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1373"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681627316"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627316"><span class="hs-identifier hs-var">tsubst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UM TvSubstEnv
</span><a href="GHC.Core.Unify.html#getTvSubstEnv"><span class="hs-identifier hs-var">getTvSubstEnv</span></a></span><span>
</span><span id="line-1374"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UM Bool
forall a. a -&gt; UM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627314"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Core.Unify.html#niSubstTvSet"><span class="hs-identifier hs-var">niSubstTvSet</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627316"><span class="hs-identifier hs-var">tsubst</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627315"><span class="hs-identifier hs-var">free_tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1375"></span><span>
</span><span id="line-1376"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>      </span><span class="hs-comment">-- Matching; no occurs check</span><span>
</span><span id="line-1377"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UM Bool
forall a. a -&gt; UM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>   </span><span class="hs-comment">-- See Note [Self-substitution when matching]</span><span>
</span><span id="line-1378"></span><span>
</span><span id="line-1379"></span><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
                Binding decisions
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1386"></span><span>
</span><span id="line-1387"></span><span class="hs-keyword">data</span><span> </span><span id="BindFlag"><span class="annot"><a href="GHC.Core.Unify.html#BindFlag"><span class="hs-identifier hs-var">BindFlag</span></a></span></span><span>
</span><span id="line-1388"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="BindMe"><span class="annot"><a href="GHC.Core.Unify.html#BindMe"><span class="hs-identifier hs-var">BindMe</span></a></span></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ A regular type variable</span></span><span>
</span><span id="line-1389"></span><span>
</span><span id="line-1390"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Apart"><span class="annot"><a href="GHC.Core.Unify.html#Apart"><span class="hs-identifier hs-var">Apart</span></a></span></span><span>       </span><span class="hs-comment">-- ^ Declare that this type variable is /apart/ from the</span><span>
</span><span id="line-1391"></span><span>                </span><span class="hs-comment">-- type provided. That is, the type variable will never</span><span>
</span><span id="line-1392"></span><span>                </span><span class="hs-comment">-- be instantiated to that type.</span><span>
</span><span id="line-1393"></span><span>                </span><span class="hs-comment">-- See also Note [Binding when looking up instances]</span><span>
</span><span id="line-1394"></span><span>                </span><span class="hs-comment">-- in GHC.Core.InstEnv.</span><span>
</span><span id="line-1395"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621681627318"><span id="local-6989586621681627320"><span class="annot"><span class="annottext">BindFlag -&gt; BindFlag -&gt; Bool
(BindFlag -&gt; BindFlag -&gt; Bool)
-&gt; (BindFlag -&gt; BindFlag -&gt; Bool) -&gt; Eq BindFlag
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: BindFlag -&gt; BindFlag -&gt; Bool
== :: BindFlag -&gt; BindFlag -&gt; Bool
$c/= :: BindFlag -&gt; BindFlag -&gt; Bool
/= :: BindFlag -&gt; BindFlag -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span>
</span><span id="line-1396"></span><span class="hs-comment">-- NB: It would be conceivable to have an analogue to MaybeApart here,</span><span>
</span><span id="line-1397"></span><span class="hs-comment">-- but there is not yet a need.</span><span>
</span><span id="line-1398"></span><span>
</span><span id="line-1399"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Unification monad
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-1406"></span><span>
</span><span id="line-1407"></span><span class="hs-keyword">data</span><span> </span><span id="UMEnv"><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-var">UMEnv</span></a></span></span><span>
</span><span id="line-1408"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="UMEnv"><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-var">UMEnv</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="um_unif"><span class="annot"><span class="annottext">UMEnv -&gt; Bool
</span><a href="GHC.Core.Unify.html#um_unif"><span class="hs-identifier hs-var hs-var">um_unif</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#AmIUnifying"><span class="hs-identifier hs-type">AmIUnifying</span></a></span><span>
</span><span id="line-1409"></span><span>
</span><span id="line-1410"></span><span>          </span><span class="hs-special">,</span><span> </span><span id="um_inj_tf"><span class="annot"><span class="annottext">UMEnv -&gt; Bool
</span><a href="GHC.Core.Unify.html#um_inj_tf"><span class="hs-identifier hs-var hs-var">um_inj_tf</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1411"></span><span>            </span><span class="hs-comment">-- Checking for injectivity?</span><span>
</span><span id="line-1412"></span><span>            </span><span class="hs-comment">-- See (end of) Note [Specification of unification]</span><span>
</span><span id="line-1413"></span><span>
</span><span id="line-1414"></span><span>          </span><span class="hs-special">,</span><span> </span><span id="um_rn_env"><span class="annot"><span class="annottext">UMEnv -&gt; RnEnv2
</span><a href="GHC.Core.Unify.html#um_rn_env"><span class="hs-identifier hs-var hs-var">um_rn_env</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a></span><span>
</span><span id="line-1415"></span><span>            </span><span class="hs-comment">-- Renaming InTyVars to OutTyVars; this eliminates</span><span>
</span><span id="line-1416"></span><span>            </span><span class="hs-comment">-- shadowing, and lines up matching foralls on the left</span><span>
</span><span id="line-1417"></span><span>            </span><span class="hs-comment">-- and right</span><span>
</span><span id="line-1418"></span><span>
</span><span id="line-1419"></span><span>          </span><span class="hs-special">,</span><span> </span><span id="um_skols"><span class="annot"><span class="annottext">UMEnv -&gt; VarSet
</span><a href="GHC.Core.Unify.html#um_skols"><span class="hs-identifier hs-var hs-var">um_skols</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a></span><span>
</span><span id="line-1420"></span><span>            </span><span class="hs-comment">-- OutTyVars bound by a forall in this unification;</span><span>
</span><span id="line-1421"></span><span>            </span><span class="hs-comment">-- Do not bind these in the substitution!</span><span>
</span><span id="line-1422"></span><span>            </span><span class="hs-comment">-- See the function tvBindFlag</span><span>
</span><span id="line-1423"></span><span>
</span><span id="line-1424"></span><span>          </span><span class="hs-special">,</span><span> </span><span id="um_bind_fun"><span class="annot"><span class="annottext">UMEnv -&gt; BindFun
</span><a href="GHC.Core.Unify.html#um_bind_fun"><span class="hs-identifier hs-var hs-var">um_bind_fun</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFun"><span class="hs-identifier hs-type">BindFun</span></a></span><span>
</span><span id="line-1425"></span><span>            </span><span class="hs-comment">-- User-supplied BindFlag function,</span><span>
</span><span id="line-1426"></span><span>            </span><span class="hs-comment">-- for variables not in um_skols</span><span>
</span><span id="line-1427"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-1428"></span><span>
</span><span id="line-1429"></span><span class="hs-keyword">data</span><span> </span><span id="UMState"><span class="annot"><a href="GHC.Core.Unify.html#UMState"><span class="hs-identifier hs-var">UMState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="UMState"><span class="annot"><a href="GHC.Core.Unify.html#UMState"><span class="hs-identifier hs-var">UMState</span></a></span></span><span>
</span><span id="line-1430"></span><span>                   </span><span class="hs-special">{</span><span> </span><span id="um_tv_env"><span class="annot"><span class="annottext">UMState -&gt; TvSubstEnv
</span><a href="GHC.Core.Unify.html#um_tv_env"><span class="hs-identifier hs-var hs-var">um_tv_env</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span>
</span><span id="line-1431"></span><span>                   </span><span class="hs-special">,</span><span> </span><span id="um_cv_env"><span class="annot"><span class="annottext">UMState -&gt; CvSubstEnv
</span><a href="GHC.Core.Unify.html#um_cv_env"><span class="hs-identifier hs-var hs-var">um_cv_env</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#CvSubstEnv"><span class="hs-identifier hs-type">CvSubstEnv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1432"></span><span>
</span><span id="line-1433"></span><span class="hs-keyword">newtype</span><span> </span><span id="UM"><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var">UM</span></a></span></span><span> </span><span id="local-6989586621681626634"><span class="annot"><a href="#local-6989586621681626634"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1434"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="UM%27"><span class="annot"><a href="GHC.Core.Unify.html#UM%27"><span class="hs-identifier hs-var">UM'</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="unUM"><span class="annot"><span class="annottext">forall a. UM a -&gt; UMState -&gt; UnifyResultM (UMState, a)
</span><a href="GHC.Core.Unify.html#unUM"><span class="hs-identifier hs-var hs-var">unUM</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMState"><span class="hs-identifier hs-type">UMState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResultM"><span class="hs-identifier hs-type">UnifyResultM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#UMState"><span class="hs-identifier hs-type">UMState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681626634"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1435"></span><span>    </span><span class="hs-comment">-- See Note [The one-shot state monad trick] in GHC.Utils.Monad</span><span>
</span><span id="line-1436"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627331"><span id="local-6989586621681627334"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; UM a -&gt; UM b)
-&gt; (forall a b. a -&gt; UM b -&gt; UM a) -&gt; Functor UM
forall a b. a -&gt; UM b -&gt; UM a
forall a b. (a -&gt; b) -&gt; UM a -&gt; UM b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
$cfmap :: forall a b. (a -&gt; b) -&gt; UM a -&gt; UM b
fmap :: forall a b. (a -&gt; b) -&gt; UM a -&gt; UM b
$c&lt;$ :: forall a b. a -&gt; UM b -&gt; UM a
&lt;$ :: forall a b. a -&gt; UM b -&gt; UM a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#Functor/GHC.Base.html#Functor"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1437"></span><span>
</span><span id="line-1438"></span><span class="hs-keyword">pattern</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621681626637"><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#UMState"><span class="hs-identifier hs-type">UMState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResultM"><span class="hs-identifier hs-type">UnifyResultM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#UMState"><span class="hs-identifier hs-type">UMState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681626637"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681626637"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1439"></span><span class="hs-comment">-- See Note [The one-shot state monad trick] in GHC.Utils.Monad</span><span>
</span><span id="line-1440"></span><span class="hs-keyword">pattern</span><span> </span><span id="UM"><span id="%24mUM"><span id="%24bUM"><span class="annot"><span class="annottext">$mUM :: forall {r} {a}.
UM a
-&gt; ((UMState -&gt; UnifyResultM (UMState, a)) -&gt; r)
-&gt; ((# #) -&gt; r)
-&gt; r
$bUM :: forall a. (UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
</span><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var hs-var hs-var hs-var">UM</span></a></span></span></span></span><span> </span><span class="annot"><a href="#local-6989586621681627339"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM%27"><span class="hs-identifier hs-type">UM'</span></a></span><span> </span><span id="local-6989586621681627339"><span class="annot"><a href="#local-6989586621681627339"><span class="hs-identifier hs-var">m</span></a></span></span><span>
</span><span id="line-1441"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1442"></span><span>    </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var">UM</span></a></span><span> </span><span id="local-6989586621681627340"><span class="annot"><span class="annottext">UMState -&gt; UnifyResultM (UMState, a)
</span><a href="#local-6989586621681627340"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
forall a. (UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
</span><a href="GHC.Core.Unify.html#UM%27"><span class="hs-identifier hs-var">UM'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(UMState -&gt; UnifyResultM (UMState, a))
-&gt; UMState -&gt; UnifyResultM (UMState, a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-identifier hs-var">oneShot</span></span><span> </span><span class="annot"><span class="annottext">UMState -&gt; UnifyResultM (UMState, a)
</span><a href="#local-6989586621681627340"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1443"></span><span>
</span><span id="line-1444"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681627346"><span id="local-6989586621681627349"><span id="local-6989586621681627352"><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#Applicative/GHC.Base.html#Applicative"><span class="hs-identifier hs-type">Applicative</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1445"></span><span>      </span><span id="local-6989586621681627355"><span class="annot"><span class="annottext">pure :: forall a. a -&gt; UM a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var hs-var hs-var hs-var">pure</span></a></span></span><span> </span><span id="local-6989586621681627356"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627356"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
forall a. (UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
</span><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681627357"><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627357"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(UMState, a) -&gt; UnifyResultM (UMState, a)
forall a. a -&gt; UnifyResultM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627357"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627356"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1446"></span><span>      </span><span id="local-6989586621681627359"><span class="annot"><span class="annottext">&lt;*&gt; :: forall a b. UM (a -&gt; b) -&gt; UM a -&gt; UM b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3C%2A%3E/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var hs-var hs-var hs-var">(&lt;*&gt;)</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UM (a -&gt; b) -&gt; UM a -&gt; UM b
forall (m :: * -&gt; *) a b. Monad m =&gt; m (a -&gt; b) -&gt; m a -&gt; m b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#ap/GHC.Base.html#ap"><span class="hs-identifier hs-var">ap</span></a></span><span>
</span><span id="line-1447"></span><span>
</span><span id="line-1448"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681627364"><span id="local-6989586621681627367"><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#Monad/GHC.Base.html#Monad"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1449"></span><span>  </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&gt;&gt;=</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1450"></span><span>  </span><span class="hs-comment">-- See Note [INLINE pragmas and (&gt;&gt;)] in GHC.Utils.Monad</span><span>
</span><span id="line-1451"></span><span>  </span><span id="local-6989586621681627370"><span class="annot"><span class="annottext">UM a
</span><a href="#local-6989586621681627370"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621681627371"><span class="annot"><span class="annottext">&gt;&gt;= :: forall a b. UM a -&gt; (a -&gt; UM b) -&gt; UM b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3E%3E%3D/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var hs-var hs-var hs-var">&gt;&gt;=</span></a></span></span><span> </span><span id="local-6989586621681627372"><span class="annot"><span class="annottext">a -&gt; UM b
</span><a href="#local-6989586621681627372"><span class="hs-identifier hs-var">k</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UMState -&gt; UnifyResultM (UMState, b)) -&gt; UM b
forall a. (UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
</span><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681627373"><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627373"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1452"></span><span>                  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627374"><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627374"><span class="hs-identifier hs-var">state'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627375"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627375"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UM a -&gt; UMState -&gt; UnifyResultM (UMState, a)
forall a. UM a -&gt; UMState -&gt; UnifyResultM (UMState, a)
</span><a href="GHC.Core.Unify.html#unUM"><span class="hs-identifier hs-var">unUM</span></a></span><span> </span><span class="annot"><span class="annottext">UM a
</span><a href="#local-6989586621681627370"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627373"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1453"></span><span>                     </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">UM b -&gt; UMState -&gt; UnifyResultM (UMState, b)
forall a. UM a -&gt; UMState -&gt; UnifyResultM (UMState, a)
</span><a href="GHC.Core.Unify.html#unUM"><span class="hs-identifier hs-var">unUM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; UM b
</span><a href="#local-6989586621681627372"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627375"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627374"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1454"></span><span>
</span><span id="line-1455"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Control.Monad.Fail.html#MonadFail/Control.Monad.Fail.html#MonadFail"><span class="hs-identifier hs-type">MonadFail</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1456"></span><span>    </span><span id="local-6989586621681627381"><span class="annot"><span class="annottext">fail :: forall a. String -&gt; UM a
</span><a href="../../base-4.18.3.0/src/Control.Monad.Fail.html#fail/Control.Monad.Fail.html#fail"><span class="hs-identifier hs-var hs-var hs-var hs-var">fail</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
forall a. (UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
</span><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">UMState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnifyResultM (UMState, a)
forall a. UnifyResultM a
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- failed pattern match</span><span>
</span><span id="line-1457"></span><span>
</span><span id="line-1458"></span><span id="local-6989586621681626592"><span class="annot"><a href="GHC.Core.Unify.html#initUM"><span class="hs-identifier hs-type">initUM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span>  </span><span class="hs-comment">-- subst to extend</span><span>
</span><span id="line-1459"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#CvSubstEnv"><span class="hs-identifier hs-type">CvSubstEnv</span></a></span><span>
</span><span id="line-1460"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681626592"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UnifyResultM"><span class="hs-identifier hs-type">UnifyResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681626592"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1461"></span><span id="initUM"><span class="annot"><span class="annottext">initUM :: forall a. TvSubstEnv -&gt; CvSubstEnv -&gt; UM a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#initUM"><span class="hs-identifier hs-var hs-var">initUM</span></a></span></span><span> </span><span id="local-6989586621681627382"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627382"><span class="hs-identifier hs-var">subst_env</span></a></span></span><span> </span><span id="local-6989586621681627383"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627383"><span class="hs-identifier hs-var">cv_subst_env</span></a></span></span><span> </span><span id="local-6989586621681627384"><span class="annot"><span class="annottext">UM a
</span><a href="#local-6989586621681627384"><span class="hs-identifier hs-var">um</span></a></span></span><span>
</span><span id="line-1462"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UM a -&gt; UMState -&gt; UnifyResultM (UMState, a)
forall a. UM a -&gt; UMState -&gt; UnifyResultM (UMState, a)
</span><a href="GHC.Core.Unify.html#unUM"><span class="hs-identifier hs-var">unUM</span></a></span><span> </span><span class="annot"><span class="annottext">UM a
</span><a href="#local-6989586621681627384"><span class="hs-identifier hs-var">um</span></a></span><span> </span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627385"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1463"></span><span>      </span><span class="annot"><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-type">Unifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMState
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627386"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627386"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; UnifyResultM a
forall a. a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-var">Unifiable</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627386"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1464"></span><span>      </span><span class="annot"><a href="GHC.Core.Unify.html#MaybeApart"><span class="hs-identifier hs-type">MaybeApart</span></a></span><span> </span><span id="local-6989586621681627387"><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627387"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMState
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627388"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627388"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; a -&gt; UnifyResultM a
forall a. MaybeApartReason -&gt; a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#MaybeApart"><span class="hs-identifier hs-var">MaybeApart</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627387"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627388"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1465"></span><span>      </span><span class="annot"><span class="annottext">UnifyResultM (UMState, a)
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnifyResultM a
forall a. UnifyResultM a
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span>
</span><span id="line-1466"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1467"></span><span>    </span><span id="local-6989586621681627385"><span class="annot"><span class="annottext">state :: UMState
</span><a href="#local-6989586621681627385"><span class="hs-identifier hs-var hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMState"><span class="hs-identifier hs-type">UMState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">um_tv_env :: TvSubstEnv
</span><a href="GHC.Core.Unify.html#um_tv_env"><span class="hs-identifier hs-var">um_tv_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627382"><span class="hs-identifier hs-var">subst_env</span></a></span><span>
</span><span id="line-1468"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">um_cv_env :: CvSubstEnv
</span><a href="GHC.Core.Unify.html#um_cv_env"><span class="hs-identifier hs-var">um_cv_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627383"><span class="hs-identifier hs-var">cv_subst_env</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1469"></span><span>
</span><span id="line-1470"></span><span class="annot"><a href="GHC.Core.Unify.html#tvBindFlag"><span class="hs-identifier hs-type">tvBindFlag</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutTyVar"><span class="hs-identifier hs-type">OutTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#BindFlag"><span class="hs-identifier hs-type">BindFlag</span></a></span><span>
</span><span id="line-1471"></span><span id="tvBindFlag"><span class="annot"><span class="annottext">tvBindFlag :: UMEnv -&gt; BindFun
</span><a href="GHC.Core.Unify.html#tvBindFlag"><span class="hs-identifier hs-var hs-var">tvBindFlag</span></a></span></span><span> </span><span id="local-6989586621681627389"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627389"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627390"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627390"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621681627391"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627391"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1472"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627390"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; VarSet
</span><a href="GHC.Core.Unify.html#um_skols"><span class="hs-identifier hs-var">um_skols</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627389"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BindFlag
</span><a href="GHC.Core.Unify.html#Apart"><span class="hs-identifier hs-var">Apart</span></a></span><span>
</span><span id="line-1473"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; BindFun
</span><a href="GHC.Core.Unify.html#um_bind_fun"><span class="hs-identifier hs-var">um_bind_fun</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627389"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627390"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627391"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1474"></span><span>
</span><span id="line-1475"></span><span class="annot"><a href="GHC.Core.Unify.html#getTvSubstEnv"><span class="hs-identifier hs-type">getTvSubstEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span>
</span><span id="line-1476"></span><span id="getTvSubstEnv"><span class="annot"><span class="annottext">getTvSubstEnv :: UM TvSubstEnv
</span><a href="GHC.Core.Unify.html#getTvSubstEnv"><span class="hs-identifier hs-var hs-var">getTvSubstEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UMState -&gt; UnifyResultM (UMState, TvSubstEnv)) -&gt; UM TvSubstEnv
forall a. (UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
</span><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var">UM</span></a></span><span> </span><span class="annot"><span class="annottext">((UMState -&gt; UnifyResultM (UMState, TvSubstEnv)) -&gt; UM TvSubstEnv)
-&gt; (UMState -&gt; UnifyResultM (UMState, TvSubstEnv)) -&gt; UM TvSubstEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681627392"><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627392"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(UMState, TvSubstEnv) -&gt; UnifyResultM (UMState, TvSubstEnv)
forall a. a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-var">Unifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627392"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UMState -&gt; TvSubstEnv
</span><a href="GHC.Core.Unify.html#um_tv_env"><span class="hs-identifier hs-var">um_tv_env</span></a></span><span> </span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627392"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1477"></span><span>
</span><span id="line-1478"></span><span class="annot"><a href="GHC.Core.Unify.html#getCvSubstEnv"><span class="hs-identifier hs-type">getCvSubstEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#CvSubstEnv"><span class="hs-identifier hs-type">CvSubstEnv</span></a></span><span>
</span><span id="line-1479"></span><span id="getCvSubstEnv"><span class="annot"><span class="annottext">getCvSubstEnv :: UM CvSubstEnv
</span><a href="GHC.Core.Unify.html#getCvSubstEnv"><span class="hs-identifier hs-var hs-var">getCvSubstEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UMState -&gt; UnifyResultM (UMState, CvSubstEnv)) -&gt; UM CvSubstEnv
forall a. (UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
</span><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var">UM</span></a></span><span> </span><span class="annot"><span class="annottext">((UMState -&gt; UnifyResultM (UMState, CvSubstEnv)) -&gt; UM CvSubstEnv)
-&gt; (UMState -&gt; UnifyResultM (UMState, CvSubstEnv)) -&gt; UM CvSubstEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681627393"><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627393"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(UMState, CvSubstEnv) -&gt; UnifyResultM (UMState, CvSubstEnv)
forall a. a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-var">Unifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627393"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UMState -&gt; CvSubstEnv
</span><a href="GHC.Core.Unify.html#um_cv_env"><span class="hs-identifier hs-var">um_cv_env</span></a></span><span> </span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627393"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1480"></span><span>
</span><span id="line-1481"></span><span class="annot"><a href="GHC.Core.Unify.html#getSubst"><span class="hs-identifier hs-type">getSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-1482"></span><span id="getSubst"><span class="annot"><span class="annottext">getSubst :: UMEnv -&gt; UM Subst
</span><a href="GHC.Core.Unify.html#getSubst"><span class="hs-identifier hs-var hs-var">getSubst</span></a></span></span><span> </span><span id="local-6989586621681627394"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627394"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681627395"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627395"><span class="hs-identifier hs-var">tv_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UM TvSubstEnv
</span><a href="GHC.Core.Unify.html#getTvSubstEnv"><span class="hs-identifier hs-var">getTvSubstEnv</span></a></span><span>
</span><span id="line-1483"></span><span>                  </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681627396"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627396"><span class="hs-identifier hs-var">cv_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UM CvSubstEnv
</span><a href="GHC.Core.Unify.html#getCvSubstEnv"><span class="hs-identifier hs-var">getCvSubstEnv</span></a></span><span>
</span><span id="line-1484"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627397"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621681627397"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#rnInScopeSet"><span class="hs-identifier hs-var">rnInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMEnv -&gt; RnEnv2
</span><a href="GHC.Core.Unify.html#um_rn_env"><span class="hs-identifier hs-var">um_rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627394"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1485"></span><span>                  </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; UM Subst
forall a. a -&gt; UM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; IdSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkSubst"><span class="hs-identifier hs-var">mkSubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627397"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627395"><span class="hs-identifier hs-var">tv_env</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627396"><span class="hs-identifier hs-var">cv_env</span></a></span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="GHC.Core.TyCo.Subst.html#emptyIdSubstEnv"><span class="hs-identifier hs-var">emptyIdSubstEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1486"></span><span>
</span><span id="line-1487"></span><span class="annot"><a href="GHC.Core.Unify.html#extendTvEnv"><span class="hs-identifier hs-type">extendTvEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1488"></span><span id="extendTvEnv"><span class="annot"><span class="annottext">extendTvEnv :: OutTyVar -&gt; Type -&gt; UM ()
</span><a href="GHC.Core.Unify.html#extendTvEnv"><span class="hs-identifier hs-var hs-var">extendTvEnv</span></a></span></span><span> </span><span id="local-6989586621681627400"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627400"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621681627401"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627401"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UMState -&gt; UnifyResultM (UMState, ())) -&gt; UM ()
forall a. (UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
</span><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var">UM</span></a></span><span> </span><span class="annot"><span class="annottext">((UMState -&gt; UnifyResultM (UMState, ())) -&gt; UM ())
-&gt; (UMState -&gt; UnifyResultM (UMState, ())) -&gt; UM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681627402"><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627402"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1489"></span><span>  </span><span class="annot"><span class="annottext">(UMState, ()) -&gt; UnifyResultM (UMState, ())
forall a. a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-var">Unifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627402"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#um_tv_env"><span class="hs-identifier hs-var">um_tv_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-type">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#um_tv_env"><span class="hs-identifier hs-var">um_tv_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681627402"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681627400"><span class="hs-identifier hs-type">tv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681627401"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1490"></span><span>
</span><span id="line-1491"></span><span class="annot"><a href="GHC.Core.Unify.html#extendCvEnv"><span class="hs-identifier hs-type">extendCvEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1492"></span><span id="extendCvEnv"><span class="annot"><span class="annottext">extendCvEnv :: OutTyVar -&gt; CoercionN -&gt; UM ()
</span><a href="GHC.Core.Unify.html#extendCvEnv"><span class="hs-identifier hs-var hs-var">extendCvEnv</span></a></span></span><span> </span><span id="local-6989586621681627405"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627405"><span class="hs-identifier hs-var">cv</span></a></span></span><span> </span><span id="local-6989586621681627406"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627406"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UMState -&gt; UnifyResultM (UMState, ())) -&gt; UM ()
forall a. (UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
</span><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var">UM</span></a></span><span> </span><span class="annot"><span class="annottext">((UMState -&gt; UnifyResultM (UMState, ())) -&gt; UM ())
-&gt; (UMState -&gt; UnifyResultM (UMState, ())) -&gt; UM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681627407"><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627407"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1493"></span><span>  </span><span class="annot"><span class="annottext">(UMState, ()) -&gt; UnifyResultM (UMState, ())
forall a. a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#Unifiable"><span class="hs-identifier hs-var">Unifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627407"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#um_cv_env"><span class="hs-identifier hs-var">um_cv_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-type">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#um_cv_env"><span class="hs-identifier hs-var">um_cv_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681627407"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681627405"><span class="hs-identifier hs-type">cv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681627406"><span class="hs-identifier hs-type">co</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1494"></span><span>
</span><span id="line-1495"></span><span class="annot"><a href="GHC.Core.Unify.html#umRnBndr2"><span class="hs-identifier hs-type">umRnBndr2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span>
</span><span id="line-1496"></span><span id="umRnBndr2"><span class="annot"><span class="annottext">umRnBndr2 :: UMEnv -&gt; OutTyVar -&gt; OutTyVar -&gt; UMEnv
</span><a href="GHC.Core.Unify.html#umRnBndr2"><span class="hs-identifier hs-var hs-var">umRnBndr2</span></a></span></span><span> </span><span id="local-6989586621681627408"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627408"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627409"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627409"><span class="hs-identifier hs-var">v1</span></a></span></span><span> </span><span id="local-6989586621681627410"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627410"><span class="hs-identifier hs-var">v2</span></a></span></span><span>
</span><span id="line-1497"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627408"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#um_rn_env"><span class="hs-identifier hs-var">um_rn_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681627411"><span class="hs-identifier hs-type">rn_env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#um_skols"><span class="hs-identifier hs-var">um_skols</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#um_skols"><span class="hs-identifier hs-var">um_skols</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681627408"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#extendVarSet"><span class="hs-operator hs-type">`extendVarSet`</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681627413"><span class="hs-identifier hs-type">v'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1498"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1499"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681627411"><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621681627411"><span class="hs-identifier hs-var">rn_env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627413"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627413"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; OutTyVar -&gt; OutTyVar -&gt; (RnEnv2, OutTyVar)
</span><a href="GHC.Types.Var.Env.html#rnBndr2_var"><span class="hs-identifier hs-var">rnBndr2_var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMEnv -&gt; RnEnv2
</span><a href="GHC.Core.Unify.html#um_rn_env"><span class="hs-identifier hs-var">um_rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627408"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627409"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627410"><span class="hs-identifier hs-var">v2</span></a></span><span>
</span><span id="line-1500"></span><span>
</span><span id="line-1501"></span><span class="annot"><a href="GHC.Core.Unify.html#checkRnEnv"><span class="hs-identifier hs-type">checkRnEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1502"></span><span id="checkRnEnv"><span class="annot"><span class="annottext">checkRnEnv :: UMEnv -&gt; VarSet -&gt; UM ()
</span><a href="GHC.Core.Unify.html#checkRnEnv"><span class="hs-identifier hs-var hs-var">checkRnEnv</span></a></span></span><span> </span><span id="local-6989586621681627415"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627415"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627416"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627416"><span class="hs-identifier hs-var">varset</span></a></span></span><span>
</span><span id="line-1503"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627418"><span class="hs-identifier hs-var">skol_vars</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; UM ()
forall a. a -&gt; UM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1504"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627416"><span class="hs-identifier hs-var">varset</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#disjointVarSet"><span class="hs-operator hs-var">`disjointVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627418"><span class="hs-identifier hs-var">skol_vars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; UM ()
forall a. a -&gt; UM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1505"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UM ()
forall a. UM a
</span><a href="GHC.Core.Unify.html#surelyApart"><span class="hs-identifier hs-var">surelyApart</span></a></span><span>
</span><span id="line-1506"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1507"></span><span>    </span><span id="local-6989586621681627418"><span class="annot"><span class="annottext">skol_vars :: VarSet
</span><a href="#local-6989586621681627418"><span class="hs-identifier hs-var hs-var">skol_vars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv -&gt; VarSet
</span><a href="GHC.Core.Unify.html#um_skols"><span class="hs-identifier hs-var">um_skols</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627415"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1508"></span><span>    </span><span class="hs-comment">-- NB: That isEmptyVarSet guard is a critical optimization;</span><span>
</span><span id="line-1509"></span><span>    </span><span class="hs-comment">-- it means we don't have to calculate the free vars of</span><span>
</span><span id="line-1510"></span><span>    </span><span class="hs-comment">-- the type, often saving quite a bit of allocation.</span><span>
</span><span id="line-1511"></span><span>
</span><span id="line-1512"></span><span class="annot"><span class="hs-comment">-- | Converts any SurelyApart to a MaybeApart</span></span><span>
</span><span id="line-1513"></span><span class="annot"><a href="GHC.Core.Unify.html#don%27tBeSoSure"><span class="hs-identifier hs-type">don'tBeSoSure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#MaybeApartReason"><span class="hs-identifier hs-type">MaybeApartReason</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1514"></span><span id="don%27tBeSoSure"><span class="annot"><span class="annottext">don'tBeSoSure :: MaybeApartReason -&gt; UM () -&gt; UM ()
</span><a href="GHC.Core.Unify.html#don%27tBeSoSure"><span class="hs-identifier hs-var hs-var">don'tBeSoSure</span></a></span></span><span> </span><span id="local-6989586621681627420"><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627420"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621681627421"><span class="annot"><span class="annottext">UM ()
</span><a href="#local-6989586621681627421"><span class="hs-identifier hs-var">um</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UMState -&gt; UnifyResultM (UMState, ())) -&gt; UM ()
forall a. (UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
</span><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var">UM</span></a></span><span> </span><span class="annot"><span class="annottext">((UMState -&gt; UnifyResultM (UMState, ())) -&gt; UM ())
-&gt; (UMState -&gt; UnifyResultM (UMState, ())) -&gt; UM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681627422"><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627422"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1515"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UM () -&gt; UMState -&gt; UnifyResultM (UMState, ())
forall a. UM a -&gt; UMState -&gt; UnifyResultM (UMState, a)
</span><a href="GHC.Core.Unify.html#unUM"><span class="hs-identifier hs-var">unUM</span></a></span><span> </span><span class="annot"><span class="annottext">UM ()
</span><a href="#local-6989586621681627421"><span class="hs-identifier hs-var">um</span></a></span><span> </span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627422"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1516"></span><span>    </span><span class="annot"><span class="annottext">UnifyResultM (UMState, ())
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; (UMState, ()) -&gt; UnifyResultM (UMState, ())
forall a. MaybeApartReason -&gt; a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#MaybeApart"><span class="hs-identifier hs-var">MaybeApart</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627420"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627422"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1517"></span><span>    </span><span id="local-6989586621681627423"><span class="annot"><span class="annottext">UnifyResultM (UMState, ())
</span><a href="#local-6989586621681627423"><span class="hs-identifier hs-var">other</span></a></span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnifyResultM (UMState, ())
</span><a href="#local-6989586621681627423"><span class="hs-identifier hs-var">other</span></a></span><span>
</span><span id="line-1518"></span><span>
</span><span id="line-1519"></span><span class="annot"><a href="GHC.Core.Unify.html#umRnOccL"><span class="hs-identifier hs-type">umRnOccL</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span>
</span><span id="line-1520"></span><span id="umRnOccL"><span class="annot"><span class="annottext">umRnOccL :: UMEnv -&gt; OutTyVar -&gt; OutTyVar
</span><a href="GHC.Core.Unify.html#umRnOccL"><span class="hs-identifier hs-var hs-var">umRnOccL</span></a></span></span><span> </span><span id="local-6989586621681627424"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627424"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627425"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627425"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; OutTyVar -&gt; OutTyVar
</span><a href="GHC.Types.Var.Env.html#rnOccL"><span class="hs-identifier hs-var">rnOccL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMEnv -&gt; RnEnv2
</span><a href="GHC.Core.Unify.html#um_rn_env"><span class="hs-identifier hs-var">um_rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627424"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627425"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1521"></span><span>
</span><span id="line-1522"></span><span class="annot"><a href="GHC.Core.Unify.html#umRnOccR"><span class="hs-identifier hs-type">umRnOccR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span>
</span><span id="line-1523"></span><span id="umRnOccR"><span class="annot"><span class="annottext">umRnOccR :: UMEnv -&gt; OutTyVar -&gt; OutTyVar
</span><a href="GHC.Core.Unify.html#umRnOccR"><span class="hs-identifier hs-var hs-var">umRnOccR</span></a></span></span><span> </span><span id="local-6989586621681627427"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627427"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627428"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627428"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; OutTyVar -&gt; OutTyVar
</span><a href="GHC.Types.Var.Env.html#rnOccR"><span class="hs-identifier hs-var">rnOccR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMEnv -&gt; RnEnv2
</span><a href="GHC.Core.Unify.html#um_rn_env"><span class="hs-identifier hs-var">um_rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627427"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627428"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1524"></span><span>
</span><span id="line-1525"></span><span class="annot"><a href="GHC.Core.Unify.html#umSwapRn"><span class="hs-identifier hs-type">umSwapRn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UMEnv"><span class="hs-identifier hs-type">UMEnv</span></a></span><span>
</span><span id="line-1526"></span><span id="umSwapRn"><span class="annot"><span class="annottext">umSwapRn :: UMEnv -&gt; UMEnv
</span><a href="GHC.Core.Unify.html#umSwapRn"><span class="hs-identifier hs-var hs-var">umSwapRn</span></a></span></span><span> </span><span id="local-6989586621681627430"><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627430"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UMEnv
</span><a href="#local-6989586621681627430"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#um_rn_env"><span class="hs-identifier hs-var">um_rn_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#rnSwap"><span class="hs-identifier hs-type">rnSwap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#um_rn_env"><span class="hs-identifier hs-var">um_rn_env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681627430"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1527"></span><span>
</span><span id="line-1528"></span><span class="annot"><a href="GHC.Core.Unify.html#maybeApart"><span class="hs-identifier hs-type">maybeApart</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#MaybeApartReason"><span class="hs-identifier hs-type">MaybeApartReason</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1529"></span><span id="maybeApart"><span class="annot"><span class="annottext">maybeApart :: MaybeApartReason -&gt; UM ()
</span><a href="GHC.Core.Unify.html#maybeApart"><span class="hs-identifier hs-var hs-var">maybeApart</span></a></span></span><span> </span><span id="local-6989586621681627432"><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627432"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UMState -&gt; UnifyResultM (UMState, ())) -&gt; UM ()
forall a. (UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
</span><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681627433"><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627433"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaybeApartReason -&gt; (UMState, ()) -&gt; UnifyResultM (UMState, ())
forall a. MaybeApartReason -&gt; a -&gt; UnifyResultM a
</span><a href="GHC.Core.Unify.html#MaybeApart"><span class="hs-identifier hs-var">MaybeApart</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeApartReason
</span><a href="#local-6989586621681627432"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UMState
</span><a href="#local-6989586621681627433"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1530"></span><span>
</span><span id="line-1531"></span><span id="local-6989586621681626627"><span class="annot"><a href="GHC.Core.Unify.html#surelyApart"><span class="hs-identifier hs-type">surelyApart</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-type">UM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681626627"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1532"></span><span id="surelyApart"><span class="annot"><span class="annottext">surelyApart :: forall a. UM a
</span><a href="GHC.Core.Unify.html#surelyApart"><span class="hs-identifier hs-var hs-var">surelyApart</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
forall a. (UMState -&gt; UnifyResultM (UMState, a)) -&gt; UM a
</span><a href="GHC.Core.Unify.html#UM"><span class="hs-identifier hs-var">UM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">UMState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnifyResultM (UMState, a)
forall a. UnifyResultM a
</span><a href="GHC.Core.Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1533"></span><span>
</span><span id="line-1534"></span><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
            Matching a (lifted) type against a coercion
%*                                                                      *
%************************************************************************

This section defines essentially an inverse to liftCoSubst. It is defined
here to avoid a dependency from Coercion on this module.

-}</span><span>
</span><span id="line-1545"></span><span>
</span><span id="line-1546"></span><span class="hs-keyword">data</span><span> </span><span id="MatchEnv"><span class="annot"><a href="GHC.Core.Unify.html#MatchEnv"><span class="hs-identifier hs-var">MatchEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ME"><span class="annot"><a href="GHC.Core.Unify.html#ME"><span class="hs-identifier hs-var">ME</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="me_tmpls"><span class="annot"><span class="annottext">MatchEnv -&gt; VarSet
</span><a href="GHC.Core.Unify.html#me_tmpls"><span class="hs-identifier hs-var hs-var">me_tmpls</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a></span><span>
</span><span id="line-1547"></span><span>                   </span><span class="hs-special">,</span><span> </span><span id="me_env"><span class="annot"><span class="annottext">MatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Unify.html#me_env"><span class="hs-identifier hs-var hs-var">me_env</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1548"></span><span>
</span><span id="line-1549"></span><span class="hs-comment">-- | 'liftCoMatch' is sort of inverse to 'liftCoSubst'.  In particular, if</span><span>
</span><span id="line-1550"></span><span class="hs-comment">--   @liftCoMatch vars ty co == Just s@, then @liftCoSubst s ty == co@,</span><span>
</span><span id="line-1551"></span><span class="hs-comment">--   where @==@ there means that the result of 'liftCoSubst' has the same</span><span>
</span><span id="line-1552"></span><span class="hs-comment">--   type as the original co; but may be different under the hood.</span><span>
</span><span id="line-1553"></span><span class="hs-comment">--   That is, it matches a type against a coercion of the same</span><span>
</span><span id="line-1554"></span><span class="hs-comment">--   &quot;shape&quot;, and returns a lifting substitution which could have been</span><span>
</span><span id="line-1555"></span><span class="hs-comment">--   used to produce the given coercion from the given type.</span><span>
</span><span id="line-1556"></span><span class="hs-comment">--   Note that this function is incomplete -- it might return Nothing</span><span>
</span><span id="line-1557"></span><span class="hs-comment">--   when there does indeed exist a possible lifting context.</span><span>
</span><span id="line-1558"></span><span class="hs-comment">--</span><span>
</span><span id="line-1559"></span><span class="hs-comment">-- This function is incomplete in that it doesn't respect the equality</span><span>
</span><span id="line-1560"></span><span class="hs-comment">-- in `eqType`. That is, it's possible that this will succeed for t1 and</span><span>
</span><span id="line-1561"></span><span class="hs-comment">-- fail for t2, even when t1 `eqType` t2. That's because it depends on</span><span>
</span><span id="line-1562"></span><span class="hs-comment">-- there being a very similar structure between the type and the coercion.</span><span>
</span><span id="line-1563"></span><span class="hs-comment">-- This incompleteness shouldn't be all that surprising, especially because</span><span>
</span><span id="line-1564"></span><span class="hs-comment">-- it depends on the structure of the coercion, which is a silly thing to do.</span><span>
</span><span id="line-1565"></span><span class="hs-comment">--</span><span>
</span><span id="line-1566"></span><span class="hs-comment">-- The lifting context produced doesn't have to be exacting in the roles</span><span>
</span><span id="line-1567"></span><span class="hs-comment">-- of the mappings. This is because any use of the lifting context will</span><span>
</span><span id="line-1568"></span><span class="hs-comment">-- also require a desired role. Thus, this algorithm prefers mapping to</span><span>
</span><span id="line-1569"></span><span class="hs-comment">-- nominal coercions where it can do so.</span><span>
</span><span id="line-1570"></span><span class="annot"><a href="GHC.Core.Unify.html#liftCoMatch"><span class="hs-identifier hs-type">liftCoMatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a></span><span>
</span><span id="line-1571"></span><span id="liftCoMatch"><span class="annot"><span class="annottext">liftCoMatch :: VarSet -&gt; Type -&gt; CoercionN -&gt; Maybe LiftingContext
</span><a href="GHC.Core.Unify.html#liftCoMatch"><span class="hs-identifier hs-var hs-var">liftCoMatch</span></a></span></span><span> </span><span id="local-6989586621681627438"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627438"><span class="hs-identifier hs-var">tmpls</span></a></span></span><span> </span><span id="local-6989586621681627439"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627439"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681627440"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627440"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-1572"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681627441"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627441"><span class="hs-identifier hs-var">cenv1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627443"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627445"><span class="hs-identifier hs-var">ki</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627446"><span class="hs-identifier hs-var">ki_co</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627447"><span class="hs-identifier hs-var">ki_ki_co</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627447"><span class="hs-identifier hs-var">ki_ki_co</span></a></span><span>
</span><span id="line-1573"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681627448"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627448"><span class="hs-identifier hs-var">cenv2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627443"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627441"><span class="hs-identifier hs-var">cenv1</span></a></span><span>       </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627439"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627440"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1574"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627449"><span class="hs-identifier hs-var">co_lkind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627450"><span class="hs-identifier hs-var">co_rkind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1575"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">LiftingContext -&gt; Maybe LiftingContext
forall a. a -&gt; Maybe a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; CvSubstEnv -&gt; LiftingContext
</span><a href="GHC.Core.Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627452"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627448"><span class="hs-identifier hs-var">cenv2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1576"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1577"></span><span>    </span><span id="local-6989586621681627443"><span class="annot"><span class="annottext">menv :: MatchEnv
</span><a href="#local-6989586621681627443"><span class="hs-identifier hs-var hs-var">menv</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#ME"><span class="hs-identifier hs-type">ME</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">me_tmpls :: VarSet
</span><a href="GHC.Core.Unify.html#me_tmpls"><span class="hs-identifier hs-var">me_tmpls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627438"><span class="hs-identifier hs-var">tmpls</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">me_env :: RnEnv2
</span><a href="GHC.Core.Unify.html#me_env"><span class="hs-identifier hs-var">me_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; RnEnv2
</span><a href="GHC.Types.Var.Env.html#mkRnEnv2"><span class="hs-identifier hs-var">mkRnEnv2</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627452"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1578"></span><span>    </span><span id="local-6989586621681627452"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621681627452"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627438"><span class="hs-identifier hs-var">tmpls</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627440"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1579"></span><span>    </span><span class="hs-comment">-- Like tcMatchTy, assume all the interesting variables</span><span>
</span><span id="line-1580"></span><span>    </span><span class="hs-comment">-- in ty are in tmpls</span><span>
</span><span id="line-1581"></span><span>
</span><span id="line-1582"></span><span>    </span><span id="local-6989586621681627445"><span class="annot"><span class="annottext">ki :: Type
</span><a href="#local-6989586621681627445"><span class="hs-identifier hs-var hs-var">ki</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627439"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1583"></span><span>    </span><span id="local-6989586621681627446"><span class="annot"><span class="annottext">ki_co :: CoercionN
</span><a href="#local-6989586621681627446"><span class="hs-identifier hs-var hs-var">ki_co</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627440"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1584"></span><span>    </span><span id="local-6989586621681627447"><span class="annot"><span class="annottext">ki_ki_co :: CoercionN
</span><a href="#local-6989586621681627447"><span class="hs-identifier hs-var hs-var">ki_ki_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a></span><span>
</span><span id="line-1585"></span><span>
</span><span id="line-1586"></span><span>    </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681627449"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627449"><span class="hs-identifier hs-var">co_lkind</span></a></span></span><span> </span><span id="local-6989586621681627450"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627450"><span class="hs-identifier hs-var">co_rkind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627446"><span class="hs-identifier hs-var">ki_co</span></a></span><span>
</span><span id="line-1587"></span><span>
</span><span id="line-1588"></span><span class="annot"><span class="hs-comment">-- | 'ty_co_match' does all the actual work for 'liftCoMatch'.</span></span><span>
</span><span id="line-1589"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-type">ty_co_match</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#MatchEnv"><span class="hs-identifier hs-type">MatchEnv</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ ambient helpful info</span></span><span>
</span><span id="line-1590"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ incoming subst</span></span><span>
</span><span id="line-1591"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>       </span><span class="annot"><span class="hs-comment">-- ^ ty, type to match</span></span><span>
</span><span id="line-1592"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ co :: lty ~r rty, coercion to match against</span></span><span>
</span><span id="line-1593"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ :: kind(lsubst(ty)) ~N kind(lty)</span></span><span>
</span><span id="line-1594"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ :: kind(rsubst(ty)) ~N kind(rty)</span></span><span>
</span><span id="line-1595"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a></span><span>
</span><span id="line-1596"></span><span>   </span><span class="hs-comment">-- ^ Just env ==&gt; liftCoSubst Nominal env ty == co, modulo roles.</span><span>
</span><span id="line-1597"></span><span>   </span><span class="hs-comment">-- Also: Just env ==&gt; lsubst(ty) == lty and rsubst(ty) == rty,</span><span>
</span><span id="line-1598"></span><span>   </span><span class="hs-comment">-- where lsubst = lcSubstLeft(env) and rsubst = lcSubstRight(env)</span><span>
</span><span id="line-1599"></span><span id="ty_co_match"><span class="annot"><span class="annottext">ty_co_match :: MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var hs-var">ty_co_match</span></a></span></span><span> </span><span id="local-6989586621681627457"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627457"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627458"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627458"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681627459"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627459"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681627460"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627460"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621681627461"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627461"><span class="hs-identifier hs-var">lkco</span></a></span></span><span> </span><span id="local-6989586621681627462"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627462"><span class="hs-identifier hs-var">rkco</span></a></span></span><span>
</span><span id="line-1600"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681627463"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627463"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627459"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627457"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627458"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627463"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627460"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627461"><span class="hs-identifier hs-var">lkco</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627462"><span class="hs-identifier hs-var">rkco</span></a></span><span>
</span><span id="line-1601"></span><span>
</span><span id="line-1602"></span><span>  </span><span class="hs-comment">-- handle Refl case:</span><span>
</span><span id="line-1603"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627459"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; CvSubstEnv -&gt; Bool
forall a. VarSet -&gt; VarEnv a -&gt; Bool
</span><a href="#local-6989586621681627464"><span class="hs-operator hs-var">`isNotInDomainOf`</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627458"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1604"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627465"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627465"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; Maybe (Type, Role)
</span><a href="GHC.Core.Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627460"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1605"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627459"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627465"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-1606"></span><span>    </span><span class="hs-comment">-- Why `eqType` and not `tcEqType`? Because this function is only used</span><span>
</span><span id="line-1607"></span><span>    </span><span class="hs-comment">-- during coercion optimisation, after type-checking has finished.</span><span>
</span><span id="line-1608"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; Maybe CvSubstEnv
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627458"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1609"></span><span>
</span><span id="line-1610"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1611"></span><span>    </span><span id="local-6989586621681626656"><span class="annot"><a href="#local-6989586621681627464"><span class="hs-identifier hs-type">isNotInDomainOf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681626656"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-1612"></span><span>    </span><span id="local-6989586621681627464"><span class="annot"><span class="annottext">isNotInDomainOf :: forall a. VarSet -&gt; VarEnv a -&gt; Bool
</span><a href="#local-6989586621681627464"><span class="hs-identifier hs-var hs-var">isNotInDomainOf</span></a></span></span><span> </span><span id="local-6989586621681627467"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627467"><span class="hs-identifier hs-var">set</span></a></span></span><span> </span><span id="local-6989586621681627468"><span class="annot"><span class="annottext">VarEnv a
</span><a href="#local-6989586621681627468"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-1613"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutTyVar -&gt; Bool) -&gt; VarSet -&gt; Bool
</span><a href="#local-6989586621681627469"><span class="hs-identifier hs-var">noneSet</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681627470"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627470"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; VarEnv a -&gt; Bool
forall a. OutTyVar -&gt; VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemVarEnv"><span class="hs-identifier hs-var">elemVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627470"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv a
</span><a href="#local-6989586621681627468"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681627467"><span class="hs-identifier hs-var">set</span></a></span><span>
</span><span id="line-1614"></span><span>
</span><span id="line-1615"></span><span>    </span><span class="annot"><a href="#local-6989586621681627469"><span class="hs-identifier hs-type">noneSet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1616"></span><span>    </span><span id="local-6989586621681627469"><span class="annot"><span class="annottext">noneSet :: (OutTyVar -&gt; Bool) -&gt; VarSet -&gt; Bool
</span><a href="#local-6989586621681627469"><span class="hs-identifier hs-var hs-var">noneSet</span></a></span></span><span> </span><span id="local-6989586621681627472"><span class="annot"><span class="annottext">OutTyVar -&gt; Bool
</span><a href="#local-6989586621681627472"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutTyVar -&gt; Bool) -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#allVarSet"><span class="hs-identifier hs-var">allVarSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (OutTyVar -&gt; Bool) -&gt; OutTyVar -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; Bool
</span><a href="#local-6989586621681627472"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1617"></span><span>
</span><span id="line-1618"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span id="local-6989586621681627474"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627474"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627475"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627475"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681627476"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627476"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681627477"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627477"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621681627478"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627478"><span class="hs-identifier hs-var">lkco</span></a></span></span><span> </span><span id="local-6989586621681627479"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627479"><span class="hs-identifier hs-var">rkco</span></a></span></span><span>
</span><span id="line-1619"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621681627480"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627480"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span id="local-6989586621681627481"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627481"><span class="hs-identifier hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627476"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1620"></span><span>     </span><span class="hs-comment">-- See Note [Matching in the presence of casts (1)]</span><span>
</span><span id="line-1621"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627482"><span class="annot"><span class="annottext">empty_subst :: Subst
</span><a href="#local-6989586621681627482"><span class="hs-identifier hs-var hs-var">empty_subst</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RnEnv2 -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#rnInScopeSet"><span class="hs-identifier hs-var">rnInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Unify.html#me_env"><span class="hs-identifier hs-var">me_env</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627474"><span class="hs-identifier hs-var">menv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1622"></span><span>        </span><span id="local-6989586621681627483"><span class="annot"><span class="annottext">substed_co_l :: CoercionN
</span><a href="#local-6989586621681627483"><span class="hs-identifier hs-var hs-var">substed_co_l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; CoercionN -&gt; CoercionN
Subst -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.Coercion.html#liftEnvSubstLeft"><span class="hs-identifier hs-var">liftEnvSubstLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681627482"><span class="hs-identifier hs-var">empty_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627475"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627481"><span class="hs-identifier hs-var">co'</span></a></span><span>
</span><span id="line-1623"></span><span>        </span><span id="local-6989586621681627485"><span class="annot"><span class="annottext">substed_co_r :: CoercionN
</span><a href="#local-6989586621681627485"><span class="hs-identifier hs-var hs-var">substed_co_r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; CoercionN -&gt; CoercionN
Subst -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.Coercion.html#liftEnvSubstRight"><span class="hs-identifier hs-var">liftEnvSubstRight</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681627482"><span class="hs-identifier hs-var">empty_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627475"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627481"><span class="hs-identifier hs-var">co'</span></a></span><span>
</span><span id="line-1624"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-1625"></span><span>    </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627474"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627475"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627480"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627477"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627483"><span class="hs-identifier hs-var">substed_co_l</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627478"><span class="hs-identifier hs-var">lkco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1626"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627485"><span class="hs-identifier hs-var">substed_co_r</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627479"><span class="hs-identifier hs-var">rkco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1627"></span><span>
</span><span id="line-1628"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SymCo"><span class="hs-identifier hs-type">SymCo</span></a></span><span> </span><span id="local-6989586621681627488"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627488"><span class="hs-identifier hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627477"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1629"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; CvSubstEnv
</span><a href="GHC.Core.Coercion.html#swapLiftCoEnv"><span class="hs-identifier hs-var">swapLiftCoEnv</span></a></span><span> </span><span class="annot"><span class="annottext">(CvSubstEnv -&gt; CvSubstEnv) -&gt; Maybe CvSubstEnv -&gt; Maybe CvSubstEnv
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627474"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CvSubstEnv -&gt; CvSubstEnv
</span><a href="GHC.Core.Coercion.html#swapLiftCoEnv"><span class="hs-identifier hs-var">swapLiftCoEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627475"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627476"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627488"><span class="hs-identifier hs-var">co'</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627479"><span class="hs-identifier hs-var">rkco</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627478"><span class="hs-identifier hs-var">lkco</span></a></span><span>
</span><span id="line-1630"></span><span>
</span><span id="line-1631"></span><span>  </span><span class="hs-comment">-- Match a type variable against a non-refl coercion</span><span>
</span><span id="line-1632"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span id="local-6989586621681627490"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627490"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627491"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627491"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621681627492"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627492"><span class="hs-identifier hs-var">tv1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627493"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627493"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621681627494"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627494"><span class="hs-identifier hs-var">lkco</span></a></span></span><span> </span><span id="local-6989586621681627495"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627495"><span class="hs-identifier hs-var">rkco</span></a></span></span><span>
</span><span id="line-1633"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681627496"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627496"><span class="hs-identifier hs-var">co1'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; OutTyVar -&gt; Maybe CoercionN
forall a. VarEnv a -&gt; OutTyVar -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627491"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627497"><span class="hs-identifier hs-var">tv1'</span></a></span><span> </span><span class="hs-comment">-- tv1' is already bound to co1</span><span>
</span><span id="line-1634"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; CoercionN -&gt; CoercionN -&gt; Bool
</span><a href="GHC.Core.Coercion.html#eqCoercionX"><span class="hs-identifier hs-var">eqCoercionX</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RnEnv2 -&gt; RnEnv2
</span><a href="GHC.Types.Var.Env.html#nukeRnEnvL"><span class="hs-identifier hs-var">nukeRnEnvL</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621681627500"><span class="hs-identifier hs-var">rn_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627496"><span class="hs-identifier hs-var">co1'</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627493"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1635"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; Maybe CvSubstEnv
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627491"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1636"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe CvSubstEnv
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>       </span><span class="hs-comment">-- no match since tv1 matches two different coercions</span><span>
</span><span id="line-1637"></span><span>
</span><span id="line-1638"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627497"><span class="hs-identifier hs-var">tv1'</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-operator hs-var">`elemVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv -&gt; VarSet
</span><a href="GHC.Core.Unify.html#me_tmpls"><span class="hs-identifier hs-var">me_tmpls</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627490"><span class="hs-identifier hs-var">menv</span></a></span><span>           </span><span class="hs-comment">-- tv1' is a template var</span><span>
</span><span id="line-1639"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(OutTyVar -&gt; Bool) -&gt; [OutTyVar] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#any/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RnEnv2 -&gt; OutTyVar -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#inRnEnvR"><span class="hs-identifier hs-var">inRnEnvR</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621681627500"><span class="hs-identifier hs-var">rn_env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN -&gt; [OutTyVar]
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfCoList"><span class="hs-identifier hs-var">tyCoVarsOfCoList</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627493"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1640"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe CvSubstEnv
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>      </span><span class="hs-comment">-- occurs check failed</span><span>
</span><span id="line-1641"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; Maybe CvSubstEnv
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(CvSubstEnv -&gt; Maybe CvSubstEnv) -&gt; CvSubstEnv -&gt; Maybe CvSubstEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; OutTyVar -&gt; CoercionN -&gt; CvSubstEnv
forall a. VarEnv a -&gt; OutTyVar -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627491"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627497"><span class="hs-identifier hs-var">tv1'</span></a></span><span> </span><span class="annot"><span class="annottext">(CoercionN -&gt; CvSubstEnv) -&gt; CoercionN -&gt; CvSubstEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1642"></span><span>                </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#castCoercionKind"><span class="hs-identifier hs-var">castCoercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627493"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627494"><span class="hs-identifier hs-var">lkco</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627495"><span class="hs-identifier hs-var">rkco</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1643"></span><span>
</span><span id="line-1644"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1645"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CvSubstEnv
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1646"></span><span>
</span><span id="line-1647"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1648"></span><span>    </span><span id="local-6989586621681627500"><span class="annot"><span class="annottext">rn_env :: RnEnv2
</span><a href="#local-6989586621681627500"><span class="hs-identifier hs-var hs-var">rn_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Unify.html#me_env"><span class="hs-identifier hs-var">me_env</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627490"><span class="hs-identifier hs-var">menv</span></a></span><span>
</span><span id="line-1649"></span><span>    </span><span id="local-6989586621681627497"><span class="annot"><span class="annottext">tv1' :: OutTyVar
</span><a href="#local-6989586621681627497"><span class="hs-identifier hs-var hs-var">tv1'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; OutTyVar -&gt; OutTyVar
</span><a href="GHC.Types.Var.Env.html#rnOccL"><span class="hs-identifier hs-var">rnOccL</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621681627500"><span class="hs-identifier hs-var">rn_env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627492"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-1650"></span><span>
</span><span id="line-1651"></span><span>  </span><span class="hs-comment">-- just look through SubCo's. We don't really care about roles here.</span><span>
</span><span id="line-1652"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span id="local-6989586621681627503"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627503"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627504"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627504"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681627505"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627505"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#SubCo"><span class="hs-identifier hs-type">SubCo</span></a></span><span> </span><span id="local-6989586621681627507"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627507"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627508"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627508"><span class="hs-identifier hs-var">lkco</span></a></span></span><span> </span><span id="local-6989586621681627509"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627509"><span class="hs-identifier hs-var">rkco</span></a></span></span><span>
</span><span id="line-1653"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627503"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627504"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627505"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627507"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627508"><span class="hs-identifier hs-var">lkco</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627509"><span class="hs-identifier hs-var">rkco</span></a></span><span>
</span><span id="line-1654"></span><span>
</span><span id="line-1655"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span id="local-6989586621681627510"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627510"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627511"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627511"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621681627512"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627512"><span class="hs-identifier hs-var">ty1a</span></a></span></span><span> </span><span id="local-6989586621681627513"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627513"><span class="hs-identifier hs-var">ty1b</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627514"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627514"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621681627515"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627515"><span class="hs-identifier hs-var">_lkco</span></a></span></span><span> </span><span id="local-6989586621681627516"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627516"><span class="hs-identifier hs-var">_rkco</span></a></span></span><span>
</span><span id="line-1656"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627517"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627517"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627518"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627518"><span class="hs-identifier hs-var">arg2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; Maybe (CoercionN, CoercionN)
</span><a href="GHC.Core.Coercion.html#splitAppCo_maybe"><span class="hs-identifier hs-var">splitAppCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627514"><span class="hs-identifier hs-var">co</span></a></span><span>     </span><span class="hs-comment">-- c.f. Unify.match on AppTy</span><span>
</span><span id="line-1657"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; [Type]
-&gt; CoercionN
-&gt; [CoercionN]
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match_app"><span class="hs-identifier hs-var">ty_co_match_app</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627510"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627511"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627512"><span class="hs-identifier hs-var">ty1a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627513"><span class="hs-identifier hs-var">ty1b</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627517"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627518"><span class="hs-identifier hs-var">arg2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1658"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span id="local-6989586621681627521"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627521"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627522"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627522"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681627523"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627523"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppCo"><span class="hs-identifier hs-type">AppCo</span></a></span><span> </span><span id="local-6989586621681627525"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627525"><span class="hs-identifier hs-var">co2</span></a></span></span><span> </span><span id="local-6989586621681627526"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627526"><span class="hs-identifier hs-var">arg2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627527"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627527"><span class="hs-identifier hs-var">_lkco</span></a></span></span><span> </span><span id="local-6989586621681627528"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627528"><span class="hs-identifier hs-var">_rkco</span></a></span></span><span>
</span><span id="line-1659"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627529"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627529"><span class="hs-identifier hs-var">ty1a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627530"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627530"><span class="hs-identifier hs-var">ty1b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Maybe (Type, Type)
Type -&gt; Maybe (Type, Type)
</span><a href="GHC.Core.Type.html#splitAppTyNoView_maybe"><span class="hs-identifier hs-var">splitAppTyNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627523"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1660"></span><span>       </span><span class="hs-comment">-- yes, the one from Type, not TcType; this is for coercion optimization</span><span>
</span><span id="line-1661"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; [Type]
-&gt; CoercionN
-&gt; [CoercionN]
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match_app"><span class="hs-identifier hs-var">ty_co_match_app</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627521"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627522"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627529"><span class="hs-identifier hs-var">ty1a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627530"><span class="hs-identifier hs-var">ty1b</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627525"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627526"><span class="hs-identifier hs-var">arg2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1662"></span><span>
</span><span id="line-1663"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span id="local-6989586621681627531"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627531"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627532"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627532"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621681627533"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627533"><span class="hs-identifier hs-var">tc1</span></a></span></span><span> </span><span id="local-6989586621681627534"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627534"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConAppCo"><span class="hs-identifier hs-type">TyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681627536"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627536"><span class="hs-identifier hs-var">tc2</span></a></span></span><span> </span><span id="local-6989586621681627537"><span class="annot"><span class="annottext">[CoercionN]
</span><a href="#local-6989586621681627537"><span class="hs-identifier hs-var">cos</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627538"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627538"><span class="hs-identifier hs-var">_lkco</span></a></span></span><span> </span><span id="local-6989586621681627539"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627539"><span class="hs-identifier hs-var">_rkco</span></a></span></span><span>
</span><span id="line-1664"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; TyCon
-&gt; [Type]
-&gt; TyCon
-&gt; [CoercionN]
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match_tc"><span class="hs-identifier hs-var">ty_co_match_tc</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627531"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627532"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627533"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627534"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627536"><span class="hs-identifier hs-var">tc2</span></a></span><span> </span><span class="annot"><span class="annottext">[CoercionN]
</span><a href="#local-6989586621681627537"><span class="hs-identifier hs-var">cos</span></a></span><span>
</span><span id="line-1665"></span><span>
</span><span id="line-1666"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span id="local-6989586621681627541"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627541"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627542"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627542"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_mult :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681627544"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627544"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681627546"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627546"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681627548"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627548"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1667"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunCo"><span class="hs-identifier hs-type">FunCo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fco_mult :: CoercionN -&gt; CoercionN
</span><a href="GHC.Core.TyCo.Rep.html#fco_mult"><span class="hs-identifier hs-var">fco_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681627551"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627551"><span class="hs-identifier hs-var">co_w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fco_arg :: CoercionN -&gt; CoercionN
</span><a href="GHC.Core.TyCo.Rep.html#fco_arg"><span class="hs-identifier hs-var">fco_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681627553"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627553"><span class="hs-identifier hs-var">co1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fco_res :: CoercionN -&gt; CoercionN
</span><a href="GHC.Core.TyCo.Rep.html#fco_res"><span class="hs-identifier hs-var">fco_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681627555"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627555"><span class="hs-identifier hs-var">co2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627556"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627556"><span class="hs-identifier hs-var">_lkco</span></a></span></span><span> </span><span id="local-6989586621681627557"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627557"><span class="hs-identifier hs-var">_rkco</span></a></span></span><span>
</span><span id="line-1668"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MatchEnv -&gt; CvSubstEnv -&gt; [Type] -&gt; [CoercionN] -&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match_args"><span class="hs-identifier hs-var">ty_co_match_args</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627541"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627542"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627544"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">,</span><span>    </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627559"><span class="hs-identifier hs-var">rep1</span></a></span><span class="hs-special">,</span><span>    </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627560"><span class="hs-identifier hs-var">rep2</span></a></span><span class="hs-special">,</span><span>    </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627546"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627548"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1669"></span><span>                                </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627551"><span class="hs-identifier hs-var">co_w</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627561"><span class="hs-identifier hs-var">co1_rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627562"><span class="hs-identifier hs-var">co2_rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627553"><span class="hs-identifier hs-var">co1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627555"><span class="hs-identifier hs-var">co2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1670"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1671"></span><span>     </span><span id="local-6989586621681627559"><span class="annot"><span class="annottext">rep1 :: Type
</span><a href="#local-6989586621681627559"><span class="hs-identifier hs-var hs-var">rep1</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#getRuntimeRep"><span class="hs-identifier hs-var">getRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627546"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1672"></span><span>     </span><span id="local-6989586621681627560"><span class="annot"><span class="annottext">rep2 :: Type
</span><a href="#local-6989586621681627560"><span class="hs-identifier hs-var hs-var">rep2</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#getRuntimeRep"><span class="hs-identifier hs-var">getRuntimeRep</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627548"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1673"></span><span>     </span><span id="local-6989586621681627561"><span class="annot"><span class="annottext">co1_rep :: CoercionN
</span><a href="#local-6989586621681627561"><span class="hs-identifier hs-var hs-var">co1_rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CoercionN -&gt; CoercionN
CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkRuntimeRepCo"><span class="hs-identifier hs-var">mkRuntimeRepCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627553"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-1674"></span><span>     </span><span id="local-6989586621681627562"><span class="annot"><span class="annottext">co2_rep :: CoercionN
</span><a href="#local-6989586621681627562"><span class="hs-identifier hs-var hs-var">co2_rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CoercionN -&gt; CoercionN
CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkRuntimeRepCo"><span class="hs-identifier hs-var">mkRuntimeRepCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627555"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-1675"></span><span>    </span><span class="hs-comment">-- NB: we include the RuntimeRep arguments in the matching;</span><span>
</span><span id="line-1676"></span><span>    </span><span class="hs-comment">--     not doing so caused #21205.</span><span>
</span><span id="line-1677"></span><span>
</span><span id="line-1678"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span id="local-6989586621681627565"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627565"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627566"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627566"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621681627567"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627567"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627568"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627568"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1679"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllCo"><span class="hs-identifier hs-type">ForAllCo</span></a></span><span> </span><span id="local-6989586621681627570"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627570"><span class="hs-identifier hs-var">tv2</span></a></span></span><span> </span><span id="local-6989586621681627571"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627571"><span class="hs-identifier hs-var">kind_co2</span></a></span></span><span> </span><span id="local-6989586621681627572"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627572"><span class="hs-identifier hs-var">co2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1680"></span><span>                       </span><span id="local-6989586621681627573"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627573"><span class="hs-identifier hs-var">lkco</span></a></span></span><span> </span><span id="local-6989586621681627574"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627574"><span class="hs-identifier hs-var">rkco</span></a></span></span><span>
</span><span id="line-1681"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627567"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627570"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-1682"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681627576"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627576"><span class="hs-identifier hs-var">subst1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627565"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627566"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar -&gt; Type
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627567"><span class="hs-identifier hs-var">tv1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627571"><span class="hs-identifier hs-var">kind_co2</span></a></span><span>
</span><span id="line-1683"></span><span>                               </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627578"><span class="hs-identifier hs-var">ki_ki_co</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627578"><span class="hs-identifier hs-var">ki_ki_co</span></a></span><span>
</span><span id="line-1684"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627579"><span class="annot"><span class="annottext">rn_env0 :: RnEnv2
</span><a href="#local-6989586621681627579"><span class="hs-identifier hs-var hs-var">rn_env0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MatchEnv -&gt; RnEnv2
</span><a href="GHC.Core.Unify.html#me_env"><span class="hs-identifier hs-var">me_env</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627565"><span class="hs-identifier hs-var">menv</span></a></span><span>
</span><span id="line-1685"></span><span>             </span><span id="local-6989586621681627580"><span class="annot"><span class="annottext">rn_env1 :: RnEnv2
</span><a href="#local-6989586621681627580"><span class="hs-identifier hs-var hs-var">rn_env1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RnEnv2 -&gt; OutTyVar -&gt; OutTyVar -&gt; RnEnv2
</span><a href="GHC.Types.Var.Env.html#rnBndr2"><span class="hs-identifier hs-var">rnBndr2</span></a></span><span> </span><span class="annot"><span class="annottext">RnEnv2
</span><a href="#local-6989586621681627579"><span class="hs-identifier hs-var">rn_env0</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627567"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627570"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-1686"></span><span>             </span><span id="local-6989586621681627582"><span class="annot"><span class="annottext">menv' :: MatchEnv
</span><a href="#local-6989586621681627582"><span class="hs-identifier hs-var hs-var">menv'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627565"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#me_env"><span class="hs-identifier hs-var">me_env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681627580"><span class="hs-identifier hs-type">rn_env1</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1687"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627582"><span class="hs-identifier hs-var">menv'</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627576"><span class="hs-identifier hs-var">subst1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627568"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627572"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627573"><span class="hs-identifier hs-var">lkco</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627574"><span class="hs-identifier hs-var">rkco</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1688"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1689"></span><span>    </span><span id="local-6989586621681627578"><span class="annot"><span class="annottext">ki_ki_co :: CoercionN
</span><a href="#local-6989586621681627578"><span class="hs-identifier hs-var hs-var">ki_ki_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a></span><span>
</span><span id="line-1690"></span><span>
</span><span id="line-1691"></span><span class="hs-comment">-- ty_co_match menv subst (ForAllTy (Bndr cv1 _) ty1)</span><span>
</span><span id="line-1692"></span><span class="hs-comment">--                        (ForAllCo cv2 kind_co2 co2)</span><span>
</span><span id="line-1693"></span><span class="hs-comment">--                        lkco rkco</span><span>
</span><span id="line-1694"></span><span class="hs-comment">--   | isCoVar cv1 &amp;&amp; isCoVar cv2</span><span>
</span><span id="line-1695"></span><span class="hs-comment">--   We seems not to have enough information for this case</span><span>
</span><span id="line-1696"></span><span class="hs-comment">--   1. Given:</span><span>
</span><span id="line-1697"></span><span class="hs-comment">--        cv1      :: (s1 :: k1) ~r (s2 :: k2)</span><span>
</span><span id="line-1698"></span><span class="hs-comment">--        kind_co2 :: (s1' ~ s2') ~N (t1 ~ t2)</span><span>
</span><span id="line-1699"></span><span class="hs-comment">--        eta1      = mkSelCo (SelTyCon 2 role) (downgradeRole r Nominal kind_co2)</span><span>
</span><span id="line-1700"></span><span class="hs-comment">--                 :: s1' ~ t1</span><span>
</span><span id="line-1701"></span><span class="hs-comment">--        eta2      = mkSelCo (SelTyCon 3 role) (downgradeRole r Nominal kind_co2)</span><span>
</span><span id="line-1702"></span><span class="hs-comment">--                 :: s2' ~ t2</span><span>
</span><span id="line-1703"></span><span class="hs-comment">--      Wanted:</span><span>
</span><span id="line-1704"></span><span class="hs-comment">--        subst1 &lt;- ty_co_match menv subst  s1 eta1 kco1 kco2</span><span>
</span><span id="line-1705"></span><span class="hs-comment">--        subst2 &lt;- ty_co_match menv subst1 s2 eta2 kco3 kco4</span><span>
</span><span id="line-1706"></span><span class="hs-comment">--      Question: How do we get kcoi?</span><span>
</span><span id="line-1707"></span><span class="hs-comment">--   2. Given:</span><span>
</span><span id="line-1708"></span><span class="hs-comment">--        lkco :: &lt;*&gt;    -- See Note [Weird typing rule for ForAllTy] in GHC.Core.TyCo.Rep</span><span>
</span><span id="line-1709"></span><span class="hs-comment">--        rkco :: &lt;*&gt;</span><span>
</span><span id="line-1710"></span><span class="hs-comment">--      Wanted:</span><span>
</span><span id="line-1711"></span><span class="hs-comment">--        ty_co_match menv' subst2 ty1 co2 lkco' rkco'</span><span>
</span><span id="line-1712"></span><span class="hs-comment">--      Question: How do we get lkco' and rkco'?</span><span>
</span><span id="line-1713"></span><span>
</span><span id="line-1714"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681627583"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627583"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-1715"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; Maybe CvSubstEnv
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627583"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-comment">-- don't inspect coercions</span><span>
</span><span id="line-1716"></span><span>
</span><span id="line-1717"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span id="local-6989586621681627584"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627584"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627585"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627585"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681627586"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627586"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#GRefl"><span class="hs-identifier hs-type">GRefl</span></a></span><span> </span><span id="local-6989586621681627588"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627588"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621681627589"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627589"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#MCo"><span class="hs-identifier hs-type">MCo</span></a></span><span> </span><span id="local-6989586621681627591"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627591"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627592"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627592"><span class="hs-identifier hs-var">lkco</span></a></span></span><span> </span><span id="local-6989586621681627593"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627593"><span class="hs-identifier hs-var">rkco</span></a></span></span><span>
</span><span id="line-1718"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627584"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627585"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627586"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; MCoercion -&gt; CoercionN
</span><a href="GHC.Core.TyCo.Rep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627588"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627589"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercion
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627592"><span class="hs-identifier hs-var">lkco</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627593"><span class="hs-identifier hs-var">rkco</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627591"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1719"></span><span>
</span><span id="line-1720"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span id="local-6989586621681627595"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627595"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627596"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627596"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681627597"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627597"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681627598"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627598"><span class="hs-identifier hs-var">co1</span></a></span></span><span> </span><span id="local-6989586621681627599"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627599"><span class="hs-identifier hs-var">lkco</span></a></span></span><span> </span><span id="local-6989586621681627600"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627600"><span class="hs-identifier hs-var">rkco</span></a></span></span><span>
</span><span id="line-1721"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621681627601"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627601"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621681627602"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627602"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627603"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627603"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; Maybe (Type, Role)
</span><a href="GHC.Core.Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627598"><span class="hs-identifier hs-var">co1</span></a></span><span>
</span><span id="line-1722"></span><span>  </span><span class="hs-comment">-- In @pushRefl@, pushing reflexive coercion inside CastTy will give us</span><span>
</span><span id="line-1723"></span><span>  </span><span class="hs-comment">-- t |&gt; co ~ t ; &lt;t&gt; ; t ~ t |&gt; co</span><span>
</span><span id="line-1724"></span><span>  </span><span class="hs-comment">-- But transitive coercions are not helpful. Therefore we deal</span><span>
</span><span id="line-1725"></span><span>  </span><span class="hs-comment">-- with it here: we do recursion on the smaller reflexive coercion,</span><span>
</span><span id="line-1726"></span><span>  </span><span class="hs-comment">-- while propagating the correct kind coercions.</span><span>
</span><span id="line-1727"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627604"><span class="annot"><span class="annottext">kco' :: CoercionN
</span><a href="#local-6989586621681627604"><span class="hs-identifier hs-var hs-var">kco'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627602"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-1728"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627595"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627596"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627597"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627603"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627601"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627599"><span class="hs-identifier hs-var">lkco</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627604"><span class="hs-identifier hs-var">kco'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1729"></span><span>                                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627600"><span class="hs-identifier hs-var">rkco</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627604"><span class="hs-identifier hs-var">kco'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1730"></span><span>
</span><span id="line-1731"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span id="local-6989586621681627606"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627606"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627607"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627607"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681627608"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627608"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681627609"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627609"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621681627610"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627610"><span class="hs-identifier hs-var">lkco</span></a></span></span><span> </span><span id="local-6989586621681627611"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627611"><span class="hs-identifier hs-var">rkco</span></a></span></span><span>
</span><span id="line-1732"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681627612"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627612"><span class="hs-identifier hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; Maybe CoercionN
</span><a href="GHC.Core.Unify.html#pushRefl"><span class="hs-identifier hs-var">pushRefl</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627609"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627606"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627607"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627608"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627612"><span class="hs-identifier hs-var">co'</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627610"><span class="hs-identifier hs-var">lkco</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627611"><span class="hs-identifier hs-var">rkco</span></a></span><span>
</span><span id="line-1733"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CvSubstEnv
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1734"></span><span>
</span><span id="line-1735"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match_tc"><span class="hs-identifier hs-type">ty_co_match_tc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#MatchEnv"><span class="hs-identifier hs-type">MatchEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a></span><span>
</span><span id="line-1736"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1737"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1738"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a></span><span>
</span><span id="line-1739"></span><span id="ty_co_match_tc"><span class="annot"><span class="annottext">ty_co_match_tc :: MatchEnv
-&gt; CvSubstEnv
-&gt; TyCon
-&gt; [Type]
-&gt; TyCon
-&gt; [CoercionN]
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match_tc"><span class="hs-identifier hs-var hs-var">ty_co_match_tc</span></a></span></span><span> </span><span id="local-6989586621681627614"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627614"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627615"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627615"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681627616"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627616"><span class="hs-identifier hs-var">tc1</span></a></span></span><span> </span><span id="local-6989586621681627617"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627617"><span class="hs-identifier hs-var">tys1</span></a></span></span><span> </span><span id="local-6989586621681627618"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627618"><span class="hs-identifier hs-var">tc2</span></a></span></span><span> </span><span id="local-6989586621681627619"><span class="annot"><span class="annottext">[CoercionN]
</span><a href="#local-6989586621681627619"><span class="hs-identifier hs-var">cos2</span></a></span></span><span>
</span><span id="line-1740"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="../../base-4.18.3.0/src/Control.Monad.html#guard/Control.Monad.html#guard"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627616"><span class="hs-identifier hs-var">tc1</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; TyCon -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627618"><span class="hs-identifier hs-var">tc2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1741"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">MatchEnv -&gt; CvSubstEnv -&gt; [Type] -&gt; [CoercionN] -&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match_args"><span class="hs-identifier hs-var">ty_co_match_args</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627614"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627615"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627617"><span class="hs-identifier hs-var">tys1</span></a></span><span> </span><span class="annot"><span class="annottext">[CoercionN]
</span><a href="#local-6989586621681627619"><span class="hs-identifier hs-var">cos2</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1742"></span><span>
</span><span id="line-1743"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match_app"><span class="hs-identifier hs-type">ty_co_match_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#MatchEnv"><span class="hs-identifier hs-type">MatchEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a></span><span>
</span><span id="line-1744"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1745"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a></span><span>
</span><span id="line-1746"></span><span id="ty_co_match_app"><span class="annot"><span class="annottext">ty_co_match_app :: MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; [Type]
-&gt; CoercionN
-&gt; [CoercionN]
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match_app"><span class="hs-identifier hs-var hs-var">ty_co_match_app</span></a></span></span><span> </span><span id="local-6989586621681627620"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627620"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627621"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627621"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681627622"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627622"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681627623"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627623"><span class="hs-identifier hs-var">ty1args</span></a></span></span><span> </span><span id="local-6989586621681627624"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627624"><span class="hs-identifier hs-var">co2</span></a></span></span><span> </span><span id="local-6989586621681627625"><span class="annot"><span class="annottext">[CoercionN]
</span><a href="#local-6989586621681627625"><span class="hs-identifier hs-var">co2args</span></a></span></span><span>
</span><span id="line-1747"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627626"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627626"><span class="hs-identifier hs-var">ty1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627627"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627627"><span class="hs-identifier hs-var">ty1a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Maybe (Type, Type)
Type -&gt; Maybe (Type, Type)
</span><a href="GHC.Core.Type.html#splitAppTyNoView_maybe"><span class="hs-identifier hs-var">splitAppTyNoView_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627622"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1748"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627628"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627628"><span class="hs-identifier hs-var">co2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627629"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627629"><span class="hs-identifier hs-var">co2a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; Maybe (CoercionN, CoercionN)
</span><a href="GHC.Core.Coercion.html#splitAppCo_maybe"><span class="hs-identifier hs-var">splitAppCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627624"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-1749"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; [Type]
-&gt; CoercionN
-&gt; [CoercionN]
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match_app"><span class="hs-identifier hs-var">ty_co_match_app</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627620"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627621"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627626"><span class="hs-identifier hs-var">ty1'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627627"><span class="hs-identifier hs-var">ty1a</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; [Type]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627623"><span class="hs-identifier hs-var">ty1args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627628"><span class="hs-identifier hs-var">co2'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627629"><span class="hs-identifier hs-var">co2a</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; [CoercionN] -&gt; [CoercionN]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CoercionN]
</span><a href="#local-6989586621681627625"><span class="hs-identifier hs-var">co2args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1750"></span><span>
</span><span id="line-1751"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1752"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681627630"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627630"><span class="hs-identifier hs-var">subst1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627620"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627621"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627631"><span class="hs-identifier hs-var">ki1</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627632"><span class="hs-identifier hs-var">ki2</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627633"><span class="hs-identifier hs-var">ki_ki_co</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627633"><span class="hs-identifier hs-var">ki_ki_co</span></a></span><span>
</span><span id="line-1753"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681627634"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627634"><span class="hs-identifier hs-var">lkco</span></a></span></span><span> </span><span id="local-6989586621681627635"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627635"><span class="hs-identifier hs-var">rkco</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; CoercionN) -&gt; Pair Type -&gt; Pair CoercionN
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627632"><span class="hs-identifier hs-var">ki2</span></a></span><span>
</span><span id="line-1754"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681627636"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627636"><span class="hs-identifier hs-var">subst2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627620"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627630"><span class="hs-identifier hs-var">subst1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627622"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627624"><span class="hs-identifier hs-var">co2</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627634"><span class="hs-identifier hs-var">lkco</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627635"><span class="hs-identifier hs-var">rkco</span></a></span><span>
</span><span id="line-1755"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">MatchEnv -&gt; CvSubstEnv -&gt; [Type] -&gt; [CoercionN] -&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match_args"><span class="hs-identifier hs-var">ty_co_match_args</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627620"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627636"><span class="hs-identifier hs-var">subst2</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627623"><span class="hs-identifier hs-var">ty1args</span></a></span><span> </span><span class="annot"><span class="annottext">[CoercionN]
</span><a href="#local-6989586621681627625"><span class="hs-identifier hs-var">co2args</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1756"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1757"></span><span>    </span><span id="local-6989586621681627631"><span class="annot"><span class="annottext">ki1 :: Type
</span><a href="#local-6989586621681627631"><span class="hs-identifier hs-var hs-var">ki1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627622"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1758"></span><span>    </span><span id="local-6989586621681627632"><span class="annot"><span class="annottext">ki2 :: CoercionN
</span><a href="#local-6989586621681627632"><span class="hs-identifier hs-var hs-var">ki2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627624"><span class="hs-identifier hs-var">co2</span></a></span><span>
</span><span id="line-1759"></span><span>    </span><span id="local-6989586621681627633"><span class="annot"><span class="annottext">ki_ki_co :: CoercionN
</span><a href="#local-6989586621681627633"><span class="hs-identifier hs-var hs-var">ki_ki_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a></span><span>
</span><span id="line-1760"></span><span>
</span><span id="line-1761"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match_args"><span class="hs-identifier hs-type">ty_co_match_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#MatchEnv"><span class="hs-identifier hs-type">MatchEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1762"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a></span><span>
</span><span id="line-1763"></span><span id="ty_co_match_args"><span class="annot"><span class="annottext">ty_co_match_args :: MatchEnv -&gt; CvSubstEnv -&gt; [Type] -&gt; [CoercionN] -&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match_args"><span class="hs-identifier hs-var hs-var">ty_co_match_args</span></a></span></span><span> </span><span id="local-6989586621681627637"><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627637"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621681627638"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627638"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627639"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627639"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681627640"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627640"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627641"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627641"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681627642"><span class="annot"><span class="annottext">[CoercionN]
</span><a href="#local-6989586621681627642"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1764"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681627643"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627643"><span class="hs-identifier hs-var">lty</span></a></span></span><span> </span><span id="local-6989586621681627644"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627644"><span class="hs-identifier hs-var">rty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; Pair Type
</span><a href="GHC.Core.Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627641"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-1765"></span><span>             </span><span id="local-6989586621681627645"><span class="annot"><span class="annottext">lkco :: CoercionN
</span><a href="#local-6989586621681627645"><span class="hs-identifier hs-var hs-var">lkco</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627643"><span class="hs-identifier hs-var">lty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1766"></span><span>             </span><span id="local-6989586621681627646"><span class="annot"><span class="annottext">rkco :: CoercionN
</span><a href="#local-6989586621681627646"><span class="hs-identifier hs-var hs-var">rkco</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627644"><span class="hs-identifier hs-var">rty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1767"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681627647"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627647"><span class="hs-identifier hs-var">subst'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MatchEnv
-&gt; CvSubstEnv
-&gt; Type
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match"><span class="hs-identifier hs-var">ty_co_match</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627637"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627638"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627639"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627641"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627645"><span class="hs-identifier hs-var">lkco</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627646"><span class="hs-identifier hs-var">rkco</span></a></span><span>
</span><span id="line-1768"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">MatchEnv -&gt; CvSubstEnv -&gt; [Type] -&gt; [CoercionN] -&gt; Maybe CvSubstEnv
</span><a href="GHC.Core.Unify.html#ty_co_match_args"><span class="hs-identifier hs-var">ty_co_match_args</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><a href="#local-6989586621681627637"><span class="hs-identifier hs-var">menv</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627647"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627640"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">[CoercionN]
</span><a href="#local-6989586621681627642"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1769"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match_args"><span class="hs-identifier hs-var">ty_co_match_args</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><span class="hs-identifier">_</span></span><span>    </span><span id="local-6989586621681627648"><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627648"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CvSubstEnv -&gt; Maybe CvSubstEnv
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
</span><a href="#local-6989586621681627648"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-1770"></span><span class="annot"><a href="GHC.Core.Unify.html#ty_co_match_args"><span class="hs-identifier hs-var">ty_co_match_args</span></a></span><span> </span><span class="annot"><span class="annottext">MatchEnv
</span><span class="hs-identifier">_</span></span><span>    </span><span class="annot"><span class="annottext">CvSubstEnv
</span><span class="hs-identifier">_</span></span><span>     </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span>        </span><span class="annot"><span class="annottext">[CoercionN]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe CvSubstEnv
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1771"></span><span>
</span><span id="line-1772"></span><span class="annot"><a href="GHC.Core.Unify.html#pushRefl"><span class="hs-identifier hs-type">pushRefl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-1773"></span><span id="pushRefl"><span class="annot"><span class="annottext">pushRefl :: CoercionN -&gt; Maybe CoercionN
</span><a href="GHC.Core.Unify.html#pushRefl"><span class="hs-identifier hs-var hs-var">pushRefl</span></a></span></span><span> </span><span id="local-6989586621681627649"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627649"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1774"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN -&gt; Maybe (Type, Role)
</span><a href="GHC.Core.Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627649"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1775"></span><span>    </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621681627650"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627650"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681627651"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627651"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1776"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; Maybe CoercionN
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.TyCo.Rep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627650"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627651"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1777"></span><span>    </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span id="local-6989586621681627652"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621681627652"><span class="hs-identifier hs-var">af</span></a></span></span><span> </span><span id="local-6989586621681627653"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627653"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621681627654"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627654"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681627655"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627655"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627656"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627656"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1778"></span><span>      </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="annot"><span class="annottext">CoercionN -&gt; Maybe CoercionN
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
-&gt; FunTyFlag
-&gt; FunTyFlag
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
-&gt; CoercionN
</span><a href="GHC.Core.TyCo.Rep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627656"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621681627652"><span class="hs-identifier hs-var">af</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621681627652"><span class="hs-identifier hs-var">af</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627656"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627653"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627656"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627654"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627656"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627655"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1779"></span><span>    </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621681627657"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627657"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621681627658"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627658"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627659"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627659"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1780"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; Maybe CoercionN
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TyCon -&gt; [CoercionN] -&gt; CoercionN
</span><a href="GHC.Core.TyCo.Rep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627659"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627657"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Role -&gt; Type -&gt; CoercionN) -&gt; [Role] -&gt; [Type] -&gt; [CoercionN]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#zipWith/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TyCon -&gt; [Role]
</span><a href="GHC.Core.Coercion.html#tyConRoleListX"><span class="hs-identifier hs-var">tyConRoleListX</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627659"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627657"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627658"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1781"></span><span>    </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621681627662"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627662"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627663"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627663"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627664"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627664"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1782"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; Maybe CoercionN
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar -&gt; CoercionN -&gt; CoercionN -&gt; CoercionN
</span><a href="GHC.Core.TyCo.Rep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627662"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar -&gt; Type
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627662"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Type -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681627664"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627663"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1783"></span><span>    </span><span class="hs-comment">-- NB: NoRefl variant. Otherwise, we get a loop!</span><span>
</span><span id="line-1784"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Type, Role)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe CoercionN
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1785"></span><span>
</span><span id="line-1786"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
              Flattening
*                                                                      *
************************************************************************

Note [Flattening type-family applications when matching instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
As described in &quot;Closed type families with overlapping equations&quot;
http://research.microsoft.com/en-us/um/people/simonpj/papers/ext-f/axioms-extended.pdf
we need to flatten core types before unifying them, when checking for &quot;surely-apart&quot;
against earlier equations of a closed type family.
Flattening means replacing all top-level uses of type functions with
fresh variables, *taking care to preserve sharing*. That is, the type
(Either (F a b) (F a b)) should flatten to (Either c c), never (Either
c d).

Here is a nice example of why it's all necessary:

  type family F a b where
    F Int Bool = Char
    F a   b    = Double
  type family G a         -- open, no instances

How do we reduce (F (G Float) (G Float))? The first equation clearly doesn't match,
while the second equation does. But, before reducing, we must make sure that the
target can never become (F Int Bool). Well, no matter what G Float becomes, it
certainly won't become *both* Int and Bool, so indeed we're safe reducing
(F (G Float) (G Float)) to Double.

This is necessary not only to get more reductions (which we might be
willing to give up on), but for substitutivity. If we have (F x x), we
can see that (F x x) can reduce to Double. So, it had better be the
case that (F blah blah) can reduce to Double, no matter what (blah)
is!  Flattening as done below ensures this.

We also use this flattening operation to check for class instances.
If we have
  instance C (Maybe b)
  instance {-# OVERLAPPING #-} C (Maybe Bool)
  [W] C (Maybe (F a))
we want to know that the second instance might match later. So we
flatten the (F a) in the target before trying to unify with instances.
(This is done in GHC.Core.InstEnv.lookupInstEnv'.)

The algorithm works by building up a TypeMap TyVar, mapping
type family applications to fresh variables. This mapping must
be threaded through all the function calls, as any entry in
the mapping must be propagated to all future nodes in the tree.

The algorithm also must track the set of in-scope variables, in
order to make fresh variables as it flattens. (We are far from a
source of fresh Uniques.) See Wrinkle 2, below.

There are wrinkles, of course:

1. The flattening algorithm must account for the possibility
   of inner `forall`s. (A `forall` seen here can happen only
   because of impredicativity. However, the flattening operation
   is an algorithm in Core, which is impredicative.)
   Suppose we have (forall b. F b) -&gt; (forall b. F b). Of course,
   those two bs are entirely unrelated, and so we should certainly
   not flatten the two calls F b to the same variable. Instead, they
   must be treated separately. We thus carry a substitution that
   freshens variables; we must apply this substitution (in
   `coreFlattenTyFamApp`) before looking up an application in the environment.
   Note that the range of the substitution contains only TyVars, never anything
   else.

   For the sake of efficiency, we only apply this substitution when absolutely
   necessary. Namely:

   * We do not perform the substitution at all if it is empty.
   * We only need to worry about the arguments of a type family that are within
     the arity of said type family, so we can get away with not applying the
     substitution to any oversaturated type family arguments.
   * Importantly, we do /not/ achieve this substitution by recursively
     flattening the arguments, as this would be wrong. Consider `F (G a)`,
     where F and G are type families. We might decide that `F (G a)` flattens
     to `beta`. Later, the substitution is non-empty (but does not map `a`) and
     so we flatten `G a` to `gamma` and try to flatten `F gamma`. Of course,
     `F gamma` is unknown, and so we flatten it to `delta`, but it really
     should have been `beta`! Argh!

     Moral of the story: instead of flattening the arguments, just substitute
     them directly.

2. There are two different reasons we might add a variable
   to the in-scope set as we work:

     A. We have just invented a new flattening variable.
     B. We have entered a `forall`.

   Annoying here is that in-scope variable source (A) must be
   threaded through the calls. For example, consider (F b -&gt; forall c. F c).
   Suppose that, when flattening F b, we invent a fresh variable c.
   Now, when we encounter (forall c. F c), we need to know c is already in
   scope so that we locally rename c to c'. However, if we don't thread through
   the in-scope set from one argument of (-&gt;) to the other, we won't know this
   and might get very confused.

   In contrast, source (B) increases only as we go deeper, as in-scope sets
   normally do. However, even here we must be careful. The TypeMap TyVar that
   contains mappings from type family applications to freshened variables will
   be threaded through both sides of (forall b. F b) -&gt; (forall b. F b). We
   thus must make sure that the two `b`s don't get renamed to the same b1. (If
   they did, then looking up `F b1` would yield the same flatten var for
   each.) So, even though `forall`-bound variables should really be in the
   in-scope set only when they are in scope, we retain these variables even
   outside of their scope. This ensures that, if we encounter a fresh
   `forall`-bound b, we will rename it to b2, not b1. Note that keeping a
   larger in-scope set than strictly necessary is always OK, as in-scope sets
   are only ever used to avoid collisions.

   Sadly, the freshening substitution described in (1) really mustn't bind
   variables outside of their scope: note that its domain is the *unrenamed*
   variables. This means that the substitution gets &quot;pushed down&quot; (like a
   reader monad) while the in-scope set gets threaded (like a state monad).
   Because a Subst contains its own in-scope set, we don't carry a Subst;
   instead, we just carry a TvSubstEnv down, tying it to the InScopeSet
   traveling separately as necessary.

3. Consider `F ty_1 ... ty_n`, where F is a type family with arity k:

     type family F ty_1 ... ty_k :: res_k

   It's tempting to just flatten `F ty_1 ... ty_n` to `alpha`, where alpha is a
   flattening skolem. But we must instead flatten it to
   `alpha ty_(k+1) ... ty_n`&#8212;that is, by only flattening up to the arity of the
   type family.

   Why is this better? Consider the following concrete example from #16995:

     type family Param :: Type -&gt; Type

     type family LookupParam (a :: Type) :: Type where
       LookupParam (f Char) = Bool
       LookupParam x        = Int

     foo :: LookupParam (Param ())
     foo = 42

   In order for `foo` to typecheck, `LookupParam (Param ())` must reduce to
   `Int`. But if we flatten `Param ()` to `alpha`, then GHC can't be sure if
   `alpha` is apart from `f Char`, so it won't fall through to the second
   equation. But since the `Param` type family has arity 0, we can instead
   flatten `Param ()` to `alpha ()`, about which GHC knows with confidence is
   apart from `f Char`, permitting the second equation to be reached.

   Not only does this allow more programs to be accepted, it's also important
   for correctness. Not doing this was the root cause of the Core Lint error
   in #16995.

flattenTys is defined here because of module dependencies.
-}</span><span>
</span><span id="line-1942"></span><span>
</span><span id="line-1943"></span><span class="hs-keyword">data</span><span> </span><span id="FlattenEnv"><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-var">FlattenEnv</span></a></span></span><span>
</span><span id="line-1944"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="FlattenEnv"><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-var">FlattenEnv</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="fe_type_map"><span class="annot"><span class="annottext">FlattenEnv -&gt; TypeMap (OutTyVar, TyCon, [Type])
</span><a href="GHC.Core.Unify.html#fe_type_map"><span class="hs-identifier hs-var hs-var">fe_type_map</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Map.Type.html#TypeMap"><span class="hs-identifier hs-type">TypeMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1945"></span><span>                 </span><span class="hs-comment">-- domain: exactly-saturated type family applications</span><span>
</span><span id="line-1946"></span><span>                 </span><span class="hs-comment">-- range: (fresh variable, type family tycon, args)</span><span>
</span><span id="line-1947"></span><span>               </span><span class="hs-special">,</span><span> </span><span id="fe_in_scope"><span class="annot"><span class="annottext">FlattenEnv -&gt; InScopeSet
</span><a href="GHC.Core.Unify.html#fe_in_scope"><span class="hs-identifier hs-var hs-var">fe_in_scope</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1948"></span><span>                 </span><span class="hs-comment">-- See Note [Flattening type-family applications when matching instances]</span><span>
</span><span id="line-1949"></span><span>
</span><span id="line-1950"></span><span class="annot"><a href="GHC.Core.Unify.html#emptyFlattenEnv"><span class="hs-identifier hs-type">emptyFlattenEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span>
</span><span id="line-1951"></span><span id="emptyFlattenEnv"><span class="annot"><span class="annottext">emptyFlattenEnv :: InScopeSet -&gt; FlattenEnv
</span><a href="GHC.Core.Unify.html#emptyFlattenEnv"><span class="hs-identifier hs-var hs-var">emptyFlattenEnv</span></a></span></span><span> </span><span id="local-6989586621681627669"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627669"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span>
</span><span id="line-1952"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fe_type_map :: TypeMap (OutTyVar, TyCon, [Type])
</span><a href="GHC.Core.Unify.html#fe_type_map"><span class="hs-identifier hs-var">fe_type_map</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeMap (OutTyVar, TyCon, [Type])
forall a. TypeMap a
</span><a href="GHC.Core.Map.Type.html#emptyTypeMap"><span class="hs-identifier hs-var">emptyTypeMap</span></a></span><span>
</span><span id="line-1953"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fe_in_scope :: InScopeSet
</span><a href="GHC.Core.Unify.html#fe_in_scope"><span class="hs-identifier hs-var">fe_in_scope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627669"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1954"></span><span>
</span><span id="line-1955"></span><span class="annot"><a href="GHC.Core.Unify.html#updateInScopeSet"><span class="hs-identifier hs-type">updateInScopeSet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span>
</span><span id="line-1956"></span><span id="updateInScopeSet"><span class="annot"><span class="annottext">updateInScopeSet :: FlattenEnv -&gt; (InScopeSet -&gt; InScopeSet) -&gt; FlattenEnv
</span><a href="GHC.Core.Unify.html#updateInScopeSet"><span class="hs-identifier hs-var hs-var">updateInScopeSet</span></a></span></span><span> </span><span id="local-6989586621681627672"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627672"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627673"><span class="annot"><span class="annottext">InScopeSet -&gt; InScopeSet
</span><a href="#local-6989586621681627673"><span class="hs-identifier hs-var">upd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627672"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#fe_in_scope"><span class="hs-identifier hs-var">fe_in_scope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681627673"><span class="hs-identifier hs-type">upd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#fe_in_scope"><span class="hs-identifier hs-var">fe_in_scope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681627672"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1957"></span><span>
</span><span id="line-1958"></span><span class="annot"><a href="GHC.Core.Unify.html#flattenTys"><span class="hs-identifier hs-type">flattenTys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1959"></span><span class="hs-comment">-- See Note [Flattening type-family applications when matching instances]</span><span>
</span><span id="line-1960"></span><span id="flattenTys"><span class="annot"><span class="annottext">flattenTys :: InScopeSet -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.Unify.html#flattenTys"><span class="hs-identifier hs-var hs-var">flattenTys</span></a></span></span><span> </span><span id="local-6989586621681627674"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627674"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621681627675"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627675"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Type], TyVarEnv (TyCon, [Type])) -&gt; [Type]
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; [Type] -&gt; ([Type], TyVarEnv (TyCon, [Type]))
</span><a href="GHC.Core.Unify.html#flattenTysX"><span class="hs-identifier hs-var">flattenTysX</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627674"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627675"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1961"></span><span>
</span><span id="line-1962"></span><span class="annot"><a href="GHC.Core.Unify.html#flattenTysX"><span class="hs-identifier hs-type">flattenTysX</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TyVarEnv"><span class="hs-identifier hs-type">TyVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1963"></span><span class="hs-comment">-- See Note [Flattening type-family applications when matching instances]</span><span>
</span><span id="line-1964"></span><span class="hs-comment">-- NB: the returned types mention the fresh type variables</span><span>
</span><span id="line-1965"></span><span class="hs-comment">--     in the domain of the returned env, whose range includes</span><span>
</span><span id="line-1966"></span><span class="hs-comment">--     the original type family applications. Building a substitution</span><span>
</span><span id="line-1967"></span><span class="hs-comment">--     from this information and applying it would yield the original</span><span>
</span><span id="line-1968"></span><span class="hs-comment">--     types -- almost. The problem is that the original type might</span><span>
</span><span id="line-1969"></span><span class="hs-comment">--     have something like (forall b. F a b); the returned environment</span><span>
</span><span id="line-1970"></span><span class="hs-comment">--     can't really sensibly refer to that b. So it may include a locally-</span><span>
</span><span id="line-1971"></span><span class="hs-comment">--     bound tyvar in its range. Currently, the only usage of this env't</span><span>
</span><span id="line-1972"></span><span class="hs-comment">--     checks whether there are any meta-variables in it</span><span>
</span><span id="line-1973"></span><span class="hs-comment">--     (in GHC.Tc.Solver.Monad.mightEqualLater), so this is all OK.</span><span>
</span><span id="line-1974"></span><span id="flattenTysX"><span class="annot"><span class="annottext">flattenTysX :: InScopeSet -&gt; [Type] -&gt; ([Type], TyVarEnv (TyCon, [Type]))
</span><a href="GHC.Core.Unify.html#flattenTysX"><span class="hs-identifier hs-var hs-var">flattenTysX</span></a></span></span><span> </span><span id="local-6989586621681627677"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627677"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621681627678"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627678"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-1975"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627679"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627679"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627680"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627680"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; FlattenEnv -&gt; [Type] -&gt; (FlattenEnv, [Type])
</span><a href="GHC.Core.Unify.html#coreFlattenTys"><span class="hs-identifier hs-var">coreFlattenTys</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="GHC.Core.TyCo.Subst.html#emptyTvSubstEnv"><span class="hs-identifier hs-var">emptyTvSubstEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; FlattenEnv
</span><a href="GHC.Core.Unify.html#emptyFlattenEnv"><span class="hs-identifier hs-var">emptyFlattenEnv</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627677"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627678"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-1976"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627680"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TypeMap (OutTyVar, TyCon, [Type]) -&gt; TyVarEnv (TyCon, [Type])
</span><a href="#local-6989586621681627682"><span class="hs-identifier hs-var">build_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv -&gt; TypeMap (OutTyVar, TyCon, [Type])
</span><a href="GHC.Core.Unify.html#fe_type_map"><span class="hs-identifier hs-var">fe_type_map</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627679"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1977"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1978"></span><span>    </span><span class="annot"><a href="#local-6989586621681627682"><span class="hs-identifier hs-type">build_env</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Map.Type.html#TypeMap"><span class="hs-identifier hs-type">TypeMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#TyVarEnv"><span class="hs-identifier hs-type">TyVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1979"></span><span>    </span><span id="local-6989586621681627682"><span class="annot"><span class="annottext">build_env :: TypeMap (OutTyVar, TyCon, [Type]) -&gt; TyVarEnv (TyCon, [Type])
</span><a href="#local-6989586621681627682"><span class="hs-identifier hs-var hs-var">build_env</span></a></span></span><span> </span><span id="local-6989586621681627683"><span class="annot"><span class="annottext">TypeMap (OutTyVar, TyCon, [Type])
</span><a href="#local-6989586621681627683"><span class="hs-identifier hs-var">env_in</span></a></span></span><span>
</span><span id="line-1980"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((OutTyVar, TyCon, [Type])
 -&gt; TyVarEnv (TyCon, [Type]) -&gt; TyVarEnv (TyCon, [Type]))
-&gt; TypeMap (OutTyVar, TyCon, [Type])
-&gt; TyVarEnv (TyCon, [Type])
-&gt; TyVarEnv (TyCon, [Type])
forall a b. (a -&gt; b -&gt; b) -&gt; TypeMap a -&gt; b -&gt; b
forall (m :: * -&gt; *) a b.
TrieMap m =&gt;
(a -&gt; b -&gt; b) -&gt; m a -&gt; b -&gt; b
</span><a href="GHC.Data.TrieMap.html#foldTM"><span class="hs-identifier hs-var">foldTM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681627685"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627685"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627686"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627686"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627687"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627687"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627688"><span class="annot"><span class="annottext">TyVarEnv (TyCon, [Type])
</span><a href="#local-6989586621681627688"><span class="hs-identifier hs-var">env_out</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyVarEnv (TyCon, [Type])
-&gt; OutTyVar -&gt; (TyCon, [Type]) -&gt; TyVarEnv (TyCon, [Type])
forall a. VarEnv a -&gt; OutTyVar -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TyVarEnv (TyCon, [Type])
</span><a href="#local-6989586621681627688"><span class="hs-identifier hs-var">env_out</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627685"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627686"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627687"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1981"></span><span>               </span><span class="annot"><span class="annottext">TypeMap (OutTyVar, TyCon, [Type])
</span><a href="#local-6989586621681627683"><span class="hs-identifier hs-var">env_in</span></a></span><span> </span><span class="annot"><span class="annottext">TyVarEnv (TyCon, [Type])
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-1982"></span><span>
</span><span id="line-1983"></span><span class="annot"><a href="GHC.Core.Unify.html#coreFlattenTys"><span class="hs-identifier hs-type">coreFlattenTys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span>
</span><span id="line-1984"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1985"></span><span id="coreFlattenTys"><span class="annot"><span class="annottext">coreFlattenTys :: TvSubstEnv -&gt; FlattenEnv -&gt; [Type] -&gt; (FlattenEnv, [Type])
</span><a href="GHC.Core.Unify.html#coreFlattenTys"><span class="hs-identifier hs-var hs-var">coreFlattenTys</span></a></span></span><span> </span><span id="local-6989586621681627689"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627689"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type))
-&gt; FlattenEnv -&gt; [Type] -&gt; (FlattenEnv, [Type])
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapAccumL/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TvSubstEnv -&gt; FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="GHC.Core.Unify.html#coreFlattenTy"><span class="hs-identifier hs-var">coreFlattenTy</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627689"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1986"></span><span>
</span><span id="line-1987"></span><span class="annot"><a href="GHC.Core.Unify.html#coreFlattenTy"><span class="hs-identifier hs-type">coreFlattenTy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span>
</span><span id="line-1988"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1989"></span><span id="coreFlattenTy"><span class="annot"><span class="annottext">coreFlattenTy :: TvSubstEnv -&gt; FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="GHC.Core.Unify.html#coreFlattenTy"><span class="hs-identifier hs-var hs-var">coreFlattenTy</span></a></span></span><span> </span><span id="local-6989586621681627691"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627691"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-1990"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1991"></span><span>    </span><span id="local-6989586621681627692"><span class="annot"><span class="annottext">go :: FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="#local-6989586621681627692"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681627693"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627693"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627694"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627694"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681627695"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627695"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627694"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627693"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627695"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-1992"></span><span>
</span><span id="line-1993"></span><span>    </span><span class="annot"><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681627696"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627696"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621681627697"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627697"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1994"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681627698"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627698"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; OutTyVar -&gt; Maybe Type
forall a. VarEnv a -&gt; OutTyVar -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627691"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627697"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627696"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627698"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1995"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627699"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627699"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627700"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627700"><span class="hs-identifier hs-var">ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627696"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar -&gt; Type
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627697"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-1996"></span><span>                                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627699"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">(OutTyVar -&gt; Type) -&gt; OutTyVar -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; Type -&gt; OutTyVar
</span><a href="GHC.Types.Var.html#setTyVarKind"><span class="hs-identifier hs-var">setTyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627697"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627700"><span class="hs-identifier hs-var">ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1997"></span><span>    </span><span class="annot"><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681627702"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627702"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621681627703"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627703"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681627704"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627704"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627705"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627705"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627706"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627706"><span class="hs-identifier hs-var">ty1'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627702"><span class="hs-identifier hs-var">env</span></a></span><span>  </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627703"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-1998"></span><span>                                 </span><span class="hs-special">(</span><span id="local-6989586621681627707"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627707"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627708"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627708"><span class="hs-identifier hs-var">ty2'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627705"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627704"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-1999"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627707"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627706"><span class="hs-identifier hs-var">ty1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627708"><span class="hs-identifier hs-var">ty2'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2000"></span><span>    </span><span class="annot"><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681627709"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627709"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621681627710"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627710"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621681627711"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627711"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2001"></span><span>         </span><span class="hs-comment">-- NB: Don't just check if isFamilyTyCon: this catches *data* families,</span><span>
</span><span id="line-2002"></span><span>         </span><span class="hs-comment">-- which are generative and thus can be preserved during flattening</span><span>
</span><span id="line-2003"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Role -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isGenerativeTyCon"><span class="hs-identifier hs-var">isGenerativeTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627710"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2004"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; FlattenEnv -&gt; TyCon -&gt; [Type] -&gt; (FlattenEnv, Type)
</span><a href="GHC.Core.Unify.html#coreFlattenTyFamApp"><span class="hs-identifier hs-var">coreFlattenTyFamApp</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627691"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627709"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627710"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627711"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-2005"></span><span>
</span><span id="line-2006"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2007"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627714"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627714"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627715"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627715"><span class="hs-identifier hs-var">tys'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; FlattenEnv -&gt; [Type] -&gt; (FlattenEnv, [Type])
</span><a href="GHC.Core.Unify.html#coreFlattenTys"><span class="hs-identifier hs-var">coreFlattenTys</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627691"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627709"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627711"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-2008"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627714"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627710"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627715"><span class="hs-identifier hs-var">tys'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2009"></span><span>
</span><span id="line-2010"></span><span>    </span><span class="annot"><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681627717"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627717"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627718"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621681627718"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_mult :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681627719"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627719"><span class="hs-identifier hs-var">mult</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681627720"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627720"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681627721"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627721"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2011"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627722"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627722"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627723"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627723"><span class="hs-identifier hs-var">ty1'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627717"><span class="hs-identifier hs-var">env</span></a></span><span>  </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627720"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-2012"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621681627724"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627724"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627725"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627725"><span class="hs-identifier hs-var">ty2'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627722"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627721"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-2013"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621681627726"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627726"><span class="hs-identifier hs-var">env3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627727"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627727"><span class="hs-identifier hs-var">mult'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627724"><span class="hs-identifier hs-var">env2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627719"><span class="hs-identifier hs-var">mult</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-2014"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627726"><span class="hs-identifier hs-var">env3</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627718"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681627727"><span class="hs-identifier hs-type">mult'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681627723"><span class="hs-identifier hs-type">ty1'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681627725"><span class="hs-identifier hs-type">ty2'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2015"></span><span>
</span><span id="line-2016"></span><span>    </span><span class="annot"><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681627728"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627728"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621681627729"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627729"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621681627730"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621681627730"><span class="hs-identifier hs-var">vis</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681627731"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627731"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2017"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627732"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627732"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627733"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627733"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627734"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627734"><span class="hs-identifier hs-var">tv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
-&gt; FlattenEnv -&gt; OutTyVar -&gt; (FlattenEnv, TvSubstEnv, OutTyVar)
</span><a href="GHC.Core.Unify.html#coreFlattenVarBndr"><span class="hs-identifier hs-var">coreFlattenVarBndr</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627691"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627728"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627729"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-2018"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621681627736"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627736"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627737"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627737"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="GHC.Core.Unify.html#coreFlattenTy"><span class="hs-identifier hs-var">coreFlattenTy</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627733"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627732"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627731"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-2019"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627736"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarBndr OutTyVar ForAllTyFlag -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar -&gt; ForAllTyFlag -&gt; VarBndr OutTyVar ForAllTyFlag
forall var argf. var -&gt; argf -&gt; VarBndr var argf
</span><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627734"><span class="hs-identifier hs-var">tv'</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621681627730"><span class="hs-identifier hs-var">vis</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627737"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2020"></span><span>
</span><span id="line-2021"></span><span>    </span><span class="annot"><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681627738"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627738"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627739"><span class="annot"><span class="annottext">ty :: Type
</span><a href="#local-6989586621681627739"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627738"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627739"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2022"></span><span>
</span><span id="line-2023"></span><span>    </span><span class="annot"><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681627740"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627740"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621681627741"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627741"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681627742"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627742"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2024"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627743"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627743"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627744"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627744"><span class="hs-identifier hs-var">ty'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627740"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627741"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2025"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621681627745"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627745"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627746"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627746"><span class="hs-identifier hs-var">co'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; FlattenEnv -&gt; CoercionN -&gt; (FlattenEnv, CoercionN)
</span><a href="GHC.Core.Unify.html#coreFlattenCo"><span class="hs-identifier hs-var">coreFlattenCo</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627691"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627743"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627742"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-2026"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627745"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CoercionN -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627744"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627746"><span class="hs-identifier hs-var">co'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2027"></span><span>
</span><span id="line-2028"></span><span>    </span><span class="annot"><a href="#local-6989586621681627692"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681627748"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627748"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span id="local-6989586621681627749"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627749"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2029"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627750"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627750"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627751"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627751"><span class="hs-identifier hs-var">co'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; FlattenEnv -&gt; CoercionN -&gt; (FlattenEnv, CoercionN)
</span><a href="GHC.Core.Unify.html#coreFlattenCo"><span class="hs-identifier hs-var">coreFlattenCo</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627691"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627748"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627749"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-2030"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627750"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoercionN -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627751"><span class="hs-identifier hs-var">co'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2031"></span><span>
</span><span id="line-2032"></span><span>
</span><span id="line-2033"></span><span class="hs-comment">-- when flattening, we don't care about the contents of coercions.</span><span>
</span><span id="line-2034"></span><span class="hs-comment">-- so, just return a fresh variable of the right (flattened) type</span><span>
</span><span id="line-2035"></span><span class="annot"><a href="GHC.Core.Unify.html#coreFlattenCo"><span class="hs-identifier hs-type">coreFlattenCo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span>
</span><span id="line-2036"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2037"></span><span id="coreFlattenCo"><span class="annot"><span class="annottext">coreFlattenCo :: TvSubstEnv -&gt; FlattenEnv -&gt; CoercionN -&gt; (FlattenEnv, CoercionN)
</span><a href="GHC.Core.Unify.html#coreFlattenCo"><span class="hs-identifier hs-var hs-var">coreFlattenCo</span></a></span></span><span> </span><span id="local-6989586621681627752"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627752"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681627753"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627753"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627754"><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627754"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-2038"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627755"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; CoercionN
</span><a href="GHC.Core.Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627757"><span class="hs-identifier hs-var">covar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2039"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2040"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681627758"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627758"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627759"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627759"><span class="hs-identifier hs-var">kind'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="GHC.Core.Unify.html#coreFlattenTy"><span class="hs-identifier hs-var">coreFlattenTy</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627752"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627753"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoercionN -&gt; Type
</span><a href="GHC.Core.Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionN
</span><a href="#local-6989586621681627754"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2041"></span><span>    </span><span id="local-6989586621681627757"><span class="annot"><span class="annottext">covar :: OutTyVar
</span><a href="#local-6989586621681627757"><span class="hs-identifier hs-var hs-var">covar</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Type -&gt; OutTyVar
</span><a href="GHC.Core.Unify.html#mkFlattenFreshCoVar"><span class="hs-identifier hs-var">mkFlattenFreshCoVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv -&gt; InScopeSet
</span><a href="GHC.Core.Unify.html#fe_in_scope"><span class="hs-identifier hs-var">fe_in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627758"><span class="hs-identifier hs-var">env1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627759"><span class="hs-identifier hs-var">kind'</span></a></span><span>
</span><span id="line-2042"></span><span>    </span><span class="hs-comment">-- Add the covar to the FlattenEnv's in-scope set.</span><span>
</span><span id="line-2043"></span><span>    </span><span class="hs-comment">-- See Note [Flattening type-family applications when matching instances], wrinkle 2A.</span><span>
</span><span id="line-2044"></span><span>    </span><span id="local-6989586621681627755"><span class="annot"><span class="annottext">env2 :: FlattenEnv
</span><a href="#local-6989586621681627755"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv -&gt; (InScopeSet -&gt; InScopeSet) -&gt; FlattenEnv
</span><a href="GHC.Core.Unify.html#updateInScopeSet"><span class="hs-identifier hs-var">updateInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627758"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(InScopeSet -&gt; OutTyVar -&gt; InScopeSet)
-&gt; OutTyVar -&gt; InScopeSet -&gt; InScopeSet
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#flip/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; OutTyVar -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627757"><span class="hs-identifier hs-var">covar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2045"></span><span>
</span><span id="line-2046"></span><span class="annot"><a href="GHC.Core.Unify.html#coreFlattenVarBndr"><span class="hs-identifier hs-type">coreFlattenVarBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span>
</span><span id="line-2047"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2048"></span><span id="coreFlattenVarBndr"><span class="annot"><span class="annottext">coreFlattenVarBndr :: TvSubstEnv
-&gt; FlattenEnv -&gt; OutTyVar -&gt; (FlattenEnv, TvSubstEnv, OutTyVar)
</span><a href="GHC.Core.Unify.html#coreFlattenVarBndr"><span class="hs-identifier hs-var hs-var">coreFlattenVarBndr</span></a></span></span><span> </span><span id="local-6989586621681627764"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627764"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621681627765"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627765"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627766"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627766"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-2049"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627767"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627768"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627769"><span class="hs-identifier hs-var">tv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2050"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2051"></span><span>    </span><span class="hs-comment">-- See Note [Flattening type-family applications when matching instances], wrinkle 2B.</span><span>
</span><span id="line-2052"></span><span>    </span><span id="local-6989586621681627770"><span class="annot"><span class="annottext">kind :: Type
</span><a href="#local-6989586621681627770"><span class="hs-identifier hs-var hs-var">kind</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutTyVar -&gt; Type
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627766"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-2053"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681627771"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627771"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627772"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627772"><span class="hs-identifier hs-var">kind'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; FlattenEnv -&gt; Type -&gt; (FlattenEnv, Type)
</span><a href="GHC.Core.Unify.html#coreFlattenTy"><span class="hs-identifier hs-var">coreFlattenTy</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627764"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627765"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627770"><span class="hs-identifier hs-var">kind</span></a></span><span>
</span><span id="line-2054"></span><span>    </span><span id="local-6989586621681627769"><span class="annot"><span class="annottext">tv' :: OutTyVar
</span><a href="#local-6989586621681627769"><span class="hs-identifier hs-var hs-var">tv'</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; OutTyVar -&gt; OutTyVar
</span><a href="GHC.Types.Var.Env.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv -&gt; InScopeSet
</span><a href="GHC.Core.Unify.html#fe_in_scope"><span class="hs-identifier hs-var">fe_in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627771"><span class="hs-identifier hs-var">env1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar -&gt; Type -&gt; OutTyVar
</span><a href="GHC.Types.Var.html#setVarType"><span class="hs-identifier hs-var">setVarType</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627766"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627772"><span class="hs-identifier hs-var">kind'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2055"></span><span>    </span><span id="local-6989586621681627768"><span class="annot"><span class="annottext">subst' :: TvSubstEnv
</span><a href="#local-6989586621681627768"><span class="hs-identifier hs-var hs-var">subst'</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; OutTyVar -&gt; Type -&gt; TvSubstEnv
forall a. VarEnv a -&gt; OutTyVar -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627764"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627766"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627769"><span class="hs-identifier hs-var">tv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2056"></span><span>    </span><span id="local-6989586621681627767"><span class="annot"><span class="annottext">env2 :: FlattenEnv
</span><a href="#local-6989586621681627767"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv -&gt; (InScopeSet -&gt; InScopeSet) -&gt; FlattenEnv
</span><a href="GHC.Core.Unify.html#updateInScopeSet"><span class="hs-identifier hs-var">updateInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627771"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(InScopeSet -&gt; OutTyVar -&gt; InScopeSet)
-&gt; OutTyVar -&gt; InScopeSet -&gt; InScopeSet
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#flip/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; OutTyVar -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627769"><span class="hs-identifier hs-var">tv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2057"></span><span>
</span><span id="line-2058"></span><span class="annot"><a href="GHC.Core.Unify.html#coreFlattenTyFamApp"><span class="hs-identifier hs-type">coreFlattenTyFamApp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span>
</span><span id="line-2059"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>         </span><span class="hs-comment">-- type family tycon</span><span>
</span><span id="line-2060"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- args, already flattened</span><span>
</span><span id="line-2061"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2062"></span><span id="coreFlattenTyFamApp"><span class="annot"><span class="annottext">coreFlattenTyFamApp :: TvSubstEnv -&gt; FlattenEnv -&gt; TyCon -&gt; [Type] -&gt; (FlattenEnv, Type)
</span><a href="GHC.Core.Unify.html#coreFlattenTyFamApp"><span class="hs-identifier hs-var hs-var">coreFlattenTyFamApp</span></a></span></span><span> </span><span id="local-6989586621681627775"><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627775"><span class="hs-identifier hs-var">tv_subst</span></a></span></span><span> </span><span id="local-6989586621681627776"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627776"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681627777"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627777"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621681627778"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627778"><span class="hs-identifier hs-var">fam_args</span></a></span></span><span>
</span><span id="line-2063"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TypeMap (OutTyVar, TyCon, [Type])
-&gt; Type -&gt; Maybe (OutTyVar, TyCon, [Type])
forall a. TypeMap a -&gt; Type -&gt; Maybe a
</span><a href="GHC.Core.Map.Type.html#lookupTypeMap"><span class="hs-identifier hs-var">lookupTypeMap</span></a></span><span> </span><span class="annot"><span class="annottext">TypeMap (OutTyVar, TyCon, [Type])
</span><a href="#local-6989586621681627780"><span class="hs-identifier hs-var">type_map</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627781"><span class="hs-identifier hs-var">fam_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2064"></span><span>      </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681627782"><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627782"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627783"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkAppTys"><span class="hs-identifier hs-var">mkAppTys</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627782"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627785"><span class="hs-identifier hs-var">leftover_args'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2065"></span><span>      </span><span class="annot"><span class="annottext">Maybe (OutTyVar, TyCon, [Type])
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2066"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627786"><span class="annot"><span class="annottext">tyvar_name :: Name
</span><a href="#local-6989586621681627786"><span class="hs-identifier hs-var hs-var">tyvar_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Name
forall a. Uniquable a =&gt; a -&gt; Name
</span><a href="GHC.Core.Unify.html#mkFlattenFreshTyName"><span class="hs-identifier hs-var">mkFlattenFreshTyName</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627777"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-2067"></span><span>            </span><span id="local-6989586621681627788"><span class="annot"><span class="annottext">tv :: OutTyVar
</span><a href="#local-6989586621681627788"><span class="hs-identifier hs-var hs-var">tv</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; OutTyVar -&gt; OutTyVar
</span><a href="GHC.Types.Var.Env.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627789"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(OutTyVar -&gt; OutTyVar) -&gt; OutTyVar -&gt; OutTyVar
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2068"></span><span>                         </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; OutTyVar
</span><a href="GHC.Types.Var.html#mkTyVar"><span class="hs-identifier hs-var">mkTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681627786"><span class="hs-identifier hs-var">tyvar_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Type
Type -&gt; Type
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627781"><span class="hs-identifier hs-var">fam_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2069"></span><span>
</span><span id="line-2070"></span><span>            </span><span id="local-6989586621681627791"><span class="annot"><span class="annottext">ty' :: Type
</span><a href="#local-6989586621681627791"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkAppTys"><span class="hs-identifier hs-var">mkAppTys</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutTyVar -&gt; Type
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">OutTyVar
</span><a href="#local-6989586621681627788"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627785"><span class="hs-identifier hs-var">leftover_args'</span></a></span><span>
</span><span id="line-2071"></span><span>            </span><span id="local-6989586621681627792"><span class="annot"><span class="annottext">env'' :: FlattenEnv
</span><a href="#local-6989586621681627792"><span class="hs-identifier hs-var hs-var">env''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627783"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#fe_type_map"><span class="hs-identifier hs-var">fe_type_map</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Map.Type.html#extendTypeMap"><span class="hs-identifier hs-type">extendTypeMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681627780"><span class="hs-identifier hs-type">type_map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681627781"><span class="hs-identifier hs-type">fam_ty</span></a></span><span>
</span><span id="line-2072"></span><span>                                                       </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681627788"><span class="hs-identifier hs-type">tv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681627777"><span class="hs-identifier hs-type">fam_tc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681627794"><span class="hs-identifier hs-type">sat_fam_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2073"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#fe_in_scope"><span class="hs-identifier hs-var">fe_in_scope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-identifier hs-type">extendInScopeSet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681627789"><span class="hs-identifier hs-type">in_scope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681627788"><span class="hs-identifier hs-type">tv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2074"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627792"><span class="hs-identifier hs-var">env''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627791"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2075"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2076"></span><span>    </span><span id="local-6989586621681627795"><span class="annot"><span class="annottext">arity :: Arity
</span><a href="#local-6989586621681627795"><span class="hs-identifier hs-var hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Arity
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627777"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-2077"></span><span>    </span><span id="local-6989586621681627796"><span class="annot"><span class="annottext">tcv_subst :: Subst
</span><a href="#local-6989586621681627796"><span class="hs-identifier hs-var hs-var">tcv_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; IdSubstEnv -&gt; TvSubstEnv -&gt; CvSubstEnv -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FlattenEnv -&gt; InScopeSet
</span><a href="GHC.Core.Unify.html#fe_in_scope"><span class="hs-identifier hs-var">fe_in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627776"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IdSubstEnv
</span><a href="GHC.Core.TyCo.Subst.html#emptyIdSubstEnv"><span class="hs-identifier hs-var">emptyIdSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627775"><span class="hs-identifier hs-var">tv_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CvSubstEnv
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-2078"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681627794"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627794"><span class="hs-identifier hs-var">sat_fam_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627797"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627797"><span class="hs-identifier hs-var">leftover_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ([Type], [Type]) -&gt; ([Type], [Type])
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681627795"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Arity
forall a. [a] -&gt; Arity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Arity
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627778"><span class="hs-identifier hs-var">fam_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([Type], [Type]) -&gt; ([Type], [Type]))
-&gt; ([Type], [Type]) -&gt; ([Type], [Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2079"></span><span>                                    </span><span class="annot"><span class="annottext">Arity -&gt; [Type] -&gt; ([Type], [Type])
forall a. Arity -&gt; [a] -&gt; ([a], [a])
</span><a href="../../base-4.18.3.0/src/GHC.List.html#splitAt/GHC.List.html#splitAt"><span class="hs-identifier hs-var">splitAt</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681627795"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627778"><span class="hs-identifier hs-var">fam_args</span></a></span><span>
</span><span id="line-2080"></span><span>    </span><span class="hs-comment">-- Apply the substitution before looking up an application in the</span><span>
</span><span id="line-2081"></span><span>    </span><span class="hs-comment">-- environment. See Note [Flattening type-family applications when matching instances],</span><span>
</span><span id="line-2082"></span><span>    </span><span class="hs-comment">-- wrinkle 1.</span><span>
</span><span id="line-2083"></span><span>    </span><span class="hs-comment">-- NB: substTys short-cuts the common case when the substitution is empty.</span><span>
</span><span id="line-2084"></span><span>    </span><span id="local-6989586621681627802"><span class="annot"><span class="annottext">sat_fam_args' :: [Type]
</span><a href="#local-6989586621681627802"><span class="hs-identifier hs-var hs-var">sat_fam_args'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; [Type] -&gt; [Type]
Subst -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.TyCo.Subst.html#substTys"><span class="hs-identifier hs-var">substTys</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681627796"><span class="hs-identifier hs-var">tcv_subst</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627794"><span class="hs-identifier hs-var">sat_fam_args</span></a></span><span>
</span><span id="line-2085"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681627783"><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627783"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681627785"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627785"><span class="hs-identifier hs-var">leftover_args'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TvSubstEnv -&gt; FlattenEnv -&gt; [Type] -&gt; (FlattenEnv, [Type])
</span><a href="GHC.Core.Unify.html#coreFlattenTys"><span class="hs-identifier hs-var">coreFlattenTys</span></a></span><span> </span><span class="annot"><span class="annottext">TvSubstEnv
</span><a href="#local-6989586621681627775"><span class="hs-identifier hs-var">tv_subst</span></a></span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627776"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627797"><span class="hs-identifier hs-var">leftover_args</span></a></span><span>
</span><span id="line-2086"></span><span>    </span><span class="hs-comment">-- `fam_tc` may be over-applied to `fam_args` (see</span><span>
</span><span id="line-2087"></span><span>    </span><span class="hs-comment">-- Note [Flattening type-family applications when matching instances]</span><span>
</span><span id="line-2088"></span><span>    </span><span class="hs-comment">-- wrinkle 3), so we split it into the arguments needed to saturate it</span><span>
</span><span id="line-2089"></span><span>    </span><span class="hs-comment">-- (sat_fam_args') and the rest (leftover_args')</span><span>
</span><span id="line-2090"></span><span>    </span><span id="local-6989586621681627781"><span class="annot"><span class="annottext">fam_ty :: Type
</span><a href="#local-6989586621681627781"><span class="hs-identifier hs-var hs-var">fam_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Type] -&gt; Type
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681627777"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681627802"><span class="hs-identifier hs-var">sat_fam_args'</span></a></span><span>
</span><span id="line-2091"></span><span>    </span><span class="annot"><a href="GHC.Core.Unify.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fe_type_map :: FlattenEnv -&gt; TypeMap (OutTyVar, TyCon, [Type])
</span><a href="GHC.Core.Unify.html#fe_type_map"><span class="hs-identifier hs-var">fe_type_map</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681627780"><span class="annot"><span class="annottext">TypeMap (OutTyVar, TyCon, [Type])
</span><a href="#local-6989586621681627780"><span class="hs-identifier hs-var">type_map</span></a></span></span><span>
</span><span id="line-2092"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fe_in_scope :: FlattenEnv -&gt; InScopeSet
</span><a href="GHC.Core.Unify.html#fe_in_scope"><span class="hs-identifier hs-var">fe_in_scope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681627789"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627789"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlattenEnv
</span><a href="#local-6989586621681627783"><span class="hs-identifier hs-var">env'</span></a></span><span>
</span><span id="line-2093"></span><span>
</span><span id="line-2094"></span><span id="local-6989586621681626683"><span class="annot"><a href="GHC.Core.Unify.html#mkFlattenFreshTyName"><span class="hs-identifier hs-type">mkFlattenFreshTyName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#Uniquable"><span class="hs-identifier hs-type">Uniquable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681626683"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681626683"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span></span><span>
</span><span id="line-2095"></span><span id="mkFlattenFreshTyName"><span class="annot"><span class="annottext">mkFlattenFreshTyName :: forall a. Uniquable a =&gt; a -&gt; Name
</span><a href="GHC.Core.Unify.html#mkFlattenFreshTyName"><span class="hs-identifier hs-var hs-var">mkFlattenFreshTyName</span></a></span></span><span> </span><span id="local-6989586621681627806"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627806"><span class="hs-identifier hs-var">unq</span></a></span></span><span>
</span><span id="line-2096"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; FastString -&gt; Name
</span><a href="GHC.Types.Name.html#mkSysTvName"><span class="hs-identifier hs-var">mkSysTvName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Unique
forall a. Uniquable a =&gt; a -&gt; Unique
</span><a href="GHC.Types.Unique.html#getUnique"><span class="hs-identifier hs-var">getUnique</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681627806"><span class="hs-identifier hs-var">unq</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;flt&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-2097"></span><span>
</span><span id="line-2098"></span><span class="annot"><a href="GHC.Core.Unify.html#mkFlattenFreshCoVar"><span class="hs-identifier hs-type">mkFlattenFreshCoVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a></span><span>
</span><span id="line-2099"></span><span id="mkFlattenFreshCoVar"><span class="annot"><span class="annottext">mkFlattenFreshCoVar :: InScopeSet -&gt; Type -&gt; OutTyVar
</span><a href="GHC.Core.Unify.html#mkFlattenFreshCoVar"><span class="hs-identifier hs-var hs-var">mkFlattenFreshCoVar</span></a></span></span><span> </span><span id="local-6989586621681627810"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627810"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621681627811"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627811"><span class="hs-identifier hs-var">kind</span></a></span></span><span>
</span><span id="line-2100"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681627812"><span class="annot"><span class="annottext">uniq :: Unique
</span><a href="#local-6989586621681627812"><span class="hs-identifier hs-var hs-var">uniq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Unique
</span><a href="GHC.Types.Var.Env.html#unsafeGetFreshLocalUnique"><span class="hs-identifier hs-var">unsafeGetFreshLocalUnique</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681627810"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-2101"></span><span>        </span><span id="local-6989586621681627814"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681627814"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; FastString -&gt; Name
</span><a href="GHC.Types.Name.html#mkSystemVarName"><span class="hs-identifier hs-var">mkSystemVarName</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681627812"><span class="hs-identifier hs-var">uniq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;flc&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-2102"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Type -&gt; OutTyVar
</span><a href="GHC.Types.Var.html#mkCoVar"><span class="hs-identifier hs-var">mkCoVar</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681627814"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681627811"><span class="hs-identifier hs-var">kind</span></a></span><span>
</span><span id="line-2103"></span><span>
</span><span id="line-2104"></span></pre></body></html>