<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.HsToCore.Usage</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Dependency/fingerprinting code (used by GHC.Iface.Make)</span></span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="GHC.HsToCore.Usage.html#mkUsageInfo"><span class="hs-identifier">mkUsageInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.HsToCore.Usage.html#mkUsedNames"><span class="hs-identifier">mkUsedNames</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="GHC.HsToCore.Usage.html#UsageConfig"><span class="hs-identifier">UsageConfig</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html"><span class="hs-identifier">GHC.Driver.Env</span></a></span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html"><span class="hs-identifier">GHC.Tc.Types</span></a></span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Iface.Load.html"><span class="hs-identifier">GHC.Iface.Load</span></a></span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Fingerprint.html"><span class="hs-identifier">GHC.Utils.Fingerprint</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html"><span class="hs-identifier">GHC.Utils.Monad</span></a></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html"><span class="hs-identifier">GHC.Types.Name.Set</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#NameSet"><span class="hs-identifier">NameSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#allUses"><span class="hs-identifier">allUses</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Set.html"><span class="hs-identifier">GHC.Types.Unique.Set</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.html"><span class="hs-identifier">GHC.Unit</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Env.html"><span class="hs-identifier">GHC.Unit.Env</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.External.html"><span class="hs-identifier">GHC.Unit.External</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Imported.html"><span class="hs-identifier">GHC.Unit.Module.Imported</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModIface.html"><span class="hs-identifier">GHC.Unit.Module.ModIface</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html"><span class="hs-identifier">GHC.Unit.Module.Deps</span></a></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.IORef.html#/Data.IORef.html"><span class="hs-identifier">Data.IORef</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.List.html#/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.2.1/src/Data.OldList.html#sortBy/Data.OldList.html#sortBy"><span class="hs-identifier">sortBy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../containers-0.6.7/src/Data.Map.html#/Data.Map.html"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.6.7/src/Data.Map.Internal.html#Map/Data.Map.Internal.html#Map"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../containers-0.6.7/src/Data.Map.html#/Data.Map.html"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../containers-0.6.7/src/Data.Set.html#/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html"><span class="hs-identifier">GHC.Linker.Types</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Finder.html"><span class="hs-identifier">GHC.Unit.Finder</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.DFM.html"><span class="hs-identifier">GHC.Types.Unique.DFM</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Plugins.html"><span class="hs-identifier">GHC.Driver.Plugins</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">{- Note [Module self-dependency]
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

GHC.Rename.Names.calculateAvails asserts the invariant that a module must not occur in
its own dep_orphs or dep_finsts. However, if we aren't careful this can occur
in the presence of hs-boot files: Consider that we have two modules, A and B,
both with hs-boot files,

    A.hs contains a SOURCE import of B B.hs-boot contains a SOURCE import of A
    A.hs-boot declares an orphan instance A.hs defines the orphan instance

In this case, B's dep_orphs will contain A due to its SOURCE import of A.
Consequently, A will contain itself in its imp_orphs due to its import of B.
This fact would end up being recorded in A's interface file. This would then
break the invariant asserted by calculateAvails that a module does not itself in
its dep_orphs. This was the cause of #14128.

-}</span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="annot"><a href="GHC.HsToCore.Usage.html#mkUsedNames"><span class="hs-identifier hs-type">mkUsedNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a></span><span>
</span><span id="line-70"></span><span id="mkUsedNames"><span class="annot"><span class="annottext">mkUsedNames :: TcGblEnv -&gt; NameSet
</span><a href="GHC.HsToCore.Usage.html#mkUsedNames"><span class="hs-identifier hs-var hs-var">mkUsedNames</span></a></span></span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tcg_dus :: TcGblEnv -&gt; DefUses
</span><a href="GHC.Tc.Types.html#tcg_dus"><span class="hs-identifier hs-var">tcg_dus</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682061661"><span class="annot"><span class="annottext">DefUses
</span><a href="#local-6989586621682061661"><span class="hs-identifier hs-var">dus</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DefUses -&gt; NameSet
</span><a href="GHC.Types.Name.Set.html#allUses"><span class="hs-identifier hs-var">allUses</span></a></span><span> </span><span class="annot"><span class="annottext">DefUses
</span><a href="#local-6989586621682061661"><span class="hs-identifier hs-var">dus</span></a></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-keyword">data</span><span> </span><span id="UsageConfig"><span class="annot"><a href="GHC.HsToCore.Usage.html#UsageConfig"><span class="hs-identifier hs-var">UsageConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="UsageConfig"><span class="annot"><a href="GHC.HsToCore.Usage.html#UsageConfig"><span class="hs-identifier hs-var">UsageConfig</span></a></span></span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="uc_safe_implicit_imps_req"><span class="annot"><span class="annottext">UsageConfig -&gt; Bool
</span><a href="GHC.HsToCore.Usage.html#uc_safe_implicit_imps_req"><span class="hs-identifier hs-var hs-var">uc_safe_implicit_imps_req</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Are all implicit imports required to be safe for this Safe Haskell mode?</span></span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="annot"><a href="GHC.HsToCore.Usage.html#mkUsageInfo"><span class="hs-identifier hs-type">mkUsageInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.HsToCore.Usage.html#UsageConfig"><span class="hs-identifier hs-type">UsageConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Plugins.html#Plugins"><span class="hs-identifier hs-type">Plugins</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Finder.Types.html#FinderCache"><span class="hs-identifier hs-type">FinderCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Env.html#UnitEnv"><span class="hs-identifier hs-type">UnitEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Imported.html#ImportedMods"><span class="hs-identifier hs-type">ImportedMods</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-77"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Fingerprint.Type.html#Fingerprint/GHC.Fingerprint.Type.html#Fingerprint"><span class="hs-identifier hs-type">Fingerprint</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#PkgsLoaded"><span class="hs-identifier hs-type">PkgsLoaded</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#IfG"><span class="hs-identifier hs-type">IfG</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Module.Deps.html#Usage"><span class="hs-identifier hs-type">Usage</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-78"></span><span id="mkUsageInfo"><span class="annot"><span class="annottext">mkUsageInfo :: UsageConfig
-&gt; Plugins
-&gt; FinderCache
-&gt; UnitEnv
-&gt; Module
-&gt; ImportedMods
-&gt; NameSet
-&gt; [FilePath]
-&gt; [(Module, Fingerprint)]
-&gt; [Linkable]
-&gt; PkgsLoaded
-&gt; IfG [Usage]
</span><a href="GHC.HsToCore.Usage.html#mkUsageInfo"><span class="hs-identifier hs-var hs-var">mkUsageInfo</span></a></span></span><span> </span><span id="local-6989586621682061664"><span class="annot"><span class="annottext">UsageConfig
</span><a href="#local-6989586621682061664"><span class="hs-identifier hs-var">uc</span></a></span></span><span> </span><span id="local-6989586621682061665"><span class="annot"><span class="annottext">Plugins
</span><a href="#local-6989586621682061665"><span class="hs-identifier hs-var">plugins</span></a></span></span><span> </span><span id="local-6989586621682061666"><span class="annot"><span class="annottext">FinderCache
</span><a href="#local-6989586621682061666"><span class="hs-identifier hs-var">fc</span></a></span></span><span> </span><span id="local-6989586621682061667"><span class="annot"><span class="annottext">UnitEnv
</span><a href="#local-6989586621682061667"><span class="hs-identifier hs-var">unit_env</span></a></span></span><span> </span><span id="local-6989586621682061668"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061668"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span id="local-6989586621682061669"><span class="annot"><span class="annottext">ImportedMods
</span><a href="#local-6989586621682061669"><span class="hs-identifier hs-var">dir_imp_mods</span></a></span></span><span> </span><span id="local-6989586621682061670"><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621682061670"><span class="hs-identifier hs-var">used_names</span></a></span></span><span> </span><span id="local-6989586621682061671"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621682061671"><span class="hs-identifier hs-var">dependent_files</span></a></span></span><span> </span><span id="local-6989586621682061672"><span class="annot"><span class="annottext">[(Module, Fingerprint)]
</span><a href="#local-6989586621682061672"><span class="hs-identifier hs-var">merged</span></a></span></span><span> </span><span id="local-6989586621682061673"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621682061673"><span class="hs-identifier hs-var">needed_links</span></a></span></span><span> </span><span id="local-6989586621682061674"><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621682061674"><span class="hs-identifier hs-var">needed_pkgs</span></a></span></span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-80"></span><span>    </span><span id="local-6989586621682061675"><span class="annot"><span class="annottext">ExternalPackageState
</span><a href="#local-6989586621682061675"><span class="hs-identifier hs-var">eps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ExternalPackageState
-&gt; IOEnv (Env IfGblEnv ()) ExternalPackageState
forall a. IO a -&gt; IOEnv (Env IfGblEnv ()) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.18.2.1/src/Control.Monad.IO.Class.html#liftIO/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ExternalPackageState
 -&gt; IOEnv (Env IfGblEnv ()) ExternalPackageState)
-&gt; IO ExternalPackageState
-&gt; IOEnv (Env IfGblEnv ()) ExternalPackageState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IORef ExternalPackageState -&gt; IO ExternalPackageState
forall a. IORef a -&gt; IO a
</span><a href="../../base-4.18.2.1/src/GHC.IORef.html#readIORef/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExternalUnitCache -&gt; IORef ExternalPackageState
</span><a href="GHC.Unit.External.html#euc_eps"><span class="hs-identifier hs-var">euc_eps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnitEnv -&gt; ExternalUnitCache
</span><a href="GHC.Unit.Env.html#ue_eps"><span class="hs-identifier hs-var">ue_eps</span></a></span><span> </span><span class="annot"><span class="annottext">UnitEnv
</span><a href="#local-6989586621682061667"><span class="hs-identifier hs-var">unit_env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>    </span><span id="local-6989586621682061680"><span class="annot"><span class="annottext">[Fingerprint]
</span><a href="#local-6989586621682061680"><span class="hs-identifier hs-var">hashes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [Fingerprint] -&gt; IOEnv (Env IfGblEnv ()) [Fingerprint]
forall a. IO a -&gt; IOEnv (Env IfGblEnv ()) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.18.2.1/src/Control.Monad.IO.Class.html#liftIO/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [Fingerprint] -&gt; IOEnv (Env IfGblEnv ()) [Fingerprint])
-&gt; IO [Fingerprint] -&gt; IOEnv (Env IfGblEnv ()) [Fingerprint]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO Fingerprint) -&gt; [FilePath] -&gt; IO [Fingerprint]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#mapM/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO Fingerprint
</span><a href="../../base-4.18.2.1/src/GHC.Fingerprint.html#getFileHash/GHC.Fingerprint.html#getFileHash"><span class="hs-identifier hs-var">getFileHash</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621682061671"><span class="hs-identifier hs-var">dependent_files</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682061683"><span class="annot"><span class="annottext">hu :: HomeUnit
</span><a href="#local-6989586621682061683"><span class="hs-identifier hs-var hs-var">hu</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnitEnv -&gt; HomeUnit
</span><a href="GHC.Unit.Env.html#unsafeGetHomeUnit"><span class="hs-identifier hs-var">unsafeGetHomeUnit</span></a></span><span> </span><span class="annot"><span class="annottext">UnitEnv
</span><a href="#local-6989586621682061667"><span class="hs-identifier hs-var">unit_env</span></a></span><span>
</span><span id="line-83"></span><span>        </span><span id="local-6989586621682061685"><span class="annot"><span class="annottext">hug :: HomeUnitGraph
</span><a href="#local-6989586621682061685"><span class="hs-identifier hs-var hs-var">hug</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnitEnv -&gt; HomeUnitGraph
</span><a href="GHC.Unit.Env.html#ue_home_unit_graph"><span class="hs-identifier hs-var">ue_home_unit_graph</span></a></span><span> </span><span class="annot"><span class="annottext">UnitEnv
</span><a href="#local-6989586621682061667"><span class="hs-identifier hs-var">unit_env</span></a></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-comment">-- Dependencies on object files due to TH and plugins</span><span>
</span><span id="line-85"></span><span>    </span><span id="local-6989586621682061687"><span class="annot"><span class="annottext">[Usage]
</span><a href="#local-6989586621682061687"><span class="hs-identifier hs-var">object_usages</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [Usage] -&gt; IfG [Usage]
forall a. IO a -&gt; IOEnv (Env IfGblEnv ()) a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.18.2.1/src/Control.Monad.IO.Class.html#liftIO/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [Usage] -&gt; IfG [Usage]) -&gt; IO [Usage] -&gt; IfG [Usage]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PackageIfaceTable
-&gt; Plugins
-&gt; FinderCache
-&gt; HomeUnitGraph
-&gt; [Linkable]
-&gt; PkgsLoaded
-&gt; IO [Usage]
</span><a href="GHC.HsToCore.Usage.html#mkObjectUsage"><span class="hs-identifier hs-var">mkObjectUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExternalPackageState -&gt; PackageIfaceTable
</span><a href="GHC.Unit.External.html#eps_PIT"><span class="hs-identifier hs-var">eps_PIT</span></a></span><span> </span><span class="annot"><span class="annottext">ExternalPackageState
</span><a href="#local-6989586621682061675"><span class="hs-identifier hs-var">eps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Plugins
</span><a href="#local-6989586621682061665"><span class="hs-identifier hs-var">plugins</span></a></span><span> </span><span class="annot"><span class="annottext">FinderCache
</span><a href="#local-6989586621682061666"><span class="hs-identifier hs-var">fc</span></a></span><span> </span><span class="annot"><span class="annottext">HomeUnitGraph
</span><a href="#local-6989586621682061685"><span class="hs-identifier hs-var">hug</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621682061673"><span class="hs-identifier hs-var">needed_links</span></a></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621682061674"><span class="hs-identifier hs-var">needed_pkgs</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682061690"><span class="annot"><span class="annottext">all_home_ids :: Set UnitId
</span><a href="#local-6989586621682061690"><span class="hs-identifier hs-var hs-var">all_home_ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnitEnv -&gt; Set UnitId
</span><a href="GHC.Unit.Env.html#ue_all_home_unit_ids"><span class="hs-identifier hs-var">ue_all_home_unit_ids</span></a></span><span> </span><span class="annot"><span class="annottext">UnitEnv
</span><a href="#local-6989586621682061667"><span class="hs-identifier hs-var">unit_env</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span id="local-6989586621682061692"><span class="annot"><span class="annottext">[Usage]
</span><a href="#local-6989586621682061692"><span class="hs-identifier hs-var">mod_usages</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UsageConfig
-&gt; HomeUnit
-&gt; Set UnitId
-&gt; Module
-&gt; ImportedMods
-&gt; NameSet
-&gt; IfG [Usage]
</span><a href="GHC.HsToCore.Usage.html#mk_mod_usage_info"><span class="hs-identifier hs-var">mk_mod_usage_info</span></a></span><span> </span><span class="annot"><span class="annottext">UsageConfig
</span><a href="#local-6989586621682061664"><span class="hs-identifier hs-var">uc</span></a></span><span> </span><span class="annot"><span class="annottext">HomeUnit
</span><a href="#local-6989586621682061683"><span class="hs-identifier hs-var">hu</span></a></span><span> </span><span class="annot"><span class="annottext">Set UnitId
</span><a href="#local-6989586621682061690"><span class="hs-identifier hs-var">all_home_ids</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061668"><span class="hs-identifier hs-var">this_mod</span></a></span><span>
</span><span id="line-88"></span><span>                                       </span><span class="annot"><span class="annottext">ImportedMods
</span><a href="#local-6989586621682061669"><span class="hs-identifier hs-var">dir_imp_mods</span></a></span><span> </span><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621682061670"><span class="hs-identifier hs-var">used_names</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682061694"><span class="annot"><span class="annottext">usages :: [Usage]
</span><a href="#local-6989586621682061694"><span class="hs-identifier hs-var hs-var">usages</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Usage]
</span><a href="#local-6989586621682061692"><span class="hs-identifier hs-var">mod_usages</span></a></span><span> </span><span class="annot"><span class="annottext">[Usage] -&gt; [Usage] -&gt; [Usage]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html#UsageFile"><span class="hs-identifier hs-type">UsageFile</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">usg_file_path :: FilePath
</span><a href="GHC.Unit.Module.Deps.html#usg_file_path"><span class="hs-identifier hs-var">usg_file_path</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682061697"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-90"></span><span>                                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">usg_file_hash :: Fingerprint
</span><a href="GHC.Unit.Module.Deps.html#usg_file_hash"><span class="hs-identifier hs-var">usg_file_hash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621682061699"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-91"></span><span>                                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">usg_file_label :: Maybe FilePath
</span><a href="GHC.Unit.Module.Deps.html#usg_file_label"><span class="hs-identifier hs-var">usg_file_label</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-92"></span><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682061697"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682061697"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682061699"><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621682061699"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; [Fingerprint] -&gt; [(FilePath, Fingerprint)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#zip/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621682061671"><span class="hs-identifier hs-var">dependent_files</span></a></span><span> </span><span class="annot"><span class="annottext">[Fingerprint]
</span><a href="#local-6989586621682061680"><span class="hs-identifier hs-var">hashes</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-93"></span><span>                            </span><span class="annot"><span class="annottext">[Usage] -&gt; [Usage] -&gt; [Usage]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html#UsageMergedRequirement"><span class="hs-identifier hs-type">UsageMergedRequirement</span></a></span><span>
</span><span id="line-94"></span><span>                                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">usg_mod :: Module
</span><a href="GHC.Unit.Module.Deps.html#usg_mod"><span class="hs-identifier hs-var">usg_mod</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061703"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-95"></span><span>                                      </span><span class="annot"><span class="annottext">usg_mod_hash :: Fingerprint
</span><a href="GHC.Unit.Module.Deps.html#usg_mod_hash"><span class="hs-identifier hs-var">usg_mod_hash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621682061705"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-96"></span><span>                                    </span><span class="hs-special">}</span><span>
</span><span id="line-97"></span><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682061703"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061703"><span class="hs-identifier hs-var">mod</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682061705"><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621682061705"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Module, Fingerprint)]
</span><a href="#local-6989586621682061672"><span class="hs-identifier hs-var">merged</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-98"></span><span>                            </span><span class="annot"><span class="annottext">[Usage] -&gt; [Usage] -&gt; [Usage]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[Usage]
</span><a href="#local-6989586621682061687"><span class="hs-identifier hs-var">object_usages</span></a></span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><span class="annottext">[Usage]
</span><a href="#local-6989586621682061694"><span class="hs-identifier hs-var">usages</span></a></span><span> </span><span class="annot"><span class="annottext">[Usage] -&gt; IfG [Usage] -&gt; IfG [Usage]
forall a b. [a] -&gt; b -&gt; b
</span><a href="GHC.Utils.Misc.html#seqList"><span class="hs-operator hs-var">`seqList`</span></a></span><span> </span><span class="annot"><span class="annottext">[Usage] -&gt; IfG [Usage]
forall a. a -&gt; IOEnv (Env IfGblEnv ()) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">[Usage]
</span><a href="#local-6989586621682061694"><span class="hs-identifier hs-var">usages</span></a></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-comment">-- seq the list of Usages returned: occasionally these</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">-- don't get evaluated for a while and we can end up hanging on to</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">-- the entire collection of Ifaces.</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-comment">{- Note [Plugin dependencies]
   ~~~~~~~~~~~~~~~~~~~~~~~~~~

Modules for which plugins were used in the compilation process, should be
recompiled whenever one of those plugins changes. But how do we know if a
plugin changed from the previous time a module was compiled?

We could try storing the fingerprints of the interface files of plugins in
the interface file of the module. And see if there are changes between
compilation runs. However, this is pretty much a non-option because interface
fingerprints of plugin modules are fairly stable, unless you compile plugins
with optimisations turned on, and give basically all binders an INLINE pragma.

So instead:

  * For plugins that were built locally: we store the filepath and hash of the
    object files of the module with the `plugin` binder, and the object files of
    modules that are dependencies of the plugin module and belong to the same
    `UnitId` as the plugin
  * For plugins in an external package: we store the filepath and hash of
    the dynamic library containing the plugin module.

During recompilation we then compare the hashes of those files again to see
if anything has changed.

One issue with this approach is that object files are currently (GHC 8.6.1)
not created fully deterministically, which could sometimes induce accidental
recompilation of a module for which plugins were used in the compile process.

One way to improve this is to either:

  * Have deterministic object file creation
  * Create and store implementation hashes, which would be based on the Core
    of the module and the implementation hashes of its dependencies, and then
    compare implementation hashes for recompilation. Creation of implementation
    hashes is however potentially expensive.

    A serious issue with the interface hash idea is that if you include an
    interface hash, that hash also needs to depend on the hash of its
    dependencies. Therefore, if any of the transitive dependencies of a modules
    gets updated then you need to recompile the module in case the interface
    hash has changed irrespective if the module uses TH or not.

    This is important to maintain the invariant that the information in the
    interface file is always up-to-date.


    See #20790 (comment 3)
-}</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-comment">{-
Note [Object File Dependencies]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In addition to the Note [Plugin dependencies] above, for TH we also need to record
the hashes of object files that the TH code is required to load. These are
calculated by the loader in `getLinkDeps` and are accumulated in each individual
`TcGblEnv`, in `tcg_th_needed_deps`. We read this just before compute the UsageInfo
to inject the appropriate dependencies.
-}</span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="hs-comment">-- | Find object files corresponding to the transitive closure of given home</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- modules and direct object files for pkg dependencies</span><span>
</span><span id="line-166"></span><span class="annot"><a href="GHC.HsToCore.Usage.html#mkObjectUsage"><span class="hs-identifier hs-type">mkObjectUsage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.External.html#PackageIfaceTable"><span class="hs-identifier hs-type">PackageIfaceTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Plugins.html#Plugins"><span class="hs-identifier hs-type">Plugins</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Finder.Types.html#FinderCache"><span class="hs-identifier hs-type">FinderCache</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Env.html#HomeUnitGraph"><span class="hs-identifier hs-type">HomeUnitGraph</span></a></span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Linker.Types.html#Linkable"><span class="hs-identifier hs-type">Linkable</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#PkgsLoaded"><span class="hs-identifier hs-type">PkgsLoaded</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Module.Deps.html#Usage"><span class="hs-identifier hs-type">Usage</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-167"></span><span id="mkObjectUsage"><span class="annot"><span class="annottext">mkObjectUsage :: PackageIfaceTable
-&gt; Plugins
-&gt; FinderCache
-&gt; HomeUnitGraph
-&gt; [Linkable]
-&gt; PkgsLoaded
-&gt; IO [Usage]
</span><a href="GHC.HsToCore.Usage.html#mkObjectUsage"><span class="hs-identifier hs-var hs-var">mkObjectUsage</span></a></span></span><span> </span><span id="local-6989586621682061707"><span class="annot"><span class="annottext">PackageIfaceTable
</span><a href="#local-6989586621682061707"><span class="hs-identifier hs-var">pit</span></a></span></span><span> </span><span id="local-6989586621682061708"><span class="annot"><span class="annottext">Plugins
</span><a href="#local-6989586621682061708"><span class="hs-identifier hs-var">plugins</span></a></span></span><span> </span><span id="local-6989586621682061709"><span class="annot"><span class="annottext">FinderCache
</span><a href="#local-6989586621682061709"><span class="hs-identifier hs-var">fc</span></a></span></span><span> </span><span id="local-6989586621682061710"><span class="annot"><span class="annottext">HomeUnitGraph
</span><a href="#local-6989586621682061710"><span class="hs-identifier hs-var">hug</span></a></span></span><span> </span><span id="local-6989586621682061711"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621682061711"><span class="hs-identifier hs-var">th_links_needed</span></a></span></span><span> </span><span id="local-6989586621682061712"><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621682061712"><span class="hs-identifier hs-var">th_pkgs_needed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682061713"><span class="annot"><span class="annottext">ls :: [Linkable]
</span><a href="#local-6989586621682061713"><span class="hs-identifier hs-var hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Linkable -&gt; Module) -&gt; [Linkable] -&gt; [Linkable]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#ordNubOn"><span class="hs-identifier hs-var">ordNubOn</span></a></span><span> </span><span class="annot"><span class="annottext">Linkable -&gt; Module
</span><a href="GHC.Linker.Types.html#linkableModule"><span class="hs-identifier hs-var">linkableModule</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621682061711"><span class="hs-identifier hs-var">th_links_needed</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable] -&gt; [Linkable] -&gt; [Linkable]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621682061716"><span class="hs-identifier hs-var">plugins_links_needed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>          </span><span id="local-6989586621682061717"><span class="annot"><span class="annottext">ds :: [LibrarySpec]
</span><a href="#local-6989586621682061717"><span class="hs-identifier hs-var hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LoadedPkgInfo -&gt; [LibrarySpec])
-&gt; [LoadedPkgInfo] -&gt; [LibrarySpec]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#concatMap/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="annot"><span class="annottext">LoadedPkgInfo -&gt; [LibrarySpec]
</span><a href="GHC.Linker.Types.html#loaded_pkg_hs_objs"><span class="hs-identifier hs-var">loaded_pkg_hs_objs</span></a></span><span> </span><span class="annot"><span class="annottext">([LoadedPkgInfo] -&gt; [LibrarySpec])
-&gt; [LoadedPkgInfo] -&gt; [LibrarySpec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded -&gt; [LoadedPkgInfo]
forall key elt. UniqDFM key elt -&gt; [elt]
</span><a href="GHC.Types.Unique.DFM.html#eltsUDFM"><span class="hs-identifier hs-var">eltsUDFM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PkgsLoaded -&gt; PkgsLoaded -&gt; PkgsLoaded
forall key elt.
UniqDFM key elt -&gt; UniqDFM key elt -&gt; UniqDFM key elt
</span><a href="GHC.Types.Unique.DFM.html#plusUDFM"><span class="hs-identifier hs-var">plusUDFM</span></a></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621682061712"><span class="hs-identifier hs-var">th_pkgs_needed</span></a></span><span> </span><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621682061722"><span class="hs-identifier hs-var">plugin_pkgs_needed</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- TODO possibly record loaded_pkg_non_hs_objs as well</span><span>
</span><span id="line-170"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621682061716"><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621682061716"><span class="hs-identifier hs-var">plugins_links_needed</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682061722"><span class="annot"><span class="annottext">PkgsLoaded
</span><a href="#local-6989586621682061722"><span class="hs-identifier hs-var">plugin_pkgs_needed</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Plugins -&gt; ([Linkable], PkgsLoaded)
</span><a href="GHC.Driver.Plugins.html#loadedPluginDeps"><span class="hs-identifier hs-var">loadedPluginDeps</span></a></span><span> </span><span class="annot"><span class="annottext">Plugins
</span><a href="#local-6989586621682061708"><span class="hs-identifier hs-var">plugins</span></a></span><span>
</span><span id="line-171"></span><span>      </span><span class="annot"><span class="annottext">[[Usage]] -&gt; [Usage]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#concat/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="annot"><span class="annottext">([[Usage]] -&gt; [Usage]) -&gt; IO [[Usage]] -&gt; IO [Usage]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.2.1/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[IO [Usage]] -&gt; IO [[Usage]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
forall (m :: * -&gt; *) a. Monad m =&gt; [m a] -&gt; m [a]
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#sequence/Data.Traversable.html#sequence"><span class="hs-identifier hs-var">sequence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Linkable -&gt; IO [Usage]) -&gt; [Linkable] -&gt; [IO [Usage]]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Linkable -&gt; IO [Usage]
</span><a href="#local-6989586621682061727"><span class="hs-identifier hs-var">linkableToUsage</span></a></span><span> </span><span class="annot"><span class="annottext">[Linkable]
</span><a href="#local-6989586621682061713"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="annot"><span class="annottext">[IO [Usage]] -&gt; [IO [Usage]] -&gt; [IO [Usage]]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">(LibrarySpec -&gt; IO [Usage]) -&gt; [LibrarySpec] -&gt; [IO [Usage]]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">LibrarySpec -&gt; IO [Usage]
</span><a href="#local-6989586621682061728"><span class="hs-identifier hs-var">librarySpecToUsage</span></a></span><span> </span><span class="annot"><span class="annottext">[LibrarySpec]
</span><a href="#local-6989586621682061717"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-173"></span><span>    </span><span id="local-6989586621682061727"><span class="annot"><span class="annottext">linkableToUsage :: Linkable -&gt; IO [Usage]
</span><a href="#local-6989586621682061727"><span class="hs-identifier hs-var hs-var">linkableToUsage</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#LM"><span class="hs-identifier hs-type">LM</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682061730"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061730"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682061731"><span class="annot"><span class="annottext">[Unlinked]
</span><a href="#local-6989586621682061731"><span class="hs-identifier hs-var">uls</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Unlinked -&gt; IO Usage) -&gt; [Unlinked] -&gt; IO [Usage]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#mapM/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; Unlinked -&gt; IO Usage
</span><a href="#local-6989586621682061732"><span class="hs-identifier hs-var">unlinkedToUsage</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061730"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Unlinked]
</span><a href="#local-6989586621682061731"><span class="hs-identifier hs-var">uls</span></a></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span>    </span><span id="local-6989586621682061733"><span class="annot"><span class="annottext">msg :: GenModule unit -&gt; FilePath
</span><a href="#local-6989586621682061733"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span id="local-6989586621682061734"><span class="annot"><span class="annottext">GenModule unit
</span><a href="#local-6989586621682061734"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModuleName -&gt; FilePath
</span><a href="Language.Haskell.Syntax.Module.Name.html#moduleNameString"><span class="hs-identifier hs-var">moduleNameString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenModule unit -&gt; ModuleName
forall unit. GenModule unit -&gt; ModuleName
</span><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a></span><span> </span><span class="annot"><span class="annottext">GenModule unit
</span><a href="#local-6989586621682061734"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; FilePath
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;[TH] changed&quot;</span></span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>    </span><span id="local-6989586621682061737"><span class="annot"><span class="annottext">fing :: Maybe FilePath -&gt; FilePath -&gt; IO Usage
</span><a href="#local-6989586621682061737"><span class="hs-identifier hs-var hs-var">fing</span></a></span></span><span> </span><span id="local-6989586621682061738"><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621682061738"><span class="hs-identifier hs-var">mmsg</span></a></span></span><span> </span><span id="local-6989586621682061739"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682061739"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Fingerprint -&gt; Maybe FilePath -&gt; Usage
</span><a href="GHC.Unit.Module.Deps.html#UsageFile"><span class="hs-identifier hs-var">UsageFile</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682061739"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">(Fingerprint -&gt; Maybe FilePath -&gt; Usage)
-&gt; IO Fingerprint -&gt; IO (Maybe FilePath -&gt; Usage)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.2.1/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FinderCache -&gt; FilePath -&gt; IO Fingerprint
</span><a href="GHC.Unit.Finder.html#lookupFileCache"><span class="hs-identifier hs-var">lookupFileCache</span></a></span><span> </span><span class="annot"><span class="annottext">FinderCache
</span><a href="#local-6989586621682061709"><span class="hs-identifier hs-var">fc</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682061739"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe FilePath -&gt; Usage) -&gt; IO (Maybe FilePath) -&gt; IO Usage
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%3C%2A%3E/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe FilePath -&gt; IO (Maybe FilePath)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621682061738"><span class="hs-identifier hs-var">mmsg</span></a></span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span>    </span><span id="local-6989586621682061732"><span class="annot"><span class="annottext">unlinkedToUsage :: Module -&gt; Unlinked -&gt; IO Usage
</span><a href="#local-6989586621682061732"><span class="hs-identifier hs-var hs-var">unlinkedToUsage</span></a></span></span><span> </span><span id="local-6989586621682061741"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061741"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682061742"><span class="annot"><span class="annottext">Unlinked
</span><a href="#local-6989586621682061742"><span class="hs-identifier hs-var">ul</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-180"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Unlinked -&gt; Maybe FilePath
</span><a href="GHC.Linker.Types.html#nameOfObject_maybe"><span class="hs-identifier hs-var">nameOfObject_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Unlinked
</span><a href="#local-6989586621682061742"><span class="hs-identifier hs-var">ul</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-181"></span><span>        </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682061744"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682061744"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe FilePath -&gt; FilePath -&gt; IO Usage
</span><a href="#local-6989586621682061737"><span class="hs-identifier hs-var">fing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; Maybe FilePath
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; FilePath
forall {unit}. GenModule unit -&gt; FilePath
</span><a href="#local-6989586621682061733"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061741"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682061744"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-182"></span><span>        </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-183"></span><span>          </span><span class="hs-comment">-- This should only happen for home package things but oneshot puts</span><span>
</span><span id="line-184"></span><span>          </span><span class="hs-comment">-- home package ifaces in the PIT.</span><span>
</span><span id="line-185"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682061745"><span class="annot"><span class="annottext">miface :: Maybe ModIface
</span><a href="#local-6989586621682061745"><span class="hs-identifier hs-var hs-var">miface</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HomeUnitGraph -&gt; PackageIfaceTable -&gt; Module -&gt; Maybe ModIface
</span><a href="GHC.Driver.Env.html#lookupIfaceByModule"><span class="hs-identifier hs-var">lookupIfaceByModule</span></a></span><span> </span><span class="annot"><span class="annottext">HomeUnitGraph
</span><a href="#local-6989586621682061710"><span class="hs-identifier hs-var">hug</span></a></span><span> </span><span class="annot"><span class="annottext">PackageIfaceTable
</span><a href="#local-6989586621682061707"><span class="hs-identifier hs-var">pit</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061741"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-186"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ModIface
</span><a href="#local-6989586621682061745"><span class="hs-identifier hs-var">miface</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-187"></span><span>            </span><span class="annot"><span class="annottext">Maybe ModIface
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; SDoc -&gt; IO Usage
forall a. HasCallStack =&gt; FilePath -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;mkObjectUsage&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061741"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>            </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682061749"><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621682061749"><span class="hs-identifier hs-var">iface</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>              </span><span class="annot"><span class="annottext">Usage -&gt; IO Usage
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; IO Usage) -&gt; Usage -&gt; IO Usage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName -&gt; UnitId -&gt; Fingerprint -&gt; Usage
</span><a href="GHC.Unit.Module.Deps.html#UsageHomeModuleInterface"><span class="hs-identifier hs-var">UsageHomeModuleInterface</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; ModuleName
forall unit. GenModule unit -&gt; ModuleName
</span><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061741"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unit -&gt; UnitId
</span><a href="GHC.Unit.Types.html#toUnitId"><span class="hs-identifier hs-var">toUnitId</span></a></span><span> </span><span class="annot"><span class="annottext">(Unit -&gt; UnitId) -&gt; Unit -&gt; UnitId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Module -&gt; Unit
forall unit. GenModule unit -&gt; unit
</span><a href="GHC.Unit.Types.html#moduleUnit"><span class="hs-identifier hs-var">moduleUnit</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061741"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModIfaceBackend -&gt; Fingerprint
</span><a href="GHC.Unit.Module.ModIface.html#mi_iface_hash"><span class="hs-identifier hs-var">mi_iface_hash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModIface -&gt; IfaceBackendExts 'ModIfaceFinal
forall (phase :: ModIfacePhase).
ModIface_ phase -&gt; IfaceBackendExts phase
</span><a href="GHC.Unit.Module.ModIface.html#mi_final_exts"><span class="hs-identifier hs-var">mi_final_exts</span></a></span><span> </span><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621682061749"><span class="hs-identifier hs-var">iface</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><a href="#local-6989586621682061728"><span class="hs-identifier hs-type">librarySpecToUsage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Module.Deps.html#Usage"><span class="hs-identifier hs-type">Usage</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-192"></span><span>    </span><span id="local-6989586621682061728"><span class="annot"><span class="annottext">librarySpecToUsage :: LibrarySpec -&gt; IO [Usage]
</span><a href="#local-6989586621682061728"><span class="hs-identifier hs-var hs-var">librarySpecToUsage</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#Objects"><span class="hs-identifier hs-type">Objects</span></a></span><span> </span><span id="local-6989586621682061756"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621682061756"><span class="hs-identifier hs-var">os</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO Usage) -&gt; [FilePath] -&gt; IO [Usage]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#traverse/Data.Traversable.html#traverse"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe FilePath -&gt; FilePath -&gt; IO Usage
</span><a href="#local-6989586621682061737"><span class="hs-identifier hs-var">fing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621682061756"><span class="hs-identifier hs-var">os</span></a></span><span>
</span><span id="line-193"></span><span>    </span><span class="annot"><a href="#local-6989586621682061728"><span class="hs-identifier hs-var">librarySpecToUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#Archive"><span class="hs-identifier hs-type">Archive</span></a></span><span> </span><span id="local-6989586621682061759"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682061759"><span class="hs-identifier hs-var">fn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO Usage) -&gt; [FilePath] -&gt; IO [Usage]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#traverse/Data.Traversable.html#traverse"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe FilePath -&gt; FilePath -&gt; IO Usage
</span><a href="#local-6989586621682061737"><span class="hs-identifier hs-var">fing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682061759"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><a href="#local-6989586621682061728"><span class="hs-identifier hs-var">librarySpecToUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#DLLPath"><span class="hs-identifier hs-type">DLLPath</span></a></span><span> </span><span id="local-6989586621682061761"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682061761"><span class="hs-identifier hs-var">fn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; IO Usage) -&gt; [FilePath] -&gt; IO [Usage]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#traverse/Data.Traversable.html#traverse"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe FilePath -&gt; FilePath -&gt; IO Usage
</span><a href="#local-6989586621682061737"><span class="hs-identifier hs-var">fing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621682061761"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><a href="#local-6989586621682061728"><span class="hs-identifier hs-var">librarySpecToUsage</span></a></span><span> </span><span class="annot"><span class="annottext">LibrarySpec
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Usage] -&gt; IO [Usage]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="annot"><a href="GHC.HsToCore.Usage.html#mk_mod_usage_info"><span class="hs-identifier hs-type">mk_mod_usage_info</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.HsToCore.Usage.html#UsageConfig"><span class="hs-identifier hs-type">UsageConfig</span></a></span><span>
</span><span id="line-198"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Home.html#HomeUnit"><span class="hs-identifier hs-type">HomeUnit</span></a></span><span>
</span><span id="line-199"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../containers-0.6.7/src/Data.Set.Internal.html#Set/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set.Set</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a></span><span>
</span><span id="line-200"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span>
</span><span id="line-201"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Imported.html#ImportedMods"><span class="hs-identifier hs-type">ImportedMods</span></a></span><span>
</span><span id="line-202"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.Set.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a></span><span>
</span><span id="line-203"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#IfG"><span class="hs-identifier hs-type">IfG</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Module.Deps.html#Usage"><span class="hs-identifier hs-type">Usage</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-204"></span><span id="mk_mod_usage_info"><span class="annot"><span class="annottext">mk_mod_usage_info :: UsageConfig
-&gt; HomeUnit
-&gt; Set UnitId
-&gt; Module
-&gt; ImportedMods
-&gt; NameSet
-&gt; IfG [Usage]
</span><a href="GHC.HsToCore.Usage.html#mk_mod_usage_info"><span class="hs-identifier hs-var hs-var">mk_mod_usage_info</span></a></span></span><span> </span><span id="local-6989586621682061762"><span class="annot"><span class="annottext">UsageConfig
</span><a href="#local-6989586621682061762"><span class="hs-identifier hs-var">uc</span></a></span></span><span> </span><span id="local-6989586621682061763"><span class="annot"><span class="annottext">HomeUnit
</span><a href="#local-6989586621682061763"><span class="hs-identifier hs-var">home_unit</span></a></span></span><span> </span><span id="local-6989586621682061764"><span class="annot"><span class="annottext">Set UnitId
</span><a href="#local-6989586621682061764"><span class="hs-identifier hs-var">home_unit_ids</span></a></span></span><span> </span><span id="local-6989586621682061765"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061765"><span class="hs-identifier hs-var">this_mod</span></a></span></span><span> </span><span id="local-6989586621682061766"><span class="annot"><span class="annottext">ImportedMods
</span><a href="#local-6989586621682061766"><span class="hs-identifier hs-var">direct_imports</span></a></span></span><span> </span><span id="local-6989586621682061767"><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621682061767"><span class="hs-identifier hs-var">used_names</span></a></span></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Module -&gt; IOEnv (Env IfGblEnv ()) (Maybe Usage))
-&gt; [Module] -&gt; IfG [Usage]
forall (m :: * -&gt; *) a b.
Applicative m =&gt;
(a -&gt; m (Maybe b)) -&gt; [a] -&gt; m [b]
</span><a href="GHC.Utils.Monad.html#mapMaybeM"><span class="hs-identifier hs-var">mapMaybeM</span></a></span><span> </span><span class="annot"><span class="annottext">Module -&gt; IOEnv (Env IfGblEnv ()) (Maybe Usage)
</span><a href="#local-6989586621682061769"><span class="hs-identifier hs-var">mkUsageM</span></a></span><span> </span><span class="annot"><span class="annottext">[Module]
</span><a href="#local-6989586621682061770"><span class="hs-identifier hs-var">usage_mods</span></a></span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-207"></span><span>    </span><span id="local-6989586621682061771"><span class="annot"><span class="annottext">safe_implicit_imps_req :: Bool
</span><a href="#local-6989586621682061771"><span class="hs-identifier hs-var hs-var">safe_implicit_imps_req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageConfig -&gt; Bool
</span><a href="GHC.HsToCore.Usage.html#uc_safe_implicit_imps_req"><span class="hs-identifier hs-var">uc_safe_implicit_imps_req</span></a></span><span> </span><span class="annot"><span class="annottext">UsageConfig
</span><a href="#local-6989586621682061762"><span class="hs-identifier hs-var">uc</span></a></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621682061772"><span class="annot"><span class="annottext">used_mods :: [Module]
</span><a href="#local-6989586621682061772"><span class="hs-identifier hs-var hs-var">used_mods</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModuleEnv [OccName] -&gt; [Module]
forall a. ModuleEnv a -&gt; [Module]
</span><a href="GHC.Unit.Module.Env.html#moduleEnvKeys"><span class="hs-identifier hs-var">moduleEnvKeys</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleEnv [OccName]
</span><a href="#local-6989586621682061774"><span class="hs-identifier hs-var">ent_map</span></a></span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621682061775"><span class="annot"><span class="annottext">dir_imp_mods :: [Module]
</span><a href="#local-6989586621682061775"><span class="hs-identifier hs-var hs-var">dir_imp_mods</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImportedMods -&gt; [Module]
forall a. ModuleEnv a -&gt; [Module]
</span><a href="GHC.Unit.Module.Env.html#moduleEnvKeys"><span class="hs-identifier hs-var">moduleEnvKeys</span></a></span><span> </span><span class="annot"><span class="annottext">ImportedMods
</span><a href="#local-6989586621682061766"><span class="hs-identifier hs-var">direct_imports</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621682061776"><span class="annot"><span class="annottext">all_mods :: [Module]
</span><a href="#local-6989586621682061776"><span class="hs-identifier hs-var hs-var">all_mods</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Module]
</span><a href="#local-6989586621682061772"><span class="hs-identifier hs-var">used_mods</span></a></span><span> </span><span class="annot"><span class="annottext">[Module] -&gt; [Module] -&gt; [Module]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">(Module -&gt; Bool) -&gt; [Module] -&gt; [Module]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#filter/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; [Module] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#notElem/Data.Foldable.html#notElem"><span class="hs-operator hs-var">`notElem`</span></a></span><span> </span><span class="annot"><span class="annottext">[Module]
</span><a href="#local-6989586621682061772"><span class="hs-identifier hs-var">used_mods</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Module]
</span><a href="#local-6989586621682061775"><span class="hs-identifier hs-var">dir_imp_mods</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span id="local-6989586621682061770"><span class="annot"><span class="annottext">usage_mods :: [Module]
</span><a href="#local-6989586621682061770"><span class="hs-identifier hs-var hs-var">usage_mods</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Module -&gt; Module -&gt; Ordering) -&gt; [Module] -&gt; [Module]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/Data.OldList.html#sortBy/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a></span><span> </span><span class="annot"><span class="annottext">Module -&gt; Module -&gt; Ordering
</span><a href="GHC.Unit.Module.html#stableModuleCmp"><span class="hs-identifier hs-var">stableModuleCmp</span></a></span><span> </span><span class="annot"><span class="annottext">[Module]
</span><a href="#local-6989586621682061776"><span class="hs-identifier hs-var">all_mods</span></a></span><span>
</span><span id="line-213"></span><span>                        </span><span class="hs-comment">-- canonical order is imported, to avoid interface-file</span><span>
</span><span id="line-214"></span><span>                        </span><span class="hs-comment">-- wobblage.</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span>    </span><span class="hs-comment">-- ent_map groups together all the things imported and used</span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-comment">-- from a particular module</span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><a href="#local-6989586621682061774"><span class="hs-identifier hs-type">ent_map</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Env.html#ModuleEnv"><span class="hs-identifier hs-type">ModuleEnv</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Name.Occurrence.html#OccName"><span class="hs-identifier hs-type">OccName</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-219"></span><span>    </span><span id="local-6989586621682061774"><span class="annot"><span class="annottext">ent_map :: ModuleEnv [OccName]
</span><a href="#local-6989586621682061774"><span class="hs-identifier hs-var hs-var">ent_map</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; ModuleEnv [OccName] -&gt; ModuleEnv [OccName])
-&gt; ModuleEnv [OccName] -&gt; NameSet -&gt; ModuleEnv [OccName]
forall elt a. (elt -&gt; a -&gt; a) -&gt; a -&gt; UniqSet elt -&gt; a
</span><a href="GHC.Types.Unique.Set.html#nonDetStrictFoldUniqSet"><span class="hs-identifier hs-var">nonDetStrictFoldUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; ModuleEnv [OccName] -&gt; ModuleEnv [OccName]
</span><a href="#local-6989586621682061780"><span class="hs-identifier hs-var">add_mv</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleEnv [OccName]
forall a. ModuleEnv a
</span><a href="GHC.Unit.Module.Env.html#emptyModuleEnv"><span class="hs-identifier hs-var">emptyModuleEnv</span></a></span><span> </span><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621682061767"><span class="hs-identifier hs-var">used_names</span></a></span><span>
</span><span id="line-220"></span><span>     </span><span class="hs-comment">-- nonDetStrictFoldUniqSet is OK here. If you follow the logic, we sort by</span><span>
</span><span id="line-221"></span><span>     </span><span class="hs-comment">-- OccName in ent_hashs</span><span>
</span><span id="line-222"></span><span>     </span><span class="hs-keyword">where</span><span>
</span><span id="line-223"></span><span>      </span><span id="local-6989586621682061780"><span class="annot"><span class="annottext">add_mv :: Name -&gt; ModuleEnv [OccName] -&gt; ModuleEnv [OccName]
</span><a href="#local-6989586621682061780"><span class="hs-identifier hs-var hs-var">add_mv</span></a></span></span><span> </span><span id="local-6989586621682061782"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682061782"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621682061783"><span class="annot"><span class="annottext">ModuleEnv [OccName]
</span><a href="#local-6989586621682061783"><span class="hs-identifier hs-var">mv_map</span></a></span></span><span>
</span><span id="line-224"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isWiredInName"><span class="hs-identifier hs-var">isWiredInName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682061782"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModuleEnv [OccName]
</span><a href="#local-6989586621682061783"><span class="hs-identifier hs-var">mv_map</span></a></span><span>  </span><span class="hs-comment">-- ignore wired-in names</span><span>
</span><span id="line-225"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-226"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Module
</span><a href="GHC.Types.Name.html#nameModule_maybe"><span class="hs-identifier hs-var">nameModule_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682061782"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-227"></span><span>             </span><span class="annot"><span class="annottext">Maybe Module
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; ModuleEnv [OccName] -&gt; ModuleEnv [OccName]
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isSystemName"><span class="hs-identifier hs-var">isSystemName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682061782"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682061782"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ModuleEnv [OccName]
</span><a href="#local-6989586621682061783"><span class="hs-identifier hs-var">mv_map</span></a></span><span>
</span><span id="line-228"></span><span>                </span><span class="hs-comment">-- See Note [Internal used_names]</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span>             </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682061788"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061788"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-231"></span><span>                </span><span class="hs-comment">-- See Note [Identity versus semantic module]</span><span>
</span><span id="line-232"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682061789"><span class="annot"><span class="annottext">mod' :: Module
</span><a href="#local-6989586621682061789"><span class="hs-identifier hs-var hs-var">mod'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Module -&gt; Bool
forall u. GenModule (GenUnit u) -&gt; Bool
</span><a href="GHC.Unit.Module.html#isHoleModule"><span class="hs-identifier hs-var">isHoleModule</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061788"><span class="hs-identifier hs-var">mod</span></a></span><span>
</span><span id="line-233"></span><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">HomeUnit -&gt; ModuleName -&gt; Module
</span><a href="GHC.Unit.Home.html#mkHomeModule"><span class="hs-identifier hs-var">mkHomeModule</span></a></span><span> </span><span class="annot"><span class="annottext">HomeUnit
</span><a href="#local-6989586621682061763"><span class="hs-identifier hs-var">home_unit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; ModuleName
forall unit. GenModule unit -&gt; ModuleName
</span><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061788"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061788"><span class="hs-identifier hs-var">mod</span></a></span><span>
</span><span id="line-235"></span><span>                </span><span class="hs-comment">-- This lambda function is really just a</span><span>
</span><span id="line-236"></span><span>                </span><span class="hs-comment">-- specialised (++); originally came about to</span><span>
</span><span id="line-237"></span><span>                </span><span class="hs-comment">-- avoid quadratic behaviour (trac #2680)</span><span>
</span><span id="line-238"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">([OccName] -&gt; [OccName] -&gt; [OccName])
-&gt; ModuleEnv [OccName]
-&gt; Module
-&gt; [OccName]
-&gt; ModuleEnv [OccName]
forall a.
(a -&gt; a -&gt; a) -&gt; ModuleEnv a -&gt; Module -&gt; a -&gt; ModuleEnv a
</span><a href="GHC.Unit.Module.Env.html#extendModuleEnvWith"><span class="hs-identifier hs-var">extendModuleEnvWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">[OccName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682061793"><span class="annot"><span class="annottext">[OccName]
</span><a href="#local-6989586621682061793"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621682061794"><span class="hs-identifier hs-var">occ</span></a></span><span class="annot"><span class="annottext">OccName -&gt; [OccName] -&gt; [OccName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[OccName]
</span><a href="#local-6989586621682061793"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ModuleEnv [OccName]
</span><a href="#local-6989586621682061783"><span class="hs-identifier hs-var">mv_map</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061789"><span class="hs-identifier hs-var">mod'</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621682061794"><span class="hs-identifier hs-var">occ</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-239"></span><span>            </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621682061794"><span class="annot"><span class="annottext">occ :: OccName
</span><a href="#local-6989586621682061794"><span class="hs-identifier hs-var hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OccName
</span><a href="GHC.Types.Name.html#nameOccName"><span class="hs-identifier hs-var">nameOccName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682061782"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span>    </span><span class="annot"><a href="#local-6989586621682061769"><span class="hs-identifier hs-type">mkUsageM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#IfG"><span class="hs-identifier hs-type">IfG</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html#Usage"><span class="hs-identifier hs-type">Usage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>    </span><span id="local-6989586621682061769"><span class="annot"><span class="annottext">mkUsageM :: Module -&gt; IOEnv (Env IfGblEnv ()) (Maybe Usage)
</span><a href="#local-6989586621682061769"><span class="hs-identifier hs-var hs-var">mkUsageM</span></a></span></span><span> </span><span id="local-6989586621682061796"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061796"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061796"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">Module -&gt; Module -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061765"><span class="hs-identifier hs-var">this_mod</span></a></span><span> </span><span class="hs-comment">-- We don't care about usages of things in *this* module</span><span>
</span><span id="line-243"></span><span>                 </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Module -&gt; Unit
forall unit. GenModule unit -&gt; unit
</span><a href="GHC.Unit.Types.html#moduleUnit"><span class="hs-identifier hs-var">moduleUnit</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061796"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">Unit -&gt; Unit -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Unit
</span><a href="GHC.Unit.Types.html#interactiveUnit"><span class="hs-identifier hs-var">interactiveUnit</span></a></span><span> </span><span class="hs-comment">-- ... or in GHCi</span><span>
</span><span id="line-244"></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Usage -&gt; IOEnv (Env IfGblEnv ()) (Maybe Usage)
forall a. a -&gt; IOEnv (Env IfGblEnv ()) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Usage
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><a href="#local-6989586621682061769"><span class="hs-identifier hs-var">mkUsageM</span></a></span><span> </span><span id="local-6989586621682061799"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061799"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-246"></span><span>      </span><span id="local-6989586621682061800"><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621682061800"><span class="hs-identifier hs-var">iface</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; Module -&gt; IfM () ModIface
forall lcl. SDoc -&gt; Module -&gt; IfM lcl ModIface
</span><a href="GHC.Iface.Load.html#loadSysInterface"><span class="hs-identifier hs-var">loadSysInterface</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;mk_mod_usage&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061799"><span class="hs-identifier hs-var">mod</span></a></span><span>
</span><span id="line-247"></span><span>        </span><span class="hs-comment">-- Make sure the interface is loaded even if we don't directly use</span><span>
</span><span id="line-248"></span><span>        </span><span class="hs-comment">-- any symbols from it, to ensure determinism. See #22217.</span><span>
</span><span id="line-249"></span><span>      </span><span class="annot"><span class="annottext">Maybe Usage -&gt; IOEnv (Env IfGblEnv ()) (Maybe Usage)
forall a. a -&gt; IOEnv (Env IfGblEnv ()) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Usage -&gt; IOEnv (Env IfGblEnv ()) (Maybe Usage))
-&gt; Maybe Usage -&gt; IOEnv (Env IfGblEnv ()) (Maybe Usage)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Module -&gt; ModIface -&gt; Maybe Usage
</span><a href="#local-6989586621682061803"><span class="hs-identifier hs-var">mkUsage</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061799"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621682061800"><span class="hs-identifier hs-var">iface</span></a></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-comment">-- We want to create a Usage for a home module if</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-comment">--  a) we used something from it; has something in used_names</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-comment">--  b) we imported it, even if we used nothing from it</span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-comment">--     (need to recompile if its export list changes: export_fprint)</span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><a href="#local-6989586621682061803"><span class="hs-identifier hs-type">mkUsage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModIface.html#ModIface"><span class="hs-identifier hs-type">ModIface</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html#Usage"><span class="hs-identifier hs-type">Usage</span></a></span><span>
</span><span id="line-257"></span><span>    </span><span id="local-6989586621682061803"><span class="annot"><span class="annottext">mkUsage :: Module -&gt; ModIface -&gt; Maybe Usage
</span><a href="#local-6989586621682061803"><span class="hs-identifier hs-var hs-var">mkUsage</span></a></span></span><span> </span><span id="local-6989586621682061804"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061804"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span id="local-6989586621682061805"><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621682061805"><span class="hs-identifier hs-var">iface</span></a></span></span><span>
</span><span id="line-258"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unit -&gt; UnitId
</span><a href="GHC.Unit.Types.html#toUnitId"><span class="hs-identifier hs-var">toUnitId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; Unit
forall unit. GenModule unit -&gt; unit
</span><a href="GHC.Unit.Types.html#moduleUnit"><span class="hs-identifier hs-var">moduleUnit</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061804"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UnitId -&gt; Set UnitId -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#notMember/Data.Set.Internal.html#notMember"><span class="hs-operator hs-var">`Set.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">Set UnitId
</span><a href="#local-6989586621682061764"><span class="hs-identifier hs-var">home_unit_ids</span></a></span><span>
</span><span id="line-259"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Usage -&gt; Maybe Usage
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; Maybe Usage) -&gt; Usage -&gt; Maybe Usage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html#UsagePackageModule"><span class="hs-identifier hs-type">UsagePackageModule</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">usg_mod :: Module
</span><a href="GHC.Unit.Module.Deps.html#usg_mod"><span class="hs-identifier hs-var">usg_mod</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061804"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-260"></span><span>                                   </span><span class="annot"><span class="annottext">usg_mod_hash :: Fingerprint
</span><a href="GHC.Unit.Module.Deps.html#usg_mod_hash"><span class="hs-identifier hs-var">usg_mod_hash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621682061808"><span class="hs-identifier hs-var">mod_hash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-261"></span><span>                                   </span><span class="annot"><span class="annottext">usg_safe :: Bool
</span><a href="GHC.Unit.Module.Deps.html#usg_safe"><span class="hs-identifier hs-var">usg_safe</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682061810"><span class="hs-identifier hs-var">imp_safe</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-comment">-- for package modules, we record the module hash only</span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OccName] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[OccName]
</span><a href="#local-6989586621682061812"><span class="hs-identifier hs-var">used_occs</span></a></span><span>
</span><span id="line-265"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Fingerprint -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Maybe.html#isNothing/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Fingerprint
</span><a href="#local-6989586621682061815"><span class="hs-identifier hs-var">export_hash</span></a></span><span>
</span><span id="line-266"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682061817"><span class="hs-identifier hs-var">is_direct_import</span></a></span><span>
</span><span id="line-267"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682061818"><span class="hs-identifier hs-var">finsts_mod</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Usage
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                 </span><span class="hs-comment">-- Record no usage info</span><span>
</span><span id="line-269"></span><span>        </span><span class="hs-comment">-- for directly-imported modules, we always want to record a usage</span><span>
</span><span id="line-270"></span><span>        </span><span class="hs-comment">-- on the orphan hash.  This is what triggers a recompilation if</span><span>
</span><span id="line-271"></span><span>        </span><span class="hs-comment">-- an orphan is added or removed somewhere below us in the future.</span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-274"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Usage -&gt; Maybe Usage
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html#UsageHomeModule"><span class="hs-identifier hs-type">UsageHomeModule</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-275"></span><span>                      </span><span class="annot"><span class="annottext">usg_mod_name :: ModuleName
</span><a href="GHC.Unit.Module.Deps.html#usg_mod_name"><span class="hs-identifier hs-var">usg_mod_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Module -&gt; ModuleName
forall unit. GenModule unit -&gt; ModuleName
</span><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061804"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-276"></span><span>                      </span><span class="annot"><span class="annottext">usg_unit_id :: UnitId
</span><a href="GHC.Unit.Module.Deps.html#usg_unit_id"><span class="hs-identifier hs-var">usg_unit_id</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unit -&gt; UnitId
</span><a href="GHC.Unit.Types.html#toUnitId"><span class="hs-identifier hs-var">toUnitId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; Unit
forall unit. GenModule unit -&gt; unit
</span><a href="GHC.Unit.Types.html#moduleUnit"><span class="hs-identifier hs-var">moduleUnit</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061804"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-277"></span><span>                      </span><span class="annot"><span class="annottext">usg_mod_hash :: Fingerprint
</span><a href="GHC.Unit.Module.Deps.html#usg_mod_hash"><span class="hs-identifier hs-var">usg_mod_hash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621682061808"><span class="hs-identifier hs-var">mod_hash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-278"></span><span>                      </span><span class="annot"><span class="annottext">usg_exports :: Maybe Fingerprint
</span><a href="GHC.Unit.Module.Deps.html#usg_exports"><span class="hs-identifier hs-var">usg_exports</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Fingerprint
</span><a href="#local-6989586621682061815"><span class="hs-identifier hs-var">export_hash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-279"></span><span>                      </span><span class="annot"><span class="annottext">usg_entities :: [(OccName, Fingerprint)]
</span><a href="GHC.Unit.Module.Deps.html#usg_entities"><span class="hs-identifier hs-var">usg_entities</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map OccName Fingerprint -&gt; [(OccName, Fingerprint)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../containers-0.6.7/src/Data.Map.Internal.html#toList/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">Map.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Map OccName Fingerprint
</span><a href="#local-6989586621682061825"><span class="hs-identifier hs-var">ent_hashs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-280"></span><span>                      </span><span class="annot"><span class="annottext">usg_safe :: Bool
</span><a href="GHC.Unit.Module.Deps.html#usg_safe"><span class="hs-identifier hs-var">usg_safe</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682061810"><span class="hs-identifier hs-var">imp_safe</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-281"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-282"></span><span>        </span><span id="local-6989586621682061818"><span class="annot"><span class="annottext">finsts_mod :: Bool
</span><a href="#local-6989586621682061818"><span class="hs-identifier hs-var hs-var">finsts_mod</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModIfaceBackend -&gt; Bool
</span><a href="GHC.Unit.Module.ModIface.html#mi_finsts"><span class="hs-identifier hs-var">mi_finsts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModIface -&gt; IfaceBackendExts 'ModIfaceFinal
forall (phase :: ModIfacePhase).
ModIface_ phase -&gt; IfaceBackendExts phase
</span><a href="GHC.Unit.Module.ModIface.html#mi_final_exts"><span class="hs-identifier hs-var">mi_final_exts</span></a></span><span> </span><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621682061805"><span class="hs-identifier hs-var">iface</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>        </span><span id="local-6989586621682061827"><span class="annot"><span class="annottext">hash_env :: OccName -&gt; Maybe (OccName, Fingerprint)
</span><a href="#local-6989586621682061827"><span class="hs-identifier hs-var hs-var">hash_env</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModIfaceBackend -&gt; OccName -&gt; Maybe (OccName, Fingerprint)
</span><a href="GHC.Unit.Module.ModIface.html#mi_hash_fn"><span class="hs-identifier hs-var">mi_hash_fn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModIface -&gt; IfaceBackendExts 'ModIfaceFinal
forall (phase :: ModIfacePhase).
ModIface_ phase -&gt; IfaceBackendExts phase
</span><a href="GHC.Unit.Module.ModIface.html#mi_final_exts"><span class="hs-identifier hs-var">mi_final_exts</span></a></span><span> </span><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621682061805"><span class="hs-identifier hs-var">iface</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>        </span><span id="local-6989586621682061808"><span class="annot"><span class="annottext">mod_hash :: Fingerprint
</span><a href="#local-6989586621682061808"><span class="hs-identifier hs-var hs-var">mod_hash</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModIfaceBackend -&gt; Fingerprint
</span><a href="GHC.Unit.Module.ModIface.html#mi_mod_hash"><span class="hs-identifier hs-var">mi_mod_hash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModIface -&gt; IfaceBackendExts 'ModIfaceFinal
forall (phase :: ModIfacePhase).
ModIface_ phase -&gt; IfaceBackendExts phase
</span><a href="GHC.Unit.Module.ModIface.html#mi_final_exts"><span class="hs-identifier hs-var">mi_final_exts</span></a></span><span> </span><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621682061805"><span class="hs-identifier hs-var">iface</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>        </span><span id="local-6989586621682061815"><span class="annot"><span class="annottext">export_hash :: Maybe Fingerprint
</span><a href="#local-6989586621682061815"><span class="hs-identifier hs-var hs-var">export_hash</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682061830"><span class="hs-identifier hs-var">depend_on_exports</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fingerprint -&gt; Maybe Fingerprint
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModIfaceBackend -&gt; Fingerprint
</span><a href="GHC.Unit.Module.ModIface.html#mi_exp_hash"><span class="hs-identifier hs-var">mi_exp_hash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModIface -&gt; IfaceBackendExts 'ModIfaceFinal
forall (phase :: ModIfacePhase).
ModIface_ phase -&gt; IfaceBackendExts phase
</span><a href="GHC.Unit.Module.ModIface.html#mi_final_exts"><span class="hs-identifier hs-var">mi_final_exts</span></a></span><span> </span><span class="annot"><span class="annottext">ModIface
</span><a href="#local-6989586621682061805"><span class="hs-identifier hs-var">iface</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Fingerprint
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>        </span><span id="local-6989586621682061832"><span class="annot"><span class="annottext">by_is_safe :: ImportedBy -&gt; Bool
</span><a href="#local-6989586621682061832"><span class="hs-identifier hs-var hs-var">by_is_safe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.Imported.html#ImportedByUser"><span class="hs-identifier hs-type">ImportedByUser</span></a></span><span> </span><span id="local-6989586621682061834"><span class="annot"><span class="annottext">ImportedModsVal
</span><a href="#local-6989586621682061834"><span class="hs-identifier hs-var">imv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImportedModsVal -&gt; Bool
</span><a href="GHC.Unit.Module.Imported.html#imv_is_safe"><span class="hs-identifier hs-var">imv_is_safe</span></a></span><span> </span><span class="annot"><span class="annottext">ImportedModsVal
</span><a href="#local-6989586621682061834"><span class="hs-identifier hs-var">imv</span></a></span><span>
</span><span id="line-289"></span><span>        </span><span class="annot"><a href="#local-6989586621682061832"><span class="hs-identifier hs-var">by_is_safe</span></a></span><span> </span><span class="annot"><span class="annottext">ImportedBy
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-290"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621682061817"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682061817"><span class="hs-identifier hs-var">is_direct_import</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682061810"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682061810"><span class="hs-identifier hs-var">imp_safe</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ImportedMods -&gt; Module -&gt; Maybe [ImportedBy]
forall a. ModuleEnv a -&gt; Module -&gt; Maybe a
</span><a href="GHC.Unit.Module.Env.html#lookupModuleEnv"><span class="hs-identifier hs-var">lookupModuleEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ImportedMods
</span><a href="#local-6989586621682061766"><span class="hs-identifier hs-var">direct_imports</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061804"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-292"></span><span>                </span><span class="hs-comment">-- ezyang: I'm not sure if any is the correct</span><span>
</span><span id="line-293"></span><span>                </span><span class="hs-comment">-- metric here. If safety was guaranteed to be uniform</span><span>
</span><span id="line-294"></span><span>                </span><span class="hs-comment">-- across all imports, why did the old code only look</span><span>
</span><span id="line-295"></span><span>                </span><span class="hs-comment">-- at the first import?</span><span>
</span><span id="line-296"></span><span>                </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682061837"><span class="annot"><span class="annottext">[ImportedBy]
</span><a href="#local-6989586621682061837"><span class="hs-identifier hs-var">bys</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(ImportedBy -&gt; Bool) -&gt; [ImportedBy] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#any/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="annot"><span class="annottext">ImportedBy -&gt; Bool
</span><a href="#local-6989586621682061832"><span class="hs-identifier hs-var">by_is_safe</span></a></span><span> </span><span class="annot"><span class="annottext">[ImportedBy]
</span><a href="#local-6989586621682061837"><span class="hs-identifier hs-var">bys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>                </span><span class="annot"><span class="annottext">Maybe [ImportedBy]
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682061771"><span class="hs-identifier hs-var">safe_implicit_imps_req</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>                </span><span class="hs-comment">-- Nothing case is for references to entities which were</span><span>
</span><span id="line-299"></span><span>                </span><span class="hs-comment">-- not directly imported (NB: the &quot;implicit&quot; Prelude import</span><span>
</span><span id="line-300"></span><span>                </span><span class="hs-comment">-- counts as directly imported!  An entity is not directly</span><span>
</span><span id="line-301"></span><span>                </span><span class="hs-comment">-- imported if, e.g., we got a reference to it from a</span><span>
</span><span id="line-302"></span><span>                </span><span class="hs-comment">-- reexport of another module.)</span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>        </span><span id="local-6989586621682061812"><span class="annot"><span class="annottext">used_occs :: [OccName]
</span><a href="#local-6989586621682061812"><span class="hs-identifier hs-var hs-var">used_occs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModuleEnv [OccName] -&gt; Module -&gt; Maybe [OccName]
forall a. ModuleEnv a -&gt; Module -&gt; Maybe a
</span><a href="GHC.Unit.Module.Env.html#lookupModuleEnv"><span class="hs-identifier hs-var">lookupModuleEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleEnv [OccName]
</span><a href="#local-6989586621682061774"><span class="hs-identifier hs-var">ent_map</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061804"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [OccName] -&gt; [OccName] -&gt; [OccName]
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span>        </span><span class="hs-comment">-- Making a Map here ensures that (a) we remove duplicates</span><span>
</span><span id="line-307"></span><span>        </span><span class="hs-comment">-- when we have usages on several subordinates of a single parent,</span><span>
</span><span id="line-308"></span><span>        </span><span class="hs-comment">-- and (b) that the usages emerge in a canonical order, which</span><span>
</span><span id="line-309"></span><span>        </span><span class="hs-comment">-- is why we use Map rather than OccEnv: Map works</span><span>
</span><span id="line-310"></span><span>        </span><span class="hs-comment">-- using Ord on the OccNames, which is a lexicographic ordering.</span><span>
</span><span id="line-311"></span><span>        </span><span class="annot"><a href="#local-6989586621682061825"><span class="hs-identifier hs-type">ent_hashs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../containers-0.6.7/src/Data.Map.Internal.html#Map/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Name.Occurrence.html#OccName"><span class="hs-identifier hs-type">OccName</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Fingerprint.Type.html#Fingerprint/GHC.Fingerprint.Type.html#Fingerprint"><span class="hs-identifier hs-type">Fingerprint</span></a></span><span>
</span><span id="line-312"></span><span>        </span><span id="local-6989586621682061825"><span class="annot"><span class="annottext">ent_hashs :: Map OccName Fingerprint
</span><a href="#local-6989586621682061825"><span class="hs-identifier hs-var hs-var">ent_hashs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(OccName, Fingerprint)] -&gt; Map OccName Fingerprint
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../containers-0.6.7/src/Data.Map.Internal.html#fromList/Data.Map.Internal.html#fromList"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(OccName -&gt; (OccName, Fingerprint))
-&gt; [OccName] -&gt; [(OccName, Fingerprint)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">OccName -&gt; (OccName, Fingerprint)
</span><a href="#local-6989586621682061841"><span class="hs-identifier hs-var">lookup_occ</span></a></span><span> </span><span class="annot"><span class="annottext">[OccName]
</span><a href="#local-6989586621682061812"><span class="hs-identifier hs-var">used_occs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>        </span><span id="local-6989586621682061841"><span class="annot"><span class="annottext">lookup_occ :: OccName -&gt; (OccName, Fingerprint)
</span><a href="#local-6989586621682061841"><span class="hs-identifier hs-var hs-var">lookup_occ</span></a></span></span><span> </span><span id="local-6989586621682061842"><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621682061842"><span class="hs-identifier hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-315"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OccName -&gt; Maybe (OccName, Fingerprint)
</span><a href="#local-6989586621682061827"><span class="hs-identifier hs-var">hash_env</span></a></span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621682061842"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-316"></span><span>                </span><span class="annot"><span class="annottext">Maybe (OccName, Fingerprint)
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; SDoc -&gt; (OccName, Fingerprint)
forall a. HasCallStack =&gt; FilePath -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;mkUsage&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621682061804"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">OccName -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">OccName
</span><a href="#local-6989586621682061842"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">NameSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621682061767"><span class="hs-identifier hs-var">used_names</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>                </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682061844"><span class="annot"><span class="annottext">(OccName, Fingerprint)
</span><a href="#local-6989586621682061844"><span class="hs-identifier hs-var">r</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(OccName, Fingerprint)
</span><a href="#local-6989586621682061844"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span>        </span><span id="local-6989586621682061830"><span class="annot"><span class="annottext">depend_on_exports :: Bool
</span><a href="#local-6989586621682061830"><span class="hs-identifier hs-var hs-var">depend_on_exports</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682061817"><span class="hs-identifier hs-var">is_direct_import</span></a></span><span>
</span><span id="line-320"></span><span>        </span><span class="hs-comment">{- True
              Even if we used 'import M ()', we have to register a
              usage on the export list because we are sensitive to
              changes in orphan instances/rules.
           False
              In GHC 6.8.x we always returned true, and in
              fact it recorded a dependency on *all* the
              modules underneath in the dependency tree.  This
              happens to make orphans work right, but is too
              expensive: it'll read too many interface files.
              The 'isNothing maybe_iface' check above saved us
              from generating many of these usages (at least in
              one-shot mode), but that's even more bogus!
        -}</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span class="hs-comment">{-
Note [Internal used_names]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Most of the used_names are External Names, but we can have System
Names too. Two examples:

* Names arising from Language.Haskell.TH.newName.
  See Note [Binders in Template Haskell] in GHC.ThToHs (and #5362).
* The names of auxiliary bindings in derived instances.
  See Note [Auxiliary binders] in GHC.Tc.Deriv.Generate.

Such Names are always for locally-defined things, for which we don't gather
usage info, so we can just ignore them in ent_map. Moreover, they are always
System Names, hence the assert, just as a double check.
-}</span><span>
</span><span id="line-350"></span></pre></body></html>