<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns   #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Tc.Solver.Interact</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-4"></span><span>     </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#solveSimpleGivens"><span class="hs-identifier">solveSimpleGivens</span></a></span><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- Solves [Ct]</span><span>
</span><span id="line-5"></span><span>     </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#solveSimpleWanteds"><span class="hs-identifier">solveSimpleWanteds</span></a></span><span>   </span><span class="hs-comment">-- Solves Cts</span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier">SwapFlag</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#IntWithInf"><span class="hs-identifier">IntWithInf</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#intGtLimit"><span class="hs-identifier">intGtLimit</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html"><span class="hs-identifier">GHC.Tc.Solver.Canonical</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Errors.Types.html"><span class="hs-identifier">GHC.Tc.Errors.Types</span></a></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html"><span class="hs-identifier">GHC.Tc.Utils.TcType</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#coercibleTyConKey"><span class="hs-identifier">coercibleTyConKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#heqTyConKey"><span class="hs-identifier">heqTyConKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#eqTyConKey"><span class="hs-identifier">eqTyConKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#ipClassKey"><span class="hs-identifier">ipClassKey</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html"><span class="hs-identifier">GHC.Tc.Instance.FunDeps</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Family.html"><span class="hs-identifier">GHC.Tc.Instance.Family</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html"><span class="hs-identifier">GHC.Tc.Instance.Class</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#InstanceWhat"><span class="hs-identifier">InstanceWhat</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#safeOverlap"><span class="hs-identifier">safeOverlap</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html"><span class="hs-identifier">GHC.Tc.Types.Evidence</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html"><span class="hs-identifier">GHC.Tc.Types</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html"><span class="hs-identifier">GHC.Tc.Types.Constraint</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html"><span class="hs-identifier">GHC.Tc.Types.Origin</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html"><span class="hs-identifier">GHC.Tc.Utils.TcMType</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html#promoteMetaTyVarTo"><span class="hs-identifier">promoteMetaTyVarTo</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Types.html"><span class="hs-identifier">GHC.Tc.Solver.Types</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html"><span class="hs-identifier">GHC.Tc.Solver.InertSet</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html"><span class="hs-identifier">GHC.Tc.Solver.Monad</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.InstEnv.html"><span class="hs-identifier">GHC.Core.InstEnv</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.InstEnv.html#DFunInstType"><span class="hs-identifier">DFunInstType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Class.html"><span class="hs-identifier">GHC.Core.Class</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html"><span class="hs-identifier">GHC.Core.Reduction</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html"><span class="hs-identifier">GHC.Core.FamInstEnv</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html"><span class="hs-identifier">GHC.Core.Unify</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTyWithTFs"><span class="hs-identifier">tcUnifyTyWithTFs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html#ruleMatchTyKiX"><span class="hs-identifier">ruleMatchTyKiX</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html"><span class="hs-identifier">GHC.Core.Coercion.Axiom</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier">CoAxBranch</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxiom"><span class="hs-identifier">CoAxiom</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#TypeEqn"><span class="hs-identifier">TypeEqn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#fromBranches"><span class="hs-identifier">fromBranches</span></a></span><span>
</span><span id="line-44"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#sfInteractInert"><span class="hs-identifier">sfInteractInert</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#sfInteractTop"><span class="hs-identifier">sfInteractTop</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html"><span class="hs-identifier">GHC.Types.SrcLoc</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html"><span class="hs-identifier">GHC.Types.Unique</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#hasKey"><span class="hs-identifier">hasKey</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html"><span class="hs-identifier">GHC.Data.Bag</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html"><span class="hs-identifier">GHC.Data.Pair</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier">Pair</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html"><span class="hs-identifier">GHC.Utils.Monad</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html#concatMapM"><span class="hs-identifier">concatMapM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldlM/Data.Foldable.html#foldlM"><span class="hs-identifier">foldlM</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html"><span class="hs-identifier">GHC.Driver.Session</span></a></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../ghc-boot-9.6.6/src/GHC.LanguageExtensions.html#/GHC.LanguageExtensions.html"><span class="hs-identifier">GHC.LanguageExtensions</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LangExt</span></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.List.html#/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.OldList.html#deleteFirstsBy/Data.OldList.html#deleteFirstsBy"><span class="hs-identifier">deleteFirstsBy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Maybe.html#/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Maybe.html#listToMaybe/Data.Maybe.html#listToMaybe"><span class="hs-identifier">listToMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Maybe.html#mapMaybe/Data.Maybe.html#mapMaybe"><span class="hs-identifier">mapMaybe</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Function.html#/Data.Function.html"><span class="hs-identifier">Data.Function</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Function.html#on/Data.Function.html#on"><span class="hs-identifier">on</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Semigroup.html#/Data.Semigroup.html"><span class="hs-identifier">Data.Semigroup</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#/Control.Monad.Trans.Class.html"><span class="hs-identifier">Control.Monad.Trans.Class</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Maybe.html#/Control.Monad.Trans.Maybe.html"><span class="hs-identifier">Control.Monad.Trans.Maybe</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Control.Monad.html#/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-comment">{-
**********************************************************************
*                                                                    *
*                      Main Interaction Solver                       *
*                                                                    *
**********************************************************************

Note [Basic Simplifier Plan]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
1. Pick an element from the WorkList if there exists one with depth
   less than our context-stack depth.

2. Run it down the 'stage' pipeline. Stages are:
      - canonicalization
      - inert reactions
      - spontaneous reactions
      - top-level interactions
   Each stage returns a StopOrContinue and may have sideeffected
   the inerts or worklist.

   The threading of the stages is as follows:
      - If (Stop) is returned by a stage then we start again from Step 1.
      - If (ContinueWith ct) is returned by a stage, we feed 'ct' on to
        the next stage in the pipeline.
4. If the element has survived (i.e. ContinueWith x) the last stage
   then we add it in the inerts and jump back to Step 1.

If in Step 1 no such element exists, we have exceeded our context-stack
depth and will simply fail.
-}</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#solveSimpleGivens"><span class="hs-identifier hs-type">solveSimpleGivens</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span id="solveSimpleGivens"><span class="annot"><span class="annottext">solveSimpleGivens :: [Ct] -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#solveSimpleGivens"><span class="hs-identifier hs-var hs-var">solveSimpleGivens</span></a></span></span><span> </span><span id="local-6989586621681975512"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975512"><span class="hs-identifier hs-var">givens</span></a></span></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975512"><span class="hs-identifier hs-var">givens</span></a></span><span>  </span><span class="hs-comment">-- Shortcut for common case</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcS ()
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;solveSimpleGivens {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ct] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975512"><span class="hs-identifier hs-var">givens</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; TcS ()
</span><a href="#local-6989586621681975516"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975512"><span class="hs-identifier hs-var">givens</span></a></span><span>
</span><span id="line-107"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;End solveSimpleGivens }&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-109"></span><span>    </span><span id="local-6989586621681975516"><span class="annot"><span class="annottext">go :: [Ct] -&gt; TcS ()
</span><a href="#local-6989586621681975516"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681975522"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975522"><span class="hs-identifier hs-var">givens</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#solveSimples"><span class="hs-identifier hs-var">solveSimples</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ct] -&gt; Cts
forall a. [a] -&gt; Bag a
</span><a href="GHC.Data.Bag.html#listToBag"><span class="hs-identifier hs-var">listToBag</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975522"><span class="hs-identifier hs-var">givens</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>                   </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975525"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975525"><span class="hs-identifier hs-var">new_givens</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS [Ct]
</span><a href="GHC.Tc.Solver.Interact.html#runTcPluginsGiven"><span class="hs-identifier hs-var">runTcPluginsGiven</span></a></span><span>
</span><span id="line-111"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS () -&gt; TcS ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#when/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ct] -&gt; Bool
forall (f :: * -&gt; *) a. Foldable f =&gt; f a -&gt; Bool
</span><a href="GHC.Utils.Misc.html#notNull"><span class="hs-identifier hs-var">notNull</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975525"><span class="hs-identifier hs-var">new_givens</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcS () -&gt; TcS ()) -&gt; TcS () -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-112"></span><span>                     </span><span class="annot"><span class="annottext">[Ct] -&gt; TcS ()
</span><a href="#local-6989586621681975516"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975525"><span class="hs-identifier hs-var">new_givens</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#solveSimpleWanteds"><span class="hs-identifier hs-type">solveSimpleWanteds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Cts"><span class="hs-identifier hs-type">Cts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-115"></span><span class="hs-comment">-- The result is not necessarily zonked</span><span>
</span><span id="line-116"></span><span id="solveSimpleWanteds"><span class="annot"><span class="annottext">solveSimpleWanteds :: Cts -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.Interact.html#solveSimpleWanteds"><span class="hs-identifier hs-var hs-var">solveSimpleWanteds</span></a></span></span><span> </span><span id="local-6989586621681975529"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975529"><span class="hs-identifier hs-var">simples</span></a></span></span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;solveSimpleWanteds {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cts -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975529"><span class="hs-identifier hs-var">simples</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975530"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681975530"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.Session.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-119"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681975532"><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681975532"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681975533"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975533"><span class="hs-identifier hs-var">wc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScDepth
-&gt; IntWithInf
-&gt; WantedConstraints
-&gt; TcS (ScDepth, WantedConstraints)
</span><a href="#local-6989586621681975534"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ScDepth
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; IntWithInf
</span><a href="GHC.Driver.Session.html#solverIterations"><span class="hs-identifier hs-var">solverIterations</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681975530"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="GHC.Tc.Types.Constraint.html#emptyWC"><span class="hs-identifier hs-var">emptyWC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681975529"><span class="hs-identifier hs-type">simples</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;solveSimpleWanteds end }&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-121"></span><span>             </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iterations =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ScDepth -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681975532"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-122"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;residual =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975533"><span class="hs-identifier hs-var">wc</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-123"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975533"><span class="hs-identifier hs-var">wc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><a href="#local-6989586621681975534"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#IntWithInf"><span class="hs-identifier hs-type">IntWithInf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621681975534"><span class="annot"><span class="annottext">go :: ScDepth
-&gt; IntWithInf
-&gt; WantedConstraints
-&gt; TcS (ScDepth, WantedConstraints)
</span><a href="#local-6989586621681975534"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681975541"><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681975541"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681975542"><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621681975542"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span id="local-6989586621681975543"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975543"><span class="hs-identifier hs-var">wc</span></a></span></span><span>
</span><span id="line-127"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681975541"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">ScDepth -&gt; IntWithInf -&gt; Bool
</span><a href="GHC.Types.Basic.html#intGtLimit"><span class="hs-operator hs-var">`intGtLimit`</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621681975542"><span class="hs-identifier hs-var">limit</span></a></span><span>
</span><span id="line-128"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRnMessage -&gt; TcS (ScDepth, WantedConstraints)
forall a. TcRnMessage -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#failTcS"><span class="hs-identifier hs-var">failTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcS (ScDepth, WantedConstraints))
-&gt; TcRnMessage -&gt; TcS (ScDepth, WantedConstraints)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Cts -&gt; IntWithInf -&gt; WantedConstraints -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnSimplifierTooManyIterations"><span class="hs-identifier hs-var">TcRnSimplifierTooManyIterations</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975529"><span class="hs-identifier hs-var">simples</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621681975542"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975543"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-129"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; Bool
forall a. Bag a -&gt; Bool
</span><a href="GHC.Data.Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975543"><span class="hs-identifier hs-var">wc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ScDepth, WantedConstraints) -&gt; TcS (ScDepth, WantedConstraints)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681975541"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975543"><span class="hs-identifier hs-var">wc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-133"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Solve</span><span>
</span><span id="line-134"></span><span>            </span><span id="local-6989586621681975547"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975547"><span class="hs-identifier hs-var">wc1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.Interact.html#solve_simple_wanteds"><span class="hs-identifier hs-var">solve_simple_wanteds</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975543"><span class="hs-identifier hs-var">wc</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>            </span><span class="hs-comment">-- Run plugins</span><span>
</span><span id="line-137"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681975549"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975549"><span class="hs-identifier hs-var">rerun_plugin</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681975550"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975550"><span class="hs-identifier hs-var">wc2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS (Bool, WantedConstraints)
</span><a href="GHC.Tc.Solver.Interact.html#runTcPluginsWanted"><span class="hs-identifier hs-var">runTcPluginsWanted</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975547"><span class="hs-identifier hs-var">wc1</span></a></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975549"><span class="hs-identifier hs-var">rerun_plugin</span></a></span><span>
</span><span id="line-140"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;solveSimple going round again:&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975549"><span class="hs-identifier hs-var">rerun_plugin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ScDepth
-&gt; IntWithInf
-&gt; WantedConstraints
-&gt; TcS (ScDepth, WantedConstraints)
</span><a href="#local-6989586621681975534"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681975541"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">ScDepth -&gt; ScDepth -&gt; ScDepth
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.2.1/src/GHC.Num.html#%2B/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">ScDepth
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><a href="#local-6989586621681975542"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975550"><span class="hs-identifier hs-var">wc2</span></a></span><span> </span><span class="hs-special">}</span><span>   </span><span class="hs-comment">-- Loop</span><span>
</span><span id="line-142"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(ScDepth, WantedConstraints) -&gt; TcS (ScDepth, WantedConstraints)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681975541"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975550"><span class="hs-identifier hs-var">wc2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>           </span><span class="hs-comment">-- Done</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#solve_simple_wanteds"><span class="hs-identifier hs-type">solve_simple_wanteds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span>
</span><span id="line-146"></span><span class="hs-comment">-- Try solving these constraints</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- Affects the unification state (of course) but not the inert set</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- The result is not necessarily zonked</span><span>
</span><span id="line-149"></span><span id="solve_simple_wanteds"><span class="annot"><span class="annottext">solve_simple_wanteds :: WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.Interact.html#solve_simple_wanteds"><span class="hs-identifier hs-var hs-var">solve_simple_wanteds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975554"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975554"><span class="hs-identifier hs-var">simples1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_impl :: WantedConstraints -&gt; Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975556"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621681975556"><span class="hs-identifier hs-var">implics1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_errors :: WantedConstraints -&gt; Bag DelayedError
</span><a href="GHC.Tc.Types.Constraint.html#wc_errors"><span class="hs-identifier hs-var">wc_errors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975558"><span class="annot"><span class="annottext">Bag DelayedError
</span><a href="#local-6989586621681975558"><span class="hs-identifier hs-var">errs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcS WantedConstraints -&gt; TcS WantedConstraints
forall a. TcS a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#nestTcS"><span class="hs-identifier hs-var">nestTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS WantedConstraints -&gt; TcS WantedConstraints)
-&gt; TcS WantedConstraints -&gt; TcS WantedConstraints
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#solveSimples"><span class="hs-identifier hs-var">solveSimples</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975554"><span class="hs-identifier hs-var">simples1</span></a></span><span>
</span><span id="line-152"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681975560"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621681975560"><span class="hs-identifier hs-var">implics2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681975561"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975561"><span class="hs-identifier hs-var">unsolved</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS (Bag Implication, Cts)
</span><a href="GHC.Tc.Solver.Monad.html#getUnsolvedInerts"><span class="hs-identifier hs-var">getUnsolvedInerts</span></a></span><span>
</span><span id="line-153"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975561"><span class="hs-identifier hs-var">unsolved</span></a></span><span>
</span><span id="line-154"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_impl :: Bag Implication
</span><a href="GHC.Tc.Types.Constraint.html#wc_impl"><span class="hs-identifier hs-var">wc_impl</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621681975556"><span class="hs-identifier hs-var">implics1</span></a></span><span> </span><span class="annot"><span class="annottext">Bag Implication -&gt; Bag Implication -&gt; Bag Implication
forall a. Bag a -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#unionBags"><span class="hs-operator hs-var">`unionBags`</span></a></span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621681975560"><span class="hs-identifier hs-var">implics2</span></a></span><span>
</span><span id="line-155"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wc_errors :: Bag DelayedError
</span><a href="GHC.Tc.Types.Constraint.html#wc_errors"><span class="hs-identifier hs-var">wc_errors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bag DelayedError
</span><a href="#local-6989586621681975558"><span class="hs-identifier hs-var">errs</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="hs-comment">{- Note [The solveSimpleWanteds loop]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Solving a bunch of simple constraints is done in a loop,
(the 'go' loop of 'solveSimpleWanteds'):
  1. Try to solve them
  2. Try the plugin
  3. If the plugin wants to run again, go back to step 1
-}</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="hs-comment">-- The main solver loop implements Note [Basic Simplifier Plan]</span><span>
</span><span id="line-167"></span><span class="hs-comment">---------------------------------------------------------------</span><span>
</span><span id="line-168"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#solveSimples"><span class="hs-identifier hs-type">solveSimples</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Cts"><span class="hs-identifier hs-type">Cts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span class="hs-comment">-- Returns the final InertSet in TcS</span><span>
</span><span id="line-170"></span><span class="hs-comment">-- Has no effect on work-list or residual-implications</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- The constraints are initially examined in left-to-right order</span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span id="solveSimples"><span class="annot"><span class="annottext">solveSimples :: Cts -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#solveSimples"><span class="hs-identifier hs-var hs-var">solveSimples</span></a></span></span><span> </span><span id="local-6989586621681975564"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975564"><span class="hs-identifier hs-var">cts</span></a></span></span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;solveSimples&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">(WorkList -&gt; WorkList) -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#updWorkListTcS"><span class="hs-identifier hs-var">updWorkListTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681975566"><span class="annot"><span class="annottext">WorkList
</span><a href="#local-6989586621681975566"><span class="hs-identifier hs-var">wl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; WorkList -&gt; WorkList) -&gt; WorkList -&gt; Cts -&gt; WorkList
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; Bag a -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; WorkList -&gt; WorkList
</span><a href="GHC.Tc.Solver.InertSet.html#extendWorkListCt"><span class="hs-identifier hs-var">extendWorkListCt</span></a></span><span> </span><span class="annot"><span class="annottext">WorkList
</span><a href="#local-6989586621681975566"><span class="hs-identifier hs-var">wl</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975564"><span class="hs-identifier hs-var">cts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcS ()
</span><a href="#local-6989586621681975569"><span class="hs-identifier hs-var">solve_loop</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-178"></span><span>    </span><span id="local-6989586621681975569"><span class="annot"><span class="annottext">solve_loop :: TcS ()
</span><a href="#local-6989586621681975569"><span class="hs-identifier hs-var hs-var">solve_loop</span></a></span></span><span>
</span><span id="line-179"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;solve_loop&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-180"></span><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681975573"><span class="annot"><span class="annottext">Maybe Ct
</span><a href="#local-6989586621681975573"><span class="hs-identifier hs-var">sel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS (Maybe Ct)
</span><a href="GHC.Tc.Solver.Monad.html#selectNextWorkItem"><span class="hs-identifier hs-var">selectNextWorkItem</span></a></span><span>
</span><span id="line-181"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Ct
</span><a href="#local-6989586621681975573"><span class="hs-identifier hs-var">sel</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-182"></span><span>              </span><span class="annot"><span class="annottext">Maybe Ct
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcS ()
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>              </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681975575"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975575"><span class="hs-identifier hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">[(String, SimplifierStage)] -&gt; Ct -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#runSolverPipeline"><span class="hs-identifier hs-var">runSolverPipeline</span></a></span><span> </span><span class="annot"><span class="annottext">[(String, SimplifierStage)]
</span><a href="GHC.Tc.Solver.Interact.html#thePipeline"><span class="hs-identifier hs-var">thePipeline</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975575"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-184"></span><span>                            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcS ()
</span><a href="#local-6989586621681975569"><span class="hs-identifier hs-var">solve_loop</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">-- | Extract the (inert) givens and invoke the plugins on them.</span><span>
</span><span id="line-187"></span><span class="hs-comment">-- Remove solved givens from the inert set and emit insolubles, but</span><span>
</span><span id="line-188"></span><span class="hs-comment">-- return new work produced so that 'solveSimpleGivens' can feed it back</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- into the main solver.</span><span>
</span><span id="line-190"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#runTcPluginsGiven"><span class="hs-identifier hs-type">runTcPluginsGiven</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-191"></span><span id="runTcPluginsGiven"><span class="annot"><span class="annottext">runTcPluginsGiven :: TcS [Ct]
</span><a href="GHC.Tc.Solver.Interact.html#runTcPluginsGiven"><span class="hs-identifier hs-var hs-var">runTcPluginsGiven</span></a></span></span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681975578"><span class="annot"><span class="annottext">[TcPluginSolver]
</span><a href="#local-6989586621681975578"><span class="hs-identifier hs-var">solvers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS [TcPluginSolver]
</span><a href="GHC.Tc.Solver.Interact.html#getTcPluginSolvers"><span class="hs-identifier hs-var">getTcPluginSolvers</span></a></span><span>
</span><span id="line-193"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[TcPluginSolver] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPluginSolver]
</span><a href="#local-6989586621681975578"><span class="hs-identifier hs-var">solvers</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; TcS [Ct]
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681975580"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975580"><span class="hs-identifier hs-var">givens</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS [Ct]
</span><a href="GHC.Tc.Solver.Monad.html#getInertGivens"><span class="hs-identifier hs-var">getInertGivens</span></a></span><span>
</span><span id="line-195"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975580"><span class="hs-identifier hs-var">givens</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; TcS [Ct]
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681975582"><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975582"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcPluginSolver] -&gt; SplitCts -&gt; TcS TcPluginProgress
</span><a href="GHC.Tc.Solver.Interact.html#runTcPluginSolvers"><span class="hs-identifier hs-var">runTcPluginSolvers</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPluginSolver]
</span><a href="#local-6989586621681975578"><span class="hs-identifier hs-var">solvers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975580"><span class="hs-identifier hs-var">givens</span></a></span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681975584"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975584"><span class="hs-identifier hs-var">solved_givens</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(EvTerm, Ct)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcPluginProgress -&gt; ([Ct], [(EvTerm, Ct)])
</span><a href="GHC.Tc.Solver.Interact.html#pluginSolvedCts"><span class="hs-identifier hs-var">pluginSolvedCts</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975582"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-198"></span><span>             </span><span id="local-6989586621681975586"><span class="annot"><span class="annottext">insols :: [Ct]
</span><a href="#local-6989586621681975586"><span class="hs-identifier hs-var hs-var">insols</span></a></span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcPluginProgress -&gt; [Ct]
</span><a href="GHC.Tc.Solver.Interact.html#pluginBadCts"><span class="hs-identifier hs-var">pluginBadCts</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975582"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-199"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(InertCans -&gt; InertCans) -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#updInertCans"><span class="hs-identifier hs-var">updInertCans</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ct] -&gt; InertCans -&gt; InertCans
</span><a href="GHC.Tc.Solver.Monad.html#removeInertCts"><span class="hs-identifier hs-var">removeInertCts</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975584"><span class="hs-identifier hs-var">solved_givens</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Cts -&gt; Cts) -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#updInertIrreds"><span class="hs-identifier hs-var">updInertIrreds</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681975591"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975591"><span class="hs-identifier hs-var">irreds</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; [Ct] -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#extendCtsList"><span class="hs-identifier hs-var">extendCtsList</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975591"><span class="hs-identifier hs-var">irreds</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975586"><span class="hs-identifier hs-var">insols</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; TcS [Ct]
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPluginProgress -&gt; [Ct]
</span><a href="GHC.Tc.Solver.Interact.html#pluginNewCts"><span class="hs-identifier hs-var">pluginNewCts</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975582"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="hs-comment">-- | Given a bag of (rewritten, zonked) wanteds, invoke the plugins on</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- them and produce an updated bag of wanteds (possibly with some new</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- work) and a bag of insolubles.  The boolean indicates whether</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- 'solveSimpleWanteds' should feed the updated wanteds back into the</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- main solver.</span><span>
</span><span id="line-208"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#runTcPluginsWanted"><span class="hs-identifier hs-type">runTcPluginsWanted</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span id="runTcPluginsWanted"><span class="annot"><span class="annottext">runTcPluginsWanted :: WantedConstraints -&gt; TcS (Bool, WantedConstraints)
</span><a href="GHC.Tc.Solver.Interact.html#runTcPluginsWanted"><span class="hs-identifier hs-var hs-var">runTcPluginsWanted</span></a></span></span><span> </span><span id="local-6989586621681975594"><span class="annot"><span class="annottext">wc :: WantedConstraints
</span><a href="#local-6989586621681975594"><span class="hs-identifier hs-var">wc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#WC"><span class="hs-identifier hs-type">WC</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">wc_simple :: WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975595"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975595"><span class="hs-identifier hs-var">simples1</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; Bool
forall a. Bag a -&gt; Bool
</span><a href="GHC.Data.Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975595"><span class="hs-identifier hs-var">simples1</span></a></span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, WantedConstraints) -&gt; TcS (Bool, WantedConstraints)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975594"><span class="hs-identifier hs-var">wc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681975596"><span class="annot"><span class="annottext">[TcPluginSolver]
</span><a href="#local-6989586621681975596"><span class="hs-identifier hs-var">solvers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS [TcPluginSolver]
</span><a href="GHC.Tc.Solver.Interact.html#getTcPluginSolvers"><span class="hs-identifier hs-var">getTcPluginSolvers</span></a></span><span>
</span><span id="line-214"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[TcPluginSolver] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPluginSolver]
</span><a href="#local-6989586621681975596"><span class="hs-identifier hs-var">solvers</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(Bool, WantedConstraints) -&gt; TcS (Bool, WantedConstraints)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975594"><span class="hs-identifier hs-var">wc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681975597"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975597"><span class="hs-identifier hs-var">given</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS [Ct]
</span><a href="GHC.Tc.Solver.Monad.html#getInertGivens"><span class="hs-identifier hs-var">getInertGivens</span></a></span><span>
</span><span id="line-217"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975598"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975598"><span class="hs-identifier hs-var">wanted</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; TcS Cts
</span><a href="GHC.Tc.Solver.Monad.html#zonkSimples"><span class="hs-identifier hs-var">zonkSimples</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975595"><span class="hs-identifier hs-var">simples1</span></a></span><span>    </span><span class="hs-comment">-- Plugin requires zonked inputs</span><span>
</span><span id="line-218"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975600"><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975600"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcPluginSolver] -&gt; SplitCts -&gt; TcS TcPluginProgress
</span><a href="GHC.Tc.Solver.Interact.html#runTcPluginSolvers"><span class="hs-identifier hs-var">runTcPluginSolvers</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPluginSolver]
</span><a href="#local-6989586621681975596"><span class="hs-identifier hs-var">solvers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975597"><span class="hs-identifier hs-var">given</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; [Ct]
forall a. Bag a -&gt; [a]
</span><a href="GHC.Data.Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975598"><span class="hs-identifier hs-var">wanted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ct]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681975602"><span class="annot"><span class="annottext">[(EvTerm, Ct)]
</span><a href="#local-6989586621681975602"><span class="hs-identifier hs-var">solved_wanted</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcPluginProgress -&gt; ([Ct], [(EvTerm, Ct)])
</span><a href="GHC.Tc.Solver.Interact.html#pluginSolvedCts"><span class="hs-identifier hs-var">pluginSolvedCts</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975600"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-220"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ct]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681975603"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975603"><span class="hs-identifier hs-var">unsolved_wanted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcPluginProgress -&gt; SplitCts
</span><a href="GHC.Tc.Solver.Interact.html#pluginInputCts"><span class="hs-identifier hs-var">pluginInputCts</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975600"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-221"></span><span>             </span><span id="local-6989586621681975605"><span class="annot"><span class="annottext">new_wanted :: [Ct]
</span><a href="#local-6989586621681975605"><span class="hs-identifier hs-var hs-var">new_wanted</span></a></span></span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcPluginProgress -&gt; [Ct]
</span><a href="GHC.Tc.Solver.Interact.html#pluginNewCts"><span class="hs-identifier hs-var">pluginNewCts</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975600"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-222"></span><span>             </span><span id="local-6989586621681975606"><span class="annot"><span class="annottext">insols :: [Ct]
</span><a href="#local-6989586621681975606"><span class="hs-identifier hs-var hs-var">insols</span></a></span></span><span>                                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcPluginProgress -&gt; [Ct]
</span><a href="GHC.Tc.Solver.Interact.html#pluginBadCts"><span class="hs-identifier hs-var">pluginBadCts</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975600"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-comment">-- SLPJ: I'm deeply suspicious of this</span><span>
</span><span id="line-225"></span><span class="hs-comment">--       ; updInertCans (removeInertCts $ solved_givens)</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">((EvTerm, Ct) -&gt; TcS ()) -&gt; [(EvTerm, Ct)] -&gt; TcS ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#mapM_/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="annot"><span class="annottext">(EvTerm, Ct) -&gt; TcS ()
</span><a href="#local-6989586621681975608"><span class="hs-identifier hs-var">setEv</span></a></span><span> </span><span class="annot"><span class="annottext">[(EvTerm, Ct)]
</span><a href="#local-6989586621681975602"><span class="hs-identifier hs-var">solved_wanted</span></a></span><span>
</span><span id="line-228"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Bool, WantedConstraints) -&gt; TcS (Bool, WantedConstraints)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; Bool
forall (f :: * -&gt; *) a. Foldable f =&gt; f a -&gt; Bool
</span><a href="GHC.Utils.Misc.html#notNull"><span class="hs-identifier hs-var">notNull</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPluginProgress -&gt; [Ct]
</span><a href="GHC.Tc.Solver.Interact.html#pluginNewCts"><span class="hs-identifier hs-var">pluginNewCts</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975600"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621681975594"><span class="hs-identifier hs-var">wc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#wc_simple"><span class="hs-identifier hs-var">wc_simple</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#listToBag"><span class="hs-identifier hs-type">listToBag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975605"><span class="hs-identifier hs-type">new_wanted</span></a></span><span>       </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#andCts"><span class="hs-operator hs-type">`andCts`</span></a></span><span>
</span><span id="line-230"></span><span>                                   </span><span class="annot"><a href="GHC.Data.Bag.html#listToBag"><span class="hs-identifier hs-type">listToBag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975603"><span class="hs-identifier hs-type">unsolved_wanted</span></a></span><span>  </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#andCts"><span class="hs-operator hs-type">`andCts`</span></a></span><span>
</span><span id="line-231"></span><span>                                   </span><span class="annot"><a href="GHC.Data.Bag.html#listToBag"><span class="hs-identifier hs-type">listToBag</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975606"><span class="hs-identifier hs-type">insols</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-233"></span><span>    </span><span class="annot"><a href="#local-6989586621681975608"><span class="hs-identifier hs-type">setEv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>    </span><span id="local-6989586621681975608"><span class="annot"><span class="annottext">setEv :: (EvTerm, Ct) -&gt; TcS ()
</span><a href="#local-6989586621681975608"><span class="hs-identifier hs-var hs-var">setEv</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681975610"><span class="annot"><span class="annottext">EvTerm
</span><a href="#local-6989586621681975610"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681975611"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975611"><span class="hs-identifier hs-var">ct</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975611"><span class="hs-identifier hs-var">ct</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-235"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_dest :: CtEvidence -&gt; TcEvDest
</span><a href="GHC.Tc.Types.Constraint.html#ctev_dest"><span class="hs-identifier hs-var">ctev_dest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975615"><span class="annot"><span class="annottext">TcEvDest
</span><a href="#local-6989586621681975615"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcEvDest -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setWantedEvTerm"><span class="hs-identifier hs-var">setWantedEvTerm</span></a></span><span> </span><span class="annot"><span class="annottext">TcEvDest
</span><a href="#local-6989586621681975615"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">EvTerm
</span><a href="#local-6989586621681975610"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-236"></span><span>      </span><span class="annot"><span class="annottext">CtEvidence
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TcS ()
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#panic"><span class="hs-identifier hs-var">panic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;runTcPluginsWanted.setEv: attempt to solve non-wanted!&quot;</span></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span class="annot"><span class="hs-comment">-- | A pair of (given, wanted) constraints to pass to plugins</span></span><span>
</span><span id="line-239"></span><span class="hs-keyword">type</span><span> </span><span id="SplitCts"><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SplitCts"><span class="hs-identifier hs-var">SplitCts</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="annot"><span class="hs-comment">-- | A solved pair of constraints, with evidence for wanteds</span></span><span>
</span><span id="line-242"></span><span class="hs-keyword">type</span><span> </span><span id="SolvedCts"><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SolvedCts"><span class="hs-identifier hs-var">SolvedCts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-comment">-- | Represents collections of constraints generated by typechecker</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- plugins</span><span>
</span><span id="line-246"></span><span class="hs-keyword">data</span><span> </span><span id="TcPluginProgress"><span class="annot"><a href="GHC.Tc.Solver.Interact.html#TcPluginProgress"><span class="hs-identifier hs-var">TcPluginProgress</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TcPluginProgress"><span class="annot"><a href="GHC.Tc.Solver.Interact.html#TcPluginProgress"><span class="hs-identifier hs-var">TcPluginProgress</span></a></span></span><span>
</span><span id="line-247"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="pluginInputCts"><span class="annot"><span class="annottext">TcPluginProgress -&gt; SplitCts
</span><a href="GHC.Tc.Solver.Interact.html#pluginInputCts"><span class="hs-identifier hs-var hs-var">pluginInputCts</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SplitCts"><span class="hs-identifier hs-type">SplitCts</span></a></span><span>
</span><span id="line-248"></span><span>      </span><span class="hs-comment">-- ^ Original inputs to the plugins with solved/bad constraints</span><span>
</span><span id="line-249"></span><span>      </span><span class="hs-comment">-- removed, but otherwise unmodified</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pluginSolvedCts"><span class="annot"><span class="annottext">TcPluginProgress -&gt; ([Ct], [(EvTerm, Ct)])
</span><a href="GHC.Tc.Solver.Interact.html#pluginSolvedCts"><span class="hs-identifier hs-var hs-var">pluginSolvedCts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SolvedCts"><span class="hs-identifier hs-type">SolvedCts</span></a></span><span>
</span><span id="line-251"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Constraints solved by plugins</span></span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pluginBadCts"><span class="annot"><span class="annottext">TcPluginProgress -&gt; [Ct]
</span><a href="GHC.Tc.Solver.Interact.html#pluginBadCts"><span class="hs-identifier hs-var hs-var">pluginBadCts</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-253"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Constraints reported as insoluble by plugins</span></span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pluginNewCts"><span class="annot"><span class="annottext">TcPluginProgress -&gt; [Ct]
</span><a href="GHC.Tc.Solver.Interact.html#pluginNewCts"><span class="hs-identifier hs-var hs-var">pluginNewCts</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-255"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ New constraints emitted by plugins</span></span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#getTcPluginSolvers"><span class="hs-identifier hs-type">getTcPluginSolvers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginSolver"><span class="hs-identifier hs-type">TcPluginSolver</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-259"></span><span id="getTcPluginSolvers"><span class="annot"><span class="annottext">getTcPluginSolvers :: TcS [TcPluginSolver]
</span><a href="GHC.Tc.Solver.Interact.html#getTcPluginSolvers"><span class="hs-identifier hs-var hs-var">getTcPluginSolvers</span></a></span></span><span>
</span><span id="line-260"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681975620"><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621681975620"><span class="hs-identifier hs-var">tcg_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS TcGblEnv
</span><a href="GHC.Tc.Solver.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[TcPluginSolver] -&gt; TcS [TcPluginSolver]
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcGblEnv -&gt; [TcPluginSolver]
</span><a href="GHC.Tc.Types.html#tcg_tc_plugin_solvers"><span class="hs-identifier hs-var">tcg_tc_plugin_solvers</span></a></span><span> </span><span class="annot"><span class="annottext">TcGblEnv
</span><a href="#local-6989586621681975620"><span class="hs-identifier hs-var">tcg_env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span class="hs-comment">-- | Starting from a pair of (given, wanted) constraints,</span><span>
</span><span id="line-263"></span><span class="hs-comment">-- invoke each of the typechecker constraint-solving plugins in turn and return</span><span>
</span><span id="line-264"></span><span class="hs-comment">--</span><span>
</span><span id="line-265"></span><span class="hs-comment">--  * the remaining unmodified constraints,</span><span>
</span><span id="line-266"></span><span class="hs-comment">--  * constraints that have been solved,</span><span>
</span><span id="line-267"></span><span class="hs-comment">--  * constraints that are insoluble, and</span><span>
</span><span id="line-268"></span><span class="hs-comment">--  * new work.</span><span>
</span><span id="line-269"></span><span class="hs-comment">--</span><span>
</span><span id="line-270"></span><span class="hs-comment">-- Note that new work generated by one plugin will not be seen by</span><span>
</span><span id="line-271"></span><span class="hs-comment">-- other plugins on this pass (but the main constraint solver will be</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- re-invoked and they will see it later).  There is no check that new</span><span>
</span><span id="line-273"></span><span class="hs-comment">-- work differs from the original constraints supplied to the plugin:</span><span>
</span><span id="line-274"></span><span class="hs-comment">-- the plugin itself should perform this check if necessary.</span><span>
</span><span id="line-275"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#runTcPluginSolvers"><span class="hs-identifier hs-type">runTcPluginSolvers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginSolver"><span class="hs-identifier hs-type">TcPluginSolver</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SplitCts"><span class="hs-identifier hs-type">SplitCts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#TcPluginProgress"><span class="hs-identifier hs-type">TcPluginProgress</span></a></span><span>
</span><span id="line-276"></span><span id="runTcPluginSolvers"><span class="annot"><span class="annottext">runTcPluginSolvers :: [TcPluginSolver] -&gt; SplitCts -&gt; TcS TcPluginProgress
</span><a href="GHC.Tc.Solver.Interact.html#runTcPluginSolvers"><span class="hs-identifier hs-var hs-var">runTcPluginSolvers</span></a></span></span><span> </span><span id="local-6989586621681975623"><span class="annot"><span class="annottext">[TcPluginSolver]
</span><a href="#local-6989586621681975623"><span class="hs-identifier hs-var">solvers</span></a></span></span><span> </span><span id="local-6989586621681975624"><span class="annot"><span class="annottext">SplitCts
</span><a href="#local-6989586621681975624"><span class="hs-identifier hs-var">all_cts</span></a></span></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681975625"><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621681975625"><span class="hs-identifier hs-var">ev_binds_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS EvBindsVar
</span><a href="GHC.Tc.Solver.Monad.html#getTcEvBindsVar"><span class="hs-identifier hs-var">getTcEvBindsVar</span></a></span><span>
</span><span id="line-278"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(TcPluginProgress -&gt; TcPluginSolver -&gt; TcS TcPluginProgress)
-&gt; TcPluginProgress -&gt; [TcPluginSolver] -&gt; TcS TcPluginProgress
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><a href="../../base-4.18.2.1/src/Control.Monad.html#foldM/Control.Monad.html#foldM"><span class="hs-identifier hs-var">foldM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EvBindsVar
-&gt; TcPluginProgress -&gt; TcPluginSolver -&gt; TcS TcPluginProgress
</span><a href="#local-6989586621681975628"><span class="hs-identifier hs-var">do_plugin</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621681975625"><span class="hs-identifier hs-var">ev_binds_var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975629"><span class="hs-identifier hs-var">initialProgress</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPluginSolver]
</span><a href="#local-6989586621681975623"><span class="hs-identifier hs-var">solvers</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><a href="#local-6989586621681975628"><span class="hs-identifier hs-type">do_plugin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvBindsVar"><span class="hs-identifier hs-type">EvBindsVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#TcPluginProgress"><span class="hs-identifier hs-type">TcPluginProgress</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginSolver"><span class="hs-identifier hs-type">TcPluginSolver</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#TcPluginProgress"><span class="hs-identifier hs-type">TcPluginProgress</span></a></span><span>
</span><span id="line-281"></span><span>    </span><span id="local-6989586621681975628"><span class="annot"><span class="annottext">do_plugin :: EvBindsVar
-&gt; TcPluginProgress -&gt; TcPluginSolver -&gt; TcS TcPluginProgress
</span><a href="#local-6989586621681975628"><span class="hs-identifier hs-var hs-var">do_plugin</span></a></span></span><span> </span><span id="local-6989586621681975630"><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621681975630"><span class="hs-identifier hs-var">ev_binds_var</span></a></span></span><span> </span><span id="local-6989586621681975631"><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975631"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621681975632"><span class="annot"><span class="annottext">TcPluginSolver
</span><a href="#local-6989586621681975632"><span class="hs-identifier hs-var">solver</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>        </span><span id="local-6989586621681975633"><span class="annot"><span class="annottext">TcPluginSolveResult
</span><a href="#local-6989586621681975633"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPluginM TcPluginSolveResult -&gt; TcS TcPluginSolveResult
forall a. TcPluginM a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#runTcPluginTcS"><span class="hs-identifier hs-var">runTcPluginTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([Ct] -&gt; [Ct] -&gt; TcPluginM TcPluginSolveResult)
-&gt; SplitCts -&gt; TcPluginM TcPluginSolveResult
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><a href="../../base-4.18.2.1/src/Data.Tuple.html#uncurry/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPluginSolver
</span><a href="#local-6989586621681975632"><span class="hs-identifier hs-var">solver</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621681975630"><span class="hs-identifier hs-var">ev_binds_var</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPluginProgress -&gt; SplitCts
</span><a href="GHC.Tc.Solver.Interact.html#pluginInputCts"><span class="hs-identifier hs-var">pluginInputCts</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975631"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>        </span><span class="annot"><span class="annottext">TcPluginProgress -&gt; TcS TcPluginProgress
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(TcPluginProgress -&gt; TcS TcPluginProgress)
-&gt; TcPluginProgress -&gt; TcS TcPluginProgress
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginProgress -&gt; TcPluginSolveResult -&gt; TcPluginProgress
</span><a href="#local-6989586621681975636"><span class="hs-identifier hs-var">progress</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975631"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginSolveResult
</span><a href="#local-6989586621681975633"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span>    </span><span class="annot"><a href="#local-6989586621681975636"><span class="hs-identifier hs-type">progress</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#TcPluginProgress"><span class="hs-identifier hs-type">TcPluginProgress</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginSolveResult"><span class="hs-identifier hs-type">TcPluginSolveResult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#TcPluginProgress"><span class="hs-identifier hs-type">TcPluginProgress</span></a></span><span>
</span><span id="line-286"></span><span>    </span><span id="local-6989586621681975636"><span class="annot"><span class="annottext">progress :: TcPluginProgress -&gt; TcPluginSolveResult -&gt; TcPluginProgress
</span><a href="#local-6989586621681975636"><span class="hs-identifier hs-var hs-var">progress</span></a></span></span><span> </span><span id="local-6989586621681975637"><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975637"><span class="hs-identifier hs-var">p</span></a></span></span><span>
</span><span id="line-287"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginSolveResult"><span class="hs-identifier hs-type">TcPluginSolveResult</span></a></span><span>
</span><span id="line-288"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tcPluginInsolubleCts :: TcPluginSolveResult -&gt; [Ct]
</span><a href="GHC.Tc.Types.html#tcPluginInsolubleCts"><span class="hs-identifier hs-var">tcPluginInsolubleCts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975640"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975640"><span class="hs-identifier hs-var">bad_cts</span></a></span></span><span>
</span><span id="line-289"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tcPluginSolvedCts :: TcPluginSolveResult -&gt; [(EvTerm, Ct)]
</span><a href="GHC.Tc.Types.html#tcPluginSolvedCts"><span class="hs-identifier hs-var">tcPluginSolvedCts</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975642"><span class="annot"><span class="annottext">[(EvTerm, Ct)]
</span><a href="#local-6989586621681975642"><span class="hs-identifier hs-var">solved_cts</span></a></span></span><span>
</span><span id="line-290"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tcPluginNewCts :: TcPluginSolveResult -&gt; [Ct]
</span><a href="GHC.Tc.Types.html#tcPluginNewCts"><span class="hs-identifier hs-var">tcPluginNewCts</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975644"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975644"><span class="hs-identifier hs-var">new_cts</span></a></span></span><span>
</span><span id="line-291"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-292"></span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-293"></span><span>        </span><span class="annot"><span class="annottext">TcPluginProgress
</span><a href="#local-6989586621681975637"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#pluginInputCts"><span class="hs-identifier hs-var">pluginInputCts</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681975645"><span class="hs-identifier hs-type">discard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681975640"><span class="hs-identifier hs-type">bad_cts</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-type">++</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-type">map</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Tuple.html#snd/Data.Tuple.html#snd"><span class="hs-identifier hs-type">snd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975642"><span class="hs-identifier hs-type">solved_cts</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#pluginInputCts"><span class="hs-identifier hs-var">pluginInputCts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975637"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#pluginSolvedCts"><span class="hs-identifier hs-var">pluginSolvedCts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681975647"><span class="hs-identifier hs-type">add</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975642"><span class="hs-identifier hs-type">solved_cts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#pluginSolvedCts"><span class="hs-identifier hs-var">pluginSolvedCts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975637"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#pluginNewCts"><span class="hs-identifier hs-var">pluginNewCts</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681975644"><span class="hs-identifier hs-type">new_cts</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-type">++</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#pluginNewCts"><span class="hs-identifier hs-var">pluginNewCts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975637"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-296"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#pluginBadCts"><span class="hs-identifier hs-var">pluginBadCts</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681975640"><span class="hs-identifier hs-type">bad_cts</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-type">++</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#pluginBadCts"><span class="hs-identifier hs-var">pluginBadCts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975637"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-297"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span>    </span><span id="local-6989586621681975629"><span class="annot"><span class="annottext">initialProgress :: TcPluginProgress
</span><a href="#local-6989586621681975629"><span class="hs-identifier hs-var hs-var">initialProgress</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SplitCts
-&gt; ([Ct], [(EvTerm, Ct)]) -&gt; [Ct] -&gt; [Ct] -&gt; TcPluginProgress
</span><a href="GHC.Tc.Solver.Interact.html#TcPluginProgress"><span class="hs-identifier hs-var">TcPluginProgress</span></a></span><span> </span><span class="annot"><span class="annottext">SplitCts
</span><a href="#local-6989586621681975624"><span class="hs-identifier hs-var">all_cts</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><a href="#local-6989586621681975645"><span class="hs-identifier hs-type">discard</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SplitCts"><span class="hs-identifier hs-type">SplitCts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SplitCts"><span class="hs-identifier hs-type">SplitCts</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span id="local-6989586621681975645"><span class="annot"><span class="annottext">discard :: [Ct] -&gt; SplitCts -&gt; SplitCts
</span><a href="#local-6989586621681975645"><span class="hs-identifier hs-var hs-var">discard</span></a></span></span><span> </span><span id="local-6989586621681975648"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975648"><span class="hs-identifier hs-var">cts</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681975649"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975649"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681975650"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975650"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975649"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; [Ct] -&gt; [Ct]
</span><a href="#local-6989586621681975651"><span class="hs-operator hs-var">`without`</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975648"><span class="hs-identifier hs-var">cts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975650"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; [Ct] -&gt; [Ct]
</span><a href="#local-6989586621681975651"><span class="hs-operator hs-var">`without`</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975648"><span class="hs-identifier hs-var">cts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span>    </span><span class="annot"><a href="#local-6989586621681975651"><span class="hs-identifier hs-type">without</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621681975651"><span class="annot"><span class="annottext">without :: [Ct] -&gt; [Ct] -&gt; [Ct]
</span><a href="#local-6989586621681975651"><span class="hs-identifier hs-var hs-var">without</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; Ct -&gt; Bool) -&gt; [Ct] -&gt; [Ct] -&gt; [Ct]
forall a. (a -&gt; a -&gt; Bool) -&gt; [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/Data.OldList.html#deleteFirstsBy/Data.OldList.html#deleteFirstsBy"><span class="hs-identifier hs-var">deleteFirstsBy</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Ct -&gt; Bool
</span><a href="#local-6989586621681975652"><span class="hs-identifier hs-var">eqCt</span></a></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span>    </span><span class="annot"><a href="#local-6989586621681975652"><span class="hs-identifier hs-type">eqCt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-309"></span><span>    </span><span id="local-6989586621681975652"><span class="annot"><span class="annottext">eqCt :: Ct -&gt; Ct -&gt; Bool
</span><a href="#local-6989586621681975652"><span class="hs-identifier hs-var hs-var">eqCt</span></a></span></span><span> </span><span id="local-6989586621681975653"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975653"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621681975654"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975654"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#ctFlavour"><span class="hs-identifier hs-var">ctFlavour</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975653"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">CtFlavour -&gt; CtFlavour -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#ctFlavour"><span class="hs-identifier hs-var">ctFlavour</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975654"><span class="hs-identifier hs-var">c'</span></a></span><span>
</span><span id="line-310"></span><span>             </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975653"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; TcPredType -&gt; TcPredType -&gt; Bool
TcPredType -&gt; TcPredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975654"><span class="hs-identifier hs-var">c'</span></a></span><span>
</span><span id="line-311"></span><span>
</span><span id="line-312"></span><span>    </span><span class="annot"><a href="#local-6989586621681975647"><span class="hs-identifier hs-type">add</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SolvedCts"><span class="hs-identifier hs-type">SolvedCts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SolvedCts"><span class="hs-identifier hs-type">SolvedCts</span></a></span><span>
</span><span id="line-313"></span><span>    </span><span id="local-6989586621681975647"><span class="annot"><span class="annottext">add :: [(EvTerm, Ct)] -&gt; ([Ct], [(EvTerm, Ct)]) -&gt; ([Ct], [(EvTerm, Ct)])
</span><a href="#local-6989586621681975647"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span id="local-6989586621681975659"><span class="annot"><span class="annottext">[(EvTerm, Ct)]
</span><a href="#local-6989586621681975659"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621681975660"><span class="annot"><span class="annottext">([Ct], [(EvTerm, Ct)])
</span><a href="#local-6989586621681975660"><span class="hs-identifier hs-var">scs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([Ct], [(EvTerm, Ct)]) -&gt; (EvTerm, Ct) -&gt; ([Ct], [(EvTerm, Ct)]))
-&gt; ([Ct], [(EvTerm, Ct)])
-&gt; [(EvTerm, Ct)]
-&gt; ([Ct], [(EvTerm, Ct)])
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldl%27/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">([Ct], [(EvTerm, Ct)]) -&gt; (EvTerm, Ct) -&gt; ([Ct], [(EvTerm, Ct)])
</span><a href="#local-6989586621681975662"><span class="hs-identifier hs-var">addOne</span></a></span><span> </span><span class="annot"><span class="annottext">([Ct], [(EvTerm, Ct)])
</span><a href="#local-6989586621681975660"><span class="hs-identifier hs-var">scs</span></a></span><span> </span><span class="annot"><span class="annottext">[(EvTerm, Ct)]
</span><a href="#local-6989586621681975659"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span>    </span><span class="annot"><a href="#local-6989586621681975662"><span class="hs-identifier hs-type">addOne</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SolvedCts"><span class="hs-identifier hs-type">SolvedCts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SolvedCts"><span class="hs-identifier hs-type">SolvedCts</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span id="local-6989586621681975662"><span class="annot"><span class="annottext">addOne :: ([Ct], [(EvTerm, Ct)]) -&gt; (EvTerm, Ct) -&gt; ([Ct], [(EvTerm, Ct)])
</span><a href="#local-6989586621681975662"><span class="hs-identifier hs-var hs-var">addOne</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681975663"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975663"><span class="hs-identifier hs-var">givens</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681975664"><span class="annot"><span class="annottext">[(EvTerm, Ct)]
</span><a href="#local-6989586621681975664"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681975665"><span class="annot"><span class="annottext">EvTerm
</span><a href="#local-6989586621681975665"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681975666"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975666"><span class="hs-identifier hs-var">ct</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975666"><span class="hs-identifier hs-var">ct</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-317"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtGiven"><span class="hs-identifier hs-type">CtGiven</span></a></span><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975666"><span class="hs-identifier hs-var">ct</span></a></span><span class="annot"><span class="annottext">Ct -&gt; [Ct] -&gt; [Ct]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975663"><span class="hs-identifier hs-var">givens</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(EvTerm, Ct)]
</span><a href="#local-6989586621681975664"><span class="hs-identifier hs-var">wanteds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975663"><span class="hs-identifier hs-var">givens</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EvTerm
</span><a href="#local-6989586621681975665"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975666"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span class="annot"><span class="annottext">(EvTerm, Ct) -&gt; [(EvTerm, Ct)] -&gt; [(EvTerm, Ct)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[(EvTerm, Ct)]
</span><a href="#local-6989586621681975664"><span class="hs-identifier hs-var">wanteds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span class="hs-keyword">type</span><span> </span><span id="WorkItem"><span class="annot"><a href="GHC.Tc.Solver.Interact.html#WorkItem"><span class="hs-identifier hs-var">WorkItem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span>
</span><span id="line-322"></span><span class="hs-keyword">type</span><span> </span><span id="SimplifierStage"><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SimplifierStage"><span class="hs-identifier hs-var">SimplifierStage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#WorkItem"><span class="hs-identifier hs-type">WorkItem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#runSolverPipeline"><span class="hs-identifier hs-type">runSolverPipeline</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Base.html#String/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SimplifierStage"><span class="hs-identifier hs-type">SimplifierStage</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The pipeline</span><span>
</span><span id="line-325"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#WorkItem"><span class="hs-identifier hs-type">WorkItem</span></a></span><span>                   </span><span class="hs-comment">-- The work item</span><span>
</span><span id="line-326"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span class="hs-comment">-- Run this item down the pipeline, leaving behind new work and inerts</span><span>
</span><span id="line-328"></span><span id="runSolverPipeline"><span class="annot"><span class="annottext">runSolverPipeline :: [(String, SimplifierStage)] -&gt; Ct -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#runSolverPipeline"><span class="hs-identifier hs-var hs-var">runSolverPipeline</span></a></span></span><span> </span><span id="local-6989586621681975669"><span class="annot"><span class="annottext">[(String, SimplifierStage)]
</span><a href="#local-6989586621681975669"><span class="hs-identifier hs-var">pipeline</span></a></span></span><span> </span><span id="local-6989586621681975670"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975670"><span class="hs-identifier hs-var">workItem</span></a></span></span><span>
</span><span id="line-329"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681975671"><span class="annot"><span class="annottext">WorkList
</span><a href="#local-6989586621681975671"><span class="hs-identifier hs-var">wl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS WorkList
</span><a href="GHC.Tc.Solver.Monad.html#getWorkList"><span class="hs-identifier hs-var">getWorkList</span></a></span><span>
</span><span id="line-330"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975673"><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681975673"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS InertSet
</span><a href="GHC.Tc.Solver.Monad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a></span><span>
</span><span id="line-331"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975675"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621681975675"><span class="hs-identifier hs-var">tclevel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS TcLevel
</span><a href="GHC.Tc.Solver.Monad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a></span><span>
</span><span id="line-332"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;----------------------------- &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-333"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Start solver pipeline {&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-334"></span><span>                  </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tclevel =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621681975675"><span class="hs-identifier hs-var">tclevel</span></a></span><span>
</span><span id="line-335"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;work item =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975670"><span class="hs-identifier hs-var">workItem</span></a></span><span>
</span><span id="line-336"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inerts =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681975673"><span class="hs-identifier hs-var">inerts</span></a></span><span>
</span><span id="line-337"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rest of worklist =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WorkList -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">WorkList
</span><a href="#local-6989586621681975671"><span class="hs-identifier hs-var">wl</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#bumpStepCountTcS"><span class="hs-identifier hs-var">bumpStepCountTcS</span></a></span><span>    </span><span class="hs-comment">-- One step for each constraint processed</span><span>
</span><span id="line-340"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975678"><span class="annot"><span class="annottext">StopOrContinue Ct
</span><a href="#local-6989586621681975678"><span class="hs-identifier hs-var">final_res</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(String, SimplifierStage)]
-&gt; StopOrContinue Ct -&gt; TcS (StopOrContinue Ct)
</span><a href="#local-6989586621681975679"><span class="hs-identifier hs-var">run_pipeline</span></a></span><span> </span><span class="annot"><span class="annottext">[(String, SimplifierStage)]
</span><a href="#local-6989586621681975669"><span class="hs-identifier hs-var">pipeline</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; StopOrContinue Ct
forall a. a -&gt; StopOrContinue a
</span><a href="GHC.Tc.Solver.Canonical.html#ContinueWith"><span class="hs-identifier hs-var">ContinueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975670"><span class="hs-identifier hs-var">workItem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>
</span><span id="line-342"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StopOrContinue Ct
</span><a href="#local-6989586621681975678"><span class="hs-identifier hs-var">final_res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-343"></span><span>           </span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span id="local-6989586621681975682"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975682"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621681975683"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621681975683"><span class="hs-identifier hs-var">s</span></a></span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceFireTcS"><span class="hs-identifier hs-var">traceFireTcS</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975682"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621681975683"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-344"></span><span>                                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;End solver pipeline (discharged) }&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-345"></span><span>                                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcS ()
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-346"></span><span>           </span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#ContinueWith"><span class="hs-identifier hs-type">ContinueWith</span></a></span><span> </span><span id="local-6989586621681975685"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975685"><span class="hs-identifier hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#addInertCan"><span class="hs-identifier hs-var">addInertCan</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975685"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-347"></span><span>                                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceFireTcS"><span class="hs-identifier hs-var">traceFireTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975685"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Kept as inert&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>                                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;End solver pipeline (kept as inert) }&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-349"></span><span>                                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;final_item =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975685"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-350"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span class="annot"><a href="#local-6989586621681975679"><span class="hs-identifier hs-type">run_pipeline</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Base.html#String/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SimplifierStage"><span class="hs-identifier hs-type">SimplifierStage</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span>
</span><span id="line-352"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>        </span><span id="local-6989586621681975679"><span class="annot"><span class="annottext">run_pipeline :: [(String, SimplifierStage)]
-&gt; StopOrContinue Ct -&gt; TcS (StopOrContinue Ct)
</span><a href="#local-6989586621681975679"><span class="hs-identifier hs-var hs-var">run_pipeline</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621681975687"><span class="annot"><span class="annottext">StopOrContinue Ct
</span><a href="#local-6989586621681975687"><span class="hs-identifier hs-var">res</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StopOrContinue Ct -&gt; TcS (StopOrContinue Ct)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">StopOrContinue Ct
</span><a href="#local-6989586621681975687"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-354"></span><span>        </span><span class="annot"><a href="#local-6989586621681975679"><span class="hs-identifier hs-var">run_pipeline</span></a></span><span> </span><span class="annot"><span class="annottext">[(String, SimplifierStage)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#Stop"><span class="hs-identifier hs-type">Stop</span></a></span><span> </span><span id="local-6989586621681975688"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975688"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621681975689"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621681975689"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StopOrContinue Ct -&gt; TcS (StopOrContinue Ct)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc -&gt; StopOrContinue Ct
forall a. CtEvidence -&gt; SDoc -&gt; StopOrContinue a
</span><a href="GHC.Tc.Solver.Canonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975688"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621681975689"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>        </span><span class="annot"><a href="#local-6989586621681975679"><span class="hs-identifier hs-var">run_pipeline</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621681975690"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681975690"><span class="hs-identifier hs-var">stg_name</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681975691"><span class="annot"><span class="annottext">SimplifierStage
</span><a href="#local-6989586621681975691"><span class="hs-identifier hs-var">stg</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681975692"><span class="annot"><span class="annottext">[(String, SimplifierStage)]
</span><a href="#local-6989586621681975692"><span class="hs-identifier hs-var">stgs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#ContinueWith"><span class="hs-identifier hs-type">ContinueWith</span></a></span><span> </span><span id="local-6989586621681975693"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975693"><span class="hs-identifier hs-var">ct</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;runStage &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681975690"><span class="hs-identifier hs-var">stg_name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; {&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;workitem   = &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975693"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>               </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975694"><span class="annot"><span class="annottext">StopOrContinue Ct
</span><a href="#local-6989586621681975694"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
</span><a href="#local-6989586621681975691"><span class="hs-identifier hs-var">stg</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975693"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-359"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;end stage &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681975690"><span class="hs-identifier hs-var">stg_name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; }&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-360"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[(String, SimplifierStage)]
-&gt; StopOrContinue Ct -&gt; TcS (StopOrContinue Ct)
</span><a href="#local-6989586621681975679"><span class="hs-identifier hs-var">run_pipeline</span></a></span><span> </span><span class="annot"><span class="annottext">[(String, SimplifierStage)]
</span><a href="#local-6989586621681975692"><span class="hs-identifier hs-var">stgs</span></a></span><span> </span><span class="annot"><span class="annottext">StopOrContinue Ct
</span><a href="#local-6989586621681975694"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span class="hs-comment">{-
Example 1:
  Inert:   {c ~ d, F a ~ t, b ~ Int, a ~ ty} (all given)
  Reagent: a ~ [b] (given)

React with (c~d)     ==&gt; IR (ContinueWith (a~[b]))  True    []
React with (F a ~ t) ==&gt; IR (ContinueWith (a~[b]))  False   [F [b] ~ t]
React with (b ~ Int) ==&gt; IR (ContinueWith (a~[Int]) True    []

Example 2:
  Inert:  {c ~w d, F a ~g t, b ~w Int, a ~w ty}
  Reagent: a ~w [b]

React with (c ~w d)   ==&gt; IR (ContinueWith (a~[b]))  True    []
React with (F a ~g t) ==&gt; IR (ContinueWith (a~[b]))  True    []    (can't rewrite given with wanted!)
etc.

Example 3:
  Inert:  {a ~ Int, F Int ~ b} (given)
  Reagent: F a ~ b (wanted)

React with (a ~ Int)   ==&gt; IR (ContinueWith (F Int ~ b)) True []
React with (F Int ~ b) ==&gt; IR Stop True []    -- after substituting we re-canonicalize and get nothing
-}</span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#thePipeline"><span class="hs-identifier hs-type">thePipeline</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Base.html#String/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#SimplifierStage"><span class="hs-identifier hs-type">SimplifierStage</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-388"></span><span id="thePipeline"><span class="annot"><span class="annottext">thePipeline :: [(String, SimplifierStage)]
</span><a href="GHC.Tc.Solver.Interact.html#thePipeline"><span class="hs-identifier hs-var hs-var">thePipeline</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canonicalization&quot;</span></span><span class="hs-special">,</span><span>        </span><span class="annot"><span class="annottext">SimplifierStage
</span><a href="GHC.Tc.Solver.Canonical.html#canonicalize"><span class="hs-identifier hs-var">GHC.Tc.Solver.Canonical.canonicalize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interact with inerts&quot;</span></span><span class="hs-special">,</span><span>    </span><span class="annot"><span class="annottext">SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#interactWithInertsStage"><span class="hs-identifier hs-var">interactWithInertsStage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-390"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;top-level reactions&quot;</span></span><span class="hs-special">,</span><span>     </span><span class="annot"><span class="annottext">SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#topReactionsStage"><span class="hs-identifier hs-var">topReactionsStage</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span class="hs-comment">{-
*********************************************************************************
*                                                                               *
                       The interact-with-inert Stage
*                                                                               *
*********************************************************************************

Note [The Solver Invariant]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
We always add Givens first.  So you might think that the solver has
the invariant

   If the work-item is Given,
   then the inert item must Given

But this isn't quite true.  Suppose we have,
    c1: [W] beta ~ [alpha], c2 : [W] blah, c3 :[W] alpha ~ Int
After processing the first two, we get
     c1: [G] beta ~ [alpha], c2 : [W] blah
Now, c3 does not interact with the given c1, so when we spontaneously
solve c3, we must re-react it with the inert set.  So we can attempt a
reaction between inert c2 [W] and work-item c3 [G].

It *is* true that [Solver Invariant]
   If the work-item is Given,
   AND there is a reaction
   then the inert item must Given
or, equivalently,
   If the work-item is Given,
   and the inert item is Wanted
   then there is no reaction
-}</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span class="hs-comment">-- Interaction result of  WorkItem &lt;~&gt; Ct</span><span>
</span><span id="line-426"></span><span>
</span><span id="line-427"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#interactWithInertsStage"><span class="hs-identifier hs-type">interactWithInertsStage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#WorkItem"><span class="hs-identifier hs-type">WorkItem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span class="hs-comment">-- Precondition: if the workitem is a CEqCan then it will not be able to</span><span>
</span><span id="line-429"></span><span class="hs-comment">-- react with anything at this stage (except, maybe, via a type family</span><span>
</span><span id="line-430"></span><span class="hs-comment">-- dependency)</span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span id="interactWithInertsStage"><span class="annot"><span class="annottext">interactWithInertsStage :: SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#interactWithInertsStage"><span class="hs-identifier hs-var hs-var">interactWithInertsStage</span></a></span></span><span> </span><span id="local-6989586621681975698"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975698"><span class="hs-identifier hs-var">wi</span></a></span></span><span>
</span><span id="line-433"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681975699"><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681975699"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS InertSet
</span><a href="GHC.Tc.Solver.Monad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a></span><span>
</span><span id="line-434"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681975700"><span class="annot"><span class="annottext">ics :: InertCans
</span><a href="#local-6989586621681975700"><span class="hs-identifier hs-var hs-var">ics</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InertSet -&gt; InertCans
</span><a href="GHC.Tc.Solver.InertSet.html#inert_cans"><span class="hs-identifier hs-var">inert_cans</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681975699"><span class="hs-identifier hs-var">inerts</span></a></span><span>
</span><span id="line-435"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975698"><span class="hs-identifier hs-var">wi</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-436"></span><span>             </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CEqCan"><span class="hs-identifier hs-type">CEqCan</span></a></span><span>       </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#interactEq"><span class="hs-identifier hs-var">interactEq</span></a></span><span>      </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975700"><span class="hs-identifier hs-var">ics</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975698"><span class="hs-identifier hs-var">wi</span></a></span><span>
</span><span id="line-437"></span><span>             </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CIrredCan"><span class="hs-identifier hs-type">CIrredCan</span></a></span><span>    </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#interactIrred"><span class="hs-identifier hs-var">interactIrred</span></a></span><span>   </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975700"><span class="hs-identifier hs-var">ics</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975698"><span class="hs-identifier hs-var">wi</span></a></span><span>
</span><span id="line-438"></span><span>             </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CDictCan"><span class="hs-identifier hs-type">CDictCan</span></a></span><span>     </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#interactDict"><span class="hs-identifier hs-var">interactDict</span></a></span><span>    </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975700"><span class="hs-identifier hs-var">ics</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975698"><span class="hs-identifier hs-var">wi</span></a></span><span>
</span><span id="line-439"></span><span>             </span><span class="annot"><span class="annottext">Ct
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS (StopOrContinue Ct)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interactWithInerts&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975698"><span class="hs-identifier hs-var">wi</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-440"></span><span>                </span><span class="hs-comment">-- CNonCanonical have been canonicalised</span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span class="hs-keyword">data</span><span> </span><span id="InteractResult"><span class="annot"><a href="GHC.Tc.Solver.Interact.html#InteractResult"><span class="hs-identifier hs-var">InteractResult</span></a></span></span><span>
</span><span id="line-443"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="KeepInert"><span class="annot"><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span></span><span>   </span><span class="hs-comment">-- Keep the inert item, and solve the work item from it</span><span>
</span><span id="line-444"></span><span>                 </span><span class="hs-comment">-- (if the latter is Wanted; just discard it if not)</span><span>
</span><span id="line-445"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="KeepWork"><span class="annot"><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span></span><span>    </span><span class="hs-comment">-- Keep the work item, and solve the inert item from it</span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#InteractResult"><span class="hs-identifier hs-type">InteractResult</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-448"></span><span>  </span><span id="local-6989586621681975716"><span class="annot"><span class="annottext">ppr :: InteractResult -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;keep inert&quot;</span></span><span>
</span><span id="line-449"></span><span>  </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;keep work-item&quot;</span></span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#solveOneFromTheOther"><span class="hs-identifier hs-type">solveOneFromTheOther</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span>  </span><span class="hs-comment">-- Inert    (Dict or Irred)</span><span>
</span><span id="line-452"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span>  </span><span class="hs-comment">-- WorkItem (same predicate as inert)</span><span>
</span><span id="line-453"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#InteractResult"><span class="hs-identifier hs-type">InteractResult</span></a></span><span>
</span><span id="line-454"></span><span class="hs-comment">-- Precondition:</span><span>
</span><span id="line-455"></span><span class="annot"><span class="hs-comment">-- * inert and work item represent evidence for the /same/ predicate</span></span><span>
</span><span id="line-456"></span><span class="annot"><span class="hs-comment">-- * Both are CDictCan or CIrredCan</span></span><span>
</span><span id="line-457"></span><span class="hs-comment">--</span><span>
</span><span id="line-458"></span><span class="hs-comment">-- We can always solve one from the other: even if both are wanted,</span><span>
</span><span id="line-459"></span><span class="hs-comment">-- although we don't rewrite wanteds with wanteds, we can combine</span><span>
</span><span id="line-460"></span><span class="hs-comment">-- two wanteds into one by solving one from the other</span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span id="solveOneFromTheOther"><span class="annot"><span class="annottext">solveOneFromTheOther :: Ct -&gt; Ct -&gt; InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#solveOneFromTheOther"><span class="hs-identifier hs-var hs-var">solveOneFromTheOther</span></a></span></span><span> </span><span id="local-6989586621681975718"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975718"><span class="hs-identifier hs-var">ct_i</span></a></span></span><span> </span><span id="local-6989586621681975719"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975719"><span class="hs-identifier hs-var">ct_w</span></a></span></span><span>
</span><span id="line-463"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_loc :: CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctev_loc"><span class="hs-identifier hs-var">ctev_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975721"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975721"><span class="hs-identifier hs-var">loc_w</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975722"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-464"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtLoc -&gt; Bool
</span><a href="GHC.Tc.Solver.InertSet.html#prohibitedSuperClassSolve"><span class="hs-identifier hs-var">prohibitedSuperClassSolve</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975724"><span class="hs-identifier hs-var">loc_i</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975721"><span class="hs-identifier hs-var">loc_w</span></a></span><span>
</span><span id="line-465"></span><span>  </span><span class="hs-comment">-- See Note [Solving superclass constraints] in GHC.Tc.TyCl.Instance</span><span>
</span><span id="line-466"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Inert must be Given</span><span>
</span><span id="line-467"></span><span>    </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975722"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-470"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Inert is Given or Wanted</span><span>
</span><span id="line-471"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975725"><span class="hs-identifier hs-var">ev_i</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-472"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtGiven"><span class="hs-identifier hs-type">CtGiven</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span>
</span><span id="line-473"></span><span>        </span><span class="hs-comment">-- work is Wanted; inert is Given: easy choice.</span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span>      </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-comment">-- Both are Wanted</span><span>
</span><span id="line-476"></span><span>        </span><span class="hs-comment">-- If only one has no pending superclasses, use it</span><span>
</span><span id="line-477"></span><span>        </span><span class="hs-comment">-- Otherwise we can get infinite superclass expansion (#22516)</span><span>
</span><span id="line-478"></span><span>        </span><span class="hs-comment">-- in silly cases like   class C T b =&gt; C a b where ...</span><span>
</span><span id="line-479"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975727"><span class="hs-identifier hs-var">is_psc_i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975728"><span class="hs-identifier hs-var">is_psc_w</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span>
</span><span id="line-480"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975727"><span class="hs-identifier hs-var">is_psc_i</span></a></span><span class="hs-special">,</span><span>     </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975728"><span class="hs-identifier hs-var">is_psc_w</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span>
</span><span id="line-481"></span><span>
</span><span id="line-482"></span><span>        </span><span class="hs-comment">-- If only one is a WantedSuperclassOrigin (arising from expanding</span><span>
</span><span id="line-483"></span><span>        </span><span class="hs-comment">-- a Wanted class constraint), keep the other: wanted superclasses</span><span>
</span><span id="line-484"></span><span>        </span><span class="hs-comment">-- may be unexpected by users</span><span>
</span><span id="line-485"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975729"><span class="hs-identifier hs-var">is_wsc_orig_i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975730"><span class="hs-identifier hs-var">is_wsc_orig_w</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span>
</span><span id="line-486"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975729"><span class="hs-identifier hs-var">is_wsc_orig_i</span></a></span><span class="hs-special">,</span><span>     </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975730"><span class="hs-identifier hs-var">is_wsc_orig_w</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span>        </span><span class="hs-comment">-- otherwise, just choose the lower span</span><span>
</span><span id="line-489"></span><span>        </span><span class="hs-comment">-- reason: if we have something like (abs 1) (where the</span><span>
</span><span id="line-490"></span><span>        </span><span class="hs-comment">-- Num constraint cannot be satisfied), it's better to</span><span>
</span><span id="line-491"></span><span>        </span><span class="hs-comment">-- get an error about abs than about 1.</span><span>
</span><span id="line-492"></span><span>        </span><span class="hs-comment">-- This test might become more elaborate if we see an</span><span>
</span><span id="line-493"></span><span>        </span><span class="hs-comment">-- opportunity to improve the error messages</span><span>
</span><span id="line-494"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealSrcSpan -&gt; RealSrcSpan -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">(&lt;)</span></span><span> </span><span class="annot"><span class="annottext">(RealSrcSpan -&gt; RealSrcSpan -&gt; Bool)
-&gt; (CtLoc -&gt; RealSrcSpan) -&gt; CtLoc -&gt; CtLoc -&gt; Bool
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/Data.Function.html#on/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; RealSrcSpan
</span><a href="GHC.Tc.Types.Constraint.html#ctLocSpan"><span class="hs-identifier hs-var">ctLocSpan</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975724"><span class="hs-identifier hs-var">loc_i</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975733"><span class="hs-identifier hs-var">loc_w</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span>
</span><span id="line-495"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span>
</span><span id="line-496"></span><span>
</span><span id="line-497"></span><span>  </span><span class="hs-comment">-- From here on the work-item is Given</span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_loc :: CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctev_loc"><span class="hs-identifier hs-var">ctev_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975734"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975734"><span class="hs-identifier hs-var">loc_i</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975725"><span class="hs-identifier hs-var">ev_i</span></a></span><span>
</span><span id="line-500"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtLoc -&gt; Bool
</span><a href="GHC.Tc.Solver.InertSet.html#prohibitedSuperClassSolve"><span class="hs-identifier hs-var">prohibitedSuperClassSolve</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975733"><span class="hs-identifier hs-var">loc_w</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975734"><span class="hs-identifier hs-var">loc_i</span></a></span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span>   </span><span class="hs-comment">-- Just discard the un-usable Given</span><span>
</span><span id="line-502"></span><span>                </span><span class="hs-comment">-- This never actually happens because</span><span>
</span><span id="line-503"></span><span>                </span><span class="hs-comment">-- Givens get processed first</span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975725"><span class="hs-identifier hs-var">ev_i</span></a></span><span>
</span><span id="line-506"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-comment">-- From here on both are Given</span><span>
</span><span id="line-509"></span><span>  </span><span class="hs-comment">-- See Note [Replacement vs keeping]</span><span>
</span><span id="line-510"></span><span>
</span><span id="line-511"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621681975735"><span class="hs-identifier hs-var">lvl_i</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcLevel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621681975736"><span class="hs-identifier hs-var">lvl_w</span></a></span><span>
</span><span id="line-512"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="#local-6989586621681975737"><span class="hs-identifier hs-var">same_level_strategy</span></a></span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-comment">-- Both are Given, levels differ</span><span>
</span><span id="line-515"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="#local-6989586621681975738"><span class="hs-identifier hs-var">different_level_strategy</span></a></span><span>
</span><span id="line-516"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-517"></span><span>     </span><span id="local-6989586621681975725"><span class="annot"><span class="annottext">ev_i :: CtEvidence
</span><a href="#local-6989586621681975725"><span class="hs-identifier hs-var hs-var">ev_i</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975718"><span class="hs-identifier hs-var">ct_i</span></a></span><span>
</span><span id="line-518"></span><span>     </span><span id="local-6989586621681975722"><span class="annot"><span class="annottext">ev_w :: CtEvidence
</span><a href="#local-6989586621681975722"><span class="hs-identifier hs-var hs-var">ev_w</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975719"><span class="hs-identifier hs-var">ct_w</span></a></span><span>
</span><span id="line-519"></span><span>
</span><span id="line-520"></span><span>     </span><span id="local-6989586621681975739"><span class="annot"><span class="annottext">pred :: TcPredType
</span><a href="#local-6989586621681975739"><span class="hs-identifier hs-var hs-var">pred</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975725"><span class="hs-identifier hs-var">ev_i</span></a></span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span>     </span><span id="local-6989586621681975724"><span class="annot"><span class="annottext">loc_i :: CtLoc
</span><a href="#local-6989586621681975724"><span class="hs-identifier hs-var hs-var">loc_i</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975725"><span class="hs-identifier hs-var">ev_i</span></a></span><span>
</span><span id="line-523"></span><span>     </span><span id="local-6989586621681975733"><span class="annot"><span class="annottext">loc_w :: CtLoc
</span><a href="#local-6989586621681975733"><span class="hs-identifier hs-var hs-var">loc_w</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975722"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-524"></span><span>     </span><span id="local-6989586621681975742"><span class="annot"><span class="annottext">orig_i :: CtOrigin
</span><a href="#local-6989586621681975742"><span class="hs-identifier hs-var hs-var">orig_i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Constraint.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975724"><span class="hs-identifier hs-var">loc_i</span></a></span><span>
</span><span id="line-525"></span><span>     </span><span id="local-6989586621681975744"><span class="annot"><span class="annottext">orig_w :: CtOrigin
</span><a href="#local-6989586621681975744"><span class="hs-identifier hs-var hs-var">orig_w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Constraint.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975733"><span class="hs-identifier hs-var">loc_w</span></a></span><span>
</span><span id="line-526"></span><span>     </span><span id="local-6989586621681975735"><span class="annot"><span class="annottext">lvl_i :: TcLevel
</span><a href="#local-6989586621681975735"><span class="hs-identifier hs-var hs-var">lvl_i</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; TcLevel
</span><a href="GHC.Tc.Types.Constraint.html#ctLocLevel"><span class="hs-identifier hs-var">ctLocLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975724"><span class="hs-identifier hs-var">loc_i</span></a></span><span>
</span><span id="line-527"></span><span>     </span><span id="local-6989586621681975736"><span class="annot"><span class="annottext">lvl_w :: TcLevel
</span><a href="#local-6989586621681975736"><span class="hs-identifier hs-var hs-var">lvl_w</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; TcLevel
</span><a href="GHC.Tc.Types.Constraint.html#ctLocLevel"><span class="hs-identifier hs-var">ctLocLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975733"><span class="hs-identifier hs-var">loc_w</span></a></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span>     </span><span id="local-6989586621681975728"><span class="annot"><span class="annottext">is_psc_w :: Bool
</span><a href="#local-6989586621681975728"><span class="hs-identifier hs-var hs-var">is_psc_w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isPendingScDict"><span class="hs-identifier hs-var">isPendingScDict</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975719"><span class="hs-identifier hs-var">ct_w</span></a></span><span>
</span><span id="line-530"></span><span>     </span><span id="local-6989586621681975727"><span class="annot"><span class="annottext">is_psc_i :: Bool
</span><a href="#local-6989586621681975727"><span class="hs-identifier hs-var hs-var">is_psc_i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isPendingScDict"><span class="hs-identifier hs-var">isPendingScDict</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975718"><span class="hs-identifier hs-var">ct_i</span></a></span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span>     </span><span id="local-6989586621681975729"><span class="annot"><span class="annottext">is_wsc_orig_i :: Bool
</span><a href="#local-6989586621681975729"><span class="hs-identifier hs-var hs-var">is_wsc_orig_i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; Bool
</span><a href="GHC.Tc.Types.Origin.html#isWantedSuperclassOrigin"><span class="hs-identifier hs-var">isWantedSuperclassOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621681975742"><span class="hs-identifier hs-var">orig_i</span></a></span><span>
</span><span id="line-533"></span><span>     </span><span id="local-6989586621681975730"><span class="annot"><span class="annottext">is_wsc_orig_w :: Bool
</span><a href="#local-6989586621681975730"><span class="hs-identifier hs-var hs-var">is_wsc_orig_w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; Bool
</span><a href="GHC.Tc.Types.Origin.html#isWantedSuperclassOrigin"><span class="hs-identifier hs-var">isWantedSuperclassOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621681975744"><span class="hs-identifier hs-var">orig_w</span></a></span><span>
</span><span id="line-534"></span><span>
</span><span id="line-535"></span><span>     </span><span id="local-6989586621681975738"><span class="annot"><span class="annottext">different_level_strategy :: InteractResult
</span><a href="#local-6989586621681975738"><span class="hs-identifier hs-var hs-var">different_level_strategy</span></a></span></span><span>  </span><span class="hs-comment">-- Both Given</span><span>
</span><span id="line-536"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isIPLikePred"><span class="hs-identifier hs-var">isIPLikePred</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975739"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621681975736"><span class="hs-identifier hs-var">lvl_w</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcLevel -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621681975735"><span class="hs-identifier hs-var">lvl_i</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span>
</span><span id="line-537"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621681975736"><span class="hs-identifier hs-var">lvl_w</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcLevel -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621681975735"><span class="hs-identifier hs-var">lvl_i</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span>
</span><span id="line-538"></span><span>       </span><span class="hs-comment">-- See Note [Replacement vs keeping] part (1)</span><span>
</span><span id="line-539"></span><span>       </span><span class="hs-comment">-- For the isIPLikePred case see Note [Shadowing of Implicit Parameters]</span><span>
</span><span id="line-540"></span><span>
</span><span id="line-541"></span><span>     </span><span id="local-6989586621681975737"><span class="annot"><span class="annottext">same_level_strategy :: InteractResult
</span><a href="#local-6989586621681975737"><span class="hs-identifier hs-var hs-var">same_level_strategy</span></a></span></span><span> </span><span class="hs-comment">-- Both Given</span><span>
</span><span id="line-542"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621681975742"><span class="hs-identifier hs-var">orig_i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621681975744"><span class="hs-identifier hs-var">orig_w</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-543"></span><span>
</span><span id="line-544"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#GivenSCOrigin"><span class="hs-identifier hs-type">GivenSCOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681975751"><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681975751"><span class="hs-identifier hs-var">depth_i</span></a></span></span><span> </span><span id="local-6989586621681975752"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975752"><span class="hs-identifier hs-var">blocked_i</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#GivenSCOrigin"><span class="hs-identifier hs-type">GivenSCOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfoAnon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681975753"><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681975753"><span class="hs-identifier hs-var">depth_w</span></a></span></span><span> </span><span id="local-6989586621681975754"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975754"><span class="hs-identifier hs-var">blocked_w</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975752"><span class="hs-identifier hs-var">blocked_i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975754"><span class="hs-identifier hs-var">blocked_w</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span>  </span><span class="hs-comment">-- Case 2(a) from</span><span>
</span><span id="line-546"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975752"><span class="hs-identifier hs-var">blocked_i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975754"><span class="hs-identifier hs-var">blocked_w</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span> </span><span class="hs-comment">-- Note [Replacement vs keeping]</span><span>
</span><span id="line-547"></span><span>
</span><span id="line-548"></span><span>             </span><span class="hs-comment">-- Both blocked or both not blocked</span><span>
</span><span id="line-549"></span><span>
</span><span id="line-550"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681975753"><span class="hs-identifier hs-var">depth_w</span></a></span><span> </span><span class="annot"><span class="annottext">ScDepth -&gt; ScDepth -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681975751"><span class="hs-identifier hs-var">depth_i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span>   </span><span class="hs-comment">-- Case 2(c) from</span><span>
</span><span id="line-551"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span>  </span><span class="hs-comment">-- Note [Replacement vs keeping]</span><span>
</span><span id="line-552"></span><span>
</span><span id="line-553"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Origin.html#GivenSCOrigin"><span class="hs-identifier hs-type">GivenSCOrigin</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span>  </span><span class="hs-comment">-- Case 2(b) from Note [Replacement vs keeping]</span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span>           </span><span class="annot"><span class="annottext">(CtOrigin, CtOrigin)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span>  </span><span class="hs-comment">-- Case 2(d) from Note [Replacement vs keeping]</span><span>
</span><span id="line-556"></span><span>
</span><span id="line-557"></span><span class="hs-comment">{-
Note [Replacement vs keeping]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we have two Given constraints both of type (C tys), say, which should
we keep?  More subtle than you might think! This is all implemented in
solveOneFromTheOther.

  1) Constraints come from different levels (different_level_strategy)

      - For implicit parameters we want to keep the innermost (deepest)
        one, so that it overrides the outer one.
        See Note [Shadowing of Implicit Parameters]

      - For everything else, we want to keep the outermost one.  Reason: that
        makes it more likely that the inner one will turn out to be unused,
        and can be reported as redundant.  See Note [Tracking redundant constraints]
        in GHC.Tc.Solver.

        It transpires that using the outermost one is responsible for an
        8% performance improvement in nofib cryptarithm2, compared to
        just rolling the dice.  I didn't investigate why.

  2) Constraints coming from the same level (i.e. same implication)

       (a) If both are GivenSCOrigin, choose the one that is unblocked if possible
           according to Note [Solving superclass constraints] in GHC.Tc.TyCl.Instance.

       (b) Prefer constraints that are not superclass selections. Example:

             f :: (Eq a, Ord a) =&gt; a -&gt; Bool
             f x = x == x

           Eager superclass expansion gives us two [G] Eq a constraints. We
           want to keep the one from the user-written Eq a, not the superclass
           selection. This means we report the Ord a as redundant with
           -Wredundant-constraints, not the Eq a.

           Getting this wrong was #20602. See also
           Note [Tracking redundant constraints] in GHC.Tc.Solver.

       (c) If both are GivenSCOrigin, chooose the one with the shallower
           superclass-selection depth, in the hope of identifying more correct
           redundant constraints. This is really a generalization of point (b),
           because the superclass depth of a non-superclass constraint is 0.

           (If the levels differ, we definitely won't have both with GivenSCOrigin.)

       (d) Finally, when there is still a choice, use KeepInert rather than
           KeepWork, for two reasons:
             - to avoid unnecessary munging of the inert set.
             - to cut off superclass loops; see Note [Superclass loops] in GHC.Tc.Solver.Canonical

Doing the level-check for implicit parameters, rather than making the work item
always override, is important.  Consider

    data T a where { T1 :: (?x::Int) =&gt; T Int; T2 :: T a }

    f :: (?x::a) =&gt; T a -&gt; Int
    f T1 = ?x
    f T2 = 3

We have a [G] (?x::a) in the inert set, and at the pattern match on T1 we add
two new givens in the work-list:  [G] (?x::Int)
                                  [G] (a ~ Int)
Now consider these steps
  - process a~Int, kicking out (?x::a)
  - process (?x::Int), the inner given, adding to inert set
  - process (?x::a), the outer given, overriding the inner given
Wrong!  The level-check ensures that the inner implicit parameter wins.
(Actually I think that the order in which the work-list is processed means
that this chain of events won't happen, but that's very fragile.)

*********************************************************************************
*                                                                               *
                   interactIrred
*                                                                               *
*********************************************************************************

Note [Multiple matching irreds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
You might think that it's impossible to have multiple irreds all match the
work item; after all, interactIrred looks for matches and solves one from the
other. However, note that interacting insoluble, non-droppable irreds does not
do this matching. We thus might end up with several insoluble, non-droppable,
matching irreds in the inert set. When another irred comes along that we have
not yet labeled insoluble, we can find multiple matches. These multiple matches
cause no harm, but it would be wrong to ASSERT that they aren't there (as we
once had done). This problem can be tickled by typecheck/should_compile/holes.

-}</span><span>
</span><span id="line-647"></span><span>
</span><span id="line-648"></span><span class="hs-comment">-- Two pieces of irreducible evidence: if their types are *exactly identical*</span><span>
</span><span id="line-649"></span><span class="hs-comment">-- we can rewrite them. We can never improve using this:</span><span>
</span><span id="line-650"></span><span class="hs-comment">-- if we want ty1 :: Constraint and have ty2 :: Constraint it clearly does not</span><span>
</span><span id="line-651"></span><span class="hs-comment">-- mean that (ty1 ~ ty2)</span><span>
</span><span id="line-652"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#interactIrred"><span class="hs-identifier hs-type">interactIrred</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-653"></span><span>
</span><span id="line-654"></span><span id="interactIrred"><span class="annot"><span class="annottext">interactIrred :: InertCans -&gt; SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#interactIrred"><span class="hs-identifier hs-var hs-var">interactIrred</span></a></span></span><span> </span><span id="local-6989586621681975755"><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975755"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span id="local-6989586621681975756"><span class="annot"><span class="annottext">ct_w :: Ct
</span><a href="#local-6989586621681975756"><span class="hs-identifier hs-var">ct_w</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CIrredCan"><span class="hs-identifier hs-type">CIrredCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975758"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975758"><span class="hs-identifier hs-var">ev_w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_reason :: Ct -&gt; CtIrredReason
</span><a href="GHC.Tc.Types.Constraint.html#cc_reason"><span class="hs-identifier hs-var">cc_reason</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975760"><span class="annot"><span class="annottext">CtIrredReason
</span><a href="#local-6989586621681975760"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-655"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CtIrredReason -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isInsolubleReason"><span class="hs-identifier hs-var">isInsolubleReason</span></a></span><span> </span><span class="annot"><span class="annottext">CtIrredReason
</span><a href="#local-6989586621681975760"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-656"></span><span>               </span><span class="hs-comment">-- For insolubles, don't allow the constraint to be dropped</span><span>
</span><span id="line-657"></span><span>               </span><span class="hs-comment">-- which can happen with solveOneFromTheOther, so that</span><span>
</span><span id="line-658"></span><span>               </span><span class="hs-comment">-- we get distinct error messages with -fdefer-type-errors</span><span>
</span><span id="line-659"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975756"><span class="hs-identifier hs-var">ct_w</span></a></span><span>
</span><span id="line-660"></span><span>
</span><span id="line-661"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681975763"><span class="annot"><span class="annottext">Bag (Ct, SwapFlag)
</span><a href="#local-6989586621681975763"><span class="hs-identifier hs-var">matching_irreds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681975764"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975764"><span class="hs-identifier hs-var">others</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; CtEvidence -&gt; (Bag (Ct, SwapFlag), Cts)
</span><a href="GHC.Tc.Solver.Interact.html#findMatchingIrreds"><span class="hs-identifier hs-var">findMatchingIrreds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InertCans -&gt; Cts
</span><a href="GHC.Tc.Solver.InertSet.html#inert_irreds"><span class="hs-identifier hs-var">inert_irreds</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975755"><span class="hs-identifier hs-var">inerts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975758"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621681975767"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975767"><span class="hs-identifier hs-var">ct_i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681975768"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621681975768"><span class="hs-identifier hs-var">swap</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681975769"><span class="annot"><span class="annottext">[(Ct, SwapFlag)]
</span><a href="#local-6989586621681975769"><span class="hs-identifier hs-var">_rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bag (Ct, SwapFlag) -&gt; [(Ct, SwapFlag)]
forall a. Bag a -&gt; [a]
</span><a href="GHC.Data.Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a></span><span> </span><span class="annot"><span class="annottext">Bag (Ct, SwapFlag)
</span><a href="#local-6989586621681975763"><span class="hs-identifier hs-var">matching_irreds</span></a></span><span>
</span><span id="line-663"></span><span>        </span><span class="hs-comment">-- See Note [Multiple matching irreds]</span><span>
</span><span id="line-664"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681975770"><span class="annot"><span class="annottext">ev_i :: CtEvidence
</span><a href="#local-6989586621681975770"><span class="hs-identifier hs-var hs-var">ev_i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975767"><span class="hs-identifier hs-var">ct_i</span></a></span><span>
</span><span id="line-665"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iteractIrred&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-666"></span><span>         </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;wanted:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975756"><span class="hs-identifier hs-var">ct_w</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Constraint.html#ctOrigin"><span class="hs-identifier hs-var">ctOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975756"><span class="hs-identifier hs-var">ct_w</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-667"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inert: &quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975767"><span class="hs-identifier hs-var">ct_i</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Constraint.html#ctOrigin"><span class="hs-identifier hs-var">ctOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975767"><span class="hs-identifier hs-var">ct_i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-668"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Ct -&gt; InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#solveOneFromTheOther"><span class="hs-identifier hs-var">solveOneFromTheOther</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975767"><span class="hs-identifier hs-var">ct_i</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975756"><span class="hs-identifier hs-var">ct_w</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-669"></span><span>            </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975758"><span class="hs-identifier hs-var">ev_w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SwapFlag -&gt; CtEvidence -&gt; EvTerm
</span><a href="#local-6989586621681975774"><span class="hs-identifier hs-var">swap_me</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621681975768"><span class="hs-identifier hs-var">swap</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975770"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-670"></span><span>                            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">StopOrContinue Ct -&gt; TcS (StopOrContinue Ct)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc -&gt; StopOrContinue Ct
forall a. CtEvidence -&gt; SDoc -&gt; StopOrContinue a
</span><a href="GHC.Tc.Solver.Canonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975758"><span class="hs-identifier hs-var">ev_w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Irred equal:KeepInert&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975756"><span class="hs-identifier hs-var">ct_w</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-671"></span><span>            </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975770"><span class="hs-identifier hs-var">ev_i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SwapFlag -&gt; CtEvidence -&gt; EvTerm
</span><a href="#local-6989586621681975774"><span class="hs-identifier hs-var">swap_me</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621681975768"><span class="hs-identifier hs-var">swap</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975758"><span class="hs-identifier hs-var">ev_w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-672"></span><span>                            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Cts -&gt; Cts) -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#updInertIrreds"><span class="hs-identifier hs-var">updInertIrreds</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Cts
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975764"><span class="hs-identifier hs-var">others</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-673"></span><span>                            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975756"><span class="hs-identifier hs-var">ct_w</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-676"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975756"><span class="hs-identifier hs-var">ct_w</span></a></span><span>
</span><span id="line-677"></span><span>
</span><span id="line-678"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-679"></span><span>    </span><span class="annot"><a href="#local-6989586621681975774"><span class="hs-identifier hs-type">swap_me</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a></span><span>
</span><span id="line-680"></span><span>    </span><span id="local-6989586621681975774"><span class="annot"><span class="annottext">swap_me :: SwapFlag -&gt; CtEvidence -&gt; EvTerm
</span><a href="#local-6989586621681975774"><span class="hs-identifier hs-var hs-var">swap_me</span></a></span></span><span> </span><span id="local-6989586621681975775"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621681975775"><span class="hs-identifier hs-var">swap</span></a></span></span><span> </span><span id="local-6989586621681975776"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975776"><span class="hs-identifier hs-var">ev</span></a></span></span><span>
</span><span id="line-681"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621681975775"><span class="hs-identifier hs-var">swap</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-682"></span><span>           </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm
</span><a href="GHC.Tc.Types.Constraint.html#ctEvTerm"><span class="hs-identifier hs-var">ctEvTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975776"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-683"></span><span>           </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcCoercion -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#evCoercion"><span class="hs-identifier hs-var">evCoercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EvTerm -&gt; TcCoercion
</span><a href="GHC.Tc.Types.Evidence.html#evTermCoercion"><span class="hs-identifier hs-var">evTermCoercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm
</span><a href="GHC.Tc.Types.Constraint.html#ctEvTerm"><span class="hs-identifier hs-var">ctEvTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975776"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-684"></span><span>
</span><span id="line-685"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#interactIrred"><span class="hs-identifier hs-var">interactIrred</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681975783"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975783"><span class="hs-identifier hs-var">wi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS (StopOrContinue Ct)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interactIrred&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975783"><span class="hs-identifier hs-var">wi</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-686"></span><span>
</span><span id="line-687"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#findMatchingIrreds"><span class="hs-identifier hs-type">findMatchingIrreds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Cts"><span class="hs-identifier hs-type">Cts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-688"></span><span id="findMatchingIrreds"><span class="annot"><span class="annottext">findMatchingIrreds :: Cts -&gt; CtEvidence -&gt; (Bag (Ct, SwapFlag), Cts)
</span><a href="GHC.Tc.Solver.Interact.html#findMatchingIrreds"><span class="hs-identifier hs-var hs-var">findMatchingIrreds</span></a></span></span><span> </span><span id="local-6989586621681975784"><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975784"><span class="hs-identifier hs-var">irreds</span></a></span></span><span> </span><span id="local-6989586621681975785"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975785"><span class="hs-identifier hs-var">ev</span></a></span></span><span>
</span><span id="line-689"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqPred"><span class="hs-identifier hs-type">EqPred</span></a></span><span> </span><span id="local-6989586621681975787"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681975787"><span class="hs-identifier hs-var">eq_rel1</span></a></span></span><span> </span><span id="local-6989586621681975788"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975788"><span class="hs-identifier hs-var">lty1</span></a></span></span><span> </span><span id="local-6989586621681975789"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975789"><span class="hs-identifier hs-var">rty1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975791"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-690"></span><span>    </span><span class="hs-comment">-- See Note [Solving irreducible equalities]</span><span>
</span><span id="line-691"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; Either (Ct, SwapFlag) Ct)
-&gt; Cts -&gt; (Bag (Ct, SwapFlag), Cts)
forall a b c. (a -&gt; Either b c) -&gt; Bag a -&gt; (Bag b, Bag c)
</span><a href="GHC.Data.Bag.html#partitionBagWith"><span class="hs-identifier hs-var">partitionBagWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel -&gt; TcPredType -&gt; TcPredType -&gt; Ct -&gt; Either (Ct, SwapFlag) Ct
</span><a href="#local-6989586621681975793"><span class="hs-identifier hs-var">match_eq</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681975787"><span class="hs-identifier hs-var">eq_rel1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975788"><span class="hs-identifier hs-var">lty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975789"><span class="hs-identifier hs-var">rty1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975784"><span class="hs-identifier hs-var">irreds</span></a></span><span>
</span><span id="line-692"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-693"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; Either (Ct, SwapFlag) Ct)
-&gt; Cts -&gt; (Bag (Ct, SwapFlag), Cts)
forall a b c. (a -&gt; Either b c) -&gt; Bag a -&gt; (Bag b, Bag c)
</span><a href="GHC.Data.Bag.html#partitionBagWith"><span class="hs-identifier hs-var">partitionBagWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Either (Ct, SwapFlag) Ct
</span><a href="#local-6989586621681975794"><span class="hs-identifier hs-var">match_non_eq</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975784"><span class="hs-identifier hs-var">irreds</span></a></span><span>
</span><span id="line-694"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-695"></span><span>    </span><span id="local-6989586621681975791"><span class="annot"><span class="annottext">pred :: TcPredType
</span><a href="#local-6989586621681975791"><span class="hs-identifier hs-var hs-var">pred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975785"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-696"></span><span>    </span><span id="local-6989586621681975794"><span class="annot"><span class="annottext">match_non_eq :: Ct -&gt; Either (Ct, SwapFlag) Ct
</span><a href="#local-6989586621681975794"><span class="hs-identifier hs-var hs-var">match_non_eq</span></a></span></span><span> </span><span id="local-6989586621681975795"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975795"><span class="hs-identifier hs-var">ct</span></a></span></span><span>
</span><span id="line-697"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975795"><span class="hs-identifier hs-var">ct</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; TcPredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqTypeNoKindCheck"><span class="hs-operator hs-var">`tcEqTypeNoKindCheck`</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975791"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct, SwapFlag) -&gt; Either (Ct, SwapFlag) Ct
forall a b. a -&gt; Either a b
</span><a href="../../base-4.18.2.1/src/Data.Either.html#Left/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975795"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-698"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Either (Ct, SwapFlag) Ct
forall a b. b -&gt; Either a b
</span><a href="../../base-4.18.2.1/src/Data.Either.html#Right/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975795"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-699"></span><span>
</span><span id="line-700"></span><span>    </span><span id="local-6989586621681975793"><span class="annot"><span class="annottext">match_eq :: EqRel -&gt; TcPredType -&gt; TcPredType -&gt; Ct -&gt; Either (Ct, SwapFlag) Ct
</span><a href="#local-6989586621681975793"><span class="hs-identifier hs-var hs-var">match_eq</span></a></span></span><span> </span><span id="local-6989586621681975798"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681975798"><span class="hs-identifier hs-var">eq_rel1</span></a></span></span><span> </span><span id="local-6989586621681975799"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975799"><span class="hs-identifier hs-var">lty1</span></a></span></span><span> </span><span id="local-6989586621681975800"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975800"><span class="hs-identifier hs-var">rty1</span></a></span></span><span> </span><span id="local-6989586621681975801"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975801"><span class="hs-identifier hs-var">ct</span></a></span></span><span>
</span><span id="line-701"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqPred"><span class="hs-identifier hs-type">EqPred</span></a></span><span> </span><span id="local-6989586621681975802"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681975802"><span class="hs-identifier hs-var">eq_rel2</span></a></span></span><span> </span><span id="local-6989586621681975803"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975803"><span class="hs-identifier hs-var">lty2</span></a></span></span><span> </span><span id="local-6989586621681975804"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975804"><span class="hs-identifier hs-var">rty2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975801"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-702"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681975798"><span class="hs-identifier hs-var">eq_rel1</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; EqRel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681975802"><span class="hs-identifier hs-var">eq_rel2</span></a></span><span>
</span><span id="line-703"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681975805"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621681975805"><span class="hs-identifier hs-var">swap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPredType
-&gt; TcPredType -&gt; TcPredType -&gt; TcPredType -&gt; Maybe SwapFlag
</span><a href="#local-6989586621681975806"><span class="hs-identifier hs-var">match_eq_help</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975799"><span class="hs-identifier hs-var">lty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975800"><span class="hs-identifier hs-var">rty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975803"><span class="hs-identifier hs-var">lty2</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975804"><span class="hs-identifier hs-var">rty2</span></a></span><span>
</span><span id="line-704"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct, SwapFlag) -&gt; Either (Ct, SwapFlag) Ct
forall a b. a -&gt; Either a b
</span><a href="../../base-4.18.2.1/src/Data.Either.html#Left/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975801"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621681975805"><span class="hs-identifier hs-var">swap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-705"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-706"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Either (Ct, SwapFlag) Ct
forall a b. b -&gt; Either a b
</span><a href="../../base-4.18.2.1/src/Data.Either.html#Right/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975801"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-707"></span><span>
</span><span id="line-708"></span><span>    </span><span id="local-6989586621681975806"><span class="annot"><span class="annottext">match_eq_help :: TcPredType
-&gt; TcPredType -&gt; TcPredType -&gt; TcPredType -&gt; Maybe SwapFlag
</span><a href="#local-6989586621681975806"><span class="hs-identifier hs-var hs-var">match_eq_help</span></a></span></span><span> </span><span id="local-6989586621681975807"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975807"><span class="hs-identifier hs-var">lty1</span></a></span></span><span> </span><span id="local-6989586621681975808"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975808"><span class="hs-identifier hs-var">rty1</span></a></span></span><span> </span><span id="local-6989586621681975809"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975809"><span class="hs-identifier hs-var">lty2</span></a></span></span><span> </span><span id="local-6989586621681975810"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975810"><span class="hs-identifier hs-var">rty2</span></a></span></span><span>
</span><span id="line-709"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975807"><span class="hs-identifier hs-var">lty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; TcPredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqTypeNoKindCheck"><span class="hs-operator hs-var">`tcEqTypeNoKindCheck`</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975809"><span class="hs-identifier hs-var">lty2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975808"><span class="hs-identifier hs-var">rty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; TcPredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqTypeNoKindCheck"><span class="hs-operator hs-var">`tcEqTypeNoKindCheck`</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975810"><span class="hs-identifier hs-var">rty2</span></a></span><span>
</span><span id="line-710"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; Maybe SwapFlag
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span>
</span><span id="line-711"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975807"><span class="hs-identifier hs-var">lty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; TcPredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqTypeNoKindCheck"><span class="hs-operator hs-var">`tcEqTypeNoKindCheck`</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975810"><span class="hs-identifier hs-var">rty2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975808"><span class="hs-identifier hs-var">rty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; TcPredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqTypeNoKindCheck"><span class="hs-operator hs-var">`tcEqTypeNoKindCheck`</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975809"><span class="hs-identifier hs-var">lty2</span></a></span><span>
</span><span id="line-712"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapFlag -&gt; Maybe SwapFlag
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span>
</span><span id="line-713"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-714"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe SwapFlag
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-715"></span><span>
</span><span id="line-716"></span><span class="hs-comment">{- Note [Solving irreducible equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (#14333)
  [G] a b ~R# c d
  [W] c d ~R# a b
Clearly we should be able to solve this! Even though the constraints are
not decomposable. We solve this when looking up the work-item in the
irreducible constraints to look for an identical one.  When doing this
lookup, findMatchingIrreds spots the equality case, and matches either
way around. It has to return a swap-flag so we can generate evidence
that is the right way round too.
-}</span><span>
</span><span id="line-728"></span><span>
</span><span id="line-729"></span><span class="hs-comment">{-
*********************************************************************************
*                                                                               *
                   interactDict
*                                                                               *
*********************************************************************************

Note [Shortcut solving]
~~~~~~~~~~~~~~~~~~~~~~~
When we interact a [W] constraint with a [G] constraint that solves it, there is
a possibility that we could produce better code if instead we solved from a
top-level instance declaration (See #12791, #5835). For example:

    class M a b where m :: a -&gt; b

    type C a b = (Num a, M a b)

    f :: C Int b =&gt; b -&gt; Int -&gt; Int
    f _ x = x + 1

The body of `f` requires a [W] `Num Int` instance. We could solve this
constraint from the givens because we have `C Int b` and that provides us a
solution for `Num Int`. This would let us produce core like the following
(with -O2):

    f :: forall b. C Int b =&gt; b -&gt; Int -&gt; Int
    f = \ (@ b) ($d(%,%) :: C Int b) _ (eta1 :: Int) -&gt;
        + @ Int
          (GHC.Classes.$p1(%,%) @ (Num Int) @ (M Int b) $d(%,%))
          eta1
          A.f1

This is bad! We could do /much/ better if we solved [W] `Num Int` directly
from the instance that we have in scope:

    f :: forall b. C Int b =&gt; b -&gt; Int -&gt; Int
    f = \ (@ b) _ _ (x :: Int) -&gt;
        case x of { GHC.Types.I# x1 -&gt; GHC.Types.I# (GHC.Prim.+# x1 1#) }

** NB: It is important to emphasize that all this is purely an optimization:
** exactly the same programs should typecheck with or without this
** procedure.

Solving fully
~~~~~~~~~~~~~
There is a reason why the solver does not simply try to solve such
constraints with top-level instances. If the solver finds a relevant
instance declaration in scope, that instance may require a context
that can't be solved for. A good example of this is:

    f :: Ord [a] =&gt; ...
    f x = ..Need Eq [a]...

If we have instance `Eq a =&gt; Eq [a]` in scope and we tried to use it, we would
be left with the obligation to solve the constraint Eq a, which we cannot. So we
must be conservative in our attempt to use an instance declaration to solve the
[W] constraint we're interested in.

Our rule is that we try to solve all of the instance's subgoals
recursively all at once. Precisely: We only attempt to solve
constraints of the form `C1, ... Cm =&gt; C t1 ... t n`, where all the Ci
are themselves class constraints of the form `C1', ... Cm' =&gt; C' t1'
... tn'` and we only succeed if the entire tree of constraints is
solvable from instances.

An example that succeeds:

    class Eq a =&gt; C a b | b -&gt; a where
      m :: b -&gt; a

    f :: C [Int] b =&gt; b -&gt; Bool
    f x = m x == []

We solve for `Eq [Int]`, which requires `Eq Int`, which we also have. This
produces the following core:

    f :: forall b. C [Int] b =&gt; b -&gt; Bool
    f = \ (@ b) ($dC :: C [Int] b) (x :: b) -&gt;
        GHC.Classes.$fEq[]_$s$c==
          (m @ [Int] @ b $dC x) (GHC.Types.[] @ Int)

An example that fails:

    class Eq a =&gt; C a b | b -&gt; a where
      m :: b -&gt; a

    f :: C [a] b =&gt; b -&gt; Bool
    f x = m x == []

Which, because solving `Eq [a]` demands `Eq a` which we cannot solve, produces:

    f :: forall a b. C [a] b =&gt; b -&gt; Bool
    f = \ (@ a) (@ b) ($dC :: C [a] b) (eta :: b) -&gt;
        ==
          @ [a]
          (A.$p1C @ [a] @ b $dC)
          (m @ [a] @ b $dC eta)
          (GHC.Types.[] @ a)

Note [Shortcut solving: type families]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have (#13943)
  class Take (n :: Nat) where ...
  instance {-# OVERLAPPING #-}                    Take 0 where ..
  instance {-# OVERLAPPABLE #-} (Take (n - 1)) =&gt; Take n where ..

And we have [W] Take 3.  That only matches one instance so we get
[W] Take (3-1).  Really we should now rewrite to reduce the (3-1) to 2, and
so on -- but that is reproducing yet more of the solver.  Sigh.  For now,
we just give up (remember all this is just an optimisation).

But we must not just naively try to lookup (Take (3-1)) in the
InstEnv, or it'll (wrongly) appear not to match (Take 0) and get a
unique match on the (Take n) instance.  That leads immediately to an
infinite loop.  Hence the check that 'preds' have no type families
(isTyFamFree).

Note [Shortcut solving: incoherence]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This optimization relies on coherence of dictionaries to be correct. When we
cannot assume coherence because of IncoherentInstances then this optimization
can change the behavior of the user's code.

The following four modules produce a program whose output would change depending
on whether we apply this optimization when IncoherentInstances is in effect:

=========
    {-# LANGUAGE MultiParamTypeClasses #-}
    module A where

    class A a where
      int :: a -&gt; Int

    class A a =&gt; C a b where
      m :: b -&gt; a -&gt; a

=========
    {-# LANGUAGE FlexibleInstances     #-}
    {-# LANGUAGE MultiParamTypeClasses #-}
    module B where

    import A

    instance A a where
      int _ = 1

    instance C a [b] where
      m _ = id

=========
    {-# LANGUAGE FlexibleContexts      #-}
    {-# LANGUAGE FlexibleInstances     #-}
    {-# LANGUAGE IncoherentInstances   #-}
    {-# LANGUAGE MultiParamTypeClasses #-}
    module C where

    import A

    instance A Int where
      int _ = 2

    instance C Int [Int] where
      m _ = id

    intC :: C Int a =&gt; a -&gt; Int -&gt; Int
    intC _ x = int x

=========
    module Main where

    import A
    import B
    import C

    main :: IO ()
    main = print (intC [] (0::Int))

The output of `main` if we avoid the optimization under the effect of
IncoherentInstances is `1`. If we were to do the optimization, the output of
`main` would be `2`.

Note [Shortcut try_solve_from_instance]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The workhorse of the short-cut solver is
    try_solve_from_instance :: (EvBindMap, DictMap CtEvidence)
                            -&gt; CtEvidence       -- Solve this
                            -&gt; MaybeT TcS (EvBindMap, DictMap CtEvidence)
Note that:

* The CtEvidence is the goal to be solved

* The MaybeT manages early failure if we find a subgoal that
  cannot be solved from instances.

* The (EvBindMap, DictMap CtEvidence) is an accumulating purely-functional
  state that allows try_solve_from_instance to augment the evidence
  bindings and inert_solved_dicts as it goes.

  If it succeeds, we commit all these bindings and solved dicts to the
  main TcS InertSet.  If not, we abandon it all entirely.

Passing along the solved_dicts important for two reasons:

* We need to be able to handle recursive super classes. The
  solved_dicts state  ensures that we remember what we have already
  tried to solve to avoid looping.

* As #15164 showed, it can be important to exploit sharing between
  goals. E.g. To solve G we may need G1 and G2. To solve G1 we may need H;
  and to solve G2 we may need H. If we don't spot this sharing we may
  solve H twice; and if this pattern repeats we may get exponentially bad
  behaviour.

Note [No Given/Given fundeps]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We do not create constraints from:
* Given/Given interactions via functional dependencies or type family
  injectivity annotations.
* Given/instance fundep interactions via functional dependencies or
  type family injectivity annotations.

In this Note, all these interactions are called just &quot;fundeps&quot;.

We ingore such fundeps for several reasons:

1. These fundeps will never serve a purpose in accepting more
   programs: Given constraints do not contain metavariables that could
   be unified via exploring fundeps. They *could* be useful in
   discovering inaccessible code. However, the constraints will be
   Wanteds, and as such will cause errors (not just warnings) if they
   go unsolved. Maybe there is a clever way to get the right
   inaccessible code warnings, but the path forward is far from
   clear. #12466 has further commentary.

2. Furthermore, here is a case where a Given/instance interaction is actively
   harmful (from dependent/should_compile/RaeJobTalk):

       type family a == b :: Bool
       type family Not a = r | r -&gt; a where
         Not False = True
         Not True  = False

       [G] Not (a == b) ~ True

   Reacting this Given with the equations for Not produces

      [W] a == b ~ False

   This is indeed a true consequence, and would make sense as a fresh Given.
   But we don't have a way to produce evidence for fundeps, as a Wanted it
   is /harmful/: we can't prove it, and so we'll report an error and reject
   the program. (Previously fundeps gave rise to Deriveds, which
   carried no evidence, so it didn't matter that they could not be proved.)

3. #20922 showed a subtle different problem with Given/instance fundeps.
      type family ZipCons (as :: [k]) (bssx :: [[k]]) = (r :: [[k]]) | r -&gt; as bssx where
        ZipCons (a ': as) (bs ': bss) = (a ': bs) ': ZipCons as bss
        ...

      tclevel = 4
      [G] ZipCons is1 iss ~ (i : is2) : jss

   (The tclevel=4 means that this Given is at level 4.)  The fundep tells us that
   'iss' must be of form (is2 : beta[4]) where beta[4] is a fresh unification
   variable; we don't know what type it stands for. So we would emit
      [W] iss ~ is2 : beta

   Again we can't prove that equality; and worse we'll rewrite iss to
   (is2:beta) in deeply nested constraints inside this implication,
   where beta is untouchable (under other equality constraints), leading
   to other insoluble constraints.

The bottom line: since we have no evidence for them, we should ignore Given/Given
and Given/instance fundeps entirely.
-}</span><span>
</span><span id="line-1004"></span><span>
</span><span id="line-1005"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#interactDict"><span class="hs-identifier hs-type">interactDict</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1006"></span><span id="interactDict"><span class="annot"><span class="annottext">interactDict :: InertCans -&gt; SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#interactDict"><span class="hs-identifier hs-var hs-var">interactDict</span></a></span></span><span> </span><span id="local-6989586621681975811"><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975811"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span id="local-6989586621681975812"><span class="annot"><span class="annottext">ct_w :: Ct
</span><a href="#local-6989586621681975812"><span class="hs-identifier hs-var">ct_w</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CDictCan"><span class="hs-identifier hs-type">CDictCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975813"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975813"><span class="hs-identifier hs-var">ev_w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_class :: Ct -&gt; Class
</span><a href="GHC.Tc.Types.Constraint.html#cc_class"><span class="hs-identifier hs-var">cc_class</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975815"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975815"><span class="hs-identifier hs-var">cls</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_tyargs :: Ct -&gt; [TcPredType]
</span><a href="GHC.Tc.Types.Constraint.html#cc_tyargs"><span class="hs-identifier hs-var">cc_tyargs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975817"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975817"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1007"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681975818"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975818"><span class="hs-identifier hs-var">ct_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; CtLoc -&gt; Class -&gt; [TcPredType] -&gt; Maybe Ct
</span><a href="GHC.Tc.Solver.Monad.html#lookupInertDict"><span class="hs-identifier hs-var">lookupInertDict</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975811"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975813"><span class="hs-identifier hs-var">ev_w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975815"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975817"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1008"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681975820"><span class="annot"><span class="annottext">ev_i :: CtEvidence
</span><a href="#local-6989586621681975820"><span class="hs-identifier hs-var hs-var">ev_i</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975818"><span class="hs-identifier hs-var">ct_i</span></a></span><span>
</span><span id="line-1009"></span><span>        </span><span id="local-6989586621681975821"><span class="annot"><span class="annottext">loc_i :: CtLoc
</span><a href="#local-6989586621681975821"><span class="hs-identifier hs-var hs-var">loc_i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975820"><span class="hs-identifier hs-var">ev_i</span></a></span><span>
</span><span id="line-1010"></span><span>        </span><span id="local-6989586621681975822"><span class="annot"><span class="annottext">loc_w :: CtLoc
</span><a href="#local-6989586621681975822"><span class="hs-identifier hs-var hs-var">loc_w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975813"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-1011"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- There is a matching dictionary in the inert set</span><span>
</span><span id="line-1012"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- First to try to solve it /completely/ from top level instances</span><span>
</span><span id="line-1013"></span><span>         </span><span class="hs-comment">-- See Note [Shortcut solving]</span><span>
</span><span id="line-1014"></span><span>         </span><span id="local-6989586621681975823"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681975823"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.Session.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-1015"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975824"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975824"><span class="hs-identifier hs-var">short_cut_worked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; CtEvidence -&gt; CtEvidence -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Interact.html#shortCutSolver"><span class="hs-identifier hs-var">shortCutSolver</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681975823"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975813"><span class="hs-identifier hs-var">ev_w</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975820"><span class="hs-identifier hs-var">ev_i</span></a></span><span>
</span><span id="line-1016"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681975824"><span class="hs-identifier hs-var">short_cut_worked</span></a></span><span>
</span><span id="line-1017"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; String -&gt; TcS (StopOrContinue Ct)
forall a. CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975813"><span class="hs-identifier hs-var">ev_w</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interactDict/solved from instance&quot;</span></span><span>
</span><span id="line-1018"></span><span>
</span><span id="line-1019"></span><span>         </span><span class="hs-comment">-- Next see if we are in &quot;loopy-superclass&quot; land.  If so,</span><span>
</span><span id="line-1020"></span><span>         </span><span class="hs-comment">-- we don't want to replace the (Given) inert with the</span><span>
</span><span id="line-1021"></span><span>         </span><span class="hs-comment">-- (Wanted) work-item, or vice versa; we want to hang on</span><span>
</span><span id="line-1022"></span><span>         </span><span class="hs-comment">-- to both, and try to solve the work-item via an instance.</span><span>
</span><span id="line-1023"></span><span>         </span><span class="hs-comment">-- See Note [Solving superclass constraints] in GHC.Tc.TyCl.Instance</span><span>
</span><span id="line-1024"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtLoc -&gt; Bool
</span><a href="GHC.Tc.Solver.InertSet.html#prohibitedSuperClassSolve"><span class="hs-identifier hs-var">prohibitedSuperClassSolve</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975821"><span class="hs-identifier hs-var">loc_i</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975822"><span class="hs-identifier hs-var">loc_w</span></a></span><span>
</span><span id="line-1025"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975812"><span class="hs-identifier hs-var">ct_w</span></a></span><span>
</span><span id="line-1026"></span><span>         </span><span class="hs-keyword">else</span><span>
</span><span id="line-1027"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- The short-cut solver didn't fire, and loopy superclasses</span><span>
</span><span id="line-1028"></span><span>         </span><span class="hs-comment">-- are dealt with, so we can either solve</span><span>
</span><span id="line-1029"></span><span>         </span><span class="hs-comment">-- the inert from the work-item or vice-versa.</span><span>
</span><span id="line-1030"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Ct -&gt; InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#solveOneFromTheOther"><span class="hs-identifier hs-var">solveOneFromTheOther</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975818"><span class="hs-identifier hs-var">ct_i</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975812"><span class="hs-identifier hs-var">ct_w</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1031"></span><span>           </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepInert"><span class="hs-identifier hs-var">KeepInert</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lookupInertDict:KeepInert&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975812"><span class="hs-identifier hs-var">ct_w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1032"></span><span>                           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975813"><span class="hs-identifier hs-var">ev_w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm
</span><a href="GHC.Tc.Types.Constraint.html#ctEvTerm"><span class="hs-identifier hs-var">ctEvTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975820"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1033"></span><span>                           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">StopOrContinue Ct -&gt; TcS (StopOrContinue Ct)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(StopOrContinue Ct -&gt; TcS (StopOrContinue Ct))
-&gt; StopOrContinue Ct -&gt; TcS (StopOrContinue Ct)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc -&gt; StopOrContinue Ct
forall a. CtEvidence -&gt; SDoc -&gt; StopOrContinue a
</span><a href="GHC.Tc.Solver.Canonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975813"><span class="hs-identifier hs-var">ev_w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Dict equal&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975812"><span class="hs-identifier hs-var">ct_w</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1034"></span><span>           </span><span class="annot"><span class="annottext">InteractResult
</span><a href="GHC.Tc.Solver.Interact.html#KeepWork"><span class="hs-identifier hs-var">KeepWork</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lookupInertDict:KeepWork&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975812"><span class="hs-identifier hs-var">ct_w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1035"></span><span>                           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975820"><span class="hs-identifier hs-var">ev_i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm
</span><a href="GHC.Tc.Types.Constraint.html#ctEvTerm"><span class="hs-identifier hs-var">ctEvTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975813"><span class="hs-identifier hs-var">ev_w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1036"></span><span>                           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(DictMap Ct -&gt; DictMap Ct) -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#updInertDicts"><span class="hs-identifier hs-var">updInertDicts</span></a></span><span> </span><span class="annot"><span class="annottext">((DictMap Ct -&gt; DictMap Ct) -&gt; TcS ())
-&gt; (DictMap Ct -&gt; DictMap Ct) -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681975828"><span class="annot"><span class="annottext">DictMap Ct
</span><a href="#local-6989586621681975828"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DictMap Ct -&gt; Class -&gt; [TcPredType] -&gt; DictMap Ct
forall a. DictMap a -&gt; Class -&gt; [TcPredType] -&gt; DictMap a
</span><a href="GHC.Tc.Solver.Types.html#delDict"><span class="hs-identifier hs-var">delDict</span></a></span><span> </span><span class="annot"><span class="annottext">DictMap Ct
</span><a href="#local-6989586621681975828"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975815"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975817"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1037"></span><span>                           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975812"><span class="hs-identifier hs-var">ct_w</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1038"></span><span>
</span><span id="line-1039"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975815"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#ipClassKey"><span class="hs-identifier hs-var">ipClassKey</span></a></span><span>
</span><span id="line-1040"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975813"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-1041"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#interactGivenIP"><span class="hs-identifier hs-var">interactGivenIP</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975811"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975812"><span class="hs-identifier hs-var">ct_w</span></a></span><span>
</span><span id="line-1042"></span><span>
</span><span id="line-1043"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1044"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; CtEvidence -&gt; Class -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#addFunDepWork"><span class="hs-identifier hs-var">addFunDepWork</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975811"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975813"><span class="hs-identifier hs-var">ev_w</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975815"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-1045"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975812"><span class="hs-identifier hs-var">ct_w</span></a></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-1046"></span><span>
</span><span id="line-1047"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#interactDict"><span class="hs-identifier hs-var">interactDict</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681975833"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975833"><span class="hs-identifier hs-var">wi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS (StopOrContinue Ct)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interactDict&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975833"><span class="hs-identifier hs-var">wi</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1048"></span><span>
</span><span id="line-1049"></span><span class="hs-comment">-- See Note [Shortcut solving]</span><span>
</span><span id="line-1050"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#shortCutSolver"><span class="hs-identifier hs-type">shortCutSolver</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span>
</span><span id="line-1051"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-comment">-- Work item</span><span>
</span><span id="line-1052"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-comment">-- Inert we want to try to replace</span><span>
</span><span id="line-1053"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>   </span><span class="hs-comment">-- True &lt;=&gt; success</span><span>
</span><span id="line-1054"></span><span id="shortCutSolver"><span class="annot"><span class="annottext">shortCutSolver :: DynFlags -&gt; CtEvidence -&gt; CtEvidence -&gt; TcS Bool
</span><a href="GHC.Tc.Solver.Interact.html#shortCutSolver"><span class="hs-identifier hs-var hs-var">shortCutSolver</span></a></span></span><span> </span><span id="local-6989586621681975834"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681975834"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621681975835"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975835"><span class="hs-identifier hs-var">ev_w</span></a></span></span><span> </span><span id="local-6989586621681975836"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975836"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span>
</span><span id="line-1055"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isWanted"><span class="hs-identifier hs-var">isWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975835"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-1056"></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975836"><span class="hs-identifier hs-var">ev_i</span></a></span><span>
</span><span id="line-1057"></span><span> </span><span class="hs-comment">-- We are about to solve a [W] constraint from a [G] constraint. We take</span><span>
</span><span id="line-1058"></span><span> </span><span class="hs-comment">-- a moment to see if we can get a better solution using an instance.</span><span>
</span><span id="line-1059"></span><span> </span><span class="hs-comment">-- Note that we only do this for the sake of performance. Exactly the same</span><span>
</span><span id="line-1060"></span><span> </span><span class="hs-comment">-- programs should typecheck regardless of whether we take this step or</span><span>
</span><span id="line-1061"></span><span> </span><span class="hs-comment">-- not. See Note [Shortcut solving]</span><span>
</span><span id="line-1062"></span><span>
</span><span id="line-1063"></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPredType -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isIPLikePred"><span class="hs-identifier hs-var">isIPLikePred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975835"><span class="hs-identifier hs-var">ev_w</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Not for implicit parameters (#18627)</span><span>
</span><span id="line-1064"></span><span>
</span><span id="line-1065"></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Extension -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#xopt"><span class="hs-identifier hs-var">xopt</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.IncoherentInstances</span></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681975834"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1066"></span><span> </span><span class="hs-comment">-- If IncoherentInstances is on then we cannot rely on coherence of proofs</span><span>
</span><span id="line-1067"></span><span> </span><span class="hs-comment">-- in order to justify this optimization: The proof provided by the</span><span>
</span><span id="line-1068"></span><span> </span><span class="hs-comment">-- [G] constraint's superclass may be different from the top-level proof.</span><span>
</span><span id="line-1069"></span><span> </span><span class="hs-comment">-- See Note [Shortcut solving: incoherence]</span><span>
</span><span id="line-1070"></span><span>
</span><span id="line-1071"></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_SolveConstantDicts"><span class="hs-identifier hs-var">Opt_SolveConstantDicts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681975834"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-1072"></span><span> </span><span class="hs-comment">-- Enabled by the -fsolve-constant-dicts flag</span><span>
</span><span id="line-1073"></span><span>
</span><span id="line-1074"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681975842"><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621681975842"><span class="hs-identifier hs-var">ev_binds_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS EvBindsVar
</span><a href="GHC.Tc.Solver.Monad.html#getTcEvBindsVar"><span class="hs-identifier hs-var">getTcEvBindsVar</span></a></span><span>
</span><span id="line-1075"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975843"><span class="annot"><span class="annottext">EvBindMap
</span><a href="#local-6989586621681975843"><span class="hs-identifier hs-var">ev_binds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; TcS EvBindMap -&gt; TcS EvBindMap
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EvBindsVar -&gt; Bool
</span><a href="GHC.Tc.Types.Evidence.html#isCoEvBindsVar"><span class="hs-identifier hs-var">isCoEvBindsVar</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621681975842"><span class="hs-identifier hs-var">ev_binds_var</span></a></span><span> </span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975835"><span class="hs-identifier hs-var">ev_w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcS EvBindMap -&gt; TcS EvBindMap) -&gt; TcS EvBindMap -&gt; TcS EvBindMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1076"></span><span>                     </span><span class="annot"><span class="annottext">EvBindsVar -&gt; TcS EvBindMap
</span><a href="GHC.Tc.Solver.Monad.html#getTcEvBindsMap"><span class="hs-identifier hs-var">getTcEvBindsMap</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621681975842"><span class="hs-identifier hs-var">ev_binds_var</span></a></span><span>
</span><span id="line-1077"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975847"><span class="annot"><span class="annottext">DictMap CtEvidence
</span><a href="#local-6989586621681975847"><span class="hs-identifier hs-var">solved_dicts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS (DictMap CtEvidence)
</span><a href="GHC.Tc.Solver.Monad.html#getSolvedDicts"><span class="hs-identifier hs-var">getSolvedDicts</span></a></span><span>
</span><span id="line-1078"></span><span>
</span><span id="line-1079"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975849"><span class="annot"><span class="annottext">Maybe (EvBindMap, DictMap CtEvidence)
</span><a href="#local-6989586621681975849"><span class="hs-identifier hs-var">mb_stuff</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MaybeT TcS (EvBindMap, DictMap CtEvidence)
-&gt; TcS (Maybe (EvBindMap, DictMap CtEvidence))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Maybe.html#runMaybeT/Control.Monad.Trans.Maybe.html#runMaybeT"><span class="hs-identifier hs-var">runMaybeT</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeT TcS (EvBindMap, DictMap CtEvidence)
 -&gt; TcS (Maybe (EvBindMap, DictMap CtEvidence)))
-&gt; MaybeT TcS (EvBindMap, DictMap CtEvidence)
-&gt; TcS (Maybe (EvBindMap, DictMap CtEvidence))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(EvBindMap, DictMap CtEvidence)
-&gt; CtEvidence -&gt; MaybeT TcS (EvBindMap, DictMap CtEvidence)
</span><a href="#local-6989586621681975851"><span class="hs-identifier hs-var">try_solve_from_instance</span></a></span><span>
</span><span id="line-1080"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EvBindMap
</span><a href="#local-6989586621681975843"><span class="hs-identifier hs-var">ev_binds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DictMap CtEvidence
</span><a href="#local-6989586621681975847"><span class="hs-identifier hs-var">solved_dicts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975835"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-1081"></span><span>
</span><span id="line-1082"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (EvBindMap, DictMap CtEvidence)
</span><a href="#local-6989586621681975849"><span class="hs-identifier hs-var">mb_stuff</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1083"></span><span>           </span><span class="annot"><span class="annottext">Maybe (EvBindMap, DictMap CtEvidence)
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1084"></span><span>           </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681975852"><span class="annot"><span class="annottext">EvBindMap
</span><a href="#local-6989586621681975852"><span class="hs-identifier hs-var">ev_binds'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681975853"><span class="annot"><span class="annottext">DictMap CtEvidence
</span><a href="#local-6989586621681975853"><span class="hs-identifier hs-var">solved_dicts'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1085"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">EvBindsVar -&gt; EvBindMap -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setTcEvBindsMap"><span class="hs-identifier hs-var">setTcEvBindsMap</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621681975842"><span class="hs-identifier hs-var">ev_binds_var</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindMap
</span><a href="#local-6989586621681975852"><span class="hs-identifier hs-var">ev_binds'</span></a></span><span>
</span><span id="line-1086"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">DictMap CtEvidence -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setSolvedDicts"><span class="hs-identifier hs-var">setSolvedDicts</span></a></span><span> </span><span class="annot"><span class="annottext">DictMap CtEvidence
</span><a href="#local-6989586621681975853"><span class="hs-identifier hs-var">solved_dicts'</span></a></span><span>
</span><span id="line-1087"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1088"></span><span>
</span><span id="line-1089"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1090"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1091"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1092"></span><span>    </span><span class="hs-comment">-- This `CtLoc` is used only to check the well-staged condition of any</span><span>
</span><span id="line-1093"></span><span>    </span><span class="hs-comment">-- candidate DFun. Our subgoals all have the same stage as our root</span><span>
</span><span id="line-1094"></span><span>    </span><span class="hs-comment">-- [W] constraint so it is safe to use this while solving them.</span><span>
</span><span id="line-1095"></span><span>    </span><span id="local-6989586621681975856"><span class="annot"><span class="annottext">loc_w :: CtLoc
</span><a href="#local-6989586621681975856"><span class="hs-identifier hs-var hs-var">loc_w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975835"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-1096"></span><span>
</span><span id="line-1097"></span><span>    </span><span class="annot"><a href="#local-6989586621681975851"><span class="hs-identifier hs-type">try_solve_from_instance</span></a></span><span>   </span><span class="hs-comment">-- See Note [Shortcut try_solve_from_instance]</span><span>
</span><span id="line-1098"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvBindMap"><span class="hs-identifier hs-type">EvBindMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Types.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>
</span><span id="line-1099"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Maybe.html#MaybeT/Control.Monad.Trans.Maybe.html#MaybeT"><span class="hs-identifier hs-type">MaybeT</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvBindMap"><span class="hs-identifier hs-type">EvBindMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Types.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1100"></span><span>    </span><span id="local-6989586621681975851"><span class="annot"><span class="annottext">try_solve_from_instance :: (EvBindMap, DictMap CtEvidence)
-&gt; CtEvidence -&gt; MaybeT TcS (EvBindMap, DictMap CtEvidence)
</span><a href="#local-6989586621681975851"><span class="hs-identifier hs-var hs-var">try_solve_from_instance</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681975857"><span class="annot"><span class="annottext">EvBindMap
</span><a href="#local-6989586621681975857"><span class="hs-identifier hs-var">ev_binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681975858"><span class="annot"><span class="annottext">DictMap CtEvidence
</span><a href="#local-6989586621681975858"><span class="hs-identifier hs-var">solved_dicts</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681975859"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975859"><span class="hs-identifier hs-var">ev</span></a></span></span><span>
</span><span id="line-1101"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681975860"><span class="annot"><span class="annottext">pred :: TcPredType
</span><a href="#local-6989586621681975860"><span class="hs-identifier hs-var hs-var">pred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975859"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-1102"></span><span>            </span><span id="local-6989586621681975861"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621681975861"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span>  </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975859"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-1103"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#ClassPred"><span class="hs-identifier hs-type">ClassPred</span></a></span><span> </span><span id="local-6989586621681975863"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975863"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621681975864"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975864"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975860"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-1104"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681975865"><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681975865"><span class="hs-identifier hs-var">inst_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS ClsInstResult -&gt; MaybeT TcS ClsInstResult
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; MaybeT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS ClsInstResult -&gt; MaybeT TcS ClsInstResult)
-&gt; TcS ClsInstResult -&gt; MaybeT TcS ClsInstResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Bool -&gt; Class -&gt; [TcPredType] -&gt; TcS ClsInstResult
</span><a href="GHC.Tc.Solver.Monad.html#matchGlobalInst"><span class="hs-identifier hs-var">matchGlobalInst</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681975834"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975863"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975864"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1105"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681975865"><span class="hs-identifier hs-var">inst_res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1106"></span><span>               </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#OneInst"><span class="hs-identifier hs-type">OneInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cir_new_theta :: ClsInstResult -&gt; [TcPredType]
</span><a href="GHC.Tc.Instance.Class.html#cir_new_theta"><span class="hs-identifier hs-var">cir_new_theta</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975870"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975870"><span class="hs-identifier hs-var">preds</span></a></span></span><span>
</span><span id="line-1107"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cir_mk_ev :: ClsInstResult -&gt; [EvExpr] -&gt; EvTerm
</span><a href="GHC.Tc.Instance.Class.html#cir_mk_ev"><span class="hs-identifier hs-var">cir_mk_ev</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975872"><span class="annot"><span class="annottext">[EvExpr] -&gt; EvTerm
</span><a href="#local-6989586621681975872"><span class="hs-identifier hs-var">mk_ev</span></a></span></span><span>
</span><span id="line-1108"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cir_what :: ClsInstResult -&gt; InstanceWhat
</span><a href="GHC.Tc.Instance.Class.html#cir_what"><span class="hs-identifier hs-var">cir_what</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975874"><span class="annot"><span class="annottext">InstanceWhat
</span><a href="#local-6989586621681975874"><span class="hs-identifier hs-var">what</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1109"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InstanceWhat -&gt; Bool
</span><a href="GHC.Tc.Instance.Class.html#safeOverlap"><span class="hs-identifier hs-var">safeOverlap</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceWhat
</span><a href="#local-6989586621681975874"><span class="hs-identifier hs-var">what</span></a></span><span>
</span><span id="line-1110"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(TcPredType -&gt; Bool) -&gt; [TcPredType] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#all/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; Bool
</span><a href="GHC.Tc.Utils.TcType.html#isTyFamFree"><span class="hs-identifier hs-var">isTyFamFree</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975870"><span class="hs-identifier hs-var">preds</span></a></span><span>  </span><span class="hs-comment">-- Note [Shortcut solving: type families]</span><span>
</span><span id="line-1111"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681975877"><span class="annot"><span class="annottext">solved_dicts' :: DictMap CtEvidence
</span><a href="#local-6989586621681975877"><span class="hs-identifier hs-var hs-var">solved_dicts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DictMap CtEvidence
-&gt; Class -&gt; [TcPredType] -&gt; CtEvidence -&gt; DictMap CtEvidence
forall a. DictMap a -&gt; Class -&gt; [TcPredType] -&gt; a -&gt; DictMap a
</span><a href="GHC.Tc.Solver.Types.html#addDict"><span class="hs-identifier hs-var">addDict</span></a></span><span> </span><span class="annot"><span class="annottext">DictMap CtEvidence
</span><a href="#local-6989586621681975858"><span class="hs-identifier hs-var">solved_dicts</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975863"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975864"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975859"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-1112"></span><span>                             </span><span class="hs-comment">-- solved_dicts': it is important that we add our goal</span><span>
</span><span id="line-1113"></span><span>                             </span><span class="hs-comment">-- to the cache before we solve! Otherwise we may end</span><span>
</span><span id="line-1114"></span><span>                             </span><span class="hs-comment">-- up in a loop while solving recursive dictionaries.</span><span>
</span><span id="line-1115"></span><span>
</span><span id="line-1116"></span><span>                       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcS () -&gt; MaybeT TcS ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; MaybeT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS () -&gt; MaybeT TcS ()) -&gt; TcS () -&gt; MaybeT TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shortCutSolver: found instance&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcPredType] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975870"><span class="hs-identifier hs-var">preds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1117"></span><span>                       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975879"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975879"><span class="hs-identifier hs-var">loc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS CtLoc -&gt; MaybeT TcS CtLoc
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; MaybeT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS CtLoc -&gt; MaybeT TcS CtLoc) -&gt; TcS CtLoc -&gt; MaybeT TcS CtLoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; InstanceWhat -&gt; TcPredType -&gt; TcS CtLoc
</span><a href="GHC.Tc.Solver.Interact.html#checkInstanceOK"><span class="hs-identifier hs-var">checkInstanceOK</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975861"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceWhat
</span><a href="#local-6989586621681975874"><span class="hs-identifier hs-var">what</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975860"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-1118"></span><span>                       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcS () -&gt; MaybeT TcS ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; MaybeT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS () -&gt; MaybeT TcS ()) -&gt; TcS () -&gt; MaybeT TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; TcPredType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#checkReductionDepth"><span class="hs-identifier hs-var">checkReductionDepth</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975879"><span class="hs-identifier hs-var">loc'</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975860"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-1119"></span><span>
</span><span id="line-1120"></span><span>
</span><span id="line-1121"></span><span>                       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681975882"><span class="annot"><span class="annottext">[MaybeNew]
</span><a href="#local-6989586621681975882"><span class="hs-identifier hs-var">evc_vs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcPredType -&gt; MaybeT TcS MaybeNew)
-&gt; [TcPredType] -&gt; MaybeT TcS [MaybeNew]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#mapM/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence
-&gt; CtLoc -&gt; DictMap CtEvidence -&gt; TcPredType -&gt; MaybeT TcS MaybeNew
</span><a href="#local-6989586621681975884"><span class="hs-identifier hs-var">new_wanted_cached</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975859"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975879"><span class="hs-identifier hs-var">loc'</span></a></span><span> </span><span class="annot"><span class="annottext">DictMap CtEvidence
</span><a href="#local-6989586621681975877"><span class="hs-identifier hs-var">solved_dicts'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975870"><span class="hs-identifier hs-var">preds</span></a></span><span>
</span><span id="line-1122"></span><span>                                  </span><span class="hs-comment">-- Emit work for subgoals but use our local cache</span><span>
</span><span id="line-1123"></span><span>                                  </span><span class="hs-comment">-- so we can solve recursive dictionaries.</span><span>
</span><span id="line-1124"></span><span>
</span><span id="line-1125"></span><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681975885"><span class="annot"><span class="annottext">ev_tm :: EvTerm
</span><a href="#local-6989586621681975885"><span class="hs-identifier hs-var hs-var">ev_tm</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EvExpr] -&gt; EvTerm
</span><a href="#local-6989586621681975872"><span class="hs-identifier hs-var">mk_ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(MaybeNew -&gt; EvExpr) -&gt; [MaybeNew] -&gt; [EvExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeNew -&gt; EvExpr
</span><a href="GHC.Tc.Solver.Monad.html#getEvExpr"><span class="hs-identifier hs-var">getEvExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[MaybeNew]
</span><a href="#local-6989586621681975882"><span class="hs-identifier hs-var">evc_vs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1126"></span><span>                             </span><span id="local-6989586621681975887"><span class="annot"><span class="annottext">ev_binds' :: EvBindMap
</span><a href="#local-6989586621681975887"><span class="hs-identifier hs-var hs-var">ev_binds'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EvBindMap -&gt; EvBind -&gt; EvBindMap
</span><a href="GHC.Tc.Types.Evidence.html#extendEvBinds"><span class="hs-identifier hs-var">extendEvBinds</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindMap
</span><a href="#local-6989586621681975857"><span class="hs-identifier hs-var">ev_binds</span></a></span><span> </span><span class="annot"><span class="annottext">(EvBind -&gt; EvBindMap) -&gt; EvBind -&gt; EvBindMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1127"></span><span>                                         </span><span class="annot"><span class="annottext">TyVar -&gt; EvTerm -&gt; EvBind
</span><a href="GHC.Tc.Types.Evidence.html#mkWantedEvBind"><span class="hs-identifier hs-var">mkWantedEvBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; TyVar
</span><a href="GHC.Tc.Types.Constraint.html#ctEvEvId"><span class="hs-identifier hs-var">ctEvEvId</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975859"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EvTerm
</span><a href="#local-6989586621681975885"><span class="hs-identifier hs-var">ev_tm</span></a></span><span>
</span><span id="line-1128"></span><span>
</span><span id="line-1129"></span><span>                       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">((EvBindMap, DictMap CtEvidence)
 -&gt; CtEvidence -&gt; MaybeT TcS (EvBindMap, DictMap CtEvidence))
-&gt; (EvBindMap, DictMap CtEvidence)
-&gt; [CtEvidence]
-&gt; MaybeT TcS (EvBindMap, DictMap CtEvidence)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#foldlM/Data.Foldable.html#foldlM"><span class="hs-identifier hs-var">foldlM</span></a></span><span> </span><span class="annot"><span class="annottext">(EvBindMap, DictMap CtEvidence)
-&gt; CtEvidence -&gt; MaybeT TcS (EvBindMap, DictMap CtEvidence)
</span><a href="#local-6989586621681975851"><span class="hs-identifier hs-var">try_solve_from_instance</span></a></span><span>
</span><span id="line-1130"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EvBindMap
</span><a href="#local-6989586621681975887"><span class="hs-identifier hs-var">ev_binds'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DictMap CtEvidence
</span><a href="#local-6989586621681975877"><span class="hs-identifier hs-var">solved_dicts'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1131"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[MaybeNew] -&gt; [CtEvidence]
</span><a href="GHC.Tc.Solver.Monad.html#freshGoals"><span class="hs-identifier hs-var">freshGoals</span></a></span><span> </span><span class="annot"><span class="annottext">[MaybeNew]
</span><a href="#local-6989586621681975882"><span class="hs-identifier hs-var">evc_vs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1132"></span><span>
</span><span id="line-1133"></span><span>               </span><span class="annot"><span class="annottext">ClsInstResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaybeT TcS (EvBindMap, DictMap CtEvidence)
forall a. MaybeT TcS a
forall (m :: * -&gt; *) a. MonadPlus m =&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#mzero/GHC.Base.html#mzero"><span class="hs-identifier hs-var">mzero</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1134"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeT TcS (EvBindMap, DictMap CtEvidence)
forall a. MaybeT TcS a
forall (m :: * -&gt; *) a. MonadPlus m =&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#mzero/GHC.Base.html#mzero"><span class="hs-identifier hs-var">mzero</span></a></span><span>
</span><span id="line-1135"></span><span>
</span><span id="line-1136"></span><span>
</span><span id="line-1137"></span><span>    </span><span class="hs-comment">-- Use a local cache of solved dicts while emitting EvVars for new work</span><span>
</span><span id="line-1138"></span><span>    </span><span class="hs-comment">-- We bail out of the entire computation if we need to emit an EvVar for</span><span>
</span><span id="line-1139"></span><span>    </span><span class="hs-comment">-- a subgoal that isn't a ClassPred.</span><span>
</span><span id="line-1140"></span><span>    </span><span class="annot"><a href="#local-6989586621681975884"><span class="hs-identifier hs-type">new_wanted_cached</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span>
</span><span id="line-1141"></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Types.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcPredType"><span class="hs-identifier hs-type">TcPredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Maybe.html#MaybeT/Control.Monad.Trans.Maybe.html#MaybeT"><span class="hs-identifier hs-type">MaybeT</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#MaybeNew"><span class="hs-identifier hs-type">MaybeNew</span></a></span><span>
</span><span id="line-1142"></span><span>    </span><span id="local-6989586621681975884"><span class="annot"><span class="annottext">new_wanted_cached :: CtEvidence
-&gt; CtLoc -&gt; DictMap CtEvidence -&gt; TcPredType -&gt; MaybeT TcS MaybeNew
</span><a href="#local-6989586621681975884"><span class="hs-identifier hs-var hs-var">new_wanted_cached</span></a></span></span><span> </span><span id="local-6989586621681975893"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975893"><span class="hs-identifier hs-var">ev_w</span></a></span></span><span> </span><span id="local-6989586621681975894"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975894"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621681975895"><span class="annot"><span class="annottext">DictMap CtEvidence
</span><a href="#local-6989586621681975895"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span id="local-6989586621681975896"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975896"><span class="hs-identifier hs-var">pty</span></a></span></span><span>
</span><span id="line-1143"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#ClassPred"><span class="hs-identifier hs-type">ClassPred</span></a></span><span> </span><span id="local-6989586621681975897"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975897"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621681975898"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975898"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975896"><span class="hs-identifier hs-var">pty</span></a></span><span>
</span><span id="line-1144"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcS MaybeNew -&gt; MaybeT TcS MaybeNew
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; MaybeT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS MaybeNew -&gt; MaybeT TcS MaybeNew)
-&gt; TcS MaybeNew -&gt; MaybeT TcS MaybeNew
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DictMap CtEvidence
-&gt; CtLoc -&gt; Class -&gt; [TcPredType] -&gt; Maybe CtEvidence
forall a. DictMap a -&gt; CtLoc -&gt; Class -&gt; [TcPredType] -&gt; Maybe a
</span><a href="GHC.Tc.Solver.Types.html#findDict"><span class="hs-identifier hs-var">findDict</span></a></span><span> </span><span class="annot"><span class="annottext">DictMap CtEvidence
</span><a href="#local-6989586621681975895"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975856"><span class="hs-identifier hs-var">loc_w</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975897"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975898"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1145"></span><span>          </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681975900"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975900"><span class="hs-identifier hs-var">ctev</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaybeNew -&gt; TcS MaybeNew
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeNew -&gt; TcS MaybeNew) -&gt; MaybeNew -&gt; TcS MaybeNew
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">EvExpr -&gt; MaybeNew
</span><a href="GHC.Tc.Solver.Monad.html#Cached"><span class="hs-identifier hs-var">Cached</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CtEvidence -&gt; EvExpr
CtEvidence -&gt; EvExpr
</span><a href="GHC.Tc.Types.Constraint.html#ctEvExpr"><span class="hs-identifier hs-var">ctEvExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975900"><span class="hs-identifier hs-var">ctev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1146"></span><span>          </span><span class="annot"><span class="annottext">Maybe CtEvidence
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; MaybeNew
</span><a href="GHC.Tc.Solver.Monad.html#Fresh"><span class="hs-identifier hs-var">Fresh</span></a></span><span> </span><span class="annot"><span class="annottext">(CtEvidence -&gt; MaybeNew) -&gt; TcS CtEvidence -&gt; TcS MaybeNew
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.2.1/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; RewriterSet -&gt; TcPredType -&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Monad.html#newWantedNC"><span class="hs-identifier hs-var">newWantedNC</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975894"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#ctEvRewriters"><span class="hs-identifier hs-var">ctEvRewriters</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975893"><span class="hs-identifier hs-var">ev_w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975896"><span class="hs-identifier hs-var">pty</span></a></span><span>
</span><span id="line-1147"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MaybeT TcS MaybeNew
forall a. MaybeT TcS a
forall (m :: * -&gt; *) a. MonadPlus m =&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#mzero/GHC.Base.html#mzero"><span class="hs-identifier hs-var">mzero</span></a></span><span>
</span><span id="line-1148"></span><span>
</span><span id="line-1149"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#addFunDepWork"><span class="hs-identifier hs-type">addFunDepWork</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1150"></span><span class="hs-comment">-- Add wanted constraints from type-class functional dependencies.</span><span>
</span><span id="line-1151"></span><span id="addFunDepWork"><span class="annot"><span class="annottext">addFunDepWork :: InertCans -&gt; CtEvidence -&gt; Class -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#addFunDepWork"><span class="hs-identifier hs-var hs-var">addFunDepWork</span></a></span></span><span> </span><span id="local-6989586621681975907"><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975907"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span id="local-6989586621681975908"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975908"><span class="hs-identifier hs-var">work_ev</span></a></span></span><span> </span><span id="local-6989586621681975909"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975909"><span class="hs-identifier hs-var">cls</span></a></span></span><span>
</span><span id="line-1152"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; TcS ()) -&gt; Cts -&gt; TcS ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; Bag a -&gt; m ()
</span><a href="GHC.Data.Bag.html#mapBagM_"><span class="hs-identifier hs-var">mapBagM_</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; TcS ()
</span><a href="#local-6989586621681975911"><span class="hs-identifier hs-var">add_fds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DictMap Ct -&gt; Class -&gt; Cts
forall a. DictMap a -&gt; Class -&gt; Bag a
</span><a href="GHC.Tc.Solver.Types.html#findDictsByClass"><span class="hs-identifier hs-var">findDictsByClass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InertCans -&gt; DictMap Ct
</span><a href="GHC.Tc.Solver.InertSet.html#inert_dicts"><span class="hs-identifier hs-var">inert_dicts</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975907"><span class="hs-identifier hs-var">inerts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975909"><span class="hs-identifier hs-var">cls</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1153"></span><span>               </span><span class="hs-comment">-- No need to check flavour; fundeps work between</span><span>
</span><span id="line-1154"></span><span>               </span><span class="hs-comment">-- any pair of constraints, regardless of flavour</span><span>
</span><span id="line-1155"></span><span>               </span><span class="hs-comment">-- Importantly we don't throw workitem back in the</span><span>
</span><span id="line-1156"></span><span>               </span><span class="hs-comment">-- worklist because this can cause loops (see #5236)</span><span>
</span><span id="line-1157"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1158"></span><span>    </span><span id="local-6989586621681975914"><span class="annot"><span class="annottext">work_pred :: TcPredType
</span><a href="#local-6989586621681975914"><span class="hs-identifier hs-var hs-var">work_pred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975908"><span class="hs-identifier hs-var">work_ev</span></a></span><span>
</span><span id="line-1159"></span><span>    </span><span id="local-6989586621681975915"><span class="annot"><span class="annottext">work_loc :: CtLoc
</span><a href="#local-6989586621681975915"><span class="hs-identifier hs-var hs-var">work_loc</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975908"><span class="hs-identifier hs-var">work_ev</span></a></span><span>
</span><span id="line-1160"></span><span>
</span><span id="line-1161"></span><span>    </span><span id="local-6989586621681975911"><span class="annot"><span class="annottext">add_fds :: Ct -&gt; TcS ()
</span><a href="#local-6989586621681975911"><span class="hs-identifier hs-var hs-var">add_fds</span></a></span></span><span> </span><span id="local-6989586621681975916"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975916"><span class="hs-identifier hs-var">inert_ct</span></a></span></span><span>
</span><span id="line-1162"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;addFunDepWork&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-1163"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975908"><span class="hs-identifier hs-var">work_ev</span></a></span><span>
</span><span id="line-1164"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; SDoc
</span><a href="GHC.Tc.Types.Constraint.html#pprCtLoc"><span class="hs-identifier hs-var">pprCtLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975915"><span class="hs-identifier hs-var">work_loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGivenLoc"><span class="hs-identifier hs-var">isGivenLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975915"><span class="hs-identifier hs-var">work_loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1165"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; SDoc
</span><a href="GHC.Tc.Types.Constraint.html#pprCtLoc"><span class="hs-identifier hs-var">pprCtLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975919"><span class="hs-identifier hs-var">inert_loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGivenLoc"><span class="hs-identifier hs-var">isGivenLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975919"><span class="hs-identifier hs-var">inert_loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1166"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; SDoc
</span><a href="GHC.Tc.Types.Constraint.html#pprCtLoc"><span class="hs-identifier hs-var">pprCtLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975920"><span class="hs-identifier hs-var">derived_loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGivenLoc"><span class="hs-identifier hs-var">isGivenLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975920"><span class="hs-identifier hs-var">derived_loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1167"></span><span>
</span><span id="line-1168"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS () -&gt; TcS ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../base-4.18.2.1/src/Control.Monad.html#unless/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975908"><span class="hs-identifier hs-var">work_ev</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975922"><span class="hs-identifier hs-var">inert_ev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcS () -&gt; TcS ()) -&gt; TcS () -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1169"></span><span>             </span><span class="annot"><span class="annottext">RewriterSet -&gt; [FunDepEqn (CtLoc, RewriterSet)] -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#emitFunDepWanteds"><span class="hs-identifier hs-var">emitFunDepWanteds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#ctEvRewriters"><span class="hs-identifier hs-var">ctEvRewriters</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975908"><span class="hs-identifier hs-var">work_ev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([FunDepEqn (CtLoc, RewriterSet)] -&gt; TcS ())
-&gt; [FunDepEqn (CtLoc, RewriterSet)] -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1170"></span><span>             </span><span class="annot"><span class="annottext">(CtLoc, RewriterSet)
-&gt; TcPredType -&gt; TcPredType -&gt; [FunDepEqn (CtLoc, RewriterSet)]
forall loc. loc -&gt; TcPredType -&gt; TcPredType -&gt; [FunDepEqn loc]
</span><a href="GHC.Tc.Instance.FunDeps.html#improveFromAnother"><span class="hs-identifier hs-var">improveFromAnother</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975920"><span class="hs-identifier hs-var">derived_loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621681975925"><span class="hs-identifier hs-var">inert_rewriters</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975926"><span class="hs-identifier hs-var">inert_pred</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975914"><span class="hs-identifier hs-var">work_pred</span></a></span><span>
</span><span id="line-1171"></span><span>               </span><span class="hs-comment">-- We don't really rewrite tys2, see below _rewritten_tys2, so that's ok</span><span>
</span><span id="line-1172"></span><span>               </span><span class="hs-comment">-- Do not create FDs from Given/Given interactions: See Note [No Given/Given fundeps]</span><span>
</span><span id="line-1173"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1174"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1175"></span><span>        </span><span id="local-6989586621681975922"><span class="annot"><span class="annottext">inert_ev :: CtEvidence
</span><a href="#local-6989586621681975922"><span class="hs-identifier hs-var hs-var">inert_ev</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975916"><span class="hs-identifier hs-var">inert_ct</span></a></span><span>
</span><span id="line-1176"></span><span>        </span><span id="local-6989586621681975926"><span class="annot"><span class="annottext">inert_pred :: TcPredType
</span><a href="#local-6989586621681975926"><span class="hs-identifier hs-var hs-var">inert_pred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975922"><span class="hs-identifier hs-var">inert_ev</span></a></span><span>
</span><span id="line-1177"></span><span>        </span><span id="local-6989586621681975919"><span class="annot"><span class="annottext">inert_loc :: CtLoc
</span><a href="#local-6989586621681975919"><span class="hs-identifier hs-var hs-var">inert_loc</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975922"><span class="hs-identifier hs-var">inert_ev</span></a></span><span>
</span><span id="line-1178"></span><span>        </span><span id="local-6989586621681975925"><span class="annot"><span class="annottext">inert_rewriters :: RewriterSet
</span><a href="#local-6989586621681975925"><span class="hs-identifier hs-var hs-var">inert_rewriters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#ctRewriters"><span class="hs-identifier hs-var">ctRewriters</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975916"><span class="hs-identifier hs-var">inert_ct</span></a></span><span>
</span><span id="line-1179"></span><span>        </span><span id="local-6989586621681975920"><span class="annot"><span class="annottext">derived_loc :: CtLoc
</span><a href="#local-6989586621681975920"><span class="hs-identifier hs-var hs-var">derived_loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975915"><span class="hs-identifier hs-var">work_loc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctl_depth"><span class="hs-identifier hs-var">ctl_depth</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctl_depth"><span class="hs-identifier hs-var">ctl_depth</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975915"><span class="hs-identifier hs-type">work_loc</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#maxSubGoalDepth"><span class="hs-operator hs-type">`maxSubGoalDepth`</span></a></span><span>
</span><span id="line-1180"></span><span>                                              </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctl_depth"><span class="hs-identifier hs-var">ctl_depth</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975919"><span class="hs-identifier hs-type">inert_loc</span></a></span><span>
</span><span id="line-1181"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctl_origin"><span class="hs-identifier hs-var">ctl_origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FunDepOrigin1"><span class="hs-identifier hs-type">FunDepOrigin1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975914"><span class="hs-identifier hs-type">work_pred</span></a></span><span>
</span><span id="line-1182"></span><span>                                                            </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctLocOrigin"><span class="hs-identifier hs-type">ctLocOrigin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975915"><span class="hs-identifier hs-type">work_loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1183"></span><span>                                                            </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctLocSpan"><span class="hs-identifier hs-type">ctLocSpan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975915"><span class="hs-identifier hs-type">work_loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1184"></span><span>                                                            </span><span class="annot"><a href="#local-6989586621681975926"><span class="hs-identifier hs-type">inert_pred</span></a></span><span>
</span><span id="line-1185"></span><span>                                                            </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctLocOrigin"><span class="hs-identifier hs-type">ctLocOrigin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975919"><span class="hs-identifier hs-type">inert_loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1186"></span><span>                                                            </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctLocSpan"><span class="hs-identifier hs-type">ctLocSpan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975919"><span class="hs-identifier hs-type">inert_loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1187"></span><span>
</span><span id="line-1188"></span><span class="hs-comment">{-
**********************************************************************
*                                                                    *
                   Implicit parameters
*                                                                    *
**********************************************************************
-}</span><span>
</span><span id="line-1195"></span><span>
</span><span id="line-1196"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#interactGivenIP"><span class="hs-identifier hs-type">interactGivenIP</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1197"></span><span class="hs-comment">-- Work item is Given (?x:ty)</span><span>
</span><span id="line-1198"></span><span class="hs-comment">-- See Note [Shadowing of Implicit Parameters]</span><span>
</span><span id="line-1199"></span><span id="interactGivenIP"><span class="annot"><span class="annottext">interactGivenIP :: InertCans -&gt; SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#interactGivenIP"><span class="hs-identifier hs-var hs-var">interactGivenIP</span></a></span></span><span> </span><span id="local-6989586621681975932"><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975932"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span id="local-6989586621681975933"><span class="annot"><span class="annottext">workItem :: Ct
</span><a href="#local-6989586621681975933"><span class="hs-identifier hs-var">workItem</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CDictCan"><span class="hs-identifier hs-type">CDictCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975934"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975934"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_class :: Ct -&gt; Class
</span><a href="GHC.Tc.Types.Constraint.html#cc_class"><span class="hs-identifier hs-var">cc_class</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975935"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975935"><span class="hs-identifier hs-var">cls</span></a></span></span><span>
</span><span id="line-1200"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_tyargs :: Ct -&gt; [TcPredType]
</span><a href="GHC.Tc.Types.Constraint.html#cc_tyargs"><span class="hs-identifier hs-var">cc_tyargs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975936"><span class="annot"><span class="annottext">tys :: [TcPredType]
</span><a href="#local-6989586621681975936"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621681975937"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975937"><span class="hs-identifier hs-var">ip_str</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[TcPredType]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1201"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">(InertCans -&gt; InertCans) -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#updInertCans"><span class="hs-identifier hs-var">updInertCans</span></a></span><span> </span><span class="annot"><span class="annottext">((InertCans -&gt; InertCans) -&gt; TcS ())
-&gt; (InertCans -&gt; InertCans) -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681975938"><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975938"><span class="hs-identifier hs-var">cans</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975938"><span class="hs-identifier hs-var">cans</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#inert_dicts"><span class="hs-identifier hs-var">inert_dicts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Types.html#addDict"><span class="hs-identifier hs-type">addDict</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975939"><span class="hs-identifier hs-type">filtered_dicts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975935"><span class="hs-identifier hs-type">cls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975936"><span class="hs-identifier hs-type">tys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975933"><span class="hs-identifier hs-type">workItem</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1202"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; String -&gt; TcS (StopOrContinue Ct)
forall a. CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975934"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Given IP&quot;</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1203"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1204"></span><span>    </span><span id="local-6989586621681975940"><span class="annot"><span class="annottext">dicts :: DictMap Ct
</span><a href="#local-6989586621681975940"><span class="hs-identifier hs-var hs-var">dicts</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; DictMap Ct
</span><a href="GHC.Tc.Solver.InertSet.html#inert_dicts"><span class="hs-identifier hs-var">inert_dicts</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975932"><span class="hs-identifier hs-var">inerts</span></a></span><span>
</span><span id="line-1205"></span><span>    </span><span id="local-6989586621681975941"><span class="annot"><span class="annottext">ip_dicts :: Cts
</span><a href="#local-6989586621681975941"><span class="hs-identifier hs-var hs-var">ip_dicts</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DictMap Ct -&gt; Class -&gt; Cts
forall a. DictMap a -&gt; Class -&gt; Bag a
</span><a href="GHC.Tc.Solver.Types.html#findDictsByClass"><span class="hs-identifier hs-var">findDictsByClass</span></a></span><span> </span><span class="annot"><span class="annottext">DictMap Ct
</span><a href="#local-6989586621681975940"><span class="hs-identifier hs-var">dicts</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975935"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-1206"></span><span>    </span><span id="local-6989586621681975942"><span class="annot"><span class="annottext">other_ip_dicts :: Cts
</span><a href="#local-6989586621681975942"><span class="hs-identifier hs-var hs-var">other_ip_dicts</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; Bool) -&gt; Cts -&gt; Cts
forall a. (a -&gt; Bool) -&gt; Bag a -&gt; Bag a
</span><a href="GHC.Data.Bag.html#filterBag"><span class="hs-identifier hs-var">filterBag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Ct -&gt; Bool) -&gt; Ct -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Bool
</span><a href="#local-6989586621681975945"><span class="hs-identifier hs-var">is_this_ip</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975941"><span class="hs-identifier hs-var">ip_dicts</span></a></span><span>
</span><span id="line-1207"></span><span>    </span><span id="local-6989586621681975939"><span class="annot"><span class="annottext">filtered_dicts :: DictMap Ct
</span><a href="#local-6989586621681975939"><span class="hs-identifier hs-var hs-var">filtered_dicts</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DictMap Ct -&gt; Class -&gt; Cts -&gt; DictMap Ct
</span><a href="GHC.Tc.Solver.Types.html#addDictsByClass"><span class="hs-identifier hs-var">addDictsByClass</span></a></span><span> </span><span class="annot"><span class="annottext">DictMap Ct
</span><a href="#local-6989586621681975940"><span class="hs-identifier hs-var">dicts</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681975935"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621681975942"><span class="hs-identifier hs-var">other_ip_dicts</span></a></span><span>
</span><span id="line-1208"></span><span>
</span><span id="line-1209"></span><span>    </span><span class="hs-comment">-- Pick out any Given constraints for the same implicit parameter</span><span>
</span><span id="line-1210"></span><span>    </span><span id="local-6989586621681975945"><span class="annot"><span class="annottext">is_this_ip :: Ct -&gt; Bool
</span><a href="#local-6989586621681975945"><span class="hs-identifier hs-var hs-var">is_this_ip</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CDictCan"><span class="hs-identifier hs-type">CDictCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975947"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975947"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_tyargs :: Ct -&gt; [TcPredType]
</span><a href="GHC.Tc.Types.Constraint.html#cc_tyargs"><span class="hs-identifier hs-var">cc_tyargs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975948"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975948"><span class="hs-identifier hs-var">ip_str'</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[TcPredType]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1211"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975947"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975937"><span class="hs-identifier hs-var">ip_str</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; TcPredType -&gt; TcPredType -&gt; Bool
TcPredType -&gt; TcPredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975948"><span class="hs-identifier hs-var">ip_str'</span></a></span><span>
</span><span id="line-1212"></span><span>    </span><span class="annot"><a href="#local-6989586621681975945"><span class="hs-identifier hs-var">is_this_ip</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1213"></span><span>
</span><span id="line-1214"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#interactGivenIP"><span class="hs-identifier hs-var">interactGivenIP</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681975949"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975949"><span class="hs-identifier hs-var">wi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS (StopOrContinue Ct)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interactGivenIP&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975949"><span class="hs-identifier hs-var">wi</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1215"></span><span>
</span><span id="line-1216"></span><span class="hs-comment">{- Note [Shadowing of Implicit Parameters]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following example:

f :: (?x :: Char) =&gt; Char
f = let ?x = 'a' in ?x

The &quot;let ?x = ...&quot; generates an implication constraint of the form:

?x :: Char =&gt; ?x :: Char

Furthermore, the signature for `f` also generates an implication
constraint, so we end up with the following nested implication:

?x :: Char =&gt; (?x :: Char =&gt; ?x :: Char)

Note that the wanted (?x :: Char) constraint may be solved in
two incompatible ways:  either by using the parameter from the
signature, or by using the local definition.  Our intention is
that the local definition should &quot;shadow&quot; the parameter of the
signature, and we implement this as follows: when we add a new
*given* implicit parameter to the inert set, it replaces any existing
givens for the same implicit parameter.

Similarly, consider
   f :: (?x::a) =&gt; Bool -&gt; a

   g v = let ?x::Int = 3
         in (f v, let ?x::Bool = True in f v)

This should probably be well typed, with
   g :: Bool -&gt; (Int, Bool)

So the inner binding for ?x::Bool *overrides* the outer one.

See ticket #17104 for a rather tricky example of this overriding
behaviour.

All this works for the normal cases but it has an odd side effect in
some pathological programs like this:
-- This is accepted, the second parameter shadows
f1 :: (?x :: Int, ?x :: Char) =&gt; Char
f1 = ?x

-- This is rejected, the second parameter shadows
f2 :: (?x :: Int, ?x :: Char) =&gt; Int
f2 = ?x

Both of these are actually wrong:  when we try to use either one,
we'll get two incompatible wanted constraints (?x :: Int, ?x :: Char),
which would lead to an error.

I can think of two ways to fix this:

  1. Simply disallow multiple constraints for the same implicit
    parameter---this is never useful, and it can be detected completely
    syntactically.

  2. Move the shadowing machinery to the location where we nest
     implications, and add some code here that will produce an
     error if we get multiple givens for the same implicit parameter.


**********************************************************************
*                                                                    *
                   interactFunEq
*                                                                    *
**********************************************************************
-}</span><span>
</span><span id="line-1285"></span><span>
</span><span id="line-1286"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#improveLocalFunEqs"><span class="hs-identifier hs-type">improveLocalFunEqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-1287"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1288"></span><span class="hs-comment">-- Generate improvement equalities, by comparing</span><span>
</span><span id="line-1289"></span><span class="hs-comment">-- the current work item with inert CFunEqs</span><span>
</span><span id="line-1290"></span><span class="hs-comment">-- E.g.   x + y ~ z,   x + y' ~ z   =&gt;   [W] y ~ y'</span><span>
</span><span id="line-1291"></span><span class="hs-comment">--</span><span>
</span><span id="line-1292"></span><span class="hs-comment">-- See Note [FunDep and implicit parameter reactions]</span><span>
</span><span id="line-1293"></span><span id="improveLocalFunEqs"><span class="annot"><span class="annottext">improveLocalFunEqs :: CtEvidence
-&gt; InertCans -&gt; TyCon -&gt; [TcPredType] -&gt; TcPredType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#improveLocalFunEqs"><span class="hs-identifier hs-var hs-var">improveLocalFunEqs</span></a></span></span><span> </span><span id="local-6989586621681975952"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975952"><span class="hs-identifier hs-var">work_ev</span></a></span></span><span> </span><span id="local-6989586621681975953"><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975953"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span id="local-6989586621681975954"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681975954"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621681975955"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975955"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681975956"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975956"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1294"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS () -&gt; TcS ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../base-4.18.2.1/src/Control.Monad.html#unless/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681975957"><span class="hs-identifier hs-var">improvement_eqns</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TcS () -&gt; TcS ()) -&gt; TcS () -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1295"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interactFunEq improvements: &quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1296"></span><span>                   </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Eqns:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681975957"><span class="hs-identifier hs-var">improvement_eqns</span></a></span><span>
</span><span id="line-1297"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Candidates:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975958"><span class="hs-identifier hs-var">funeqs_for_tc</span></a></span><span>
</span><span id="line-1298"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Inert eqs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">InertEqs -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InertCans -&gt; InertEqs
</span><a href="GHC.Tc.Solver.InertSet.html#inert_eqs"><span class="hs-identifier hs-var">inert_eqs</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975953"><span class="hs-identifier hs-var">inerts</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1299"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">RewriterSet -&gt; [FunDepEqn (CtLoc, RewriterSet)] -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#emitFunDepWanteds"><span class="hs-identifier hs-var">emitFunDepWanteds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#ctEvRewriters"><span class="hs-identifier hs-var">ctEvRewriters</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975952"><span class="hs-identifier hs-var">work_ev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681975957"><span class="hs-identifier hs-var">improvement_eqns</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1300"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1301"></span><span>    </span><span id="local-6989586621681975960"><span class="annot"><span class="annottext">funeqs :: FunEqMap [Ct]
</span><a href="#local-6989586621681975960"><span class="hs-identifier hs-var hs-var">funeqs</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; FunEqMap [Ct]
</span><a href="GHC.Tc.Solver.InertSet.html#inert_funeqs"><span class="hs-identifier hs-var">inert_funeqs</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681975953"><span class="hs-identifier hs-var">inerts</span></a></span><span>
</span><span id="line-1302"></span><span>    </span><span id="local-6989586621681975958"><span class="annot"><span class="annottext">funeqs_for_tc :: [Ct]
</span><a href="#local-6989586621681975958"><span class="hs-identifier hs-var hs-var">funeqs_for_tc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975962"><span class="hs-identifier hs-var">funeq_ct</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681975963"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975963"><span class="hs-identifier hs-var">equal_ct_list</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FunEqMap [Ct] -&gt; TyCon -&gt; [[Ct]]
forall a. FunEqMap a -&gt; TyCon -&gt; [a]
</span><a href="GHC.Tc.Solver.Types.html#findFunEqsByTyCon"><span class="hs-identifier hs-var">findFunEqsByTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">FunEqMap [Ct]
</span><a href="#local-6989586621681975960"><span class="hs-identifier hs-var">funeqs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681975954"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-1303"></span><span>                               </span><span class="hs-special">,</span><span> </span><span id="local-6989586621681975962"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975962"><span class="hs-identifier hs-var">funeq_ct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975963"><span class="hs-identifier hs-var">equal_ct_list</span></a></span><span>
</span><span id="line-1304"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; EqRel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#ctEqRel"><span class="hs-identifier hs-var">ctEqRel</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681975962"><span class="hs-identifier hs-var">funeq_ct</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1305"></span><span>                                  </span><span class="hs-comment">-- representational equalities don't interact</span><span>
</span><span id="line-1306"></span><span>                                  </span><span class="hs-comment">-- with type family dependencies</span><span>
</span><span id="line-1307"></span><span>    </span><span id="local-6989586621681975967"><span class="annot"><span class="annottext">work_loc :: CtLoc
</span><a href="#local-6989586621681975967"><span class="hs-identifier hs-var hs-var">work_loc</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975952"><span class="hs-identifier hs-var">work_ev</span></a></span><span>
</span><span id="line-1308"></span><span>    </span><span id="local-6989586621681975968"><span class="annot"><span class="annottext">work_pred :: TcPredType
</span><a href="#local-6989586621681975968"><span class="hs-identifier hs-var hs-var">work_pred</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975952"><span class="hs-identifier hs-var">work_ev</span></a></span><span>
</span><span id="line-1309"></span><span>    </span><span id="local-6989586621681975969"><span class="annot"><span class="annottext">fam_inj_info :: Injectivity
</span><a href="#local-6989586621681975969"><span class="hs-identifier hs-var hs-var">fam_inj_info</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Injectivity
</span><a href="GHC.Core.TyCon.html#tyConInjectivityInfo"><span class="hs-identifier hs-var">tyConInjectivityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681975954"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-1310"></span><span>
</span><span id="line-1311"></span><span>    </span><span class="hs-comment">--------------------</span><span>
</span><span id="line-1312"></span><span>    </span><span class="annot"><a href="#local-6989586621681975957"><span class="hs-identifier hs-type">improvement_eqns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html#FunDepEqn"><span class="hs-identifier hs-type">FunDepEqn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1313"></span><span>    </span><span id="local-6989586621681975957"><span class="annot"><span class="annottext">improvement_eqns :: [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681975957"><span class="hs-identifier hs-var hs-var">improvement_eqns</span></a></span></span><span>
</span><span id="line-1314"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681975971"><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621681975971"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe BuiltInSynFamily
</span><a href="GHC.Core.TyCon.html#isBuiltInSynFamTyCon_maybe"><span class="hs-identifier hs-var">isBuiltInSynFamTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681975954"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-1315"></span><span>      </span><span class="hs-glyph">=</span><span>    </span><span class="hs-comment">-- Try built-in families, notably for arithmethic</span><span>
</span><span id="line-1316"></span><span>        </span><span class="annot"><span class="annottext">(Ct -&gt; [FunDepEqn (CtLoc, RewriterSet)])
-&gt; [Ct] -&gt; [FunDepEqn (CtLoc, RewriterSet)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#concatMap/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuiltInSynFamily
-&gt; TcPredType -&gt; Ct -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681975974"><span class="hs-identifier hs-var">do_one_built_in</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621681975971"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975956"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975958"><span class="hs-identifier hs-var">funeqs_for_tc</span></a></span><span>
</span><span id="line-1317"></span><span>
</span><span id="line-1318"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#Injective"><span class="hs-identifier hs-type">Injective</span></a></span><span> </span><span id="local-6989586621681975976"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681975976"><span class="hs-identifier hs-var">injective_args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Injectivity
</span><a href="#local-6989586621681975969"><span class="hs-identifier hs-var">fam_inj_info</span></a></span><span>
</span><span id="line-1319"></span><span>      </span><span class="hs-glyph">=</span><span>    </span><span class="hs-comment">-- Try improvement from type families with injectivity annotations</span><span>
</span><span id="line-1320"></span><span>        </span><span class="annot"><span class="annottext">(Ct -&gt; [FunDepEqn (CtLoc, RewriterSet)])
-&gt; [Ct] -&gt; [FunDepEqn (CtLoc, RewriterSet)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#concatMap/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Bool] -&gt; TcPredType -&gt; Ct -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681975977"><span class="hs-identifier hs-var">do_one_injective</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681975976"><span class="hs-identifier hs-var">injective_args</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975956"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621681975958"><span class="hs-identifier hs-var">funeqs_for_tc</span></a></span><span>
</span><span id="line-1321"></span><span>
</span><span id="line-1322"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1323"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1324"></span><span>
</span><span id="line-1325"></span><span>    </span><span class="hs-comment">--------------------</span><span>
</span><span id="line-1326"></span><span>    </span><span id="local-6989586621681975974"><span class="annot"><span class="annottext">do_one_built_in :: BuiltInSynFamily
-&gt; TcPredType -&gt; Ct -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681975974"><span class="hs-identifier hs-var hs-var">do_one_built_in</span></a></span></span><span> </span><span id="local-6989586621681975978"><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621681975978"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621681975979"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975979"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CEqCan"><span class="hs-identifier hs-type">CEqCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_lhs :: Ct -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#cc_lhs"><span class="hs-identifier hs-var">cc_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681975982"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975982"><span class="hs-identifier hs-var">iargs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_rhs :: Ct -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#cc_rhs"><span class="hs-identifier hs-var">cc_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975984"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975984"><span class="hs-identifier hs-var">irhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975985"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975985"><span class="hs-identifier hs-var">inert_ev</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1327"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975985"><span class="hs-identifier hs-var">inert_ev</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975952"><span class="hs-identifier hs-var">work_ev</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [No Given/Given fundeps]</span><span>
</span><span id="line-1328"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; [TypeEqn] -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681975986"><span class="hs-identifier hs-var">mk_fd_eqns</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975985"><span class="hs-identifier hs-var">inert_ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuiltInSynFamily
-&gt; [TcPredType]
-&gt; TcPredType
-&gt; [TcPredType]
-&gt; TcPredType
-&gt; [TypeEqn]
</span><a href="GHC.Core.Coercion.Axiom.html#sfInteractInert"><span class="hs-identifier hs-var">sfInteractInert</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621681975978"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975955"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975979"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975982"><span class="hs-identifier hs-var">iargs</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975984"><span class="hs-identifier hs-var">irhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1329"></span><span>
</span><span id="line-1330"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1331"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1332"></span><span>
</span><span id="line-1333"></span><span>    </span><span class="annot"><a href="#local-6989586621681975974"><span class="hs-identifier hs-var">do_one_built_in</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ct
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; [FunDepEqn (CtLoc, RewriterSet)]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interactFunEq 1&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681975954"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1334"></span><span>
</span><span id="line-1335"></span><span>    </span><span class="hs-comment">--------------------</span><span>
</span><span id="line-1336"></span><span>    </span><span class="hs-comment">-- See Note [Type inference for type families with injectivity]</span><span>
</span><span id="line-1337"></span><span>    </span><span id="local-6989586621681975977"><span class="annot"><span class="annottext">do_one_injective :: [Bool] -&gt; TcPredType -&gt; Ct -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681975977"><span class="hs-identifier hs-var hs-var">do_one_injective</span></a></span></span><span> </span><span id="local-6989586621681975987"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681975987"><span class="hs-identifier hs-var">inj_args</span></a></span></span><span> </span><span id="local-6989586621681975988"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975988"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CEqCan"><span class="hs-identifier hs-type">CEqCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_lhs :: Ct -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#cc_lhs"><span class="hs-identifier hs-var">cc_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681975989"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975989"><span class="hs-identifier hs-var">inert_args</span></a></span></span><span>
</span><span id="line-1338"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_rhs :: Ct -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#cc_rhs"><span class="hs-identifier hs-var">cc_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975990"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975990"><span class="hs-identifier hs-var">irhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681975991"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975991"><span class="hs-identifier hs-var">inert_ev</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1339"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975991"><span class="hs-identifier hs-var">inert_ev</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975952"><span class="hs-identifier hs-var">work_ev</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [No Given/Given fundeps]</span><span>
</span><span id="line-1340"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975988"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; TcPredType -&gt; TcPredType -&gt; Bool
TcPredType -&gt; TcPredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975990"><span class="hs-identifier hs-var">irhs</span></a></span><span>
</span><span id="line-1341"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; [TypeEqn] -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681975986"><span class="hs-identifier hs-var">mk_fd_eqns</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975991"><span class="hs-identifier hs-var">inert_ev</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeEqn] -&gt; [FunDepEqn (CtLoc, RewriterSet)])
-&gt; [TypeEqn] -&gt; [FunDepEqn (CtLoc, RewriterSet)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; TcPredType -&gt; TypeEqn
forall a. a -&gt; a -&gt; Pair a
</span><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975993"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975994"><span class="hs-identifier hs-var">iarg</span></a></span><span>
</span><span id="line-1342"></span><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681975993"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975993"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681975994"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975994"><span class="hs-identifier hs-var">iarg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcPredType]
-&gt; [TcPredType] -&gt; [Bool] -&gt; [(TcPredType, TcPredType, Bool)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#zip3/GHC.List.html#zip3"><span class="hs-identifier hs-var">zip3</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975955"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681975989"><span class="hs-identifier hs-var">inert_args</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681975987"><span class="hs-identifier hs-var">inj_args</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1343"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1344"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1345"></span><span>
</span><span id="line-1346"></span><span>    </span><span class="annot"><a href="#local-6989586621681975977"><span class="hs-identifier hs-var">do_one_injective</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ct
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; [FunDepEqn (CtLoc, RewriterSet)]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interactFunEq 2&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681975954"><span class="hs-identifier hs-var">fam_tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1347"></span><span>
</span><span id="line-1348"></span><span>    </span><span class="hs-comment">--------------------</span><span>
</span><span id="line-1349"></span><span>    </span><span class="annot"><a href="#local-6989586621681975986"><span class="hs-identifier hs-type">mk_fd_eqns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#TypeEqn"><span class="hs-identifier hs-type">TypeEqn</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html#FunDepEqn"><span class="hs-identifier hs-type">FunDepEqn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1350"></span><span>    </span><span id="local-6989586621681975986"><span class="annot"><span class="annottext">mk_fd_eqns :: CtEvidence -&gt; [TypeEqn] -&gt; [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681975986"><span class="hs-identifier hs-var hs-var">mk_fd_eqns</span></a></span></span><span> </span><span id="local-6989586621681975996"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975996"><span class="hs-identifier hs-var">inert_ev</span></a></span></span><span> </span><span id="local-6989586621681975997"><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621681975997"><span class="hs-identifier hs-var">eqns</span></a></span></span><span>
</span><span id="line-1351"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[TypeEqn] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621681975997"><span class="hs-identifier hs-var">eqns</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1352"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html#FDEqn"><span class="hs-identifier hs-type">FDEqn</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fd_qtvs :: [TyVar]
</span><a href="GHC.Tc.Instance.FunDeps.html#fd_qtvs"><span class="hs-identifier hs-var">fd_qtvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fd_eqs :: [TypeEqn]
</span><a href="GHC.Tc.Instance.FunDeps.html#fd_eqs"><span class="hs-identifier hs-var">fd_eqs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621681975997"><span class="hs-identifier hs-var">eqns</span></a></span><span>
</span><span id="line-1353"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fd_pred1 :: TcPredType
</span><a href="GHC.Tc.Instance.FunDeps.html#fd_pred1"><span class="hs-identifier hs-var">fd_pred1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975968"><span class="hs-identifier hs-var">work_pred</span></a></span><span>
</span><span id="line-1354"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fd_pred2 :: TcPredType
</span><a href="GHC.Tc.Instance.FunDeps.html#fd_pred2"><span class="hs-identifier hs-var">fd_pred2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976003"><span class="hs-identifier hs-var">inert_pred</span></a></span><span>
</span><span id="line-1355"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fd_loc :: (CtLoc, RewriterSet)
</span><a href="GHC.Tc.Instance.FunDeps.html#fd_loc"><span class="hs-identifier hs-var">fd_loc</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976005"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621681976006"><span class="hs-identifier hs-var">inert_rewriters</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1356"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1357"></span><span>        </span><span id="local-6989586621681976007"><span class="annot"><span class="annottext">initial_loc :: CtLoc
</span><a href="#local-6989586621681976007"><span class="hs-identifier hs-var hs-var">initial_loc</span></a></span></span><span>  </span><span class="hs-comment">-- start with the location of the Wanted involved</span><span>
</span><span id="line-1358"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975952"><span class="hs-identifier hs-var">work_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976008"><span class="hs-identifier hs-var">inert_loc</span></a></span><span>
</span><span id="line-1359"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975967"><span class="hs-identifier hs-var">work_loc</span></a></span><span>
</span><span id="line-1360"></span><span>        </span><span id="local-6989586621681976009"><span class="annot"><span class="annottext">eqn_orig :: CtOrigin
</span><a href="#local-6989586621681976009"><span class="hs-identifier hs-var hs-var">eqn_orig</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcPredType
-&gt; CtOrigin
-&gt; RealSrcSpan
-&gt; TcPredType
-&gt; CtOrigin
-&gt; RealSrcSpan
-&gt; CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#InjTFOrigin1"><span class="hs-identifier hs-var">InjTFOrigin1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681975968"><span class="hs-identifier hs-var">work_pred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Constraint.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975967"><span class="hs-identifier hs-var">work_loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; RealSrcSpan
</span><a href="GHC.Tc.Types.Constraint.html#ctLocSpan"><span class="hs-identifier hs-var">ctLocSpan</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681975967"><span class="hs-identifier hs-var">work_loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1361"></span><span>                                       </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976003"><span class="hs-identifier hs-var">inert_pred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Constraint.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976008"><span class="hs-identifier hs-var">inert_loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; RealSrcSpan
</span><a href="GHC.Tc.Types.Constraint.html#ctLocSpan"><span class="hs-identifier hs-var">ctLocSpan</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976008"><span class="hs-identifier hs-var">inert_loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1362"></span><span>        </span><span id="local-6989586621681976011"><span class="annot"><span class="annottext">eqn_loc :: CtLoc
</span><a href="#local-6989586621681976011"><span class="hs-identifier hs-var hs-var">eqn_loc</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#setCtLocOrigin"><span class="hs-identifier hs-var">setCtLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976007"><span class="hs-identifier hs-var">initial_loc</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621681976009"><span class="hs-identifier hs-var">eqn_orig</span></a></span><span>
</span><span id="line-1363"></span><span>        </span><span id="local-6989586621681976003"><span class="annot"><span class="annottext">inert_pred :: TcPredType
</span><a href="#local-6989586621681976003"><span class="hs-identifier hs-var hs-var">inert_pred</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975996"><span class="hs-identifier hs-var">inert_ev</span></a></span><span>
</span><span id="line-1364"></span><span>        </span><span id="local-6989586621681976008"><span class="annot"><span class="annottext">inert_loc :: CtLoc
</span><a href="#local-6989586621681976008"><span class="hs-identifier hs-var hs-var">inert_loc</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975996"><span class="hs-identifier hs-var">inert_ev</span></a></span><span>
</span><span id="line-1365"></span><span>        </span><span id="local-6989586621681976006"><span class="annot"><span class="annottext">inert_rewriters :: RewriterSet
</span><a href="#local-6989586621681976006"><span class="hs-identifier hs-var hs-var">inert_rewriters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#ctEvRewriters"><span class="hs-identifier hs-var">ctEvRewriters</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681975996"><span class="hs-identifier hs-var">inert_ev</span></a></span><span>
</span><span id="line-1366"></span><span>        </span><span id="local-6989586621681976005"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621681976005"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976011"><span class="hs-identifier hs-var">eqn_loc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctl_depth"><span class="hs-identifier hs-var">ctl_depth</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctl_depth"><span class="hs-identifier hs-var">ctl_depth</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681976008"><span class="hs-identifier hs-type">inert_loc</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#maxSubGoalDepth"><span class="hs-operator hs-type">`maxSubGoalDepth`</span></a></span><span>
</span><span id="line-1367"></span><span>                                    </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctl_depth"><span class="hs-identifier hs-var">ctl_depth</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681975967"><span class="hs-identifier hs-type">work_loc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1368"></span><span>
</span><span id="line-1369"></span><span class="hs-comment">{- Note [Type inference for type families with injectivity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have a type family with an injectivity annotation:
    type family F a b = r | r -&gt; b

Then if we have an equality like F s1 t1 ~ F s2 t2,
we can use the injectivity to get a new Wanted constraint on
the injective argument
  [W] t1 ~ t2

That in turn can help GHC solve constraints that would otherwise require
guessing.  For example, consider the ambiguity check for
   f :: F Int b -&gt; Int
We get the constraint
   [W] F Int b ~ F Int beta
where beta is a unification variable.  Injectivity lets us pick beta ~ b.

Injectivity information is also used at the call sites. For example:
   g = f True
gives rise to
   [W] F Int b ~ Bool
from which we can derive b.  This requires looking at the defining equations of
a type family, ie. finding equation with a matching RHS (Bool in this example)
and inferring values of type variables (b in this example) from the LHS patterns
of the matching equation.  For closed type families we have to perform
additional apartness check for the selected equation to check that the selected
is guaranteed to fire for given LHS arguments.

These new constraints are Wanted constraints, but we will not use the evidence.
We could go further and offer evidence from decomposing injective type-function
applications, but that would require new evidence forms, and an extension to
FC, so we don't do that right now (Dec 14).

We generate these Wanteds in three places, depending on how we notice the
injectivity.

1. When we have a [W] F tys1 ~ F tys2. This is handled in canEqCanLHS2, and
described in Note [Decomposing type family applications] in GHC.Tc.Solver.Canonical.

2. When we have [W] F tys1 ~ T and [W] F tys2 ~ T. Note that neither of these
constraints rewrites the other, as they have different LHSs. This is done
in improveLocalFunEqs, called during the interactWithInertsStage.

3. When we have [W] F tys ~ T and an equation for F that looks like F tys' = T.
This is done in improve_top_fun_eqs, called from the top-level reactions stage.

See also Note [Injective type families] in GHC.Core.TyCon

Note [Cache-caused loops]
~~~~~~~~~~~~~~~~~~~~~~~~~
It is very dangerous to cache a rewritten wanted family equation as 'solved' in our
solved cache (which is the default behaviour or xCtEvidence), because the interaction
may not be contributing towards a solution. Here is an example:

Initial inert set:
  [W] g1 : F a ~ beta1
Work item:
  [W] g2 : F a ~ beta2
The work item will react with the inert yielding the _same_ inert set plus:
    (i)   Will set g2 := g1 `cast` g3
    (ii)  Will add to our solved cache that [S] g2 : F a ~ beta2
    (iii) Will emit [W] g3 : beta1 ~ beta2
Now, the g3 work item will be spontaneously solved to [G] g3 : beta1 ~ beta2
and then it will react the item in the inert ([W] g1 : F a ~ beta1). So it
will set
      g1 := g ; sym g3
and what is g? Well it would ideally be a new goal of type (F a ~ beta2) but
remember that we have this in our solved cache, and it is ... g2! In short we
created the evidence loop:

        g2 := g1 ; g3
        g3 := refl
        g1 := g2 ; sym g3

To avoid this situation we do not cache as solved any workitems (or inert)
which did not really made a 'step' towards proving some goal. Solved's are
just an optimization so we don't lose anything in terms of completeness of
solving.

**********************************************************************
*                                                                    *
                   interactEq
*                                                                    *
**********************************************************************
-}</span><span>
</span><span id="line-1454"></span><span>
</span><span id="line-1455"></span><span class="hs-comment">{- Note [Combining equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have
   Inert:     g1 :: a ~ t
   Work item: g2 :: a ~ t

Then we can simply solve g2 from g1, thus g2 := g1.  Easy!
But it's not so simple:

* If t is a type variable, the equalties might be oriented differently:
      e.g. (g1 :: a~b) and (g2 :: b~a)
  So we look both ways round.  Hence the SwapFlag result to
  inertsCanDischarge.

* We can only do g2 := g1 if g1 can discharge g2; that depends on
  (a) the role and (b) the flavour.  E.g. a representational equality
  cannot discharge a nominal one; a Wanted cannot discharge a Given.
  The predicate is eqCanRewriteFR.

* Visibility. Suppose  S :: forall k. k -&gt; Type, and consider unifying
      S @Type (a::Type)  ~   S @(Type-&gt;Type) (b::Type-&gt;Type)
  From the first argument we get (Type ~ Type-&gt;Type); from the second
  argument we get (a ~ b) which in turn gives (Type ~ Type-&gt;Type).
  See typecheck/should_fail/T16204c.

  That first argument is invisible in the source program (aside from
  visible type application), so we'd much prefer to get the error from
  the second. We track visibility in the uo_visible field of a TypeEqOrigin.
  We use this to prioritise visible errors (see GHC.Tc.Errors.tryReporters,
  the partition on isVisibleOrigin).

  So when combining two otherwise-identical equalites, we want to
  keep the visible one, and discharge the invisible one.  Hence the
  call to strictly_more_visible.
-}</span><span>
</span><span id="line-1490"></span><span>
</span><span id="line-1491"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#inertsCanDischarge"><span class="hs-identifier hs-type">inertsCanDischarge</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span>
</span><span id="line-1492"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>  </span><span class="hs-comment">-- The evidence for the inert</span><span>
</span><span id="line-1493"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a></span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Whether we need mkSymCo</span><span>
</span><span id="line-1494"></span><span id="inertsCanDischarge"><span class="annot"><span class="annottext">inertsCanDischarge :: InertCans -&gt; Ct -&gt; Maybe (CtEvidence, SwapFlag)
</span><a href="GHC.Tc.Solver.Interact.html#inertsCanDischarge"><span class="hs-identifier hs-var hs-var">inertsCanDischarge</span></a></span></span><span> </span><span id="local-6989586621681976014"><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681976014"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CEqCan"><span class="hs-identifier hs-type">CEqCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_lhs :: Ct -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#cc_lhs"><span class="hs-identifier hs-var">cc_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976015"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621681976015"><span class="hs-identifier hs-var">lhs_w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_rhs :: Ct -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#cc_rhs"><span class="hs-identifier hs-var">cc_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976016"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976016"><span class="hs-identifier hs-var">rhs_w</span></a></span></span><span>
</span><span id="line-1495"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976017"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976017"><span class="hs-identifier hs-var">ev_w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_eq_rel :: Ct -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#cc_eq_rel"><span class="hs-identifier hs-var">cc_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976019"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976019"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1496"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976020"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976020"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[CtEvidence]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976021"><span class="hs-identifier hs-var">ev_i</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CEqCan"><span class="hs-identifier hs-type">CEqCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976021"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976021"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_rhs :: Ct -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#cc_rhs"><span class="hs-identifier hs-var">cc_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976022"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976022"><span class="hs-identifier hs-var">rhs_i</span></a></span></span><span>
</span><span id="line-1497"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_eq_rel :: Ct -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#cc_eq_rel"><span class="hs-identifier hs-var">cc_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976023"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976023"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1498"></span><span>                             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; CanEqLHS -&gt; [Ct]
</span><a href="GHC.Tc.Solver.InertSet.html#findEq"><span class="hs-identifier hs-var">findEq</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681976014"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621681976015"><span class="hs-identifier hs-var">lhs_w</span></a></span><span>
</span><span id="line-1499"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976022"><span class="hs-identifier hs-var">rhs_i</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; TcPredType -&gt; TcPredType -&gt; Bool
TcPredType -&gt; TcPredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976016"><span class="hs-identifier hs-var">rhs_w</span></a></span><span>
</span><span id="line-1500"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EqRel -&gt; Bool
</span><a href="#local-6989586621681976025"><span class="hs-identifier hs-var">inert_beats_wanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976021"><span class="hs-identifier hs-var">ev_i</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976023"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1501"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-comment">-- Inert:     a ~ ty</span><span>
</span><span id="line-1502"></span><span>     </span><span class="hs-comment">-- Work item: a ~ ty</span><span>
</span><span id="line-1503"></span><span>    </span><span class="annot"><span class="annottext">(CtEvidence, SwapFlag) -&gt; Maybe (CtEvidence, SwapFlag)
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976020"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1504"></span><span>
</span><span id="line-1505"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681976026"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621681976026"><span class="hs-identifier hs-var">rhs_lhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; Maybe CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHS_maybe"><span class="hs-identifier hs-var">canEqLHS_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976016"><span class="hs-identifier hs-var">rhs_w</span></a></span><span>
</span><span id="line-1506"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976028"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976028"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[CtEvidence]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976029"><span class="hs-identifier hs-var">ev_i</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CEqCan"><span class="hs-identifier hs-type">CEqCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976029"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976029"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_rhs :: Ct -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#cc_rhs"><span class="hs-identifier hs-var">cc_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976030"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976030"><span class="hs-identifier hs-var">rhs_i</span></a></span></span><span>
</span><span id="line-1507"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_eq_rel :: Ct -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#cc_eq_rel"><span class="hs-identifier hs-var">cc_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976031"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976031"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1508"></span><span>                             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; CanEqLHS -&gt; [Ct]
</span><a href="GHC.Tc.Solver.InertSet.html#findEq"><span class="hs-identifier hs-var">findEq</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681976014"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621681976026"><span class="hs-identifier hs-var">rhs_lhs</span></a></span><span>
</span><span id="line-1509"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976030"><span class="hs-identifier hs-var">rhs_i</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; TcPredType -&gt; TcPredType -&gt; Bool
TcPredType -&gt; TcPredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#canEqLHSType"><span class="hs-identifier hs-var">canEqLHSType</span></a></span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621681976015"><span class="hs-identifier hs-var">lhs_w</span></a></span><span>
</span><span id="line-1510"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EqRel -&gt; Bool
</span><a href="#local-6989586621681976025"><span class="hs-identifier hs-var">inert_beats_wanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976029"><span class="hs-identifier hs-var">ev_i</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976031"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1511"></span><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-comment">-- Inert:     a ~ b</span><span>
</span><span id="line-1512"></span><span>     </span><span class="hs-comment">-- Work item: b ~ a</span><span>
</span><span id="line-1513"></span><span>     </span><span class="annot"><span class="annottext">(CtEvidence, SwapFlag) -&gt; Maybe (CtEvidence, SwapFlag)
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976028"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1514"></span><span>
</span><span id="line-1515"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1516"></span><span>    </span><span id="local-6989586621681976033"><span class="annot"><span class="annottext">loc_w :: CtLoc
</span><a href="#local-6989586621681976033"><span class="hs-identifier hs-var hs-var">loc_w</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976017"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-1517"></span><span>    </span><span id="local-6989586621681976034"><span class="annot"><span class="annottext">flav_w :: CtFlavour
</span><a href="#local-6989586621681976034"><span class="hs-identifier hs-var hs-var">flav_w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#ctEvFlavour"><span class="hs-identifier hs-var">ctEvFlavour</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976017"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-1518"></span><span>    </span><span id="local-6989586621681976036"><span class="annot"><span class="annottext">fr_w :: (CtFlavour, EqRel)
</span><a href="#local-6989586621681976036"><span class="hs-identifier hs-var hs-var">fr_w</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtFlavour
</span><a href="#local-6989586621681976034"><span class="hs-identifier hs-var">flav_w</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976019"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1519"></span><span>
</span><span id="line-1520"></span><span>    </span><span id="local-6989586621681976025"><span class="annot"><span class="annottext">inert_beats_wanted :: CtEvidence -&gt; EqRel -&gt; Bool
</span><a href="#local-6989586621681976025"><span class="hs-identifier hs-var hs-var">inert_beats_wanted</span></a></span></span><span> </span><span id="local-6989586621681976037"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976037"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span> </span><span id="local-6989586621681976038"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976038"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span>
</span><span id="line-1521"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- eqCanRewriteFR:        see second bullet of Note [Combining equalities]</span><span>
</span><span id="line-1522"></span><span>        </span><span class="hs-comment">-- strictly_more_visible: see last bullet of Note [Combining equalities]</span><span>
</span><span id="line-1523"></span><span>        </span><span class="annot"><span class="annottext">(CtFlavour, EqRel)
</span><a href="#local-6989586621681976039"><span class="hs-identifier hs-var">fr_i</span></a></span><span> </span><span class="annot"><span class="annottext">(CtFlavour, EqRel) -&gt; (CtFlavour, EqRel) -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#eqCanRewriteFR"><span class="hs-operator hs-var">`eqCanRewriteFR`</span></a></span><span> </span><span class="annot"><span class="annottext">(CtFlavour, EqRel)
</span><a href="#local-6989586621681976036"><span class="hs-identifier hs-var">fr_w</span></a></span><span>
</span><span id="line-1524"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976033"><span class="hs-identifier hs-var">loc_w</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtLoc -&gt; Bool
</span><a href="#local-6989586621681976041"><span class="hs-operator hs-var">`strictly_more_visible`</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976037"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1525"></span><span>                 </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CtFlavour, EqRel)
</span><a href="#local-6989586621681976036"><span class="hs-identifier hs-var">fr_w</span></a></span><span> </span><span class="annot"><span class="annottext">(CtFlavour, EqRel) -&gt; (CtFlavour, EqRel) -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#eqCanRewriteFR"><span class="hs-operator hs-var">`eqCanRewriteFR`</span></a></span><span> </span><span class="annot"><span class="annottext">(CtFlavour, EqRel)
</span><a href="#local-6989586621681976039"><span class="hs-identifier hs-var">fr_i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1526"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1527"></span><span>        </span><span id="local-6989586621681976039"><span class="annot"><span class="annottext">fr_i :: (CtFlavour, EqRel)
</span><a href="#local-6989586621681976039"><span class="hs-identifier hs-var hs-var">fr_i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#ctEvFlavour"><span class="hs-identifier hs-var">ctEvFlavour</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976037"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976038"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1528"></span><span>
</span><span id="line-1529"></span><span>    </span><span class="hs-comment">-- See Note [Combining equalities], final bullet</span><span>
</span><span id="line-1530"></span><span>    </span><span id="local-6989586621681976041"><span class="annot"><span class="annottext">strictly_more_visible :: CtLoc -&gt; CtLoc -&gt; Bool
</span><a href="#local-6989586621681976041"><span class="hs-identifier hs-var hs-var">strictly_more_visible</span></a></span></span><span> </span><span id="local-6989586621681976042"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976042"><span class="hs-identifier hs-var">loc1</span></a></span></span><span> </span><span id="local-6989586621681976043"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976043"><span class="hs-identifier hs-var">loc2</span></a></span></span><span>
</span><span id="line-1531"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtOrigin -&gt; Bool
</span><a href="GHC.Tc.Types.Origin.html#isVisibleOrigin"><span class="hs-identifier hs-var">isVisibleOrigin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Constraint.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976043"><span class="hs-identifier hs-var">loc2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>
</span><span id="line-1532"></span><span>         </span><span class="annot"><span class="annottext">CtOrigin -&gt; Bool
</span><a href="GHC.Tc.Types.Origin.html#isVisibleOrigin"><span class="hs-identifier hs-var">isVisibleOrigin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Constraint.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976042"><span class="hs-identifier hs-var">loc1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1533"></span><span>
</span><span id="line-1534"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#inertsCanDischarge"><span class="hs-identifier hs-var">inertsCanDischarge</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ct
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (CtEvidence, SwapFlag)
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1535"></span><span>
</span><span id="line-1536"></span><span>
</span><span id="line-1537"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#interactEq"><span class="hs-identifier hs-type">interactEq</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1538"></span><span id="interactEq"><span class="annot"><span class="annottext">interactEq :: InertCans -&gt; SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#interactEq"><span class="hs-identifier hs-var hs-var">interactEq</span></a></span></span><span> </span><span id="local-6989586621681976045"><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681976045"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span id="local-6989586621681976046"><span class="annot"><span class="annottext">workItem :: Ct
</span><a href="#local-6989586621681976046"><span class="hs-identifier hs-var">workItem</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CEqCan"><span class="hs-identifier hs-type">CEqCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_lhs :: Ct -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#cc_lhs"><span class="hs-identifier hs-var">cc_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976047"><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621681976047"><span class="hs-identifier hs-var">lhs</span></a></span></span><span>
</span><span id="line-1539"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_rhs :: Ct -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#cc_rhs"><span class="hs-identifier hs-var">cc_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976048"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976048"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1540"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976049"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976049"><span class="hs-identifier hs-var">ev</span></a></span></span><span>
</span><span id="line-1541"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_eq_rel :: Ct -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#cc_eq_rel"><span class="hs-identifier hs-var">cc_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976050"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976050"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1542"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976051"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976051"><span class="hs-identifier hs-var">ev_i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976052"><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621681976052"><span class="hs-identifier hs-var">swapped</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; Ct -&gt; Maybe (CtEvidence, SwapFlag)
</span><a href="GHC.Tc.Solver.Interact.html#inertsCanDischarge"><span class="hs-identifier hs-var">inertsCanDischarge</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681976045"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976046"><span class="hs-identifier hs-var">workItem</span></a></span><span>
</span><span id="line-1543"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976049"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">(EvTerm -&gt; TcS ()) -&gt; EvTerm -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1544"></span><span>         </span><span class="annot"><span class="annottext">TcCoercion -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#evCoercion"><span class="hs-identifier hs-var">evCoercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SwapFlag -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Tc.Types.Evidence.html#maybeSymCo"><span class="hs-identifier hs-var">maybeSymCo</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="#local-6989586621681976052"><span class="hs-identifier hs-var">swapped</span></a></span><span> </span><span class="annot"><span class="annottext">(TcCoercion -&gt; TcCoercion) -&gt; TcCoercion -&gt; TcCoercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1545"></span><span>                     </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; TcCoercion -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976050"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1546"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; Role
</span><a href="GHC.Tc.Types.Constraint.html#ctEvRole"><span class="hs-identifier hs-var">ctEvRole</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976051"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1547"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CtEvidence -&gt; TcCoercion
CtEvidence -&gt; TcCoercion
</span><a href="GHC.Tc.Types.Constraint.html#ctEvCoercion"><span class="hs-identifier hs-var">ctEvCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976051"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1548"></span><span>
</span><span id="line-1549"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; String -&gt; TcS (StopOrContinue Ct)
forall a. CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976049"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Solved from inert&quot;</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1550"></span><span>
</span><span id="line-1551"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976050"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>   </span><span class="hs-comment">-- See Note [Do not unify representational equalities]</span><span>
</span><span id="line-1552"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Not unifying representational equality&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976046"><span class="hs-identifier hs-var">workItem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1553"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976046"><span class="hs-identifier hs-var">workItem</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1554"></span><span>
</span><span id="line-1555"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1556"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanEqLHS
</span><a href="#local-6989586621681976047"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1557"></span><span>       </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyVarLHS"><span class="hs-identifier hs-type">TyVarLHS</span></a></span><span> </span><span id="local-6989586621681976060"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976060"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence -&gt; TyVar -&gt; TcPredType -&gt; TcS (StopOrContinue Ct)
</span><a href="GHC.Tc.Solver.Interact.html#tryToSolveByUnification"><span class="hs-identifier hs-var">tryToSolveByUnification</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976046"><span class="hs-identifier hs-var">workItem</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976049"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976060"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976048"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1558"></span><span>
</span><span id="line-1559"></span><span>       </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span id="local-6989586621681976062"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976062"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621681976063"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976063"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; InertCans -&gt; TyCon -&gt; [TcPredType] -&gt; TcPredType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#improveLocalFunEqs"><span class="hs-identifier hs-var">improveLocalFunEqs</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976049"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681976045"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976062"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976063"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976048"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1560"></span><span>                              </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976046"><span class="hs-identifier hs-var">workItem</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1561"></span><span>
</span><span id="line-1562"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#interactEq"><span class="hs-identifier hs-var">interactEq</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681976064"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976064"><span class="hs-identifier hs-var">wi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS (StopOrContinue Ct)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;interactEq&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976064"><span class="hs-identifier hs-var">wi</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1563"></span><span>
</span><span id="line-1564"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-1565"></span><span class="hs-comment">-- We have a meta-tyvar on the left, and metaTyVarUpdateOK has said &quot;yes&quot;</span><span>
</span><span id="line-1566"></span><span class="hs-comment">-- So try to solve by unifying.</span><span>
</span><span id="line-1567"></span><span class="hs-comment">-- Three reasons why not:</span><span>
</span><span id="line-1568"></span><span class="hs-comment">--    Skolem escape</span><span>
</span><span id="line-1569"></span><span class="hs-comment">--    Given equalities (GADTs)</span><span>
</span><span id="line-1570"></span><span class="hs-comment">--    Unifying a TyVarTv with a non-tyvar type</span><span>
</span><span id="line-1571"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#tryToSolveByUnification"><span class="hs-identifier hs-type">tryToSolveByUnification</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span>
</span><span id="line-1572"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span>   </span><span class="hs-comment">-- LHS tyvar</span><span>
</span><span id="line-1573"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>    </span><span class="hs-comment">-- RHS</span><span>
</span><span id="line-1574"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1575"></span><span id="tryToSolveByUnification"><span class="annot"><span class="annottext">tryToSolveByUnification :: Ct -&gt; CtEvidence -&gt; TyVar -&gt; TcPredType -&gt; TcS (StopOrContinue Ct)
</span><a href="GHC.Tc.Solver.Interact.html#tryToSolveByUnification"><span class="hs-identifier hs-var hs-var">tryToSolveByUnification</span></a></span></span><span> </span><span id="local-6989586621681976066"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976066"><span class="hs-identifier hs-var">work_item</span></a></span></span><span> </span><span id="local-6989586621681976067"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976067"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621681976068"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976068"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621681976069"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976069"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1576"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976070"><span class="annot"><span class="annottext">TouchabilityTestResult
</span><a href="#local-6989586621681976070"><span class="hs-identifier hs-var">is_touchable</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976071"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976071"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtFlavour
-&gt; TyVar -&gt; TcPredType -&gt; TcS (TouchabilityTestResult, TcPredType)
</span><a href="GHC.Tc.Solver.Monad.html#touchabilityTest"><span class="hs-identifier hs-var">touchabilityTest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#ctEvFlavour"><span class="hs-identifier hs-var">ctEvFlavour</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976067"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976068"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976069"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1577"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tryToSolveByUnification&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976068"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'~'</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976071"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1578"></span><span>                                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TouchabilityTestResult -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TouchabilityTestResult
</span><a href="#local-6989586621681976070"><span class="hs-identifier hs-var">is_touchable</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1579"></span><span>
</span><span id="line-1580"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TouchabilityTestResult
</span><a href="#local-6989586621681976070"><span class="hs-identifier hs-var">is_touchable</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1581"></span><span>           </span><span class="annot"><span class="annottext">TouchabilityTestResult
</span><a href="GHC.Tc.Solver.Monad.html#Untouchable"><span class="hs-identifier hs-var">Untouchable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976066"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-1582"></span><span>           </span><span class="hs-comment">-- For the latter two cases see Note [Solve by unification]</span><span>
</span><span id="line-1583"></span><span>           </span><span class="annot"><span class="annottext">TouchabilityTestResult
</span><a href="GHC.Tc.Solver.Monad.html#TouchableSameLevel"><span class="hs-identifier hs-var">TouchableSameLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TyVar -&gt; TcPredType -&gt; TcS (StopOrContinue Ct)
</span><a href="GHC.Tc.Solver.Interact.html#solveByUnification"><span class="hs-identifier hs-var">solveByUnification</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976067"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976068"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976071"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1584"></span><span>           </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TouchableOuterLevel"><span class="hs-identifier hs-type">TouchableOuterLevel</span></a></span><span> </span><span id="local-6989586621681976078"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976078"><span class="hs-identifier hs-var">free_metas</span></a></span></span><span> </span><span id="local-6989586621681976079"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621681976079"><span class="hs-identifier hs-var">tv_lvl</span></a></span></span><span>
</span><span id="line-1585"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">TcM () -&gt; TcS ()
forall a. TcM a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM () -&gt; TcS ()) -&gt; TcM () -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) Bool) -&gt; [TyVar] -&gt; TcM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#mapM_/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt;
TcLevel -&gt; TyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) Bool
TcLevel -&gt; TyVar -&gt; IOEnv (Env TcGblEnv TcLclEnv) Bool
</span><a href="GHC.Tc.Utils.TcMType.html#promoteMetaTyVarTo"><span class="hs-identifier hs-var">promoteMetaTyVarTo</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621681976079"><span class="hs-identifier hs-var">tv_lvl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976078"><span class="hs-identifier hs-var">free_metas</span></a></span><span>
</span><span id="line-1586"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcLevel -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setUnificationFlag"><span class="hs-identifier hs-var">setUnificationFlag</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621681976079"><span class="hs-identifier hs-var">tv_lvl</span></a></span><span>
</span><span id="line-1587"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TyVar -&gt; TcPredType -&gt; TcS (StopOrContinue Ct)
</span><a href="GHC.Tc.Solver.Interact.html#solveByUnification"><span class="hs-identifier hs-var">solveByUnification</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976067"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976068"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976071"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1588"></span><span>
</span><span id="line-1589"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#solveByUnification"><span class="hs-identifier hs-type">solveByUnification</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Xi"><span class="hs-identifier hs-type">Xi</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1590"></span><span class="hs-comment">-- Solve with the identity coercion</span><span>
</span><span id="line-1591"></span><span class="hs-comment">-- Precondition: kind(xi) equals kind(tv)</span><span>
</span><span id="line-1592"></span><span class="hs-comment">-- Precondition: CtEvidence is Wanted</span><span>
</span><span id="line-1593"></span><span class="hs-comment">-- Precondition: CtEvidence is nominal</span><span>
</span><span id="line-1594"></span><span class="hs-comment">-- Returns: workItem where</span><span>
</span><span id="line-1595"></span><span class="hs-comment">--        workItem = the new Given constraint</span><span>
</span><span id="line-1596"></span><span class="hs-comment">--</span><span>
</span><span id="line-1597"></span><span class="hs-comment">-- NB: No need for an occurs check here, because solveByUnification always</span><span>
</span><span id="line-1598"></span><span class="hs-comment">--     arises from a CEqCan, a *canonical* constraint.  Its invariant (TyEq:OC)</span><span>
</span><span id="line-1599"></span><span class="hs-comment">--     says that in (a ~ xi), the type variable a does not appear in xi.</span><span>
</span><span id="line-1600"></span><span class="hs-comment">--     See GHC.Tc.Types.Constraint.Ct invariants.</span><span>
</span><span id="line-1601"></span><span class="hs-comment">--</span><span>
</span><span id="line-1602"></span><span class="hs-comment">-- Post: tv is unified (by side effect) with xi;</span><span>
</span><span id="line-1603"></span><span class="hs-comment">--       we often write tv := xi</span><span>
</span><span id="line-1604"></span><span id="solveByUnification"><span class="annot"><span class="annottext">solveByUnification :: CtEvidence -&gt; TyVar -&gt; TcPredType -&gt; TcS (StopOrContinue Ct)
</span><a href="GHC.Tc.Solver.Interact.html#solveByUnification"><span class="hs-identifier hs-var hs-var">solveByUnification</span></a></span></span><span> </span><span id="local-6989586621681976083"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976083"><span class="hs-identifier hs-var">wd</span></a></span></span><span> </span><span id="local-6989586621681976084"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976084"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621681976085"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976085"><span class="hs-identifier hs-var">xi</span></a></span></span><span>
</span><span id="line-1605"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681976086"><span class="annot"><span class="annottext">tv_ty :: TcPredType
</span><a href="#local-6989586621681976086"><span class="hs-identifier hs-var hs-var">tv_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; TcPredType
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976084"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-1606"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Sneaky unification:&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1607"></span><span>                       </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unifies:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976084"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;:=&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976085"><span class="hs-identifier hs-var">xi</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1608"></span><span>                             </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Coercion:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; TcPredType -&gt; SDoc
</span><a href="GHC.Tc.Solver.Monad.html#pprEq"><span class="hs-identifier hs-var">pprEq</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976086"><span class="hs-identifier hs-var">tv_ty</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976085"><span class="hs-identifier hs-var">xi</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1609"></span><span>                             </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Left Kind is:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; TcPredType -&gt; TcPredType
TcPredType -&gt; TcPredType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976086"><span class="hs-identifier hs-var">tv_ty</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1610"></span><span>                             </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Right Kind is:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; TcPredType -&gt; TcPredType
TcPredType -&gt; TcPredType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976085"><span class="hs-identifier hs-var">xi</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1611"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; TcPredType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#unifyTyVar"><span class="hs-identifier hs-var">unifyTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976084"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976085"><span class="hs-identifier hs-var">xi</span></a></span><span>
</span><span id="line-1612"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976083"><span class="hs-identifier hs-var">wd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcCoercion -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#evCoercion"><span class="hs-identifier hs-var">evCoercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPredType -&gt; TcCoercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976085"><span class="hs-identifier hs-var">xi</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1613"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681976092"><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681976092"><span class="hs-identifier hs-var">n_kicked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; TcS ScDepth
</span><a href="GHC.Tc.Solver.Monad.html#kickOutAfterUnification"><span class="hs-identifier hs-var">kickOutAfterUnification</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976084"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-1614"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">StopOrContinue Ct -&gt; TcS (StopOrContinue Ct)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc -&gt; StopOrContinue Ct
forall a. CtEvidence -&gt; SDoc -&gt; StopOrContinue a
</span><a href="GHC.Tc.Solver.Canonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976083"><span class="hs-identifier hs-var">wd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Solved by unification&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ScDepth -&gt; SDoc
</span><a href="GHC.Tc.Solver.Monad.html#pprKicked"><span class="hs-identifier hs-var">pprKicked</span></a></span><span> </span><span class="annot"><span class="annottext">ScDepth
</span><a href="#local-6989586621681976092"><span class="hs-identifier hs-var">n_kicked</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1615"></span><span>
</span><span id="line-1616"></span><span class="hs-comment">{- Note [Avoid double unifications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The spontaneous solver has to return a given which mentions the unified unification
variable *on the left* of the equality. Here is what happens if not:
  Original wanted:  (a ~ alpha),  (alpha ~ Int)
We spontaneously solve the first wanted, without changing the order!
      given : a ~ alpha      [having unified alpha := a]
Now the second wanted comes along, but it cannot rewrite the given, so we simply continue.
At the end we spontaneously solve that guy, *reunifying*  [alpha := Int]

We avoid this problem by orienting the resulting given so that the unification
variable is on the left (note that alternatively we could attempt to
enforce this at canonicalization).

See also Note [No touchables as FunEq RHS] in GHC.Tc.Solver.Monad; avoiding
double unifications is the main reason we disallow touchable
unification variables as RHS of type family equations: F xis ~ alpha.

Note [Do not unify representational equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider   [W] alpha ~R# b
where alpha is touchable. Should we unify alpha := b?

Certainly not!  Unifying forces alpha and be to be the same; but they
only need to be representationally equal types.

For example, we might have another constraint [W] alpha ~# N b
where
  newtype N b = MkN b
and we want to get alpha := N b.

See also #15144, which was caused by unifying a representational
equality.

Note [Solve by unification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we solve
   alpha[n] ~ ty
by unification, there are two cases to consider

* TouchableSameLevel: if the ambient level is 'n', then
  we can simply update alpha := ty, and do nothing else

* TouchableOuterLevel free_metas n: if the ambient level is greater than
  'n' (the level of alpha), in addition to setting alpha := ty we must
  do two other things:

  1. Promote all the free meta-vars of 'ty' to level n.  After all,
     alpha[n] is at level n, and so if we set, say,
          alpha[n] := Maybe beta[m],
     we must ensure that when unifying beta we do skolem-escape checks
     etc relevant to level n.  Simple way to do that: promote beta to
     level n.

  2. Set the Unification Level Flag to record that a level-n unification has
     taken place. See Note [The Unification Level Flag] in GHC.Tc.Solver.Monad

NB: TouchableSameLevel is just an optimisation for TouchableOuterLevel. Promotion
would be a no-op, and setting the unification flag unnecessarily would just
make the solver iterate more often.  (We don't need to iterate when unifying
at the ambient level because of the kick-out mechanism.)


************************************************************************
*                                                                      *
*          Functional dependencies, instantiation of equations
*                                                                      *
************************************************************************

When we spot an equality arising from a functional dependency,
we now use that equality (a &quot;wanted&quot;) to rewrite the work-item
constraint right away.  This avoids two dangers

 Danger 1: If we send the original constraint on down the pipeline
           it may react with an instance declaration, and in delicate
           situations (when a Given overlaps with an instance) that
           may produce new insoluble goals: see #4952

 Danger 2: If we don't rewrite the constraint, it may re-react
           with the same thing later, and produce the same equality
           again --&gt; termination worries.

To achieve this required some refactoring of GHC.Tc.Instance.FunDeps (nicer
now!).

Note [FunDep and implicit parameter reactions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Currently, our story of interacting two dictionaries (or a dictionary
and top-level instances) for functional dependencies, and implicit
parameters, is that we simply produce new Wanted equalities.  So for example

        class D a b | a -&gt; b where ...
    Inert:
        d1 :g D Int Bool
    WorkItem:
        d2 :w D Int alpha

    We generate the extra work item
        cv :w alpha ~ Bool
    where 'cv' is currently unused.  However, this new item can perhaps be
    spontaneously solved to become given and react with d2,
    discharging it in favour of a new constraint d2' thus:
        d2' :w D Int Bool
        d2 := d2' |&gt; D Int cv
    Now d2' can be discharged from d1

We could be more aggressive and try to *immediately* solve the dictionary
using those extra equalities.

If that were the case with the same inert set and work item we might discard
d2 directly:

        cv :w alpha ~ Bool
        d2 := d1 |&gt; D Int cv

But in general it's a bit painful to figure out the necessary coercion,
so we just take the first approach. Here is a better example. Consider:
    class C a b c | a -&gt; b
And:
     [Given]  d1 : C T Int Char
     [Wanted] d2 : C T beta Int
In this case, it's *not even possible* to solve the wanted immediately.
So we should simply output the functional dependency and add this guy
[but NOT its superclasses] back in the worklist. Even worse:
     [Given] d1 : C T Int beta
     [Wanted] d2: C T beta Int
Then it is solvable, but its very hard to detect this on the spot.

It's exactly the same with implicit parameters, except that the
&quot;aggressive&quot; approach would be much easier to implement.

Note [Fundeps with instances, and equality orientation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This Note describes a delicate interaction that constrains the orientation of
equalities. This one is about fundeps, but the /exact/ same thing arises for
type-family injectivity constraints: see Note [Improvement orientation].

doTopFundepImprovement compares the constraint with all the instance
declarations, to see if we can produce any equalities. E.g
   class C2 a b | a -&gt; b
   instance C Int Bool
Then the constraint (C Int ty) generates the equality [W] ty ~ Bool.

There is a nasty corner in #19415 which led to the typechecker looping:
   class C s t b | s -&gt; t
   instance ... =&gt; C (T kx x) (T ky y) Int
   T :: forall k. k -&gt; Type

   work_item: dwrk :: C (T @ka (a::ka)) (T @kb0 (b0::kb0)) Char
      where kb0, b0 are unification vars

   ==&gt; {doTopFundepImprovement: compare work_item with instance,
        generate /fresh/ unification variables kfresh0, yfresh0,
        emit a new Wanted, and add dwrk to inert set}

   Suppose we emit this new Wanted from the fundep:
       [W] T kb0 (b0::kb0) ~ T kfresh0 (yfresh0::kfresh0)

   ==&gt; {solve that equality kb0 := kfresh0, b0 := yfresh0}
   Now kick out dwrk, since it mentions kb0
   But now we are back to the start!  Loop!

NB1: This example relies on an instance that does not satisfy the
     coverage condition (although it may satisfy the weak coverage
     condition), and hence whose fundeps generate fresh unification
     variables.  Not satisfying the coverage condition is known to
     lead to termination trouble, but in this case it's plain silly.

NB2: In this example, the third parameter to C ensures that the
     instance doesn't actually match the Wanted, so we can't use it to
     solve the Wanted

We solve the problem by (#21703):

    carefully orienting the new Wanted so that all the
    freshly-generated unification variables are on the LHS.

    Thus we emit
       [W] T kfresh0 (yfresh0::kfresh0) ~ T kb0 (b0::kb0)
    and /NOT/
       [W] T kb0 (b0::kb0) ~ T kfresh0 (yfresh0::kfresh0)

Now we'll unify kfresh0:=kb0, yfresh0:=b0, and all is well.  The general idea
is that we want to preferentially eliminate those freshly-generated
unification variables, rather than unifying older variables, which causes
kick-out etc.

Keeping younger variables on the left also gives very minor improvement in
the compiler performance by having less kick-outs and allocations (-0.1% on
average).  Indeed Historical Note [Eliminate younger unification variables]
in GHC.Tc.Utils.Unify describes an earlier attempt to do so systematically,
apparently now in abeyance.

But this is is a delicate solution. We must take care to /preserve/
orientation during solving. Wrinkles:

(W1) We start with
       [W] T kfresh0 (yfresh0::kfresh0) ~ T kb0 (b0::kb0)
     Decompose to
       [W] kfresh0 ~ kb0
       [W] (yfresh0::kfresh0) ~ (b0::kb0)
     Preserve orientiation when decomposing!!

(W2) Suppose we happen to tackle the second Wanted from (W1)
     first. Then in canEqCanLHSHetero we emit a /kind/ equality, as
     well as a now-homogeneous type equality
       [W] kco : kfresh0 ~ kb0
       [W] (yfresh0::kfresh0) ~ (b0::kb0) |&gt; (sym kco)
     Preserve orientation in canEqCanLHSHetero!!  (Failing to
     preserve orientation here was the immediate cause of #21703.)

(W3) There is a potential interaction with the swapping done by
     GHC.Tc.Utils.Unify.swapOverTyVars.  We think it's fine, but it's
     a slight worry.  See especially Note [TyVar/TyVar orientation] in
     that module.

The trouble is that &quot;preserving orientation&quot; is a rather global invariant,
and sometimes we definitely do want to swap (e.g. Int ~ alpha), so we don't
even have a precise statement of what the invariant is.  The advantage
of the preserve-orientation plan is that it is extremely cheap to implement,
and apparently works beautifully.

--- Alternative plan (1) ---
Rather than have an ill-defined invariant, another possiblity is to
elminate those fresh unification variables at birth, when generating
the new fundep-inspired equalities.

The key idea is to call `instFlexiX` in `emitFunDepWanteds` on only those
type variables that are guaranteed to give us some progress. This means we
have to locally (without calling emitWanteds) identify the type variables
that do not give us any progress.  In the above example, we _know_ that
emitting the two wanteds `kco` and `co` is fruitless.

  Q: How do we identify such no-ops?

  1. Generate a matching substitution from LHS to RHS
        &#632; = [kb0 :-&gt; k0, b0 :-&gt;  y0]
  2. Call `instFlexiX` on only those type variables that do not appear in the domain of &#632;
        &#632;' = instFlexiX &#632; (tvs - domain &#632;)
  3. Apply &#632;' on LHS and then call emitWanteds
        unifyWanteds ... (subst &#632;' LHS) RHS

Why will this work?  The matching substitution &#632; will be a best effort
substitution that gives us all the easy solutions. It can be generated with
modified version of `Core/Unify.unify_tys` where we run it in a matching mode
and never generate `SurelyApart` and always return a `MaybeApart Subst`
instead.

The same alternative plan would work for type-family injectivity constraints:
see Note [Improvement orientation].
--- End of Alternative plan (1) ---

--- Alternative plan (2) ---
We could have a new flavour of TcTyVar (like `TauTv`, `TyVarTv` etc; see GHC.Tc.Utils.TcType.MetaInfo)
for the fresh unification variables introduced by functional dependencies.  Say `FunDepTv`.  Then in
GHC.Tc.Utils.Unify.swapOverTyVars we could arrange to keep a `FunDepTv` on the left if possible.
Looks possible, but it's one more complication.
--- End of Alternative plan (2) ---


--- Historical note: Failed Alternative Plan (3) ---
Previously we used a flag `cc_fundeps` in `CDictCan`. It would flip to False
once we used a fun dep to hint the solver to break and to stop emitting more
wanteds.  This solution was not complete, and caused a failures while trying
to solve for transitive functional dependencies (test case: T21703)
-- End of Historical note: Failed Alternative Plan (3) --

Note [Weird fundeps]
~~~~~~~~~~~~~~~~~~~~
Consider   class Het a b | a -&gt; b where
              het :: m (f c) -&gt; a -&gt; m b

           class GHet (a :: * -&gt; *) (b :: * -&gt; *) | a -&gt; b
           instance            GHet (K a) (K [a])
           instance Het a b =&gt; GHet (K a) (K b)

The two instances don't actually conflict on their fundeps,
although it's pretty strange.  So they are both accepted. Now
try   [W] GHet (K Int) (K Bool)
This triggers fundeps from both instance decls;
      [W] K Bool ~ K [a]
      [W] K Bool ~ K beta
And there's a risk of complaining about Bool ~ [a].  But in fact
the Wanted matches the second instance, so we never get as far
as the fundeps.

#7875 is a case in point.
-}</span><span>
</span><span id="line-1904"></span><span>
</span><span id="line-1905"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#doTopFundepImprovement"><span class="hs-identifier hs-type">doTopFundepImprovement</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1906"></span><span class="hs-comment">-- Try to functional-dependency improvement between the constraint</span><span>
</span><span id="line-1907"></span><span class="hs-comment">-- and the top-level instance declarations</span><span>
</span><span id="line-1908"></span><span class="hs-comment">-- See Note [Fundeps with instances, and equality orientation]</span><span>
</span><span id="line-1909"></span><span class="hs-comment">-- See also Note [Weird fundeps]</span><span>
</span><span id="line-1910"></span><span id="doTopFundepImprovement"><span class="annot"><span class="annottext">doTopFundepImprovement :: Ct -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#doTopFundepImprovement"><span class="hs-identifier hs-var hs-var">doTopFundepImprovement</span></a></span></span><span> </span><span id="local-6989586621681976096"><span class="annot"><span class="annottext">work_item :: Ct
</span><a href="#local-6989586621681976096"><span class="hs-identifier hs-var">work_item</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CDictCan"><span class="hs-identifier hs-type">CDictCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976097"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976097"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_class :: Ct -&gt; Class
</span><a href="GHC.Tc.Types.Constraint.html#cc_class"><span class="hs-identifier hs-var">cc_class</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976098"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976098"><span class="hs-identifier hs-var">cls</span></a></span></span><span>
</span><span id="line-1911"></span><span>                                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_tyargs :: Ct -&gt; [TcPredType]
</span><a href="GHC.Tc.Types.Constraint.html#cc_tyargs"><span class="hs-identifier hs-var">cc_tyargs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976099"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976099"><span class="hs-identifier hs-var">xis</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1912"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;try_fundeps&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976096"><span class="hs-identifier hs-var">work_item</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1913"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681976100"><span class="annot"><span class="annottext">InstEnvs
</span><a href="#local-6989586621681976100"><span class="hs-identifier hs-var">instEnvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS InstEnvs
</span><a href="GHC.Tc.Solver.Monad.html#getInstEnvs"><span class="hs-identifier hs-var">getInstEnvs</span></a></span><span>
</span><span id="line-1914"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681976102"><span class="annot"><span class="annottext">fundep_eqns :: [FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681976102"><span class="hs-identifier hs-var hs-var">fundep_eqns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InstEnvs
-&gt; (TcPredType -&gt; SrcSpan -&gt; (CtLoc, RewriterSet))
-&gt; Class
-&gt; [TcPredType]
-&gt; [FunDepEqn (CtLoc, RewriterSet)]
forall loc.
InstEnvs
-&gt; (TcPredType -&gt; SrcSpan -&gt; loc)
-&gt; Class
-&gt; [TcPredType]
-&gt; [FunDepEqn loc]
</span><a href="GHC.Tc.Instance.FunDeps.html#improveFromInstEnv"><span class="hs-identifier hs-var">improveFromInstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">InstEnvs
</span><a href="#local-6989586621681976100"><span class="hs-identifier hs-var">instEnvs</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; SrcSpan -&gt; (CtLoc, RewriterSet)
</span><a href="#local-6989586621681976104"><span class="hs-identifier hs-var">mk_ct_loc</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976098"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976099"><span class="hs-identifier hs-var">xis</span></a></span><span>
</span><span id="line-1915"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">RewriterSet -&gt; [FunDepEqn (CtLoc, RewriterSet)] -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#emitFunDepWanteds"><span class="hs-identifier hs-var">emitFunDepWanteds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#ctEvRewriters"><span class="hs-identifier hs-var">ctEvRewriters</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976097"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681976102"><span class="hs-identifier hs-var">fundep_eqns</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1916"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1917"></span><span>     </span><span id="local-6989586621681976105"><span class="annot"><span class="annottext">dict_pred :: TcPredType
</span><a href="#local-6989586621681976105"><span class="hs-identifier hs-var hs-var">dict_pred</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [TcPredType] -&gt; TcPredType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976098"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976099"><span class="hs-identifier hs-var">xis</span></a></span><span>
</span><span id="line-1918"></span><span>     </span><span id="local-6989586621681976107"><span class="annot"><span class="annottext">dict_loc :: CtLoc
</span><a href="#local-6989586621681976107"><span class="hs-identifier hs-var hs-var">dict_loc</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976097"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-1919"></span><span>     </span><span id="local-6989586621681976108"><span class="annot"><span class="annottext">dict_origin :: CtOrigin
</span><a href="#local-6989586621681976108"><span class="hs-identifier hs-var hs-var">dict_origin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Constraint.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976107"><span class="hs-identifier hs-var">dict_loc</span></a></span><span>
</span><span id="line-1920"></span><span>
</span><span id="line-1921"></span><span>     </span><span class="annot"><a href="#local-6989586621681976104"><span class="hs-identifier hs-type">mk_ct_loc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span>   </span><span class="hs-comment">-- From instance decl</span><span>
</span><span id="line-1922"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span>    </span><span class="hs-comment">-- also from instance deol</span><span>
</span><span id="line-1923"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1924"></span><span>     </span><span id="local-6989586621681976104"><span class="annot"><span class="annottext">mk_ct_loc :: TcPredType -&gt; SrcSpan -&gt; (CtLoc, RewriterSet)
</span><a href="#local-6989586621681976104"><span class="hs-identifier hs-var hs-var">mk_ct_loc</span></a></span></span><span> </span><span id="local-6989586621681976110"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976110"><span class="hs-identifier hs-var">inst_pred</span></a></span></span><span> </span><span id="local-6989586621681976111"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621681976111"><span class="hs-identifier hs-var">inst_loc</span></a></span></span><span>
</span><span id="line-1925"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976107"><span class="hs-identifier hs-var">dict_loc</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#ctl_origin"><span class="hs-identifier hs-var">ctl_origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#FunDepOrigin2"><span class="hs-identifier hs-type">FunDepOrigin2</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681976105"><span class="hs-identifier hs-type">dict_pred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681976108"><span class="hs-identifier hs-type">dict_origin</span></a></span><span>
</span><span id="line-1926"></span><span>                                                 </span><span class="annot"><a href="#local-6989586621681976110"><span class="hs-identifier hs-type">inst_pred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681976111"><span class="hs-identifier hs-type">inst_loc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1927"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-var">emptyRewriterSet</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1928"></span><span>
</span><span id="line-1929"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#doTopFundepImprovement"><span class="hs-identifier hs-var">doTopFundepImprovement</span></a></span><span> </span><span id="local-6989586621681976114"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976114"><span class="hs-identifier hs-var">work_item</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doTopFundepImprovement&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976114"><span class="hs-identifier hs-var">work_item</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1930"></span><span>
</span><span id="line-1931"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#emitFunDepWanteds"><span class="hs-identifier hs-type">emitFunDepWanteds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span>  </span><span class="hs-comment">-- from the work item</span><span>
</span><span id="line-1932"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html#FunDepEqn"><span class="hs-identifier hs-type">FunDepEqn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1933"></span><span>
</span><span id="line-1934"></span><span id="emitFunDepWanteds"><span class="annot"><span class="annottext">emitFunDepWanteds :: RewriterSet -&gt; [FunDepEqn (CtLoc, RewriterSet)] -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#emitFunDepWanteds"><span class="hs-identifier hs-var hs-var">emitFunDepWanteds</span></a></span></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcS ()
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- common case noop</span><span>
</span><span id="line-1935"></span><span class="hs-comment">-- See Note [FunDep and implicit parameter reactions]</span><span>
</span><span id="line-1936"></span><span>
</span><span id="line-1937"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#emitFunDepWanteds"><span class="hs-identifier hs-var">emitFunDepWanteds</span></a></span><span> </span><span id="local-6989586621681976115"><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621681976115"><span class="hs-identifier hs-var">work_rewriters</span></a></span></span><span> </span><span id="local-6989586621681976116"><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681976116"><span class="hs-identifier hs-var">fd_eqns</span></a></span></span><span>
</span><span id="line-1938"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FunDepEqn (CtLoc, RewriterSet) -&gt; TcS ())
-&gt; [FunDepEqn (CtLoc, RewriterSet)] -&gt; TcS ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#mapM_/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="annot"><span class="annottext">FunDepEqn (CtLoc, RewriterSet) -&gt; TcS ()
</span><a href="#local-6989586621681976117"><span class="hs-identifier hs-var">do_one_FDEqn</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDepEqn (CtLoc, RewriterSet)]
</span><a href="#local-6989586621681976116"><span class="hs-identifier hs-var">fd_eqns</span></a></span><span>
</span><span id="line-1939"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1940"></span><span>    </span><span id="local-6989586621681976117"><span class="annot"><span class="annottext">do_one_FDEqn :: FunDepEqn (CtLoc, RewriterSet) -&gt; TcS ()
</span><a href="#local-6989586621681976117"><span class="hs-identifier hs-var hs-var">do_one_FDEqn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Instance.FunDeps.html#FDEqn"><span class="hs-identifier hs-type">FDEqn</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fd_qtvs :: forall loc. FunDepEqn loc -&gt; [TyVar]
</span><a href="GHC.Tc.Instance.FunDeps.html#fd_qtvs"><span class="hs-identifier hs-var">fd_qtvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976118"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976118"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fd_eqs :: forall loc. FunDepEqn loc -&gt; [TypeEqn]
</span><a href="GHC.Tc.Instance.FunDeps.html#fd_eqs"><span class="hs-identifier hs-var">fd_eqs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976119"><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621681976119"><span class="hs-identifier hs-var">eqs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fd_loc :: forall loc. FunDepEqn loc -&gt; loc
</span><a href="GHC.Tc.Instance.FunDeps.html#fd_loc"><span class="hs-identifier hs-var">fd_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976120"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976120"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976121"><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621681976121"><span class="hs-identifier hs-var">rewriters</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1941"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976118"><span class="hs-identifier hs-var">tvs</span></a></span><span>  </span><span class="hs-comment">-- Common shortcut</span><span>
</span><span id="line-1942"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;emitFunDepWanteds 1&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubGoalDepth -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; SubGoalDepth
</span><a href="GHC.Tc.Types.Constraint.html#ctl_depth"><span class="hs-identifier hs-var">ctl_depth</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976120"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeEqn] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621681976119"><span class="hs-identifier hs-var">eqs</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGivenLoc"><span class="hs-identifier hs-var">isGivenLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976120"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1943"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(TypeEqn -&gt; TcS TcCoercion) -&gt; [TypeEqn] -&gt; TcS ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#mapM_/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681976122"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976122"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681976123"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976123"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RewriterSet
-&gt; CtLoc -&gt; Role -&gt; TcPredType -&gt; TcPredType -&gt; TcS TcCoercion
</span><a href="GHC.Tc.Solver.Canonical.html#unifyWanted"><span class="hs-identifier hs-var">unifyWanted</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621681976125"><span class="hs-identifier hs-var">all_rewriters</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976120"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976122"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976123"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1944"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TypeEqn] -&gt; [TypeEqn]
forall a. [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#reverse/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621681976119"><span class="hs-identifier hs-var">eqs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1945"></span><span>             </span><span class="hs-comment">-- See Note [Reverse order of fundep equations]</span><span>
</span><span id="line-1946"></span><span>
</span><span id="line-1947"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1948"></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;emitFunDepWanteds 2&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubGoalDepth -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; SubGoalDepth
</span><a href="GHC.Tc.Types.Constraint.html#ctl_depth"><span class="hs-identifier hs-var">ctl_depth</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976120"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976118"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeEqn] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621681976119"><span class="hs-identifier hs-var">eqs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1949"></span><span>          </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681976128"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976128"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [TyVar] -&gt; TcS Subst
</span><a href="GHC.Tc.Solver.Monad.html#instFlexiX"><span class="hs-identifier hs-var">instFlexiX</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="GHC.Core.TyCo.Subst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976118"><span class="hs-identifier hs-var">tvs</span></a></span><span>  </span><span class="hs-comment">-- Takes account of kind substitution</span><span>
</span><span id="line-1950"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(TypeEqn -&gt; TcS TcCoercion) -&gt; [TypeEqn] -&gt; TcS ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#mapM_/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; RewriterSet -&gt; Subst -&gt; TypeEqn -&gt; TcS TcCoercion
</span><a href="#local-6989586621681976131"><span class="hs-identifier hs-var">do_one_eq</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976120"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621681976125"><span class="hs-identifier hs-var">all_rewriters</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976128"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TypeEqn] -&gt; [TypeEqn]
forall a. [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#reverse/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621681976119"><span class="hs-identifier hs-var">eqs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1951"></span><span>               </span><span class="hs-comment">-- See Note [Reverse order of fundep equations]</span><span>
</span><span id="line-1952"></span><span>     </span><span class="hs-keyword">where</span><span>
</span><span id="line-1953"></span><span>       </span><span id="local-6989586621681976125"><span class="annot"><span class="annottext">all_rewriters :: RewriterSet
</span><a href="#local-6989586621681976125"><span class="hs-identifier hs-var hs-var">all_rewriters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621681976115"><span class="hs-identifier hs-var">work_rewriters</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet -&gt; RewriterSet -&gt; RewriterSet
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%3C%3E/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">S.&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621681976121"><span class="hs-identifier hs-var">rewriters</span></a></span><span>
</span><span id="line-1954"></span><span>
</span><span id="line-1955"></span><span>    </span><span id="local-6989586621681976131"><span class="annot"><span class="annottext">do_one_eq :: CtLoc -&gt; RewriterSet -&gt; Subst -&gt; TypeEqn -&gt; TcS TcCoercion
</span><a href="#local-6989586621681976131"><span class="hs-identifier hs-var hs-var">do_one_eq</span></a></span></span><span> </span><span id="local-6989586621681976132"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976132"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621681976133"><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621681976133"><span class="hs-identifier hs-var">rewriters</span></a></span></span><span> </span><span id="local-6989586621681976134"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976134"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681976135"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976135"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681976136"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976136"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1956"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriterSet
-&gt; CtLoc -&gt; Role -&gt; TcPredType -&gt; TcPredType -&gt; TcS TcCoercion
</span><a href="GHC.Tc.Solver.Canonical.html#unifyWanted"><span class="hs-identifier hs-var">unifyWanted</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621681976133"><span class="hs-identifier hs-var">rewriters</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976132"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; TcPredType -&gt; TcPredType
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976138"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976135"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976136"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-1957"></span><span>         </span><span class="hs-comment">-- ty2 does not mention fd_qtvs, so no need to subst it.</span><span>
</span><span id="line-1958"></span><span>         </span><span class="hs-comment">-- See GHC.Tc.Instance.Fundeps Note [Improving against instances]</span><span>
</span><span id="line-1959"></span><span>         </span><span class="hs-comment">--     Wrinkle (1)</span><span>
</span><span id="line-1960"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1961"></span><span>         </span><span id="local-6989586621681976138"><span class="annot"><span class="annottext">subst' :: Subst
</span><a href="#local-6989586621681976138"><span class="hs-identifier hs-var hs-var">subst'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; VarSet -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#extendSubstInScopeSet"><span class="hs-identifier hs-var">extendSubstInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976134"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPredType -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976135"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1962"></span><span>         </span><span class="hs-comment">-- The free vars of ty1 aren't just fd_qtvs: ty1 is the result</span><span>
</span><span id="line-1963"></span><span>         </span><span class="hs-comment">-- of matching with the [W] constraint. So we add its free</span><span>
</span><span id="line-1964"></span><span>         </span><span class="hs-comment">-- vars to InScopeSet, to satisfy substTy's invariants, even</span><span>
</span><span id="line-1965"></span><span>         </span><span class="hs-comment">-- though ty1 will never (currently) be a poytype, so this</span><span>
</span><span id="line-1966"></span><span>         </span><span class="hs-comment">-- InScopeSet will never be looked at.</span><span>
</span><span id="line-1967"></span><span>
</span><span id="line-1968"></span><span class="hs-comment">{-
**********************************************************************
*                                                                    *
                       The top-reaction Stage
*                                                                    *
**********************************************************************
-}</span><span>
</span><span id="line-1975"></span><span>
</span><span id="line-1976"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#topReactionsStage"><span class="hs-identifier hs-type">topReactionsStage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#WorkItem"><span class="hs-identifier hs-type">WorkItem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1977"></span><span class="hs-comment">-- The work item does not react with the inert set,</span><span>
</span><span id="line-1978"></span><span class="hs-comment">-- so try interaction with top-level instances.</span><span>
</span><span id="line-1979"></span><span id="topReactionsStage"><span class="annot"><span class="annottext">topReactionsStage :: SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#topReactionsStage"><span class="hs-identifier hs-var hs-var">topReactionsStage</span></a></span></span><span> </span><span id="local-6989586621681976141"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976141"><span class="hs-identifier hs-var">work_item</span></a></span></span><span>
</span><span id="line-1980"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doTopReact&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976141"><span class="hs-identifier hs-var">work_item</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1981"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976141"><span class="hs-identifier hs-var">work_item</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1982"></span><span>
</span><span id="line-1983"></span><span>           </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CDictCan"><span class="hs-identifier hs-type">CDictCan</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1984"></span><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681976142"><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976142"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS InertSet
</span><a href="GHC.Tc.Solver.Monad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a></span><span>
</span><span id="line-1985"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">InertSet -&gt; SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#doTopReactDict"><span class="hs-identifier hs-var">doTopReactDict</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976142"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976141"><span class="hs-identifier hs-var">work_item</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1986"></span><span>
</span><span id="line-1987"></span><span>           </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CEqCan"><span class="hs-identifier hs-type">CEqCan</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1988"></span><span>             </span><span class="annot"><span class="annottext">SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#doTopReactEq"><span class="hs-identifier hs-var">doTopReactEq</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976141"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-1989"></span><span>
</span><span id="line-1990"></span><span>           </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CIrredCan"><span class="hs-identifier hs-type">CIrredCan</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1991"></span><span>             </span><span class="annot"><span class="annottext">SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#doTopReactOther"><span class="hs-identifier hs-var">doTopReactOther</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976141"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-1992"></span><span>
</span><span id="line-1993"></span><span>           </span><span class="hs-comment">-- Any other work item does not react with any top-level equations</span><span>
</span><span id="line-1994"></span><span>           </span><span class="annot"><span class="annottext">Ct
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976141"><span class="hs-identifier hs-var">work_item</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1995"></span><span>
</span><span id="line-1996"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-1997"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#doTopReactOther"><span class="hs-identifier hs-type">doTopReactOther</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1998"></span><span class="hs-comment">-- Try local quantified constraints for</span><span>
</span><span id="line-1999"></span><span class="hs-comment">--     CEqCan    e.g.  (lhs ~# ty)</span><span>
</span><span id="line-2000"></span><span class="hs-comment">-- and CIrredCan e.g.  (c a)</span><span>
</span><span id="line-2001"></span><span class="hs-comment">--</span><span>
</span><span id="line-2002"></span><span class="hs-comment">-- Why equalities? See GHC.Tc.Solver.Canonical</span><span>
</span><span id="line-2003"></span><span class="hs-comment">-- Note [Equality superclasses in quantified constraints]</span><span>
</span><span id="line-2004"></span><span id="doTopReactOther"><span class="annot"><span class="annottext">doTopReactOther :: SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#doTopReactOther"><span class="hs-identifier hs-var hs-var">doTopReactOther</span></a></span></span><span> </span><span id="local-6989586621681976146"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976146"><span class="hs-identifier hs-var">work_item</span></a></span></span><span>
</span><span id="line-2005"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976147"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-2006"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976146"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2007"></span><span>
</span><span id="line-2008"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqPred"><span class="hs-identifier hs-type">EqPred</span></a></span><span> </span><span id="local-6989586621681976148"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976148"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621681976149"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976149"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621681976150"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976150"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; Pred
</span><a href="GHC.Core.Predicate.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976151"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2009"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; EqRel -&gt; TcPredType -&gt; TcPredType -&gt; TcS (StopOrContinue Ct)
</span><a href="GHC.Tc.Solver.Interact.html#doTopReactEqPred"><span class="hs-identifier hs-var">doTopReactEqPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976146"><span class="hs-identifier hs-var">work_item</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976148"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976149"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976150"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-2010"></span><span>
</span><span id="line-2011"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2012"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681976153"><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976153"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; CtLoc -&gt; TcS ClsInstResult
</span><a href="GHC.Tc.Solver.Interact.html#matchLocalInst"><span class="hs-identifier hs-var">matchLocalInst</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976151"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976155"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-2013"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976153"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2014"></span><span>           </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#OneInst"><span class="hs-identifier hs-type">OneInst</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; ClsInstResult -&gt; TcS (StopOrContinue Ct)
</span><a href="GHC.Tc.Solver.Interact.html#chooseInstance"><span class="hs-identifier hs-var">chooseInstance</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976147"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976153"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-2015"></span><span>           </span><span class="annot"><span class="annottext">ClsInstResult
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976146"><span class="hs-identifier hs-var">work_item</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2016"></span><span>
</span><span id="line-2017"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2018"></span><span>    </span><span id="local-6989586621681976147"><span class="annot"><span class="annottext">ev :: CtEvidence
</span><a href="#local-6989586621681976147"><span class="hs-identifier hs-var hs-var">ev</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976146"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2019"></span><span>    </span><span id="local-6989586621681976155"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621681976155"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976147"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-2020"></span><span>    </span><span id="local-6989586621681976151"><span class="annot"><span class="annottext">pred :: TcPredType
</span><a href="#local-6989586621681976151"><span class="hs-identifier hs-var hs-var">pred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976147"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-2021"></span><span>
</span><span id="line-2022"></span><span class="annot"><span class="hs-comment">{-********************************************************************
*                                                                    *
          Top-level reaction for equality constraints (CEqCan)
*                                                                    *
********************************************************************-}</span></span><span>
</span><span id="line-2027"></span><span>
</span><span id="line-2028"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#doTopReactEqPred"><span class="hs-identifier hs-type">doTopReactEqPred</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2029"></span><span id="doTopReactEqPred"><span class="annot"><span class="annottext">doTopReactEqPred :: Ct -&gt; EqRel -&gt; TcPredType -&gt; TcPredType -&gt; TcS (StopOrContinue Ct)
</span><a href="GHC.Tc.Solver.Interact.html#doTopReactEqPred"><span class="hs-identifier hs-var hs-var">doTopReactEqPred</span></a></span></span><span> </span><span id="local-6989586621681976157"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976157"><span class="hs-identifier hs-var">work_item</span></a></span></span><span> </span><span id="local-6989586621681976158"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976158"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621681976159"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976159"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621681976160"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976160"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2030"></span><span>  </span><span class="hs-comment">-- See Note [Looking up primitive equalities in quantified constraints]</span><span>
</span><span id="line-2031"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681976161"><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621681976161"><span class="hs-identifier hs-var">ev_binds_var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS EvBindsVar
</span><a href="GHC.Tc.Solver.Monad.html#getTcEvBindsVar"><span class="hs-identifier hs-var">getTcEvBindsVar</span></a></span><span>
</span><span id="line-2032"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681976162"><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681976162"><span class="hs-identifier hs-var">ics</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS InertCans
</span><a href="GHC.Tc.Solver.Monad.html#getInertCans"><span class="hs-identifier hs-var">getInertCans</span></a></span><span>
</span><span id="line-2033"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isWanted"><span class="hs-identifier hs-var">isWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976164"><span class="hs-identifier hs-var">ev</span></a></span><span>                       </span><span class="hs-comment">-- Never look up Givens in quantified constraints</span><span>
</span><span id="line-2034"></span><span>         </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[QCInst] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InertCans -&gt; [QCInst]
</span><a href="GHC.Tc.Solver.InertSet.html#inert_insts"><span class="hs-identifier hs-var">inert_insts</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681976162"><span class="hs-identifier hs-var">ics</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Shortcut common case</span><span>
</span><span id="line-2035"></span><span>         </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EvBindsVar -&gt; Bool
</span><a href="GHC.Tc.Types.Evidence.html#isCoEvBindsVar"><span class="hs-identifier hs-var">isCoEvBindsVar</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindsVar
</span><a href="#local-6989586621681976161"><span class="hs-identifier hs-var">ev_binds_var</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Instances in no-evidence implications]</span><span>
</span><span id="line-2036"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue Ct)
</span><a href="#local-6989586621681976166"><span class="hs-identifier hs-var">try_for_qci</span></a></span><span>
</span><span id="line-2037"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976157"><span class="hs-identifier hs-var">work_item</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2038"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2039"></span><span>    </span><span id="local-6989586621681976164"><span class="annot"><span class="annottext">ev :: CtEvidence
</span><a href="#local-6989586621681976164"><span class="hs-identifier hs-var hs-var">ev</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976157"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2040"></span><span>    </span><span id="local-6989586621681976167"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621681976167"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976164"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-2041"></span><span>
</span><span id="line-2042"></span><span>    </span><span id="local-6989586621681976168"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621681976168"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976158"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-2043"></span><span>    </span><span id="local-6989586621681976166"><span class="annot"><span class="annottext">try_for_qci :: TcS (StopOrContinue Ct)
</span><a href="#local-6989586621681976166"><span class="hs-identifier hs-var hs-var">try_for_qci</span></a></span></span><span>  </span><span class="hs-comment">-- First try looking for (lhs ~ rhs)</span><span>
</span><span id="line-2044"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976169"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976169"><span class="hs-identifier hs-var">cls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976170"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976170"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; TcPredType -&gt; TcPredType -&gt; Maybe (Class, [TcPredType])
</span><a href="GHC.Tc.Utils.TcType.html#boxEqPred"><span class="hs-identifier hs-var">boxEqPred</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976158"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976159"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976160"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2045"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681976172"><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976172"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; CtLoc -&gt; TcS ClsInstResult
</span><a href="GHC.Tc.Solver.Interact.html#matchLocalInst"><span class="hs-identifier hs-var">matchLocalInst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [TcPredType] -&gt; TcPredType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976169"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976170"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976167"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-2046"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;final_qci_check:1&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [TcPredType] -&gt; TcPredType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976169"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976170"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2047"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976172"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2048"></span><span>                </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#OneInst"><span class="hs-identifier hs-type">OneInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cir_mk_ev :: ClsInstResult -&gt; [EvExpr] -&gt; EvTerm
</span><a href="GHC.Tc.Instance.Class.html#cir_mk_ev"><span class="hs-identifier hs-var">cir_mk_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976173"><span class="annot"><span class="annottext">[EvExpr] -&gt; EvTerm
</span><a href="#local-6989586621681976173"><span class="hs-identifier hs-var">mk_ev</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2049"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; ClsInstResult -&gt; TcS (StopOrContinue Ct)
</span><a href="GHC.Tc.Solver.Interact.html#chooseInstance"><span class="hs-identifier hs-var">chooseInstance</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976164"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976172"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#cir_mk_ev"><span class="hs-identifier hs-var">cir_mk_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681976174"><span class="hs-identifier hs-type">mk_eq_ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681976169"><span class="hs-identifier hs-type">cls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681976170"><span class="hs-identifier hs-type">tys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681976173"><span class="hs-identifier hs-type">mk_ev</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2050"></span><span>                </span><span class="annot"><span class="annottext">ClsInstResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcS (StopOrContinue Ct)
</span><a href="#local-6989586621681976175"><span class="hs-identifier hs-var">try_swapping</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2051"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2052"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976157"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2053"></span><span>
</span><span id="line-2054"></span><span>    </span><span id="local-6989586621681976175"><span class="annot"><span class="annottext">try_swapping :: TcS (StopOrContinue Ct)
</span><a href="#local-6989586621681976175"><span class="hs-identifier hs-var hs-var">try_swapping</span></a></span></span><span>  </span><span class="hs-comment">-- Now try looking for (rhs ~ lhs)  (see #23333)</span><span>
</span><span id="line-2055"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976176"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976176"><span class="hs-identifier hs-var">cls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976177"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976177"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; TcPredType -&gt; TcPredType -&gt; Maybe (Class, [TcPredType])
</span><a href="GHC.Tc.Utils.TcType.html#boxEqPred"><span class="hs-identifier hs-var">boxEqPred</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621681976158"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976160"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976159"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-2056"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681976178"><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976178"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; CtLoc -&gt; TcS ClsInstResult
</span><a href="GHC.Tc.Solver.Interact.html#matchLocalInst"><span class="hs-identifier hs-var">matchLocalInst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [TcPredType] -&gt; TcPredType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976176"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976177"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976167"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-2057"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;final_qci_check:2&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [TcPredType] -&gt; TcPredType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976176"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976177"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2058"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976178"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2059"></span><span>                </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#OneInst"><span class="hs-identifier hs-type">OneInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cir_mk_ev :: ClsInstResult -&gt; [EvExpr] -&gt; EvTerm
</span><a href="GHC.Tc.Instance.Class.html#cir_mk_ev"><span class="hs-identifier hs-var">cir_mk_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976179"><span class="annot"><span class="annottext">[EvExpr] -&gt; EvTerm
</span><a href="#local-6989586621681976179"><span class="hs-identifier hs-var">mk_ev</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2060"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681976180"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976180"><span class="hs-identifier hs-var">ev'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriterSet
-&gt; CtEvidence
-&gt; SwapFlag
-&gt; Reduction
-&gt; Reduction
-&gt; TcS CtEvidence
</span><a href="GHC.Tc.Solver.Canonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-var">emptyRewriterSet</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976164"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">SwapFlag
</span><a href="GHC.Types.Basic.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a></span><span>
</span><span id="line-2061"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcPredType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681976168"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976160"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TcPredType -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621681976168"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976159"><span class="hs-identifier hs-var">lhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2062"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; ClsInstResult -&gt; TcS (StopOrContinue Ct)
</span><a href="GHC.Tc.Solver.Interact.html#chooseInstance"><span class="hs-identifier hs-var">chooseInstance</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976180"><span class="hs-identifier hs-var">ev'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976178"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#cir_mk_ev"><span class="hs-identifier hs-var">cir_mk_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681976174"><span class="hs-identifier hs-type">mk_eq_ev</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681976176"><span class="hs-identifier hs-type">cls</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681976177"><span class="hs-identifier hs-type">tys</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681976179"><span class="hs-identifier hs-type">mk_ev</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2063"></span><span>                </span><span class="annot"><span class="annottext">ClsInstResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;final_qci_check:3&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976157"><span class="hs-identifier hs-var">work_item</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2064"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976157"><span class="hs-identifier hs-var">work_item</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-2065"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2066"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976157"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2067"></span><span>
</span><span id="line-2068"></span><span>    </span><span id="local-6989586621681976174"><span class="annot"><span class="annottext">mk_eq_ev :: Class -&gt; [TcPredType] -&gt; (t -&gt; EvTerm) -&gt; t -&gt; EvTerm
</span><a href="#local-6989586621681976174"><span class="hs-identifier hs-var hs-var">mk_eq_ev</span></a></span></span><span> </span><span id="local-6989586621681976187"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976187"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621681976188"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976188"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span id="local-6989586621681976189"><span class="annot"><span class="annottext">t -&gt; EvTerm
</span><a href="#local-6989586621681976189"><span class="hs-identifier hs-var">mk_ev</span></a></span></span><span> </span><span id="local-6989586621681976190"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681976190"><span class="hs-identifier hs-var">evs</span></a></span></span><span>
</span><span id="line-2069"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; EvTerm
</span><a href="#local-6989586621681976189"><span class="hs-identifier hs-var">mk_ev</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681976190"><span class="hs-identifier hs-var">evs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2070"></span><span>          </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html#EvExpr"><span class="hs-identifier hs-type">EvExpr</span></a></span><span> </span><span id="local-6989586621681976192"><span class="annot"><span class="annottext">EvExpr
</span><a href="#local-6989586621681976192"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EvExpr -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#EvExpr"><span class="hs-identifier hs-var">EvExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; EvExpr
forall b. TyVar -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976194"><span class="hs-identifier hs-var">sc_id</span></a></span><span> </span><span class="annot"><span class="annottext">EvExpr -&gt; [TcPredType] -&gt; EvExpr
forall b. Expr b -&gt; [TcPredType] -&gt; Expr b
</span><a href="GHC.Core.html#mkTyApps"><span class="hs-operator hs-var">`mkTyApps`</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976188"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">EvExpr -&gt; EvExpr -&gt; EvExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-operator hs-var">`App`</span></a></span><span> </span><span class="annot"><span class="annottext">EvExpr
</span><a href="#local-6989586621681976192"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2071"></span><span>          </span><span id="local-6989586621681976197"><span class="annot"><span class="annottext">EvTerm
</span><a href="#local-6989586621681976197"><span class="hs-identifier hs-var">ev</span></a></span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; EvTerm
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mk_eq_ev&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EvTerm -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">EvTerm
</span><a href="#local-6989586621681976197"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2072"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2073"></span><span>        </span><span class="hs-special">[</span><span id="local-6989586621681976194"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976194"><span class="hs-identifier hs-var">sc_id</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [TyVar]
</span><a href="GHC.Core.Class.html#classSCSelIds"><span class="hs-identifier hs-var">classSCSelIds</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976187"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-2074"></span><span>
</span><span id="line-2075"></span><span class="hs-comment">{- Note [Looking up primitive equalities in quantified constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For equalities (a ~# b) look up (a ~ b), and then do a superclass
selection. This avoids having to support quantified constraints whose
kind is not Constraint, such as (forall a. F a ~# b)

See
 * Note [Evidence for quantified constraints] in GHC.Core.Predicate
 * Note [Equality superclasses in quantified constraints]
   in GHC.Tc.Solver.Canonical

Note [Reverse order of fundep equations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this scenario (from dependent/should_fail/T13135_simple):

  type Sig :: Type -&gt; Type
  data Sig a = SigFun a (Sig a)

  type SmartFun :: forall (t :: Type). Sig t -&gt; Type
  type family SmartFun sig = r | r -&gt; sig where
    SmartFun @Type (SigFun @Type a sig) = a -&gt; SmartFun @Type sig

  [W] SmartFun @kappa sigma ~ (Int -&gt; Bool)

The injectivity of SmartFun allows us to produce two new equalities:

  [W] w1 :: Type ~ kappa
  [W] w2 :: SigFun @Type Int beta ~ sigma

for some fresh (beta :: SigType). The second Wanted here is actually
heterogeneous: the LHS has type Sig Type while the RHS has type Sig kappa.
Of course, if we solve the first wanted first, the second becomes homogeneous.

When looking for injectivity-inspired equalities, we work left-to-right,
producing the two equalities in the order written above. However, these
equalities are then passed into unifyWanted, which will fail, adding these
to the work list. However, crucially, the work list operates like a *stack*.
So, because we add w1 and then w2, we process w2 first. This is silly: solving
w1 would unlock w2. So we make sure to add equalities to the work
list in left-to-right order, which requires a few key calls to 'reverse'.

This treatment is also used for class-based functional dependencies, although
we do not have a program yet known to exhibit a loop there. It just seems
like the right thing to do.

When this was originally conceived, it was necessary to avoid a loop in T13135.
That loop is now avoided by continuing with the kind equality (not the type
equality) in canEqCanLHSHetero (see Note [Equalities with incompatible kinds]
in GHC.Tc.Solver.Canonical). However, the idea of working left-to-right still
seems worthwhile, and so the calls to 'reverse' remain.

-}</span><span>
</span><span id="line-2127"></span><span>
</span><span id="line-2128"></span><span class="hs-comment">--------------------</span><span>
</span><span id="line-2129"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#doTopReactEq"><span class="hs-identifier hs-type">doTopReactEq</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2130"></span><span id="doTopReactEq"><span class="annot"><span class="annottext">doTopReactEq :: SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#doTopReactEq"><span class="hs-identifier hs-var hs-var">doTopReactEq</span></a></span></span><span> </span><span id="local-6989586621681976199"><span class="annot"><span class="annottext">work_item :: Ct
</span><a href="#local-6989586621681976199"><span class="hs-identifier hs-var">work_item</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CEqCan"><span class="hs-identifier hs-type">CEqCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976200"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976200"><span class="hs-identifier hs-var">old_ev</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_lhs :: Ct -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#cc_lhs"><span class="hs-identifier hs-var">cc_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyFamLHS"><span class="hs-identifier hs-type">TyFamLHS</span></a></span><span> </span><span id="local-6989586621681976201"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976201"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621681976202"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976202"><span class="hs-identifier hs-var">args</span></a></span></span><span>
</span><span id="line-2131"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_rhs :: Ct -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#cc_rhs"><span class="hs-identifier hs-var">cc_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976203"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976203"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2132"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TyCon -&gt; [TcPredType] -&gt; TcPredType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#improveTopFunEqs"><span class="hs-identifier hs-var">improveTopFunEqs</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976200"><span class="hs-identifier hs-var">old_ev</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976201"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976202"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976203"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2133"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#doTopReactOther"><span class="hs-identifier hs-var">doTopReactOther</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976199"><span class="hs-identifier hs-var">work_item</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2134"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#doTopReactEq"><span class="hs-identifier hs-var">doTopReactEq</span></a></span><span> </span><span id="local-6989586621681976205"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976205"><span class="hs-identifier hs-var">work_item</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#doTopReactOther"><span class="hs-identifier hs-var">doTopReactOther</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976205"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2135"></span><span>
</span><span id="line-2136"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#improveTopFunEqs"><span class="hs-identifier hs-type">improveTopFunEqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2137"></span><span class="hs-comment">-- See Note [FunDep and implicit parameter reactions]</span><span>
</span><span id="line-2138"></span><span id="improveTopFunEqs"><span class="annot"><span class="annottext">improveTopFunEqs :: CtEvidence -&gt; TyCon -&gt; [TcPredType] -&gt; TcPredType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#improveTopFunEqs"><span class="hs-identifier hs-var hs-var">improveTopFunEqs</span></a></span></span><span> </span><span id="local-6989586621681976206"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976206"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621681976207"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976207"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621681976208"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976208"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681976209"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976209"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-2139"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976206"><span class="hs-identifier hs-var">ev</span></a></span><span>  </span><span class="hs-comment">-- See Note [No Given/Given fundeps]</span><span>
</span><span id="line-2140"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TcS ()
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2141"></span><span>
</span><span id="line-2142"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2143"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681976210"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621681976210"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS (FamInstEnv, FamInstEnv)
</span><a href="GHC.Tc.Solver.Monad.html#getFamInstEnvs"><span class="hs-identifier hs-var">getFamInstEnvs</span></a></span><span>
</span><span id="line-2144"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681976212"><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621681976212"><span class="hs-identifier hs-var">eqns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
-&gt; TyCon -&gt; [TcPredType] -&gt; TcPredType -&gt; TcS [TypeEqn]
</span><a href="GHC.Tc.Solver.Interact.html#improve_top_fun_eqs"><span class="hs-identifier hs-var">improve_top_fun_eqs</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621681976210"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976207"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976208"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976209"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2145"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;improveTopFunEqs&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976207"><span class="hs-identifier hs-var">fam_tc</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976208"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976209"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2146"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TypeEqn] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621681976212"><span class="hs-identifier hs-var">eqns</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2147"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(TypeEqn -&gt; TcS TcCoercion) -&gt; [TypeEqn] -&gt; TcS ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#mapM_/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621681976214"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976214"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681976215"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976215"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RewriterSet
-&gt; CtLoc -&gt; Role -&gt; TcPredType -&gt; TcPredType -&gt; TcS TcCoercion
</span><a href="GHC.Tc.Solver.Canonical.html#unifyWanted"><span class="hs-identifier hs-var">unifyWanted</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621681976216"><span class="hs-identifier hs-var">rewriters</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976217"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976214"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976215"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2148"></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TypeEqn] -&gt; [TypeEqn]
forall a. [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#reverse/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeEqn]
</span><a href="#local-6989586621681976212"><span class="hs-identifier hs-var">eqns</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2149"></span><span>         </span><span class="hs-comment">-- Missing that `reverse` causes T13135 and T13135_simple to loop.</span><span>
</span><span id="line-2150"></span><span>         </span><span class="hs-comment">-- See Note [Reverse order of fundep equations]</span><span>
</span><span id="line-2151"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2152"></span><span>    </span><span id="local-6989586621681976217"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621681976217"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#bumpCtLocDepth"><span class="hs-identifier hs-var">bumpCtLocDepth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976206"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2153"></span><span>        </span><span class="hs-comment">-- ToDo: this location is wrong; it should be FunDepOrigin2</span><span>
</span><span id="line-2154"></span><span>        </span><span class="hs-comment">-- See #14778</span><span>
</span><span id="line-2155"></span><span>    </span><span id="local-6989586621681976216"><span class="annot"><span class="annottext">rewriters :: RewriterSet
</span><a href="#local-6989586621681976216"><span class="hs-identifier hs-var hs-var">rewriters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#ctEvRewriters"><span class="hs-identifier hs-var">ctEvRewriters</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976206"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-2156"></span><span>
</span><span id="line-2157"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#improve_top_fun_eqs"><span class="hs-identifier hs-type">improve_top_fun_eqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-2158"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-2159"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#TypeEqn"><span class="hs-identifier hs-type">TypeEqn</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2160"></span><span id="improve_top_fun_eqs"><span class="annot"><span class="annottext">improve_top_fun_eqs :: (FamInstEnv, FamInstEnv)
-&gt; TyCon -&gt; [TcPredType] -&gt; TcPredType -&gt; TcS [TypeEqn]
</span><a href="GHC.Tc.Solver.Interact.html#improve_top_fun_eqs"><span class="hs-identifier hs-var hs-var">improve_top_fun_eqs</span></a></span></span><span> </span><span id="local-6989586621681976220"><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621681976220"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span id="local-6989586621681976221"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976221"><span class="hs-identifier hs-var">fam_tc</span></a></span></span><span> </span><span id="local-6989586621681976222"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976222"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681976223"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976223"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span>
</span><span id="line-2161"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681976224"><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621681976224"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe BuiltInSynFamily
</span><a href="GHC.Core.TyCon.html#isBuiltInSynFamTyCon_maybe"><span class="hs-identifier hs-var">isBuiltInSynFamTyCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976221"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-2162"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeEqn] -&gt; TcS [TypeEqn]
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuiltInSynFamily -&gt; [TcPredType] -&gt; TcPredType -&gt; [TypeEqn]
</span><a href="GHC.Core.Coercion.Axiom.html#sfInteractTop"><span class="hs-identifier hs-var">sfInteractTop</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltInSynFamily
</span><a href="#local-6989586621681976224"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976222"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976223"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2163"></span><span>
</span><span id="line-2164"></span><span>  </span><span class="hs-comment">-- see Note [Type inference for type families with injectivity]</span><span>
</span><span id="line-2165"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isOpenTypeFamilyTyCon"><span class="hs-identifier hs-var">isOpenTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976221"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-2166"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#Injective"><span class="hs-identifier hs-type">Injective</span></a></span><span> </span><span id="local-6989586621681976226"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681976226"><span class="hs-identifier hs-var">injective_args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Injectivity
</span><a href="GHC.Core.TyCon.html#tyConInjectivityInfo"><span class="hs-identifier hs-var">tyConInjectivityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976221"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-2167"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681976227"><span class="annot"><span class="annottext">fam_insts :: [FamInst]
</span><a href="#local-6989586621681976227"><span class="hs-identifier hs-var hs-var">fam_insts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv) -&gt; TyCon -&gt; [FamInst]
</span><a href="GHC.Core.FamInstEnv.html#lookupFamInstEnvByTyCon"><span class="hs-identifier hs-var">lookupFamInstEnvByTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">(FamInstEnv, FamInstEnv)
</span><a href="#local-6989586621681976220"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976221"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-2168"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- it is possible to have several compatible equations in an open type</span><span>
</span><span id="line-2169"></span><span>    </span><span class="hs-comment">-- family but we only want to derive equalities from one such equation.</span><span>
</span><span id="line-2170"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681976229"><span class="annot"><span class="annottext">improvs :: [([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
</span><a href="#local-6989586621681976229"><span class="hs-identifier hs-var hs-var">improvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FamInst]
-&gt; (FamInst -&gt; [TyVar])
-&gt; (FamInst -&gt; [TcPredType])
-&gt; (FamInst -&gt; TcPredType)
-&gt; (FamInst -&gt; Maybe CoAxBranch)
-&gt; [([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
forall a.
[a]
-&gt; (a -&gt; [TyVar])
-&gt; (a -&gt; [TcPredType])
-&gt; (a -&gt; TcPredType)
-&gt; (a -&gt; Maybe CoAxBranch)
-&gt; [([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
</span><a href="#local-6989586621681976230"><span class="hs-identifier hs-var">buildImprovementData</span></a></span><span> </span><span class="annot"><span class="annottext">[FamInst]
</span><a href="#local-6989586621681976227"><span class="hs-identifier hs-var">fam_insts</span></a></span><span>
</span><span id="line-2171"></span><span>                           </span><span class="annot"><span class="annottext">FamInst -&gt; [TyVar]
</span><a href="GHC.Core.FamInstEnv.html#fi_tvs"><span class="hs-identifier hs-var">fi_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; [TcPredType]
</span><a href="GHC.Core.FamInstEnv.html#fi_tys"><span class="hs-identifier hs-var">fi_tys</span></a></span><span> </span><span class="annot"><span class="annottext">FamInst -&gt; TcPredType
</span><a href="GHC.Core.FamInstEnv.html#fi_rhs"><span class="hs-identifier hs-var">fi_rhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe CoAxBranch -&gt; FamInst -&gt; Maybe CoAxBranch
forall a b. a -&gt; b -&gt; a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#const/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CoAxBranch
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2172"></span><span>
</span><span id="line-2173"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;improve_top_fun_eqs2&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[([TcPredType], Subst, [TyVar], Maybe CoAxBranch)] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
</span><a href="#local-6989586621681976229"><span class="hs-identifier hs-var">improvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2174"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(([TcPredType], Subst, [TyVar], Maybe CoAxBranch) -&gt; TcS [TypeEqn])
-&gt; [([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
-&gt; TcS [TypeEqn]
forall (m :: * -&gt; *) (f :: * -&gt; *) a b.
(Monad m, Traversable f) =&gt;
(a -&gt; m [b]) -&gt; f a -&gt; m [b]
</span><a href="GHC.Utils.Monad.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Bool]
-&gt; ([TcPredType], Subst, [TyVar], Maybe CoAxBranch)
-&gt; TcS [TypeEqn]
</span><a href="#local-6989586621681976235"><span class="hs-identifier hs-var">injImproveEqns</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681976226"><span class="hs-identifier hs-var">injective_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
 -&gt; TcS [TypeEqn])
-&gt; [([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
-&gt; TcS [TypeEqn]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2175"></span><span>         </span><span class="annot"><span class="annottext">ScDepth
-&gt; [([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
-&gt; [([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
forall a. ScDepth -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#take/GHC.List.html#take"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="annot"><span class="annottext">ScDepth
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">[([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
</span><a href="#local-6989586621681976229"><span class="hs-identifier hs-var">improvs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2176"></span><span>
</span><span id="line-2177"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681976237"><span class="annot"><span class="annottext">CoAxiom Branched
</span><a href="#local-6989586621681976237"><span class="hs-identifier hs-var">ax</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe (CoAxiom Branched)
</span><a href="GHC.Core.TyCon.html#isClosedSynFamilyTyConWithAxiom_maybe"><span class="hs-identifier hs-var">isClosedSynFamilyTyConWithAxiom_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976221"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-2178"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#Injective"><span class="hs-identifier hs-type">Injective</span></a></span><span> </span><span id="local-6989586621681976239"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681976239"><span class="hs-identifier hs-var">injective_args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Injectivity
</span><a href="GHC.Core.TyCon.html#tyConInjectivityInfo"><span class="hs-identifier hs-var">tyConInjectivityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681976221"><span class="hs-identifier hs-var">fam_tc</span></a></span><span>
</span><span id="line-2179"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([TcPredType], Subst, [TyVar], Maybe CoAxBranch) -&gt; TcS [TypeEqn])
-&gt; [([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
-&gt; TcS [TypeEqn]
forall (m :: * -&gt; *) (f :: * -&gt; *) a b.
(Monad m, Traversable f) =&gt;
(a -&gt; m [b]) -&gt; f a -&gt; m [b]
</span><a href="GHC.Utils.Monad.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Bool]
-&gt; ([TcPredType], Subst, [TyVar], Maybe CoAxBranch)
-&gt; TcS [TypeEqn]
</span><a href="#local-6989586621681976235"><span class="hs-identifier hs-var">injImproveEqns</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681976239"><span class="hs-identifier hs-var">injective_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
 -&gt; TcS [TypeEqn])
-&gt; [([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
-&gt; TcS [TypeEqn]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2180"></span><span>    </span><span class="annot"><span class="annottext">[CoAxBranch]
-&gt; (CoAxBranch -&gt; [TyVar])
-&gt; (CoAxBranch -&gt; [TcPredType])
-&gt; (CoAxBranch -&gt; TcPredType)
-&gt; (CoAxBranch -&gt; Maybe CoAxBranch)
-&gt; [([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
forall a.
[a]
-&gt; (a -&gt; [TyVar])
-&gt; (a -&gt; [TcPredType])
-&gt; (a -&gt; TcPredType)
-&gt; (a -&gt; Maybe CoAxBranch)
-&gt; [([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
</span><a href="#local-6989586621681976230"><span class="hs-identifier hs-var">buildImprovementData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Branches Branched -&gt; [CoAxBranch]
forall (br :: BranchFlag). Branches br -&gt; [CoAxBranch]
</span><a href="GHC.Core.Coercion.Axiom.html#fromBranches"><span class="hs-identifier hs-var">fromBranches</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoAxiom Branched -&gt; Branches Branched
forall (br :: BranchFlag). CoAxiom br -&gt; Branches br
</span><a href="GHC.Core.Coercion.Axiom.html#co_ax_branches"><span class="hs-identifier hs-var">co_ax_branches</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxiom Branched
</span><a href="#local-6989586621681976237"><span class="hs-identifier hs-var">ax</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2181"></span><span>                         </span><span class="annot"><span class="annottext">CoAxBranch -&gt; [TyVar]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_tvs"><span class="hs-identifier hs-var">cab_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; [TcPredType]
</span><a href="GHC.Core.Coercion.Axiom.html#cab_lhs"><span class="hs-identifier hs-var">cab_lhs</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; TcPredType
</span><a href="GHC.Core.Coercion.Axiom.html#cab_rhs"><span class="hs-identifier hs-var">cab_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">CoAxBranch -&gt; Maybe CoAxBranch
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span>
</span><span id="line-2182"></span><span>
</span><span id="line-2183"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2184"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeEqn] -&gt; TcS [TypeEqn]
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2185"></span><span>
</span><span id="line-2186"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2187"></span><span>      </span><span id="local-6989586621681976244"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621681976244"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPredType -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976223"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2188"></span><span>
</span><span id="line-2189"></span><span>      </span><span id="local-6989586621681974929"><span class="annot"><a href="#local-6989586621681976230"><span class="hs-identifier hs-type">buildImprovementData</span></a></span><span>
</span><span id="line-2190"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681974929"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span>                     </span><span class="hs-comment">-- axioms for a TF (FamInst or CoAxBranch)</span><span>
</span><span id="line-2191"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681974929"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- get bound tyvars of an axiom</span><span>
</span><span id="line-2192"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681974929"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- get LHS of an axiom</span><span>
</span><span id="line-2193"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681974929"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>             </span><span class="hs-comment">-- get RHS of an axiom</span><span>
</span><span id="line-2194"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681974929"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Just =&gt; apartness check required</span><span>
</span><span id="line-2195"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span> </span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-2196"></span><span>             </span><span class="hs-comment">-- Result:</span><span>
</span><span id="line-2197"></span><span>             </span><span class="hs-comment">-- ( [arguments of a matching axiom]</span><span>
</span><span id="line-2198"></span><span>             </span><span class="hs-comment">-- , RHS-unifying substitution</span><span>
</span><span id="line-2199"></span><span>             </span><span class="hs-comment">-- , axiom variables without substitution</span><span>
</span><span id="line-2200"></span><span>             </span><span class="hs-comment">-- , Maybe matching axiom [Nothing - open TF, Just - closed TF ] )</span><span>
</span><span id="line-2201"></span><span>      </span><span id="local-6989586621681976230"><span class="annot"><span class="annottext">buildImprovementData :: forall a.
[a]
-&gt; (a -&gt; [TyVar])
-&gt; (a -&gt; [TcPredType])
-&gt; (a -&gt; TcPredType)
-&gt; (a -&gt; Maybe CoAxBranch)
-&gt; [([TcPredType], Subst, [TyVar], Maybe CoAxBranch)]
</span><a href="#local-6989586621681976230"><span class="hs-identifier hs-var hs-var">buildImprovementData</span></a></span></span><span> </span><span id="local-6989586621681976249"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621681976249"><span class="hs-identifier hs-var">axioms</span></a></span></span><span> </span><span id="local-6989586621681976250"><span class="annot"><span class="annottext">a -&gt; [TyVar]
</span><a href="#local-6989586621681976250"><span class="hs-identifier hs-var">axiomTVs</span></a></span></span><span> </span><span id="local-6989586621681976251"><span class="annot"><span class="annottext">a -&gt; [TcPredType]
</span><a href="#local-6989586621681976251"><span class="hs-identifier hs-var">axiomLHS</span></a></span></span><span> </span><span id="local-6989586621681976252"><span class="annot"><span class="annottext">a -&gt; TcPredType
</span><a href="#local-6989586621681976252"><span class="hs-identifier hs-var">axiomRHS</span></a></span></span><span> </span><span id="local-6989586621681976253"><span class="annot"><span class="annottext">a -&gt; Maybe CoAxBranch
</span><a href="#local-6989586621681976253"><span class="hs-identifier hs-var">wrap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2202"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976254"><span class="hs-identifier hs-var">ax_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976255"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976256"><span class="hs-identifier hs-var">unsubstTvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe CoAxBranch
</span><a href="#local-6989586621681976253"><span class="hs-identifier hs-var">wrap</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681976257"><span class="hs-identifier hs-var">axiom</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2203"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681976257"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681976257"><span class="hs-identifier hs-var">axiom</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621681976249"><span class="hs-identifier hs-var">axioms</span></a></span><span>
</span><span id="line-2204"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681976254"><span class="annot"><span class="annottext">ax_args :: [TcPredType]
</span><a href="#local-6989586621681976254"><span class="hs-identifier hs-var hs-var">ax_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; [TcPredType]
</span><a href="#local-6989586621681976251"><span class="hs-identifier hs-var">axiomLHS</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681976257"><span class="hs-identifier hs-var">axiom</span></a></span><span>
</span><span id="line-2205"></span><span>                </span><span id="local-6989586621681976258"><span class="annot"><span class="annottext">ax_rhs :: TcPredType
</span><a href="#local-6989586621681976258"><span class="hs-identifier hs-var hs-var">ax_rhs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; TcPredType
</span><a href="#local-6989586621681976252"><span class="hs-identifier hs-var">axiomRHS</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681976257"><span class="hs-identifier hs-var">axiom</span></a></span><span>
</span><span id="line-2206"></span><span>                </span><span id="local-6989586621681976259"><span class="annot"><span class="annottext">ax_tvs :: [TyVar]
</span><a href="#local-6989586621681976259"><span class="hs-identifier hs-var hs-var">ax_tvs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; [TyVar]
</span><a href="#local-6989586621681976250"><span class="hs-identifier hs-var">axiomTVs</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681976257"><span class="hs-identifier hs-var">axiom</span></a></span><span>
</span><span id="line-2207"></span><span>                </span><span id="local-6989586621681976260"><span class="annot"><span class="annottext">in_scope1 :: InScopeSet
</span><a href="#local-6989586621681976260"><span class="hs-identifier hs-var hs-var">in_scope1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681976244"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [TyVar] -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSetList"><span class="hs-operator hs-var">`extendInScopeSetList`</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976259"><span class="hs-identifier hs-var">ax_tvs</span></a></span><span>
</span><span id="line-2208"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681976255"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976255"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Bool -&gt; InScopeSet -&gt; TcPredType -&gt; TcPredType -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcUnifyTyWithTFs"><span class="hs-identifier hs-var">tcUnifyTyWithTFs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681976260"><span class="hs-identifier hs-var">in_scope1</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976258"><span class="hs-identifier hs-var">ax_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976223"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2209"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681976262"><span class="annot"><span class="annottext">notInSubst :: TyVar -&gt; Bool
</span><a href="#local-6989586621681976262"><span class="hs-identifier hs-var hs-var">notInSubst</span></a></span></span><span> </span><span id="local-6989586621681976263"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976263"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976263"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; VarEnv TcPredType -&gt; Bool
forall a. TyVar -&gt; VarEnv a -&gt; Bool
</span><a href="GHC.Types.Var.Env.html#elemVarEnv"><span class="hs-operator hs-var">`elemVarEnv`</span></a></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; VarEnv TcPredType
</span><a href="GHC.Core.TyCo.Subst.html#getTvSubstEnv"><span class="hs-identifier hs-var">getTvSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976255"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2210"></span><span>                </span><span id="local-6989586621681976256"><span class="annot"><span class="annottext">unsubstTvs :: [TyVar]
</span><a href="#local-6989586621681976256"><span class="hs-identifier hs-var hs-var">unsubstTvs</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; Bool) -&gt; [TyVar] -&gt; [TyVar]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#filter/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="#local-6989586621681976262"><span class="hs-identifier hs-var">notInSubst</span></a></span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; Bool) -&gt; (TyVar -&gt; Bool) -&gt; TyVar -&gt; Bool
forall (f :: * -&gt; *). Applicative f =&gt; f Bool -&gt; f Bool -&gt; f Bool
</span><a href="GHC.Utils.Misc.html#%3C%26%26%3E"><span class="hs-operator hs-var">&lt;&amp;&amp;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976259"><span class="hs-identifier hs-var">ax_tvs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2211"></span><span>                   </span><span class="hs-comment">-- The order of unsubstTvs is important; it must be</span><span>
</span><span id="line-2212"></span><span>                   </span><span class="hs-comment">-- in telescope order e.g. (k:*) (a:k)</span><span>
</span><span id="line-2213"></span><span>
</span><span id="line-2214"></span><span>      </span><span class="annot"><a href="#local-6989586621681976235"><span class="hs-identifier hs-type">injImproveEqns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span>
</span><span id="line-2215"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2216"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.Coercion.Axiom.html#TypeEqn"><span class="hs-identifier hs-type">TypeEqn</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2217"></span><span>      </span><span id="local-6989586621681976235"><span class="annot"><span class="annottext">injImproveEqns :: [Bool]
-&gt; ([TcPredType], Subst, [TyVar], Maybe CoAxBranch)
-&gt; TcS [TypeEqn]
</span><a href="#local-6989586621681976235"><span class="hs-identifier hs-var hs-var">injImproveEqns</span></a></span></span><span> </span><span id="local-6989586621681976269"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681976269"><span class="hs-identifier hs-var">inj_args</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976270"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976270"><span class="hs-identifier hs-var">ax_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976271"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976271"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976272"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976272"><span class="hs-identifier hs-var">unsubstTvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976273"><span class="annot"><span class="annottext">Maybe CoAxBranch
</span><a href="#local-6989586621681976273"><span class="hs-identifier hs-var">cabr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2218"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681976274"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976274"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [TyVar] -&gt; TcS Subst
</span><a href="GHC.Tc.Solver.Monad.html#instFlexiX"><span class="hs-identifier hs-var">instFlexiX</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976271"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976272"><span class="hs-identifier hs-var">unsubstTvs</span></a></span><span>
</span><span id="line-2219"></span><span>                  </span><span class="hs-comment">-- If the current substitution bind [k -&gt; *], and</span><span>
</span><span id="line-2220"></span><span>                  </span><span class="hs-comment">-- one of the un-substituted tyvars is (a::k), we'd better</span><span>
</span><span id="line-2221"></span><span>                  </span><span class="hs-comment">-- be sure to apply the current substitution to a's kind.</span><span>
</span><span id="line-2222"></span><span>                  </span><span class="hs-comment">-- Hence instFlexiX.   #13135 was an example.</span><span>
</span><span id="line-2223"></span><span>
</span><span id="line-2224"></span><span>             </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[TypeEqn] -&gt; TcS [TypeEqn]
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; TcPredType -&gt; TypeEqn
forall a. a -&gt; a -&gt; Pair a
</span><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; TcPredType -&gt; TcPredType
Subst -&gt; TcPredType -&gt; TcPredType
</span><a href="GHC.Core.TyCo.Subst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976274"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976276"><span class="hs-identifier hs-var">ax_arg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976277"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-2225"></span><span>                        </span><span class="hs-comment">-- NB: the ax_arg part is on the left</span><span>
</span><span id="line-2226"></span><span>                        </span><span class="hs-comment">-- see Note [Improvement orientation]</span><span>
</span><span id="line-2227"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CoAxBranch
</span><a href="#local-6989586621681976273"><span class="hs-identifier hs-var">cabr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2228"></span><span>                          </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681976278"><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621681976278"><span class="hs-identifier hs-var">cabr'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[TcPredType] -&gt; CoAxBranch -&gt; Bool
</span><a href="GHC.Core.FamInstEnv.html#apartnessCheck"><span class="hs-identifier hs-var">apartnessCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; [TcPredType] -&gt; [TcPredType]
Subst -&gt; [TcPredType] -&gt; [TcPredType]
</span><a href="GHC.Core.TyCo.Subst.html#substTys"><span class="hs-identifier hs-var">substTys</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976274"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976270"><span class="hs-identifier hs-var">ax_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoAxBranch
</span><a href="#local-6989586621681976278"><span class="hs-identifier hs-var">cabr'</span></a></span><span>
</span><span id="line-2229"></span><span>                          </span><span class="annot"><span class="annottext">Maybe CoAxBranch
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2230"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976276"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976276"><span class="hs-identifier hs-var">ax_arg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976277"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976277"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcPredType]
-&gt; [TcPredType] -&gt; [Bool] -&gt; [(TcPredType, TcPredType, Bool)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#zip3/GHC.List.html#zip3"><span class="hs-identifier hs-var">zip3</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976270"><span class="hs-identifier hs-var">ax_args</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976222"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621681976269"><span class="hs-identifier hs-var">inj_args</span></a></span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2231"></span><span>
</span><span id="line-2232"></span><span class="hs-comment">{-
Note [MATCHING-SYNONYMS]
~~~~~~~~~~~~~~~~~~~~~~~~
When trying to match a dictionary (D tau) to a top-level instance, or a
type family equation (F taus_1 ~ tau_2) to a top-level family instance,
we do *not* need to expand type synonyms because the matcher will do that for us.

Note [Improvement orientation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See also Note [Fundeps with instances, and equality orientation], which describes
the Exact Same Prolem, with the same solution, but for functional dependencies.

A very delicate point is the orientation of equalities
arising from injectivity improvement (#12522).  Suppose we have
  type family F x = t | t -&gt; x
  type instance F (a, Int) = (Int, G a)
where G is injective; and wanted constraints

  [W] TF (alpha, beta) ~ fuv
  [W] fuv ~ (Int, &lt;some type&gt;)

The injectivity will give rise to constraints

  [W] gamma1 ~ alpha
  [W] Int ~ beta

The fresh unification variable gamma1 comes from the fact that we
can only do &quot;partial improvement&quot; here; see Section 5.2 of
&quot;Injective type families for Haskell&quot; (HS'15).

Now, it's very important to orient the equations this way round,
so that the fresh unification variable will be eliminated in
favour of alpha.  If we instead had
   [W] alpha ~ gamma1
then we would unify alpha := gamma1; and kick out the wanted
constraint.  But when we grough it back in, it'd look like
   [W] TF (gamma1, beta) ~ fuv
and exactly the same thing would happen again!  Infinite loop.

This all seems fragile, and it might seem more robust to avoid
introducing gamma1 in the first place, in the case where the
actual argument (alpha, beta) partly matches the improvement
template.  But that's a bit tricky, esp when we remember that the
kinds much match too; so it's easier to let the normal machinery
handle it.  Instead we are careful to orient the new
equality with the template on the left.  Delicate, but it works.

-}</span><span>
</span><span id="line-2280"></span><span>
</span><span id="line-2281"></span><span class="annot"><span class="hs-comment">{- *******************************************************************
*                                                                    *
         Top-level reaction for class constraints (CDictCan)
*                                                                    *
**********************************************************************-}</span></span><span>
</span><span id="line-2286"></span><span>
</span><span id="line-2287"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#doTopReactDict"><span class="hs-identifier hs-type">doTopReactDict</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2288"></span><span class="hs-comment">-- Try to use type-class instance declarations to simplify the constraint</span><span>
</span><span id="line-2289"></span><span id="doTopReactDict"><span class="annot"><span class="annottext">doTopReactDict :: InertSet -&gt; SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#doTopReactDict"><span class="hs-identifier hs-var hs-var">doTopReactDict</span></a></span></span><span> </span><span id="local-6989586621681976281"><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976281"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span id="local-6989586621681976282"><span class="annot"><span class="annottext">work_item :: Ct
</span><a href="#local-6989586621681976282"><span class="hs-identifier hs-var">work_item</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CDictCan"><span class="hs-identifier hs-type">CDictCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976283"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976283"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_class :: Ct -&gt; Class
</span><a href="GHC.Tc.Types.Constraint.html#cc_class"><span class="hs-identifier hs-var">cc_class</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976284"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976284"><span class="hs-identifier hs-var">cls</span></a></span></span><span>
</span><span id="line-2290"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_tyargs :: Ct -&gt; [TcPredType]
</span><a href="GHC.Tc.Types.Constraint.html#cc_tyargs"><span class="hs-identifier hs-var">cc_tyargs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976285"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976285"><span class="hs-identifier hs-var">xis</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2291"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976283"><span class="hs-identifier hs-var">ev</span></a></span><span>   </span><span class="hs-comment">-- Never use instances for Given constraints</span><span>
</span><span id="line-2292"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976282"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2293"></span><span>     </span><span class="hs-comment">-- See Note [No Given/Given fundeps]</span><span>
</span><span id="line-2294"></span><span>
</span><span id="line-2295"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681976286"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976286"><span class="hs-identifier hs-var">solved_ev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InertSet -&gt; CtLoc -&gt; Class -&gt; [TcPredType] -&gt; Maybe CtEvidence
</span><a href="GHC.Tc.Solver.Monad.html#lookupSolvedDict"><span class="hs-identifier hs-var">lookupSolvedDict</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976281"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976288"><span class="hs-identifier hs-var">dict_loc</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976284"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976285"><span class="hs-identifier hs-var">xis</span></a></span><span>   </span><span class="hs-comment">-- Cached</span><span>
</span><span id="line-2296"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976283"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm
</span><a href="GHC.Tc.Types.Constraint.html#ctEvTerm"><span class="hs-identifier hs-var">ctEvTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976286"><span class="hs-identifier hs-var">solved_ev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2297"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; String -&gt; TcS (StopOrContinue Ct)
forall a. CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976283"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Dict/Top (cached)&quot;</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2298"></span><span>
</span><span id="line-2299"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>  </span><span class="hs-comment">-- Wanted, but not cached</span><span>
</span><span id="line-2300"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681976289"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681976289"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.Session.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-2301"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681976290"><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976290"><span class="hs-identifier hs-var">lkup_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DynFlags
-&gt; InertSet -&gt; Class -&gt; [TcPredType] -&gt; CtLoc -&gt; TcS ClsInstResult
</span><a href="GHC.Tc.Solver.Interact.html#matchClassInst"><span class="hs-identifier hs-var">matchClassInst</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681976289"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976281"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976284"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976285"><span class="hs-identifier hs-var">xis</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976288"><span class="hs-identifier hs-var">dict_loc</span></a></span><span>
</span><span id="line-2302"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976290"><span class="hs-identifier hs-var">lkup_res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2303"></span><span>               </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#OneInst"><span class="hs-identifier hs-type">OneInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cir_what :: ClsInstResult -&gt; InstanceWhat
</span><a href="GHC.Tc.Instance.Class.html#cir_what"><span class="hs-identifier hs-var">cir_what</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976292"><span class="annot"><span class="annottext">InstanceWhat
</span><a href="#local-6989586621681976292"><span class="hs-identifier hs-var">what</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2304"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">InstanceWhat -&gt; Ct -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#insertSafeOverlapFailureTcS"><span class="hs-identifier hs-var">insertSafeOverlapFailureTcS</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceWhat
</span><a href="#local-6989586621681976292"><span class="hs-identifier hs-var">what</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976282"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2305"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">InstanceWhat -&gt; CtEvidence -&gt; Class -&gt; [TcPredType] -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#addSolvedDict"><span class="hs-identifier hs-var">addSolvedDict</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceWhat
</span><a href="#local-6989586621681976292"><span class="hs-identifier hs-var">what</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976283"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976284"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976285"><span class="hs-identifier hs-var">xis</span></a></span><span>
</span><span id="line-2306"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; ClsInstResult -&gt; TcS (StopOrContinue Ct)
</span><a href="GHC.Tc.Solver.Interact.html#chooseInstance"><span class="hs-identifier hs-var">chooseInstance</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976283"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976290"><span class="hs-identifier hs-var">lkup_res</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2307"></span><span>               </span><span class="annot"><span class="annottext">ClsInstResult
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- NoInstance or NotSure</span><span>
</span><span id="line-2308"></span><span>                     </span><span class="hs-comment">-- We didn't solve it; so try functional dependencies with</span><span>
</span><span id="line-2309"></span><span>                     </span><span class="hs-comment">-- the instance environment</span><span>
</span><span id="line-2310"></span><span>                     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Interact.html#doTopFundepImprovement"><span class="hs-identifier hs-var">doTopFundepImprovement</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976282"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2311"></span><span>                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">InertSet -&gt; SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#tryLastResortProhibitedSuperclass"><span class="hs-identifier hs-var">tryLastResortProhibitedSuperclass</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976281"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976282"><span class="hs-identifier hs-var">work_item</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2312"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-2313"></span><span>     </span><span id="local-6989586621681976288"><span class="annot"><span class="annottext">dict_loc :: CtLoc
</span><a href="#local-6989586621681976288"><span class="hs-identifier hs-var hs-var">dict_loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976283"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-2314"></span><span>
</span><span id="line-2315"></span><span>
</span><span id="line-2316"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#doTopReactDict"><span class="hs-identifier hs-var">doTopReactDict</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681976296"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976296"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS (StopOrContinue Ct)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doTopReactDict&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976296"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2317"></span><span>
</span><span id="line-2318"></span><span class="hs-comment">-- | As a last resort, we TEMPORARILY allow a prohibited superclass solve,</span><span>
</span><span id="line-2319"></span><span class="hs-comment">-- emitting a loud warning when doing so: we might be creating non-terminating</span><span>
</span><span id="line-2320"></span><span class="hs-comment">-- evidence (as we are in T22912 for example).</span><span>
</span><span id="line-2321"></span><span class="hs-comment">--</span><span>
</span><span id="line-2322"></span><span class="hs-comment">-- See Note [Migrating away from loopy superclass solving] in GHC.Tc.TyCl.Instance.</span><span>
</span><span id="line-2323"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#tryLastResortProhibitedSuperclass"><span class="hs-identifier hs-type">tryLastResortProhibitedSuperclass</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2324"></span><span id="tryLastResortProhibitedSuperclass"><span class="annot"><span class="annottext">tryLastResortProhibitedSuperclass :: InertSet -&gt; SimplifierStage
</span><a href="GHC.Tc.Solver.Interact.html#tryLastResortProhibitedSuperclass"><span class="hs-identifier hs-var hs-var">tryLastResortProhibitedSuperclass</span></a></span></span><span> </span><span id="local-6989586621681976297"><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976297"><span class="hs-identifier hs-var">inerts</span></a></span></span><span>
</span><span id="line-2325"></span><span>    </span><span id="local-6989586621681976298"><span class="annot"><span class="annottext">work_item :: Ct
</span><a href="#local-6989586621681976298"><span class="hs-identifier hs-var">work_item</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CDictCan"><span class="hs-identifier hs-type">CDictCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976299"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976299"><span class="hs-identifier hs-var">ev_w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_class :: Ct -&gt; Class
</span><a href="GHC.Tc.Types.Constraint.html#cc_class"><span class="hs-identifier hs-var">cc_class</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976300"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976300"><span class="hs-identifier hs-var">cls</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_tyargs :: Ct -&gt; [TcPredType]
</span><a href="GHC.Tc.Types.Constraint.html#cc_tyargs"><span class="hs-identifier hs-var">cc_tyargs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976301"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976301"><span class="hs-identifier hs-var">xis</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2326"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681976302"><span class="annot"><span class="annottext">loc_w :: CtLoc
</span><a href="#local-6989586621681976302"><span class="hs-identifier hs-var hs-var">loc_w</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976299"><span class="hs-identifier hs-var">ev_w</span></a></span><span>
</span><span id="line-2327"></span><span>        </span><span id="local-6989586621681976303"><span class="annot"><span class="annottext">orig_w :: CtOrigin
</span><a href="#local-6989586621681976303"><span class="hs-identifier hs-var hs-var">orig_w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Constraint.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976302"><span class="hs-identifier hs-var">loc_w</span></a></span><span>
</span><span id="line-2328"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ScOrigin"><span class="hs-identifier hs-type">ScOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstOrQC
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NakedScFlag
</span><a href="GHC.Tc.Types.Origin.html#NakedSc"><span class="hs-identifier hs-var">NakedSc</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621681976303"><span class="hs-identifier hs-var">orig_w</span></a></span><span>   </span><span class="hs-comment">-- work_item is definitely Wanted</span><span>
</span><span id="line-2329"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681976306"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976306"><span class="hs-identifier hs-var">ct_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InertCans -&gt; CtLoc -&gt; Class -&gt; [TcPredType] -&gt; Maybe Ct
</span><a href="GHC.Tc.Solver.Monad.html#lookupInertDict"><span class="hs-identifier hs-var">lookupInertDict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InertSet -&gt; InertCans
</span><a href="GHC.Tc.Solver.InertSet.html#inert_cans"><span class="hs-identifier hs-var">inert_cans</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976297"><span class="hs-identifier hs-var">inerts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976302"><span class="hs-identifier hs-var">loc_w</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976300"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976301"><span class="hs-identifier hs-var">xis</span></a></span><span>
</span><span id="line-2330"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681976307"><span class="annot"><span class="annottext">ev_i :: CtEvidence
</span><a href="#local-6989586621681976307"><span class="hs-identifier hs-var hs-var">ev_i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976306"><span class="hs-identifier hs-var">ct_i</span></a></span><span>
</span><span id="line-2331"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976307"><span class="hs-identifier hs-var">ev_i</span></a></span><span>
</span><span id="line-2332"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976299"><span class="hs-identifier hs-var">ev_w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm
</span><a href="GHC.Tc.Types.Constraint.html#ctEvTerm"><span class="hs-identifier hs-var">ctEvTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976307"><span class="hs-identifier hs-var">ev_i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2333"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; TcRnMessage -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#ctLocWarnTcS"><span class="hs-identifier hs-var">ctLocWarnTcS</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976302"><span class="hs-identifier hs-var">loc_w</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRnMessage -&gt; TcS ()) -&gt; TcRnMessage -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2334"></span><span>         </span><span class="annot"><span class="annottext">CtLoc -&gt; TcPredType -&gt; TcRnMessage
</span><a href="GHC.Tc.Errors.Types.html#TcRnLoopySuperclassSolve"><span class="hs-identifier hs-var">TcRnLoopySuperclassSolve</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976302"><span class="hs-identifier hs-var">loc_w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ct -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976298"><span class="hs-identifier hs-var">work_item</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2335"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">StopOrContinue Ct -&gt; TcS (StopOrContinue Ct)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(StopOrContinue Ct -&gt; TcS (StopOrContinue Ct))
-&gt; StopOrContinue Ct -&gt; TcS (StopOrContinue Ct)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc -&gt; StopOrContinue Ct
forall a. CtEvidence -&gt; SDoc -&gt; StopOrContinue a
</span><a href="GHC.Tc.Solver.Canonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976299"><span class="hs-identifier hs-var">ev_w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Loopy superclass&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2336"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#tryLastResortProhibitedSuperclass"><span class="hs-identifier hs-var">tryLastResortProhibitedSuperclass</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681976310"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976310"><span class="hs-identifier hs-var">work_item</span></a></span></span><span>
</span><span id="line-2337"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplifierStage
forall a. a -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621681976310"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2338"></span><span>
</span><span id="line-2339"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#chooseInstance"><span class="hs-identifier hs-type">chooseInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Canonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2340"></span><span id="chooseInstance"><span class="annot"><span class="annottext">chooseInstance :: CtEvidence -&gt; ClsInstResult -&gt; TcS (StopOrContinue Ct)
</span><a href="GHC.Tc.Solver.Interact.html#chooseInstance"><span class="hs-identifier hs-var hs-var">chooseInstance</span></a></span></span><span> </span><span id="local-6989586621681976311"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976311"><span class="hs-identifier hs-var">work_item</span></a></span></span><span>
</span><span id="line-2341"></span><span>               </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Instance.Class.html#OneInst"><span class="hs-identifier hs-type">OneInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cir_new_theta :: ClsInstResult -&gt; [TcPredType]
</span><a href="GHC.Tc.Instance.Class.html#cir_new_theta"><span class="hs-identifier hs-var">cir_new_theta</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976312"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976312"><span class="hs-identifier hs-var">theta</span></a></span></span><span>
</span><span id="line-2342"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cir_what :: ClsInstResult -&gt; InstanceWhat
</span><a href="GHC.Tc.Instance.Class.html#cir_what"><span class="hs-identifier hs-var">cir_what</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976313"><span class="annot"><span class="annottext">InstanceWhat
</span><a href="#local-6989586621681976313"><span class="hs-identifier hs-var">what</span></a></span></span><span>
</span><span id="line-2343"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cir_mk_ev :: ClsInstResult -&gt; [EvExpr] -&gt; EvTerm
</span><a href="GHC.Tc.Instance.Class.html#cir_mk_ev"><span class="hs-identifier hs-var">cir_mk_ev</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976314"><span class="annot"><span class="annottext">[EvExpr] -&gt; EvTerm
</span><a href="#local-6989586621681976314"><span class="hs-identifier hs-var">mk_ev</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2344"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doTopReact/found instance for&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976311"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2345"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681976315"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976315"><span class="hs-identifier hs-var">deeper_loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; InstanceWhat -&gt; TcPredType -&gt; TcS CtLoc
</span><a href="GHC.Tc.Solver.Interact.html#checkInstanceOK"><span class="hs-identifier hs-var">checkInstanceOK</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976316"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceWhat
</span><a href="#local-6989586621681976313"><span class="hs-identifier hs-var">what</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976317"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2346"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; TcPredType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#checkReductionDepth"><span class="hs-identifier hs-var">checkReductionDepth</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976315"><span class="hs-identifier hs-var">deeper_loc</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976317"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2347"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcS Bool -&gt; SDoc -&gt; TcS ()
forall (m :: * -&gt; *).
(HasCallStack, Monad m) =&gt;
m Bool -&gt; SDoc -&gt; m ()
</span><a href="GHC.Utils.Panic.html#assertPprM"><span class="hs-identifier hs-var">assertPprM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcS EvBindsVar
</span><a href="GHC.Tc.Solver.Monad.html#getTcEvBindsVar"><span class="hs-identifier hs-var">getTcEvBindsVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcS EvBindsVar -&gt; (EvBindsVar -&gt; TcS Bool) -&gt; TcS Bool
forall a b. TcS a -&gt; (a -&gt; TcS b) -&gt; TcS b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%3E%3E%3D/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS Bool
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; TcS Bool)
-&gt; (EvBindsVar -&gt; Bool) -&gt; EvBindsVar -&gt; TcS Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (EvBindsVar -&gt; Bool) -&gt; EvBindsVar -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">EvBindsVar -&gt; Bool
</span><a href="GHC.Tc.Types.Evidence.html#isCoEvBindsVar"><span class="hs-identifier hs-var">isCoEvBindsVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2348"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976311"><span class="hs-identifier hs-var">work_item</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2349"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681976319"><span class="annot"><span class="annottext">[MaybeNew]
</span><a href="#local-6989586621681976319"><span class="hs-identifier hs-var">evc_vars</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TcPredType -&gt; TcS MaybeNew) -&gt; [TcPredType] -&gt; TcS [MaybeNew]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#mapM/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; RewriterSet -&gt; TcPredType -&gt; TcS MaybeNew
</span><a href="GHC.Tc.Solver.Monad.html#newWanted"><span class="hs-identifier hs-var">newWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976315"><span class="hs-identifier hs-var">deeper_loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#ctEvRewriters"><span class="hs-identifier hs-var">ctEvRewriters</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976311"><span class="hs-identifier hs-var">work_item</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976312"><span class="hs-identifier hs-var">theta</span></a></span><span>
</span><span id="line-2350"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EvTerm -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976311"><span class="hs-identifier hs-var">work_item</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EvExpr] -&gt; EvTerm
</span><a href="#local-6989586621681976314"><span class="hs-identifier hs-var">mk_ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(MaybeNew -&gt; EvExpr) -&gt; [MaybeNew] -&gt; [EvExpr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeNew -&gt; EvExpr
</span><a href="GHC.Tc.Solver.Monad.html#getEvExpr"><span class="hs-identifier hs-var">getEvExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[MaybeNew]
</span><a href="#local-6989586621681976319"><span class="hs-identifier hs-var">evc_vars</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2351"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[CtEvidence] -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#emitWorkNC"><span class="hs-identifier hs-var">emitWorkNC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[MaybeNew] -&gt; [CtEvidence]
</span><a href="GHC.Tc.Solver.Monad.html#freshGoals"><span class="hs-identifier hs-var">freshGoals</span></a></span><span> </span><span class="annot"><span class="annottext">[MaybeNew]
</span><a href="#local-6989586621681976319"><span class="hs-identifier hs-var">evc_vars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2352"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; String -&gt; TcS (StopOrContinue Ct)
forall a. CtEvidence -&gt; String -&gt; TcS (StopOrContinue a)
</span><a href="GHC.Tc.Solver.Canonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976311"><span class="hs-identifier hs-var">work_item</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Dict/Top (solved wanted)&quot;</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2353"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2354"></span><span>     </span><span id="local-6989586621681976317"><span class="annot"><span class="annottext">pred :: TcPredType
</span><a href="#local-6989586621681976317"><span class="hs-identifier hs-var hs-var">pred</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976311"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2355"></span><span>     </span><span id="local-6989586621681976316"><span class="annot"><span class="annottext">loc :: CtLoc
</span><a href="#local-6989586621681976316"><span class="hs-identifier hs-var hs-var">loc</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976311"><span class="hs-identifier hs-var">work_item</span></a></span><span>
</span><span id="line-2356"></span><span>
</span><span id="line-2357"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#chooseInstance"><span class="hs-identifier hs-var">chooseInstance</span></a></span><span> </span><span id="local-6989586621681976322"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976322"><span class="hs-identifier hs-var">work_item</span></a></span></span><span> </span><span id="local-6989586621681976323"><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976323"><span class="hs-identifier hs-var">lookup_res</span></a></span></span><span>
</span><span id="line-2358"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS (StopOrContinue Ct)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;chooseInstance&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976322"><span class="hs-identifier hs-var">work_item</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976323"><span class="hs-identifier hs-var">lookup_res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2359"></span><span>
</span><span id="line-2360"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#checkInstanceOK"><span class="hs-identifier hs-type">checkInstanceOK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#InstanceWhat"><span class="hs-identifier hs-type">InstanceWhat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcPredType"><span class="hs-identifier hs-type">TcPredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span>
</span><span id="line-2361"></span><span class="hs-comment">-- Check that it's OK to use this instance:</span><span>
</span><span id="line-2362"></span><span class="hs-comment">--    (a) the use is well staged in the Template Haskell sense</span><span>
</span><span id="line-2363"></span><span class="hs-comment">-- Returns the CtLoc to used for sub-goals</span><span>
</span><span id="line-2364"></span><span class="hs-comment">-- Probably also want to call checkReductionDepth</span><span>
</span><span id="line-2365"></span><span id="checkInstanceOK"><span class="annot"><span class="annottext">checkInstanceOK :: CtLoc -&gt; InstanceWhat -&gt; TcPredType -&gt; TcS CtLoc
</span><a href="GHC.Tc.Solver.Interact.html#checkInstanceOK"><span class="hs-identifier hs-var hs-var">checkInstanceOK</span></a></span></span><span> </span><span id="local-6989586621681976324"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976324"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621681976325"><span class="annot"><span class="annottext">InstanceWhat
</span><a href="#local-6989586621681976325"><span class="hs-identifier hs-var">what</span></a></span></span><span> </span><span id="local-6989586621681976326"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976326"><span class="hs-identifier hs-var">pred</span></a></span></span><span>
</span><span id="line-2366"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; InstanceWhat -&gt; TcPredType -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#checkWellStagedDFun"><span class="hs-identifier hs-var">checkWellStagedDFun</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976324"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceWhat
</span><a href="#local-6989586621681976325"><span class="hs-identifier hs-var">what</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976326"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2367"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; TcS CtLoc
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976328"><span class="hs-identifier hs-var">deeper_loc</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2368"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2369"></span><span>     </span><span id="local-6989586621681976328"><span class="annot"><span class="annottext">deeper_loc :: CtLoc
</span><a href="#local-6989586621681976328"><span class="hs-identifier hs-var hs-var">deeper_loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtLoc
</span><a href="#local-6989586621681976329"><span class="hs-identifier hs-var">zap_origin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtLoc -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#bumpCtLocDepth"><span class="hs-identifier hs-var">bumpCtLocDepth</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976324"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2370"></span><span>     </span><span id="local-6989586621681976330"><span class="annot"><span class="annottext">origin :: CtOrigin
</span><a href="#local-6989586621681976330"><span class="hs-identifier hs-var hs-var">origin</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Constraint.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976324"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-2371"></span><span>
</span><span id="line-2372"></span><span>     </span><span id="local-6989586621681976329"><span class="annot"><span class="annottext">zap_origin :: CtLoc -&gt; CtLoc
</span><a href="#local-6989586621681976329"><span class="hs-identifier hs-var hs-var">zap_origin</span></a></span></span><span> </span><span id="local-6989586621681976331"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976331"><span class="hs-identifier hs-var">loc</span></a></span></span><span>  </span><span class="hs-comment">-- After applying an instance we can set ScOrigin to</span><span>
</span><span id="line-2373"></span><span>                     </span><span class="hs-comment">-- NotNakedSc, so that prohibitedSuperClassSolve never fires</span><span>
</span><span id="line-2374"></span><span>                     </span><span class="hs-comment">-- See Note [Solving superclass constraints] in</span><span>
</span><span id="line-2375"></span><span>                     </span><span class="hs-comment">-- GHC.Tc.TyCl.Instance, (sc1).</span><span>
</span><span id="line-2376"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#ScOrigin"><span class="hs-identifier hs-type">ScOrigin</span></a></span><span> </span><span id="local-6989586621681976332"><span class="annot"><span class="annottext">ClsInstOrQC
</span><a href="#local-6989586621681976332"><span class="hs-identifier hs-var">what</span></a></span></span><span> </span><span class="annot"><span class="annottext">NakedScFlag
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621681976330"><span class="hs-identifier hs-var">origin</span></a></span><span>
</span><span id="line-2377"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtOrigin -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#setCtLocOrigin"><span class="hs-identifier hs-var">setCtLocOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976331"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClsInstOrQC -&gt; NakedScFlag -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#ScOrigin"><span class="hs-identifier hs-var">ScOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstOrQC
</span><a href="#local-6989586621681976332"><span class="hs-identifier hs-var">what</span></a></span><span> </span><span class="annot"><span class="annottext">NakedScFlag
</span><a href="GHC.Tc.Types.Origin.html#NotNakedSc"><span class="hs-identifier hs-var">NotNakedSc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2378"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2379"></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976331"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-2380"></span><span>
</span><span id="line-2381"></span><span class="hs-comment">{- Note [Instances in no-evidence implications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In #15290 we had
  [G] forall p q. Coercible p q =&gt; Coercible (m p) (m q))
  [W] forall &lt;no-ev&gt; a. m (Int, IntStateT m a)
                          ~R#
                        m (Int, StateT Int m a)

The Given is an ordinary quantified constraint; the Wanted is an implication
equality that arises from
  [W] (forall a. t1) ~R# (forall a. t2)

But because the (t1 ~R# t2) is solved &quot;inside a type&quot; (under that forall a)
we can't generate any term evidence.  So we can't actually use that
lovely quantified constraint.  Alas!

This test arranges to ignore the instance-based solution under these
(rare) circumstances.   It's sad, but I  really don't see what else we can do.
-}</span><span>
</span><span id="line-2400"></span><span>
</span><span id="line-2401"></span><span>
</span><span id="line-2402"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#matchClassInst"><span class="hs-identifier hs-type">matchClassInst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a></span><span>
</span><span id="line-2403"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2404"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a></span><span>
</span><span id="line-2405"></span><span id="matchClassInst"><span class="annot"><span class="annottext">matchClassInst :: DynFlags
-&gt; InertSet -&gt; Class -&gt; [TcPredType] -&gt; CtLoc -&gt; TcS ClsInstResult
</span><a href="GHC.Tc.Solver.Interact.html#matchClassInst"><span class="hs-identifier hs-var hs-var">matchClassInst</span></a></span></span><span> </span><span id="local-6989586621681976334"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681976334"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621681976335"><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976335"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span id="local-6989586621681976336"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976336"><span class="hs-identifier hs-var">clas</span></a></span></span><span> </span><span id="local-6989586621681976337"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976337"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span id="local-6989586621681976338"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976338"><span class="hs-identifier hs-var">loc</span></a></span></span><span>
</span><span id="line-2406"></span><span class="hs-comment">-- First check whether there is an in-scope Given that could</span><span>
</span><span id="line-2407"></span><span class="hs-comment">-- match this constraint.  In that case, do not use any instance</span><span>
</span><span id="line-2408"></span><span class="hs-comment">-- whether top level, or local quantified constraints.</span><span>
</span><span id="line-2409"></span><span class="hs-comment">-- See Note [Instance and Given overlap]</span><span>
</span><span id="line-2410"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Extension -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#xopt"><span class="hs-identifier hs-var">xopt</span></a></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.IncoherentInstances</span></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681976334"><span class="hs-identifier hs-var">dflags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2411"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; Bool
</span><a href="GHC.Tc.Solver.Interact.html#naturallyCoherentClass"><span class="hs-identifier hs-var">naturallyCoherentClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976336"><span class="hs-identifier hs-var">clas</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2412"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InertSet -&gt; CtLoc -&gt; Class -&gt; [TcPredType] -&gt; Bool
</span><a href="GHC.Tc.Solver.InertSet.html#noMatchableGivenDicts"><span class="hs-identifier hs-var">noMatchableGivenDicts</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976335"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976338"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976336"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976337"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2413"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Delaying instance application&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2414"></span><span>           </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Work item=&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Class -&gt; [TcPredType] -&gt; SDoc
</span><a href="GHC.Core.TyCo.Ppr.html#pprClassPred"><span class="hs-identifier hs-var">pprClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976336"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976337"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2415"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ClsInstResult -&gt; TcS ClsInstResult
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="GHC.Tc.Instance.Class.html#NotSure"><span class="hs-identifier hs-var">NotSure</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2416"></span><span>
</span><span id="line-2417"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2418"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;matchClassInst&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pred =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976343"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; SDoc
forall doc. IsLine doc =&gt; Char -&gt; doc
</span><a href="GHC.Utils.Outputable.html#char"><span class="hs-identifier hs-var">char</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'{'</span></span><span>
</span><span id="line-2419"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681976344"><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976344"><span class="hs-identifier hs-var">local_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; CtLoc -&gt; TcS ClsInstResult
</span><a href="GHC.Tc.Solver.Interact.html#matchLocalInst"><span class="hs-identifier hs-var">matchLocalInst</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976343"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976338"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-2420"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976344"><span class="hs-identifier hs-var">local_res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2421"></span><span>           </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#OneInst"><span class="hs-identifier hs-type">OneInst</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-comment">-- See Note [Local instances and incoherence]</span><span>
</span><span id="line-2422"></span><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;} matchClassInst local match&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976344"><span class="hs-identifier hs-var">local_res</span></a></span><span>
</span><span id="line-2423"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ClsInstResult -&gt; TcS ClsInstResult
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976344"><span class="hs-identifier hs-var">local_res</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2424"></span><span>
</span><span id="line-2425"></span><span>           </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="GHC.Tc.Instance.Class.html#NotSure"><span class="hs-identifier hs-var">NotSure</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- In the NotSure case for local instances</span><span>
</span><span id="line-2426"></span><span>                      </span><span class="hs-comment">-- we don't want to try global instances</span><span>
</span><span id="line-2427"></span><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;} matchClassInst local not sure&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsOutput doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-2428"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ClsInstResult -&gt; TcS ClsInstResult
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976344"><span class="hs-identifier hs-var">local_res</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2429"></span><span>
</span><span id="line-2430"></span><span>           </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="GHC.Tc.Instance.Class.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a></span><span>  </span><span class="hs-comment">-- No local instances, so try global ones</span><span>
</span><span id="line-2431"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681976346"><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976346"><span class="hs-identifier hs-var">global_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Bool -&gt; Class -&gt; [TcPredType] -&gt; TcS ClsInstResult
</span><a href="GHC.Tc.Solver.Monad.html#matchGlobalInst"><span class="hs-identifier hs-var">matchGlobalInst</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681976334"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976336"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976337"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-2432"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;} matchClassInst global result&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976346"><span class="hs-identifier hs-var">global_res</span></a></span><span>
</span><span id="line-2433"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ClsInstResult -&gt; TcS ClsInstResult
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976346"><span class="hs-identifier hs-var">global_res</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2434"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2435"></span><span>    </span><span id="local-6989586621681976343"><span class="annot"><span class="annottext">pred :: TcPredType
</span><a href="#local-6989586621681976343"><span class="hs-identifier hs-var hs-var">pred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [TcPredType] -&gt; TcPredType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976336"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976337"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-2436"></span><span>
</span><span id="line-2437"></span><span class="hs-comment">-- | If a class is &quot;naturally coherent&quot;, then we needn't worry at all, in any</span><span>
</span><span id="line-2438"></span><span class="hs-comment">-- way, about overlapping/incoherent instances. Just solve the thing!</span><span>
</span><span id="line-2439"></span><span class="hs-comment">-- See Note [Naturally coherent classes]</span><span>
</span><span id="line-2440"></span><span class="hs-comment">-- See also Note [The equality types story] in GHC.Builtin.Types.Prim.</span><span>
</span><span id="line-2441"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#naturallyCoherentClass"><span class="hs-identifier hs-type">naturallyCoherentClass</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2442"></span><span id="naturallyCoherentClass"><span class="annot"><span class="annottext">naturallyCoherentClass :: Class -&gt; Bool
</span><a href="GHC.Tc.Solver.Interact.html#naturallyCoherentClass"><span class="hs-identifier hs-var hs-var">naturallyCoherentClass</span></a></span></span><span> </span><span id="local-6989586621681976347"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976347"><span class="hs-identifier hs-var">cls</span></a></span></span><span>
</span><span id="line-2443"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isCTupleClass"><span class="hs-identifier hs-var">isCTupleClass</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976347"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-2444"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976347"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#heqTyConKey"><span class="hs-identifier hs-var">heqTyConKey</span></a></span><span>
</span><span id="line-2445"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976347"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#eqTyConKey"><span class="hs-identifier hs-var">eqTyConKey</span></a></span><span>
</span><span id="line-2446"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621681976347"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#coercibleTyConKey"><span class="hs-identifier hs-var">coercibleTyConKey</span></a></span><span>
</span><span id="line-2447"></span><span>
</span><span id="line-2448"></span><span>
</span><span id="line-2449"></span><span class="hs-comment">{- Note [Instance and Given overlap]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Example, from the OutsideIn(X) paper:
       instance P x =&gt; Q [x]
       instance (x ~ y) =&gt; R y [x]

       wob :: forall a b. (Q [b], R b a) =&gt; a -&gt; Int

       g :: forall a. Q [a] =&gt; [a] -&gt; Int
       g x = wob x

From 'g' we get the implication constraint:
            forall a. Q [a] =&gt; (Q [beta], R beta [a])
If we react (Q [beta]) with its top-level axiom, we end up with a
(P beta), which we have no way of discharging. On the other hand,
if we react R beta [a] with the top-level we get  (beta ~ a), which
is solvable and can help us rewrite (Q [beta]) to (Q [a]) which is
now solvable by the given Q [a].

The partial solution is that:
  In matchClassInst (and thus in topReact), we return a matching
  instance only when there is no Given in the inerts which is
  unifiable to this particular dictionary.

  We treat any meta-tyvar as &quot;unifiable&quot; for this purpose,
  *including* untouchable ones.  But not skolems like 'a' in
  the implication constraint above.

The end effect is that, much as we do for overlapping instances, we
delay choosing a class instance if there is a possibility of another
instance OR a given to match our constraint later on. This fixes
tickets #4981 and #5002.

Other notes:

* The check is done *first*, so that it also covers classes
  with built-in instance solving, such as
     - constraint tuples
     - natural numbers
     - Typeable

* See also Note [What might equal later?] in GHC.Tc.Solver.InertSet.

* The given-overlap problem is arguably not easy to appear in practice
  due to our aggressive prioritization of equality solving over other
  constraints, but it is possible. I've added a test case in
  typecheck/should-compile/GivenOverlapping.hs

* Another &quot;live&quot; example is #10195; another is #10177.

* We ignore the overlap problem if -XIncoherentInstances is in force:
  see #6002 for a worked-out example where this makes a
  difference.

* Moreover notice that our goals here are different than the goals of
  the top-level overlapping checks. There we are interested in
  validating the following principle:

      If we inline a function f at a site where the same global
      instance environment is available as the instance environment at
      the definition site of f then we should get the same behaviour.

  But for the Given Overlap check our goal is just related to completeness of
  constraint solving.

* The solution is only a partial one.  Consider the above example with
       g :: forall a. Q [a] =&gt; [a] -&gt; Int
       g x = let v = wob x
             in v
  and suppose we have -XNoMonoLocalBinds, so that we attempt to find the most
  general type for 'v'.  When generalising v's type we'll simplify its
  Q [alpha] constraint, but we don't have Q [a] in the 'givens', so we
  will use the instance declaration after all. #11948 was a case
  in point.

All of this is disgustingly delicate, so to discourage people from writing
simplifiable class givens, we warn about signatures that contain them;
see GHC.Tc.Validity Note [Simplifiable given constraints].

Note [Naturally coherent classes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A few built-in classes are &quot;naturally coherent&quot;.  This term means that
the &quot;instance&quot; for the class is bidirectional with its superclass(es).
For example, consider (~~), which behaves as if it was defined like
this:
  class a ~# b =&gt; a ~~ b
  instance a ~# b =&gt; a ~~ b
(See Note [The equality types story] in GHC.Builtin.Types.Prim.)

Faced with [W] t1 ~~ t2, it's always OK to reduce it to [W] t1 ~# t2,
without worrying about Note [Instance and Given overlap].  Why?  Because
if we had [G] s1 ~~ s2, then we'd get the superclass [G] s1 ~# s2, and
so the reduction of the [W] constraint does not risk losing any solutions.

On the other hand, it can be fatal to /fail/ to reduce such
equalities, on the grounds of Note [Instance and Given overlap],
because many good things flow from [W] t1 ~# t2.

The same reasoning applies to

* (~~)        heqTyCon
* (~)         eqTyCon
* Coercible   coercibleTyCon

And less obviously to:

* Tuple classes.  For reasons described in GHC.Tc.Solver.Types
  Note [Tuples hiding implicit parameters], we may have a constraint
     [W] (?x::Int, C a)
  with an exactly-matching Given constraint.  We must decompose this
  tuple and solve the components separately, otherwise we won't solve
  it at all!  It is perfectly safe to decompose it, because again the
  superclasses invert the instance;  e.g.
      class (c1, c2) =&gt; (% c1, c2 %)
      instance (c1, c2) =&gt; (% c1, c2 %)
  Example in #14218

Examples: T5853, T10432, T5315, T9222, T2627b, T3028b

PS: the term &quot;naturally coherent&quot; doesn't really seem helpful.
Perhaps &quot;invertible&quot; or something?  I left it for now though.

Note [Local instances and incoherence]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f :: forall b c. (Eq b, forall a. Eq a =&gt; Eq (c a))
                 =&gt; c b -&gt; Bool
   f x = x==x

We get [W] Eq (c b), and we must use the local instance to solve it.

BUT that wanted also unifies with the top-level Eq [a] instance,
and Eq (Maybe a) etc.  We want the local instance to &quot;win&quot;, otherwise
we can't solve the wanted at all.  So we mark it as Incohherent.
According to Note [Rules for instance lookup] in GHC.Core.InstEnv, that'll
make it win even if there are other instances that unify.

Moreover this is not a hack!  The evidence for this local instance
will be constructed by GHC at a call site... from the very instances
that unify with it here.  It is not like an incoherent user-written
instance which might have utterly different behaviour.

Consider  f :: Eq a =&gt; blah.  If we have [W] Eq a, we certainly
get it from the Eq a context, without worrying that there are
lots of top-level instances that unify with [W] Eq a!  We'll use
those instances to build evidence to pass to f. That's just the
nullary case of what's happening here.
-}</span><span>
</span><span id="line-2597"></span><span>
</span><span id="line-2598"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#matchLocalInst"><span class="hs-identifier hs-type">matchLocalInst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcPredType"><span class="hs-identifier hs-type">TcPredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a></span><span>
</span><span id="line-2599"></span><span class="hs-comment">-- Look up the predicate in Given quantified constraints,</span><span>
</span><span id="line-2600"></span><span class="hs-comment">-- which are effectively just local instance declarations.</span><span>
</span><span id="line-2601"></span><span id="matchLocalInst"><span class="annot"><span class="annottext">matchLocalInst :: TcPredType -&gt; CtLoc -&gt; TcS ClsInstResult
</span><a href="GHC.Tc.Solver.Interact.html#matchLocalInst"><span class="hs-identifier hs-var hs-var">matchLocalInst</span></a></span></span><span> </span><span id="local-6989586621681976350"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976350"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span id="local-6989586621681976351"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976351"><span class="hs-identifier hs-var">loc</span></a></span></span><span>
</span><span id="line-2602"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681976352"><span class="annot"><span class="annottext">inerts :: InertSet
</span><a href="#local-6989586621681976352"><span class="hs-identifier hs-var">inerts</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#IS"><span class="hs-identifier hs-type">IS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">inert_cans :: InertSet -&gt; InertCans
</span><a href="GHC.Tc.Solver.InertSet.html#inert_cans"><span class="hs-identifier hs-var">inert_cans</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976354"><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681976354"><span class="hs-identifier hs-var">ics</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS InertSet
</span><a href="GHC.Tc.Solver.Monad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a></span><span>
</span><span id="line-2603"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InertSet
-&gt; [QCInst]
-&gt; ([(CtEvidence, [DFunInstType])], [(CtEvidence, [DFunInstType])])
</span><a href="#local-6989586621681976355"><span class="hs-identifier hs-var">match_local_inst</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976352"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InertCans -&gt; [QCInst]
</span><a href="GHC.Tc.Solver.InertSet.html#inert_insts"><span class="hs-identifier hs-var">inert_insts</span></a></span><span> </span><span class="annot"><span class="annottext">InertCans
</span><a href="#local-6989586621681976354"><span class="hs-identifier hs-var">ics</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2604"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;No local instance for&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976350"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2605"></span><span>                           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ClsInstResult -&gt; TcS ClsInstResult
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="GHC.Tc.Instance.Class.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2606"></span><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976356"><span class="annot"><span class="annottext">[(CtEvidence, [DFunInstType])]
</span><a href="#local-6989586621681976356"><span class="hs-identifier hs-var">matches</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976357"><span class="annot"><span class="annottext">[(CtEvidence, [DFunInstType])]
</span><a href="#local-6989586621681976357"><span class="hs-identifier hs-var">unifs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2607"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681976358"><span class="annot"><span class="annottext">[InstDFun]
</span><a href="#local-6989586621681976358"><span class="hs-identifier hs-var">matches</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((CtEvidence, [DFunInstType]) -&gt; TcS InstDFun)
-&gt; [(CtEvidence, [DFunInstType])] -&gt; TcS [InstDFun]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#mapM/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">(CtEvidence, [DFunInstType]) -&gt; TcS InstDFun
</span><a href="#local-6989586621681976359"><span class="hs-identifier hs-var">mk_instDFun</span></a></span><span> </span><span class="annot"><span class="annottext">[(CtEvidence, [DFunInstType])]
</span><a href="#local-6989586621681976356"><span class="hs-identifier hs-var">matches</span></a></span><span>
</span><span id="line-2608"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681976360"><span class="annot"><span class="annottext">[InstDFun]
</span><a href="#local-6989586621681976360"><span class="hs-identifier hs-var">unifs</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((CtEvidence, [DFunInstType]) -&gt; TcS InstDFun)
-&gt; [(CtEvidence, [DFunInstType])] -&gt; TcS [InstDFun]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#mapM/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">(CtEvidence, [DFunInstType]) -&gt; TcS InstDFun
</span><a href="#local-6989586621681976359"><span class="hs-identifier hs-var">mk_instDFun</span></a></span><span> </span><span class="annot"><span class="annottext">[(CtEvidence, [DFunInstType])]
</span><a href="#local-6989586621681976357"><span class="hs-identifier hs-var">unifs</span></a></span><span>
</span><span id="line-2609"></span><span>         </span><span class="hs-comment">-- See Note [Use only the best matching quantified constraint]</span><span>
</span><span id="line-2610"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[InstDFun] -&gt; Maybe InstDFun
</span><a href="GHC.Tc.Solver.Interact.html#dominatingMatch"><span class="hs-identifier hs-var">dominatingMatch</span></a></span><span> </span><span class="annot"><span class="annottext">[InstDFun]
</span><a href="#local-6989586621681976358"><span class="hs-identifier hs-var">matches</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2611"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976362"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976362"><span class="hs-identifier hs-var">dfun_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976363"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976363"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976364"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976364"><span class="hs-identifier hs-var">theta</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2612"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(InstDFun -&gt; Bool) -&gt; [InstDFun] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#all/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976364"><span class="hs-identifier hs-var">theta</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType] -&gt; [TcPredType] -&gt; Bool
</span><a href="GHC.Tc.Solver.Interact.html#impliedBySCs"><span class="hs-operator hs-var">`impliedBySCs`</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TcPredType] -&gt; Bool)
-&gt; (InstDFun -&gt; [TcPredType]) -&gt; InstDFun -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">InstDFun -&gt; [TcPredType]
forall a b c. (a, b, c) -&gt; c
</span><a href="GHC.Utils.Misc.html#thdOf3"><span class="hs-identifier hs-var">thdOf3</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[InstDFun]
</span><a href="#local-6989586621681976360"><span class="hs-identifier hs-var">unifs</span></a></span><span>
</span><span id="line-2613"></span><span>            </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2614"></span><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681976367"><span class="annot"><span class="annottext">result :: ClsInstResult
</span><a href="#local-6989586621681976367"><span class="hs-identifier hs-var hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Instance.Class.html#OneInst"><span class="hs-identifier hs-type">OneInst</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cir_new_theta :: [TcPredType]
</span><a href="GHC.Tc.Instance.Class.html#cir_new_theta"><span class="hs-identifier hs-var">cir_new_theta</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976364"><span class="hs-identifier hs-var">theta</span></a></span><span>
</span><span id="line-2615"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cir_mk_ev :: [EvExpr] -&gt; EvTerm
</span><a href="GHC.Tc.Instance.Class.html#cir_mk_ev"><span class="hs-identifier hs-var">cir_mk_ev</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; [TcPredType] -&gt; [EvExpr] -&gt; EvTerm
</span><a href="GHC.Tc.Types.Evidence.html#evDFunApp"><span class="hs-identifier hs-var">evDFunApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976362"><span class="hs-identifier hs-var">dfun_id</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976363"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-2616"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cir_what :: InstanceWhat
</span><a href="GHC.Tc.Instance.Class.html#cir_what"><span class="hs-identifier hs-var">cir_what</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InstanceWhat
</span><a href="GHC.Tc.Instance.Class.html#LocalInstance"><span class="hs-identifier hs-var">LocalInstance</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2617"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Best local instance found:&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2618"></span><span>                  </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pred:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976350"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2619"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;result:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976367"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-2620"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;matches:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[InstDFun] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[InstDFun]
</span><a href="#local-6989586621681976358"><span class="hs-identifier hs-var">matches</span></a></span><span>
</span><span id="line-2621"></span><span>                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unifs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[InstDFun] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[InstDFun]
</span><a href="#local-6989586621681976360"><span class="hs-identifier hs-var">unifs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2622"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ClsInstResult -&gt; TcS ClsInstResult
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="#local-6989586621681976367"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2623"></span><span>
</span><span id="line-2624"></span><span>          </span><span class="hs-special">;</span><span> </span><span id="local-6989586621681976370"><span class="annot"><span class="annottext">Maybe InstDFun
</span><a href="#local-6989586621681976370"><span class="hs-identifier hs-var">mb_best</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-2625"></span><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Multiple local instances; not committing to any&quot;</span></span><span>
</span><span id="line-2626"></span><span>                  </span><span class="annot"><span class="annottext">(SDoc -&gt; TcS ()) -&gt; SDoc -&gt; TcS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pred:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976350"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2627"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;matches:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[InstDFun] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[InstDFun]
</span><a href="#local-6989586621681976358"><span class="hs-identifier hs-var">matches</span></a></span><span>
</span><span id="line-2628"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unifs:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[InstDFun] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[InstDFun]
</span><a href="#local-6989586621681976360"><span class="hs-identifier hs-var">unifs</span></a></span><span>
</span><span id="line-2629"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;best_match:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe InstDFun -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe InstDFun
</span><a href="#local-6989586621681976370"><span class="hs-identifier hs-var">mb_best</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2630"></span><span>               </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ClsInstResult -&gt; TcS ClsInstResult
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ClsInstResult
</span><a href="GHC.Tc.Instance.Class.html#NotSure"><span class="hs-identifier hs-var">NotSure</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-2631"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2632"></span><span>    </span><span id="local-6989586621681976371"><span class="annot"><span class="annottext">pred_tv_set :: VarSet
</span><a href="#local-6989586621681976371"><span class="hs-identifier hs-var hs-var">pred_tv_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976350"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2633"></span><span>
</span><span id="line-2634"></span><span>    </span><span class="annot"><a href="#local-6989586621681976359"><span class="hs-identifier hs-type">mk_instDFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.InstEnv.html#DFunInstType"><span class="hs-identifier hs-type">DFunInstType</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#InstDFun"><span class="hs-identifier hs-type">InstDFun</span></a></span><span>
</span><span id="line-2635"></span><span>    </span><span id="local-6989586621681976359"><span class="annot"><span class="annottext">mk_instDFun :: (CtEvidence, [DFunInstType]) -&gt; TcS InstDFun
</span><a href="#local-6989586621681976359"><span class="hs-identifier hs-var hs-var">mk_instDFun</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976372"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976372"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976373"><span class="annot"><span class="annottext">[DFunInstType]
</span><a href="#local-6989586621681976373"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2636"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681976374"><span class="annot"><span class="annottext">dfun_id :: TyVar
</span><a href="#local-6989586621681976374"><span class="hs-identifier hs-var hs-var">dfun_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; TyVar
</span><a href="GHC.Tc.Types.Constraint.html#ctEvEvId"><span class="hs-identifier hs-var">ctEvEvId</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976372"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-2637"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976375"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976375"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976376"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976376"><span class="hs-identifier hs-var">theta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; [DFunInstType] -&gt; TcS ([TcPredType], [TcPredType])
</span><a href="GHC.Tc.Solver.Monad.html#instDFunType"><span class="hs-identifier hs-var">instDFunType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; TyVar
</span><a href="GHC.Tc.Types.Constraint.html#ctEvEvId"><span class="hs-identifier hs-var">ctEvEvId</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976372"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DFunInstType]
</span><a href="#local-6989586621681976373"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-2638"></span><span>            </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">InstDFun -&gt; TcS InstDFun
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621681976374"><span class="hs-identifier hs-var">dfun_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976375"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976376"><span class="hs-identifier hs-var">theta</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2639"></span><span>
</span><span id="line-2640"></span><span>    </span><span class="hs-comment">-- Compute matching and unifying local instances</span><span>
</span><span id="line-2641"></span><span>    </span><span class="annot"><a href="#local-6989586621681976355"><span class="hs-identifier hs-type">match_local_inst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.InertSet.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a></span><span>
</span><span id="line-2642"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#QCInst"><span class="hs-identifier hs-type">QCInst</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2643"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.InstEnv.html#DFunInstType"><span class="hs-identifier hs-type">DFunInstType</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-2644"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.InstEnv.html#DFunInstType"><span class="hs-identifier hs-type">DFunInstType</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-2645"></span><span>    </span><span id="local-6989586621681976355"><span class="annot"><span class="annottext">match_local_inst :: InertSet
-&gt; [QCInst]
-&gt; ([(CtEvidence, [DFunInstType])], [(CtEvidence, [DFunInstType])])
</span><a href="#local-6989586621681976355"><span class="hs-identifier hs-var hs-var">match_local_inst</span></a></span></span><span> </span><span id="local-6989586621681976378"><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976378"><span class="hs-identifier hs-var">_inerts</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2646"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2647"></span><span>    </span><span class="annot"><a href="#local-6989586621681976355"><span class="hs-identifier hs-var">match_local_inst</span></a></span><span> </span><span id="local-6989586621681976379"><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976379"><span class="hs-identifier hs-var">inerts</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681976380"><span class="annot"><span class="annottext">qci :: QCInst
</span><a href="#local-6989586621681976380"><span class="hs-identifier hs-var">qci</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#QCI"><span class="hs-identifier hs-type">QCI</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">qci_tvs :: QCInst -&gt; [TyVar]
</span><a href="GHC.Tc.Types.Constraint.html#qci_tvs"><span class="hs-identifier hs-var">qci_tvs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976383"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976383"><span class="hs-identifier hs-var">qtvs</span></a></span></span><span>
</span><span id="line-2648"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">qci_pred :: QCInst -&gt; TcPredType
</span><a href="GHC.Tc.Types.Constraint.html#qci_pred"><span class="hs-identifier hs-var">qci_pred</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976385"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976385"><span class="hs-identifier hs-var">qpred</span></a></span></span><span>
</span><span id="line-2649"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">qci_ev :: QCInst -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#qci_ev"><span class="hs-identifier hs-var">qci_ev</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681976387"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976387"><span class="hs-identifier hs-var">qev</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2650"></span><span>                            </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681976388"><span class="annot"><span class="annottext">[QCInst]
</span><a href="#local-6989586621681976388"><span class="hs-identifier hs-var">qcis</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2651"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681976389"><span class="annot"><span class="annottext">in_scope :: InScopeSet
</span><a href="#local-6989586621681976389"><span class="hs-identifier hs-var hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681976390"><span class="hs-identifier hs-var">qtv_set</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#unionVarSet"><span class="hs-operator hs-var">`unionVarSet`</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681976371"><span class="hs-identifier hs-var">pred_tv_set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2652"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681976392"><span class="annot"><span class="annottext">VarEnv TcPredType
</span><a href="#local-6989586621681976392"><span class="hs-identifier hs-var">tv_subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarSet
-&gt; RnEnv2
-&gt; VarEnv TcPredType
-&gt; TcPredType
-&gt; TcPredType
-&gt; Maybe (VarEnv TcPredType)
</span><a href="GHC.Core.Unify.html#ruleMatchTyKiX"><span class="hs-identifier hs-var">ruleMatchTyKiX</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681976390"><span class="hs-identifier hs-var">qtv_set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; RnEnv2
</span><a href="GHC.Types.Var.Env.html#mkRnEnv2"><span class="hs-identifier hs-var">mkRnEnv2</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681976389"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2653"></span><span>                                        </span><span class="annot"><span class="annottext">VarEnv TcPredType
</span><a href="GHC.Core.TyCo.Subst.html#emptyTvSubstEnv"><span class="hs-identifier hs-var">emptyTvSubstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976385"><span class="hs-identifier hs-var">qpred</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976350"><span class="hs-identifier hs-var">pred</span></a></span><span>
</span><span id="line-2654"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681976395"><span class="annot"><span class="annottext">match :: (CtEvidence, [DFunInstType])
</span><a href="#local-6989586621681976395"><span class="hs-identifier hs-var hs-var">match</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976387"><span class="hs-identifier hs-var">qev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; DFunInstType) -&gt; [TyVar] -&gt; [DFunInstType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarEnv TcPredType -&gt; TyVar -&gt; DFunInstType
forall a. VarEnv a -&gt; TyVar -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">VarEnv TcPredType
</span><a href="#local-6989586621681976392"><span class="hs-identifier hs-var">tv_subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976383"><span class="hs-identifier hs-var">qtvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2655"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CtEvidence, [DFunInstType])
</span><a href="#local-6989586621681976395"><span class="hs-identifier hs-var">match</span></a></span><span class="annot"><span class="annottext">(CtEvidence, [DFunInstType])
-&gt; [(CtEvidence, [DFunInstType])] -&gt; [(CtEvidence, [DFunInstType])]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[(CtEvidence, [DFunInstType])]
</span><a href="#local-6989586621681976397"><span class="hs-identifier hs-var">matches</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(CtEvidence, [DFunInstType])]
</span><a href="#local-6989586621681976398"><span class="hs-identifier hs-var">unifs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2656"></span><span>
</span><span id="line-2657"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2658"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; ([(CtEvidence, [DFunInstType])], [(CtEvidence, [DFunInstType])])
-&gt; ([(CtEvidence, [DFunInstType])], [(CtEvidence, [DFunInstType])])
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#disjointVarSet"><span class="hs-identifier hs-var">disjointVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681976390"><span class="hs-identifier hs-var">qtv_set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPredType -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976350"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2659"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QCInst -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">QCInst
</span><a href="#local-6989586621681976380"><span class="hs-identifier hs-var">qci</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976350"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2660"></span><span>            </span><span class="hs-comment">-- ASSERT: unification relies on the</span><span>
</span><span id="line-2661"></span><span>            </span><span class="hs-comment">-- quantified variables being fresh</span><span>
</span><span id="line-2662"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(CtEvidence, [DFunInstType])]
</span><a href="#local-6989586621681976397"><span class="hs-identifier hs-var">matches</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (CtEvidence, [DFunInstType])
</span><a href="#local-6989586621681976400"><span class="hs-identifier hs-var">this_unif</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (CtEvidence, [DFunInstType])
-&gt; [(CtEvidence, [DFunInstType])] -&gt; [(CtEvidence, [DFunInstType])]
forall {a}. Maybe a -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621681976401"><span class="hs-operator hs-var">`combine`</span></a></span><span> </span><span class="annot"><span class="annottext">[(CtEvidence, [DFunInstType])]
</span><a href="#local-6989586621681976398"><span class="hs-identifier hs-var">unifs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2663"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2664"></span><span>        </span><span id="local-6989586621681976402"><span class="annot"><span class="annottext">qloc :: CtLoc
</span><a href="#local-6989586621681976402"><span class="hs-identifier hs-var hs-var">qloc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976387"><span class="hs-identifier hs-var">qev</span></a></span><span>
</span><span id="line-2665"></span><span>        </span><span id="local-6989586621681976390"><span class="annot"><span class="annottext">qtv_set :: VarSet
</span><a href="#local-6989586621681976390"><span class="hs-identifier hs-var hs-var">qtv_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; VarSet
</span><a href="GHC.Types.Var.Set.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976383"><span class="hs-identifier hs-var">qtvs</span></a></span><span>
</span><span id="line-2666"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681976397"><span class="annot"><span class="annottext">[(CtEvidence, [DFunInstType])]
</span><a href="#local-6989586621681976397"><span class="hs-identifier hs-var">matches</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976398"><span class="annot"><span class="annottext">[(CtEvidence, [DFunInstType])]
</span><a href="#local-6989586621681976398"><span class="hs-identifier hs-var">unifs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InertSet
-&gt; [QCInst]
-&gt; ([(CtEvidence, [DFunInstType])], [(CtEvidence, [DFunInstType])])
</span><a href="#local-6989586621681976355"><span class="hs-identifier hs-var">match_local_inst</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976379"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">[QCInst]
</span><a href="#local-6989586621681976388"><span class="hs-identifier hs-var">qcis</span></a></span><span>
</span><span id="line-2667"></span><span>        </span><span id="local-6989586621681976400"><span class="annot"><span class="annottext">this_unif :: Maybe (CtEvidence, [DFunInstType])
</span><a href="#local-6989586621681976400"><span class="hs-identifier hs-var hs-var">this_unif</span></a></span></span><span>
</span><span id="line-2668"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681976404"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976404"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InertSet
-&gt; TcPredType -&gt; CtLoc -&gt; TcPredType -&gt; CtLoc -&gt; Maybe Subst
</span><a href="GHC.Tc.Solver.InertSet.html#mightEqualLater"><span class="hs-identifier hs-var">mightEqualLater</span></a></span><span> </span><span class="annot"><span class="annottext">InertSet
</span><a href="#local-6989586621681976379"><span class="hs-identifier hs-var">inerts</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976385"><span class="hs-identifier hs-var">qpred</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976402"><span class="hs-identifier hs-var">qloc</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976350"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621681976351"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-2669"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CtEvidence, [DFunInstType]) -&gt; Maybe (CtEvidence, [DFunInstType])
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621681976387"><span class="hs-identifier hs-var">qev</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; DFunInstType) -&gt; [TyVar] -&gt; [DFunInstType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; TyVar -&gt; DFunInstType
</span><a href="GHC.Core.TyCo.Subst.html#lookupTyVar"><span class="hs-identifier hs-var">lookupTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681976404"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621681976383"><span class="hs-identifier hs-var">qtvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2670"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2671"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (CtEvidence, [DFunInstType])
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2672"></span><span>
</span><span id="line-2673"></span><span>        </span><span id="local-6989586621681976401"><span class="annot"><span class="annottext">combine :: Maybe a -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621681976401"><span class="hs-identifier hs-var hs-var">combine</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span id="local-6989586621681976407"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621681976407"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621681976407"><span class="hs-identifier hs-var">us</span></a></span><span>
</span><span id="line-2674"></span><span>        </span><span class="annot"><a href="#local-6989586621681976401"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681976408"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681976408"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681976409"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621681976409"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681976408"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621681976409"><span class="hs-identifier hs-var">us</span></a></span><span>
</span><span id="line-2675"></span><span>
</span><span id="line-2676"></span><span class="annot"><span class="hs-comment">-- | Instance dictionary function and type.</span></span><span>
</span><span id="line-2677"></span><span class="hs-keyword">type</span><span> </span><span id="InstDFun"><span class="annot"><a href="GHC.Tc.Solver.Interact.html#InstDFun"><span class="hs-identifier hs-var">InstDFun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#DFunId"><span class="hs-identifier hs-type">DFunId</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcThetaType"><span class="hs-identifier hs-type">TcThetaType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2678"></span><span>
</span><span id="line-2679"></span><span class="hs-comment">-- | Try to find a local quantified instance that dominates all others,</span><span>
</span><span id="line-2680"></span><span class="hs-comment">-- i.e. which has a weaker instance context than all the others.</span><span>
</span><span id="line-2681"></span><span class="hs-comment">--</span><span>
</span><span id="line-2682"></span><span class="hs-comment">-- See Note [Use only the best matching quantified constraint].</span><span>
</span><span id="line-2683"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#dominatingMatch"><span class="hs-identifier hs-type">dominatingMatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#InstDFun"><span class="hs-identifier hs-type">InstDFun</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#InstDFun"><span class="hs-identifier hs-type">InstDFun</span></a></span><span>
</span><span id="line-2684"></span><span id="dominatingMatch"><span class="annot"><span class="annottext">dominatingMatch :: [InstDFun] -&gt; Maybe InstDFun
</span><a href="GHC.Tc.Solver.Interact.html#dominatingMatch"><span class="hs-identifier hs-var hs-var">dominatingMatch</span></a></span></span><span> </span><span id="local-6989586621681976412"><span class="annot"><span class="annottext">[InstDFun]
</span><a href="#local-6989586621681976412"><span class="hs-identifier hs-var">matches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2685"></span><span>  </span><span class="annot"><span class="annottext">[InstDFun] -&gt; Maybe InstDFun
forall a. [a] -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/Data.Maybe.html#listToMaybe/Data.Maybe.html#listToMaybe"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">([InstDFun] -&gt; Maybe InstDFun) -&gt; [InstDFun] -&gt; Maybe InstDFun
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((InstDFun, [InstDFun]) -&gt; Maybe InstDFun)
-&gt; [(InstDFun, [InstDFun])] -&gt; [InstDFun]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/Data.Maybe.html#mapMaybe/Data.Maybe.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(InstDFun -&gt; [InstDFun] -&gt; Maybe InstDFun)
-&gt; (InstDFun, [InstDFun]) -&gt; Maybe InstDFun
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><a href="../../base-4.18.2.1/src/Data.Tuple.html#uncurry/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a></span><span> </span><span class="annot"><span class="annottext">InstDFun -&gt; [InstDFun] -&gt; Maybe InstDFun
</span><a href="#local-6989586621681976413"><span class="hs-identifier hs-var">go</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[InstDFun] -&gt; [(InstDFun, [InstDFun])]
forall a. [a] -&gt; [(a, [a])]
</span><a href="GHC.Utils.Misc.html#holes"><span class="hs-identifier hs-var">holes</span></a></span><span> </span><span class="annot"><span class="annottext">[InstDFun]
</span><a href="#local-6989586621681976412"><span class="hs-identifier hs-var">matches</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2686"></span><span>  </span><span class="hs-comment">-- listToMaybe: arbitrarily pick any one context that is weaker than</span><span>
</span><span id="line-2687"></span><span>  </span><span class="hs-comment">-- all others, e.g. so that we can handle [Eq a, Num a] vs [Num a, Eq a]</span><span>
</span><span id="line-2688"></span><span>  </span><span class="hs-comment">-- (see test case T22223).</span><span>
</span><span id="line-2689"></span><span>
</span><span id="line-2690"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2691"></span><span>    </span><span class="annot"><a href="#local-6989586621681976413"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#InstDFun"><span class="hs-identifier hs-type">InstDFun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#InstDFun"><span class="hs-identifier hs-type">InstDFun</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#InstDFun"><span class="hs-identifier hs-type">InstDFun</span></a></span><span>
</span><span id="line-2692"></span><span>    </span><span id="local-6989586621681976413"><span class="annot"><span class="annottext">go :: InstDFun -&gt; [InstDFun] -&gt; Maybe InstDFun
</span><a href="#local-6989586621681976413"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681976415"><span class="annot"><span class="annottext">InstDFun
</span><a href="#local-6989586621681976415"><span class="hs-identifier hs-var">this</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InstDFun -&gt; Maybe InstDFun
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">InstDFun
</span><a href="#local-6989586621681976415"><span class="hs-identifier hs-var">this</span></a></span><span>
</span><span id="line-2693"></span><span>    </span><span class="annot"><a href="#local-6989586621681976413"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681976416"><span class="annot"><span class="annottext">this :: InstDFun
</span><a href="#local-6989586621681976416"><span class="hs-identifier hs-var">this</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[TcPredType]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621681976417"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976417"><span class="hs-identifier hs-var">this_theta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[TcPredType]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621681976418"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976418"><span class="hs-identifier hs-var">other_theta</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681976419"><span class="annot"><span class="annottext">[InstDFun]
</span><a href="#local-6989586621681976419"><span class="hs-identifier hs-var">others</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2694"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976417"><span class="hs-identifier hs-var">this_theta</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType] -&gt; [TcPredType] -&gt; Bool
</span><a href="GHC.Tc.Solver.Interact.html#impliedBySCs"><span class="hs-operator hs-var">`impliedBySCs`</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976418"><span class="hs-identifier hs-var">other_theta</span></a></span><span>
</span><span id="line-2695"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InstDFun -&gt; [InstDFun] -&gt; Maybe InstDFun
</span><a href="#local-6989586621681976413"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">InstDFun
</span><a href="#local-6989586621681976416"><span class="hs-identifier hs-var">this</span></a></span><span> </span><span class="annot"><span class="annottext">[InstDFun]
</span><a href="#local-6989586621681976419"><span class="hs-identifier hs-var">others</span></a></span><span>
</span><span id="line-2696"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2697"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe InstDFun
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-2698"></span><span>
</span><span id="line-2699"></span><span class="hs-comment">-- | Whether a collection of constraints is implied by another collection,</span><span>
</span><span id="line-2700"></span><span class="hs-comment">-- according to a simple superclass check.</span><span>
</span><span id="line-2701"></span><span class="hs-comment">--</span><span>
</span><span id="line-2702"></span><span class="hs-comment">-- See Note [When does a quantified instance dominate another?].</span><span>
</span><span id="line-2703"></span><span class="annot"><a href="GHC.Tc.Solver.Interact.html#impliedBySCs"><span class="hs-identifier hs-type">impliedBySCs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcThetaType"><span class="hs-identifier hs-type">TcThetaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcThetaType"><span class="hs-identifier hs-type">TcThetaType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2704"></span><span id="impliedBySCs"><span class="annot"><span class="annottext">impliedBySCs :: [TcPredType] -&gt; [TcPredType] -&gt; Bool
</span><a href="GHC.Tc.Solver.Interact.html#impliedBySCs"><span class="hs-identifier hs-var hs-var">impliedBySCs</span></a></span></span><span> </span><span id="local-6989586621681976420"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976420"><span class="hs-identifier hs-var">c1</span></a></span></span><span> </span><span id="local-6989586621681976421"><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976421"><span class="hs-identifier hs-var">c2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcPredType -&gt; Bool) -&gt; [TcPredType] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#all/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; Bool
</span><a href="#local-6989586621681976422"><span class="hs-identifier hs-var">in_c2</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976420"><span class="hs-identifier hs-var">c1</span></a></span><span>
</span><span id="line-2705"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2706"></span><span>    </span><span class="annot"><a href="#local-6989586621681976422"><span class="hs-identifier hs-type">in_c2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcPredType"><span class="hs-identifier hs-type">TcPredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2707"></span><span>    </span><span id="local-6989586621681976422"><span class="annot"><span class="annottext">in_c2 :: TcPredType -&gt; Bool
</span><a href="#local-6989586621681976422"><span class="hs-identifier hs-var hs-var">in_c2</span></a></span></span><span> </span><span id="local-6989586621681976423"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976423"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TcPredType -&gt; Bool) -&gt; [TcPredType] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#any/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976423"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; TcPredType -&gt; TcPredType -&gt; Bool
TcPredType -&gt; TcPredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqType"><span class="hs-operator hs-var">`tcEqType`</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976425"><span class="hs-identifier hs-var">c2_expanded</span></a></span><span>
</span><span id="line-2708"></span><span>
</span><span id="line-2709"></span><span>    </span><span class="annot"><a href="#local-6989586621681976425"><span class="hs-identifier hs-type">c2_expanded</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcPredType"><span class="hs-identifier hs-type">TcPredType</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Includes all superclasses</span><span>
</span><span id="line-2710"></span><span>    </span><span id="local-6989586621681976425"><span class="annot"><span class="annottext">c2_expanded :: [TcPredType]
</span><a href="#local-6989586621681976425"><span class="hs-identifier hs-var hs-var">c2_expanded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976426"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681976427"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976427"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TcPredType]
</span><a href="#local-6989586621681976421"><span class="hs-identifier hs-var">c2</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681976426"><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976426"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976427"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; [TcPredType] -&gt; [TcPredType]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">TcPredType -&gt; [TcPredType]
</span><a href="GHC.Tc.Utils.TcType.html#transSuperClasses"><span class="hs-identifier hs-var">transSuperClasses</span></a></span><span> </span><span class="annot"><span class="annottext">TcPredType
</span><a href="#local-6989586621681976427"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2711"></span><span>
</span><span id="line-2712"></span><span>
</span><span id="line-2713"></span><span class="hs-comment">{- Note [When does a quantified instance dominate another?]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When matching local quantified instances, it's useful to be able to pick
the one with the weakest precondition, e.g. if one has both

  [G] d1: forall a b. ( Eq a, Num b, C a b  ) =&gt; D a b
  [G] d2: forall a  .                C a Int  =&gt; D a Int
  [W] {w}: D a Int

Then it makes sense to use d2 to solve w, as doing so we end up with a strictly
weaker proof obligation of `C a Int`, compared to `(Eq a, Num Int, C a Int)`
were we to use d1.

In theory, to compute whether one context implies another, we would need to
recursively invoke the constraint solver. This is expensive, so we instead do
a simple check using superclasses, implemented in impliedBySCs.

Examples:

 - [Eq a] is implied by [Ord a]
 - [Ord a] is not implied by [Eq a],
 - any context is implied by itself,
 - the empty context is implied by any context.

Note [Use only the best matching quantified constraint]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (#20582) the ambiguity check for
  (forall a. Ord (m a), forall a. Semigroup a =&gt; Eq (m a)) =&gt; m Int

Because of eager expansion of given superclasses, we get
  [G] d1: forall a. Ord (m a)
  [G] d2: forall a. Eq (m a)
  [G] d3: forall a. Semigroup a =&gt; Eq (m a)

  [W] {w1}: forall a. Ord (m a)
  [W] {w2}: forall a. Semigroup a =&gt; Eq (m a)

The first wanted is solved straightforwardly. But the second wanted
matches *two* local instances: d2 and d3. Our general rule around multiple local
instances is that we refuse to commit to any of them. However, that
means that our type fails the ambiguity check. That's bad: the type
is perfectly fine. (This actually came up in the wild, in the streamly
library.)

The solution is to prefer local instances which are easier to prove, meaning
that they have a weaker precondition. In this case, the empty context
of d2 is a weaker constraint than the &quot;Semigroup a&quot; context of d3, so we prefer
using it when proving w2. This allows us to pass the ambiguity check here.

Our criterion for solving a Wanted by matching local quantified instances is
thus as follows:

  - There is a matching local quantified instance that dominates all others
    matches, in the sense of [When does a quantified instance dominate another?].
    Any such match do, we pick it arbitrarily (the T22223 example below says why).
  - This local quantified instance also dominates all the unifiers, as we
    wouldn't want to commit to a single match when we might have multiple,
    genuinely different matches after further unification takes place.

Some other examples:


  #15244:

    f :: (C g, D g) =&gt; ....
    class S g =&gt; C g where ...
    class S g =&gt; D g where ...
    class (forall a. Eq a =&gt; Eq (g a)) =&gt; S g where ...

  Here, in f's RHS, there are two identical quantified constraints
  available, one via the superclasses of C and one via the superclasses
  of D. Given that each implies the other, we pick one arbitrarily.


  #22216:

    class Eq a
    class Eq a =&gt; Ord a
    class (forall b. Eq b =&gt; Eq (f b)) =&gt; Eq1 f
    class (Eq1 f, forall b. Ord b =&gt; Ord (f b)) =&gt; Ord1 f

  Suppose we have

    [G] d1: Ord1 f
    [G] d2: Eq a
    [W] {w}: Eq (f a)

  Superclass expansion of d1 gives us:

    [G] d3 : Eq1 f
    [G] d4 : forall b. Ord b =&gt; Ord (f b)

  expanding d4 and d5 gives us, respectively:

    [G] d5 : forall b. Eq  b =&gt; Eq (f b)
    [G] d6 : forall b. Ord b =&gt; Eq (f b)

  Now we have two matching local instances that we could use when solving the
  Wanted. However, it's obviously silly to use d6, given that d5 provides us with
  as much information, with a strictly weaker precondition. So we pick d5 to solve
  w. If we chose d6, we would get [W] Ord a, which in this case we can't solve.


  #22223:

    [G] forall a b. (Eq a, Ord b) =&gt; C a b
    [G] forall a b. (Ord b, Eq a) =&gt; C a b
    [W] C x y

  Here we should be free to pick either quantified constraint, as they are
  equivalent up to re-ordering of the constraints in the context.
  See also Note [Do not add duplicate quantified instances]
  in GHC.Tc.Solver.Monad.

Test cases:
  typecheck/should_compile/T20582
  quantified-constraints/T15244
  quantified-constraints/T22216{a,b,c,d,e}
  quantified-constraints/T22223

Historical note: a previous solution was to instead pick the local instance
with the least superclass depth (see Note [Replacement vs keeping]),
but that doesn't work for the example from #22216.
-}</span><span>
</span><span id="line-2837"></span></pre></body></html>