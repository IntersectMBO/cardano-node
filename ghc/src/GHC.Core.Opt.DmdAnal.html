<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1993-1998


                        -----------------
                        A demand analysis
                        -----------------
-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Core.Opt.DmdAnal</span><span>
</span><span id="line-12"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#DmdAnalOpts"><span class="hs-identifier">DmdAnalOpts</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalProgram"><span class="hs-identifier">dmdAnalProgram</span></a></span><span>
</span><span id="line-14"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">where</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html"><span class="hs-identifier">GHC.Core.Opt.WorkWrap.Utils</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span>   </span><span class="hs-comment">-- All of it</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Multiplicity.html"><span class="hs-identifier">GHC.Core.Multiplicity</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier">scaledThing</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.List.html#/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapAccumL/Data.Traversable.html#mapAccumL"><span class="hs-identifier">mapAccumL</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.ForeignCall.html"><span class="hs-identifier">GHC.Types.ForeignCall</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.ForeignCall.html#isSafeForeignCall"><span class="hs-identifier">isSafeForeignCall</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#isClassPred"><span class="hs-identifier">isClassPred</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#rulesRhsFreeIds"><span class="hs-identifier">rulesRhsFreeIds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#bndrRuleAndUnfoldingIds"><span class="hs-identifier">bndrRuleAndUnfoldingIds</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier">Coercion</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html"><span class="hs-identifier">GHC.Core.TyCo.FVs</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.FVs.html#coVarsOfCos"><span class="hs-identifier">coVarsOfCos</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html"><span class="hs-identifier">GHC.Core.TyCo.Compare</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-identifier">eqType</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html"><span class="hs-identifier">GHC.Core.FamInstEnv</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html"><span class="hs-identifier">GHC.Core.Opt.Arity</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier">typeArity</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html"><span class="hs-identifier">GHC.Utils.Panic.Plain</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.PrimOps.html"><span class="hs-identifier">GHC.Builtin.PrimOps</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html"><span class="hs-identifier">GHC.Builtin.Types.Prim</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier">realWorldStatePrimTy</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Set.html"><span class="hs-identifier">GHC.Types.Unique.Set</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.MemoFun.html"><span class="hs-identifier">GHC.Types.Unique.MemoFun</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.RepType.html"><span class="hs-identifier">GHC.Types.RepType</span></a></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Top level stuff}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="annot"><span class="hs-comment">-- | Options for the demand analysis</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">data</span><span> </span><span id="DmdAnalOpts"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#DmdAnalOpts"><span class="hs-identifier hs-var">DmdAnalOpts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DmdAnalOpts"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#DmdAnalOpts"><span class="hs-identifier hs-var">DmdAnalOpts</span></a></span></span><span>
</span><span id="line-62"></span><span>   </span><span class="hs-special">{</span><span> </span><span id="dmd_strict_dicts"><span class="annot"><span class="annottext">DmdAnalOpts -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#dmd_strict_dicts"><span class="hs-identifier hs-var hs-var">dmd_strict_dicts</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-63"></span><span>   </span><span class="hs-comment">-- ^ Value of `-fdicts-strict` (on by default).</span><span>
</span><span id="line-64"></span><span>   </span><span class="hs-comment">-- When set, all functons are implicitly strict in dictionary args.</span><span>
</span><span id="line-65"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="dmd_do_boxity"><span class="annot"><span class="annottext">DmdAnalOpts -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#dmd_do_boxity"><span class="hs-identifier hs-var hs-var">dmd_do_boxity</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-66"></span><span>   </span><span class="hs-comment">-- ^ Governs whether the analysis should update boxity signatures.</span><span>
</span><span id="line-67"></span><span>   </span><span class="hs-comment">-- See Note [Don't change boxity without worker/wrapper].</span><span>
</span><span id="line-68"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="dmd_unbox_width"><span class="annot"><span class="annottext">DmdAnalOpts -&gt; Arity
</span><a href="GHC.Core.Opt.DmdAnal.html#dmd_unbox_width"><span class="hs-identifier hs-var hs-var">dmd_unbox_width</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-69"></span><span>   </span><span class="hs-comment">-- ^ Value of `-fdmd-unbox-width`.</span><span>
</span><span id="line-70"></span><span>   </span><span class="hs-comment">-- See Note [Unboxed demand on function bodies returning small products]</span><span>
</span><span id="line-71"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="dmd_max_worker_args"><span class="annot"><span class="annottext">DmdAnalOpts -&gt; Arity
</span><a href="GHC.Core.Opt.DmdAnal.html#dmd_max_worker_args"><span class="hs-identifier hs-var hs-var">dmd_max_worker_args</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-72"></span><span>   </span><span class="hs-comment">-- ^ Value of `-fmax-worker-args`.</span><span>
</span><span id="line-73"></span><span>   </span><span class="hs-comment">-- Don't unbox anything if we end up with more than this many args.</span><span>
</span><span id="line-74"></span><span>   </span><span class="hs-special">}</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">-- This is a strict alternative to (,)</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- See Note [Space Leaks in Demand Analysis]</span><span>
</span><span id="line-78"></span><span class="hs-keyword">data</span><span> </span><span id="WithDmdType"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span></span><span> </span><span id="local-6989586621681826659"><span class="annot"><a href="#local-6989586621681826659"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="WithDmdType"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621681826659"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span id="local-6989586621681826648"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#getAnnotated"><span class="hs-identifier hs-type">getAnnotated</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681826648"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681826648"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-81"></span><span id="getAnnotated"><span class="annot"><span class="annottext">getAnnotated :: forall a. WithDmdType a -&gt; a
</span><a href="GHC.Core.Opt.DmdAnal.html#getAnnotated"><span class="hs-identifier hs-var hs-var">getAnnotated</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681826898"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681826898"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681826898"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="hs-keyword">data</span><span> </span><span id="DmdResult"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#DmdResult"><span class="hs-identifier hs-var">DmdResult</span></a></span></span><span> </span><span id="local-6989586621681826683"><span class="annot"><a href="#local-6989586621681826683"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621681826684"><span class="annot"><a href="#local-6989586621681826684"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="R"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#R"><span class="hs-identifier hs-var">R</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621681826683"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621681826684"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-comment">-- | Outputs a new copy of the Core program in which binders have been annotated</span><span>
</span><span id="line-86"></span><span class="hs-comment">-- with demand and strictness information.</span><span>
</span><span id="line-87"></span><span class="hs-comment">--</span><span>
</span><span id="line-88"></span><span class="hs-comment">-- Note: use `seqBinds` on the result to avoid leaks due to lazyness (cf Note</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- [Stamp out space leaks in demand analysis])</span><span>
</span><span id="line-90"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalProgram"><span class="hs-identifier hs-type">dmdAnalProgram</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#DmdAnalOpts"><span class="hs-identifier hs-type">DmdAnalOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span>
</span><span id="line-91"></span><span id="dmdAnalProgram"><span class="annot"><span class="annottext">dmdAnalProgram :: DmdAnalOpts
-&gt; FamInstEnvs -&gt; [CoreRule] -&gt; CoreProgram -&gt; CoreProgram
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalProgram"><span class="hs-identifier hs-var hs-var">dmdAnalProgram</span></a></span></span><span> </span><span id="local-6989586621681826900"><span class="annot"><span class="annottext">DmdAnalOpts
</span><a href="#local-6989586621681826900"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681826901"><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681826901"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span id="local-6989586621681826902"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681826902"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span id="local-6989586621681826903"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681826903"><span class="hs-identifier hs-var">binds</span></a></span></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WithDmdType CoreProgram -&gt; CoreProgram
forall a. WithDmdType a -&gt; a
</span><a href="GHC.Core.Opt.DmdAnal.html#getAnnotated"><span class="hs-identifier hs-var">getAnnotated</span></a></span><span> </span><span class="annot"><span class="annottext">(WithDmdType CoreProgram -&gt; CoreProgram)
-&gt; WithDmdType CoreProgram -&gt; CoreProgram
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; CoreProgram -&gt; WithDmdType CoreProgram
</span><a href="#local-6989586621681826904"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdAnalOpts -&gt; FamInstEnvs -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#emptyAnalEnv"><span class="hs-identifier hs-var">emptyAnalEnv</span></a></span><span> </span><span class="annot"><span class="annottext">DmdAnalOpts
</span><a href="#local-6989586621681826900"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681826901"><span class="hs-identifier hs-var">fam_envs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681826903"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-comment">-- See Note [Analysing top-level bindings]</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-comment">-- and Note [Why care for top-level demand annotations?]</span><span>
</span><span id="line-96"></span><span>    </span><span id="local-6989586621681826904"><span class="annot"><span class="annottext">go :: AnalEnv -&gt; CoreProgram -&gt; WithDmdType CoreProgram
</span><a href="#local-6989586621681826904"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; CoreProgram -&gt; WithDmdType CoreProgram
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="GHC.Types.Demand.html#nopDmdType"><span class="hs-identifier hs-var">nopDmdType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><a href="#local-6989586621681826904"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681826907"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826907"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681826908"><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681826908"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681826909"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681826909"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WithDmdType (DmdResult (Bind Id) CoreProgram)
-&gt; WithDmdType CoreProgram
forall b. WithDmdType (DmdResult b [b]) -&gt; WithDmdType [b]
</span><a href="#local-6989586621681826910"><span class="hs-identifier hs-var">cons_up</span></a></span><span> </span><span class="annot"><span class="annottext">(WithDmdType (DmdResult (Bind Id) CoreProgram)
 -&gt; WithDmdType CoreProgram)
-&gt; WithDmdType (DmdResult (Bind Id) CoreProgram)
-&gt; WithDmdType CoreProgram
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; Bind Id
-&gt; (AnalEnv -&gt; WithDmdType CoreProgram)
-&gt; WithDmdType (DmdResult (Bind Id) CoreProgram)
forall a.
TopLevelFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; Bind Id
-&gt; (AnalEnv -&gt; WithDmdType a)
-&gt; WithDmdType (DmdResult (Bind Id) a)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalBind"><span class="hs-identifier hs-var">dmdAnalBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826907"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="GHC.Types.Demand.html#topSubDmd"><span class="hs-identifier hs-var">topSubDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681826908"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; WithDmdType CoreProgram
</span><a href="#local-6989586621681826914"><span class="hs-identifier hs-var">anal_body</span></a></span><span>
</span><span id="line-98"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-99"></span><span>        </span><span id="local-6989586621681826914"><span class="annot"><span class="annottext">anal_body :: AnalEnv -&gt; WithDmdType CoreProgram
</span><a href="#local-6989586621681826914"><span class="hs-identifier hs-var hs-var">anal_body</span></a></span></span><span> </span><span id="local-6989586621681826915"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826915"><span class="hs-identifier hs-var">env'</span></a></span></span><span>
</span><span id="line-100"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681826916"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681826916"><span class="hs-identifier hs-var">body_ty</span></a></span></span><span> </span><span id="local-6989586621681826917"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681826917"><span class="hs-identifier hs-var">bs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; CoreProgram -&gt; WithDmdType CoreProgram
</span><a href="#local-6989586621681826904"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826915"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681826909"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-101"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; CoreProgram -&gt; WithDmdType CoreProgram
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681826916"><span class="hs-identifier hs-var">body_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; DmdEnv -&gt; DmdType
</span><a href="GHC.Types.Demand.html#plusDmdType"><span class="hs-operator hs-var">`plusDmdType`</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; [Id] -&gt; DmdEnv
</span><a href="#local-6989586621681826919"><span class="hs-identifier hs-var">keep_alive_roots</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826915"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bind Id -&gt; [Id]
forall b. Bind b -&gt; [b]
</span><a href="GHC.Core.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681826908"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681826917"><span class="hs-identifier hs-var">bs'</span></a></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span>    </span><span id="local-6989586621681826663"><span class="annot"><a href="#local-6989586621681826910"><span class="hs-identifier hs-type">cons_up</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681826663"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681826663"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681826663"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-104"></span><span>    </span><span id="local-6989586621681826910"><span class="annot"><span class="annottext">cons_up :: forall b. WithDmdType (DmdResult b [b]) -&gt; WithDmdType [b]
</span><a href="#local-6989586621681826910"><span class="hs-identifier hs-var hs-var">cons_up</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681826921"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681826921"><span class="hs-identifier hs-var">dmd_ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#R"><span class="hs-identifier hs-type">R</span></a></span><span> </span><span id="local-6989586621681826922"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681826922"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span id="local-6989586621681826923"><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621681826923"><span class="hs-identifier hs-var">bs'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; [b] -&gt; WithDmdType [b]
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681826921"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681826922"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; [b] -&gt; [b]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621681826923"><span class="hs-identifier hs-var">bs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><a href="#local-6989586621681826919"><span class="hs-identifier hs-type">keep_alive_roots</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-comment">-- See Note [Absence analysis for stable unfoldings and RULES]</span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-comment">-- Here we keep alive &quot;roots&quot;, e.g., exported ids and stuff mentioned in</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-comment">-- orphan RULES</span><span>
</span><span id="line-110"></span><span>    </span><span id="local-6989586621681826919"><span class="annot"><span class="annottext">keep_alive_roots :: AnalEnv -&gt; [Id] -&gt; DmdEnv
</span><a href="#local-6989586621681826919"><span class="hs-identifier hs-var hs-var">keep_alive_roots</span></a></span></span><span> </span><span id="local-6989586621681826924"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826924"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681826925"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681826925"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DmdEnv] -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#plusDmdEnvs"><span class="hs-identifier hs-var">plusDmdEnvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; DmdEnv) -&gt; [Id] -&gt; [DmdEnv]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#demandRoot"><span class="hs-identifier hs-var">demandRoot</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826924"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; [Id]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#filter/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="#local-6989586621681826928"><span class="hs-identifier hs-var">is_root</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681826925"><span class="hs-identifier hs-var">ids</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><a href="#local-6989586621681826928"><span class="hs-identifier hs-type">is_root</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-113"></span><span>    </span><span id="local-6989586621681826928"><span class="annot"><span class="annottext">is_root :: Id -&gt; Bool
</span><a href="#local-6989586621681826928"><span class="hs-identifier hs-var hs-var">is_root</span></a></span></span><span> </span><span id="local-6989586621681826929"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826929"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isExportedId"><span class="hs-identifier hs-var">isExportedId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826929"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarSet -&gt; Bool
</span><a href="GHC.Types.Var.Set.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826929"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681826933"><span class="hs-identifier hs-var">rule_fvs</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span>    </span><span class="annot"><a href="#local-6989586621681826933"><span class="hs-identifier hs-type">rule_fvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a></span><span>
</span><span id="line-116"></span><span>    </span><span id="local-6989586621681826933"><span class="annot"><span class="annottext">rule_fvs :: VarSet
</span><a href="#local-6989586621681826933"><span class="hs-identifier hs-var hs-var">rule_fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreRule] -&gt; VarSet
</span><a href="GHC.Core.FVs.html#rulesRhsFreeIds"><span class="hs-identifier hs-var">rulesRhsFreeIds</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681826902"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#demandRoot"><span class="hs-identifier hs-type">demandRoot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a></span><span>
</span><span id="line-119"></span><span class="hs-comment">-- See Note [Absence analysis for stable unfoldings and RULES]</span><span>
</span><span id="line-120"></span><span id="demandRoot"><span class="annot"><span class="annottext">demandRoot :: AnalEnv -&gt; Id -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#demandRoot"><span class="hs-identifier hs-var hs-var">demandRoot</span></a></span></span><span> </span><span id="local-6989586621681826935"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826935"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681826936"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826936"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DmdEnv, CoreExpr) -&gt; DmdEnv
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; Demand -&gt; CoreExpr -&gt; (DmdEnv, CoreExpr)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalStar"><span class="hs-identifier hs-var">dmdAnalStar</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826935"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826936"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#demandRoots"><span class="hs-identifier hs-type">demandRoots</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a></span><span>
</span><span id="line-123"></span><span class="hs-comment">-- See Note [Absence analysis for stable unfoldings and RULES]</span><span>
</span><span id="line-124"></span><span id="demandRoots"><span class="annot"><span class="annottext">demandRoots :: AnalEnv -&gt; [Id] -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#demandRoots"><span class="hs-identifier hs-var hs-var">demandRoots</span></a></span></span><span> </span><span id="local-6989586621681826942"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826942"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681826943"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681826943"><span class="hs-identifier hs-var">roots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DmdEnv] -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#plusDmdEnvs"><span class="hs-identifier hs-var">plusDmdEnvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; DmdEnv) -&gt; [Id] -&gt; [DmdEnv]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#demandRoot"><span class="hs-identifier hs-var">demandRoot</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826942"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681826943"><span class="hs-identifier hs-var">roots</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#demandRootSet"><span class="hs-identifier hs-type">demandRootSet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a></span><span>
</span><span id="line-127"></span><span id="demandRootSet"><span class="annot"><span class="annottext">demandRootSet :: AnalEnv -&gt; VarSet -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#demandRootSet"><span class="hs-identifier hs-var hs-var">demandRootSet</span></a></span></span><span> </span><span id="local-6989586621681826945"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826945"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681826946"><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681826946"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; [Id] -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#demandRoots"><span class="hs-identifier hs-var">demandRoots</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826945"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarSet -&gt; [Id]
forall elt. UniqSet elt -&gt; [elt]
</span><a href="GHC.Types.Unique.Set.html#nonDetEltsUniqSet"><span class="hs-identifier hs-var">nonDetEltsUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681826946"><span class="hs-identifier hs-var">ids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>  </span><span class="hs-comment">-- It's OK to use nonDetEltsUniqSet here because plusDmdType is commutative</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-comment">-- | We attach useful (e.g. not 'topDmd') 'idDemandInfo' to top-level bindings</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- that satisfy this function.</span><span>
</span><span id="line-132"></span><span class="hs-comment">--</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- Basically, we want to know how top-level *functions* are *used*</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- (e.g. called). The information will always be lazy.</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- Any other top-level bindings are boring.</span><span>
</span><span id="line-136"></span><span class="hs-comment">--</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- See also Note [Why care for top-level demand annotations?].</span><span>
</span><span id="line-138"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#isInterestingTopLevelFn"><span class="hs-identifier hs-type">isInterestingTopLevelFn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-139"></span><span class="hs-comment">-- SG tried to set this to True and got a +2% ghc/alloc regression in T5642</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- (which is dominated by the Simplifier) at no gain in analysis precision.</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- If there was a gain, that regression might be acceptable.</span><span>
</span><span id="line-142"></span><span class="hs-comment">-- Plus, we could use LetUp for thunks and share some code with local let</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- bindings.</span><span>
</span><span id="line-144"></span><span id="isInterestingTopLevelFn"><span class="annot"><span class="annottext">isInterestingTopLevelFn :: Id -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#isInterestingTopLevelFn"><span class="hs-identifier hs-var hs-var">isInterestingTopLevelFn</span></a></span></span><span> </span><span id="local-6989586621681826950"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826950"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Arity
</span><a href="GHC.Core.Opt.Arity.html#typeArity"><span class="hs-identifier hs-var">typeArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826950"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">0</span></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-comment">{- Note [Stamp out space leaks in demand analysis]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The demand analysis pass outputs a new copy of the Core program in
which binders have been annotated with demand and strictness
information. It's tiresome to ensure that this information is fully
evaluated everywhere that we produce it, so we just run a single
seqBinds over the output before returning it, to ensure that there are
no references holding on to the input Core program.

This makes a ~30% reduction in peak memory usage when compiling
DynFlags (cf #9675 and #13426).

This is particularly important when we are doing late demand analysis,
since we don't do a seqBinds at any point thereafter. Hence code
generation would hold on to an extra copy of the Core program, via
unforced thunks in demand or strictness information; and it is the
most memory-intensive part of the compilation process, so this added
seqBinds makes a big difference in peak memory usage.

Note [Don't change boxity without worker/wrapper]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (T21754)
  f n = n+1
  {-# NOINLINE f #-}
With `-fno-worker-wrapper`, we should not give `f` a boxity signature that says
that it unboxes its argument! Client modules would never be able to cancel away
the box for n. Likewise we shouldn't give `f` the CPR property.

Similarly, in the last run of DmdAnal before codegen (which does not have a
worker/wrapper phase) we should not change boxity in any way. Remember: an
earlier result of the demand analyser, complete with worker/wrapper, has aleady
given a demand signature (with boxity info) to the function.
(The &quot;last run&quot; is mainly there to attach demanded-once info to let-bindings.)

In general, we should not run Note [Boxity analysis] unless worker/wrapper
follows to exploit the boxity and make sure that calling modules can observe the
reported boxity.

Hence DmdAnal is configured by a flag `dmd_do_boxity` that is True only
if worker/wrapper follows after DmdAnal. If it is not set, and the signature
is not subject to Note [Boxity for bottoming functions], DmdAnal tries
to transfer over the previous boxity to the new demand signature, in
`setIdDmdAndBoxSig`.

Why isn't CprAnal configured with a similar flag? Because if we aren't going to
do worker/wrapper we don't run CPR analysis at all. (see GHC.Core.Opt.Pipeline)

It might be surprising that we only try to preserve *arg* boxity, not boxity on
FVs. But FV demands won't make it into interface files anyway, so it's a waste
of energy.
Besides, W/W zaps the `DmdEnv` portion of a signature, so we don't know the old
boxity to begin with; see Note [Zapping DmdEnv after Demand Analyzer].

Note [Analysing top-level bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider a CoreProgram like
  e1 = ...
  n1 = ...
  e2 = \a b -&gt; ... fst (n1 a b) ...
  n2 = \c d -&gt; ... snd (e2 c d) ...
  ...
where e* are exported, but n* are not.
Intuitively, we can see that @n1@ is only ever called with two arguments
and in every call site, the first component of the result of the call
is evaluated. Thus, we'd like it to have idDemandInfo @LC(L,C(M,P(1L,A))@.
NB: We may *not* give e2 a similar annotation, because it is exported and
external callers might use it in arbitrary ways, expressed by 'topDmd'.
This can then be exploited by Nested CPR and eta-expansion,
see Note [Why care for top-level demand annotations?].

How do we get this result? Answer: By analysing the program as if it was a let
expression of this form:
  let e1 = ... in
  let n1 = ... in
  let e2 = ... in
  let n2 = ... in
  (e1,e2, ...)
E.g. putting all bindings in nested lets and returning all exported binders in a tuple.
Of course, we will not actually build that CoreExpr! Instead we faithfully
simulate analysis of said expression by adding the free variable 'DmdEnv'
of @e*@'s strictness signatures to the 'DmdType' we get from analysing the
nested bindings.

And even then the above form blows up analysis performance in T10370:
If @e1@ uses many free variables, we'll unnecessarily carry their demands around
with us from the moment we analyse the pair to the moment we bubble back up to
the binding for @e1@. So instead we analyse as if we had
  let e1 = ... in
  (e1, let n1 = ... in
  (    let e2 = ... in
  (e2, let n2 = ... in
  (    ...))))
That is, a series of right-nested pairs, where the @fst@ are the exported
binders of the last enclosing let binding and @snd@ continues the nested
lets.

Variables occurring free in RULE RHSs are to be handled the same as exported Ids.
See also Note [Absence analysis for stable unfoldings and RULES].

Note [Why care for top-level demand annotations?]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Reading Note [Analysing top-level bindings], you might think that we go through
quite some trouble to get useful demands for top-level bindings. They can never
be strict, for example, so why bother?

First, we get to eta-expand top-level bindings that we weren't able to
eta-expand before without Call Arity. From T18894b:
  module T18894b (f) where
  eta :: Int -&gt; Int -&gt; Int
  eta x = if fst (expensive x) == 13 then \y -&gt; ... else \y -&gt; ...
  f m = ... eta m 2 ... eta 2 m ...
Since only @f@ is exported, we see all call sites of @eta@ and can eta-expand to
arity 2.

The call demands we get for some top-level bindings will also allow Nested CPR
to unbox deeper. From T18894:
  module T18894 (h) where
  g m n = (2 * m, 2 `div` n)
  {-# NOINLINE g #-}
  h :: Int -&gt; Int
  h m = ... snd (g m 2) ... uncurry (+) (g 2 m) ...
Only @h@ is exported, hence we see that @g@ is always called in contexts were we
also force the division in the second component of the pair returned by @g@.
This allows Nested CPR to evaluate the division eagerly and return an I# in its
position.
-}</span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{The analyser itself}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span class="hs-comment">-- | Analyse a binding group and its \&quot;body\&quot;, e.g. where it is in scope.</span><span>
</span><span id="line-282"></span><span class="hs-comment">--</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- It calls a function that knows how to analyse this \&quot;body\&quot; given</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- an 'AnalEnv' with updated demand signatures for the binding group</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- (reflecting their 'idDmdSigInfo') and expects to receive a</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- 'DmdType' in return, which it uses to annotate the binding group with their</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- 'idDemandInfo'.</span><span>
</span><span id="line-288"></span><span id="local-6989586621681826666"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalBind"><span class="hs-identifier hs-type">dmdAnalBind</span></a></span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span>                 </span><span class="hs-comment">-- ^ Demand put on the &quot;body&quot;</span><span>
</span><span id="line-292"></span><span>                               </span><span class="hs-comment">--   (important for join points)</span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681826666"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ How to analyse the &quot;body&quot;, e.g.</span><span>
</span><span id="line-295"></span><span>                               </span><span class="hs-comment">--   where the binding is in scope</span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681826666"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-297"></span><span id="dmdAnalBind"><span class="annot"><span class="annottext">dmdAnalBind :: forall a.
TopLevelFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; Bind Id
-&gt; (AnalEnv -&gt; WithDmdType a)
-&gt; WithDmdType (DmdResult (Bind Id) a)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalBind"><span class="hs-identifier hs-var hs-var">dmdAnalBind</span></a></span></span><span> </span><span id="local-6989586621681826955"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681826955"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681826956"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826956"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681826957"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681826957"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span id="local-6989586621681826958"><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681826958"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621681826959"><span class="annot"><span class="annottext">AnalEnv -&gt; WithDmdType a
</span><a href="#local-6989586621681826959"><span class="hs-identifier hs-var">anal_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681826958"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-298"></span><span>  </span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681826961"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826961"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681826962"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826962"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Id -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#useLetUp"><span class="hs-identifier hs-var">useLetUp</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681826955"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826961"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; AnalEnv
-&gt; Id
-&gt; CoreExpr
-&gt; (AnalEnv -&gt; WithDmdType a)
-&gt; WithDmdType (DmdResult (Bind Id) a)
forall a.
TopLevelFlag
-&gt; AnalEnv
-&gt; Id
-&gt; CoreExpr
-&gt; (AnalEnv -&gt; WithDmdType a)
-&gt; WithDmdType (DmdResult (Bind Id) a)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalBindLetUp"><span class="hs-identifier hs-var">dmdAnalBindLetUp</span></a></span><span>   </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681826955"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826965"><span class="hs-identifier hs-var">env_rhs</span></a></span><span>     </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826961"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826962"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; WithDmdType a
</span><a href="#local-6989586621681826959"><span class="hs-identifier hs-var">anal_body</span></a></span><span>
</span><span id="line-301"></span><span>  </span><span class="annot"><span class="annottext">Bind Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; Bind Id
-&gt; (AnalEnv -&gt; WithDmdType a)
-&gt; WithDmdType (DmdResult (Bind Id) a)
forall a.
TopLevelFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; Bind Id
-&gt; (AnalEnv -&gt; WithDmdType a)
-&gt; WithDmdType (DmdResult (Bind Id) a)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalBindLetDown"><span class="hs-identifier hs-var">dmdAnalBindLetDown</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681826955"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826965"><span class="hs-identifier hs-var">env_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681826957"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681826958"><span class="hs-identifier hs-var">bind</span></a></span><span>   </span><span class="annot"><span class="annottext">AnalEnv -&gt; WithDmdType a
</span><a href="#local-6989586621681826959"><span class="hs-identifier hs-var">anal_body</span></a></span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-303"></span><span>    </span><span id="local-6989586621681826965"><span class="annot"><span class="annottext">env_rhs :: AnalEnv
</span><a href="#local-6989586621681826965"><span class="hs-identifier hs-var hs-var">env_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bind Id -&gt; AnalEnv -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#enterDFun"><span class="hs-identifier hs-var">enterDFun</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681826958"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826956"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="hs-comment">-- | Annotates uninteresting top level functions ('isInterestingTopLevelFn')</span><span>
</span><span id="line-306"></span><span class="hs-comment">-- with 'topDmd', the rest with the given demand.</span><span>
</span><span id="line-307"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#setBindIdDemandInfo"><span class="hs-identifier hs-type">setBindIdDemandInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-308"></span><span id="setBindIdDemandInfo"><span class="annot"><span class="annottext">setBindIdDemandInfo :: TopLevelFlag -&gt; Id -&gt; Demand -&gt; Id
</span><a href="GHC.Core.Opt.DmdAnal.html#setBindIdDemandInfo"><span class="hs-identifier hs-var hs-var">setBindIdDemandInfo</span></a></span></span><span> </span><span id="local-6989586621681826969"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681826969"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681826970"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826970"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681826971"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681826971"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Demand -&gt; Id
</span><a href="GHC.Types.Id.html#setIdDemandInfo"><span class="hs-identifier hs-var">setIdDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826970"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">(Demand -&gt; Id) -&gt; Demand -&gt; Id
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681826969"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#isInterestingTopLevelFn"><span class="hs-identifier hs-var">isInterestingTopLevelFn</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826970"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span>
</span><span id="line-310"></span><span>  </span><span class="annot"><span class="annottext">TopLevelFlag
</span><span class="hs-identifier">_</span></span><span>                                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681826971"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-311"></span><span>
</span><span id="line-312"></span><span class="hs-comment">-- | Update the demand signature, but be careful not to change boxity info if</span><span>
</span><span id="line-313"></span><span class="hs-comment">-- `dmd_do_boxity` is True or if the signature is bottom.</span><span>
</span><span id="line-314"></span><span class="hs-comment">-- See Note [Don't change boxity without worker/wrapper]</span><span>
</span><span id="line-315"></span><span class="hs-comment">-- and Note [Boxity for bottoming functions].</span><span>
</span><span id="line-316"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#setIdDmdAndBoxSig"><span class="hs-identifier hs-type">setIdDmdAndBoxSig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#DmdAnalOpts"><span class="hs-identifier hs-type">DmdAnalOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-317"></span><span id="setIdDmdAndBoxSig"><span class="annot"><span class="annottext">setIdDmdAndBoxSig :: DmdAnalOpts -&gt; Id -&gt; DmdSig -&gt; Id
</span><a href="GHC.Core.Opt.DmdAnal.html#setIdDmdAndBoxSig"><span class="hs-identifier hs-var hs-var">setIdDmdAndBoxSig</span></a></span></span><span> </span><span id="local-6989586621681826975"><span class="annot"><span class="annottext">DmdAnalOpts
</span><a href="#local-6989586621681826975"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681826976"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826976"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681826977"><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681826977"><span class="hs-identifier hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; DmdSig -&gt; Id
</span><a href="GHC.Types.Id.html#setIdDmdSig"><span class="hs-identifier hs-var">setIdDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826976"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">(DmdSig -&gt; Id) -&gt; DmdSig -&gt; Id
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">DmdAnalOpts -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#dmd_do_boxity"><span class="hs-identifier hs-var">dmd_do_boxity</span></a></span><span> </span><span class="annot"><span class="annottext">DmdAnalOpts
</span><a href="#local-6989586621681826975"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; Bool
</span><a href="GHC.Types.Demand.html#isBottomingSig"><span class="hs-identifier hs-var">isBottomingSig</span></a></span><span> </span><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681826977"><span class="hs-identifier hs-var">sig</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681826977"><span class="hs-identifier hs-var">sig</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; DmdSig -&gt; DmdSig
</span><a href="GHC.Types.Demand.html#transferArgBoxityDmdSig"><span class="hs-identifier hs-var">transferArgBoxityDmdSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826976"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681826977"><span class="hs-identifier hs-var">sig</span></a></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span class="hs-comment">-- | Let bindings can be processed in two ways:</span><span>
</span><span id="line-323"></span><span class="hs-comment">-- Down (RHS before body) or Up (body before RHS).</span><span>
</span><span id="line-324"></span><span class="hs-comment">-- This function handles the up variant.</span><span>
</span><span id="line-325"></span><span class="hs-comment">--</span><span>
</span><span id="line-326"></span><span class="hs-comment">-- It is very simple. For  let x = rhs in body</span><span>
</span><span id="line-327"></span><span class="hs-comment">--   * Demand-analyse 'body' in the current environment</span><span>
</span><span id="line-328"></span><span class="hs-comment">--   * Find the demand, 'rhs_dmd' placed on 'x' by 'body'</span><span>
</span><span id="line-329"></span><span class="hs-comment">--   * Demand-analyse 'rhs' in 'rhs_dmd'</span><span>
</span><span id="line-330"></span><span class="hs-comment">--</span><span>
</span><span id="line-331"></span><span class="hs-comment">-- This is used for a non-recursive local let without manifest lambdas (see</span><span>
</span><span id="line-332"></span><span class="hs-comment">-- 'useLetUp').</span><span>
</span><span id="line-333"></span><span class="hs-comment">--</span><span>
</span><span id="line-334"></span><span class="hs-comment">-- This is the LetUp rule in the paper &#8220;Higher-Order Cardinality Analysis&#8221;.</span><span>
</span><span id="line-335"></span><span id="local-6989586621681826681"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalBindLetUp"><span class="hs-identifier hs-type">dmdAnalBindLetUp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span>
</span><span id="line-336"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-337"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-338"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-339"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681826681"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681826681"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-341"></span><span id="dmdAnalBindLetUp"><span class="annot"><span class="annottext">dmdAnalBindLetUp :: forall a.
TopLevelFlag
-&gt; AnalEnv
-&gt; Id
-&gt; CoreExpr
-&gt; (AnalEnv -&gt; WithDmdType a)
-&gt; WithDmdType (DmdResult (Bind Id) a)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalBindLetUp"><span class="hs-identifier hs-var hs-var">dmdAnalBindLetUp</span></a></span></span><span> </span><span id="local-6989586621681826982"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681826982"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681826983"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826983"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681826984"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826984"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681826985"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826985"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621681826986"><span class="annot"><span class="annottext">AnalEnv -&gt; WithDmdType a
</span><a href="#local-6989586621681826986"><span class="hs-identifier hs-var">anal_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType
-&gt; DmdResult (Bind Id) a -&gt; WithDmdType (DmdResult (Bind Id) a)
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681826987"><span class="hs-identifier hs-var">final_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bind Id -&gt; a -&gt; DmdResult (Bind Id) a
forall a b. a -&gt; b -&gt; DmdResult a b
</span><a href="GHC.Core.Opt.DmdAnal.html#R"><span class="hs-identifier hs-var">R</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; Bind Id
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826988"><span class="hs-identifier hs-var">id'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826989"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681826990"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681826991"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681826991"><span class="hs-identifier hs-var">body_ty</span></a></span></span><span> </span><span id="local-6989586621681826990"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681826990"><span class="hs-identifier hs-var">body'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; WithDmdType a
</span><a href="#local-6989586621681826986"><span class="hs-identifier hs-var">anal_body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#addInScopeAnalEnv"><span class="hs-identifier hs-var">addInScopeAnalEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826983"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826984"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>    </span><span class="hs-comment">-- See Note [Bringing a new variable into scope]</span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681826993"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681826993"><span class="hs-identifier hs-var">body_ty'</span></a></span></span><span> </span><span id="local-6989586621681826994"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681826994"><span class="hs-identifier hs-var">id_dmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdType -&gt; Id -&gt; WithDmdType Demand
</span><a href="GHC.Core.Opt.DmdAnal.html#findBndrDmd"><span class="hs-identifier hs-var">findBndrDmd</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826983"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681826991"><span class="hs-identifier hs-var">body_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826984"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-comment">-- See Note [Finalising boxity for demand signatures]</span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span>    </span><span id="local-6989586621681826996"><span class="annot"><span class="annottext">id_dmd' :: Demand
</span><a href="#local-6989586621681826996"><span class="hs-identifier hs-var hs-var">id_dmd'</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Type -&gt; Demand -&gt; Demand
</span><a href="GHC.Core.Opt.DmdAnal.html#finaliseLetBoxity"><span class="hs-identifier hs-var">finaliseLetBoxity</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826983"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826984"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681826994"><span class="hs-identifier hs-var">id_dmd</span></a></span><span>
</span><span id="line-349"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681826988"><span class="annot"><span class="annottext">id' :: Id
</span><a href="#local-6989586621681826988"><span class="hs-identifier hs-var hs-var">id'</span></a></span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Id -&gt; Demand -&gt; Id
</span><a href="GHC.Core.Opt.DmdAnal.html#setBindIdDemandInfo"><span class="hs-identifier hs-var">setBindIdDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681826982"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826984"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681826996"><span class="hs-identifier hs-var">id_dmd'</span></a></span><span>
</span><span id="line-350"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681826998"><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681826998"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681826989"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826989"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Demand -&gt; CoreExpr -&gt; (DmdEnv, CoreExpr)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalStar"><span class="hs-identifier hs-var">dmdAnalStar</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826983"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681826996"><span class="hs-identifier hs-var">id_dmd'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826985"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span>    </span><span class="hs-comment">-- See Note [Absence analysis for stable unfoldings and RULES]</span><span>
</span><span id="line-353"></span><span>    </span><span id="local-6989586621681826999"><span class="annot"><span class="annottext">rule_fvs :: VarSet
</span><a href="#local-6989586621681826999"><span class="hs-identifier hs-var hs-var">rule_fvs</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; VarSet
</span><a href="GHC.Core.FVs.html#bndrRuleAndUnfoldingIds"><span class="hs-identifier hs-var">bndrRuleAndUnfoldingIds</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681826984"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-354"></span><span>    </span><span id="local-6989586621681826987"><span class="annot"><span class="annottext">final_ty :: DmdType
</span><a href="#local-6989586621681826987"><span class="hs-identifier hs-var hs-var">final_ty</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681826993"><span class="hs-identifier hs-var">body_ty'</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; DmdEnv -&gt; DmdType
</span><a href="GHC.Types.Demand.html#plusDmdType"><span class="hs-operator hs-var">`plusDmdType`</span></a></span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681826998"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; DmdEnv -&gt; DmdType
</span><a href="GHC.Types.Demand.html#plusDmdType"><span class="hs-operator hs-var">`plusDmdType`</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; VarSet -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#demandRootSet"><span class="hs-identifier hs-var">demandRootSet</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681826983"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet
</span><a href="#local-6989586621681826999"><span class="hs-identifier hs-var">rule_fvs</span></a></span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span class="hs-comment">-- | Let bindings can be processed in two ways:</span><span>
</span><span id="line-357"></span><span class="hs-comment">-- Down (RHS before body) or Up (body before RHS).</span><span>
</span><span id="line-358"></span><span class="hs-comment">-- This function handles the down variant.</span><span>
</span><span id="line-359"></span><span class="hs-comment">--</span><span>
</span><span id="line-360"></span><span class="hs-comment">-- It computes a demand signature (by means of 'dmdAnalRhsSig') and uses</span><span>
</span><span id="line-361"></span><span class="hs-comment">-- that at call sites in the body.</span><span>
</span><span id="line-362"></span><span class="hs-comment">--</span><span>
</span><span id="line-363"></span><span class="hs-comment">-- It is used for toplevel definitions, recursive definitions and local</span><span>
</span><span id="line-364"></span><span class="hs-comment">-- non-recursive definitions that have manifest lambdas (cf. 'useLetUp').</span><span>
</span><span id="line-365"></span><span class="hs-comment">-- Local non-recursive definitions without a lambda are handled with LetUp.</span><span>
</span><span id="line-366"></span><span class="hs-comment">--</span><span>
</span><span id="line-367"></span><span class="hs-comment">-- This is the LetDown rule in the paper &#8220;Higher-Order Cardinality Analysis&#8221;.</span><span>
</span><span id="line-368"></span><span id="local-6989586621681827001"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalBindLetDown"><span class="hs-identifier hs-type">dmdAnalBindLetDown</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681827001"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681827001"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-369"></span><span id="dmdAnalBindLetDown"><span class="annot"><span class="annottext">dmdAnalBindLetDown :: forall a.
TopLevelFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; Bind Id
-&gt; (AnalEnv -&gt; WithDmdType a)
-&gt; WithDmdType (DmdResult (Bind Id) a)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalBindLetDown"><span class="hs-identifier hs-var hs-var">dmdAnalBindLetDown</span></a></span></span><span> </span><span id="local-6989586621681827002"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827002"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681827003"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827003"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827004"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827004"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span id="local-6989586621681827005"><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681827005"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621681827006"><span class="annot"><span class="annottext">AnalEnv -&gt; WithDmdType a
</span><a href="#local-6989586621681827006"><span class="hs-identifier hs-var">anal_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681827005"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-370"></span><span>  </span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681827007"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827007"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681827008"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827008"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-371"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827009"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827009"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827010"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827010"><span class="hs-identifier hs-var">weak_fv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827011"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827011"><span class="hs-identifier hs-var">id1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827012"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827012"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-372"></span><span>        </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; RecFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; Id
-&gt; CoreExpr
-&gt; (AnalEnv, WeakDmds, Id, CoreExpr)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalRhsSig"><span class="hs-identifier hs-var">dmdAnalRhsSig</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827002"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827003"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827004"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827007"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827008"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-373"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AnalEnv
-&gt; WeakDmds
-&gt; [(Id, CoreExpr)]
-&gt; ([(Id, CoreExpr)] -&gt; Bind Id)
-&gt; WithDmdType (DmdResult (Bind Id) a)
</span><a href="#local-6989586621681827014"><span class="hs-identifier hs-var">do_rest</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827009"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827010"><span class="hs-identifier hs-var">weak_fv</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827011"><span class="hs-identifier hs-var">id1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827012"><span class="hs-identifier hs-var">rhs1</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Id -&gt; CoreExpr -&gt; Bind Id) -&gt; (Id, CoreExpr) -&gt; Bind Id
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#uncurry/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; Bind Id
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; Bind Id)
-&gt; ([(Id, CoreExpr)] -&gt; (Id, CoreExpr))
-&gt; [(Id, CoreExpr)]
-&gt; Bind Id
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; (Id, CoreExpr)
forall a. [a] -&gt; a
</span><a href="GHC.Utils.Misc.html#only"><span class="hs-identifier hs-var">only</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>  </span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681827019"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827019"><span class="hs-identifier hs-var">pairs</span></a></span></span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827020"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827020"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827021"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827021"><span class="hs-identifier hs-var">weak_fv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827022"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827022"><span class="hs-identifier hs-var">pairs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; [(Id, CoreExpr)]
-&gt; (AnalEnv, WeakDmds, [(Id, CoreExpr)])
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdFix"><span class="hs-identifier hs-var">dmdFix</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827002"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827003"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827004"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827019"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AnalEnv
-&gt; WeakDmds
-&gt; [(Id, CoreExpr)]
-&gt; ([(Id, CoreExpr)] -&gt; Bind Id)
-&gt; WithDmdType (DmdResult (Bind Id) a)
</span><a href="#local-6989586621681827014"><span class="hs-identifier hs-var">do_rest</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827020"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827021"><span class="hs-identifier hs-var">weak_fv</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827022"><span class="hs-identifier hs-var">pairs'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; Bind Id
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span>
</span><span id="line-377"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-378"></span><span>    </span><span id="local-6989586621681827014"><span class="annot"><span class="annottext">do_rest :: AnalEnv
-&gt; WeakDmds
-&gt; [(Id, CoreExpr)]
-&gt; ([(Id, CoreExpr)] -&gt; Bind Id)
-&gt; WithDmdType (DmdResult (Bind Id) a)
</span><a href="#local-6989586621681827014"><span class="hs-identifier hs-var hs-var">do_rest</span></a></span></span><span> </span><span id="local-6989586621681827024"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827024"><span class="hs-identifier hs-var">env'</span></a></span></span><span> </span><span id="local-6989586621681827025"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827025"><span class="hs-identifier hs-var">weak_fv</span></a></span></span><span> </span><span id="local-6989586621681827026"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827026"><span class="hs-identifier hs-var">pairs1</span></a></span></span><span> </span><span id="local-6989586621681827027"><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; Bind Id
</span><a href="#local-6989586621681827027"><span class="hs-identifier hs-var">build_bind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType
-&gt; DmdResult (Bind Id) a -&gt; WithDmdType (DmdResult (Bind Id) a)
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827028"><span class="hs-identifier hs-var">final_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bind Id -&gt; a -&gt; DmdResult (Bind Id) a
forall a b. a -&gt; b -&gt; DmdResult a b
</span><a href="GHC.Core.Opt.DmdAnal.html#R"><span class="hs-identifier hs-var">R</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; Bind Id
</span><a href="#local-6989586621681827027"><span class="hs-identifier hs-var">build_bind</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827029"><span class="hs-identifier hs-var">pairs2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681827030"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-379"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-380"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827031"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827031"><span class="hs-identifier hs-var">body_ty</span></a></span></span><span> </span><span id="local-6989586621681827030"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681827030"><span class="hs-identifier hs-var">body'</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; WithDmdType a
</span><a href="#local-6989586621681827006"><span class="hs-identifier hs-var">anal_body</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827024"><span class="hs-identifier hs-var">env'</span></a></span><span>
</span><span id="line-381"></span><span>        </span><span class="hs-comment">-- see Note [Lazy and unleashable free variables]</span><span>
</span><span id="line-382"></span><span>        </span><span id="local-6989586621681827032"><span class="annot"><span class="annottext">dmd_ty :: DmdType
</span><a href="#local-6989586621681827032"><span class="hs-identifier hs-var hs-var">dmd_ty</span></a></span></span><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; WeakDmds -&gt; DmdType
</span><a href="GHC.Core.Opt.DmdAnal.html#addWeakFVs"><span class="hs-identifier hs-var">addWeakFVs</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827031"><span class="hs-identifier hs-var">body_ty</span></a></span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827025"><span class="hs-identifier hs-var">weak_fv</span></a></span><span>
</span><span id="line-383"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827028"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827028"><span class="hs-identifier hs-var">final_ty</span></a></span></span><span> </span><span id="local-6989586621681827034"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827034"><span class="hs-identifier hs-var">id_dmds</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdType -&gt; [Id] -&gt; WithDmdType [Demand]
</span><a href="GHC.Core.Opt.DmdAnal.html#findBndrsDmds"><span class="hs-identifier hs-var">findBndrsDmds</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827024"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827032"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; Id) -&gt; [(Id, CoreExpr)] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="GHC.Utils.Misc.html#strictMap"><span class="hs-identifier hs-var">strictMap</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827026"><span class="hs-identifier hs-var">pairs1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-comment">-- Important to force this as build_bind might not force it.</span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681827029"><span class="annot"><span class="annottext">pairs2 :: [(Id, CoreExpr)]
</span><a href="#local-6989586621681827029"><span class="hs-identifier hs-var hs-var">pairs2</span></a></span></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; Demand -&gt; (Id, CoreExpr))
-&gt; [(Id, CoreExpr)] -&gt; [Demand] -&gt; [(Id, CoreExpr)]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="GHC.Utils.Misc.html#strictZipWith"><span class="hs-identifier hs-var">strictZipWith</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; Demand -&gt; (Id, CoreExpr)
</span><a href="#local-6989586621681827038"><span class="hs-identifier hs-var">do_one</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827026"><span class="hs-identifier hs-var">pairs1</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827034"><span class="hs-identifier hs-var">id_dmds</span></a></span><span>
</span><span id="line-386"></span><span>        </span><span id="local-6989586621681827038"><span class="annot"><span class="annottext">do_one :: (Id, CoreExpr) -&gt; Demand -&gt; (Id, CoreExpr)
</span><a href="#local-6989586621681827038"><span class="hs-identifier hs-var hs-var">do_one</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827039"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827039"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827040"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827040"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681827041"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827041"><span class="hs-identifier hs-var">dmd</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; CoreExpr -&gt; (Id, CoreExpr))
-&gt; Id -&gt; CoreExpr -&gt; (Id, CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24%21/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Id -&gt; Demand -&gt; Id
</span><a href="GHC.Core.Opt.DmdAnal.html#setBindIdDemandInfo"><span class="hs-identifier hs-var">setBindIdDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827002"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827039"><span class="hs-identifier hs-var">id'</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827041"><span class="hs-identifier hs-var">dmd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; (Id, CoreExpr)) -&gt; CoreExpr -&gt; (Id, CoreExpr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24%21/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827040"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-387"></span><span>        </span><span class="hs-comment">-- If the actual demand is better than the vanilla call</span><span>
</span><span id="line-388"></span><span>        </span><span class="hs-comment">-- demand, you might think that we might do better to re-analyse</span><span>
</span><span id="line-389"></span><span>        </span><span class="hs-comment">-- the RHS with the stronger demand.</span><span>
</span><span id="line-390"></span><span>        </span><span class="hs-comment">-- But (a) That seldom happens, because it means that *every* path in</span><span>
</span><span id="line-391"></span><span>        </span><span class="hs-comment">--         the body of the let has to use that stronger demand</span><span>
</span><span id="line-392"></span><span>        </span><span class="hs-comment">-- (b) It often happens temporarily in when fixpointing, because</span><span>
</span><span id="line-393"></span><span>        </span><span class="hs-comment">--     the recursive function at first seems to place a massive demand.</span><span>
</span><span id="line-394"></span><span>        </span><span class="hs-comment">--     But we don't want to go to extra work when the function will</span><span>
</span><span id="line-395"></span><span>        </span><span class="hs-comment">--     probably iterate to something less demanding.</span><span>
</span><span id="line-396"></span><span>        </span><span class="hs-comment">-- In practice, all the times the actual demand on id2 is more than</span><span>
</span><span id="line-397"></span><span>        </span><span class="hs-comment">-- the vanilla call demand seem to be due to (b).  So we don't</span><span>
</span><span id="line-398"></span><span>        </span><span class="hs-comment">-- bother to re-analyse the RHS.</span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span class="hs-comment">-- | Mimic the effect of 'GHC.Core.Prep.mkFloat', turning non-trivial argument</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- expressions/RHSs into a proper let-bound thunk (lifted) or a case (with</span><span>
</span><span id="line-402"></span><span class="hs-comment">-- unlifted scrutinee).</span><span>
</span><span id="line-403"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#anticipateANF"><span class="hs-identifier hs-type">anticipateANF</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Card"><span class="hs-identifier hs-type">Card</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Card"><span class="hs-identifier hs-type">Card</span></a></span><span>
</span><span id="line-404"></span><span id="anticipateANF"><span class="annot"><span class="annottext">anticipateANF :: CoreExpr -&gt; Card -&gt; Card
</span><a href="GHC.Core.Opt.DmdAnal.html#anticipateANF"><span class="hs-identifier hs-var hs-var">anticipateANF</span></a></span></span><span> </span><span id="local-6989586621681827044"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827044"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681827045"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827045"><span class="hs-identifier hs-var">n</span></a></span></span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827044"><span class="hs-identifier hs-var">e</span></a></span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827045"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-comment">-- trivial expr won't have a binding</span><span>
</span><span id="line-406"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Levity
</span><a href="GHC.Types.Basic.html#Unlifted"><span class="hs-identifier hs-var">Unlifted</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Maybe Levity
Type -&gt; Maybe Levity
</span><a href="GHC.Core.Type.html#typeLevity_maybe"><span class="hs-identifier hs-var">typeLevity_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CoreExpr -&gt; Type
CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827044"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Card -&gt; Bool
</span><a href="GHC.Types.Demand.html#isAbs"><span class="hs-identifier hs-var">isAbs</span></a></span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827045"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprOkForSpeculation"><span class="hs-identifier hs-var">exprOkForSpeculation</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827044"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Card -&gt; Card
forall {p}. p -&gt; Card
</span><a href="#local-6989586621681827053"><span class="hs-identifier hs-var">case_bind</span></a></span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827045"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-408"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Card -&gt; Card
</span><a href="#local-6989586621681827054"><span class="hs-identifier hs-var">let_bind</span></a></span><span>  </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827045"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-409"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-410"></span><span>    </span><span id="local-6989586621681827053"><span class="annot"><span class="annottext">case_bind :: p -&gt; Card
</span><a href="#local-6989586621681827053"><span class="hs-identifier hs-var hs-var">case_bind</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="GHC.Types.Demand.html#C_11"><span class="hs-identifier hs-var">C_11</span></a></span><span>       </span><span class="hs-comment">-- evaluated exactly once</span><span>
</span><span id="line-411"></span><span>    </span><span id="local-6989586621681827054"><span class="annot"><span class="annottext">let_bind :: Card -&gt; Card
</span><a href="#local-6989586621681827054"><span class="hs-identifier hs-var hs-var">let_bind</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Card -&gt; Card
</span><a href="GHC.Types.Demand.html#oneifyCard"><span class="hs-identifier hs-var">oneifyCard</span></a></span><span> </span><span class="hs-comment">-- evaluated at most once</span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span class="hs-comment">-- Do not process absent demands</span><span>
</span><span id="line-414"></span><span class="hs-comment">-- Otherwise act like in a normal demand analysis</span><span>
</span><span id="line-415"></span><span class="hs-comment">-- See &#8614;* relation in the Cardinality Analysis paper</span><span>
</span><span id="line-416"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalStar"><span class="hs-identifier hs-type">dmdAnalStar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-417"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>   </span><span class="hs-comment">-- This one takes a *Demand*</span><span>
</span><span id="line-418"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-419"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span id="dmdAnalStar"><span class="annot"><span class="annottext">dmdAnalStar :: AnalEnv -&gt; Demand -&gt; CoreExpr -&gt; (DmdEnv, CoreExpr)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalStar"><span class="hs-identifier hs-var hs-var">dmdAnalStar</span></a></span></span><span> </span><span id="local-6989586621681827057"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827057"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827058"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827058"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-type">:*</span></a></span><span> </span><span id="local-6989586621681827060"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827060"><span class="hs-identifier hs-var">sd</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681827061"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827061"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-421"></span><span>  </span><span class="hs-comment">-- NB: (:*) expands AbsDmd and BotDmd as needed</span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827062"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827062"><span class="hs-identifier hs-var">dmd_ty</span></a></span></span><span> </span><span id="local-6989586621681827063"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827063"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827057"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827060"><span class="hs-identifier hs-var">sd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827061"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827065"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827065"><span class="hs-identifier hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Card -&gt; Card
</span><a href="GHC.Core.Opt.DmdAnal.html#anticipateANF"><span class="hs-identifier hs-var">anticipateANF</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827061"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827058"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-424"></span><span>      </span><span class="hs-comment">-- See Note [Anticipating ANF in demand analysis]</span><span>
</span><span id="line-425"></span><span>      </span><span class="hs-comment">-- and Note [Analysing with absent demand]</span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdType -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#discardArgDmds"><span class="hs-identifier hs-var">discardArgDmds</span></a></span><span> </span><span class="annot"><span class="annottext">(DmdType -&gt; DmdEnv) -&gt; DmdType -&gt; DmdEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Card -&gt; DmdType -&gt; DmdType
</span><a href="GHC.Types.Demand.html#multDmdType"><span class="hs-identifier hs-var">multDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827065"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827062"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827063"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span class="hs-comment">-- Main Demand Analysis machinery</span><span>
</span><span id="line-429"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-type">dmdAnal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-type">dmdAnal'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span>         </span><span class="hs-comment">-- The main one takes a *SubDemand*</span><span>
</span><span id="line-431"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span id="dmdAnal"><span class="annot"><span class="annottext">dmdAnal :: AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var hs-var">dmdAnal</span></a></span></span><span> </span><span id="local-6989586621681827069"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827069"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827070"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827070"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621681827071"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827071"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dmdAnal&quot; (ppr d &lt;+&gt; ppr e) $</span><span>
</span><span id="line-434"></span><span>                  </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827069"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827070"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827071"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span id="dmdAnal%27"><span class="annot"><span class="annottext">dmdAnal' :: AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var hs-var">dmdAnal'</span></a></span></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621681827073"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681827073"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="GHC.Types.Demand.html#nopDmdType"><span class="hs-identifier hs-var">nopDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Literal -&gt; CoreExpr
forall b. Literal -&gt; Expr b
</span><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-var">Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681827073"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621681827075"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827075"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="GHC.Types.Demand.html#nopDmdType"><span class="hs-identifier hs-var">nopDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827075"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Doesn't happen, in fact</span><span>
</span><span id="line-438"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621681827077"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681827077"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdEnv -&gt; DmdType
</span><a href="GHC.Core.Opt.DmdAnal.html#noArgsDmdType"><span class="hs-identifier hs-var">noArgsDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#coercionDmdEnv"><span class="hs-identifier hs-var">coercionDmdEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681827077"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; CoreExpr
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681827077"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a></span><span> </span><span id="local-6989586621681827080"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827080"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827081"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827081"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681827082"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827082"><span class="hs-identifier hs-var">var</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-442"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; SubDemand -&gt; DmdType
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdTransform"><span class="hs-identifier hs-var">dmdTransform</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827080"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827082"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827081"><span class="hs-identifier hs-var">dmd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr
forall b. Id -&gt; Expr b
</span><a href="GHC.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827082"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>
</span><span id="line-444"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a></span><span> </span><span id="local-6989586621681827084"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827084"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827085"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827085"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681827087"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827087"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681827088"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681827088"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827089"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; DmdEnv -&gt; DmdType
</span><a href="GHC.Types.Demand.html#plusDmdType"><span class="hs-operator hs-var">`plusDmdType`</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#coercionDmdEnv"><span class="hs-identifier hs-var">coercionDmdEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681827088"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Coercion -&gt; CoreExpr
forall b. Expr b -&gt; Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827090"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681827088"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-447"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827089"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827089"><span class="hs-identifier hs-var">dmd_ty</span></a></span></span><span> </span><span id="local-6989586621681827090"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827090"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827084"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827085"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827087"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a></span><span> </span><span id="local-6989586621681827091"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827091"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827092"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827092"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621681827094"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681827094"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621681827095"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827095"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827096"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681827094"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827097"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-452"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827096"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827096"><span class="hs-identifier hs-var">dmd_ty</span></a></span></span><span> </span><span id="local-6989586621681827097"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827097"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827091"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827092"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827095"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a></span><span> </span><span id="local-6989586621681827098"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827098"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827099"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827099"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681827101"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827101"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621681827102"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827102"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827103"><span class="hs-identifier hs-var">fun_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827104"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; CoreExpr
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827102"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-457"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827103"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827103"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span id="local-6989586621681827104"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827104"><span class="hs-identifier hs-var">fun'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827098"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827099"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827101"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span class="hs-comment">-- Lots of the other code is there to make this</span><span>
</span><span id="line-460"></span><span class="hs-comment">-- beautiful, compositional, application rule :-)</span><span>
</span><span id="line-461"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a></span><span> </span><span id="local-6989586621681827105"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827105"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827106"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827106"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681827107"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827107"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681827108"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827108"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- This case handles value arguments (type args handled above)</span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-comment">-- Crucially, coercions /are/ handled here, because they are</span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-comment">-- value arguments (#10288)</span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-466"></span><span>        </span><span id="local-6989586621681827109"><span class="annot"><span class="annottext">call_dmd :: SubDemand
</span><a href="#local-6989586621681827109"><span class="hs-identifier hs-var hs-var">call_dmd</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubDemand -&gt; SubDemand
</span><a href="GHC.Types.Demand.html#mkCalledOnceDmd"><span class="hs-identifier hs-var">mkCalledOnceDmd</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827106"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-467"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827111"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827111"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span id="local-6989586621681827112"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827112"><span class="hs-identifier hs-var">fun'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827105"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827109"><span class="hs-identifier hs-var">call_dmd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827107"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-468"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681827113"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827113"><span class="hs-identifier hs-var">arg_dmd</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827114"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827114"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; (Demand, DmdType)
</span><a href="GHC.Types.Demand.html#splitDmdTy"><span class="hs-identifier hs-var">splitDmdTy</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827111"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-469"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681827116"><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827116"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827117"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827117"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Demand -&gt; CoreExpr -&gt; (DmdEnv, CoreExpr)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalStar"><span class="hs-identifier hs-var">dmdAnalStar</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827105"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827113"><span class="hs-identifier hs-var">arg_dmd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827108"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-470"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-471"></span><span class="hs-comment">--    pprTrace &quot;dmdAnal:app&quot; (vcat</span><span>
</span><span id="line-472"></span><span class="hs-comment">--         [ text &quot;dmd =&quot; &lt;+&gt; ppr dmd</span><span>
</span><span id="line-473"></span><span class="hs-comment">--         , text &quot;expr =&quot; &lt;+&gt; ppr (App fun arg)</span><span>
</span><span id="line-474"></span><span class="hs-comment">--         , text &quot;fun dmd_ty =&quot; &lt;+&gt; ppr fun_ty</span><span>
</span><span id="line-475"></span><span class="hs-comment">--         , text &quot;arg dmd =&quot; &lt;+&gt; ppr arg_dmd</span><span>
</span><span id="line-476"></span><span class="hs-comment">--         , text &quot;arg dmd_ty =&quot; &lt;+&gt; ppr arg_ty</span><span>
</span><span id="line-477"></span><span class="hs-comment">--         , text &quot;res dmd_ty =&quot; &lt;+&gt; ppr res_ty</span><span>
</span><span id="line-478"></span><span class="hs-comment">--         , text &quot;overall res dmd_ty =&quot; &lt;+&gt; ppr (res_ty `plusDmdType` arg_ty) ])</span><span>
</span><span id="line-479"></span><span>    </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827114"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; DmdEnv -&gt; DmdType
</span><a href="GHC.Types.Demand.html#plusDmdType"><span class="hs-operator hs-var">`plusDmdType`</span></a></span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827116"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827112"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827117"><span class="hs-identifier hs-var">arg'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>
</span><span id="line-481"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a></span><span> </span><span id="local-6989586621681827118"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827118"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827119"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827119"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681827121"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827121"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621681827122"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827122"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827121"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-483"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-484"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827124"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827124"><span class="hs-identifier hs-var">body_ty</span></a></span></span><span> </span><span id="local-6989586621681827125"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827125"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#addInScopeAnalEnv"><span class="hs-identifier hs-var">addInScopeAnalEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827118"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827121"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827119"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827122"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-485"></span><span>        </span><span class="hs-comment">-- See Note [Bringing a new variable into scope]</span><span>
</span><span id="line-486"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-487"></span><span>    </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827124"><span class="hs-identifier hs-var">body_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827121"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827125"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-490"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827126"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827126"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827127"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827127"><span class="hs-identifier hs-var">body_dmd</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubDemand -&gt; (Card, SubDemand)
</span><a href="GHC.Types.Demand.html#peelCallDmd"><span class="hs-identifier hs-var">peelCallDmd</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827119"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-491"></span><span>          </span><span class="hs-comment">-- body_dmd: a demand to analyze the body</span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827129"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827129"><span class="hs-identifier hs-var">body_ty</span></a></span></span><span> </span><span id="local-6989586621681827130"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827130"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#addInScopeAnalEnv"><span class="hs-identifier hs-var">addInScopeAnalEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827118"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827121"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827127"><span class="hs-identifier hs-var">body_dmd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827122"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-494"></span><span>        </span><span class="hs-comment">-- See Note [Bringing a new variable into scope]</span><span>
</span><span id="line-495"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827131"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827131"><span class="hs-identifier hs-var">lam_ty</span></a></span></span><span> </span><span id="local-6989586621681827132"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827132"><span class="hs-identifier hs-var">var'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdType -&gt; Id -&gt; WithDmdType Id
</span><a href="GHC.Core.Opt.DmdAnal.html#annotateLamIdBndr"><span class="hs-identifier hs-var">annotateLamIdBndr</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827118"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827129"><span class="hs-identifier hs-var">body_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827121"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-496"></span><span>        </span><span id="local-6989586621681827134"><span class="annot"><span class="annottext">new_dmd_type :: DmdType
</span><a href="#local-6989586621681827134"><span class="hs-identifier hs-var hs-var">new_dmd_type</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Card -&gt; DmdType -&gt; DmdType
</span><a href="GHC.Types.Demand.html#multDmdType"><span class="hs-identifier hs-var">multDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827126"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827131"><span class="hs-identifier hs-var">lam_ty</span></a></span><span>
</span><span id="line-497"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-498"></span><span>    </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827134"><span class="hs-identifier hs-var">new_dmd_type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827132"><span class="hs-identifier hs-var">var'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827130"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a></span><span> </span><span id="local-6989586621681827135"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827135"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827136"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827136"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621681827138"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827138"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621681827139"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827139"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621681827140"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827140"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621681827142"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681827142"><span class="hs-identifier hs-var">alt_con</span></a></span></span><span> </span><span id="local-6989586621681827143"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827143"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621681827144"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827144"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-comment">-- Only one alternative.</span><span>
</span><span id="line-502"></span><span>  </span><span class="hs-comment">-- If it's a DataAlt, it should be the only constructor of the type and we</span><span>
</span><span id="line-503"></span><span>  </span><span class="hs-comment">-- can consider its field demands when analysing the scrutinee.</span><span>
</span><span id="line-504"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; Bool
</span><a href="#local-6989586621681827145"><span class="hs-identifier hs-var">want_precise_field_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681827142"><span class="hs-identifier hs-var">alt_con</span></a></span><span>
</span><span id="line-505"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-506"></span><span>        </span><span id="local-6989586621681827146"><span class="annot"><span class="annottext">rhs_env :: AnalEnv
</span><a href="#local-6989586621681827146"><span class="hs-identifier hs-var hs-var">rhs_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; [Id] -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#addInScopeAnalEnvs"><span class="hs-identifier hs-var">addInScopeAnalEnvs</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827135"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827139"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827143"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>        </span><span class="hs-comment">-- See Note [Bringing a new variable into scope]</span><span>
</span><span id="line-508"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827148"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827148"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span> </span><span id="local-6989586621681827149"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827149"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827146"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827136"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827144"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-509"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827150"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827150"><span class="hs-identifier hs-var">alt_ty1</span></a></span></span><span> </span><span id="local-6989586621681827151"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827151"><span class="hs-identifier hs-var">fld_dmds</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdType -&gt; [Id] -&gt; WithDmdType [Demand]
</span><a href="GHC.Core.Opt.DmdAnal.html#findBndrsDmds"><span class="hs-identifier hs-var">findBndrsDmds</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827135"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827148"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827143"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-510"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827152"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827152"><span class="hs-identifier hs-var">alt_ty2</span></a></span></span><span> </span><span id="local-6989586621681827153"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827153"><span class="hs-identifier hs-var">case_bndr_dmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdType -&gt; Id -&gt; WithDmdType Demand
</span><a href="GHC.Core.Opt.DmdAnal.html#findBndrDmd"><span class="hs-identifier hs-var">findBndrDmd</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827135"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827150"><span class="hs-identifier hs-var">alt_ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827139"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>
</span><span id="line-511"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681827154"><span class="annot"><span class="annottext">case_bndr' :: Id
</span><a href="#local-6989586621681827154"><span class="hs-identifier hs-var hs-var">case_bndr'</span></a></span></span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Demand -&gt; Id
</span><a href="GHC.Types.Id.html#setIdDemandInfo"><span class="hs-identifier hs-var">setIdDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827139"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827153"><span class="hs-identifier hs-var">case_bndr_dmd</span></a></span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span>        </span><span class="hs-comment">-- Evaluation cardinality on the case binder is irrelevant and a no-op.</span><span>
</span><span id="line-514"></span><span>        </span><span class="hs-comment">-- What matters is its nested sub-demand!</span><span>
</span><span id="line-515"></span><span>        </span><span class="hs-comment">-- NB: If case_bndr_dmd is absDmd, boxity will say Unboxed, which is</span><span>
</span><span id="line-516"></span><span>        </span><span class="hs-comment">-- what we want, because then `seq` will put a `seqDmd` on its scrut.</span><span>
</span><span id="line-517"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Card
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-type">:*</span></a></span><span> </span><span id="local-6989586621681827155"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827155"><span class="hs-identifier hs-var">case_bndr_sd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#strictifyDmd"><span class="hs-identifier hs-var">strictifyDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827153"><span class="hs-identifier hs-var">case_bndr_dmd</span></a></span><span>
</span><span id="line-518"></span><span>
</span><span id="line-519"></span><span>        </span><span class="hs-comment">-- Compute demand on the scrutinee</span><span>
</span><span id="line-520"></span><span>        </span><span class="hs-comment">-- FORCE the result, otherwise thunks will end up retaining the</span><span>
</span><span id="line-521"></span><span>        </span><span class="hs-comment">-- whole DmdEnv</span><span>
</span><span id="line-522"></span><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621681827157"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827157"><span class="hs-identifier hs-var">bndrs'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681827158"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827158"><span class="hs-identifier hs-var">scrut_sd</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681827142"><span class="hs-identifier hs-var">alt_con</span></a></span><span>
</span><span id="line-524"></span><span>          </span><span class="hs-comment">-- See Note [Demand on the scrutinee of a product case]</span><span>
</span><span id="line-525"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681827160"><span class="annot"><span class="annottext">scrut_sd :: SubDemand
</span><a href="#local-6989586621681827160"><span class="hs-identifier hs-var hs-var">scrut_sd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubDemand -&gt; [Demand] -&gt; SubDemand
</span><a href="GHC.Core.Opt.DmdAnal.html#scrutSubDmd"><span class="hs-identifier hs-var">scrutSubDmd</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827155"><span class="hs-identifier hs-var">case_bndr_sd</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827151"><span class="hs-identifier hs-var">fld_dmds</span></a></span><span>
</span><span id="line-526"></span><span>          </span><span class="hs-comment">-- See Note [Demand on case-alternative binders]</span><span>
</span><span id="line-527"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681827162"><span class="annot"><span class="annottext">fld_dmds' :: [Demand]
</span><a href="#local-6989586621681827162"><span class="hs-identifier hs-var hs-var">fld_dmds'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubDemand -&gt; Arity -&gt; [Demand]
</span><a href="GHC.Core.Opt.DmdAnal.html#fieldBndrDmds"><span class="hs-identifier hs-var">fieldBndrDmds</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827160"><span class="hs-identifier hs-var">scrut_sd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; Arity
forall a. [a] -&gt; Arity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Arity
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827151"><span class="hs-identifier hs-var">fld_dmds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681827165"><span class="annot"><span class="annottext">bndrs' :: [Id]
</span><a href="#local-6989586621681827165"><span class="hs-identifier hs-var hs-var">bndrs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; [Id] -&gt; [Demand] -&gt; [Id]
[Id] -&gt; [Demand] -&gt; [Id]
</span><a href="GHC.Core.Opt.DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-var">setBndrsDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827143"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827162"><span class="hs-identifier hs-var">fld_dmds'</span></a></span><span>
</span><span id="line-529"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827165"><span class="hs-identifier hs-var">bndrs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827160"><span class="hs-identifier hs-var">scrut_sd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-530"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-531"></span><span>          </span><span class="hs-comment">-- DEFAULT alts. Simply add demands and discard the evaluation</span><span>
</span><span id="line-532"></span><span>          </span><span class="hs-comment">-- cardinality, as we evaluate the scrutinee exactly once.</span><span>
</span><span id="line-533"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ([Id], SubDemand) -&gt; ([Id], SubDemand)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827143"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827143"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827155"><span class="hs-identifier hs-var">case_bndr_sd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>
</span><span id="line-535"></span><span>        </span><span id="local-6989586621681827169"><span class="annot"><span class="annottext">alt_ty3 :: DmdType
</span><a href="#local-6989586621681827169"><span class="hs-identifier hs-var hs-var">alt_ty3</span></a></span></span><span>
</span><span id="line-536"></span><span>          </span><span class="hs-comment">-- See Note [Precise exceptions and strictness analysis] in &quot;GHC.Types.Demand&quot;</span><span>
</span><span id="line-537"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs -&gt; CoreExpr -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#exprMayThrowPreciseException"><span class="hs-identifier hs-var">exprMayThrowPreciseException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; FamInstEnvs
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_fam_envs"><span class="hs-identifier hs-var">ae_fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827135"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827138"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-538"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; DmdType
</span><a href="GHC.Types.Demand.html#deferAfterPreciseException"><span class="hs-identifier hs-var">deferAfterPreciseException</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827152"><span class="hs-identifier hs-var">alt_ty2</span></a></span><span>
</span><span id="line-539"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-540"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827152"><span class="hs-identifier hs-var">alt_ty2</span></a></span><span>
</span><span id="line-541"></span><span>
</span><span id="line-542"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827173"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827173"><span class="hs-identifier hs-var">scrut_ty</span></a></span></span><span> </span><span id="local-6989586621681827174"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827174"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827135"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827158"><span class="hs-identifier hs-var">scrut_sd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827138"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-543"></span><span>        </span><span id="local-6989586621681827175"><span class="annot"><span class="annottext">res_ty :: DmdType
</span><a href="#local-6989586621681827175"><span class="hs-identifier hs-var hs-var">res_ty</span></a></span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827169"><span class="hs-identifier hs-var">alt_ty3</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; DmdEnv -&gt; DmdType
</span><a href="GHC.Types.Demand.html#plusDmdType"><span class="hs-operator hs-var">`plusDmdType`</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#discardArgDmds"><span class="hs-identifier hs-var">discardArgDmds</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827173"><span class="hs-identifier hs-var">scrut_ty</span></a></span><span>
</span><span id="line-544"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-545"></span><span class="hs-comment">--    pprTrace &quot;dmdAnal:Case1&quot; (vcat [ text &quot;scrut&quot; &lt;+&gt; ppr scrut</span><span>
</span><span id="line-546"></span><span class="hs-comment">--                                   , text &quot;dmd&quot; &lt;+&gt; ppr dmd</span><span>
</span><span id="line-547"></span><span class="hs-comment">--                                   , text &quot;case_bndr_dmd&quot; &lt;+&gt; ppr (idDemandInfo case_bndr')</span><span>
</span><span id="line-548"></span><span class="hs-comment">--                                   , text &quot;scrut_sd&quot; &lt;+&gt; ppr scrut_sd</span><span>
</span><span id="line-549"></span><span class="hs-comment">--                                   , text &quot;scrut_ty&quot; &lt;+&gt; ppr scrut_ty</span><span>
</span><span id="line-550"></span><span class="hs-comment">--                                   , text &quot;alt_ty&quot; &lt;+&gt; ppr alt_ty2</span><span>
</span><span id="line-551"></span><span class="hs-comment">--                                   , text &quot;res_ty&quot; &lt;+&gt; ppr res_ty ]) $</span><span>
</span><span id="line-552"></span><span>    </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827175"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; Type -&gt; [Alt Id] -&gt; CoreExpr
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827174"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827154"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827140"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; CoreExpr -&gt; Alt Id
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681827142"><span class="hs-identifier hs-var">alt_con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827157"><span class="hs-identifier hs-var">bndrs'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827149"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-554"></span><span>      </span><span id="local-6989586621681827145"><span class="annot"><span class="annottext">want_precise_field_dmds :: AltCon -&gt; Bool
</span><a href="#local-6989586621681827145"><span class="hs-identifier hs-var hs-var">want_precise_field_dmds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621681827176"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827176"><span class="hs-identifier hs-var">dc</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-555"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe DataCon
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe DataCon
</span><a href="GHC.Core.TyCon.html#tyConSingleAlgDataCon_maybe"><span class="hs-identifier hs-var">tyConSingleAlgDataCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">(TyCon -&gt; Maybe DataCon) -&gt; TyCon -&gt; Maybe DataCon
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; TyCon
</span><a href="GHC.Core.DataCon.html#dataConTyCon"><span class="hs-identifier hs-var">dataConTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827176"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-556"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>    </span><span class="hs-comment">-- Not a product type, even though this is the</span><span>
</span><span id="line-557"></span><span>                   </span><span class="hs-comment">-- only remaining possible data constructor</span><span>
</span><span id="line-558"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DefinitelyRecursive"><span class="hs-identifier hs-var">DefinitelyRecursive</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DataCon -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_rec_dc"><span class="hs-identifier hs-var">ae_rec_dc</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827135"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827176"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-559"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>     </span><span class="hs-comment">-- See Note [Demand analysis for recursive data constructors]</span><span>
</span><span id="line-560"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-561"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-562"></span><span>      </span><span class="annot"><a href="#local-6989586621681827145"><span class="hs-identifier hs-var">want_precise_field_dmds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#LitAlt"><span class="hs-identifier hs-type">LitAlt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>  </span><span class="hs-comment">-- Like the non-product datacon above</span><span>
</span><span id="line-563"></span><span>      </span><span class="annot"><a href="#local-6989586621681827145"><span class="hs-identifier hs-var">want_precise_field_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a></span><span> </span><span id="local-6989586621681827183"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827183"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827184"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827184"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621681827185"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827185"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621681827186"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827186"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span id="local-6989586621681827187"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827187"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681827188"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681827188"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-566"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>      </span><span class="hs-comment">-- Case expression with multiple alternatives</span><span>
</span><span id="line-567"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827189"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827189"><span class="hs-identifier hs-var">scrut_ty</span></a></span></span><span> </span><span id="local-6989586621681827190"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827190"><span class="hs-identifier hs-var">scrut'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827183"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="GHC.Types.Demand.html#topSubDmd"><span class="hs-identifier hs-var">topSubDmd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827185"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-568"></span><span>
</span><span id="line-569"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827191"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827191"><span class="hs-identifier hs-var">alt_ty1</span></a></span></span><span> </span><span id="local-6989586621681827192"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827192"><span class="hs-identifier hs-var">case_bndr_dmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdType -&gt; Id -&gt; WithDmdType Demand
</span><a href="GHC.Core.Opt.DmdAnal.html#findBndrDmd"><span class="hs-identifier hs-var">findBndrDmd</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827183"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827193"><span class="hs-identifier hs-var">alt_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827186"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>
</span><span id="line-570"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681827194"><span class="annot"><span class="annottext">case_bndr' :: Id
</span><a href="#local-6989586621681827194"><span class="hs-identifier hs-var hs-var">case_bndr'</span></a></span></span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Demand -&gt; Id
</span><a href="GHC.Types.Id.html#setIdDemandInfo"><span class="hs-identifier hs-var">setIdDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827186"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827192"><span class="hs-identifier hs-var">case_bndr_dmd</span></a></span><span>
</span><span id="line-571"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827193"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827193"><span class="hs-identifier hs-var">alt_ty</span></a></span></span><span> </span><span id="local-6989586621681827195"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681827195"><span class="hs-identifier hs-var">alts'</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; Id -&gt; [Alt Id] -&gt; WithDmdType [Alt Id]
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalSumAlts"><span class="hs-identifier hs-var">dmdAnalSumAlts</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827183"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827184"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827186"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681827188"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-572"></span><span>
</span><span id="line-573"></span><span>        </span><span id="local-6989586621681827197"><span class="annot"><span class="annottext">fam_envs :: FamInstEnvs
</span><a href="#local-6989586621681827197"><span class="hs-identifier hs-var hs-var">fam_envs</span></a></span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; FamInstEnvs
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_fam_envs"><span class="hs-identifier hs-var">ae_fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827183"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-574"></span><span>        </span><span id="local-6989586621681827198"><span class="annot"><span class="annottext">alt_ty2 :: DmdType
</span><a href="#local-6989586621681827198"><span class="hs-identifier hs-var hs-var">alt_ty2</span></a></span></span><span>
</span><span id="line-575"></span><span>          </span><span class="hs-comment">-- See Note [Precise exceptions and strictness analysis] in &quot;GHC.Types.Demand&quot;</span><span>
</span><span id="line-576"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs -&gt; CoreExpr -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#exprMayThrowPreciseException"><span class="hs-identifier hs-var">exprMayThrowPreciseException</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681827197"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827185"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-577"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; DmdType
</span><a href="GHC.Types.Demand.html#deferAfterPreciseException"><span class="hs-identifier hs-var">deferAfterPreciseException</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827191"><span class="hs-identifier hs-var">alt_ty1</span></a></span><span>
</span><span id="line-578"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-579"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827191"><span class="hs-identifier hs-var">alt_ty1</span></a></span><span>
</span><span id="line-580"></span><span>        </span><span id="local-6989586621681827199"><span class="annot"><span class="annottext">res_ty :: DmdType
</span><a href="#local-6989586621681827199"><span class="hs-identifier hs-var hs-var">res_ty</span></a></span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827189"><span class="hs-identifier hs-var">scrut_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; DmdEnv -&gt; DmdType
</span><a href="GHC.Types.Demand.html#plusDmdType"><span class="hs-operator hs-var">`plusDmdType`</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#discardArgDmds"><span class="hs-identifier hs-var">discardArgDmds</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827198"><span class="hs-identifier hs-var">alt_ty2</span></a></span><span>
</span><span id="line-581"></span><span>
</span><span id="line-582"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-583"></span><span class="hs-comment">--    pprTrace &quot;dmdAnal:Case2&quot; (vcat [ text &quot;scrut&quot; &lt;+&gt; ppr scrut</span><span>
</span><span id="line-584"></span><span class="hs-comment">--                                   , text &quot;scrut_ty&quot; &lt;+&gt; ppr scrut_ty</span><span>
</span><span id="line-585"></span><span class="hs-comment">--                                   , text &quot;alt_ty1&quot; &lt;+&gt; ppr alt_ty1</span><span>
</span><span id="line-586"></span><span class="hs-comment">--                                   , text &quot;alt_ty2&quot; &lt;+&gt; ppr alt_ty2</span><span>
</span><span id="line-587"></span><span class="hs-comment">--                                   , text &quot;res_ty&quot; &lt;+&gt; ppr res_ty ]) $</span><span>
</span><span id="line-588"></span><span>    </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827199"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Id -&gt; Type -&gt; [Alt Id] -&gt; CoreExpr
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827190"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827194"><span class="hs-identifier hs-var">case_bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827187"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681827195"><span class="hs-identifier hs-var">alts'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a></span><span> </span><span id="local-6989586621681827200"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827200"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827201"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827201"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621681827203"><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681827203"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621681827204"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827204"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-591"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; CoreExpr -&gt; WithDmdType CoreExpr
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827205"><span class="hs-identifier hs-var">final_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bind Id -&gt; CoreExpr -&gt; CoreExpr
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681827206"><span class="hs-identifier hs-var">bind'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827207"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-592"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-593"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827205"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827205"><span class="hs-identifier hs-var">final_ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#R"><span class="hs-identifier hs-type">R</span></a></span><span> </span><span id="local-6989586621681827206"><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681827206"><span class="hs-identifier hs-var">bind'</span></a></span></span><span> </span><span id="local-6989586621681827207"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827207"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; Bind Id
-&gt; (AnalEnv -&gt; WithDmdType CoreExpr)
-&gt; WithDmdType (DmdResult (Bind Id) CoreExpr)
forall a.
TopLevelFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; Bind Id
-&gt; (AnalEnv -&gt; WithDmdType a)
-&gt; WithDmdType (DmdResult (Bind Id) a)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalBind"><span class="hs-identifier hs-var">dmdAnalBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827200"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827201"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681827203"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; WithDmdType CoreExpr
</span><a href="#local-6989586621681827209"><span class="hs-identifier hs-var">go'</span></a></span><span>
</span><span id="line-594"></span><span>    </span><span id="local-6989586621681827209"><span class="annot"><span class="annottext">go' :: AnalEnv -&gt; WithDmdType CoreExpr
</span><a href="#local-6989586621681827209"><span class="hs-identifier hs-var hs-var">go'</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681827210"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827210"><span class="hs-identifier hs-var">env'</span></a></span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827210"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827201"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827204"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span class="hs-comment">-- | A simple, syntactic analysis of whether an expression MAY throw a precise</span><span>
</span><span id="line-597"></span><span class="hs-comment">-- exception when evaluated. It's always sound to return 'True'.</span><span>
</span><span id="line-598"></span><span class="hs-comment">-- See Note [Which scrutinees may throw precise exceptions].</span><span>
</span><span id="line-599"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#exprMayThrowPreciseException"><span class="hs-identifier hs-type">exprMayThrowPreciseException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-600"></span><span id="exprMayThrowPreciseException"><span class="annot"><span class="annottext">exprMayThrowPreciseException :: FamInstEnvs -&gt; CoreExpr -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#exprMayThrowPreciseException"><span class="hs-identifier hs-var hs-var">exprMayThrowPreciseException</span></a></span></span><span> </span><span id="local-6989586621681827211"><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681827211"><span class="hs-identifier hs-var">envs</span></a></span></span><span> </span><span id="local-6989586621681827212"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827212"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-601"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FamInstEnvs -&gt; Type -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#forcesRealWorld"><span class="hs-identifier hs-var">forcesRealWorld</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681827211"><span class="hs-identifier hs-var">envs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CoreExpr -&gt; Type
CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827212"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- 1. in the Note</span><span>
</span><span id="line-603"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681827214"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827214"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; (CoreExpr, [CoreExpr])
forall b. Expr b -&gt; (Expr b, [Expr b])
</span><a href="GHC.Core.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827212"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-604"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681827216"><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621681827216"><span class="hs-identifier hs-var">op</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Maybe PrimOp
</span><a href="GHC.Types.Id.html#isPrimOpId_maybe"><span class="hs-identifier hs-var">isPrimOpId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827214"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-605"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621681827216"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; PrimOp -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="GHC.Builtin.PrimOps.html#RaiseIOOp"><span class="hs-identifier hs-var">RaiseIOOp</span></a></span><span>
</span><span id="line-606"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- 2. in the Note</span><span>
</span><span id="line-607"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681827220"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827220"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[CoreExpr]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; (CoreExpr, [CoreExpr])
forall b. Expr b -&gt; (Expr b, [Expr b])
</span><a href="GHC.Core.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827212"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-608"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681827221"><span class="annot"><span class="annottext">ForeignCall
</span><a href="#local-6989586621681827221"><span class="hs-identifier hs-var">fcall</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Maybe ForeignCall
</span><a href="GHC.Types.Id.html#isFCallId_maybe"><span class="hs-identifier hs-var">isFCallId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827220"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-609"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForeignCall -&gt; Bool
</span><a href="GHC.Types.ForeignCall.html#isSafeForeignCall"><span class="hs-identifier hs-var">isSafeForeignCall</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignCall
</span><a href="#local-6989586621681827221"><span class="hs-identifier hs-var">fcall</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-610"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- 3. in the Note</span><span>
</span><span id="line-611"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-612"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-comment">-- _. in the Note</span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span class="hs-comment">-- | Recognises types that are</span><span>
</span><span id="line-615"></span><span class="hs-comment">--    * @State# RealWorld@</span><span>
</span><span id="line-616"></span><span class="hs-comment">--    * Unboxed tuples with a @State# RealWorld@ field</span><span>
</span><span id="line-617"></span><span class="hs-comment">-- modulo coercions. This will detect 'IO' actions (even post Nested CPR! See</span><span>
</span><span id="line-618"></span><span class="hs-comment">-- T13380e) and user-written variants thereof by their type.</span><span>
</span><span id="line-619"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#forcesRealWorld"><span class="hs-identifier hs-type">forcesRealWorld</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-620"></span><span id="forcesRealWorld"><span class="annot"><span class="annottext">forcesRealWorld :: FamInstEnvs -&gt; Type -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#forcesRealWorld"><span class="hs-identifier hs-var hs-var">forcesRealWorld</span></a></span></span><span> </span><span id="local-6989586621681827223"><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681827223"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span> </span><span id="local-6989586621681827224"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827224"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-621"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827224"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-operator hs-var">`eqType`</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-var">realWorldStatePrimTy</span></a></span><span>
</span><span id="line-622"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-623"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827225"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681827225"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827226"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681827226"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827227"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681827227"><span class="hs-identifier hs-var">_co</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs -&gt; Type -&gt; Maybe (TyCon, [Type], Coercion)
</span><a href="GHC.Core.Utils.html#normSplitTyConApp_maybe"><span class="hs-identifier hs-var">normSplitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681827223"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827224"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-624"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isUnboxedTupleTyCon"><span class="hs-identifier hs-var">isUnboxedTupleTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681827225"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-625"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681827230"><span class="annot"><span class="annottext">field_tys :: [Scaled Type]
</span><a href="#local-6989586621681827230"><span class="hs-identifier hs-var hs-var">field_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [Type] -&gt; [Scaled Type]
</span><a href="GHC.Core.DataCon.html#dataConInstArgTys"><span class="hs-identifier hs-var">dataConInstArgTys</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; DataCon
</span><a href="GHC.Core.TyCon.html#tyConSingleDataCon"><span class="hs-identifier hs-var">tyConSingleDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681827225"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681827226"><span class="hs-identifier hs-var">tc_args</span></a></span><span>
</span><span id="line-626"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Scaled Type -&gt; Bool) -&gt; [Scaled Type] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#any/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-identifier hs-var">eqType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="GHC.Builtin.Types.Prim.html#realWorldStatePrimTy"><span class="hs-identifier hs-var">realWorldStatePrimTy</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Bool) -&gt; (Scaled Type -&gt; Type) -&gt; Scaled Type -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Scaled Type -&gt; Type
forall a. Scaled a -&gt; a
</span><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-var">scaledThing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Scaled Type]
</span><a href="#local-6989586621681827230"><span class="hs-identifier hs-var">field_tys</span></a></span><span>
</span><span id="line-627"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-628"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-629"></span><span>
</span><span id="line-630"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalSumAlts"><span class="hs-identifier hs-type">dmdAnalSumAlts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-631"></span><span id="dmdAnalSumAlts"><span class="annot"><span class="annottext">dmdAnalSumAlts :: AnalEnv -&gt; SubDemand -&gt; Id -&gt; [Alt Id] -&gt; WithDmdType [Alt Id]
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalSumAlts"><span class="hs-identifier hs-var hs-var">dmdAnalSumAlts</span></a></span></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; [Alt Id] -&gt; WithDmdType [Alt Id]
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="GHC.Types.Demand.html#botDmdType"><span class="hs-identifier hs-var">botDmdType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-632"></span><span>  </span><span class="hs-comment">-- Base case is botDmdType, for empty case alternatives</span><span>
</span><span id="line-633"></span><span>  </span><span class="hs-comment">-- This is a unit for lubDmdType, and the right result</span><span>
</span><span id="line-634"></span><span>  </span><span class="hs-comment">-- when there really are no alternatives</span><span>
</span><span id="line-635"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalSumAlts"><span class="hs-identifier hs-var">dmdAnalSumAlts</span></a></span><span> </span><span id="local-6989586621681827236"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827236"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827237"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827237"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span id="local-6989586621681827238"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827238"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827239"><span class="annot"><span class="annottext">Alt Id
</span><a href="#local-6989586621681827239"><span class="hs-identifier hs-var">alt</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681827240"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681827240"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-636"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-637"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827241"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827241"><span class="hs-identifier hs-var">cur_ty</span></a></span></span><span>  </span><span id="local-6989586621681827242"><span class="annot"><span class="annottext">Alt Id
</span><a href="#local-6989586621681827242"><span class="hs-identifier hs-var">alt'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; Id -&gt; Alt Id -&gt; WithDmdType (Alt Id)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalSumAlt"><span class="hs-identifier hs-var">dmdAnalSumAlt</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827236"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827237"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827238"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Alt Id
</span><a href="#local-6989586621681827239"><span class="hs-identifier hs-var">alt</span></a></span><span>
</span><span id="line-638"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827244"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827244"><span class="hs-identifier hs-var">rest_ty</span></a></span></span><span> </span><span id="local-6989586621681827245"><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681827245"><span class="hs-identifier hs-var">alts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; Id -&gt; [Alt Id] -&gt; WithDmdType [Alt Id]
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalSumAlts"><span class="hs-identifier hs-var">dmdAnalSumAlts</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827236"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827237"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827238"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681827240"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-639"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; [Alt Id] -&gt; WithDmdType [Alt Id]
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdType -&gt; DmdType -&gt; DmdType
</span><a href="GHC.Types.Demand.html#lubDmdType"><span class="hs-identifier hs-var">lubDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827241"><span class="hs-identifier hs-var">cur_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827244"><span class="hs-identifier hs-var">rest_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Alt Id
</span><a href="#local-6989586621681827242"><span class="hs-identifier hs-var">alt'</span></a></span><span class="annot"><span class="annottext">Alt Id -&gt; [Alt Id] -&gt; [Alt Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Alt Id]
</span><a href="#local-6989586621681827245"><span class="hs-identifier hs-var">alts'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-640"></span><span>
</span><span id="line-641"></span><span>
</span><span id="line-642"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalSumAlt"><span class="hs-identifier hs-type">dmdAnalSumAlt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span>
</span><span id="line-643"></span><span id="dmdAnalSumAlt"><span class="annot"><span class="annottext">dmdAnalSumAlt :: AnalEnv -&gt; SubDemand -&gt; Id -&gt; Alt Id -&gt; WithDmdType (Alt Id)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalSumAlt"><span class="hs-identifier hs-var hs-var">dmdAnalSumAlt</span></a></span></span><span> </span><span id="local-6989586621681827247"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827247"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827248"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827248"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span id="local-6989586621681827249"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827249"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621681827250"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681827250"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621681827251"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827251"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span id="local-6989586621681827252"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827252"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-644"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681827253"><span class="annot"><span class="annottext">rhs_env :: AnalEnv
</span><a href="#local-6989586621681827253"><span class="hs-identifier hs-var hs-var">rhs_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; [Id] -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#addInScopeAnalEnvs"><span class="hs-identifier hs-var">addInScopeAnalEnvs</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827247"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827249"><span class="hs-identifier hs-var">case_bndr</span></a></span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827251"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-645"></span><span>    </span><span class="hs-comment">-- See Note [Bringing a new variable into scope]</span><span>
</span><span id="line-646"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827254"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827254"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span> </span><span id="local-6989586621681827255"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827255"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827253"><span class="hs-identifier hs-var">rhs_env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827248"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827252"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-647"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827256"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827256"><span class="hs-identifier hs-var">alt_ty</span></a></span></span><span> </span><span id="local-6989586621681827257"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827257"><span class="hs-identifier hs-var">dmds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdType -&gt; [Id] -&gt; WithDmdType [Demand]
</span><a href="GHC.Core.Opt.DmdAnal.html#findBndrsDmds"><span class="hs-identifier hs-var">findBndrsDmds</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827247"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827254"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827251"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-648"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Card
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-type">:*</span></a></span><span> </span><span id="local-6989586621681827258"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827258"><span class="hs-identifier hs-var">case_bndr_sd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; Id -&gt; Demand
</span><a href="GHC.Types.Demand.html#findIdDemand"><span class="hs-identifier hs-var">findIdDemand</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827256"><span class="hs-identifier hs-var">alt_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827249"><span class="hs-identifier hs-var">case_bndr</span></a></span><span>
</span><span id="line-649"></span><span>        </span><span class="hs-comment">-- See Note [Demand on case-alternative binders]</span><span>
</span><span id="line-650"></span><span>        </span><span class="hs-comment">-- we can't use the scrut_sd, because it says 'Prod' and we'll use</span><span>
</span><span id="line-651"></span><span>        </span><span class="hs-comment">-- topSubDmd anyway for scrutinees of sum types.</span><span>
</span><span id="line-652"></span><span>        </span><span id="local-6989586621681827260"><span class="annot"><span class="annottext">scrut_sd :: SubDemand
</span><a href="#local-6989586621681827260"><span class="hs-identifier hs-var hs-var">scrut_sd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubDemand -&gt; [Demand] -&gt; SubDemand
</span><a href="GHC.Core.Opt.DmdAnal.html#scrutSubDmd"><span class="hs-identifier hs-var">scrutSubDmd</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827258"><span class="hs-identifier hs-var">case_bndr_sd</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827257"><span class="hs-identifier hs-var">dmds</span></a></span><span>
</span><span id="line-653"></span><span>        </span><span id="local-6989586621681827261"><span class="annot"><span class="annottext">dmds' :: [Demand]
</span><a href="#local-6989586621681827261"><span class="hs-identifier hs-var hs-var">dmds'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubDemand -&gt; Arity -&gt; [Demand]
</span><a href="GHC.Core.Opt.DmdAnal.html#fieldBndrDmds"><span class="hs-identifier hs-var">fieldBndrDmds</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827260"><span class="hs-identifier hs-var">scrut_sd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; Arity
forall a. [a] -&gt; Arity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Arity
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827257"><span class="hs-identifier hs-var">dmds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-654"></span><span>        </span><span class="hs-comment">-- Do not put a thunk into the Alt</span><span>
</span><span id="line-655"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681827262"><span class="annot"><span class="annottext">new_ids :: [Id]
</span><a href="#local-6989586621681827262"><span class="hs-identifier hs-var hs-var">new_ids</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; [Id] -&gt; [Demand] -&gt; [Id]
[Id] -&gt; [Demand] -&gt; [Id]
</span><a href="GHC.Core.Opt.DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-var">setBndrsDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827251"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827261"><span class="hs-identifier hs-var">dmds'</span></a></span><span>
</span><span id="line-656"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dmdAnalSumAlt&quot; (ppr con $$ ppr case_bndr $$ ppr dmd $$ ppr alt_ty) $</span><span>
</span><span id="line-657"></span><span>    </span><span class="annot"><span class="annottext">DmdType -&gt; Alt Id -&gt; WithDmdType (Alt Id)
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827256"><span class="hs-identifier hs-var">alt_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AltCon -&gt; [Id] -&gt; CoreExpr -&gt; Alt Id
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681827250"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827262"><span class="hs-identifier hs-var">new_ids</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827255"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span class="hs-comment">-- See Note [Demand on the scrutinee of a product case]</span><span>
</span><span id="line-660"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#scrutSubDmd"><span class="hs-identifier hs-type">scrutSubDmd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span>
</span><span id="line-661"></span><span id="scrutSubDmd"><span class="annot"><span class="annottext">scrutSubDmd :: SubDemand -&gt; [Demand] -&gt; SubDemand
</span><a href="GHC.Core.Opt.DmdAnal.html#scrutSubDmd"><span class="hs-identifier hs-var hs-var">scrutSubDmd</span></a></span></span><span> </span><span id="local-6989586621681827263"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827263"><span class="hs-identifier hs-var">case_sd</span></a></span></span><span> </span><span id="local-6989586621681827264"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827264"><span class="hs-identifier hs-var">fld_dmds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-comment">-- pprTraceWith &quot;scrutSubDmd&quot; (\scrut_sd -&gt; ppr case_sd $$ ppr fld_dmds $$ ppr scrut_sd) $</span><span>
</span><span id="line-663"></span><span>  </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827263"><span class="hs-identifier hs-var">case_sd</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand -&gt; SubDemand -&gt; SubDemand
</span><a href="GHC.Types.Demand.html#plusSubDmd"><span class="hs-operator hs-var">`plusSubDmd`</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity -&gt; [Demand] -&gt; SubDemand
</span><a href="GHC.Types.Demand.html#mkProd"><span class="hs-identifier hs-var">mkProd</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827264"><span class="hs-identifier hs-var">fld_dmds</span></a></span><span>
</span><span id="line-664"></span><span>
</span><span id="line-665"></span><span class="hs-comment">-- See Note [Demand on case-alternative binders]</span><span>
</span><span id="line-666"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#fieldBndrDmds"><span class="hs-identifier hs-type">fieldBndrDmds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span> </span><span class="hs-comment">-- on the scrutinee</span><span>
</span><span id="line-667"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-668"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Final demands for the components of the DataCon</span><span>
</span><span id="line-669"></span><span id="fieldBndrDmds"><span class="annot"><span class="annottext">fieldBndrDmds :: SubDemand -&gt; Arity -&gt; [Demand]
</span><a href="GHC.Core.Opt.DmdAnal.html#fieldBndrDmds"><span class="hs-identifier hs-var hs-var">fieldBndrDmds</span></a></span></span><span> </span><span id="local-6989586621681827268"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827268"><span class="hs-identifier hs-var">scrut_sd</span></a></span></span><span> </span><span id="local-6989586621681827269"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827269"><span class="hs-identifier hs-var">n_flds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-670"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; SubDemand -&gt; Maybe (Boxity, [Demand])
</span><a href="GHC.Types.Demand.html#viewProd"><span class="hs-identifier hs-var">viewProd</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827269"><span class="hs-identifier hs-var">n_flds</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827268"><span class="hs-identifier hs-var">scrut_sd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-671"></span><span>    </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Boxity
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827271"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827271"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827271"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-672"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Boxity, [Demand])
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Demand -&gt; [Demand]
forall a. Arity -&gt; a -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#replicate/GHC.List.html#replicate"><span class="hs-identifier hs-var">replicate</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827269"><span class="hs-identifier hs-var">n_flds</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span>
</span><span id="line-673"></span><span>                      </span><span class="hs-comment">-- Either an arity mismatch or scrut_sd was a call demand.</span><span>
</span><span id="line-674"></span><span>                      </span><span class="hs-comment">-- See Note [Untyped demand on case-alternative binders]</span><span>
</span><span id="line-675"></span><span>
</span><span id="line-676"></span><span class="hs-comment">{-
Note [Anticipating ANF in demand analysis]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When analysing non-complex (e.g., trivial) thunks and complex function
arguments, we have to pretend that the expression is really in administrative
normal form (ANF), the conversion to which is done by CorePrep.

Consider
```
f x = let y = x |&gt; co in y `seq` y `seq` ()
```
E.g., 'y' is a let-binding with a trivial RHS. That may occur if 'y' can't be
inlined, for example. Now, is 'x' used once? It may appear as if that is the
case, since its only occurrence is in 'y's memoised RHS. But actually, CorePrep
will *not* allocate a thunk for 'y', because it is trivial and could just
re-use the memoisation mechanism of 'x'! By saying that 'x' is used once it
becomes a single-entry thunk and a call to 'f' will evaluate it twice.
The same applies to trivial arguments, e.g., `f z` really evaluates `z` twice.

So, somewhat counter-intuitively, trivial arguments and let RHSs will *not* be
memoised. On the other hand, evaluation of non-trivial arguments and let RHSs
*will* be memoised. In fact, consider the effect of conversion to ANF on complex
function arguments (as done by 'GHC.Core.Prep.mkFloat'):
```
f2 (g2 x) ===&gt; let y = g2 x in f2 y                   (if `y` is lifted)
f3 (g3 x) ===&gt; case g3 x of y { __DEFAULT -&gt; f3 y }   (if `y` is not lifted)
```
So if a lifted argument like `g2 x` is complex enough, it will be memoised.
Regardless how many times 'f2' evaluates its parameter, the argument will be
evaluated at most once to WHNF.
Similarly, when an unlifted argument like `g3 x` is complex enough, we will
evaluate it *exactly* once to WHNF, no matter how 'f3' evaluates its parameter.

Note that any evaluation beyond WHNF is not affected by memoisation. So this
Note affects the outer 'Card' of a 'Demand', but not its nested 'SubDemand'.
'anticipateANF' predicts the effect of case-binding and let-binding complex
arguments, as well as the lack of memoisation for trivial let RHSs.
In particular, this takes care of the gripes in
Note [Analysing with absent demand] relating to unlifted types.

Note [Analysing with absent demand]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we analyse an expression with demand A.  The &quot;A&quot; means
&quot;absent&quot;, so this expression will never be needed. What should happen?
There are several wrinkles:

* We *do* want to analyse the expression regardless.
  Reason: Note [Always analyse in virgin pass]

  But we can post-process the results to ignore all the usage
  demands coming back. This is done by 'multDmdType' with the appropriate
  (absent) evaluation cardinality A or B.

* Nevertheless, which sub-demand should we pick for analysis?
  Since the demand was absent, any would do. Worker/wrapper will replace
  absent bindings with an absent filler anyway, so annotations in the RHS
  of an absent binding don't matter much.
  Picking 'botSubDmd' would be the most useful, but would also look a bit
  misleading in the Core output of DmdAnal, because all nested annotations would
  be bottoming. Better pick 'seqSubDmd', so that we annotate many of those
  nested bindings with A themselves.

* Since we allow unlifted arguments that are not ok-for-speculation,
  we need to be extra careful in the following situation, because unlifted
  values are evaluated even if they are not used. Example from #9254:
     f :: (() -&gt; (# Int#, () #)) -&gt; ()
          -- Strictness signature is
          --    &lt;1C(1,P(A,1L))&gt;
          -- I.e. calls k, but discards first component of result
     f k = case k () of (# _, r #) -&gt; r

     g :: Int -&gt; ()
     g y = f (\n -&gt; (# case y of I# y2 -&gt; y2, n #))

  Here, f's strictness signature says (correctly) that it calls its argument
  function and ignores the first component of its result.

  But in function g, we *will* evaluate the 'case y of ...', because it has type
  Int#. So in the program as written, 'y' will be evaluated. Hence we must
  record this usage of 'y', else 'g' will say 'y' is absent, and will w/w so
  that 'y' is bound to an absent filler (see Note [Absent fillers]), leading
  to a crash when 'y' is evaluated.

  Now, worker/wrapper could be smarter and replace `case y of I# y2 -&gt; y2`
  with a suitable absent filler such as `RUBBISH[IntRep] @Int#`.
  But as long as worker/wrapper isn't equipped to do so, we must be cautious,
  and follow Note [Anticipating ANF in demand analysis]. That is, in
  'dmdAnalStar', we will set the evaluation cardinality to C_11, anticipating
  the case binding of the complex argument `case y of I# y2 -&gt; y2`. This
  cardinlities' only effect is in the call to 'multDmdType', where it makes sure
  that the demand on the arg's free variable 'y' is not absent and strict, so
  that it is ultimately passed unboxed to 'g'.

Note [Always analyse in virgin pass]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Tricky point: make sure that we analyse in the 'virgin' pass. Consider
   rec { f acc x True  = f (...rec { g y = ...g... }...)
         f acc x False = acc }
In the virgin pass for 'f' we'll give 'f' a very strict (bottom) type.
That might mean that we analyse the sub-expression containing the
E = &quot;...rec g...&quot; stuff in a bottom demand.  Suppose we *didn't analyse*
E, but just returned botType.

Then in the *next* (non-virgin) iteration for 'f', we might analyse E
in a weaker demand, and that will trigger doing a fixpoint iteration
for g.  But *because it's not the virgin pass* we won't start g's
iteration at bottom.  Disaster.  (This happened in $sfibToList' of
nofib/spectral/fibheaps.)

So in the virgin pass we make sure that we do analyse the expression
at least once, to initialise its signatures.

Note [Which scrutinees may throw precise exceptions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This is the specification of 'exprMayThrowPreciseExceptions',
which is important for Scenario 2 of
Note [Precise exceptions and strictness analysis] in GHC.Types.Demand.

For an expression @f a1 ... an :: ty@ we determine that
  1. False  If ty is *not* @State# RealWorld@ or an unboxed tuple thereof.
            This check is done by 'forcesRealWorld'.
            (Why not simply unboxed pairs as above? This is motivated by
            T13380{d,e}.)
  2. False  If f is a PrimOp, and it is *not* raiseIO#
  3. False  If f is an unsafe FFI call ('PlayRisky')
  _. True   Otherwise &quot;give up&quot;.

It is sound to return False in those cases, because
  1. We don't give any guarantees for unsafePerformIO, so no precise exceptions
     from pure code.
  2. raiseIO# is the only primop that may throw a precise exception.
  3. Unsafe FFI calls may not interact with the RTS (to throw, for example).
     See haddock on GHC.Types.ForeignCall.PlayRisky.

We *need* to return False in those cases, because
  1. We would lose too much strictness in pure code, all over the place.
  2. We would lose strictness for primops like getMaskingState#, which
     introduces a substantial regression in
     GHC.IO.Handle.Internals.wantReadableHandle.
  3. We would lose strictness for code like GHC.Fingerprint.fingerprintData,
     where an intermittent FFI call to c_MD5Init would otherwise lose
     strictness on the arguments len and buf, leading to regressions in T9203
     (2%) and i386's haddock.base (5%). Tested by T13380f.

In !3014 we tried a more sophisticated analysis by introducing ConOrDiv (nic)
to the Divergence lattice, but in practice it turned out to be hard to untaint
from 'topDiv' to 'conDiv', leading to bugs, performance regressions and
complexity that didn't justify the single fixed testcase T13380c.

Note [Demand analysis for recursive data constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
T11545 features a single-product, recursive data type
  data A = A A A ... A
    deriving Eq
Naturally, `(==)` is deeply strict in `A` and in fact will never terminate. That
leads to very large (exponential in the depth) demand signatures and fruitless
churn in boxity analysis, demand analysis and worker/wrapper.

So we detect `A` as a recursive data constructor (see
Note [Detecting recursive data constructors]) analysing `case x of A ...`
and simply assume L for the demand on field binders, which is the same code
path as we take for sum types. This code happens in want_precise_field_dmds
in the Case equation for dmdAnal.

Combined with the B demand on the case binder, we get the very small demand
signature &lt;1S&gt;&lt;1S&gt;b on `(==)`. This improves ghc/alloc performance on T11545
tenfold! See also Note [CPR for recursive data constructors] which describes the
sibling mechanism in CPR analysis.

Note [Demand on the scrutinee of a product case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When figuring out the demand on the scrutinee of a product case,
we use the demands of the case alternative, i.e. id_dmds.
But note that these include the demand on the case binder;
see Note [Demand on case-alternative binders].
This is crucial. Example:
   f x = case x of y { (a,b) -&gt; k y a }
If we just take scrut_demand = 1P(L,A), then we won't pass x to the
worker, so the worker will rebuild
     x = (a, absent-error)
and that'll crash.

Note [Demand on case-alternative binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The demand on a binder in a case alternative comes
  (a) From the demand on the binder itself
  (b) From the demand on the case binder
Forgetting (b) led directly to #10148.

Example. Source code:
  f x@(p,_) = if p then foo x else True

  foo (p,True) = True
  foo (p,q)    = foo (q,p)

After strictness analysis, forgetting (b):
  f = \ (x_an1 [Dmd=1P(1L,ML)] :: (Bool, Bool)) -&gt;
      case x_an1
      of wild_X7 [Dmd=MP(ML,ML)]
      { (p_an2 [Dmd=1L], ds_dnz [Dmd=A]) -&gt;
      case p_an2 of _ {
        False -&gt; GHC.Types.True;
        True -&gt; foo wild_X7 }

Note that ds_dnz is syntactically dead, but the expression bound to it is
reachable through the case binder wild_X7. Now watch what happens if we inline
foo's wrapper:
  f = \ (x_an1 [Dmd=1P(1L,ML)] :: (Bool, Bool)) -&gt;
      case x_an1
      of _ [Dmd=MP(ML,ML)]
      { (p_an2 [Dmd=1L], ds_dnz [Dmd=A]) -&gt;
      case p_an2 of _ {
        False -&gt; GHC.Types.True;
        True -&gt; $wfoo_soq GHC.Types.True ds_dnz }

Look at that! ds_dnz has come back to life in the call to $wfoo_soq! A second
run of demand analysis would no longer infer ds_dnz to be absent.
But unlike occurrence analysis, which infers properties of the *syntactic*
shape of the program, the results of demand analysis describe expressions
*semantically* and are supposed to be mostly stable across Simplification.
That's why we should better account for (b).
In #10148, we ended up emitting a single-entry thunk instead of an updateable
thunk for a let binder that was an an absent case-alt binder during DmdAnal.

This is needed even for non-product types, in case the case-binder
is used but the components of the case alternative are not.

Note [Untyped demand on case-alternative binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
With unsafeCoerce, #8037 and #22039 taught us that the demand on the case binder
may be a call demand or have a different number of fields than the constructor
of the case alternative it is used in. From T22039:

  blarg :: (Int, Int) -&gt; Int
  blarg (x,y) = x+y
  -- blarg :: &lt;1!P(1L,1L)&gt;

  f :: Either Int Int -&gt; Int
  f Left{} = 0
  f e = blarg (unsafeCoerce e)
  ==&gt; { desugars to }
  f = \ (ds_d1nV :: Either Int Int) -&gt;
      case ds_d1nV of wild_X1 {
        Left ds_d1oV -&gt; lvl_s1Q6;
        Right ipv_s1Pl -&gt;
          blarg
            (case unsafeEqualityProof @(*) @(Either Int Int) @(Int, Int) of
             { UnsafeRefl co_a1oT -&gt;
             wild_X1 `cast` (Sub (Sym co_a1oT) :: Either Int Int ~R# (Int, Int))
             })
      }

The case binder `e`/`wild_X1` has demand 1!P(1L,1L), with two fields, from the call
to `blarg`, but `Right` only has one field. Although the code will crash when
executed, we must be able to analyse it in 'fieldBndrDmds' and conservatively
approximate with Top instead of panicking because of the mismatch.
In #22039, this kind of code was guarded behind a safe `cast` and thus dead
code, but nevertheless led to a panic of the compiler.

You might wonder why the same problem doesn't come up when scrutinising a
product type instead of a sum type. It appears that for products, `wild_X1`
will be inlined before DmdAnal.

See also Note [mkWWstr and unsafeCoerce] for a related issue.

Note [Aggregated demand for cardinality]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
FIXME: This Note should be named [LetUp vs. LetDown] and probably predates
said separation. SG

We use different strategies for strictness and usage/cardinality to
&quot;unleash&quot; demands captured on free variables by bindings. Let us
consider the example:

f1 y = let {-# NOINLINE h #-}
           h = y
       in  (h, h)

We are interested in obtaining cardinality demand U1 on |y|, as it is
used only in a thunk, and, therefore, is not going to be updated any
more. Therefore, the demand on |y|, captured and unleashed by usage of
|h| is U1. However, if we unleash this demand every time |h| is used,
and then sum up the effects, the ultimate demand on |y| will be U1 +
U1 = U. In order to avoid it, we *first* collect the aggregate demand
on |h| in the body of let-expression, and only then apply the demand
transformer:

transf[x](U) = {y |-&gt; U1}

so the resulting demand on |y| is U1.

The situation is, however, different for strictness, where this
aggregating approach exhibits worse results because of the nature of
|both| operation for strictness. Consider the example:

f y c =
  let h x = y |seq| x
   in case of
        True  -&gt; h True
        False -&gt; y

It is clear that |f| is strict in |y|, however, the suggested analysis
will infer from the body of |let| that |h| is used lazily (as it is
used in one branch only), therefore lazy demand will be put on its
free variable |y|. Conversely, if the demand on |h| is unleashed right
on the spot, we will get the desired result, namely, that |f| is
strict in |y|.


************************************************************************
*                                                                      *
                    Demand transformer
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-991"></span><span>
</span><span id="line-992"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdTransform"><span class="hs-identifier hs-type">dmdTransform</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ The analysis environment</span></span><span>
</span><span id="line-993"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>        </span><span class="annot"><span class="hs-comment">-- ^ The variable</span></span><span>
</span><span id="line-994"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ The evaluation context of the var</span></span><span>
</span><span id="line-995"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span>   </span><span class="hs-comment">-- ^ The demand type unleashed by the variable in this</span><span>
</span><span id="line-996"></span><span>                          </span><span class="hs-comment">-- context. The returned DmdEnv includes the demand on</span><span>
</span><span id="line-997"></span><span>                          </span><span class="hs-comment">-- this function plus demand on its free variables</span><span>
</span><span id="line-998"></span><span class="hs-comment">-- See Note [What are demand signatures?] in &quot;GHC.Types.Demand&quot;</span><span>
</span><span id="line-999"></span><span id="dmdTransform"><span class="annot"><span class="annottext">dmdTransform :: AnalEnv -&gt; Id -&gt; SubDemand -&gt; DmdType
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdTransform"><span class="hs-identifier hs-var hs-var">dmdTransform</span></a></span></span><span> </span><span id="local-6989586621681827273"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827273"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827274"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621681827275"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827275"><span class="hs-identifier hs-var">sd</span></a></span></span><span>
</span><span id="line-1000"></span><span>  </span><span class="hs-comment">-- Data constructors</span><span>
</span><span id="line-1001"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681827276"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827276"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Maybe DataCon
</span><a href="GHC.Types.Id.html#isDataConWorkId_maybe"><span class="hs-identifier hs-var">isDataConWorkId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-1002"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTraceWith &quot;dmdTransform:DataCon&quot; (\ty -&gt; ppr con $$ ppr sd $$ ppr ty) $</span><span>
</span><span id="line-1003"></span><span>    </span><span class="annot"><span class="annottext">[StrictnessMark] -&gt; SubDemand -&gt; DmdType
</span><a href="GHC.Types.Demand.html#dmdTransformDataConSig"><span class="hs-identifier hs-var">dmdTransformDataConSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [StrictnessMark]
</span><a href="GHC.Core.DataCon.html#dataConRepStrictness"><span class="hs-identifier hs-var">dataConRepStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827276"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827275"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-1004"></span><span>  </span><span class="hs-comment">-- See Note [DmdAnal for DataCon wrappers]</span><span>
</span><span id="line-1005"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDataConWrapId"><span class="hs-identifier hs-var">isDataConWrapId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681827281"><span class="annot"><span class="annottext">rhs :: CoreExpr
</span><a href="#local-6989586621681827281"><span class="hs-identifier hs-var hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; CoreExpr
</span><a href="GHC.Core.html#uf_tmpl"><span class="hs-identifier hs-var">uf_tmpl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Unfolding
</span><a href="GHC.Types.Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1006"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827284"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827284"><span class="hs-identifier hs-var">dmd_ty</span></a></span></span><span> </span><span id="local-6989586621681827285"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827285"><span class="hs-identifier hs-var">_rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827273"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827275"><span class="hs-identifier hs-var">sd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827281"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1007"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827284"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span>
</span><span id="line-1008"></span><span>  </span><span class="hs-comment">-- Dictionary component selectors</span><span>
</span><span id="line-1009"></span><span>  </span><span class="hs-comment">-- Used to be controlled by a flag.</span><span>
</span><span id="line-1010"></span><span>  </span><span class="hs-comment">-- See #18429 for some perf measurements.</span><span>
</span><span id="line-1011"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Maybe Class
</span><a href="GHC.Types.Id.html#isClassOpId_maybe"><span class="hs-identifier hs-var">isClassOpId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-1012"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dmdTransform:DictSel&quot; (ppr var $$ ppr (idDmdSig var) $$ ppr sd) $</span><span>
</span><span id="line-1013"></span><span>    </span><span class="annot"><span class="annottext">DmdSig -&gt; SubDemand -&gt; DmdType
</span><a href="GHC.Types.Demand.html#dmdTransformDictSelSig"><span class="hs-identifier hs-var">dmdTransformDictSelSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827275"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-1014"></span><span>  </span><span class="hs-comment">-- Imported functions</span><span>
</span><span id="line-1015"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isGlobalId"><span class="hs-identifier hs-var">isGlobalId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-1016"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681827289"><span class="annot"><span class="annottext">res :: DmdType
</span><a href="#local-6989586621681827289"><span class="hs-identifier hs-var hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; SubDemand -&gt; DmdType
</span><a href="GHC.Types.Demand.html#dmdTransformSig"><span class="hs-identifier hs-var">dmdTransformSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827275"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-1017"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dmdTransform:import&quot; (vcat [ppr var, ppr (idDmdSig var), ppr sd, ppr res])</span><span>
</span><span id="line-1018"></span><span>    </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827289"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-1019"></span><span>  </span><span class="hs-comment">-- Top-level or local let-bound thing for which we use LetDown ('useLetUp').</span><span>
</span><span id="line-1020"></span><span>  </span><span class="hs-comment">-- In that case, we have a strictness signature to unleash in our AnalEnv.</span><span>
</span><span id="line-1021"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827291"><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681827291"><span class="hs-identifier hs-var">sig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827292"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827292"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Id -&gt; Maybe (DmdSig, TopLevelFlag)
</span><a href="GHC.Core.Opt.DmdAnal.html#lookupSigEnv"><span class="hs-identifier hs-var">lookupSigEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827273"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-1022"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681827294"><span class="annot"><span class="annottext">fn_ty :: DmdType
</span><a href="#local-6989586621681827294"><span class="hs-identifier hs-var hs-var">fn_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; SubDemand -&gt; DmdType
</span><a href="GHC.Types.Demand.html#dmdTransformSig"><span class="hs-identifier hs-var">dmdTransformSig</span></a></span><span> </span><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681827291"><span class="hs-identifier hs-var">sig</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827275"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-1023"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dmdTransform:LetDown&quot; (vcat [ppr var, ppr sig, ppr sd, ppr fn_ty]) $</span><span>
</span><span id="line-1024"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827292"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1025"></span><span>      </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; Id -&gt; Demand -&gt; DmdType
</span><a href="GHC.Core.Opt.DmdAnal.html#addVarDmd"><span class="hs-identifier hs-var">addVarDmd</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827294"><span class="hs-identifier hs-var">fn_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Card
</span><a href="GHC.Types.Demand.html#C_11"><span class="hs-identifier hs-var">C_11</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Card -&gt; SubDemand -&gt; Demand
Card -&gt; SubDemand -&gt; Demand
</span><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-var">:*</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827275"><span class="hs-identifier hs-var">sd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1026"></span><span>      </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span>
</span><span id="line-1027"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#isInterestingTopLevelFn"><span class="hs-identifier hs-var">isInterestingTopLevelFn</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-1028"></span><span>        </span><span class="hs-comment">-- Top-level things will be used multiple times or not at</span><span>
</span><span id="line-1029"></span><span>        </span><span class="hs-comment">-- all anyway, hence the multDmd below: It means we don't</span><span>
</span><span id="line-1030"></span><span>        </span><span class="hs-comment">-- have to track whether @var@ is used strictly or at most</span><span>
</span><span id="line-1031"></span><span>        </span><span class="hs-comment">-- once, because ultimately it never will.</span><span>
</span><span id="line-1032"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; Id -&gt; Demand -&gt; DmdType
</span><a href="GHC.Core.Opt.DmdAnal.html#addVarDmd"><span class="hs-identifier hs-var">addVarDmd</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827294"><span class="hs-identifier hs-var">fn_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Card
</span><a href="GHC.Types.Demand.html#C_0N"><span class="hs-identifier hs-var">C_0N</span></a></span><span> </span><span class="annot"><span class="annottext">Card -&gt; Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#multDmd"><span class="hs-operator hs-var">`multDmd`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Card
</span><a href="GHC.Types.Demand.html#C_11"><span class="hs-identifier hs-var">C_11</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Card -&gt; SubDemand -&gt; Demand
Card -&gt; SubDemand -&gt; Demand
</span><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-var">:*</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827275"><span class="hs-identifier hs-var">sd</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- discard strictness</span><span>
</span><span id="line-1033"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1034"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827294"><span class="hs-identifier hs-var">fn_ty</span></a></span><span> </span><span class="hs-comment">-- don't bother tracking; just annotate with 'topDmd' later</span><span>
</span><span id="line-1035"></span><span>  </span><span class="hs-comment">-- Everything else:</span><span>
</span><span id="line-1036"></span><span>  </span><span class="hs-comment">--   * Local let binders for which we use LetUp (cf. 'useLetUp')</span><span>
</span><span id="line-1037"></span><span>  </span><span class="hs-comment">--   * Lambda binders</span><span>
</span><span id="line-1038"></span><span>  </span><span class="hs-comment">--   * Case and constructor field binders</span><span>
</span><span id="line-1039"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1040"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dmdTransform:other&quot; (vcat [ppr var, ppr boxity, ppr sd]) $</span><span>
</span><span id="line-1041"></span><span>    </span><span class="annot"><span class="annottext">DmdEnv -&gt; DmdType
</span><a href="GHC.Core.Opt.DmdAnal.html#noArgsDmdType"><span class="hs-identifier hs-var">noArgsDmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdEnv -&gt; Id -&gt; Demand -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#addVarDmdEnv"><span class="hs-identifier hs-var">addVarDmdEnv</span></a></span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><a href="GHC.Types.Demand.html#nopDmdEnv"><span class="hs-identifier hs-var">nopDmdEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827274"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Card
</span><a href="GHC.Types.Demand.html#C_11"><span class="hs-identifier hs-var">C_11</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Card -&gt; SubDemand -&gt; Demand
Card -&gt; SubDemand -&gt; Demand
</span><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-var">:*</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827275"><span class="hs-identifier hs-var">sd</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1042"></span><span>
</span><span id="line-1043"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                      Binding right-hand sides
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-1048"></span><span>
</span><span id="line-1049"></span><span class="hs-comment">-- | An environment in which all demands are weak according to 'isWeakDmd'.</span><span>
</span><span id="line-1050"></span><span class="hs-comment">-- See Note [Lazy and unleashable free variables].</span><span>
</span><span id="line-1051"></span><span class="hs-keyword">type</span><span> </span><span id="WeakDmds"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WeakDmds"><span class="hs-identifier hs-var">WeakDmds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-1052"></span><span>
</span><span id="line-1053"></span><span class="hs-comment">-- | @dmdAnalRhsSig@ analyses the given RHS to compute a demand signature</span><span>
</span><span id="line-1054"></span><span class="hs-comment">-- for the LetDown rule. It works as follows:</span><span>
</span><span id="line-1055"></span><span class="hs-comment">--</span><span>
</span><span id="line-1056"></span><span class="hs-comment">--  * assuming the weakest possible body sub-demand, L</span><span>
</span><span id="line-1057"></span><span class="hs-comment">--  * looking at the definition</span><span>
</span><span id="line-1058"></span><span class="hs-comment">--  * determining a strictness signature</span><span>
</span><span id="line-1059"></span><span class="hs-comment">--</span><span>
</span><span id="line-1060"></span><span class="hs-comment">-- Since it assumed a body sub-demand of L, the resulting signature is</span><span>
</span><span id="line-1061"></span><span class="hs-comment">-- applicable at any call site.</span><span>
</span><span id="line-1062"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalRhsSig"><span class="hs-identifier hs-type">dmdAnalRhsSig</span></a></span><span>
</span><span id="line-1063"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span>
</span><span id="line-1064"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span>
</span><span id="line-1065"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span>
</span><span id="line-1066"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-1067"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WeakDmds"><span class="hs-identifier hs-type">WeakDmds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1068"></span><span class="hs-comment">-- Process the RHS of the binding, add the strictness signature</span><span>
</span><span id="line-1069"></span><span class="hs-comment">-- to the Id, and augment the environment with the signature as well.</span><span>
</span><span id="line-1070"></span><span class="hs-comment">-- See Note [NOINLINE and strictness]</span><span>
</span><span id="line-1071"></span><span id="dmdAnalRhsSig"><span class="annot"><span class="annottext">dmdAnalRhsSig :: TopLevelFlag
-&gt; RecFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; Id
-&gt; CoreExpr
-&gt; (AnalEnv, WeakDmds, Id, CoreExpr)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalRhsSig"><span class="hs-identifier hs-var hs-var">dmdAnalRhsSig</span></a></span></span><span> </span><span id="local-6989586621681827301"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827301"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681827302"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681827302"><span class="hs-identifier hs-var">rec_flag</span></a></span></span><span> </span><span id="local-6989586621681827303"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827303"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827304"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827304"><span class="hs-identifier hs-var">let_dmd</span></a></span></span><span> </span><span id="local-6989586621681827305"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827305"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621681827306"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827306"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1072"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dmdAnalRhsSig&quot; (ppr id $$ ppr let_dmd $$ ppr rhs_dmds $$ ppr sig $$ ppr weak_fvs) $</span><span>
</span><span id="line-1073"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827307"><span class="hs-identifier hs-var">final_env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827308"><span class="hs-identifier hs-var">weak_fvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827309"><span class="hs-identifier hs-var">final_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827310"><span class="hs-identifier hs-var">final_rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1074"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1075"></span><span>    </span><span id="local-6989586621681827311"><span class="annot"><span class="annottext">threshold_arity :: Arity
</span><a href="#local-6989586621681827311"><span class="hs-identifier hs-var hs-var">threshold_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; Arity
</span><a href="GHC.Core.Opt.DmdAnal.html#thresholdArity"><span class="hs-identifier hs-var">thresholdArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827305"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827306"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1076"></span><span>
</span><span id="line-1077"></span><span>    </span><span id="local-6989586621681827313"><span class="annot"><span class="annottext">rhs_dmd :: SubDemand
</span><a href="#local-6989586621681827313"><span class="hs-identifier hs-var hs-var">rhs_dmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; SubDemand -&gt; SubDemand
</span><a href="GHC.Types.Demand.html#mkCalledOnceDmds"><span class="hs-identifier hs-var">mkCalledOnceDmds</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827311"><span class="hs-identifier hs-var">threshold_arity</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827315"><span class="hs-identifier hs-var">body_dmd</span></a></span><span>
</span><span id="line-1078"></span><span>
</span><span id="line-1079"></span><span>    </span><span id="local-6989586621681827315"><span class="annot"><span class="annottext">body_dmd :: SubDemand
</span><a href="#local-6989586621681827315"><span class="hs-identifier hs-var hs-var">body_dmd</span></a></span></span><span>
</span><span id="line-1080"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827305"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-1081"></span><span>      </span><span class="hs-comment">-- See Note [Demand analysis for join points]</span><span>
</span><span id="line-1082"></span><span>      </span><span class="hs-comment">-- See Note [Invariants on join points] invariant 2b, in GHC.Core</span><span>
</span><span id="line-1083"></span><span>      </span><span class="hs-comment">--     threshold_arity matches the join arity of the join point</span><span>
</span><span id="line-1084"></span><span>      </span><span class="hs-comment">-- See Note [Unboxed demand on function bodies returning small products]</span><span>
</span><span id="line-1085"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; RecFlag -&gt; Maybe Type -&gt; SubDemand -&gt; SubDemand
</span><a href="GHC.Core.Opt.DmdAnal.html#unboxedWhenSmall"><span class="hs-identifier hs-var">unboxedWhenSmall</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827303"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681827302"><span class="hs-identifier hs-var">rec_flag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Maybe Type
</span><a href="GHC.Core.Opt.DmdAnal.html#resultType_maybe"><span class="hs-identifier hs-var">resultType_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827305"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827304"><span class="hs-identifier hs-var">let_dmd</span></a></span><span>
</span><span id="line-1086"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1087"></span><span>      </span><span class="hs-comment">-- See Note [Unboxed demand on function bodies returning small products]</span><span>
</span><span id="line-1088"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; RecFlag -&gt; Maybe Type -&gt; SubDemand -&gt; SubDemand
</span><a href="GHC.Core.Opt.DmdAnal.html#unboxedWhenSmall"><span class="hs-identifier hs-var">unboxedWhenSmall</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827303"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681827302"><span class="hs-identifier hs-var">rec_flag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Maybe Type
</span><a href="GHC.Core.Opt.DmdAnal.html#resultType_maybe"><span class="hs-identifier hs-var">resultType_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827305"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="GHC.Types.Demand.html#topSubDmd"><span class="hs-identifier hs-var">topSubDmd</span></a></span><span>
</span><span id="line-1089"></span><span>
</span><span id="line-1090"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827319"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827319"><span class="hs-identifier hs-var">rhs_dmd_ty</span></a></span></span><span> </span><span id="local-6989586621681827320"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827320"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; WithDmdType CoreExpr
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827303"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827313"><span class="hs-identifier hs-var">rhs_dmd</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827306"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1091"></span><span>    </span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span> </span><span id="local-6989586621681827321"><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827321"><span class="hs-identifier hs-var">rhs_env</span></a></span></span><span> </span><span id="local-6989586621681827322"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827322"><span class="hs-identifier hs-var">rhs_dmds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827319"><span class="hs-identifier hs-var">rhs_dmd_ty</span></a></span><span>
</span><span id="line-1092"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681827323"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827323"><span class="hs-identifier hs-var">final_rhs_dmds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827310"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827310"><span class="hs-identifier hs-var">final_rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv
-&gt; Id
-&gt; Arity
-&gt; CoreExpr
-&gt; Divergence
-&gt; Maybe ([Demand], CoreExpr)
</span><a href="GHC.Core.Opt.DmdAnal.html#finaliseArgBoxities"><span class="hs-identifier hs-var">finaliseArgBoxities</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827303"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827305"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827311"><span class="hs-identifier hs-var">threshold_arity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827320"><span class="hs-identifier hs-var">rhs'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdEnv -&gt; Divergence
</span><a href="GHC.Types.Demand.html#de_div"><span class="hs-identifier hs-var">de_div</span></a></span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827321"><span class="hs-identifier hs-var">rhs_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1093"></span><span>                                  </span><span class="annot"><span class="annottext">Maybe ([Demand], CoreExpr)
-&gt; ([Demand], CoreExpr) -&gt; ([Demand], CoreExpr)
forall a. Maybe a -&gt; a -&gt; a
</span><a href="GHC.Data.Maybe.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827322"><span class="hs-identifier hs-var">rhs_dmds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827320"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1094"></span><span>
</span><span id="line-1095"></span><span>    </span><span id="local-6989586621681827327"><span class="annot"><span class="annottext">sig :: DmdSig
</span><a href="#local-6989586621681827327"><span class="hs-identifier hs-var hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; DmdType -&gt; DmdSig
</span><a href="GHC.Types.Demand.html#mkDmdSigForArity"><span class="hs-identifier hs-var">mkDmdSigForArity</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827311"><span class="hs-identifier hs-var">threshold_arity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdEnv -&gt; [Demand] -&gt; DmdType
</span><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827329"><span class="hs-identifier hs-var">sig_env</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827323"><span class="hs-identifier hs-var">final_rhs_dmds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1096"></span><span>
</span><span id="line-1097"></span><span>    </span><span id="local-6989586621681827330"><span class="annot"><span class="annottext">opts :: DmdAnalOpts
</span><a href="#local-6989586621681827330"><span class="hs-identifier hs-var hs-var">opts</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdAnalOpts
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_opts"><span class="hs-identifier hs-var">ae_opts</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827303"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1098"></span><span>    </span><span id="local-6989586621681827309"><span class="annot"><span class="annottext">final_id :: Id
</span><a href="#local-6989586621681827309"><span class="hs-identifier hs-var hs-var">final_id</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdAnalOpts -&gt; Id -&gt; DmdSig -&gt; Id
</span><a href="GHC.Core.Opt.DmdAnal.html#setIdDmdAndBoxSig"><span class="hs-identifier hs-var">setIdDmdAndBoxSig</span></a></span><span> </span><span class="annot"><span class="annottext">DmdAnalOpts
</span><a href="#local-6989586621681827330"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827305"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681827327"><span class="hs-identifier hs-var">sig</span></a></span><span>
</span><span id="line-1099"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621681827307"><span class="annot"><span class="annottext">final_env :: AnalEnv
</span><a href="#local-6989586621681827307"><span class="hs-identifier hs-var hs-var">final_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; AnalEnv -&gt; Id -&gt; DmdSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#extendAnalEnv"><span class="hs-identifier hs-var">extendAnalEnv</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827301"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827303"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827309"><span class="hs-identifier hs-var">final_id</span></a></span><span> </span><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681827327"><span class="hs-identifier hs-var">sig</span></a></span><span>
</span><span id="line-1100"></span><span>
</span><span id="line-1101"></span><span>    </span><span class="hs-comment">-- See Note [Aggregated demand for cardinality]</span><span>
</span><span id="line-1102"></span><span>    </span><span class="hs-comment">-- FIXME: That Note doesn't explain the following lines at all. The reason</span><span>
</span><span id="line-1103"></span><span>    </span><span class="hs-comment">--        is really much different: When we have a recursive function, we'd</span><span>
</span><span id="line-1104"></span><span>    </span><span class="hs-comment">--        have to also consider the free vars of the strictness signature</span><span>
</span><span id="line-1105"></span><span>    </span><span class="hs-comment">--        when checking whether we found a fixed-point. That is expensive;</span><span>
</span><span id="line-1106"></span><span>    </span><span class="hs-comment">--        we only want to check whether argument demands of the sig changed.</span><span>
</span><span id="line-1107"></span><span>    </span><span class="hs-comment">--        reuseEnv makes it so that the FV results are stable as long as the</span><span>
</span><span id="line-1108"></span><span>    </span><span class="hs-comment">--        last argument demands were. Strictness won't change. But used-once</span><span>
</span><span id="line-1109"></span><span>    </span><span class="hs-comment">--        might turn into used-many even if the signature was stable and</span><span>
</span><span id="line-1110"></span><span>    </span><span class="hs-comment">--        we'd have to do an additional iteration. reuseEnv makes sure that</span><span>
</span><span id="line-1111"></span><span>    </span><span class="hs-comment">--        we never get used-once info for FVs of recursive functions.</span><span>
</span><span id="line-1112"></span><span>    </span><span class="hs-comment">--        See #14816 where we try to get rid of reuseEnv.</span><span>
</span><span id="line-1113"></span><span>    </span><span id="local-6989586621681827333"><span class="annot"><span class="annottext">rhs_env1 :: DmdEnv
</span><a href="#local-6989586621681827333"><span class="hs-identifier hs-var hs-var">rhs_env1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681827302"><span class="hs-identifier hs-var">rec_flag</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1114"></span><span>                </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DmdEnv -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#reuseEnv"><span class="hs-identifier hs-var">reuseEnv</span></a></span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827321"><span class="hs-identifier hs-var">rhs_env</span></a></span><span>
</span><span id="line-1115"></span><span>                </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827321"><span class="hs-identifier hs-var">rhs_env</span></a></span><span>
</span><span id="line-1116"></span><span>
</span><span id="line-1117"></span><span>    </span><span class="hs-comment">-- See Note [Absence analysis for stable unfoldings and RULES]</span><span>
</span><span id="line-1118"></span><span>    </span><span id="local-6989586621681827336"><span class="annot"><span class="annottext">rhs_env2 :: DmdEnv
</span><a href="#local-6989586621681827336"><span class="hs-identifier hs-var hs-var">rhs_env2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827333"><span class="hs-identifier hs-var">rhs_env1</span></a></span><span> </span><span class="annot"><span class="annottext">DmdEnv -&gt; DmdEnv -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#plusDmdEnv"><span class="hs-operator hs-var">`plusDmdEnv`</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; VarSet -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#demandRootSet"><span class="hs-identifier hs-var">demandRootSet</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827303"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; VarSet
</span><a href="GHC.Core.FVs.html#bndrRuleAndUnfoldingIds"><span class="hs-identifier hs-var">bndrRuleAndUnfoldingIds</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827305"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1119"></span><span>
</span><span id="line-1120"></span><span>    </span><span class="hs-comment">-- See Note [Lazy and unleashable free variables]</span><span>
</span><span id="line-1121"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621681827329"><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827329"><span class="hs-identifier hs-var">sig_env</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681827308"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827308"><span class="hs-identifier hs-var">weak_fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdEnv -&gt; (DmdEnv, WeakDmds)
</span><a href="GHC.Core.Opt.DmdAnal.html#splitWeakDmds"><span class="hs-identifier hs-var">splitWeakDmds</span></a></span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827336"><span class="hs-identifier hs-var">rhs_env2</span></a></span><span>
</span><span id="line-1122"></span><span>
</span><span id="line-1123"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#splitWeakDmds"><span class="hs-identifier hs-type">splitWeakDmds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WeakDmds"><span class="hs-identifier hs-type">WeakDmds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1124"></span><span id="splitWeakDmds"><span class="annot"><span class="annottext">splitWeakDmds :: DmdEnv -&gt; (DmdEnv, WeakDmds)
</span><a href="GHC.Core.Opt.DmdAnal.html#splitWeakDmds"><span class="hs-identifier hs-var hs-var">splitWeakDmds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Demand.html#DE"><span class="hs-identifier hs-type">DE</span></a></span><span> </span><span id="local-6989586621681827340"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827340"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span id="local-6989586621681827341"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681827341"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WeakDmds -&gt; Divergence -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#DE"><span class="hs-identifier hs-var">DE</span></a></span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827342"><span class="hs-identifier hs-var">sig_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681827341"><span class="hs-identifier hs-var">div</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827343"><span class="hs-identifier hs-var">weak_fvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1125"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621681827343"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827343"><span class="hs-identifier hs-var">weak_fvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681827342"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827342"><span class="hs-identifier hs-var">sig_fvs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Demand -&gt; Bool) -&gt; WeakDmds -&gt; (WeakDmds, WeakDmds)
forall a. (a -&gt; Bool) -&gt; VarEnv a -&gt; (VarEnv a, VarEnv a)
</span><a href="GHC.Types.Var.Env.html#partitionVarEnv"><span class="hs-identifier hs-var">partitionVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isWeakDmd"><span class="hs-identifier hs-var">isWeakDmd</span></a></span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827340"><span class="hs-identifier hs-var">fvs</span></a></span><span>
</span><span id="line-1126"></span><span>
</span><span id="line-1127"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#thresholdArity"><span class="hs-identifier hs-type">thresholdArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-1128"></span><span class="hs-comment">-- See Note [Demand signatures are computed for a threshold arity based on idArity]</span><span>
</span><span id="line-1129"></span><span id="thresholdArity"><span class="annot"><span class="annottext">thresholdArity :: Id -&gt; CoreExpr -&gt; Arity
</span><a href="GHC.Core.Opt.DmdAnal.html#thresholdArity"><span class="hs-identifier hs-var hs-var">thresholdArity</span></a></span></span><span> </span><span id="local-6989586621681827345"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827345"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681827346"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827346"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1130"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Maybe Arity
</span><a href="GHC.Types.Id.html#isJoinId_maybe"><span class="hs-identifier hs-var">isJoinId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827345"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1131"></span><span>      </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681827348"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827348"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Arity
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Arity
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; Arity) -&gt; [Id] -&gt; Arity
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">([Id], CoreExpr) -&gt; [Id]
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">(([Id], CoreExpr) -&gt; [Id]) -&gt; ([Id], CoreExpr) -&gt; [Id]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; CoreExpr -&gt; ([Id], CoreExpr)
forall b. Arity -&gt; Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectNBinders"><span class="hs-identifier hs-var">collectNBinders</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827348"><span class="hs-identifier hs-var">join_arity</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827346"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1132"></span><span>      </span><span class="annot"><span class="annottext">Maybe Arity
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Arity
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827345"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-1133"></span><span>
</span><span id="line-1134"></span><span class="hs-comment">-- | The result type after applying 'idArity' many arguments. Returns 'Nothing'</span><span>
</span><span id="line-1135"></span><span class="hs-comment">-- when the type doesn't have exactly 'idArity' many arrows.</span><span>
</span><span id="line-1136"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#resultType_maybe"><span class="hs-identifier hs-type">resultType_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-1137"></span><span id="resultType_maybe"><span class="annot"><span class="annottext">resultType_maybe :: Id -&gt; Maybe Type
</span><a href="GHC.Core.Opt.DmdAnal.html#resultType_maybe"><span class="hs-identifier hs-var hs-var">resultType_maybe</span></a></span></span><span> </span><span id="local-6989586621681827353"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827353"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-1138"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827354"><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621681827354"><span class="hs-identifier hs-var">pis</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681827355"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827355"><span class="hs-identifier hs-var">ret_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([PiTyBinder], Type)
</span><a href="GHC.Core.Type.html#splitPiTys"><span class="hs-identifier hs-var">splitPiTys</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827353"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1139"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(PiTyBinder -&gt; Bool) -&gt; [PiTyBinder] -&gt; Arity
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Arity
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">PiTyBinder -&gt; Bool
</span><a href="GHC.Types.Var.html#isAnonPiTyBinder"><span class="hs-identifier hs-var">isAnonPiTyBinder</span></a></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621681827354"><span class="hs-identifier hs-var">pis</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Arity
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827353"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-1140"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Maybe Type) -&gt; Type -&gt; Maybe Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24%21/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827355"><span class="hs-identifier hs-var">ret_ty</span></a></span><span>
</span><span id="line-1141"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1142"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Type
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1143"></span><span>
</span><span id="line-1144"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#unboxedWhenSmall"><span class="hs-identifier hs-type">unboxedWhenSmall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span>
</span><span id="line-1145"></span><span class="hs-comment">-- See Note [Unboxed demand on function bodies returning small products]</span><span>
</span><span id="line-1146"></span><span id="unboxedWhenSmall"><span class="annot"><span class="annottext">unboxedWhenSmall :: AnalEnv -&gt; RecFlag -&gt; Maybe Type -&gt; SubDemand -&gt; SubDemand
</span><a href="GHC.Core.Opt.DmdAnal.html#unboxedWhenSmall"><span class="hs-identifier hs-var hs-var">unboxedWhenSmall</span></a></span></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="annot"><span class="annottext">RecFlag
</span><span class="hs-identifier">_</span></span><span>        </span><span class="annot"><span class="annottext">Maybe Type
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>       </span><span id="local-6989586621681827358"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827358"><span class="hs-identifier hs-var">sd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827358"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-1147"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#unboxedWhenSmall"><span class="hs-identifier hs-var">unboxedWhenSmall</span></a></span><span> </span><span id="local-6989586621681827359"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827359"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827360"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681827360"><span class="hs-identifier hs-var">rec_flag</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681827361"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827361"><span class="hs-identifier hs-var">ret_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681827362"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827362"><span class="hs-identifier hs-var">sd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Type -&gt; SubDemand -&gt; SubDemand
</span><a href="#local-6989586621681827363"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827361"><span class="hs-identifier hs-var">ret_ty</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827362"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-1148"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1149"></span><span>    </span><span class="hs-comment">-- Magic constant, bounding the depth of optimistic 'Unboxed' flags. We</span><span>
</span><span id="line-1150"></span><span>    </span><span class="hs-comment">-- might want to minmax in the future.</span><span>
</span><span id="line-1151"></span><span>    </span><span id="local-6989586621681827364"><span class="annot"><span class="annottext">max_depth :: Arity
</span><a href="#local-6989586621681827364"><span class="hs-identifier hs-var hs-var">max_depth</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RecFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isRec"><span class="hs-identifier hs-var">isRec</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681827360"><span class="hs-identifier hs-var">rec_flag</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">3</span></span><span> </span><span class="hs-comment">-- So we get at most something as deep as !P(L!P(L!L))</span><span>
</span><span id="line-1152"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span> </span><span class="hs-comment">-- Otherwise be unbox too deep in T18109, T18174 and others and get a bunch of stack overflows</span><span>
</span><span id="line-1153"></span><span>    </span><span class="annot"><a href="#local-6989586621681827363"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span>
</span><span id="line-1154"></span><span>    </span><span id="local-6989586621681827363"><span class="annot"><span class="annottext">go :: Arity -&gt; Type -&gt; SubDemand -&gt; SubDemand
</span><a href="#local-6989586621681827363"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681827366"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827366"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span id="local-6989586621681827367"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827367"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681827368"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827368"><span class="hs-identifier hs-var">sd</span></a></span></span><span>
</span><span id="line-1155"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827366"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827364"><span class="hs-identifier hs-var">max_depth</span></a></span><span>
</span><span id="line-1156"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827370"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681827370"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827371"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681827371"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827372"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681827372"><span class="hs-identifier hs-var">_co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs -&gt; Type -&gt; Maybe (TyCon, [Type], Coercion)
</span><a href="GHC.Core.Utils.html#normSplitTyConApp_maybe"><span class="hs-identifier hs-var">normSplitTyConApp_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; FamInstEnvs
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_fam_envs"><span class="hs-identifier hs-var">ae_fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827359"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827367"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1157"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681827373"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827373"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe DataCon
</span><a href="GHC.Core.TyCon.html#tyConSingleAlgDataCon_maybe"><span class="hs-identifier hs-var">tyConSingleAlgDataCon_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621681827370"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-1158"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [Id]
</span><a href="GHC.Core.DataCon.html#dataConExTyCoVars"><span class="hs-identifier hs-var">dataConExTyCoVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827373"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Can't unbox results with existentials</span><span>
</span><span id="line-1159"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Arity
</span><a href="GHC.Core.DataCon.html#dataConRepArity"><span class="hs-identifier hs-var">dataConRepArity</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827373"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">DmdAnalOpts -&gt; Arity
</span><a href="GHC.Core.Opt.DmdAnal.html#dmd_unbox_width"><span class="hs-identifier hs-var">dmd_unbox_width</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdAnalOpts
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_opts"><span class="hs-identifier hs-var">ae_opts</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827359"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1160"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Boxity
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827376"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827376"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; SubDemand -&gt; Maybe (Boxity, [Demand])
</span><a href="GHC.Types.Demand.html#viewProd"><span class="hs-identifier hs-var">viewProd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; Arity
</span><a href="GHC.Core.DataCon.html#dataConRepArity"><span class="hs-identifier hs-var">dataConRepArity</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827373"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827368"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-1161"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827377"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681827377"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scaled Type -&gt; Type) -&gt; [Scaled Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Scaled Type -&gt; Type
forall a. Scaled a -&gt; a
</span><a href="GHC.Core.TyCo.Rep.html#scaledThing"><span class="hs-identifier hs-var">scaledThing</span></a></span><span> </span><span class="annot"><span class="annottext">([Scaled Type] -&gt; [Type]) -&gt; [Scaled Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [Type] -&gt; [Scaled Type]
</span><a href="GHC.Core.DataCon.html#dataConInstArgTys"><span class="hs-identifier hs-var">dataConInstArgTys</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827373"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681827371"><span class="hs-identifier hs-var">tc_args</span></a></span><span>
</span><span id="line-1162"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; [Type] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827376"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681827377"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-1163"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Boxity -&gt; [Demand] -&gt; SubDemand
</span><a href="GHC.Types.Demand.html#mkProd"><span class="hs-identifier hs-var">mkProd</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span> </span><span class="annot"><span class="annottext">([Demand] -&gt; SubDemand) -&gt; [Demand] -&gt; SubDemand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24%21/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Demand -&gt; Demand) -&gt; [Type] -&gt; [Demand] -&gt; [Demand]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="GHC.Utils.Misc.html#strictZipWith"><span class="hs-identifier hs-var">strictZipWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity -&gt; Type -&gt; Demand -&gt; Demand
</span><a href="#local-6989586621681827379"><span class="hs-identifier hs-var">go_dmd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827366"><span class="hs-identifier hs-var">depth</span></a></span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Arity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#%2B/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681827377"><span class="hs-identifier hs-var">arg_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827376"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-1164"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1165"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827368"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-1166"></span><span>
</span><span id="line-1167"></span><span>    </span><span class="annot"><a href="#local-6989586621681827379"><span class="hs-identifier hs-type">go_dmd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-1168"></span><span>    </span><span id="local-6989586621681827379"><span class="annot"><span class="annottext">go_dmd :: Arity -&gt; Type -&gt; Demand -&gt; Demand
</span><a href="#local-6989586621681827379"><span class="hs-identifier hs-var hs-var">go_dmd</span></a></span></span><span> </span><span id="local-6989586621681827381"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827381"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span id="local-6989586621681827382"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827382"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681827383"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827383"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827383"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1169"></span><span>      </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#AbsDmd"><span class="hs-identifier hs-var">AbsDmd</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#AbsDmd"><span class="hs-identifier hs-var">AbsDmd</span></a></span><span>
</span><span id="line-1170"></span><span>      </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#BotDmd"><span class="hs-identifier hs-var">BotDmd</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#BotDmd"><span class="hs-identifier hs-var">BotDmd</span></a></span><span>
</span><span id="line-1171"></span><span>      </span><span id="local-6989586621681827386"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827386"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-type">:*</span></a></span><span> </span><span id="local-6989586621681827387"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827387"><span class="hs-identifier hs-var">sd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827386"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Card -&gt; SubDemand -&gt; Demand
Card -&gt; SubDemand -&gt; Demand
</span><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-var">:*</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Type -&gt; SubDemand -&gt; SubDemand
</span><a href="#local-6989586621681827363"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827381"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827382"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827387"><span class="hs-identifier hs-var">sd</span></a></span><span>
</span><span id="line-1172"></span><span>
</span><span id="line-1173"></span><span class="hs-comment">-- | If given the (local, non-recursive) let-bound 'Id', 'useLetUp' determines</span><span>
</span><span id="line-1174"></span><span class="hs-comment">-- whether we should process the binding up (body before rhs) or down (rhs</span><span>
</span><span id="line-1175"></span><span class="hs-comment">-- before body).</span><span>
</span><span id="line-1176"></span><span class="hs-comment">--</span><span>
</span><span id="line-1177"></span><span class="hs-comment">-- We use LetDown if there is a chance to get a useful strictness signature to</span><span>
</span><span id="line-1178"></span><span class="hs-comment">-- unleash at call sites. LetDown is generally more precise than LetUp if we can</span><span>
</span><span id="line-1179"></span><span class="hs-comment">-- correctly guess how it will be used in the body, that is, for which incoming</span><span>
</span><span id="line-1180"></span><span class="hs-comment">-- demand the strictness signature should be computed, which allows us to</span><span>
</span><span id="line-1181"></span><span class="hs-comment">-- unleash higher-order demands on arguments at call sites. This is mostly the</span><span>
</span><span id="line-1182"></span><span class="hs-comment">-- case when</span><span>
</span><span id="line-1183"></span><span class="hs-comment">--</span><span>
</span><span id="line-1184"></span><span class="hs-comment">--   * The binding takes any arguments before performing meaningful work (cf.</span><span>
</span><span id="line-1185"></span><span class="hs-comment">--     'idArity'), in which case we are interested to see how it uses them.</span><span>
</span><span id="line-1186"></span><span class="hs-comment">--   * The binding is a join point, hence acting like a function, not a value.</span><span>
</span><span id="line-1187"></span><span class="hs-comment">--     As a big plus, we know *precisely* how it will be used in the body; since</span><span>
</span><span id="line-1188"></span><span class="hs-comment">--     it's always tail-called, we can directly unleash the incoming demand of</span><span>
</span><span id="line-1189"></span><span class="hs-comment">--     the let binding on its RHS when computing a strictness signature. See</span><span>
</span><span id="line-1190"></span><span class="hs-comment">--     [Demand analysis for join points].</span><span>
</span><span id="line-1191"></span><span class="hs-comment">--</span><span>
</span><span id="line-1192"></span><span class="hs-comment">-- Thus, if the binding is not a join point and its arity is 0, we have a thunk</span><span>
</span><span id="line-1193"></span><span class="hs-comment">-- and use LetUp, implying that we have no usable demand signature available</span><span>
</span><span id="line-1194"></span><span class="hs-comment">-- when we analyse the let body.</span><span>
</span><span id="line-1195"></span><span class="hs-comment">--</span><span>
</span><span id="line-1196"></span><span class="hs-comment">-- Since thunk evaluation is memoised, we want to unleash its 'DmdEnv' of free</span><span>
</span><span id="line-1197"></span><span class="hs-comment">-- vars at most once, regardless of how many times it was forced in the body.</span><span>
</span><span id="line-1198"></span><span class="hs-comment">-- This makes a real difference wrt. usage demands. The other reason is being</span><span>
</span><span id="line-1199"></span><span class="hs-comment">-- able to unleash a more precise product demand on its RHS once we know how the</span><span>
</span><span id="line-1200"></span><span class="hs-comment">-- thunk was used in the let body.</span><span>
</span><span id="line-1201"></span><span class="hs-comment">--</span><span>
</span><span id="line-1202"></span><span class="hs-comment">-- Characteristic examples, always assuming a single evaluation:</span><span>
</span><span id="line-1203"></span><span class="hs-comment">--</span><span>
</span><span id="line-1204"></span><span class="hs-comment">--   * @let x = 2*y in x + x@ =&gt; LetUp. Compared to LetDown, we find out that</span><span>
</span><span id="line-1205"></span><span class="hs-comment">--     the expression uses @y@ at most once.</span><span>
</span><span id="line-1206"></span><span class="hs-comment">--   * @let x = (a,b) in fst x@ =&gt; LetUp. Compared to LetDown, we find out that</span><span>
</span><span id="line-1207"></span><span class="hs-comment">--     @b@ is absent.</span><span>
</span><span id="line-1208"></span><span class="hs-comment">--   * @let f x = x*2 in f y@ =&gt; LetDown. Compared to LetUp, we find out that</span><span>
</span><span id="line-1209"></span><span class="hs-comment">--     the expression uses @y@ strictly, because we have @f@'s demand signature</span><span>
</span><span id="line-1210"></span><span class="hs-comment">--     available at the call site.</span><span>
</span><span id="line-1211"></span><span class="hs-comment">--   * @join exit = 2*y in if a then exit else if b then exit else 3*y@ =&gt;</span><span>
</span><span id="line-1212"></span><span class="hs-comment">--     LetDown. Compared to LetUp, we find out that the expression uses @y@</span><span>
</span><span id="line-1213"></span><span class="hs-comment">--     strictly, because we can unleash @exit@'s signature at each call site.</span><span>
</span><span id="line-1214"></span><span class="hs-comment">--   * For a more convincing example with join points, see Note [Demand analysis</span><span>
</span><span id="line-1215"></span><span class="hs-comment">--     for join points].</span><span>
</span><span id="line-1216"></span><span class="hs-comment">--</span><span>
</span><span id="line-1217"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#useLetUp"><span class="hs-identifier hs-type">useLetUp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1218"></span><span id="useLetUp"><span class="annot"><span class="annottext">useLetUp :: TopLevelFlag -&gt; Id -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#useLetUp"><span class="hs-identifier hs-var hs-var">useLetUp</span></a></span></span><span> </span><span id="local-6989586621681827389"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827389"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681827390"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827390"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isNotTopLevel"><span class="hs-identifier hs-var">isNotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827389"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Arity
</span><a href="GHC.Types.Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827390"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827390"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1219"></span><span>
</span><span id="line-1220"></span><span class="hs-comment">{- Note [Demand analysis for join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   g :: (Int,Int) -&gt; Int
   g (p,q) = p+q

   f :: T -&gt; Int -&gt; Int
   f x p = g (join j y = (p,y)
              in case x of
                   A -&gt; j 3
                   B -&gt; j 4
                   C -&gt; (p,7))

If j was a vanilla function definition, we'd analyse its body with
evalDmd, and think that it was lazy in p.  But for join points we can
do better!  We know that j's body will (if called at all) be evaluated
with the demand that consumes the entire join-binding, in this case
the argument demand from g.  Whizzo!  g evaluates both components of
its argument pair, so p will certainly be evaluated if j is called.

For f to be strict in p, we need /all/ paths to evaluate p; in this
case the C branch does so too, so we are fine.  So, as usual, we need
to transport demands on free variables to the call site(s).  Compare
Note [Lazy and unleashable free variables].

The implementation is easy.  When analysing a join point, we can
analyse its body with the demand from the entire join-binding (written
let_dmd here).

Another win for join points!  #13543.

However, note that the strictness signature for a join point can
look a little puzzling.  E.g.

    (join j x = \y. error &quot;urk&quot;)
    (in case v of              )
    (     A -&gt; j 3             )  x
    (     B -&gt; j 4             )
    (     C -&gt; \y. blah        )

The entire thing is in a C(1,L) context, so j's strictness signature
will be    [A]b
meaning one absent argument, returns bottom.  That seems odd because
there's a \y inside.  But it's right because when consumed in a C(1,L)
context the RHS of the join point is indeed bottom.

Note [Demand signatures are computed for a threshold arity based on idArity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Given a binding { f = rhs }, we compute a &quot;theshold arity&quot;, and do demand
analysis based on a call with that many value arguments.

The threshold we use is

* Ordinary bindings: idArity f.
  Why idArity arguments? Because that's a conservative estimate of how many
  arguments we must feed a function before it does anything interesting with
  them.  Also it elegantly subsumes the trivial RHS and PAP case.

  idArity is /at least/ the number of manifest lambdas, but might be higher for
  PAPs and trivial RHS (see Note [Demand analysis for trivial right-hand sides]).

* Join points: the value-binder subset of the JoinArity.  This can
  be less than the number of visible lambdas; e.g.
     join j x = \y. blah
     in ...(jump j 2)....(jump j 3)....
  We know that j will never be applied to more than 1 arg (its join
  arity, and we don't eta-expand join points, so here a threshold
  of 1 is the best we can do.

Note that the idArity of a function varies independently of its cardinality
properties (cf. Note [idArity varies independently of dmdTypeDepth]), so we
implicitly encode the arity for when a demand signature is sound to unleash
in its 'dmdTypeDepth', not in its idArity (cf. Note [Understanding DmdType
and DmdSig] in GHC.Types.Demand). It is unsound to unleash a demand
signature when the incoming number of arguments is less than that. See
GHC.Types.Demand Note [What are demand signatures?]  for more details on
soundness.

Note that there might, in principle, be functions for which we might want to
analyse for more incoming arguments than idArity. Example:

  f x =
    if expensive
      then \y -&gt; ... y ...
      else \y -&gt; ... y ...

We'd analyse `f` under a unary call demand C(1,L), corresponding to idArity
being 1. That's enough to look under the manifest lambda and find out how a
unary call would use `x`, but not enough to look into the lambdas in the if
branches.

On the other hand, if we analysed for call demand C(1,C(1,L)), we'd get useful
strictness info for `y` (and more precise info on `x`) and possibly CPR
information, but

  * We would no longer be able to unleash the signature at unary call sites

  * Performing the worker/wrapper split based on this information would be
    implicitly eta-expanding `f`, playing fast and loose with divergence and
    even being unsound in the presence of newtypes, so we refrain from doing so.
    Also see Note [Don't eta expand in w/w] in GHC.Core.Opt.WorkWrap.

Since we only compute one signature, we do so for arity 1. Computing multiple
signatures for different arities (i.e., polyvariance) would be entirely
possible, if it weren't for the additional runtime and implementation
complexity.

Note [idArity varies independently of dmdTypeDepth]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general, an Id `f` has two independently varying attributes:

* f's idArity, and
* the dmdTypeDepth of f's demand signature

For example, if f's demand signature is &lt;L&gt;&lt;L&gt;, f's arity could be
greater than, or less than 2. Why?  Because both are conservative
approximations:

* Arity n means &quot;does no expensive work until applied to at least n args&quot;
  (e.g. (f x1..xm) is cheap to bring to HNF for m&lt;n)

* Dmd sig with n args means &quot;here is how to transform the incoming demand
  when applied to n args&quot;.  This is /semantic/ property, unrelated to
  arity. See GHC.Types.Demand Note [Understanding DmdType and DmdSig]

We used to check in GHC.Core.Lint that dmdTypeDepth &lt;= idArity for a let-bound
identifier. But that means we would have to zap demand signatures every time we
reset or decrease arity.

For example, consider the following expression:

    (let go x y = `x` seq ... in go) |&gt; co

`go` might have a strictness signature of `&lt;1L&gt;&lt;L&gt;`. The simplifier will identify
`go` as a nullary join point through `joinPointBinding_maybe` and float the
coercion into the binding, leading to an arity decrease:

    join go = (\x y -&gt; `x` seq ...) |&gt; co in go

With the CoreLint check, we would have to zap `go`'s perfectly viable strictness
signature.

However, in the case of a /bottoming/ signature, f : &lt;L&gt;&lt;L&gt;b, we /can/
say that f's arity is no greater than 2, because it'd be false to say
that f does no work when applied to 3 args.  Lint checks this constraint,
in `GHC.Core.Lint.lintLetBind`.

Note [Demand analysis for trivial right-hand sides]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    foo = plusInt |&gt; co
where plusInt is an arity-2 function with known strictness.  Clearly
we want plusInt's strictness to propagate to foo!  But because it has
no manifest lambdas, it won't do so automatically, and indeed 'co' might
have type (Int-&gt;Int-&gt;Int) ~ T.

Fortunately, GHC.Core.Opt.Arity gives 'foo' arity 2, which is enough for LetDown to
forward plusInt's demand signature, and all is well (see Note [Newtype arity] in
GHC.Core.Opt.Arity)! A small example is the test case NewtypeArity.

Note [Absence analysis for stable unfoldings and RULES]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Among others, tickets #18638 and #23208 show that it's really important to treat
stable unfoldings as demanded. Consider

   g = blah

   f = \x.  ...no use of g....
   {- f's stable unfolding is f = \x. ...g... -}

If f is ever inlined we use 'g'. But f's current RHS makes no use
of 'g', so if we don't look at the unfolding we'll mark g as Absent,
and transform to

   g = error &quot;Entered absent value&quot;
   f = \x. ...
   {- f's stable unfolding is f = \x. ...g... -}

Now if f is subsequently inlined, we'll use 'g' and ... disaster.

SOLUTION: if f has a stable unfolding, treat every free variable as a
/demand root/, that is: Analyse it as if it was a variable occuring in a
'topDmd' context. This is done in `demandRoot` (which we also use for exported
top-level ids). Do the same for Ids free in the RHS of any RULES for f.

Wrinkles:

  (W1) You may wonder how it can be that f's optimised RHS has somehow
    discarded 'g', but when f is inlined we /don't/ discard g in the same
    way. I think a simple example is
       g = (a,b)
       f = \x.  fst g
       {-# INLINE f #-}

    Now f's optimised RHS will be \x.a, but if we change g to (error &quot;..&quot;)
    (since it is apparently Absent) and then inline (\x. fst g) we get
    disaster.  But regardless, #18638 was a more complicated version of
    this, that actually happened in practice.

  (W2) You might wonder why we don't simply take the free vars of the
    unfolding/RULE and map them to topDmd. The reason is that any of the free vars
    might have demand signatures themselves that in turn demand transitive free
    variables and that we hence need to unleash! This came up in #23208.
    Consider

       err :: Int -&gt; b
       err = error &quot;really important message&quot;

       sg :: Int -&gt; Int
       sg _ = case err of {}  -- Str=&lt;1B&gt;b {err:-&gt;S}

       g :: a -&gt; a  -- g is exported
       g x = x
       {-# RULES &quot;g&quot; g @Int = sg #-}

    Here, `err` is only demanded by `sg`'s demand signature: It doesn't occur
    in the weak_fvs of `sg`'s RHS at all. Hence when we `demandRoots` `sg`
    because it occurs in the RULEs of `g` (which is exported), we better unleash
    the demand signature of `sg`, too! Before #23208 we simply added a 'topDmd'
    for `sg`, failing to unleash the signature and hence observed an absent
    error instead of the `really important message`.

Note [DmdAnal for DataCon wrappers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We give DataCon wrappers a (necessarily flat) demand signature in
`GHC.Types.Id.Make.mkDataConRep`, so that passes such as the Simplifier can
exploit it via the call to `GHC.Core.Opt.Simplify.Utils.isStrictArgInfo` in
`GHC.Core.Opt.Simplify.Iteration.rebuildCall`. But during DmdAnal, we *ignore*
the demand signature of a DataCon wrapper, and instead analyse its unfolding at
every call site.

The reason is that DataCon *worker*s have very precise demand transformers,
computed by `dmdTransformDataConSig`. It would be awkward if DataCon *wrappers*
would behave much less precisely during DmdAnal. Example:

   data T1 = MkT1 { get_x1 :: Int,  get_y1 :: Int }
   data T2 = MkT2 { get_x2 :: !Int, get_y2 :: Int }
   f1 x y = get_x1 (MkT1 x y)
   f2 x y = get_x2 (MkT2 x y)

Here `MkT1` has no wrapper. `get_x1` puts a demand `!P(1!L,A)` on its argument,
and `dmdTransformDataConSig` will transform that demand to an absent demand on
`y` in `f1` and an unboxing demand on `x`.
But `MkT2` has a wrapper (to evaluate the first field). If demand analysis deals
with `MkT2` only through its demand signature, demand signatures can't transform
an incoming demand `P(1!L,A)` in a useful way, so we won't get an absent demand
on `y` in `f2` or see that `x` can be unboxed. That's a serious loss.

The example above will not actually occur, because $WMkT2 would be inlined.
Nevertheless, we can get interesting sub-demands on DataCon wrapper
applications in boring contexts; see T22241.

You might worry about the efficiency cost of demand-analysing datacon wrappers
at every call site. But in fact they are inlined /anyway/ in the Final phase,
which happens before DmdAnal, so few wrappers remain. And analysing the
unfoldings for the remaining calls (which are those in a boring context) will be
exactly as (in)efficent as if we'd inlined those calls. It turns out to be not
measurable in practice.

See also Note [CPR for DataCon wrappers] in `GHC.Core.Opt.CprAnal`.

Note [Boxity for bottoming functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (A)
    indexError :: Show a =&gt; (a, a) -&gt; a -&gt; String -&gt; b
    -- Str=&lt;..&gt;&lt;1!P(S,S)&gt;&lt;1S&gt;&lt;S&gt;b
    indexError rng i s = error (show rng ++ show i ++ show s)

    get :: (Int, Int) -&gt; Int -&gt; [a] -&gt; a
    get p@(l,u) i xs
      | l &lt;= i, i &lt; u = xs !! (i-u)
      | otherwise     = indexError p i &quot;get&quot;

The hot path of `get` certainly wants to unbox `p` as well as `l` and
`u`, but the unimportant, diverging error path needs `l::a` and `u::a`
boxed, since `indexError` can't unbox them because they are polymorphic.
This pattern often occurs in performance sensitive code that does
bounds-checking.

So we want to give `indexError` a signature like `&lt;1!P(!S,!S)&gt;&lt;1!S&gt;&lt;S!S&gt;b`
where the !S (meaning Poly Unboxed C1N) says that the polymorphic arguments
are unboxed (recursively).  The wrapper for `indexError` won't /acutally/
unbox them (because their polymorphic type doesn't allow that) but when
demand-analysing /callers/, we'll behave as if that call needs the args
unboxed.

Then at call sites of `indexError`, we will end up doing some
reboxing, because `$windexError` still takes boxed arguments. This
reboxing should usually float into the slow, diverging code path; but
sometimes (sadly) it doesn't: see Note [Reboxed crud for bottoming calls].

Here is another important case (B):
    f x = Just x  -- Suppose f is not inlined for some reason
                  -- Main point: f takes its argument boxed

    wombat x = error (show (f x))

    g :: Bool -&gt; Int -&gt; a
    g True  x = x+1
    g False x = wombat x

Again we want `wombat` to pretend to take its Int-typed argument unboxed,
even though it has to pass it boxed to `f`, so that `g` can take its
argument unboxed (and rebox it before calling `wombat`).

So here's what we do: while summarising `indexError`'s boxity signature in
`finaliseArgBoxities`:

* To address (B), for bottoming functions, we start by using `unboxDeeplyDmd`
  to make all its argument demands unboxed, right to the leaves; regardless
  of what the analysis said.

* To address (A), for bottoming functions, in the DontUnbox case when the
  argument is a type variable, we /refrain/ from using trimBoxity.
  (Remember the previous bullet: we have already doen `unboxDeeplyDmd`.)

Wrinkle:

* Remember Note [No lazy, Unboxed demands in demand signature]. So
  unboxDeeplyDmd doesn't recurse into lazy demands.  It's extremely unusual
  to have lazy demands in the arguments of a bottoming function anyway.
  But it can happen, when the demand analyser gives up because it
  encounters a recursive data type; see Note [Demand analysis for recursive
  data constructors].

Note [Reboxed crud for bottoming calls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For functions like `get` in Note [Boxity for bottoming functions], it's clear
that the reboxed crud will be floated inside to the call site of `$windexError`.
But here's an example where that is not the case:
```hs
import GHC.Ix

theresCrud :: Int -&gt; Int -&gt; Int
theresCrud x y = go x
  where
    go 0 = index (0,y) 0
    go 1 = index (x,y) 1
    go n = go (n-1)
    {-# NOINLINE theresCrud #-}
```
If you look at the Core, you'll see that `y` will be reboxed and used in the
two exit join points for the `$windexError` calls, while `x` is only reboxed in the
exit join point for `index (x,y) 1` (happens in lvl below):
```
$wtheresCrud = \ ww ww1 -&gt;
      let { y = I# ww1 } in
      join { lvl2 = ... case lvl1 ww y of wild { }; ... } in
      join { lvl3 = ... case lvl y of wild { }; ... } in
      ...
```
This is currently a bug that we willingly accept and it's documented in #21128.

See also Note [indexError] in base:GHC.Ix, which describes how we use
SPECIALISE to mitigate this problem for indexError.
-}</span><span>
</span><span id="line-1576"></span><span>
</span><span id="line-1577"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
             Finalising boxity
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-1582"></span><span>
</span><span id="line-1583"></span><span class="hs-comment">{- Note [Finalising boxity for demand signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The worker/wrapper pass must strictly adhere to the boxity decisions
encoded in the demand signature, because that is the information that
demand analysis propagates throughout the program. Failing to
implement the strategy laid out in the signature can result in
reboxing in unexpected places. Hence, we must completely anticipate
unboxing decisions during demand analysis and reflect these decisions
in demand annotations. That is the job of 'finaliseArgBoxities',
which is defined here and called from demand analysis.

Here is a list of different Notes it has to take care of:

  * Note [No lazy, Unboxed demands in demand signature] such as `L!P(L)` in
    general, but still allow Note [Unboxing evaluated arguments]
  * Note [No nested Unboxed inside Boxed in demand signature] such as `1P(1!L)`
  * Note [mkWWstr and unsafeCoerce]

NB: Then, the worker/wrapper blindly trusts the boxity info in the
demand signature; that is why 'canUnboxArg' does not look at
strictness -- it is redundant to do so.

Note [Finalising boxity for let-bound Ids]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  let x = e in body
where the demand on 'x' is 1!P(blah).  We want to unbox x according to
Note [Thunk splitting] in GHC.Core.Opt.WorkWrap.  We must do this because
worker/wrapper ignores strictness and looks only at boxity flags; so if
x's demand is L!P(blah) we might still split it (wrongly).  We want to
switch to Boxed on any lazy demand.

That is what finaliseLetBoxity does.  It has no worker-arg budget, so it
is much simpler than finaliseArgBoxities.

Note [No nested Unboxed inside Boxed in demand signature]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
```
f p@(x,y)
  | even (x+y) = []
  | otherwise  = [p]
```
Demand analysis will infer that the function body puts a demand of `1P(1!L,1!L)`
on 'p', e.g., Boxed on the outside but Unboxed on the inside. But worker/wrapper
can't unbox the pair components without unboxing the pair! So we better say
`1P(1L,1L)` in the demand signature in order not to spread wrong Boxity info.
That happens via the call to trimBoxity in 'finaliseArgBoxities'/'finaliseLetBoxity'.

Note [No lazy, Unboxed demands in demand signature]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider T19407:

  data Huge = Huge Bool () ... () -- think: DynFlags
  data T = T { h :: Huge, n :: Int }
  f t@(T h _) = g h t
  g (H b _ ... _) t = if b then 1 else n t

The body of `g` puts (approx.) demand `L!P(A,1)` on `t`. But we better
not put that demand in `g`'s demand signature, because worker/wrapper will not
in general unbox a lazy-and-unboxed demand like `L!P(..)`.
(The exception are known-to-be-evaluated arguments like strict fields,
see Note [Unboxing evaluated arguments].)

The program above is an example where spreading misinformed boxity through the
signature is particularly egregious. If we give `g` that signature, then `f`
puts demand `S!P(1!P(1L,A,..),ML)` on `t`. Now we will unbox `t` in `f` it and
we get

  f (T (H b _ ... _) n) = $wf b n
  $wf b n = $wg b (T (H b x ... x) n)
  $wg = ...

Massive reboxing in `$wf`! Solution: Trim boxity on lazy demands in
'trimBoxity', modulo Note [Unboxing evaluated arguments].

Note [Unboxing evaluated arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this program (due to Roman):

    data X a = X !a

    foo :: X Int -&gt; Int -&gt; Int
    foo x@(X a) n = go 0
     where
       go i | i &lt; n     = a + go (i+1)
            | otherwise = 0

We want the worker for 'foo' to look like this:

    $wfoo :: Int# -&gt; Int# -&gt; Int#

with the first argument unboxed, so that it is not eval'd each time around the
'go' loop (which would otherwise happen, since 'foo' is not strict in 'a'). It
is sound for the wrapper to pass an unboxed arg because X is strict
(see Note [Strictness and Unboxing] in &quot;GHC.Core.Opt.DmdAnal&quot;), so its argument
must be evaluated. And if we *don't* pass an unboxed argument, we can't even
repair it by adding a `seq` thus:

    foo (X a) n = a `seq` go 0

because the seq is discarded (very early) since X is strict!

So here's what we do

* Since this has nothing to do with how 'foo' uses 'a', we leave demand
  analysis alone, but account for the additional evaluatedness when
  annotating the binder 'finaliseArgBoxities', which will retain the Unboxed
  boxity on 'a' in the definition of 'foo' in the demand 'L!P(L)'; meaning
  it's used lazily but unboxed nonetheless. This seems to contradict Note
  [No lazy, Unboxed demands in demand signature], but we know that 'a' is
  evaluated and thus can be unboxed.

* When 'finaliseArgBoxities' decides to unbox a record, it will zip the field demands
  together with the respective 'StrictnessMark'. In case of 'x', it will pair
  up the lazy field demand 'L!P(L)' on 'a' with 'MarkedStrict' to account for
  the strict field.

* Said 'StrictnessMark' is passed to the recursive invocation of 'go_args' in
  'finaliseArgBoxities' when deciding whether to unbox 'a'. 'a' was used lazily, but
  since it also says 'MarkedStrict', we'll retain the 'Unboxed' boxity on 'a'.

* Worker/wrapper will consult 'canUnboxArg' for its unboxing decision. It will
  /not/ look at the strictness bits of the demand, only at Boxity flags. As such,
  it will happily unbox 'a' despite the lazy demand on it.

The net effect is that boxity analysis and the w/w transformation are more
aggressive about unboxing the strict arguments of a data constructor than when
looking at strictness info exclusively. It is very much like (Nested) CPR, which
needs its nested fields to be evaluated in order for it to unbox nestedly.

There is the usual danger of reboxing, which as usual we ignore. But
if X is monomorphic, and has an UNPACK pragma, then this optimisation
is even more important.  We don't want the wrapper to rebox an unboxed
argument, and pass an Int to $wfoo!

This works in nested situations like T10482

    data family Bar a
    data instance Bar (a, b) = BarPair !(Bar a) !(Bar b)
    newtype instance Bar Int = Bar Int

    foo :: Bar ((Int, Int), Int) -&gt; Int -&gt; Int
    foo f k = case f of BarPair x y -&gt;
              case burble of
                 True -&gt; case x of
                           BarPair p q -&gt; ...
                 False -&gt; ...

The extra eagerness lets us produce a worker of type:
     $wfoo :: Int# -&gt; Int# -&gt; Int# -&gt; Int -&gt; Int
     $wfoo p# q# y# = ...

even though the `case x` is only lazily evaluated.

--------- Historical note ------------
We used to add data-con strictness demands when demand analysing case
expression. However, it was noticed in #15696 that this misses some cases. For
instance, consider the program (from T10482)

    data family Bar a
    data instance Bar (a, b) = BarPair !(Bar a) !(Bar b)
    newtype instance Bar Int = Bar Int

    foo :: Bar ((Int, Int), Int) -&gt; Int -&gt; Int
    foo f k =
      case f of
        BarPair x y -&gt; case burble of
                          True -&gt; case x of
                                    BarPair p q -&gt; ...
                          False -&gt; ...

We really should be able to assume that `p` is already evaluated since it came
from a strict field of BarPair. This strictness would allow us to produce a
worker of type:

    $wfoo :: Int# -&gt; Int# -&gt; Int# -&gt; Int -&gt; Int
    $wfoo p# q# y# = ...

even though the `case x` is only lazily evaluated

Indeed before we fixed #15696 this would happen since we would float the inner
`case x` through the `case burble` to get:

    foo f k =
      case f of
        BarPair x y -&gt; case x of
                          BarPair p q -&gt; case burble of
                                          True -&gt; ...
                                          False -&gt; ...

However, after fixing #15696 this could no longer happen (for the reasons
discussed in ticket:15696#comment:76). This means that the demand placed on `f`
would then be significantly weaker (since the False branch of the case on
`burble` is not strict in `p` or `q`).

Consequently, we now instead account for data-con strictness in mkWWstr_one,
applying the strictness demands to the final result of DmdAnal. The result is
that we get the strict demand signature we wanted even if we can't float
the case on `x` up through the case on `burble`.

Note [Do not unbox class dictionaries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We never unbox class dictionaries in worker/wrapper.

1. INLINABLE functions
   If we have
      f :: Ord a =&gt; [a] -&gt; Int -&gt; a
      {-# INLINABLE f #-}
   and we worker/wrapper f, we'll get a worker with an INLINABLE pragma
   (see Note [Worker/wrapper for INLINABLE functions] in GHC.Core.Opt.WorkWrap),
   which can still be specialised by the type-class specialiser, something like
      fw :: Ord a =&gt; [a] -&gt; Int# -&gt; a

   BUT if f is strict in the Ord dictionary, we might unpack it, to get
      fw :: (a-&gt;a-&gt;Bool) -&gt; [a] -&gt; Int# -&gt; a
   and the type-class specialiser can't specialise that. An example is #6056.

   Historical note: #14955 describes how I got this fix wrong the first time.
   I got aware of the issue in T5075 by the change in boxity of loop between
   demand analysis runs.

2. -fspecialise-aggressively.  As #21286 shows, the same phenomenon can occur
   occur without INLINABLE, when we use -fexpose-all-unfoldings and
   -fspecialise-aggressively to do vigorous cross-module specialisation.

3. #18421 found that unboxing a dictionary can also make the worker less likely
   to inline; the inlining heuristics seem to prefer to inline a function
   applied to a dictionary over a function applied to a bunch of functions.

TL;DR we /never/ unbox class dictionaries. Unboxing the dictionary, and passing
a raft of higher-order functions isn't a huge win anyway -- you really want to
specialise the function.

Note [Worker argument budget]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In 'finaliseArgBoxities' we don't want to generate workers with zillions of
argument when, say given a strict record with zillions of fields.  So we
limit the maximum number of worker args ('max_wkr_args') to the maximum of
  - -fmax-worker-args=N
  - The number of args in the original function; if it already has has
    zillions of arguments we don't want to seek /fewer/ args in the worker.
(Maybe we should /add/ them instead of maxing?)

We pursue a &quot;layered&quot; strategy for unboxing: we unbox the top level of the
argument(s), subject to budget; if there are any arguments left we unbox the
next layer, using that depleted budget.
Unboxing an argument *increases* the budget for the inner layer roughly
according to how many registers that argument takes (unboxed tuples take
multiple registers, see below), as determined by 'unariseArity'.
Budget is spent when we have to pass a non-absent field as a parameter.

To achieve this, we use the classic almost-circular programming technique in
which we we write one pass that takes a lazy list of the Budgets for every
layer. The effect is that of a breadth-first search (over argument type and
demand structure) to compute Budgets followed by a depth-first search to
construct the product demands, but laziness allows us to do it all in one
pass and without intermediate data structures.

Suppose we have -fmax-worker-args=4 for the remainder of this Note.
Then consider this example function:

  boxed :: (Int, Int) -&gt; (Int, (Int, Int, Int)) -&gt; Int
  boxed (a,b) (c, (d,e,f)) = a + b + c + d + e + f

With a budget of 4 args to spend (number of args is only 2), we'd be served well
to unbox both pairs, but not the triple. Indeed, that is what the algorithm
computes, and the following pictogram shows how the budget layers are computed.
Each layer is started with `n ~&gt;`, where `n` is the budget at the start of the
layer. We write -n~&gt; when we spend budget (and n is the remaining budget) and
+n~&gt; when we earn budget. We separate unboxed args with ][ and indicate
inner budget threads becoming negative in braces {{}}, so that we see which
unboxing decision we do *not* commit to. Without further ado:

  4 ~&gt; ][     (a,b) -3~&gt;               ][     (c, ...) -2~&gt;
       ][      | |                     ][      |   |
       ][      | +-------------+       ][      |   +-----------------+
       ][      |               |       ][      |                     |
       ][      v               v       ][      v                     v
  2 ~&gt; ][ +3~&gt; a  -2~&gt; ][      b  -1~&gt; ][ +2~&gt; c  -1~&gt; ][        (d, e, f) -0~&gt;
       ][      |       ][      |       ][      |       ][ {{      |  |  |                          }}
       ][      |       ][      |       ][      |       ][ {{      |  |  +----------------+         }}
       ][      v       ][      v       ][      v       ][ {{      v  +------v            v         }}
  0 ~&gt; ][ +1~&gt; I# -0~&gt; ][ +1~&gt; I# -0~&gt; ][ +1~&gt; I# -0~&gt; ][ {{ +1~&gt; d -0~&gt; ][ e -(-1)~&gt; ][ f -(-2)~&gt; }}

Unboxing increments the budget we have on the next layer (because we don't need
to retain the boxed arg), but in turn the inner layer must afford to retain all
non-absent fields, each decrementing the budget. Note how the budget becomes
negative when trying to unbox the triple and the unboxing decision is &quot;rolled
back&quot;. This is done by the 'positiveTopBudget' guard.

There's a bit of complication as a result of handling unboxed tuples correctly;
specifically, handling nested unboxed tuples. Consider (#21737)

  unboxed :: (Int, Int) -&gt; (# Int, (# Int, Int, Int #) #) -&gt; Int
  unboxed (a,b) (# c, (# d, e, f #) #) = a + b + c + d + e + f

Recall that unboxed tuples will be flattened to individual arguments during
unarisation. Here, `unboxed` will have 5 arguments at runtime because of the
nested unboxed tuple, which will be flattened to 4 args. So it's best to leave
`(a,b)` boxed (because we already are above our arg threshold), but unbox `c`
through `f` because that doesn't increase the number of args post unarisation.

Note that the challenge is that syntactically, `(# d, e, f #)` occurs in a
deeper layer than `(a, b)`. Treating unboxed tuples as a regular data type, we'd
make the same unboxing decisions as for `boxed` above; although our starting
budget is 5 (Here, the number of args is greater than -fmax-worker-args), it's
not enough to unbox the triple (we'd finish with budget -1). So we'd unbox `a`
through `c`, but not `d` through `f`, which is silly, because then we'd end up
having 6 arguments at runtime, of which `d` through `f` weren't unboxed.

Hence we pretend that the fields of unboxed tuples appear in the same budget
layer as the tuple itself. For example at the top-level, `(# x,y #)` is to be
treated just like two arguments `x` and `y`.
Of course, for that to work, our budget calculations must initialise
'max_wkr_args' to 5, based on the 'unariseArity' of each Core arg: That would be
1 for the pair and 4 for the unboxed pair. Then when we decide whether to unbox
the unboxed pair, we *directly* recurse into the fields, spending our budget
on retaining `c` and (after recursing once more) `d` through `f` as arguments,
depleting our budget completely in the first layer. Pictorially:

  5 ~&gt; ][         (a,b) -4~&gt;             ][         (# c, ... #)
       ][ {{      | |                 }} ][      c  -3~&gt; ][ (# d, e, f #)
       ][ {{      | +-------+         }} ][      |       ][      d  -2~&gt; ][      e  -1~&gt; ][      f  -0~&gt;
       ][ {{      |         |         }} ][      |       ][      |       ][      |       ][      |
       ][ {{      v         v         }} ][      v       ][      v       ][      v       ][      v
  0 ~&gt; ][ {{ +1~&gt; a -0~&gt; ][ b -(-1)~&gt; }} ][ +1~&gt; I# -0~&gt; ][ +1~&gt; I# -0~&gt; ][ +1~&gt; I# -0~&gt; ][ +1~&gt; I# -0~&gt;

As you can see, we have no budget left to justify unboxing `(a,b)` on the second
layer, which is good, because it would increase the number of args. Also note
that we can still unbox `c` through `f` in this layer, because doing so has a
net zero effect on budget.

Note [The OPAQUE pragma and avoiding the reboxing of arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In https://gitlab.haskell.org/ghc/ghc/-/issues/13143 it was identified that when
a function 'f' with a NOINLINE pragma is W/W transformed, then the worker for
'f' should get the NOINLINE annotation, while the wrapper /should/ be inlined.

That's because if the wrapper for 'f' had stayed NOINLINE, then any worker of a
W/W-transformed /caller of/ 'f' would immediately rebox any unboxed arguments
that is applied to the wrapper of 'f'. When the wrapper is inlined, that kind of
reboxing does not happen.

But now we have functions with OPAQUE pragmas, which by definition (See Note
[OPAQUE pragma]) do not get W/W-transformed. So in order to avoid reboxing
workers of any W/W-transformed /callers of/ 'f' we need to strip all boxity
information from 'f' in the demand analysis. This will inform the
W/W-transformation code that boxed arguments of 'f' must definitely be passed
along in boxed form and as such dissuade the creation of reboxing workers.
-}</span><span>
</span><span id="line-1934"></span><span>
</span><span id="line-1935"></span><span class="annot"><span class="hs-comment">-- | How many registers does this type take after unarisation?</span></span><span>
</span><span id="line-1936"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#unariseArity"><span class="hs-identifier hs-type">unariseArity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span>
</span><span id="line-1937"></span><span id="unariseArity"><span class="annot"><span class="annottext">unariseArity :: Type -&gt; Arity
</span><a href="GHC.Core.Opt.DmdAnal.html#unariseArity"><span class="hs-identifier hs-var hs-var">unariseArity</span></a></span></span><span> </span><span id="local-6989586621681827393"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827393"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PrimRep] -&gt; Arity
forall a. [a] -&gt; Arity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Arity
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; [PrimRep]
Type -&gt; [PrimRep]
</span><a href="GHC.Types.RepType.html#typePrimRep"><span class="hs-identifier hs-var">typePrimRep</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827393"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1938"></span><span>
</span><span id="line-1939"></span><span class="hs-keyword">data</span><span> </span><span id="Budgets"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#Budgets"><span class="hs-identifier hs-var">Budgets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MkB"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#MkB"><span class="hs-identifier hs-var">MkB</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#Budgets"><span class="hs-identifier hs-type">Budgets</span></a></span><span>   </span><span class="hs-comment">-- An infinite list of arity budgets</span><span>
</span><span id="line-1940"></span><span>
</span><span id="line-1941"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#earnTopBudget"><span class="hs-identifier hs-type">earnTopBudget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#Budgets"><span class="hs-identifier hs-type">Budgets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#Budgets"><span class="hs-identifier hs-type">Budgets</span></a></span><span>
</span><span id="line-1942"></span><span id="earnTopBudget"><span class="annot"><span class="annottext">earnTopBudget :: Budgets -&gt; Budgets
</span><a href="GHC.Core.Opt.DmdAnal.html#earnTopBudget"><span class="hs-identifier hs-var hs-var">earnTopBudget</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#MkB"><span class="hs-identifier hs-type">MkB</span></a></span><span> </span><span id="local-6989586621681827397"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827397"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681827398"><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827398"><span class="hs-identifier hs-var">bg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Budgets -&gt; Budgets
</span><a href="GHC.Core.Opt.DmdAnal.html#MkB"><span class="hs-identifier hs-var">MkB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827397"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Arity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#%2B/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827398"><span class="hs-identifier hs-var">bg</span></a></span><span>
</span><span id="line-1943"></span><span>
</span><span id="line-1944"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#spendTopBudget"><span class="hs-identifier hs-type">spendTopBudget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#Budgets"><span class="hs-identifier hs-type">Budgets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#Budgets"><span class="hs-identifier hs-type">Budgets</span></a></span><span>
</span><span id="line-1945"></span><span id="spendTopBudget"><span class="annot"><span class="annottext">spendTopBudget :: Arity -&gt; Budgets -&gt; Budgets
</span><a href="GHC.Core.Opt.DmdAnal.html#spendTopBudget"><span class="hs-identifier hs-var hs-var">spendTopBudget</span></a></span></span><span> </span><span id="local-6989586621681827400"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827400"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#MkB"><span class="hs-identifier hs-type">MkB</span></a></span><span> </span><span id="local-6989586621681827401"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827401"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681827402"><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827402"><span class="hs-identifier hs-var">bg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Budgets -&gt; Budgets
</span><a href="GHC.Core.Opt.DmdAnal.html#MkB"><span class="hs-identifier hs-var">MkB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827401"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Arity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#-/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827400"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827402"><span class="hs-identifier hs-var">bg</span></a></span><span>
</span><span id="line-1946"></span><span>
</span><span id="line-1947"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#positiveTopBudget"><span class="hs-identifier hs-type">positiveTopBudget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#Budgets"><span class="hs-identifier hs-type">Budgets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1948"></span><span id="positiveTopBudget"><span class="annot"><span class="annottext">positiveTopBudget :: Budgets -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#positiveTopBudget"><span class="hs-identifier hs-var hs-var">positiveTopBudget</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#MkB"><span class="hs-identifier hs-type">MkB</span></a></span><span> </span><span id="local-6989586621681827404"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827404"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Budgets
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827404"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1949"></span><span>
</span><span id="line-1950"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#finaliseArgBoxities"><span class="hs-identifier hs-type">finaliseArgBoxities</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#Arity"><span class="hs-identifier hs-type">Arity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Divergence"><span class="hs-identifier hs-type">Divergence</span></a></span><span>
</span><span id="line-1951"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1952"></span><span id="finaliseArgBoxities"><span class="annot"><span class="annottext">finaliseArgBoxities :: AnalEnv
-&gt; Id
-&gt; Arity
-&gt; CoreExpr
-&gt; Divergence
-&gt; Maybe ([Demand], CoreExpr)
</span><a href="GHC.Core.Opt.DmdAnal.html#finaliseArgBoxities"><span class="hs-identifier hs-var hs-var">finaliseArgBoxities</span></a></span></span><span> </span><span id="local-6989586621681827405"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827405"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827406"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827406"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621681827407"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827407"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span id="local-6989586621681827408"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827408"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621681827409"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681827409"><span class="hs-identifier hs-var">div</span></a></span></span><span>
</span><span id="line-1953"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827407"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Arity
forall a. (a -&gt; Bool) -&gt; [a] -&gt; Arity
</span><a href="GHC.Utils.Misc.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827410"><span class="hs-identifier hs-var">bndrs</span></a></span><span>  </span><span class="hs-comment">-- Can't find enough binders</span><span>
</span><span id="line-1954"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ([Demand], CoreExpr)
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-comment">-- This happens if we have   f = g</span><span>
</span><span id="line-1955"></span><span>             </span><span class="hs-comment">-- Then there are no binders; we don't worker/wrapper; and we</span><span>
</span><span id="line-1956"></span><span>             </span><span class="hs-comment">-- simply want to give f the same demand signature as g</span><span>
</span><span id="line-1957"></span><span>
</span><span id="line-1958"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-comment">-- NB: arity is the threshold_arity, which might be less than</span><span>
</span><span id="line-1959"></span><span>              </span><span class="hs-comment">-- manifest arity for join points</span><span>
</span><span id="line-1960"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;finaliseArgBoxities&quot; (</span><span>
</span><span id="line-1961"></span><span>    </span><span class="hs-comment">--   vcat [text &quot;function:&quot; &lt;+&gt; ppr fn</span><span>
</span><span id="line-1962"></span><span>    </span><span class="hs-comment">--        , text &quot;dmds before:&quot; &lt;+&gt; ppr (map idDemandInfo (filter isId bndrs))</span><span>
</span><span id="line-1963"></span><span>    </span><span class="hs-comment">--        , text &quot;dmds after: &quot; &lt;+&gt;  ppr arg_dmds' ]) $</span><span>
</span><span id="line-1964"></span><span>    </span><span class="annot"><span class="annottext">([Demand], CoreExpr) -&gt; Maybe ([Demand], CoreExpr)
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827411"><span class="hs-identifier hs-var">arg_dmds'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681827412"><span class="hs-identifier hs-var">add_demands</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827411"><span class="hs-identifier hs-var">arg_dmds'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827408"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1965"></span><span>    </span><span class="hs-comment">-- add_demands: we must attach the final boxities to the lambda-binders</span><span>
</span><span id="line-1966"></span><span>    </span><span class="hs-comment">-- of the function, both because that's kosher, and because CPR analysis</span><span>
</span><span id="line-1967"></span><span>    </span><span class="hs-comment">-- uses the info on the binders directly.</span><span>
</span><span id="line-1968"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1969"></span><span>    </span><span id="local-6989586621681827413"><span class="annot"><span class="annottext">opts :: DmdAnalOpts
</span><a href="#local-6989586621681827413"><span class="hs-identifier hs-var hs-var">opts</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdAnalOpts
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_opts"><span class="hs-identifier hs-var">ae_opts</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827405"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1970"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681827410"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827410"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827414"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827414"><span class="hs-identifier hs-var">_body</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ([Id], CoreExpr)
forall b. Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827408"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1971"></span><span>    </span><span id="local-6989586621681827416"><span class="annot"><span class="annottext">unarise_arity :: Arity
</span><a href="#local-6989586621681827416"><span class="hs-identifier hs-var hs-var">unarise_arity</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Arity] -&gt; Arity
forall a. Num a =&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#sum/Data.Foldable.html#sum"><span class="hs-identifier hs-var">sum</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Arity
</span><a href="GHC.Core.Opt.DmdAnal.html#unariseArity"><span class="hs-identifier hs-var">unariseArity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827418"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681827418"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827418"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827410"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827418"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1972"></span><span>    </span><span id="local-6989586621681827419"><span class="annot"><span class="annottext">max_wkr_args :: Arity
</span><a href="#local-6989586621681827419"><span class="hs-identifier hs-var hs-var">max_wkr_args</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdAnalOpts -&gt; Arity
</span><a href="GHC.Core.Opt.DmdAnal.html#dmd_max_worker_args"><span class="hs-identifier hs-var">dmd_max_worker_args</span></a></span><span> </span><span class="annot"><span class="annottext">DmdAnalOpts
</span><a href="#local-6989586621681827413"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Arity
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`max`</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827416"><span class="hs-identifier hs-var">unarise_arity</span></a></span><span>
</span><span id="line-1973"></span><span>                      </span><span class="hs-comment">-- This is the budget initialisation step of</span><span>
</span><span id="line-1974"></span><span>                      </span><span class="hs-comment">-- Note [Worker argument budget]</span><span>
</span><span id="line-1975"></span><span>
</span><span id="line-1976"></span><span>    </span><span class="hs-comment">-- This is the key line, which uses almost-circular programming</span><span>
</span><span id="line-1977"></span><span>    </span><span class="hs-comment">-- The remaining budget from one layer becomes the initial</span><span>
</span><span id="line-1978"></span><span>    </span><span class="hs-comment">-- budget for the next layer down.  See Note [Worker argument budget]</span><span>
</span><span id="line-1979"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681827421"><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827421"><span class="hs-identifier hs-var">remaining_budget</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827411"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827411"><span class="hs-identifier hs-var">arg_dmds'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Budgets -&gt; [(Type, StrictnessMark, Demand)] -&gt; (Budgets, [Demand])
</span><a href="#local-6989586621681827422"><span class="hs-identifier hs-var">go_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity -&gt; Budgets -&gt; Budgets
</span><a href="GHC.Core.Opt.DmdAnal.html#MkB"><span class="hs-identifier hs-var">MkB</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827419"><span class="hs-identifier hs-var">max_wkr_args</span></a></span><span> </span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827421"><span class="hs-identifier hs-var">remaining_budget</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Type, StrictnessMark, Demand)]
</span><a href="#local-6989586621681827423"><span class="hs-identifier hs-var">arg_triples</span></a></span><span>
</span><span id="line-1980"></span><span>
</span><span id="line-1981"></span><span>    </span><span class="annot"><a href="#local-6989586621681827423"><span class="hs-identifier hs-type">arg_triples</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1982"></span><span>    </span><span id="local-6989586621681827423"><span class="annot"><span class="annottext">arg_triples :: [(Type, StrictnessMark, Demand)]
</span><a href="#local-6989586621681827423"><span class="hs-identifier hs-var hs-var">arg_triples</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity
-&gt; [(Type, StrictnessMark, Demand)]
-&gt; [(Type, StrictnessMark, Demand)]
forall a. Arity -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#take/GHC.List.html#take"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827407"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">([(Type, StrictnessMark, Demand)]
 -&gt; [(Type, StrictnessMark, Demand)])
-&gt; [(Type, StrictnessMark, Demand)]
-&gt; [(Type, StrictnessMark, Demand)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1983"></span><span>                  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827425"><span class="hs-identifier hs-var">bndr_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-var">NotMarkedStrict</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type -&gt; Demand
</span><a href="#local-6989586621681827427"><span class="hs-identifier hs-var">get_dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827428"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827425"><span class="hs-identifier hs-var">bndr_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1984"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681827428"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827428"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827410"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-1985"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Core.html#isRuntimeVar"><span class="hs-identifier hs-var">isRuntimeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827428"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681827425"><span class="annot"><span class="annottext">bndr_ty :: Type
</span><a href="#local-6989586621681827425"><span class="hs-identifier hs-var hs-var">bndr_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827428"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1986"></span><span>
</span><span id="line-1987"></span><span>    </span><span class="annot"><a href="#local-6989586621681827427"><span class="hs-identifier hs-type">get_dmd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-1988"></span><span>    </span><span id="local-6989586621681827427"><span class="annot"><span class="annottext">get_dmd :: Id -&gt; Type -&gt; Demand
</span><a href="#local-6989586621681827427"><span class="hs-identifier hs-var hs-var">get_dmd</span></a></span></span><span> </span><span id="local-6989586621681827430"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827430"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681827431"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827431"><span class="hs-identifier hs-var">bndr_ty</span></a></span></span><span>
</span><span id="line-1989"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Predicate.html#isClassPred"><span class="hs-identifier hs-var">isClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827431"><span class="hs-identifier hs-var">bndr_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#trimBoxity"><span class="hs-identifier hs-var">trimBoxity</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827433"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-1990"></span><span>        </span><span class="hs-comment">-- See Note [Do not unbox class dictionaries]</span><span>
</span><span id="line-1991"></span><span>        </span><span class="hs-comment">-- NB: 'ty' has not been normalised, so this will (rightly)</span><span>
</span><span id="line-1992"></span><span>        </span><span class="hs-comment">--     catch newtype dictionaries too.</span><span>
</span><span id="line-1993"></span><span>        </span><span class="hs-comment">-- NB: even for bottoming functions, don't unbox dictionaries</span><span>
</span><span id="line-1994"></span><span>
</span><span id="line-1995"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681827434"><span class="hs-identifier hs-var">is_bot_fn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#unboxDeeplyDmd"><span class="hs-identifier hs-var">unboxDeeplyDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827433"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-1996"></span><span>        </span><span class="hs-comment">-- See Note [Boxity for bottoming functions], case (B)</span><span>
</span><span id="line-1997"></span><span>
</span><span id="line-1998"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681827436"><span class="hs-identifier hs-var">is_opaque</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#trimBoxity"><span class="hs-identifier hs-var">trimBoxity</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827433"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-1999"></span><span>        </span><span class="hs-comment">-- See Note [OPAQUE pragma]</span><span>
</span><span id="line-2000"></span><span>        </span><span class="hs-comment">-- See Note [The OPAQUE pragma and avoiding the reboxing of arguments]</span><span>
</span><span id="line-2001"></span><span>
</span><span id="line-2002"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827433"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-2003"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2004"></span><span>        </span><span id="local-6989586621681827433"><span class="annot"><span class="annottext">dmd :: Demand
</span><a href="#local-6989586621681827433"><span class="hs-identifier hs-var hs-var">dmd</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Demand
</span><a href="GHC.Types.Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827430"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-2005"></span><span>        </span><span id="local-6989586621681827436"><span class="annot"><span class="annottext">is_opaque :: Bool
</span><a href="#local-6989586621681827436"><span class="hs-identifier hs-var hs-var">is_opaque</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InlinePragma -&gt; Bool
</span><a href="GHC.Types.Basic.html#isOpaquePragma"><span class="hs-identifier hs-var">isOpaquePragma</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; InlinePragma
</span><a href="GHC.Types.Id.html#idInlinePragma"><span class="hs-identifier hs-var">idInlinePragma</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827406"><span class="hs-identifier hs-var">fn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2006"></span><span>
</span><span id="line-2007"></span><span>    </span><span class="hs-comment">-- is_bot_fn:  see Note [Boxity for bottoming functions]</span><span>
</span><span id="line-2008"></span><span>    </span><span id="local-6989586621681827434"><span class="annot"><span class="annottext">is_bot_fn :: Bool
</span><a href="#local-6989586621681827434"><span class="hs-identifier hs-var hs-var">is_bot_fn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681827409"><span class="hs-identifier hs-var">div</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence -&gt; Divergence -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="GHC.Types.Demand.html#botDiv"><span class="hs-identifier hs-var">botDiv</span></a></span><span>
</span><span id="line-2009"></span><span>
</span><span id="line-2010"></span><span>    </span><span class="annot"><a href="#local-6989586621681827422"><span class="hs-identifier hs-type">go_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#Budgets"><span class="hs-identifier hs-type">Budgets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#Budgets"><span class="hs-identifier hs-type">Budgets</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2011"></span><span>    </span><span id="local-6989586621681827422"><span class="annot"><span class="annottext">go_args :: Budgets -&gt; [(Type, StrictnessMark, Demand)] -&gt; (Budgets, [Demand])
</span><a href="#local-6989586621681827422"><span class="hs-identifier hs-var hs-var">go_args</span></a></span></span><span> </span><span id="local-6989586621681827440"><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827440"><span class="hs-identifier hs-var">bg</span></a></span></span><span> </span><span id="local-6989586621681827441"><span class="annot"><span class="annottext">[(Type, StrictnessMark, Demand)]
</span><a href="#local-6989586621681827441"><span class="hs-identifier hs-var">triples</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Budgets -&gt; (Type, StrictnessMark, Demand) -&gt; (Budgets, Demand))
-&gt; Budgets
-&gt; [(Type, StrictnessMark, Demand)]
-&gt; (Budgets, [Demand])
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapAccumL/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a></span><span> </span><span class="annot"><span class="annottext">Budgets -&gt; (Type, StrictnessMark, Demand) -&gt; (Budgets, Demand)
</span><a href="#local-6989586621681827442"><span class="hs-identifier hs-var">go_arg</span></a></span><span> </span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827440"><span class="hs-identifier hs-var">bg</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, StrictnessMark, Demand)]
</span><a href="#local-6989586621681827441"><span class="hs-identifier hs-var">triples</span></a></span><span>
</span><span id="line-2012"></span><span>
</span><span id="line-2013"></span><span>    </span><span class="annot"><a href="#local-6989586621681827442"><span class="hs-identifier hs-type">go_arg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#Budgets"><span class="hs-identifier hs-type">Budgets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#Budgets"><span class="hs-identifier hs-type">Budgets</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2014"></span><span>    </span><span id="local-6989586621681827442"><span class="annot"><span class="annottext">go_arg :: Budgets -&gt; (Type, StrictnessMark, Demand) -&gt; (Budgets, Demand)
</span><a href="#local-6989586621681827442"><span class="hs-identifier hs-var hs-var">go_arg</span></a></span></span><span> </span><span id="local-6989586621681827443"><span class="annot"><span class="annottext">bg :: Budgets
</span><a href="#local-6989586621681827443"><span class="hs-identifier hs-var">bg</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#MkB"><span class="hs-identifier hs-type">MkB</span></a></span><span> </span><span id="local-6989586621681827444"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827444"><span class="hs-identifier hs-var">bg_top</span></a></span></span><span> </span><span id="local-6989586621681827445"><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827445"><span class="hs-identifier hs-var">bg_inner</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827446"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827446"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827447"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621681827447"><span class="hs-identifier hs-var">str_mark</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827448"><span class="annot"><span class="annottext">dmd :: Demand
</span><a href="#local-6989586621681827448"><span class="hs-identifier hs-var">dmd</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621681827449"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827449"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-type">:*</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2015"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnalEnv
-&gt; Type
-&gt; StrictnessMark
-&gt; Demand
-&gt; UnboxingDecision [(Type, StrictnessMark, Demand)]
</span><a href="GHC.Core.Opt.DmdAnal.html#wantToUnboxArg"><span class="hs-identifier hs-var">wantToUnboxArg</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827405"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827446"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621681827447"><span class="hs-identifier hs-var">str_mark</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827448"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2016"></span><span>          </span><span class="annot"><span class="annottext">UnboxingDecision [(Type, StrictnessMark, Demand)]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DropAbsent"><span class="hs-identifier hs-var">DropAbsent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827443"><span class="hs-identifier hs-var">bg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827448"><span class="hs-identifier hs-var">dmd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2017"></span><span>
</span><span id="line-2018"></span><span>          </span><span class="annot"><span class="annottext">UnboxingDecision [(Type, StrictnessMark, Demand)]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DontUnbox"><span class="hs-identifier hs-var">DontUnbox</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681827434"><span class="hs-identifier hs-var">is_bot_fn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isTyVarTy"><span class="hs-identifier hs-var">isTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827446"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827454"><span class="hs-identifier hs-var">retain_budget</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827448"><span class="hs-identifier hs-var">dmd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2019"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827454"><span class="hs-identifier hs-var">retain_budget</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#trimBoxity"><span class="hs-identifier hs-var">trimBoxity</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827448"><span class="hs-identifier hs-var">dmd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2020"></span><span>            </span><span class="hs-comment">-- If bot: Keep deep boxity even though WW won't unbox</span><span>
</span><span id="line-2021"></span><span>            </span><span class="hs-comment">-- See Note [Boxity for bottoming functions] case (A)</span><span>
</span><span id="line-2022"></span><span>            </span><span class="hs-comment">-- trimBoxity: see Note [No lazy, Unboxed demands in demand signature]</span><span>
</span><span id="line-2023"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-2024"></span><span>              </span><span id="local-6989586621681827454"><span class="annot"><span class="annottext">retain_budget :: Budgets
</span><a href="#local-6989586621681827454"><span class="hs-identifier hs-var hs-var">retain_budget</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Budgets -&gt; Budgets
</span><a href="GHC.Core.Opt.DmdAnal.html#spendTopBudget"><span class="hs-identifier hs-var">spendTopBudget</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Arity
</span><a href="GHC.Core.Opt.DmdAnal.html#unariseArity"><span class="hs-identifier hs-var">unariseArity</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827446"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827443"><span class="hs-identifier hs-var">bg</span></a></span><span>
</span><span id="line-2025"></span><span>                </span><span class="hs-comment">-- spendTopBudget: spend from our budget the cost of the</span><span>
</span><span id="line-2026"></span><span>                </span><span class="hs-comment">-- retaining the arg</span><span>
</span><span id="line-2027"></span><span>                </span><span class="hs-comment">-- The unboxed case does happen here, for example</span><span>
</span><span id="line-2028"></span><span>                </span><span class="hs-comment">--   app g x = g x :: (# Int, Int #)</span><span>
</span><span id="line-2029"></span><span>                </span><span class="hs-comment">-- here, `x` is used `L`azy and thus Boxed</span><span>
</span><span id="line-2030"></span><span>
</span><span id="line-2031"></span><span>          </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DoUnbox"><span class="hs-identifier hs-type">DoUnbox</span></a></span><span> </span><span id="local-6989586621681827456"><span class="annot"><span class="annottext">[(Type, StrictnessMark, Demand)]
</span><a href="#local-6989586621681827456"><span class="hs-identifier hs-var">triples</span></a></span></span><span>
</span><span id="line-2032"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnboxedTupleType"><span class="hs-identifier hs-var">isUnboxedTupleType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827446"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2033"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827458"><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827458"><span class="hs-identifier hs-var">bg'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827459"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827459"><span class="hs-identifier hs-var">dmds'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Budgets -&gt; [(Type, StrictnessMark, Demand)] -&gt; (Budgets, [Demand])
</span><a href="#local-6989586621681827422"><span class="hs-identifier hs-var">go_args</span></a></span><span> </span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827443"><span class="hs-identifier hs-var">bg</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, StrictnessMark, Demand)]
</span><a href="#local-6989586621681827456"><span class="hs-identifier hs-var">triples</span></a></span><span>
</span><span id="line-2034"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827458"><span class="hs-identifier hs-var">bg'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827449"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Card -&gt; SubDemand -&gt; Demand
Card -&gt; SubDemand -&gt; Demand
</span><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-var">:*</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Boxity -&gt; [Demand] -&gt; SubDemand
</span><a href="GHC.Types.Demand.html#mkProd"><span class="hs-identifier hs-var">mkProd</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span> </span><span class="annot"><span class="annottext">([Demand] -&gt; SubDemand) -&gt; [Demand] -&gt; SubDemand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24%21/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827459"><span class="hs-identifier hs-var">dmds'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2035"></span><span>                     </span><span class="hs-comment">-- See Note [Worker argument budget]</span><span>
</span><span id="line-2036"></span><span>                     </span><span class="hs-comment">-- unboxed tuples are always unboxed, deeply</span><span>
</span><span id="line-2037"></span><span>                     </span><span class="hs-comment">-- NB: Recurse with bg, *not* bg_inner! The unboxed fields</span><span>
</span><span id="line-2038"></span><span>                     </span><span class="hs-comment">-- are at the same budget layer.</span><span>
</span><span id="line-2039"></span><span>
</span><span id="line-2040"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnboxedSumType"><span class="hs-identifier hs-var">isUnboxedSumType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827446"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-2041"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; (Budgets, Demand)
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unboxing through unboxed sum&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827406"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827446"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2042"></span><span>                     </span><span class="hs-comment">-- We currently don't return DoUnbox for unboxed sums.</span><span>
</span><span id="line-2043"></span><span>                     </span><span class="hs-comment">-- But hopefully we will at some point. When that happens,</span><span>
</span><span id="line-2044"></span><span>                     </span><span class="hs-comment">-- it would still be impossible to predict the effect</span><span>
</span><span id="line-2045"></span><span>                     </span><span class="hs-comment">-- of dropping absent fields and unboxing others on the</span><span>
</span><span id="line-2046"></span><span>                     </span><span class="hs-comment">-- unariseArity of the sum without losing sanity.</span><span>
</span><span id="line-2047"></span><span>                     </span><span class="hs-comment">-- We could overwrite bg_top with the one from</span><span>
</span><span id="line-2048"></span><span>                     </span><span class="hs-comment">-- retain_budget while still unboxing inside the alts as in</span><span>
</span><span id="line-2049"></span><span>                     </span><span class="hs-comment">-- the tuple case for a conservative solution, though.</span><span>
</span><span id="line-2050"></span><span>
</span><span id="line-2051"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2052"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity -&gt; Budgets -&gt; Budgets
</span><a href="GHC.Core.Opt.DmdAnal.html#spendTopBudget"><span class="hs-identifier hs-var">spendTopBudget</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity -&gt; Budgets -&gt; Budgets
</span><a href="GHC.Core.Opt.DmdAnal.html#MkB"><span class="hs-identifier hs-var">MkB</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827444"><span class="hs-identifier hs-var">bg_top</span></a></span><span> </span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827464"><span class="hs-identifier hs-var">final_bg_inner</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827465"><span class="hs-identifier hs-var">final_dmd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2053"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-2054"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621681827466"><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827466"><span class="hs-identifier hs-var">bg_inner'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827467"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827467"><span class="hs-identifier hs-var">dmds'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Budgets -&gt; [(Type, StrictnessMark, Demand)] -&gt; (Budgets, [Demand])
</span><a href="#local-6989586621681827422"><span class="hs-identifier hs-var">go_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Budgets -&gt; Budgets
</span><a href="GHC.Core.Opt.DmdAnal.html#earnTopBudget"><span class="hs-identifier hs-var">earnTopBudget</span></a></span><span> </span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827445"><span class="hs-identifier hs-var">bg_inner</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Type, StrictnessMark, Demand)]
</span><a href="#local-6989586621681827456"><span class="hs-identifier hs-var">triples</span></a></span><span>
</span><span id="line-2055"></span><span>                     </span><span class="hs-comment">-- earnTopBudget: give back the cost of retaining the</span><span>
</span><span id="line-2056"></span><span>                     </span><span class="hs-comment">-- arg we are insted unboxing.</span><span>
</span><span id="line-2057"></span><span>              </span><span id="local-6989586621681827468"><span class="annot"><span class="annottext">dmd' :: Demand
</span><a href="#local-6989586621681827468"><span class="hs-identifier hs-var hs-var">dmd'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827449"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Card -&gt; SubDemand -&gt; Demand
Card -&gt; SubDemand -&gt; Demand
</span><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-var">:*</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Boxity -&gt; [Demand] -&gt; SubDemand
</span><a href="GHC.Types.Demand.html#mkProd"><span class="hs-identifier hs-var">mkProd</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span> </span><span class="annot"><span class="annottext">([Demand] -&gt; SubDemand) -&gt; [Demand] -&gt; SubDemand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24%21/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827467"><span class="hs-identifier hs-var">dmds'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2058"></span><span>              </span><span class="hs-glyph">~</span><span class="hs-special">(</span><span id="local-6989586621681827464"><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827464"><span class="hs-identifier hs-var">final_bg_inner</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827465"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827465"><span class="hs-identifier hs-var">final_dmd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- &quot;~&quot;: This match *must* be lazy!</span><span>
</span><span id="line-2059"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Budgets -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#positiveTopBudget"><span class="hs-identifier hs-var">positiveTopBudget</span></a></span><span> </span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827466"><span class="hs-identifier hs-var">bg_inner'</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827466"><span class="hs-identifier hs-var">bg_inner'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827468"><span class="hs-identifier hs-var">dmd'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2060"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Budgets
</span><a href="#local-6989586621681827445"><span class="hs-identifier hs-var">bg_inner</span></a></span><span class="hs-special">,</span><span>  </span><span class="annot"><span class="annottext">Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#trimBoxity"><span class="hs-identifier hs-var">trimBoxity</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827448"><span class="hs-identifier hs-var">dmd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2061"></span><span>
</span><span id="line-2062"></span><span>    </span><span class="annot"><a href="#local-6989586621681827412"><span class="hs-identifier hs-type">add_demands</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-2063"></span><span>    </span><span class="hs-comment">-- Attach the demands to the outer lambdas of this expression</span><span>
</span><span id="line-2064"></span><span>    </span><span id="local-6989586621681827412"><span class="annot"><span class="annottext">add_demands :: [Demand] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681827412"><span class="hs-identifier hs-var hs-var">add_demands</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621681827469"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827469"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827469"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-2065"></span><span>    </span><span class="annot"><a href="#local-6989586621681827412"><span class="hs-identifier hs-var">add_demands</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827470"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827470"><span class="hs-identifier hs-var">dmd</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681827471"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827471"><span class="hs-identifier hs-var">dmds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681827472"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827472"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621681827473"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827473"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2066"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827472"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827472"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681827412"><span class="hs-identifier hs-var">add_demands</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827470"><span class="hs-identifier hs-var">dmd</span></a></span><span class="annot"><span class="annottext">Demand -&gt; [Demand] -&gt; [Demand]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827471"><span class="hs-identifier hs-var">dmds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827473"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2067"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; CoreExpr -&gt; CoreExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827472"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Demand -&gt; Id
</span><a href="GHC.Types.Id.html#setIdDemandInfo"><span class="hs-operator hs-var">`setIdDemandInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827470"><span class="hs-identifier hs-var">dmd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681827412"><span class="hs-identifier hs-var">add_demands</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827471"><span class="hs-identifier hs-var">dmds</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827473"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2068"></span><span>    </span><span class="annot"><a href="#local-6989586621681827412"><span class="hs-identifier hs-var">add_demands</span></a></span><span> </span><span id="local-6989586621681827474"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827474"><span class="hs-identifier hs-var">dmds</span></a></span></span><span> </span><span id="local-6989586621681827475"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827475"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; CoreExpr
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;add_demands&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827474"><span class="hs-identifier hs-var">dmds</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827475"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2069"></span><span>
</span><span id="line-2070"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#finaliseLetBoxity"><span class="hs-identifier hs-type">finaliseLetBoxity</span></a></span><span>
</span><span id="line-2071"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-2072"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>                   </span><span class="annot"><span class="hs-comment">-- ^ Type of the let-bound Id</span></span><span>
</span><span id="line-2073"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>                 </span><span class="annot"><span class="hs-comment">-- ^ How the Id is used</span></span><span>
</span><span id="line-2074"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-2075"></span><span class="hs-comment">-- See Note [Finalising boxity for let-bound Ids]</span><span>
</span><span id="line-2076"></span><span class="hs-comment">-- This function is like finaliseArgBoxities, but much simpler because</span><span>
</span><span id="line-2077"></span><span class="hs-comment">-- it has no &quot;budget&quot;.  It simply unboxes strict demands, and stops</span><span>
</span><span id="line-2078"></span><span class="hs-comment">-- when it reaches a lazy one.</span><span>
</span><span id="line-2079"></span><span id="finaliseLetBoxity"><span class="annot"><span class="annottext">finaliseLetBoxity :: AnalEnv -&gt; Type -&gt; Demand -&gt; Demand
</span><a href="GHC.Core.Opt.DmdAnal.html#finaliseLetBoxity"><span class="hs-identifier hs-var hs-var">finaliseLetBoxity</span></a></span></span><span> </span><span id="local-6989586621681827477"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827477"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827478"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827478"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681827479"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827479"><span class="hs-identifier hs-var">dmd</span></a></span></span><span>
</span><span id="line-2080"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type, StrictnessMark, Demand) -&gt; Demand
</span><a href="#local-6989586621681827480"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827478"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-var">NotMarkedStrict</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827479"><span class="hs-identifier hs-var">dmd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2081"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2082"></span><span>    </span><span class="annot"><a href="#local-6989586621681827480"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-2083"></span><span>    </span><span id="local-6989586621681827480"><span class="annot"><span class="annottext">go :: (Type, StrictnessMark, Demand) -&gt; Demand
</span><a href="#local-6989586621681827480"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827481"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827481"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827482"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621681827482"><span class="hs-identifier hs-var">str</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827483"><span class="annot"><span class="annottext">dmd :: Demand
</span><a href="#local-6989586621681827483"><span class="hs-identifier hs-var">dmd</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621681827484"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827484"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-type">:*</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2084"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnalEnv
-&gt; Type
-&gt; StrictnessMark
-&gt; Demand
-&gt; UnboxingDecision [(Type, StrictnessMark, Demand)]
</span><a href="GHC.Core.Opt.DmdAnal.html#wantToUnboxArg"><span class="hs-identifier hs-var">wantToUnboxArg</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827477"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827481"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621681827482"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827483"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2085"></span><span>        </span><span class="annot"><span class="annottext">UnboxingDecision [(Type, StrictnessMark, Demand)]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DropAbsent"><span class="hs-identifier hs-var">DropAbsent</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827483"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-2086"></span><span>        </span><span class="annot"><span class="annottext">UnboxingDecision [(Type, StrictnessMark, Demand)]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DontUnbox"><span class="hs-identifier hs-var">DontUnbox</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#trimBoxity"><span class="hs-identifier hs-var">trimBoxity</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827483"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-2087"></span><span>        </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DoUnbox"><span class="hs-identifier hs-type">DoUnbox</span></a></span><span> </span><span id="local-6989586621681827485"><span class="annot"><span class="annottext">[(Type, StrictnessMark, Demand)]
</span><a href="#local-6989586621681827485"><span class="hs-identifier hs-var">triples</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827484"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Card -&gt; SubDemand -&gt; Demand
Card -&gt; SubDemand -&gt; Demand
</span><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-var">:*</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Boxity -&gt; [Demand] -&gt; SubDemand
</span><a href="GHC.Types.Demand.html#mkProd"><span class="hs-identifier hs-var">mkProd</span></a></span><span> </span><span class="annot"><span class="annottext">Boxity
</span><a href="Language.Haskell.Syntax.Basic.html#Unboxed"><span class="hs-identifier hs-var">Unboxed</span></a></span><span> </span><span class="annot"><span class="annottext">([Demand] -&gt; SubDemand) -&gt; [Demand] -&gt; SubDemand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24%21/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">((Type, StrictnessMark, Demand) -&gt; Demand)
-&gt; [(Type, StrictnessMark, Demand)] -&gt; [Demand]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Type, StrictnessMark, Demand) -&gt; Demand
</span><a href="#local-6989586621681827480"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, StrictnessMark, Demand)]
</span><a href="#local-6989586621681827485"><span class="hs-identifier hs-var">triples</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2088"></span><span>
</span><span id="line-2089"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#wantToUnboxArg"><span class="hs-identifier hs-type">wantToUnboxArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-2090"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#UnboxingDecision"><span class="hs-identifier hs-type">UnboxingDecision</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#StrictnessMark"><span class="hs-identifier hs-type">StrictnessMark</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-2091"></span><span id="wantToUnboxArg"><span class="annot"><span class="annottext">wantToUnboxArg :: AnalEnv
-&gt; Type
-&gt; StrictnessMark
-&gt; Demand
-&gt; UnboxingDecision [(Type, StrictnessMark, Demand)]
</span><a href="GHC.Core.Opt.DmdAnal.html#wantToUnboxArg"><span class="hs-identifier hs-var hs-var">wantToUnboxArg</span></a></span></span><span> </span><span id="local-6989586621681827486"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827486"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827487"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827487"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681827488"><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621681827488"><span class="hs-identifier hs-var">str_mark</span></a></span></span><span> </span><span id="local-6989586621681827489"><span class="annot"><span class="annottext">dmd :: Demand
</span><a href="#local-6989586621681827489"><span class="hs-identifier hs-var">dmd</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621681827490"><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827490"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#%3A%2A"><span class="hs-operator hs-type">:*</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-2092"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
-&gt; Type -&gt; Demand -&gt; UnboxingDecision (DataConPatContext Demand)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#canUnboxArg"><span class="hs-identifier hs-var">canUnboxArg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; FamInstEnvs
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_fam_envs"><span class="hs-identifier hs-var">ae_fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827486"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827487"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827489"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-2093"></span><span>      </span><span class="annot"><span class="annottext">UnboxingDecision (DataConPatContext Demand)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DropAbsent"><span class="hs-identifier hs-var">DropAbsent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnboxingDecision [(Type, StrictnessMark, Demand)]
forall unboxing_info. UnboxingDecision unboxing_info
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DropAbsent"><span class="hs-identifier hs-var">DropAbsent</span></a></span><span>
</span><span id="line-2094"></span><span>      </span><span class="annot"><span class="annottext">UnboxingDecision (DataConPatContext Demand)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DontUnbox"><span class="hs-identifier hs-var">DontUnbox</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnboxingDecision [(Type, StrictnessMark, Demand)]
forall unboxing_info. UnboxingDecision unboxing_info
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DontUnbox"><span class="hs-identifier hs-var">DontUnbox</span></a></span><span>
</span><span id="line-2095"></span><span>
</span><span id="line-2096"></span><span>      </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DoUnbox"><span class="hs-identifier hs-type">DoUnbox</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#DataConPatContext"><span class="hs-identifier hs-type">DataConPatContext</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">dcpc_dc :: forall s. DataConPatContext s -&gt; DataCon
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_dc"><span class="hs-identifier hs-var">dcpc_dc</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681827494"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827494"><span class="hs-identifier hs-var">dc</span></a></span></span><span>
</span><span id="line-2097"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_tc_args :: forall s. DataConPatContext s -&gt; [Type]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_tc_args"><span class="hs-identifier hs-var">dcpc_tc_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681827496"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681827496"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span>
</span><span id="line-2098"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dcpc_args :: forall s. DataConPatContext s -&gt; [s]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dcpc_args"><span class="hs-identifier hs-var">dcpc_args</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681827498"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827498"><span class="hs-identifier hs-var">dmds</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-2099"></span><span>       </span><span class="hs-comment">-- OK, so we /can/ unbox it; but do we /want/ to?</span><span>
</span><span id="line-2100"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Card -&gt; Bool
</span><a href="GHC.Types.Demand.html#isStrict"><span class="hs-identifier hs-var">isStrict</span></a></span><span> </span><span class="annot"><span class="annottext">Card
</span><a href="#local-6989586621681827490"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">StrictnessMark -&gt; Bool
</span><a href="GHC.Core.DataCon.html#isMarkedStrict"><span class="hs-identifier hs-var">isMarkedStrict</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="#local-6989586621681827488"><span class="hs-identifier hs-var">str_mark</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Don't unbox a lazy field</span><span>
</span><span id="line-2101"></span><span>         </span><span class="hs-comment">-- isMarkedStrict: see Note [Unboxing evaluated arguments] in DmdAnal</span><span>
</span><span id="line-2102"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnboxingDecision [(Type, StrictnessMark, Demand)]
forall unboxing_info. UnboxingDecision unboxing_info
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DontUnbox"><span class="hs-identifier hs-var">DontUnbox</span></a></span><span>
</span><span id="line-2103"></span><span>
</span><span id="line-2104"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DefinitelyRecursive"><span class="hs-identifier hs-var">DefinitelyRecursive</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DataCon -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_rec_dc"><span class="hs-identifier hs-var">ae_rec_dc</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827486"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827494"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-2105"></span><span>         </span><span class="hs-comment">-- See Note [Which types are unboxed?]</span><span>
</span><span id="line-2106"></span><span>         </span><span class="hs-comment">-- and Note [Demand analysis for recursive data constructors]</span><span>
</span><span id="line-2107"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnboxingDecision [(Type, StrictnessMark, Demand)]
forall unboxing_info. UnboxingDecision unboxing_info
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DontUnbox"><span class="hs-identifier hs-var">DontUnbox</span></a></span><span>
</span><span id="line-2108"></span><span>
</span><span id="line-2109"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>  </span><span class="hs-comment">-- Bad cases dealt with: we want to unbox!</span><span>
</span><span id="line-2110"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(Type, StrictnessMark, Demand)]
-&gt; UnboxingDecision [(Type, StrictnessMark, Demand)]
forall unboxing_info.
unboxing_info -&gt; UnboxingDecision unboxing_info
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#DoUnbox"><span class="hs-identifier hs-var">DoUnbox</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
-&gt; [StrictnessMark] -&gt; [Demand] -&gt; [(Type, StrictnessMark, Demand)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#zip3/GHC.List.html#zip3"><span class="hs-identifier hs-var">zip3</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [Type] -&gt; [Type]
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#dubiousDataConInstArgTys"><span class="hs-identifier hs-var">dubiousDataConInstArgTys</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827494"><span class="hs-identifier hs-var">dc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681827496"><span class="hs-identifier hs-var">tc_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2111"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [StrictnessMark]
</span><a href="GHC.Core.DataCon.html#dataConRepStrictness"><span class="hs-identifier hs-var">dataConRepStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681827494"><span class="hs-identifier hs-var">dc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2112"></span><span>                        </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827498"><span class="hs-identifier hs-var">dmds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2113"></span><span>
</span><span id="line-2114"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                      Fixpoints
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-2119"></span><span>
</span><span id="line-2120"></span><span class="hs-comment">-- Recursive bindings</span><span>
</span><span id="line-2121"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmdFix"><span class="hs-identifier hs-type">dmdFix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span>
</span><span id="line-2122"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>                            </span><span class="hs-comment">-- Does not include bindings for this binding</span><span>
</span><span id="line-2123"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#SubDemand"><span class="hs-identifier hs-type">SubDemand</span></a></span><span>
</span><span id="line-2124"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-2125"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WeakDmds"><span class="hs-identifier hs-type">WeakDmds</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Binders annotated with strictness info</span><span>
</span><span id="line-2126"></span><span id="dmdFix"><span class="annot"><span class="annottext">dmdFix :: TopLevelFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; [(Id, CoreExpr)]
-&gt; (AnalEnv, WeakDmds, [(Id, CoreExpr)])
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdFix"><span class="hs-identifier hs-var hs-var">dmdFix</span></a></span></span><span> </span><span id="local-6989586621681827503"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827503"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681827504"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827504"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827505"><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827505"><span class="hs-identifier hs-var">let_dmd</span></a></span></span><span> </span><span id="local-6989586621681827506"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827506"><span class="hs-identifier hs-var">orig_pairs</span></a></span></span><span>
</span><span id="line-2127"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; [(Id, CoreExpr)] -&gt; (AnalEnv, WeakDmds, [(Id, CoreExpr)])
</span><a href="#local-6989586621681827507"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827508"><span class="hs-identifier hs-var">initial_pairs</span></a></span><span>
</span><span id="line-2128"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2129"></span><span>    </span><span id="local-6989586621681827509"><span class="annot"><span class="annottext">opts :: DmdAnalOpts
</span><a href="#local-6989586621681827509"><span class="hs-identifier hs-var hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdAnalOpts
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_opts"><span class="hs-identifier hs-var">ae_opts</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827504"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2130"></span><span>    </span><span class="hs-comment">-- See Note [Initialising strictness]</span><span>
</span><span id="line-2131"></span><span>    </span><span id="local-6989586621681827508"><span class="annot"><span class="annottext">initial_pairs :: [(Id, CoreExpr)]
</span><a href="#local-6989586621681827508"><span class="hs-identifier hs-var hs-var">initial_pairs</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_virgin"><span class="hs-identifier hs-var">ae_virgin</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827504"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdAnalOpts -&gt; Id -&gt; DmdSig -&gt; Id
</span><a href="GHC.Core.Opt.DmdAnal.html#setIdDmdAndBoxSig"><span class="hs-identifier hs-var">setIdDmdAndBoxSig</span></a></span><span> </span><span class="annot"><span class="annottext">DmdAnalOpts
</span><a href="#local-6989586621681827509"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827511"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">DmdSig
</span><a href="GHC.Types.Demand.html#botSig"><span class="hs-identifier hs-var">botSig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827513"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827511"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827511"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827513"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827513"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827506"><span class="hs-identifier hs-var">orig_pairs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2132"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827506"><span class="hs-identifier hs-var">orig_pairs</span></a></span><span>
</span><span id="line-2133"></span><span>
</span><span id="line-2134"></span><span>    </span><span class="hs-comment">-- If fixed-point iteration does not yield a result we use this instead</span><span>
</span><span id="line-2135"></span><span>    </span><span class="hs-comment">-- See Note [Safe abortion in the fixed-point iteration]</span><span>
</span><span id="line-2136"></span><span>    </span><span class="annot"><a href="#local-6989586621681827514"><span class="hs-identifier hs-type">abort</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WeakDmds"><span class="hs-identifier hs-type">WeakDmds</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2137"></span><span>    </span><span id="local-6989586621681827514"><span class="annot"><span class="annottext">abort :: (AnalEnv, WeakDmds, [(Id, CoreExpr)])
</span><a href="#local-6989586621681827514"><span class="hs-identifier hs-var hs-var">abort</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827504"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827515"><span class="hs-identifier hs-var">weak_fv'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827516"><span class="hs-identifier hs-var">zapped_pairs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2138"></span><span>      </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827517"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827517"><span class="hs-identifier hs-var">weak_fv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827518"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827518"><span class="hs-identifier hs-var">pairs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [(Id, CoreExpr)] -&gt; (WeakDmds, [(Id, CoreExpr)])
</span><a href="#local-6989586621681827519"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; [(Id, CoreExpr)]
</span><a href="#local-6989586621681827520"><span class="hs-identifier hs-var">zapIdDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827506"><span class="hs-identifier hs-var">orig_pairs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2139"></span><span>            </span><span class="hs-comment">-- Note [Lazy and unleashable free variables]</span><span>
</span><span id="line-2140"></span><span>            </span><span id="local-6989586621681827521"><span class="annot"><span class="annottext">weak_fvs :: WeakDmds
</span><a href="#local-6989586621681827521"><span class="hs-identifier hs-var hs-var">weak_fvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[WeakDmds] -&gt; WeakDmds
forall a. [VarEnv a] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#plusVarEnvList"><span class="hs-identifier hs-var">plusVarEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">([WeakDmds] -&gt; WeakDmds) -&gt; [WeakDmds] -&gt; WeakDmds
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; WeakDmds) -&gt; [(Id, CoreExpr)] -&gt; [WeakDmds]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdEnv -&gt; WeakDmds
</span><a href="GHC.Types.Demand.html#de_fvs"><span class="hs-identifier hs-var">de_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">(DmdEnv -&gt; WeakDmds)
-&gt; ((Id, CoreExpr) -&gt; DmdEnv) -&gt; (Id, CoreExpr) -&gt; WeakDmds
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#dmdSigDmdEnv"><span class="hs-identifier hs-var">dmdSigDmdEnv</span></a></span><span> </span><span class="annot"><span class="annottext">(DmdSig -&gt; DmdEnv)
-&gt; ((Id, CoreExpr) -&gt; DmdSig) -&gt; (Id, CoreExpr) -&gt; DmdEnv
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; DmdSig)
-&gt; ((Id, CoreExpr) -&gt; Id) -&gt; (Id, CoreExpr) -&gt; DmdSig
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827518"><span class="hs-identifier hs-var">pairs'</span></a></span><span>
</span><span id="line-2141"></span><span>            </span><span id="local-6989586621681827515"><span class="annot"><span class="annottext">weak_fv' :: WeakDmds
</span><a href="#local-6989586621681827515"><span class="hs-identifier hs-var hs-var">weak_fv'</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Demand -&gt; Demand -&gt; Demand) -&gt; WeakDmds -&gt; WeakDmds -&gt; WeakDmds
forall a. (a -&gt; a -&gt; a) -&gt; VarEnv a -&gt; VarEnv a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#plusVarEnv_C"><span class="hs-identifier hs-var">plusVarEnv_C</span></a></span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#plusDmd"><span class="hs-identifier hs-var">plusDmd</span></a></span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827517"><span class="hs-identifier hs-var">weak_fv</span></a></span><span> </span><span class="annot"><span class="annottext">(WeakDmds -&gt; WeakDmds) -&gt; WeakDmds -&gt; WeakDmds
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Demand -&gt; Demand) -&gt; WeakDmds -&gt; WeakDmds
forall a b. (a -&gt; b) -&gt; VarEnv a -&gt; VarEnv b
</span><a href="GHC.Types.Var.Env.html#mapVarEnv"><span class="hs-identifier hs-var">mapVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand -&gt; Demand -&gt; Demand
forall a b. a -&gt; b -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#const/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827521"><span class="hs-identifier hs-var">weak_fvs</span></a></span><span>
</span><span id="line-2142"></span><span>            </span><span id="local-6989586621681827516"><span class="annot"><span class="annottext">zapped_pairs :: [(Id, CoreExpr)]
</span><a href="#local-6989586621681827516"><span class="hs-identifier hs-var hs-var">zapped_pairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)] -&gt; [(Id, CoreExpr)]
</span><a href="#local-6989586621681827520"><span class="hs-identifier hs-var">zapIdDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827518"><span class="hs-identifier hs-var">pairs'</span></a></span><span>
</span><span id="line-2143"></span><span>
</span><span id="line-2144"></span><span>    </span><span class="hs-comment">-- The fixed-point varies the idDmdSig field of the binders, and terminates if that</span><span>
</span><span id="line-2145"></span><span>    </span><span class="hs-comment">-- annotation does not change any more.</span><span>
</span><span id="line-2146"></span><span>    </span><span class="annot"><a href="#local-6989586621681827507"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WeakDmds"><span class="hs-identifier hs-type">WeakDmds</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2147"></span><span>    </span><span id="local-6989586621681827507"><span class="annot"><span class="annottext">loop :: Arity -&gt; [(Id, CoreExpr)] -&gt; (AnalEnv, WeakDmds, [(Id, CoreExpr)])
</span><a href="#local-6989586621681827507"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621681827529"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827529"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681827530"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827530"><span class="hs-identifier hs-var">pairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dmdFix&quot; (ppr n &lt;+&gt; vcat [ ppr id &lt;+&gt; ppr (idDmdSig id)</span><span>
</span><span id="line-2148"></span><span>                   </span><span class="hs-comment">--                                   | (id,_) &lt;- pairs]) $</span><span>
</span><span id="line-2149"></span><span>                   </span><span class="annot"><span class="annottext">Arity -&gt; [(Id, CoreExpr)] -&gt; (AnalEnv, WeakDmds, [(Id, CoreExpr)])
</span><a href="#local-6989586621681827531"><span class="hs-identifier hs-var">loop'</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827529"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827530"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-2150"></span><span>
</span><span id="line-2151"></span><span>    </span><span id="local-6989586621681827531"><span class="annot"><span class="annottext">loop' :: Arity -&gt; [(Id, CoreExpr)] -&gt; (AnalEnv, WeakDmds, [(Id, CoreExpr)])
</span><a href="#local-6989586621681827531"><span class="hs-identifier hs-var hs-var">loop'</span></a></span></span><span> </span><span id="local-6989586621681827532"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827532"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681827533"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827533"><span class="hs-identifier hs-var">pairs</span></a></span></span><span>
</span><span id="line-2152"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681827534"><span class="hs-identifier hs-var">found_fixpoint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827535"><span class="hs-identifier hs-var">final_anal_env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827536"><span class="hs-identifier hs-var">weak_fv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827537"><span class="hs-identifier hs-var">pairs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2153"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827532"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">10</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AnalEnv, WeakDmds, [(Id, CoreExpr)])
</span><a href="#local-6989586621681827514"><span class="hs-identifier hs-var">abort</span></a></span><span>
</span><span id="line-2154"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; [(Id, CoreExpr)] -&gt; (AnalEnv, WeakDmds, [(Id, CoreExpr)])
</span><a href="#local-6989586621681827507"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827532"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Arity
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#%2B/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827537"><span class="hs-identifier hs-var">pairs'</span></a></span><span>
</span><span id="line-2155"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2156"></span><span>        </span><span id="local-6989586621681827534"><span class="annot"><span class="annottext">found_fixpoint :: Bool
</span><a href="#local-6989586621681827534"><span class="hs-identifier hs-var hs-var">found_fixpoint</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; DmdSig) -&gt; [(Id, CoreExpr)] -&gt; [DmdSig]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; DmdSig)
-&gt; ((Id, CoreExpr) -&gt; Id) -&gt; (Id, CoreExpr) -&gt; DmdSig
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827537"><span class="hs-identifier hs-var">pairs'</span></a></span><span> </span><span class="annot"><span class="annottext">[DmdSig] -&gt; [DmdSig] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; DmdSig) -&gt; [(Id, CoreExpr)] -&gt; [DmdSig]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; DmdSig)
-&gt; ((Id, CoreExpr) -&gt; Id) -&gt; (Id, CoreExpr) -&gt; DmdSig
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827533"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-2157"></span><span>        </span><span id="local-6989586621681827538"><span class="annot"><span class="annottext">first_round :: Bool
</span><a href="#local-6989586621681827538"><span class="hs-identifier hs-var hs-var">first_round</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681827532"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Arity
</span><span class="hs-number">1</span></span><span>
</span><span id="line-2158"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681827536"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827536"><span class="hs-identifier hs-var">weak_fv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827537"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827537"><span class="hs-identifier hs-var">pairs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [(Id, CoreExpr)] -&gt; (WeakDmds, [(Id, CoreExpr)])
</span><a href="#local-6989586621681827519"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681827538"><span class="hs-identifier hs-var">first_round</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827533"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-2159"></span><span>        </span><span id="local-6989586621681827535"><span class="annot"><span class="annottext">final_anal_env :: AnalEnv
</span><a href="#local-6989586621681827535"><span class="hs-identifier hs-var hs-var">final_anal_env</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; AnalEnv -&gt; [Id] -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#extendAnalEnvs"><span class="hs-identifier hs-var">extendAnalEnvs</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827503"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827504"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; Id) -&gt; [(Id, CoreExpr)] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827537"><span class="hs-identifier hs-var">pairs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2160"></span><span>
</span><span id="line-2161"></span><span>    </span><span class="annot"><a href="#local-6989586621681827519"><span class="hs-identifier hs-type">step</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WeakDmds"><span class="hs-identifier hs-type">WeakDmds</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2162"></span><span>    </span><span id="local-6989586621681827519"><span class="annot"><span class="annottext">step :: Bool -&gt; [(Id, CoreExpr)] -&gt; (WeakDmds, [(Id, CoreExpr)])
</span><a href="#local-6989586621681827519"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621681827540"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681827540"><span class="hs-identifier hs-var">first_round</span></a></span></span><span> </span><span id="local-6989586621681827541"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827541"><span class="hs-identifier hs-var">pairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827542"><span class="hs-identifier hs-var">weak_fv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827543"><span class="hs-identifier hs-var">pairs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2163"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-2164"></span><span>        </span><span class="hs-comment">-- In all but the first iteration, delete the virgin flag</span><span>
</span><span id="line-2165"></span><span>        </span><span id="local-6989586621681827544"><span class="annot"><span class="annottext">start_env :: AnalEnv
</span><a href="#local-6989586621681827544"><span class="hs-identifier hs-var hs-var">start_env</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681827540"><span class="hs-identifier hs-var">first_round</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827504"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2166"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#nonVirgin"><span class="hs-identifier hs-var">nonVirgin</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827504"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2167"></span><span>
</span><span id="line-2168"></span><span>        </span><span id="local-6989586621681827546"><span class="annot"><span class="annottext">start :: (AnalEnv, WeakDmds)
</span><a href="#local-6989586621681827546"><span class="hs-identifier hs-var hs-var">start</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelFlag -&gt; AnalEnv -&gt; [Id] -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#extendAnalEnvs"><span class="hs-identifier hs-var">extendAnalEnvs</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827503"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827544"><span class="hs-identifier hs-var">start_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Id, CoreExpr) -&gt; Id) -&gt; [(Id, CoreExpr)] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, CoreExpr) -&gt; Id
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827541"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WeakDmds
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2169"></span><span>
</span><span id="line-2170"></span><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="hs-glyph">!</span><span id="local-6989586621681827542"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827542"><span class="hs-identifier hs-var">weak_fv</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681827543"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827543"><span class="hs-identifier hs-var">pairs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((AnalEnv, WeakDmds)
 -&gt; (Id, CoreExpr) -&gt; ((AnalEnv, WeakDmds), (Id, CoreExpr)))
-&gt; (AnalEnv, WeakDmds)
-&gt; [(Id, CoreExpr)]
-&gt; ((AnalEnv, WeakDmds), [(Id, CoreExpr)])
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapAccumL/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a></span><span> </span><span class="annot"><span class="annottext">(AnalEnv, WeakDmds)
-&gt; (Id, CoreExpr) -&gt; ((AnalEnv, WeakDmds), (Id, CoreExpr))
</span><a href="#local-6989586621681827548"><span class="hs-identifier hs-var">my_downRhs</span></a></span><span> </span><span class="annot"><span class="annottext">(AnalEnv, WeakDmds)
</span><a href="#local-6989586621681827546"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827541"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-2171"></span><span>                </span><span class="hs-comment">-- mapAccumL: Use the new signature to do the next pair</span><span>
</span><span id="line-2172"></span><span>                </span><span class="hs-comment">-- The occurrence analyser has arranged them in a good order</span><span>
</span><span id="line-2173"></span><span>                </span><span class="hs-comment">-- so this can significantly reduce the number of iterations needed</span><span>
</span><span id="line-2174"></span><span>
</span><span id="line-2175"></span><span>        </span><span id="local-6989586621681827548"><span class="annot"><span class="annottext">my_downRhs :: (AnalEnv, WeakDmds)
-&gt; (Id, CoreExpr) -&gt; ((AnalEnv, WeakDmds), (Id, CoreExpr))
</span><a href="#local-6989586621681827548"><span class="hs-identifier hs-var hs-var">my_downRhs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827549"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827549"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827550"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827550"><span class="hs-identifier hs-var">weak_fv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827551"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827551"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681827552"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827552"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2176"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;my_downRhs&quot; (ppr id $$ ppr (idDmdSig id) $$ ppr sig) $</span><span>
</span><span id="line-2177"></span><span>            </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827553"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827554"><span class="hs-identifier hs-var">weak_fv'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827555"><span class="hs-identifier hs-var">id'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827556"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2178"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-2179"></span><span>            </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621681827553"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827553"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681827557"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827557"><span class="hs-identifier hs-var">weak_fv1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681827555"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827555"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681827556"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827556"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; RecFlag
-&gt; AnalEnv
-&gt; SubDemand
-&gt; Id
-&gt; CoreExpr
-&gt; (AnalEnv, WeakDmds, Id, CoreExpr)
</span><a href="GHC.Core.Opt.DmdAnal.html#dmdAnalRhsSig"><span class="hs-identifier hs-var">dmdAnalRhsSig</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827503"><span class="hs-identifier hs-var">top_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827549"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SubDemand
</span><a href="#local-6989586621681827505"><span class="hs-identifier hs-var">let_dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827551"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827552"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-2180"></span><span>            </span><span class="hs-glyph">!</span><span id="local-6989586621681827554"><span class="annot"><span class="annottext">weak_fv' :: WeakDmds
</span><a href="#local-6989586621681827554"><span class="hs-identifier hs-var hs-var">weak_fv'</span></a></span></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Demand -&gt; Demand -&gt; Demand) -&gt; WeakDmds -&gt; WeakDmds -&gt; WeakDmds
forall a. (a -&gt; a -&gt; a) -&gt; VarEnv a -&gt; VarEnv a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#plusVarEnv_C"><span class="hs-identifier hs-var">plusVarEnv_C</span></a></span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#plusDmd"><span class="hs-identifier hs-var">plusDmd</span></a></span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827550"><span class="hs-identifier hs-var">weak_fv</span></a></span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827557"><span class="hs-identifier hs-var">weak_fv1</span></a></span><span>
</span><span id="line-2181"></span><span>
</span><span id="line-2182"></span><span>    </span><span class="annot"><a href="#local-6989586621681827520"><span class="hs-identifier hs-type">zapIdDmdSig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-2183"></span><span>    </span><span id="local-6989586621681827520"><span class="annot"><span class="annottext">zapIdDmdSig :: [(Id, CoreExpr)] -&gt; [(Id, CoreExpr)]
</span><a href="#local-6989586621681827520"><span class="hs-identifier hs-var hs-var">zapIdDmdSig</span></a></span></span><span> </span><span id="local-6989586621681827558"><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827558"><span class="hs-identifier hs-var">pairs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; DmdSig -&gt; Id
</span><a href="GHC.Types.Id.html#setIdDmdSig"><span class="hs-identifier hs-var">setIdDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827559"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">DmdSig
</span><a href="GHC.Types.Demand.html#nopSig"><span class="hs-identifier hs-var">nopSig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827561"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827559"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827559"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827561"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681827561"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Id, CoreExpr)]
</span><a href="#local-6989586621681827558"><span class="hs-identifier hs-var">pairs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-2184"></span><span>
</span><span id="line-2185"></span><span class="hs-comment">{- Note [Safe abortion in the fixed-point iteration]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Fixed-point iteration may fail to terminate. But we cannot simply give up and
return the environment and code unchanged! We still need to do one additional
round, for two reasons:

 * To get information on used free variables (both lazy and strict!)
   (see Note [Lazy and unleashable free variables])
 * To ensure that all expressions have been traversed at least once, and any left-over
   strictness annotations have been updated.

This final iteration does not add the variables to the strictness signature
environment, which effectively assigns them 'nopSig' (see &quot;getStrictness&quot;)

Note [Trimming a demand to a type]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There are two reasons we sometimes trim a demand to match a type.
  1. GADTs
  2. Recursive products and widening

More on both below.  But the bottom line is: we really don't want to
have a binder whose demand is more deeply-nested than its type
&quot;allows&quot;. So in findBndrDmd we call trimToType and findTypeShape to
trim the demand on the binder to a form that matches the type

Now to the reasons. For (1) consider
  f :: a -&gt; Bool
  f x = case ... of
          A g1 -&gt; case (x |&gt; g1) of (p,q) -&gt; ...
          B    -&gt; error &quot;urk&quot;

where A,B are the constructors of a GADT.  We'll get a 1P(L,L) demand
on x from the A branch, but that's a stupid demand for x itself, which
has type 'a'. Indeed we get ASSERTs going off (notably in
splitUseProdDmd, #8569).

For (2) consider
  data T = MkT Int T    -- A recursive product
  f :: Int -&gt; T -&gt; Int
  f 0 _         = 0
  f _ (MkT n t) = f n t

Here f is lazy in T, but its *usage* is infinite: P(L,P(L,P(L, ...))).
Notice that this happens because T is a product type, and is recursive.
If we are not careful, we'll fail to iterate to a fixpoint in dmdFix,
and bale out entirely, which is inefficient and over-conservative.

Worse, as we discovered in #18304, the size of the usages we compute
can grow /exponentially/, so even 10 iterations costs far too much.
Especially since we then discard the result.

To avoid this we use the same findTypeShape function as for (1), but
arrange that it trims the demand if it encounters the same type constructor
twice (or three times, etc).  We use our standard RecTcChecker mechanism
for this -- see GHC.Core.Opt.WorkWrap.Utils.findTypeShape.

This is usually call &quot;widening&quot;.  We could do it just in dmdFix, but
since are doing this findTypeShape business /anyway/ because of (1),
and it has all the right information to hand, it's extremely
convenient to do it there.

-}</span><span>
</span><span id="line-2247"></span><span>
</span><span id="line-2248"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
                 Strictness signatures and types
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-2253"></span><span>
</span><span id="line-2254"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#noArgsDmdType"><span class="hs-identifier hs-type">noArgsDmdType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span>
</span><span id="line-2255"></span><span id="noArgsDmdType"><span class="annot"><span class="annottext">noArgsDmdType :: DmdEnv -&gt; DmdType
</span><a href="GHC.Core.Opt.DmdAnal.html#noArgsDmdType"><span class="hs-identifier hs-var hs-var">noArgsDmdType</span></a></span></span><span> </span><span id="local-6989586621681827562"><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827562"><span class="hs-identifier hs-var">dmd_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdEnv -&gt; [Demand] -&gt; DmdType
</span><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827562"><span class="hs-identifier hs-var">dmd_env</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2256"></span><span>
</span><span id="line-2257"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#coercionDmdEnv"><span class="hs-identifier hs-type">coercionDmdEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a></span><span>
</span><span id="line-2258"></span><span id="coercionDmdEnv"><span class="annot"><span class="annottext">coercionDmdEnv :: Coercion -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#coercionDmdEnv"><span class="hs-identifier hs-var hs-var">coercionDmdEnv</span></a></span></span><span> </span><span id="local-6989586621681827563"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681827563"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Coercion] -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#coercionsDmdEnv"><span class="hs-identifier hs-var">coercionsDmdEnv</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681827563"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2259"></span><span>
</span><span id="line-2260"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#coercionsDmdEnv"><span class="hs-identifier hs-type">coercionsDmdEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a></span><span>
</span><span id="line-2261"></span><span id="coercionsDmdEnv"><span class="annot"><span class="annottext">coercionsDmdEnv :: [Coercion] -&gt; DmdEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#coercionsDmdEnv"><span class="hs-identifier hs-var hs-var">coercionsDmdEnv</span></a></span></span><span> </span><span id="local-6989586621681827565"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621681827565"><span class="hs-identifier hs-var">cos</span></a></span></span><span>
</span><span id="line-2262"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WeakDmds -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#mkTermDmdEnv"><span class="hs-identifier hs-var">mkTermDmdEnv</span></a></span><span> </span><span class="annot"><span class="annottext">(WeakDmds -&gt; DmdEnv) -&gt; WeakDmds -&gt; DmdEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Demand) -&gt; VarEnv Id -&gt; WeakDmds
forall a b. (a -&gt; b) -&gt; VarEnv a -&gt; VarEnv b
</span><a href="GHC.Types.Var.Env.html#mapVarEnv"><span class="hs-identifier hs-var">mapVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand -&gt; Id -&gt; Demand
forall a b. a -&gt; b -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#const/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VarEnv Id -&gt; WeakDmds) -&gt; VarEnv Id -&gt; WeakDmds
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">VarSet -&gt; VarEnv Id
forall a. UniqSet a -&gt; UniqFM a a
</span><a href="GHC.Types.Unique.Set.html#getUniqSet"><span class="hs-identifier hs-var">getUniqSet</span></a></span><span> </span><span class="annot"><span class="annottext">(VarSet -&gt; VarEnv Id) -&gt; VarSet -&gt; VarEnv Id
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion] -&gt; VarSet
</span><a href="GHC.Core.TyCo.FVs.html#coVarsOfCos"><span class="hs-identifier hs-var">coVarsOfCos</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621681827565"><span class="hs-identifier hs-var">cos</span></a></span><span>
</span><span id="line-2263"></span><span>  </span><span class="hs-comment">-- The VarSet from coVarsOfCos is really a VarEnv Var</span><span>
</span><span id="line-2264"></span><span>
</span><span id="line-2265"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#addVarDmd"><span class="hs-identifier hs-type">addVarDmd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span>
</span><span id="line-2266"></span><span id="addVarDmd"><span class="annot"><span class="annottext">addVarDmd :: DmdType -&gt; Id -&gt; Demand -&gt; DmdType
</span><a href="GHC.Core.Opt.DmdAnal.html#addVarDmd"><span class="hs-identifier hs-var hs-var">addVarDmd</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span> </span><span id="local-6989586621681827568"><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827568"><span class="hs-identifier hs-var">fv</span></a></span></span><span> </span><span id="local-6989586621681827569"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827569"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681827570"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827570"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621681827571"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827571"><span class="hs-identifier hs-var">dmd</span></a></span></span><span>
</span><span id="line-2267"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdEnv -&gt; [Demand] -&gt; DmdType
</span><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdEnv -&gt; Id -&gt; Demand -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#addVarDmdEnv"><span class="hs-identifier hs-var">addVarDmdEnv</span></a></span><span> </span><span class="annot"><span class="annottext">DmdEnv
</span><a href="#local-6989586621681827568"><span class="hs-identifier hs-var">fv</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827570"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827571"><span class="hs-identifier hs-var">dmd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827569"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-2268"></span><span>
</span><span id="line-2269"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#addWeakFVs"><span class="hs-identifier hs-type">addWeakFVs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WeakDmds"><span class="hs-identifier hs-type">WeakDmds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span>
</span><span id="line-2270"></span><span id="addWeakFVs"><span class="annot"><span class="annottext">addWeakFVs :: DmdType -&gt; WeakDmds -&gt; DmdType
</span><a href="GHC.Core.Opt.DmdAnal.html#addWeakFVs"><span class="hs-identifier hs-var hs-var">addWeakFVs</span></a></span></span><span> </span><span id="local-6989586621681827572"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827572"><span class="hs-identifier hs-var">dmd_ty</span></a></span></span><span> </span><span id="local-6989586621681827573"><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827573"><span class="hs-identifier hs-var">weak_fvs</span></a></span></span><span>
</span><span id="line-2271"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827572"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; DmdEnv -&gt; DmdType
</span><a href="GHC.Types.Demand.html#plusDmdType"><span class="hs-operator hs-var">`plusDmdType`</span></a></span><span> </span><span class="annot"><span class="annottext">WeakDmds -&gt; DmdEnv
</span><a href="GHC.Types.Demand.html#mkTermDmdEnv"><span class="hs-identifier hs-var">mkTermDmdEnv</span></a></span><span> </span><span class="annot"><span class="annottext">WeakDmds
</span><a href="#local-6989586621681827573"><span class="hs-identifier hs-var">weak_fvs</span></a></span><span>
</span><span id="line-2272"></span><span>        </span><span class="hs-comment">-- Using plusDmdType (rather than just plus'ing the envs)</span><span>
</span><span id="line-2273"></span><span>        </span><span class="hs-comment">-- is vital.  Consider</span><span>
</span><span id="line-2274"></span><span>        </span><span class="hs-comment">--      let f = \x -&gt; (x,y)</span><span>
</span><span id="line-2275"></span><span>        </span><span class="hs-comment">--      in  error (f 3)</span><span>
</span><span id="line-2276"></span><span>        </span><span class="hs-comment">-- Here, y is treated as a lazy-fv of f, but we must `plusDmd` that L</span><span>
</span><span id="line-2277"></span><span>        </span><span class="hs-comment">-- demand with the bottom coming up from 'error'</span><span>
</span><span id="line-2278"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-2279"></span><span>        </span><span class="hs-comment">-- I got a loop in the fixpointer without this, due to an interaction</span><span>
</span><span id="line-2280"></span><span>        </span><span class="hs-comment">-- with the weak_fv filtering in dmdAnalRhsSig.  Roughly, it was</span><span>
</span><span id="line-2281"></span><span>        </span><span class="hs-comment">--      letrec f n x</span><span>
</span><span id="line-2282"></span><span>        </span><span class="hs-comment">--          = letrec g y = x `fatbar`</span><span>
</span><span id="line-2283"></span><span>        </span><span class="hs-comment">--                         letrec h z = z + ...g...</span><span>
</span><span id="line-2284"></span><span>        </span><span class="hs-comment">--                         in h (f (n-1) x)</span><span>
</span><span id="line-2285"></span><span>        </span><span class="hs-comment">--      in ...</span><span>
</span><span id="line-2286"></span><span>        </span><span class="hs-comment">-- In the initial iteration for f, f=Bot</span><span>
</span><span id="line-2287"></span><span>        </span><span class="hs-comment">-- Suppose h is found to be strict in z, but the occurrence of g in its RHS</span><span>
</span><span id="line-2288"></span><span>        </span><span class="hs-comment">-- is lazy.  Now consider the fixpoint iteration for g, esp the demands it</span><span>
</span><span id="line-2289"></span><span>        </span><span class="hs-comment">-- places on its free variables.  Suppose it places none.  Then the</span><span>
</span><span id="line-2290"></span><span>        </span><span class="hs-comment">--      x `fatbar` ...call to h...</span><span>
</span><span id="line-2291"></span><span>        </span><span class="hs-comment">-- will give a x-&gt;V demand for x.  That turns into a L demand for x,</span><span>
</span><span id="line-2292"></span><span>        </span><span class="hs-comment">-- which floats out of the defn for h.  Without the modifyEnv, that</span><span>
</span><span id="line-2293"></span><span>        </span><span class="hs-comment">-- L demand doesn't get both'd with the Bot coming up from the inner</span><span>
</span><span id="line-2294"></span><span>        </span><span class="hs-comment">-- call to f.  So we just get an L demand for x for g.</span><span>
</span><span id="line-2295"></span><span>
</span><span id="line-2296"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-type">setBndrsDemandInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Stack.Types.html#HasCallStack/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2297"></span><span id="setBndrsDemandInfo"><span class="annot"><span class="annottext">setBndrsDemandInfo :: HasCallStack =&gt; [Id] -&gt; [Demand] -&gt; [Id]
</span><a href="GHC.Core.Opt.DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-var hs-var">setBndrsDemandInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827585"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827585"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681827586"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827586"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681827587"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827587"><span class="hs-identifier hs-var">ds</span></a></span></span><span>
</span><span id="line-2298"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827585"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827585"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; [Id] -&gt; [Demand] -&gt; [Id]
[Id] -&gt; [Demand] -&gt; [Id]
</span><a href="GHC.Core.Opt.DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-var">setBndrsDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827586"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827587"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-2299"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-var">setBndrsDemandInfo</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827588"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827588"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681827589"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827589"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827590"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827590"><span class="hs-identifier hs-var">d</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681827591"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827591"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2300"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681827592"><span class="annot"><span class="annottext">new_info :: Id
</span><a href="#local-6989586621681827592"><span class="hs-identifier hs-var hs-var">new_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Demand -&gt; Id
</span><a href="GHC.Types.Id.html#setIdDemandInfo"><span class="hs-identifier hs-var">setIdDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827588"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827590"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-2301"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681827593"><span class="annot"><span class="annottext">vars :: [Id]
</span><a href="#local-6989586621681827593"><span class="hs-identifier hs-var hs-var">vars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; [Id] -&gt; [Demand] -&gt; [Id]
[Id] -&gt; [Demand] -&gt; [Id]
</span><a href="GHC.Core.Opt.DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-var">setBndrsDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827589"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827591"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-2302"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827592"><span class="hs-identifier hs-var">new_info</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; [Id] -&gt; [Id]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827593"><span class="hs-identifier hs-var">vars</span></a></span><span>
</span><span id="line-2303"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-var">setBndrsDemandInfo</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621681827594"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827594"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Id] -&gt; [Id]
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827594"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2304"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-var">setBndrsDemandInfo</span></a></span><span> </span><span id="local-6989586621681827595"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827595"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; [Id]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;setBndrsDemandInfo&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Id] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827595"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2305"></span><span>
</span><span id="line-2306"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#annotateLamIdBndr"><span class="hs-identifier hs-type">annotateLamIdBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-2307"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span>    </span><span class="hs-comment">-- Demand type of body</span><span>
</span><span id="line-2308"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>         </span><span class="hs-comment">-- Lambda binder</span><span>
</span><span id="line-2309"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>  </span><span class="hs-comment">-- Demand type of lambda</span><span>
</span><span id="line-2310"></span><span>                                     </span><span class="hs-comment">-- and binder annotated with demand</span><span>
</span><span id="line-2311"></span><span>
</span><span id="line-2312"></span><span id="annotateLamIdBndr"><span class="annot"><span class="annottext">annotateLamIdBndr :: AnalEnv -&gt; DmdType -&gt; Id -&gt; WithDmdType Id
</span><a href="GHC.Core.Opt.DmdAnal.html#annotateLamIdBndr"><span class="hs-identifier hs-var hs-var">annotateLamIdBndr</span></a></span></span><span> </span><span id="local-6989586621681827596"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827596"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827597"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827597"><span class="hs-identifier hs-var">dmd_ty</span></a></span></span><span> </span><span id="local-6989586621681827598"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827598"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-2313"></span><span class="hs-comment">-- For lambdas we add the demand to the argument demands</span><span>
</span><span id="line-2314"></span><span class="hs-comment">-- Only called for Ids</span><span>
</span><span id="line-2315"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; WithDmdType Id -&gt; WithDmdType Id
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827598"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(WithDmdType Id -&gt; WithDmdType Id)
-&gt; WithDmdType Id -&gt; WithDmdType Id
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2316"></span><span>    </span><span class="hs-comment">-- pprTrace &quot;annLamBndr&quot; (vcat [ppr id, ppr dmd_ty, ppr final_ty]) $</span><span>
</span><span id="line-2317"></span><span>    </span><span class="annot"><span class="annottext">DmdType -&gt; Id -&gt; WithDmdType Id
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827599"><span class="hs-identifier hs-var">main_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827600"><span class="hs-identifier hs-var">new_id</span></a></span><span>
</span><span id="line-2318"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2319"></span><span>    </span><span id="local-6989586621681827600"><span class="annot"><span class="annottext">new_id :: Id
</span><a href="#local-6989586621681827600"><span class="hs-identifier hs-var hs-var">new_id</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Demand -&gt; Id
</span><a href="GHC.Types.Id.html#setIdDemandInfo"><span class="hs-identifier hs-var">setIdDemandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827598"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827601"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-2320"></span><span>    </span><span id="local-6989586621681827599"><span class="annot"><span class="annottext">main_ty :: DmdType
</span><a href="#local-6989586621681827599"><span class="hs-identifier hs-var hs-var">main_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; DmdType -&gt; DmdType
</span><a href="GHC.Types.Demand.html#addDemand"><span class="hs-identifier hs-var">addDemand</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827601"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827603"><span class="hs-identifier hs-var">dmd_ty'</span></a></span><span>
</span><span id="line-2321"></span><span>    </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827603"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827603"><span class="hs-identifier hs-var">dmd_ty'</span></a></span></span><span> </span><span id="local-6989586621681827601"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827601"><span class="hs-identifier hs-var">dmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdType -&gt; Id -&gt; WithDmdType Demand
</span><a href="GHC.Core.Opt.DmdAnal.html#findBndrDmd"><span class="hs-identifier hs-var">findBndrDmd</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827596"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827597"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827598"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-2322"></span><span>
</span><span id="line-2323"></span><span class="hs-comment">{- Note [NOINLINE and strictness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
At one point we disabled strictness for NOINLINE functions, on the
grounds that they should be entirely opaque.  But that lost lots of
useful semantic strictness information, so now we analyse them like
any other function, and pin strictness information on them.

That in turn forces us to worker/wrapper them; see
Note [Worker/wrapper for NOINLINE functions] in GHC.Core.Opt.WorkWrap.


Note [Lazy and unleashable free variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We put the strict and once-used FVs in the DmdType of the Id, so
that at its call sites we unleash demands on its strict fvs.
An example is 'roll' in imaginary/wheel-sieve2
Something like this:
        roll x = letrec
                     go y = if ... then roll (x-1) else x+1
                 in
                 go ms
We want to see that roll is strict in x, which is because
go is called.   So we put the DmdEnv for x in go's DmdType.

Another example:

        f :: Int -&gt; Int -&gt; Int
        f x y = let t = x+1
            h z = if z==0 then t else
                  if z==1 then x+1 else
                  x + h (z-1)
        in h y

Calling h does indeed evaluate x, but we can only see
that if we unleash a demand on x at the call site for t.

Incidentally, here's a place where lambda-lifting h would
lose the cigar --- we couldn't see the joint strictness in t/x

        ON THE OTHER HAND

We don't want to put *all* the fv's from the RHS into the
DmdType. Because

 * it makes the strictness signatures larger, and hence slows down fixpointing

and

 * it is useless information at the call site anyways:
   For lazy, used-many times fv's we will never get any better result than
   that, no matter how good the actual demand on the function at the call site
   is (unless it is always absent, but then the whole binder is useless).

Therefore we exclude lazy multiple-used fv's from the environment in the
DmdType.

But now the signature lies! (Missing variables are assumed to be absent.) To
make up for this, the code that analyses the binding keeps the demand on those
variable separate (usually called &quot;weak_fv&quot;) and adds it to the demand of the
whole binding later.

What if we decide _not_ to store a strictness signature for a binding at all, as
we do when aborting a fixed-point iteration? The we risk losing the information
that the strict variables are being used. In that case, we take all free variables
mentioned in the (unsound) strictness signature, conservatively approximate the
demand put on them (topDmd), and add that to the &quot;weak_fv&quot; returned by &quot;dmdFix&quot;.


************************************************************************
*                                                                      *
\subsection{Strictness signatures}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-2397"></span><span>
</span><span id="line-2398"></span><span>
</span><span id="line-2399"></span><span class="hs-keyword">data</span><span> </span><span id="AnalEnv"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-var">AnalEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AE"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AE"><span class="hs-identifier hs-var">AE</span></a></span></span><span>
</span><span id="line-2400"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ae_opts"><span class="annot"><span class="annottext">AnalEnv -&gt; DmdAnalOpts
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_opts"><span class="hs-identifier hs-var hs-var">ae_opts</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#DmdAnalOpts"><span class="hs-identifier hs-type">DmdAnalOpts</span></a></span><span>
</span><span id="line-2401"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Analysis options</span></span><span>
</span><span id="line-2402"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ae_sigs"><span class="annot"><span class="annottext">AnalEnv -&gt; SigEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_sigs"><span class="hs-identifier hs-var hs-var">ae_sigs</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a></span><span>
</span><span id="line-2403"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ae_virgin"><span class="annot"><span class="annottext">AnalEnv -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_virgin"><span class="hs-identifier hs-var hs-var">ae_virgin</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-2404"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ True on first iteration only. See Note [Initialising strictness]</span></span><span>
</span><span id="line-2405"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ae_fam_envs"><span class="annot"><span class="annottext">AnalEnv -&gt; FamInstEnvs
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_fam_envs"><span class="hs-identifier hs-var hs-var">ae_fam_envs</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span>
</span><span id="line-2406"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ae_rec_dc"><span class="annot"><span class="annottext">AnalEnv -&gt; DataCon -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_rec_dc"><span class="hs-identifier hs-var hs-var">ae_rec_dc</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#IsRecDataConResult"><span class="hs-identifier hs-type">IsRecDataConResult</span></a></span><span>
</span><span id="line-2407"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Memoised result of 'GHC.Core.Opt.WorkWrap.Utils.isRecDataCon'</span></span><span>
</span><span id="line-2408"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-2409"></span><span>
</span><span id="line-2410"></span><span>        </span><span class="hs-comment">-- We use the se_env to tell us whether to</span><span>
</span><span id="line-2411"></span><span>        </span><span class="hs-comment">-- record info about a variable in the DmdEnv</span><span>
</span><span id="line-2412"></span><span>        </span><span class="hs-comment">-- We do so if it's a LocalId, but not top-level</span><span>
</span><span id="line-2413"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-2414"></span><span>        </span><span class="hs-comment">-- The DmdEnv gives the demand on the free vars of the function</span><span>
</span><span id="line-2415"></span><span>        </span><span class="hs-comment">-- when it is given enough args to satisfy the strictness signature</span><span>
</span><span id="line-2416"></span><span>
</span><span id="line-2417"></span><span class="hs-keyword">type</span><span> </span><span id="SigEnv"><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#SigEnv"><span class="hs-identifier hs-var">SigEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2418"></span><span>
</span><span id="line-2419"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2420"></span><span>  </span><span id="local-6989586621681827628"><span class="annot"><span class="annottext">ppr :: AnalEnv -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span id="local-6989586621681827629"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827629"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;AE&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-2421"></span><span>         </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ae_virgin =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_virgin"><span class="hs-identifier hs-var">ae_virgin</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827629"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2422"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ae_sigs =&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SigEnv -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; SigEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827629"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2423"></span><span>         </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-2424"></span><span>
</span><span id="line-2425"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#emptyAnalEnv"><span class="hs-identifier hs-type">emptyAnalEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#DmdAnalOpts"><span class="hs-identifier hs-type">DmdAnalOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-2426"></span><span id="emptyAnalEnv"><span class="annot"><span class="annottext">emptyAnalEnv :: DmdAnalOpts -&gt; FamInstEnvs -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#emptyAnalEnv"><span class="hs-identifier hs-var hs-var">emptyAnalEnv</span></a></span></span><span> </span><span id="local-6989586621681827633"><span class="annot"><span class="annottext">DmdAnalOpts
</span><a href="#local-6989586621681827633"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681827634"><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681827634"><span class="hs-identifier hs-var">fam_envs</span></a></span></span><span>
</span><span id="line-2427"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AE"><span class="hs-identifier hs-type">AE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ae_opts :: DmdAnalOpts
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_opts"><span class="hs-identifier hs-var">ae_opts</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdAnalOpts
</span><a href="#local-6989586621681827633"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-2428"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ae_sigs :: SigEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SigEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#emptySigEnv"><span class="hs-identifier hs-var">emptySigEnv</span></a></span><span>
</span><span id="line-2429"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ae_virgin :: Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_virgin"><span class="hs-identifier hs-var">ae_virgin</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2430"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ae_fam_envs :: FamInstEnvs
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_fam_envs"><span class="hs-identifier hs-var">ae_fam_envs</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681827634"><span class="hs-identifier hs-var">fam_envs</span></a></span><span>
</span><span id="line-2431"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ae_rec_dc :: DataCon -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_rec_dc"><span class="hs-identifier hs-var">ae_rec_dc</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DataCon -&gt; IsRecDataConResult) -&gt; DataCon -&gt; IsRecDataConResult
forall k a. Uniquable k =&gt; (k -&gt; a) -&gt; k -&gt; a
</span><a href="GHC.Types.Unique.MemoFun.html#memoiseUniqueFun"><span class="hs-identifier hs-var">memoiseUniqueFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FamInstEnvs -&gt; IntWithInf -&gt; DataCon -&gt; IsRecDataConResult
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#isRecDataCon"><span class="hs-identifier hs-var">isRecDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681827634"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">IntWithInf
</span><span class="hs-number">3</span></span><span class="hs-special">)</span><span>
</span><span id="line-2432"></span><span>         </span><span class="hs-special">}</span><span>
</span><span id="line-2433"></span><span>
</span><span id="line-2434"></span><span class="hs-comment">-- | Unset the 'dmd_strict_dicts' flag if any of the given bindings is a DFun</span><span>
</span><span id="line-2435"></span><span class="hs-comment">-- binding. Part of the mechanism that detects</span><span>
</span><span id="line-2436"></span><span class="hs-comment">-- Note [Do not strictify a DFun's parameter dictionaries].</span><span>
</span><span id="line-2437"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#enterDFun"><span class="hs-identifier hs-type">enterDFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-2438"></span><span id="enterDFun"><span class="annot"><span class="annottext">enterDFun :: Bind Id -&gt; AnalEnv -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#enterDFun"><span class="hs-identifier hs-var hs-var">enterDFun</span></a></span></span><span> </span><span id="local-6989586621681827637"><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681827637"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621681827638"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827638"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-2439"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Bool) -&gt; [Id] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#any/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Id.html#isDFunId"><span class="hs-identifier hs-var">isDFunId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bind Id -&gt; [Id]
forall b. Bind b -&gt; [b]
</span><a href="GHC.Core.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a></span><span> </span><span class="annot"><span class="annottext">Bind Id
</span><a href="#local-6989586621681827637"><span class="hs-identifier hs-var">bind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2440"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827638"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#ae_opts"><span class="hs-identifier hs-var">ae_opts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#ae_opts"><span class="hs-identifier hs-var">ae_opts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681827638"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#dmd_strict_dicts"><span class="hs-identifier hs-var">dmd_strict_dicts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2441"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2442"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827638"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2443"></span><span>
</span><span id="line-2444"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#emptySigEnv"><span class="hs-identifier hs-type">emptySigEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a></span><span>
</span><span id="line-2445"></span><span id="emptySigEnv"><span class="annot"><span class="annottext">emptySigEnv :: SigEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#emptySigEnv"><span class="hs-identifier hs-var hs-var">emptySigEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SigEnv
forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-2446"></span><span>
</span><span id="line-2447"></span><span class="annot"><span class="hs-comment">-- | Extend an environment with the strictness sigs attached to the Ids</span></span><span>
</span><span id="line-2448"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#extendAnalEnvs"><span class="hs-identifier hs-type">extendAnalEnvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-2449"></span><span id="extendAnalEnvs"><span class="annot"><span class="annottext">extendAnalEnvs :: TopLevelFlag -&gt; AnalEnv -&gt; [Id] -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#extendAnalEnvs"><span class="hs-identifier hs-var hs-var">extendAnalEnvs</span></a></span></span><span> </span><span id="local-6989586621681827640"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827640"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681827641"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827641"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827642"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827642"><span class="hs-identifier hs-var">vars</span></a></span></span><span>
</span><span id="line-2450"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827641"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#extendSigEnvs"><span class="hs-identifier hs-type">extendSigEnvs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681827640"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681827641"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681827642"><span class="hs-identifier hs-type">vars</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2451"></span><span>
</span><span id="line-2452"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#extendSigEnvs"><span class="hs-identifier hs-type">extendSigEnvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a></span><span>
</span><span id="line-2453"></span><span id="extendSigEnvs"><span class="annot"><span class="annottext">extendSigEnvs :: TopLevelFlag -&gt; SigEnv -&gt; [Id] -&gt; SigEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#extendSigEnvs"><span class="hs-identifier hs-var hs-var">extendSigEnvs</span></a></span></span><span> </span><span id="local-6989586621681827644"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827644"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681827645"><span class="annot"><span class="annottext">SigEnv
</span><a href="#local-6989586621681827645"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span id="local-6989586621681827646"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827646"><span class="hs-identifier hs-var">vars</span></a></span></span><span>
</span><span id="line-2454"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SigEnv -&gt; [(Id, (DmdSig, TopLevelFlag))] -&gt; SigEnv
forall a. VarEnv a -&gt; [(Id, a)] -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnvList"><span class="hs-identifier hs-var">extendVarEnvList</span></a></span><span> </span><span class="annot"><span class="annottext">SigEnv
</span><a href="#local-6989586621681827645"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827648"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; DmdSig
</span><a href="GHC.Types.Id.html#idDmdSig"><span class="hs-identifier hs-var">idDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827648"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827644"><span class="hs-identifier hs-var">top_lvl</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681827648"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827648"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827646"><span class="hs-identifier hs-var">vars</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2455"></span><span>
</span><span id="line-2456"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#extendAnalEnv"><span class="hs-identifier hs-type">extendAnalEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-2457"></span><span id="extendAnalEnv"><span class="annot"><span class="annottext">extendAnalEnv :: TopLevelFlag -&gt; AnalEnv -&gt; Id -&gt; DmdSig -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#extendAnalEnv"><span class="hs-identifier hs-var hs-var">extendAnalEnv</span></a></span></span><span> </span><span id="local-6989586621681827649"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827649"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681827650"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827650"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827651"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827651"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621681827652"><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681827652"><span class="hs-identifier hs-var">sig</span></a></span></span><span>
</span><span id="line-2458"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827650"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#extendSigEnv"><span class="hs-identifier hs-type">extendSigEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681827649"><span class="hs-identifier hs-type">top_lvl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681827650"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681827651"><span class="hs-identifier hs-type">var</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681827652"><span class="hs-identifier hs-type">sig</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2459"></span><span>
</span><span id="line-2460"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#extendSigEnv"><span class="hs-identifier hs-type">extendSigEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a></span><span>
</span><span id="line-2461"></span><span id="extendSigEnv"><span class="annot"><span class="annottext">extendSigEnv :: TopLevelFlag -&gt; SigEnv -&gt; Id -&gt; DmdSig -&gt; SigEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#extendSigEnv"><span class="hs-identifier hs-var hs-var">extendSigEnv</span></a></span></span><span> </span><span id="local-6989586621681827654"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827654"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681827655"><span class="annot"><span class="annottext">SigEnv
</span><a href="#local-6989586621681827655"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span id="local-6989586621681827656"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827656"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621681827657"><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681827657"><span class="hs-identifier hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SigEnv -&gt; Id -&gt; (DmdSig, TopLevelFlag) -&gt; SigEnv
forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">SigEnv
</span><a href="#local-6989586621681827655"><span class="hs-identifier hs-var">sigs</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827656"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdSig
</span><a href="#local-6989586621681827657"><span class="hs-identifier hs-var">sig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681827654"><span class="hs-identifier hs-var">top_lvl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2462"></span><span>
</span><span id="line-2463"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#lookupSigEnv"><span class="hs-identifier hs-type">lookupSigEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Demand.html#DmdSig"><span class="hs-identifier hs-type">DmdSig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2464"></span><span id="lookupSigEnv"><span class="annot"><span class="annottext">lookupSigEnv :: AnalEnv -&gt; Id -&gt; Maybe (DmdSig, TopLevelFlag)
</span><a href="GHC.Core.Opt.DmdAnal.html#lookupSigEnv"><span class="hs-identifier hs-var hs-var">lookupSigEnv</span></a></span></span><span> </span><span id="local-6989586621681827659"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827659"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827660"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827660"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SigEnv -&gt; Id -&gt; Maybe (DmdSig, TopLevelFlag)
forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; SigEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827659"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827660"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-2465"></span><span>
</span><span id="line-2466"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#addInScopeAnalEnv"><span class="hs-identifier hs-type">addInScopeAnalEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-2467"></span><span id="addInScopeAnalEnv"><span class="annot"><span class="annottext">addInScopeAnalEnv :: AnalEnv -&gt; Id -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#addInScopeAnalEnv"><span class="hs-identifier hs-var hs-var">addInScopeAnalEnv</span></a></span></span><span> </span><span id="local-6989586621681827662"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827662"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827663"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827663"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827662"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#delVarEnv"><span class="hs-identifier hs-type">delVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681827662"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681827663"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2468"></span><span>
</span><span id="line-2469"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#addInScopeAnalEnvs"><span class="hs-identifier hs-type">addInScopeAnalEnvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-2470"></span><span id="addInScopeAnalEnvs"><span class="annot"><span class="annottext">addInScopeAnalEnvs :: AnalEnv -&gt; [Id] -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#addInScopeAnalEnvs"><span class="hs-identifier hs-var hs-var">addInScopeAnalEnvs</span></a></span></span><span> </span><span id="local-6989586621681827665"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827665"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827666"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827666"><span class="hs-identifier hs-var">ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827665"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#delVarEnvList"><span class="hs-identifier hs-type">delVarEnvList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#ae_sigs"><span class="hs-identifier hs-var">ae_sigs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681827665"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681827666"><span class="hs-identifier hs-type">ids</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2471"></span><span>
</span><span id="line-2472"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#nonVirgin"><span class="hs-identifier hs-type">nonVirgin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span>
</span><span id="line-2473"></span><span id="nonVirgin"><span class="annot"><span class="annottext">nonVirgin :: AnalEnv -&gt; AnalEnv
</span><a href="GHC.Core.Opt.DmdAnal.html#nonVirgin"><span class="hs-identifier hs-var hs-var">nonVirgin</span></a></span></span><span> </span><span id="local-6989586621681827668"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827668"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827668"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#ae_virgin"><span class="hs-identifier hs-var">ae_virgin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-2474"></span><span>
</span><span id="line-2475"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#findBndrsDmds"><span class="hs-identifier hs-type">findBndrsDmds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-2476"></span><span class="hs-comment">-- Return the demands on the Ids in the [Var]</span><span>
</span><span id="line-2477"></span><span id="findBndrsDmds"><span class="annot"><span class="annottext">findBndrsDmds :: AnalEnv -&gt; DmdType -&gt; [Id] -&gt; WithDmdType [Demand]
</span><a href="GHC.Core.Opt.DmdAnal.html#findBndrsDmds"><span class="hs-identifier hs-var hs-var">findBndrsDmds</span></a></span></span><span> </span><span id="local-6989586621681827669"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827669"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827670"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827670"><span class="hs-identifier hs-var">dmd_ty</span></a></span></span><span> </span><span id="local-6989586621681827671"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827671"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span>
</span><span id="line-2478"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; [Id] -&gt; WithDmdType [Demand]
</span><a href="#local-6989586621681827672"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827670"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827671"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-2479"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2480"></span><span>    </span><span id="local-6989586621681827672"><span class="annot"><span class="annottext">go :: DmdType -&gt; [Id] -&gt; WithDmdType [Demand]
</span><a href="#local-6989586621681827672"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681827673"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827673"><span class="hs-identifier hs-var">dmd_ty</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; [Demand] -&gt; WithDmdType [Demand]
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827673"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-2481"></span><span>    </span><span class="annot"><a href="#local-6989586621681827672"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681827674"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827674"><span class="hs-identifier hs-var">dmd_ty</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681827675"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827675"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681827676"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827676"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-2482"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827675"><span class="hs-identifier hs-var">b</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827677"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827677"><span class="hs-identifier hs-var">dmd_ty1</span></a></span></span><span> </span><span id="local-6989586621681827678"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827678"><span class="hs-identifier hs-var">dmds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; [Id] -&gt; WithDmdType [Demand]
</span><a href="#local-6989586621681827672"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827674"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827676"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-2483"></span><span>                        </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span id="local-6989586621681827679"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827679"><span class="hs-identifier hs-var">dmd_ty2</span></a></span></span><span> </span><span id="local-6989586621681827680"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827680"><span class="hs-identifier hs-var">dmd</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdType -&gt; Id -&gt; WithDmdType Demand
</span><a href="GHC.Core.Opt.DmdAnal.html#findBndrDmd"><span class="hs-identifier hs-var">findBndrDmd</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827669"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827677"><span class="hs-identifier hs-var">dmd_ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827675"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-2484"></span><span>                    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; [Demand] -&gt; WithDmdType [Demand]
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827679"><span class="hs-identifier hs-var">dmd_ty2</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827680"><span class="hs-identifier hs-var">dmd</span></a></span><span> </span><span class="annot"><span class="annottext">Demand -&gt; [Demand] -&gt; [Demand]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681827678"><span class="hs-identifier hs-var">dmds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2485"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; [Id] -&gt; WithDmdType [Demand]
</span><a href="#local-6989586621681827672"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827674"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681827676"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-2486"></span><span>
</span><span id="line-2487"></span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#findBndrDmd"><span class="hs-identifier hs-type">findBndrDmd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-type">WithDmdType</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span>
</span><span id="line-2488"></span><span class="hs-comment">-- See Note [Trimming a demand to a type]</span><span>
</span><span id="line-2489"></span><span id="findBndrDmd"><span class="annot"><span class="annottext">findBndrDmd :: AnalEnv -&gt; DmdType -&gt; Id -&gt; WithDmdType Demand
</span><a href="GHC.Core.Opt.DmdAnal.html#findBndrDmd"><span class="hs-identifier hs-var hs-var">findBndrDmd</span></a></span></span><span> </span><span id="local-6989586621681827681"><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827681"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681827682"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827682"><span class="hs-identifier hs-var">dmd_ty</span></a></span></span><span> </span><span id="local-6989586621681827683"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827683"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-2490"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;findBndrDmd&quot; (ppr id $$ ppr dmd_ty $$ ppr starting_dmd $$ ppr dmd') $</span><span>
</span><span id="line-2491"></span><span>    </span><span class="annot"><span class="annottext">DmdType -&gt; Demand -&gt; WithDmdType Demand
forall a. DmdType -&gt; a -&gt; WithDmdType a
</span><a href="GHC.Core.Opt.DmdAnal.html#WithDmdType"><span class="hs-identifier hs-var">WithDmdType</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827684"><span class="hs-identifier hs-var">dmd_ty'</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827685"><span class="hs-identifier hs-var">dmd'</span></a></span><span>
</span><span id="line-2492"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-2493"></span><span>    </span><span id="local-6989586621681827685"><span class="annot"><span class="annottext">dmd' :: Demand
</span><a href="#local-6989586621681827685"><span class="hs-identifier hs-var hs-var">dmd'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Demand
</span><a href="#local-6989586621681827686"><span class="hs-identifier hs-var">strictify</span></a></span><span> </span><span class="annot"><span class="annottext">(Demand -&gt; Demand) -&gt; Demand -&gt; Demand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-2494"></span><span>           </span><span class="annot"><span class="annottext">Demand -&gt; TypeShape -&gt; Demand
</span><a href="GHC.Types.Demand.html#trimToType"><span class="hs-identifier hs-var">trimToType</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827688"><span class="hs-identifier hs-var">starting_dmd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FamInstEnvs -&gt; Type -&gt; TypeShape
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#findTypeShape"><span class="hs-identifier hs-var">findTypeShape</span></a></span><span> </span><span class="annot"><span class="annottext">FamInstEnvs
</span><a href="#local-6989586621681827690"><span class="hs-identifier hs-var">fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827691"><span class="hs-identifier hs-var">id_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2495"></span><span>
</span><span id="line-2496"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681827684"><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827684"><span class="hs-identifier hs-var">dmd_ty'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681827688"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827688"><span class="hs-identifier hs-var">starting_dmd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdType -&gt; Id -&gt; (DmdType, Demand)
</span><a href="GHC.Types.Demand.html#peelFV"><span class="hs-identifier hs-var">peelFV</span></a></span><span> </span><span class="annot"><span class="annottext">DmdType
</span><a href="#local-6989586621681827682"><span class="hs-identifier hs-var">dmd_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827683"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-2497"></span><span>
</span><span id="line-2498"></span><span>    </span><span id="local-6989586621681827691"><span class="annot"><span class="annottext">id_ty :: Type
</span><a href="#local-6989586621681827691"><span class="hs-identifier hs-var hs-var">id_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681827683"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-2499"></span><span>
</span><span id="line-2500"></span><span>    </span><span id="local-6989586621681827686"><span class="annot"><span class="annottext">strictify :: Demand -&gt; Demand
</span><a href="#local-6989586621681827686"><span class="hs-identifier hs-var hs-var">strictify</span></a></span></span><span> </span><span id="local-6989586621681827693"><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827693"><span class="hs-identifier hs-var">dmd</span></a></span></span><span>
</span><span id="line-2501"></span><span>      </span><span class="hs-comment">-- See Note [Making dictionary parameters strict]</span><span>
</span><span id="line-2502"></span><span>      </span><span class="hs-comment">-- and Note [Do not strictify a DFun's parameter dictionaries]</span><span>
</span><span id="line-2503"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DmdAnalOpts -&gt; Bool
</span><a href="GHC.Core.Opt.DmdAnal.html#dmd_strict_dicts"><span class="hs-identifier hs-var">dmd_strict_dicts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnalEnv -&gt; DmdAnalOpts
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_opts"><span class="hs-identifier hs-var">ae_opts</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827681"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2504"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Demand -&gt; Demand
</span><a href="GHC.Types.Demand.html#strictifyDictDmd"><span class="hs-identifier hs-var">strictifyDictDmd</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681827691"><span class="hs-identifier hs-var">id_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827693"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-2505"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-2506"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681827693"><span class="hs-identifier hs-var">dmd</span></a></span><span>
</span><span id="line-2507"></span><span>
</span><span id="line-2508"></span><span>    </span><span id="local-6989586621681827690"><span class="annot"><span class="annottext">fam_envs :: FamInstEnvs
</span><a href="#local-6989586621681827690"><span class="hs-identifier hs-var hs-var">fam_envs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnalEnv -&gt; FamInstEnvs
</span><a href="GHC.Core.Opt.DmdAnal.html#ae_fam_envs"><span class="hs-identifier hs-var">ae_fam_envs</span></a></span><span> </span><span class="annot"><span class="annottext">AnalEnv
</span><a href="#local-6989586621681827681"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-2509"></span><span>
</span><span id="line-2510"></span><span class="hs-comment">{- Note [Bringing a new variable into scope]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f x = blah
   g = ...(\f. ...f...)...

In the body of the '\f', any occurrence of `f` refers to the lambda-bound `f`,
not the top-level `f` (which will be in `ae_sigs`).  So it's very important
to delete `f` from `ae_sigs` when we pass a lambda/case/let-up binding of `f`.
Otherwise chaos results (#22718).

Note [Making dictionary parameters strict]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The Opt_DictsStrict flag makes GHC use call-by-value for dictionaries.  Why?

* Generally CBV is more efficient.

* A datatype dictionary is always non-bottom and never takes much work to
  compute.  E.g. a DFun from an instance decl always returns a dictionary
  record immediately.  See DFunUnfolding in CoreSyn.
  See also Note [Recursive superclasses] in TcInstDcls.

See #17758 for more background and perf numbers.

Wrinkles:

* A newtype dictionary is *not* always non-bottom.  E.g.
      class C a where op :: a -&gt; a
      instance C Int where op = error &quot;urk&quot;
  Now a value of type (C Int) is just a newtype wrapper (a cast) around
  the error thunk.  Don't strictify these!

* Strictifying DFuns risks destroying the invariant that DFuns never take much
  work to compute, so we don't do it.
  See Note [Do not strictify a DFun's parameter dictionaries] for details.

* Although worker/wrapper *could* unbox strictly used dictionaries, we do not do
  so; see Note [Do not unbox class dictionaries].

The implementation is extremely simple: just make the strictness
analyser strictify the demand on a dictionary binder in
'findBndrDmd' if the binder does not belong to a DFun.

Note [Do not strictify a DFun's parameter dictionaries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The typechecker can tie recursive knots involving (non-recursive) DFuns, so
we must not strictify a DFun's parameter dictionaries (#22549).
T22549 has an example involving undecidable instances that &lt;&lt;loop&gt;&gt;s when we
strictify the DFun of, e.g., `$fEqSeqT`:

  Main.$fEqSeqT
    = \@m @a ($dEq :: Eq (m (ViewT m a))) ($dMonad :: Monad m) -&gt;
        GHC.Classes.C:Eq @(SeqT m a) ($c== @m @a $dEq $dMonad)
                                     ($c/= @m @a $dEq $dMonad)

  Rec {
    $dEq_a = Main.$fEqSeqT @Identity @Int $dEq_b Main.$fMonadIdentity
    $dEq_b = ... $dEq_a ... &lt;another strict context due to DFun&gt;
  }

If we make `$fEqSeqT` strict in `$dEq`, we'll collapse the Rec group into a
giant, &lt;&lt;loop&gt;&gt;ing thunk.

To prevent that, we never strictify dictionary params when inside a DFun.
That is implemented by unsetting 'dmd_strict_dicts' when entering a DFun.

See also Note [Speculative evaluation] in GHC.CoreToStg.Prep which has a rather
similar example in #20836. We may never speculate *arguments* of (recursive)
DFun calls, likewise we should not mark *formal parameters* of recursive DFuns
as strict.

Note [Initialising strictness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See section 9.2 (Finding fixpoints) of the paper.

Our basic plan is to initialise the strictness of each Id in a
recursive group to &quot;bottom&quot;, and find a fixpoint from there.  However,
this group B might be inside an *enclosing* recursive group A, in
which case we'll do the entire fixpoint shebang on for each iteration
of A. This can be illustrated by the following example:

Example:

  f [] = []
  f (x:xs) = let g []     = f xs
                 g (y:ys) = y+1 : g ys
              in g (h x)

At each iteration of the fixpoint for f, the analyser has to find a
fixpoint for the enclosed function g. In the meantime, the demand
values for g at each iteration for f are *greater* than those we
encountered in the previous iteration for f. Therefore, we can begin
the fixpoint for g not with the bottom value but rather with the
result of the previous analysis. I.e., when beginning the fixpoint
process for g, we can start from the demand signature computed for g
previously and attached to the binding occurrence of g.

To speed things up, we initialise each iteration of A (the enclosing
one) from the result of the last one, which is neatly recorded in each
binder.  That way we make use of earlier iterations of the fixpoint
algorithm. (Cunning plan.)

But on the *first* iteration we want to *ignore* the current strictness
of the Id, and start from &quot;bottom&quot;.  Nowadays the Id can have a current
strictness, because interface files record strictness for nested bindings.
To know when we are in the first iteration, we look at the ae_virgin
field of the AnalEnv.


Note [Final Demand Analyser run]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Some of the information that the demand analyser determines is not always
preserved by the simplifier.  For example, the simplifier will happily rewrite
  \y [Demand=MU] let x = y in x + x
to
  \y [Demand=MU] y + y
which is quite a lie: Now y occurs more than just once.

The once-used information is (currently) only used by the code
generator, though.  So:

 * We zap the used-once info in the worker-wrapper;
   see Note [Zapping Used Once info in WorkWrap] in
   GHC.Core.Opt.WorkWrap.
   If it's not reliable, it's better not to have it at all.

 * Just before TidyCore, we add a pass of the demand analyser,
      but WITHOUT subsequent worker/wrapper and simplifier,
   right before TidyCore.  See SimplCore.getCoreToDo.

   This way, correct information finds its way into the module interface
   (strictness signatures!) and the code generator (single-entry thunks!)

Note that, in contrast, the single-call information (C(M,..)) /can/ be
relied upon, as the simplifier tends to be very careful about not
duplicating actual function calls.

Also see #11731.

Note [Space Leaks in Demand Analysis]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Ticket: #15455
MR: !5399

In the past the result of demand analysis was not forced until the whole module
had finished being analysed. In big programs, this led to a big build up of thunks
which were all ultimately forced at the end of the analysis.

This was because the return type of the analysis was a lazy pair:
  dmdAnal :: AnalEnv -&gt; SubDemand -&gt; CoreExpr -&gt; (DmdType, CoreExpr)
To avoid space leaks we added extra bangs to evaluate the DmdType component eagerly; but
we were never sure we had added enough.
The easiest way to systematically fix this was to use a strict pair type for the
return value of the analysis so that we can be more confident that the result
is incrementally computed rather than all at the end.

A second, only loosely related point is that
the updating of Ids was not forced because the result of updating
an Id was placed into a lazy field in CoreExpr. This meant that until the end of
demand analysis, the unforced Ids would retain the DmdEnv which the demand information
was fetch from. Now we are quite careful to force Ids before putting them
back into core expressions so that we can garbage-collect the environments more eagerly.
For example see the `Case` branch of `dmdAnal'` where `case_bndr'` is forced
or `dmdAnalSumAlt`.

The net result of all these improvements is the peak live memory usage of compiling
jsaddle-dom decreases about 4GB (from 6.5G to 2.5G). A bunch of bytes allocated benchmarks also
decrease because we allocate a lot fewer thunks which we immediately overwrite and
also runtime for the pass is faster! Overall, good wins.

-}</span><span>
</span><span id="line-2681"></span></pre></body></html>