<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1993-1998

\section[WorkWrap]{Worker/wrapper-generating back-end of strictness analyser}
-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Core.Opt.WorkWrap</span><span>
</span><span id="line-9"></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier">WwOpts</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwTopBinds"><span class="hs-identifier">wwTopBinds</span></a></span><span>
</span><span id="line-11"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">where</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unfold.Make.html"><span class="hs-identifier">GHC.Core.Unfold.Make</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier">exprType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#exprIsHNF"><span class="hs-identifier">exprIsHNF</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html"><span class="hs-identifier">GHC.Core.Opt.WorkWrap.Utils</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.SimpleOpt.html"><span class="hs-identifier">GHC.Core.SimpleOpt</span></a></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html"><span class="hs-identifier">GHC.Types.Id.Info</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html"><span class="hs-identifier">GHC.Types.Unique.Supply</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html"><span class="hs-identifier">GHC.Types.Demand</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Cpr.html"><span class="hs-identifier">GHC.Types.Cpr</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SourceText.html"><span class="hs-identifier">GHC.Types.SourceText</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html"><span class="hs-identifier">GHC.Types.Unique</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html"><span class="hs-identifier">GHC.Utils.Panic.Plain</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html"><span class="hs-identifier">GHC.Utils.Monad</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-comment">{-
We take Core bindings whose binders have:

\begin{enumerate}

\item Strictness attached (by the front-end of the strictness
analyser), and / or

\item Constructed Product Result information attached by the CPR
analysis pass.

\end{enumerate}

and we return some ``plain'' bindings which have been
worker/wrapper-ified, meaning:

\begin{enumerate}

\item Functions have been split into workers and wrappers where
appropriate.  If a function has both strictness and CPR properties
then only one worker/wrapper doing both transformations is produced;

\item Binders' @IdInfos@ have been updated to reflect the existence of
these workers/wrappers (this is where we get STRICTNESS and CPR pragma
info for exported values).
\end{enumerate}
-}</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwTopBinds"><span class="hs-identifier hs-type">wwTopBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSupply"><span class="hs-identifier hs-type">UniqSupply</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span id="wwTopBinds"><span class="annot"><span class="annottext">wwTopBinds :: WwOpts -&gt; UniqSupply -&gt; CoreProgram -&gt; CoreProgram
</span><a href="GHC.Core.Opt.WorkWrap.html#wwTopBinds"><span class="hs-identifier hs-var hs-var">wwTopBinds</span></a></span></span><span> </span><span id="local-6989586621681826133"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826133"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span id="local-6989586621681826134"><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621681826134"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span id="local-6989586621681826135"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681826135"><span class="hs-identifier hs-var">top_binds</span></a></span></span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqSupply -&gt; UniqSM CoreProgram -&gt; CoreProgram
forall a. UniqSupply -&gt; UniqSM a -&gt; a
</span><a href="GHC.Types.Unique.Supply.html#initUs_"><span class="hs-identifier hs-var">initUs_</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSupply
</span><a href="#local-6989586621681826134"><span class="hs-identifier hs-var">us</span></a></span><span> </span><span class="annot"><span class="annottext">(UniqSM CoreProgram -&gt; CoreProgram)
-&gt; UniqSM CoreProgram -&gt; CoreProgram
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-72"></span><span>    </span><span id="local-6989586621681826137"><span class="annot"><span class="annottext">[CoreProgram]
</span><a href="#local-6989586621681826137"><span class="hs-identifier hs-var">top_binds'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CoreBind -&gt; UniqSM CoreProgram)
-&gt; CoreProgram -&gt; UniqSM [CoreProgram]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapM/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WwOpts -&gt; CoreBind -&gt; UniqSM CoreProgram
</span><a href="GHC.Core.Opt.WorkWrap.html#wwBind"><span class="hs-identifier hs-var">wwBind</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826133"><span class="hs-identifier hs-var">ww_opts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681826135"><span class="hs-identifier hs-var">top_binds</span></a></span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="annottext">CoreProgram -&gt; UniqSM CoreProgram
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CoreProgram] -&gt; CoreProgram
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#concat/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreProgram]
</span><a href="#local-6989586621681826137"><span class="hs-identifier hs-var">top_binds'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[wwBind-wwExpr]{@wwBind@ and @wwExpr@}
*                                                                      *
************************************************************************

@wwBind@ works on a binding, trying each \tr{(binder, expr)} pair in
turn.  Non-recursive case first, then recursive...
-}</span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwBind"><span class="hs-identifier hs-type">wwBind</span></a></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span>
</span><span id="line-87"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span>
</span><span id="line-88"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- returns a WwBinding intermediate form;</span><span>
</span><span id="line-89"></span><span>                                </span><span class="hs-comment">-- the caller will convert to Expr/Binding,</span><span>
</span><span id="line-90"></span><span>                                </span><span class="hs-comment">-- as appropriate.</span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span id="wwBind"><span class="annot"><span class="annottext">wwBind :: WwOpts -&gt; CoreBind -&gt; UniqSM CoreProgram
</span><a href="GHC.Core.Opt.WorkWrap.html#wwBind"><span class="hs-identifier hs-var hs-var">wwBind</span></a></span></span><span> </span><span id="local-6989586621681826141"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826141"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681826143"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826143"><span class="hs-identifier hs-var">binder</span></a></span></span><span> </span><span id="local-6989586621681826144"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826144"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-93"></span><span>    </span><span id="local-6989586621681826145"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826145"><span class="hs-identifier hs-var">new_rhs</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; CoreExpr -&gt; UniqSM CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826141"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826144"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span id="local-6989586621681826147"><span class="annot"><span class="annottext">[(Var, CoreExpr)]
</span><a href="#local-6989586621681826147"><span class="hs-identifier hs-var">new_pairs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; RecFlag -&gt; Var -&gt; CoreExpr -&gt; UniqSM [(Var, CoreExpr)]
</span><a href="GHC.Core.Opt.WorkWrap.html#tryWW"><span class="hs-identifier hs-var">tryWW</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826141"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826143"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826145"><span class="hs-identifier hs-var">new_rhs</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><span class="annottext">CoreProgram -&gt; UniqSM CoreProgram
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Var -&gt; CoreExpr -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826150"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826151"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681826150"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826150"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681826151"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826151"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)]
</span><a href="#local-6989586621681826147"><span class="hs-identifier hs-var">new_pairs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-96"></span><span>      </span><span class="hs-comment">-- Generated bindings must be non-recursive</span><span>
</span><span id="line-97"></span><span>      </span><span class="hs-comment">-- because the original binding was.</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwBind"><span class="hs-identifier hs-var">wwBind</span></a></span><span> </span><span id="local-6989586621681826152"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826152"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681826154"><span class="annot"><span class="annottext">[(Var, CoreExpr)]
</span><a href="#local-6989586621681826154"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CoreProgram
forall a. a -&gt; [a]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreBind -&gt; CoreProgram)
-&gt; ([(Var, CoreExpr)] -&gt; CoreBind)
-&gt; [(Var, CoreExpr)]
-&gt; CoreProgram
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">([(Var, CoreExpr)] -&gt; CoreProgram)
-&gt; UniqSM [(Var, CoreExpr)] -&gt; UniqSM CoreProgram
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">((Var, CoreExpr) -&gt; UniqSM [(Var, CoreExpr)])
-&gt; [(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall (m :: * -&gt; *) (f :: * -&gt; *) a b.
(Monad m, Traversable f) =&gt;
(a -&gt; m [b]) -&gt; f a -&gt; m [b]
</span><a href="GHC.Utils.Monad.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">(Var, CoreExpr) -&gt; UniqSM [(Var, CoreExpr)]
</span><a href="#local-6989586621681826158"><span class="hs-identifier hs-var">do_one</span></a></span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)]
</span><a href="#local-6989586621681826154"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-102"></span><span>    </span><span id="local-6989586621681826158"><span class="annot"><span class="annottext">do_one :: (Var, CoreExpr) -&gt; UniqSM [(Var, CoreExpr)]
</span><a href="#local-6989586621681826158"><span class="hs-identifier hs-var hs-var">do_one</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681826159"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826159"><span class="hs-identifier hs-var">binder</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681826160"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826160"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621681826161"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826161"><span class="hs-identifier hs-var">new_rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; CoreExpr -&gt; UniqSM CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826152"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826160"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-103"></span><span>                              </span><span class="annot"><span class="annottext">WwOpts -&gt; RecFlag -&gt; Var -&gt; CoreExpr -&gt; UniqSM [(Var, CoreExpr)]
</span><a href="GHC.Core.Opt.WorkWrap.html#tryWW"><span class="hs-identifier hs-var">tryWW</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826152"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="GHC.Types.Basic.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826159"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826161"><span class="hs-identifier hs-var">new_rhs</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-comment">{-
@wwExpr@ basically just walks the tree, looking for appropriate
annotations that can be used. Remember it is @wwBind@ that does the
matching by looking for strict arguments of the correct type.
@wwExpr@ is a version that just returns the ``Plain'' Tree.
-}</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-type">wwExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span id="wwExpr"><span class="annot"><span class="annottext">wwExpr :: WwOpts -&gt; CoreExpr -&gt; UniqSM CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var hs-var">wwExpr</span></a></span></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681826163"><span class="annot"><span class="annottext">e :: CoreExpr
</span><a href="#local-6989586621681826163"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; UniqSM CoreExpr
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826163"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-115"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681826165"><span class="annot"><span class="annottext">e :: CoreExpr
</span><a href="#local-6989586621681826165"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; UniqSM CoreExpr
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826165"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-116"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681826167"><span class="annot"><span class="annottext">e :: CoreExpr
</span><a href="#local-6989586621681826167"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; UniqSM CoreExpr
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826167"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-117"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681826169"><span class="annot"><span class="annottext">e :: CoreExpr
</span><a href="#local-6989586621681826169"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; UniqSM CoreExpr
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826169"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span id="local-6989586621681826171"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826171"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681826173"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826173"><span class="hs-identifier hs-var">binder</span></a></span></span><span> </span><span id="local-6989586621681826174"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826174"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; CoreExpr -&gt; CoreExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826175"><span class="hs-identifier hs-var">new_binder</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; UniqSM CoreExpr -&gt; UniqSM CoreExpr
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; CoreExpr -&gt; UniqSM CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826171"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826174"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681826175"><span class="annot"><span class="annottext">new_binder :: Var
</span><a href="#local-6989586621681826175"><span class="hs-identifier hs-var hs-var">new_binder</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826173"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="GHC.Types.Id.html#zapIdUsedOnceInfo"><span class="hs-identifier hs-var">zapIdUsedOnceInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826173"><span class="hs-identifier hs-var">binder</span></a></span><span>
</span><span id="line-122"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826173"><span class="hs-identifier hs-var">binder</span></a></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-comment">-- See Note [Zapping Used Once info in WorkWrap]</span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span id="local-6989586621681826178"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826178"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681826180"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826180"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621681826181"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826181"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr -&gt; CoreExpr
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr -&gt; CoreExpr)
-&gt; UniqSM CoreExpr -&gt; UniqSM (CoreExpr -&gt; CoreExpr)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; CoreExpr -&gt; UniqSM CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826178"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826180"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSM (CoreExpr -&gt; CoreExpr) -&gt; UniqSM CoreExpr -&gt; UniqSM CoreExpr
forall a b. UniqSM (a -&gt; b) -&gt; UniqSM a -&gt; UniqSM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3C%2A%3E/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; CoreExpr -&gt; UniqSM CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826178"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826181"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span id="local-6989586621681826182"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826182"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621681826184"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681826184"><span class="hs-identifier hs-var">note</span></a></span></span><span> </span><span id="local-6989586621681826185"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826185"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; CoreExpr -&gt; CoreExpr
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681826184"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr) -&gt; UniqSM CoreExpr -&gt; UniqSM CoreExpr
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; CoreExpr -&gt; UniqSM CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826182"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826185"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span id="local-6989586621681826186"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826186"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681826188"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826188"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621681826189"><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621681826189"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-132"></span><span>    </span><span id="local-6989586621681826190"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826190"><span class="hs-identifier hs-var">new_expr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; CoreExpr -&gt; UniqSM CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826186"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826188"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span class="annot"><span class="annottext">CoreExpr -&gt; UniqSM CoreExpr
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoercionR -&gt; CoreExpr
forall b. Expr b -&gt; CoercionR -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826190"><span class="hs-identifier hs-var">new_expr</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionR
</span><a href="#local-6989586621681826189"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span id="local-6989586621681826191"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826191"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621681826193"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681826193"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621681826194"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826194"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreProgram -&gt; CoreExpr -&gt; CoreExpr
forall b. [Bind b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLets"><span class="hs-identifier hs-var">mkLets</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreProgram -&gt; CoreExpr -&gt; CoreExpr)
-&gt; UniqSM CoreProgram -&gt; UniqSM (CoreExpr -&gt; CoreExpr)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; CoreBind -&gt; UniqSM CoreProgram
</span><a href="GHC.Core.Opt.WorkWrap.html#wwBind"><span class="hs-identifier hs-var">wwBind</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826191"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681826193"><span class="hs-identifier hs-var">bind</span></a></span><span> </span><span class="annot"><span class="annottext">UniqSM (CoreExpr -&gt; CoreExpr) -&gt; UniqSM CoreExpr -&gt; UniqSM CoreExpr
forall a b. UniqSM (a -&gt; b) -&gt; UniqSM a -&gt; UniqSM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3C%2A%3E/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; CoreExpr -&gt; UniqSM CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826191"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826194"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span id="local-6989586621681826196"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826196"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621681826198"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826198"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621681826199"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826199"><span class="hs-identifier hs-var">binder</span></a></span></span><span> </span><span id="local-6989586621681826200"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681826200"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681826201"><span class="annot"><span class="annottext">[Alt Var]
</span><a href="#local-6989586621681826201"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-139"></span><span>    </span><span id="local-6989586621681826202"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826202"><span class="hs-identifier hs-var">new_expr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; CoreExpr -&gt; UniqSM CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826196"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826198"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span id="local-6989586621681826203"><span class="annot"><span class="annottext">[Alt Var]
</span><a href="#local-6989586621681826203"><span class="hs-identifier hs-var">new_alts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Alt Var -&gt; UniqSM (Alt Var)) -&gt; [Alt Var] -&gt; UniqSM [Alt Var]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapM/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">Alt Var -&gt; UniqSM (Alt Var)
</span><a href="#local-6989586621681826204"><span class="hs-identifier hs-var">ww_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Var]
</span><a href="#local-6989586621681826201"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681826205"><span class="annot"><span class="annottext">new_binder :: Var
</span><a href="#local-6989586621681826205"><span class="hs-identifier hs-var hs-var">new_binder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="GHC.Types.Id.html#zapIdUsedOnceInfo"><span class="hs-identifier hs-var">zapIdUsedOnceInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826199"><span class="hs-identifier hs-var">binder</span></a></span><span>
</span><span id="line-142"></span><span>      </span><span class="hs-comment">-- See Note [Zapping Used Once info in WorkWrap]</span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><span class="annottext">CoreExpr -&gt; UniqSM CoreExpr
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Var -&gt; Type -&gt; [Alt Var] -&gt; CoreExpr
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826202"><span class="hs-identifier hs-var">new_expr</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826205"><span class="hs-identifier hs-var">new_binder</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681826200"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt Var]
</span><a href="#local-6989586621681826203"><span class="hs-identifier hs-var">new_alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-145"></span><span>    </span><span id="local-6989586621681826204"><span class="annot"><span class="annottext">ww_alt :: Alt Var -&gt; UniqSM (Alt Var)
</span><a href="#local-6989586621681826204"><span class="hs-identifier hs-var hs-var">ww_alt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621681826207"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681826207"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621681826208"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681826208"><span class="hs-identifier hs-var">binders</span></a></span></span><span> </span><span id="local-6989586621681826209"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826209"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>        </span><span id="local-6989586621681826210"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826210"><span class="hs-identifier hs-var">new_rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; CoreExpr -&gt; UniqSM CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826196"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826209"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-147"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681826211"><span class="annot"><span class="annottext">new_binders :: [Var]
</span><a href="#local-6989586621681826211"><span class="hs-identifier hs-var hs-var">new_binders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826212"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="GHC.Types.Id.html#zapIdUsedOnceInfo"><span class="hs-identifier hs-var">zapIdUsedOnceInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826212"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826212"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-148"></span><span>                          </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681826212"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826212"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681826208"><span class="hs-identifier hs-var">binders</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-149"></span><span>           </span><span class="hs-comment">-- See Note [Zapping Used Once info in WorkWrap]</span><span>
</span><span id="line-150"></span><span>        </span><span class="annot"><span class="annottext">Alt Var -&gt; UniqSM (Alt Var)
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AltCon -&gt; [Var] -&gt; CoreExpr -&gt; Alt Var
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681826207"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681826211"><span class="hs-identifier hs-var">new_binders</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826210"><span class="hs-identifier hs-var">new_rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[tryWW]{@tryWW@: attempt a worker/wrapper pair}
*                                                                      *
************************************************************************

@tryWW@ just accumulates arguments, converts strictness info from the
front-end into the proper form, then calls @mkWwBodies@ to do
the business.

The only reason this is monadised is for the unique supply.

Note [Don't w/w INLINE things]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's very important to refrain from w/w-ing an INLINE function (ie one
with a stable unfolding) because the wrapper will then overwrite the
old stable unfolding with the wrapper code.

Furthermore, if the programmer has marked something as INLINE,
we may lose by w/w'ing it.

If the strictness analyser is run twice, this test also prevents
wrappers (which are INLINEd) from being re-done.  (You can end up with
several liked-named Ids bouncing around at the same time---absolute
mischief.)

Notice that we refrain from w/w'ing an INLINE function even if it is
in a recursive group.  It might not be the loop breaker.  (We could
test for loop-breaker-hood, but I'm not sure that ever matters.)

Note [Worker/wrapper for INLINABLE functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have
  {-# INLINABLE f #-}
  f :: Ord a =&gt; [a] -&gt; Int -&gt; a
  f x y = ....f....

where f is strict in y, we might get a more efficient loop by w/w'ing
f.  But that would make a new unfolding which would overwrite the old
one! So the function would no longer be INLINABLE, and in particular
will not be specialised at call sites in other modules.

This comes up in practice (#6056).

Solution:

* Do the w/w for strictness analysis, even for INLINABLE functions

* Transfer the Stable unfolding to the *worker*.  How do we &quot;transfer
  the unfolding&quot;? Easy: by using the old one, wrapped in work_fn! See
  GHC.Core.Unfold.Make.mkWorkerUnfolding.

* We use the /original, user-specified/ function's InlineSpec pragma
  for both the wrapper and the worker (see `mkStrWrapperInlinePrag`).
  So if f is INLINEABLE, both worker and wrapper will get an InlineSpec
  of (Inlinable &quot;blah&quot;).

  It's important that both get this, because the specialiser uses
  the existence of a /user-specified/ INLINE/INLINABLE pragma to
  drive specialisation of imported functions.  See  GHC.Core.Opt.Specialise
  Note [Specialising imported functions]

* Remember, the subsequent inlining behaviour of the wrapper is expressed by
  (a) the stable unfolding
  (b) the unfolding guidance of UnfWhen
  (c) the inl_act activation (see Note [Wrapper activation]

For our {-# INLINEABLE f #-} example above, we will get something a
bit like like this:

  {-# Has stable unfolding, active in phase 2;
      plus InlineSpec = INLINEABLE #-}
  f :: Ord a =&gt; [a] -&gt; Int -&gt; a
  f d x y = case y of I# y' -&gt; fw d x y'

  {-# Has stable unfolding, plus InlineSpec = INLINEABLE #-}
  fw :: Ord a =&gt; [a] -&gt; Int# -&gt; a
  fw d x y' = let y = I# y' in ...f...


(Historical note: we used to always give the wrapper an INLINE pragma,
but CSE will not happen if there is a user-specified pragma, but
should happen for w/w&#8217;ed things (#14186).  But now we simply propagate
any user-defined pragma info, so we'll defeat CSE (rightly) only when
there is a user-supplied INLINE/INLINEABLE pragma.)

Note [No worker/wrapper for record selectors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We sometimes generate a lot of record selectors, and generally the
don't benefit from worker/wrapper.  Yes, mkWwBodies would find a w/w split,
but it is then suppressed by the certainlyWillInline test in splitFun.

The wasted effort in mkWwBodies makes a measurable difference in
compile time (see MR !2873), so although it's a terribly ad-hoc test,
we just check here for record selectors, and do a no-op in that case.

I did look for a generalisation, so that it's not just record
selectors that benefit.  But you'd need a cheap test for &quot;this
function will definitely get a w/w split&quot; and that's hard to predict
in advance...the logic in mkWwBodies is complex. So I've left the
super-simple test, with this Note to explain.

NB: record selectors are ordinary functions, inlined iff GHC wants to,
so won't be caught by the preceding isInlineUnfolding test in tryWW.

Note [Worker/wrapper for NOINLINE functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used to disable worker/wrapper for NOINLINE things, but it turns out
this can cause unnecessary reboxing of values. Consider

  {-# NOINLINE f #-}
  f :: Int -&gt; a
  f x = error (show x)

  g :: Bool -&gt; Bool -&gt; Int -&gt; Int
  g True  True  p = f p
  g False True  p = p + 1
  g b     False p = g b True p

the strictness analysis will discover f and g are strict, but because f
has no wrapper, the worker for g will rebox p. So we get

  $wg x y p# =
    let p = I# p# in  -- Yikes! Reboxing!
    case x of
      False -&gt;
        case y of
          False -&gt; $wg False True p#
          True -&gt; +# p# 1#
      True -&gt;
        case y of
          False -&gt; $wg True True p#
          True -&gt; case f p of { }

  g x y p = case p of (I# p#) -&gt; $wg x y p#

Now, in this case the reboxing will float into the True branch, and so
the allocation will only happen on the error path. But it won't float
inwards if there are multiple branches that call (f p), so the reboxing
will happen on every call of g. Disaster.

Solution: do worker/wrapper even on NOINLINE things; but move the
NOINLINE pragma to the worker.

(See #13143 for a real-world example.)

It is crucial that we do this for *all* NOINLINE functions. #10069
demonstrates what happens when we promise to w/w a (NOINLINE) leaf
function, but fail to deliver:

  data C = C Int# Int#

  {-# NOINLINE c1 #-}
  c1 :: C -&gt; Int#
  c1 (C _ n) = n

  {-# NOINLINE fc #-}
  fc :: C -&gt; Int#
  fc c = 2 *# c1 c

Failing to w/w `c1`, but still w/wing `fc` leads to the following code:

  c1 :: C -&gt; Int#
  c1 (C _ n) = n

  $wfc :: Int# -&gt; Int#
  $wfc n = let c = C 0# n in 2 #* c1 c

  fc :: C -&gt; Int#
  fc (C _ n) = $wfc n

Yikes! The reboxed `C` in `$wfc` can't cancel out, so we are in a bad place.
This generalises to any function that derives its strictness signature from
its callees, so we have to make sure that when a function announces particular
strictness properties, we have to w/w them accordingly, even if it means
splitting a NOINLINE function.

Note [Worker activation]
~~~~~~~~~~~~~~~~~~~~~~~~
Follows on from Note [Worker/wrapper for INLINABLE functions]

It is *vital* that if the worker gets an INLINABLE pragma (from the
original function), then the worker has the same phase activation as
the wrapper (or later).  That is necessary to allow the wrapper to
inline into the worker's unfolding: see GHC.Core.Opt.Simplify.Utils
Note [Simplifying inside stable unfoldings].

If the original is NOINLINE, it's important that the worker inherits the
original activation. Consider

  {-# NOINLINE expensive #-}
  expensive x = x + 1

  f y = let z = expensive y in ...

If expensive's worker inherits the wrapper's activation,
we'll get this (because of the compromise in point (2) of
Note [Wrapper activation])

  {-# NOINLINE[Final] $wexpensive #-}
  $wexpensive x = x + 1
  {-# INLINE[Final] expensive #-}
  expensive x = $wexpensive x

  f y = let z = expensive y in ...

and $wexpensive will be immediately inlined into expensive, followed by
expensive into f. This effectively removes the original NOINLINE!

Otherwise, nothing is lost by giving the worker the same activation as the
wrapper, because the worker won't have any chance of inlining until the
wrapper does; there's no point in giving it an earlier activation.

Note [Don't w/w inline small non-loop-breaker things]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general, we refrain from w/w-ing *small* functions, which are not
loop breakers, because they'll inline anyway.  But we must take care:
it may look small now, but get to be big later after other inlining
has happened.  So we take the precaution of adding a StableUnfolding
for any such functions.

I made this change when I observed a big function at the end of
compilation with a useful strictness signature but no w-w.  (It was
small during demand analysis, we refrained from w/w, and then got big
when something was inlined in its rhs.) When I measured it on nofib,
it didn't make much difference; just a few percent improved allocation
on one benchmark (bspt/Euclid.space).  But nothing got worse.

There is an infelicity though.  We may get something like
      f = g val
==&gt;
      g x = case gw x of r -&gt; I# r

      f {- InlineStable, Template = g val -}
      f = case gw x of r -&gt; I# r

The code for f duplicates that for g, without any real benefit. It
won't really be executed, because calls to f will go via the inlining.

Note [Don't w/w join points for CPR]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There's no point in exploiting CPR info on a join point. If the whole function
is getting CPR'd, then the case expression around the worker function will get
pushed into the join point by the simplifier, which will have the same effect
that w/w'ing for CPR would have - the result will be returned in an unboxed
tuple.

  f z = let join j x y = (x+1, y+1)
        in case z of A -&gt; j 1 2
                     B -&gt; j 2 3

  =&gt;

  f z = case $wf z of (# a, b #) -&gt; (a, b)
  $wf z = case (let join j x y = (x+1, y+1)
                in case z of A -&gt; j 1 2
                             B -&gt; j 2 3) of (a, b) -&gt; (# a, b #)

  =&gt;

  f z = case $wf z of (# a, b #) -&gt; (a, b)
  $wf z = let join j x y = (# x+1, y+1 #)
          in case z of A -&gt; j 1 2
                       B -&gt; j 2 3

Note that we still want to give `j` the CPR property, so that `f` has it. So
CPR *analyse* join points as regular functions, but don't *transform* them.

We could retain the CPR /signature/ on the worker after W/W, but it would
become outright wrong if the Simplifier pushes a non-trivial continuation
into it. For example:
    case (let $j x = (x,x) in ...) of alts
    ==&gt;
    let $j x = case (x,x) of alts in case ... of alts
Before pushing the case in, `$j` has the CPR property, but not afterwards.

So we simply zap the CPR signature for join pints as part of the W/W pass.
The signature served its purpose during CPR analysis in propagating the
CPR property of `$j`.

Doing W/W for returned products on a join point would be tricky anyway, as the
worker could not be a join point because it would not be tail-called. However,
doing the *argument* part of W/W still works for join points, since the wrapper
body will make a tail call:

  f z = let join j x y = x + y
        in ...

  =&gt;

  f z = let join $wj x# y# = x# +# y#
                 j x y = case x of I# x# -&gt;
                         case y of I# y# -&gt;
                         $wj x# y#
        in ...

Note [Wrapper activation]
~~~~~~~~~~~~~~~~~~~~~~~~~
When should the wrapper inlining be active?

1. It must not be active earlier than the current Activation of the Id,
   because we must give rewrite rules mentioning the wrapper and
   specialisation a chance to fire.
   See Note [Worker/wrapper for INLINABLE functions]
   and Note [Worker activation]

2. It should be active at some point, despite (1) because of
   Note [Worker/wrapper for NOINLINE functions]

3. For ordinary functions with no pragmas we want to inline the
   wrapper as early as possible (#15056).  Suppose another module
   defines    f !x xs = ... foldr k z xs ...
   and suppose we have the usual foldr/build RULE.  Then if we have
   a call `f x [1..x]`, we'd expect to inline f and the RULE will fire.
   But if f is w/w'd (which it might be), we want the inlining to
   occur just as if it hadn't been.

   (This only matters if f's RHS is big enough to w/w, but small
   enough to inline given the call site, but that can happen.)

4. We do not want to inline the wrapper before specialisation.
         module Foo where
           f :: Num a =&gt; a -&gt; Int -&gt; a
           f n 0 = n              -- Strict in the Int, hence wrapper
           f n x = f (n+n) (x-1)

           g :: Int -&gt; Int
           g x = f x x            -- Provokes a specialisation for f

         module Bar where
           import Foo

           h :: Int -&gt; Int
           h x = f 3 x

   In module Bar we want to give specialisations a chance to fire
   before inlining f's wrapper.

   (Historical note: At one stage I tried making the wrapper inlining
   always-active, and that had a very bad effect on nofib/imaginary/x2n1;
   a wrapper was inlined before the specialisation fired.)

4a. If we have
      {-# SPECIALISE foo :: (Int,Int) -&gt; Bool -&gt; Int #-}
      {-# NOINLINE [n] foo #-}
    then specialisation will generate a SPEC rule active from Phase n.
    See Note [Auto-specialisation and RULES] in GHC.Core.Opt.Specialise
    This SPEC specialisation rule will compete with inlining, but we don't
    mind that, because if inlining succeeds, it should be better.

    Now, if we w/w foo, we must ensure that the wrapper (which is very
    keen to inline) has a phase /after/ 'n', else it'll always &quot;win&quot; over
    the SPEC rule -- disaster (#20709).

Conclusion: the activation for the wrapper should be the /later/ of
  (a) the current activation of the function, or FinalPhase if it is NOINLINE
  (b) one phase /after/ the activation of any rules
This is implemented by mkStrWrapperInlinePrag.

Reminder: Note [Don't w/w INLINE things], so we don't need to worry
          about INLINE things here.


What if `foo` has no specialisations, is worker/wrappered (with the
wrapper inlining very early), and exported; and then in an importing
module we have {-# SPECIALISE foo : ... #-}?

Well then, we'll specialise foo's wrapper, which will expose a
specialisation for foo's worker, which we will do too.  That seems
fine.  (To work reliably, `foo` would need an INLINABLE pragma,
in which case we don't unpack dictionaries for the worker; see
see Note [Do not unbox class dictionaries].)

Note [Drop absent bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (#19824):
   let t = ...big...
   in ...(f t x)...

were `f` ignores its first argument.  With luck f's wrapper will inline
thereby dropping `t`, but maybe not: the arguments to f all look boring.

So we pre-empt the problem by replacing t's RHS with an absent filler.
Simple and effective.
-}</span><span>
</span><span id="line-538"></span><span>
</span><span id="line-539"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#tryWW"><span class="hs-identifier hs-type">tryWW</span></a></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span>
</span><span id="line-540"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span>
</span><span id="line-541"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>                           </span><span class="hs-comment">-- The fn binder</span><span>
</span><span id="line-542"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span>                     </span><span class="hs-comment">-- The bound rhs; its innards</span><span>
</span><span id="line-543"></span><span>                                        </span><span class="hs-comment">--   are already ww'd</span><span>
</span><span id="line-544"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- either *one* or *two* pairs;</span><span>
</span><span id="line-545"></span><span>                                        </span><span class="hs-comment">-- if one, then no worker (only</span><span>
</span><span id="line-546"></span><span>                                        </span><span class="hs-comment">-- the orig &quot;wrapper&quot; lives on);</span><span>
</span><span id="line-547"></span><span>                                        </span><span class="hs-comment">-- if two, then a worker and a</span><span>
</span><span id="line-548"></span><span>                                        </span><span class="hs-comment">-- wrapper.</span><span>
</span><span id="line-549"></span><span id="tryWW"><span class="annot"><span class="annottext">tryWW :: WwOpts -&gt; RecFlag -&gt; Var -&gt; CoreExpr -&gt; UniqSM [(Var, CoreExpr)]
</span><a href="GHC.Core.Opt.WorkWrap.html#tryWW"><span class="hs-identifier hs-var hs-var">tryWW</span></a></span></span><span> </span><span id="local-6989586621681826214"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826214"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span id="local-6989586621681826215"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681826215"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621681826216"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826216"><span class="hs-identifier hs-var">fn_id</span></a></span></span><span> </span><span id="local-6989586621681826217"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826217"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-550"></span><span>  </span><span class="hs-comment">-- See Note [Drop absent bindings]</span><span>
</span><span id="line-551"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#isAbsDmd"><span class="hs-identifier hs-var">isAbsDmd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; Demand
</span><a href="GHC.Types.Id.Info.html#demandInfo"><span class="hs-identifier hs-var">demandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826220"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-552"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826216"><span class="hs-identifier hs-var">fn_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681826223"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826223"><span class="hs-identifier hs-var">filler</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; Var -&gt; StrictnessMark -&gt; Maybe CoreExpr
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkAbsentFiller"><span class="hs-identifier hs-var">mkAbsentFiller</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826214"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826216"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-var">NotMarkedStrict</span></a></span><span>
</span><span id="line-554"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826226"><span class="hs-identifier hs-var">new_fn_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826223"><span class="hs-identifier hs-var">filler</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-555"></span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-comment">-- See Note [Don't w/w INLINE things]</span><span>
</span><span id="line-557"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Bool
</span><a href="GHC.Types.Id.Info.html#hasInlineUnfolding"><span class="hs-identifier hs-var">hasInlineUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826220"><span class="hs-identifier hs-var">fn_info</span></a></span><span>
</span><span id="line-558"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826226"><span class="hs-identifier hs-var">new_fn_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826217"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-559"></span><span>
</span><span id="line-560"></span><span>  </span><span class="hs-comment">-- See Note [No worker/wrapper for record selectors]</span><span>
</span><span id="line-561"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Id.html#isRecordSelector"><span class="hs-identifier hs-var">isRecordSelector</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826216"><span class="hs-identifier hs-var">fn_id</span></a></span><span>
</span><span id="line-562"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826226"><span class="hs-identifier hs-var">new_fn_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826217"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span>  </span><span class="hs-comment">-- Don't w/w OPAQUE things</span><span>
</span><span id="line-565"></span><span>  </span><span class="hs-comment">-- See Note [OPAQUE pragma]</span><span>
</span><span id="line-566"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-567"></span><span>  </span><span class="hs-comment">-- Whilst this check might seem superfluous, since we strip boxity</span><span>
</span><span id="line-568"></span><span>  </span><span class="hs-comment">-- information in GHC.Core.Opt.DmdAnal.finaliseArgBoxities and</span><span>
</span><span id="line-569"></span><span>  </span><span class="hs-comment">-- CPR information in GHC.Core.Opt.CprAnal.cprAnalBind, it actually</span><span>
</span><span id="line-570"></span><span>  </span><span class="hs-comment">-- isn't. That is because we would still perform w/w when:</span><span>
</span><span id="line-571"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-572"></span><span>  </span><span class="hs-comment">-- - An argument is used strictly, and -fworker-wrapper-cbv is</span><span>
</span><span id="line-573"></span><span>  </span><span class="hs-comment">--   enabled, or,</span><span>
</span><span id="line-574"></span><span>  </span><span class="hs-comment">-- - When demand analysis marks an argument as absent.</span><span>
</span><span id="line-575"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-576"></span><span>  </span><span class="hs-comment">-- In a debug build we do assert that boxity and CPR information</span><span>
</span><span id="line-577"></span><span>  </span><span class="hs-comment">-- are actually stripped, since we want to prevent callers of OPAQUE</span><span>
</span><span id="line-578"></span><span>  </span><span class="hs-comment">-- things to do reboxing. See:</span><span>
</span><span id="line-579"></span><span>  </span><span class="hs-comment">-- - Note [The OPAQUE pragma and avoiding the reboxing of arguments]</span><span>
</span><span id="line-580"></span><span>  </span><span class="hs-comment">-- - Note [The OPAQUE pragma and avoiding the reboxing of results]</span><span>
</span><span id="line-581"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">InlinePragma -&gt; Bool
</span><a href="GHC.Types.Basic.html#isOpaquePragma"><span class="hs-identifier hs-var">isOpaquePragma</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; InlinePragma
</span><a href="GHC.Types.Id.Info.html#inlinePragInfo"><span class="hs-identifier hs-var">inlinePragInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826220"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-582"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc -&gt; UniqSM [(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DmdSig -&gt; Bool
</span><a href="GHC.Types.Demand.html#onlyBoxedArguments"><span class="hs-identifier hs-var">onlyBoxedArguments</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; DmdSig
</span><a href="GHC.Types.Id.Info.html#dmdSigInfo"><span class="hs-identifier hs-var">dmdSigInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826220"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>
</span><span id="line-583"></span><span>               </span><span class="annot"><span class="annottext">CprSig -&gt; Bool
</span><a href="GHC.Types.Cpr.html#isTopCprSig"><span class="hs-identifier hs-var">isTopCprSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; CprSig
</span><a href="GHC.Types.Id.Info.html#cprSigInfo"><span class="hs-identifier hs-var">cprSigInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826220"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;OPAQUE fun with boxity&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-585"></span><span>               </span><span class="annot"><span class="annottext">Var -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826226"><span class="hs-identifier hs-var">new_fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-586"></span><span>               </span><span class="annot"><span class="annottext">DmdSig -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; DmdSig
</span><a href="GHC.Types.Id.Info.html#dmdSigInfo"><span class="hs-identifier hs-var">dmdSigInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826220"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-587"></span><span>               </span><span class="annot"><span class="annottext">CprSig -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; CprSig
</span><a href="GHC.Types.Id.Info.html#cprSigInfo"><span class="hs-identifier hs-var">cprSigInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826220"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span>
</span><span id="line-588"></span><span>               </span><span class="annot"><span class="annottext">CoreExpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826217"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM [(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)])
-&gt; UniqSM [(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-589"></span><span>    </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826226"><span class="hs-identifier hs-var">new_fn_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826217"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-590"></span><span>
</span><span id="line-591"></span><span>  </span><span class="hs-comment">-- Do this even if there is a NOINLINE pragma</span><span>
</span><span id="line-592"></span><span>  </span><span class="hs-comment">-- See Note [Worker/wrapper for NOINLINE functions]</span><span>
</span><span id="line-593"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681826240"><span class="hs-identifier hs-var">is_fun</span></a></span><span>
</span><span id="line-594"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; Var -&gt; CoreExpr -&gt; UniqSM [(Var, CoreExpr)]
</span><a href="GHC.Core.Opt.WorkWrap.html#splitFun"><span class="hs-identifier hs-var">splitFun</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826214"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826226"><span class="hs-identifier hs-var">new_fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826217"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span>  </span><span class="hs-comment">-- See Note [Thunk splitting]</span><span>
</span><span id="line-597"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RecFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isNonRec"><span class="hs-identifier hs-var">isNonRec</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681826215"><span class="hs-identifier hs-var">is_rec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681826243"><span class="hs-identifier hs-var">is_thunk</span></a></span><span>
</span><span id="line-598"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; RecFlag -&gt; Var -&gt; CoreExpr -&gt; UniqSM [(Var, CoreExpr)]
</span><a href="GHC.Core.Opt.WorkWrap.html#splitThunk"><span class="hs-identifier hs-var">splitThunk</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826214"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681826215"><span class="hs-identifier hs-var">is_rec</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826226"><span class="hs-identifier hs-var">new_fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826217"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-599"></span><span>
</span><span id="line-600"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-601"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826226"><span class="hs-identifier hs-var">new_fn_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826217"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-602"></span><span>
</span><span id="line-603"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-604"></span><span>    </span><span id="local-6989586621681826220"><span class="annot"><span class="annottext">fn_info :: IdInfo
</span><a href="#local-6989586621681826220"><span class="hs-identifier hs-var hs-var">fn_info</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Var -&gt; IdInfo
Var -&gt; IdInfo
</span><a href="GHC.Types.Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826216"><span class="hs-identifier hs-var">fn_id</span></a></span><span>
</span><span id="line-605"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681826246"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681826246"><span class="hs-identifier hs-var">wrap_dmds</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Divergence
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; ([Demand], Divergence)
</span><a href="GHC.Types.Demand.html#splitDmdSig"><span class="hs-identifier hs-var">splitDmdSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; DmdSig
</span><a href="GHC.Types.Id.Info.html#dmdSigInfo"><span class="hs-identifier hs-var">dmdSigInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826220"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>    </span><span id="local-6989586621681826226"><span class="annot"><span class="annottext">new_fn_id :: Var
</span><a href="#local-6989586621681826226"><span class="hs-identifier hs-var hs-var">new_fn_id</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="#local-6989586621681826248"><span class="hs-identifier hs-var">zap_join_cpr</span></a></span><span> </span><span class="annot"><span class="annottext">(Var -&gt; Var) -&gt; Var -&gt; Var
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="#local-6989586621681826249"><span class="hs-identifier hs-var">zap_usage</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826216"><span class="hs-identifier hs-var">fn_id</span></a></span><span>
</span><span id="line-607"></span><span>
</span><span id="line-608"></span><span>    </span><span id="local-6989586621681826249"><span class="annot"><span class="annottext">zap_usage :: Var -&gt; Var
</span><a href="#local-6989586621681826249"><span class="hs-identifier hs-var hs-var">zap_usage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="GHC.Types.Id.html#zapIdUsedOnceInfo"><span class="hs-identifier hs-var">zapIdUsedOnceInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(Var -&gt; Var) -&gt; (Var -&gt; Var) -&gt; Var -&gt; Var
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="GHC.Types.Id.html#zapIdUsageEnvInfo"><span class="hs-identifier hs-var">zapIdUsageEnvInfo</span></a></span><span>
</span><span id="line-609"></span><span>        </span><span class="hs-comment">-- See Note [Zapping DmdEnv after Demand Analyzer] and</span><span>
</span><span id="line-610"></span><span>        </span><span class="hs-comment">-- See Note [Zapping Used Once info in WorkWrap]</span><span>
</span><span id="line-611"></span><span>
</span><span id="line-612"></span><span>    </span><span id="local-6989586621681826248"><span class="annot"><span class="annottext">zap_join_cpr :: Var -&gt; Var
</span><a href="#local-6989586621681826248"><span class="hs-identifier hs-var hs-var">zap_join_cpr</span></a></span></span><span> </span><span id="local-6989586621681826251"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826251"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-613"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826251"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826251"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; CprSig -&gt; Var
</span><a href="GHC.Types.Id.html#setIdCprSig"><span class="hs-operator hs-var">`setIdCprSig`</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="GHC.Types.Cpr.html#topCprSig"><span class="hs-identifier hs-var">topCprSig</span></a></span><span>
</span><span id="line-614"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826251"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-615"></span><span>        </span><span class="hs-comment">-- See Note [Don't w/w join points for CPR]</span><span>
</span><span id="line-616"></span><span>
</span><span id="line-617"></span><span>    </span><span id="local-6989586621681826240"><span class="annot"><span class="annottext">is_fun :: Bool
</span><a href="#local-6989586621681826240"><span class="hs-identifier hs-var hs-var">is_fun</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; Bool
forall (f :: * -&gt; *) a. Foldable f =&gt; f a -&gt; Bool
</span><a href="GHC.Utils.Misc.html#notNull"><span class="hs-identifier hs-var">notNull</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681826246"><span class="hs-identifier hs-var">wrap_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826216"><span class="hs-identifier hs-var">fn_id</span></a></span><span>
</span><span id="line-618"></span><span>    </span><span id="local-6989586621681826243"><span class="annot"><span class="annottext">is_thunk :: Bool
</span><a href="#local-6989586621681826243"><span class="hs-identifier hs-var hs-var">is_thunk</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681826240"><span class="hs-identifier hs-var">is_fun</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826217"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826216"><span class="hs-identifier hs-var">fn_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>                            </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Type -&gt; Bool
Type -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826216"><span class="hs-identifier hs-var">fn_id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-620"></span><span>
</span><span id="line-621"></span><span class="hs-comment">{-
Note [Zapping DmdEnv after Demand Analyzer]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In the worker-wrapper pass we zap the DmdEnv.  Why?
 (a) it is never used again
 (b) it wastes space
 (c) it becomes incorrect as things are cloned, because
     we don't push the substitution into it

Why here?
 * Because we don&#8217;t want to do it in the Demand Analyzer, as we never know
   there when we are doing the last pass.
 * We want them to be still there at the end of DmdAnal, so that
   -ddump-str-anal contains them.
 * We don&#8217;t want a second pass just for that.
 * WorkWrap looks at all bindings anyway.

We also need to do it in TidyCore.tidyLetBndr to clean up after the
final, worker/wrapper-less run of the demand analyser (see
Note [Final Demand Analyser run] in GHC.Core.Opt.DmdAnal).

Note [Zapping Used Once info in WorkWrap]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
During the work/wrap pass, using zapIdUsedOnceInfo, we zap the &quot;used once&quot; info
* on every binder (let binders, case binders, lambda binders)
* in both demands and in strictness signatures
* recursively

Why?
 * The simplifier may happen to transform code in a way that invalidates the
   data (see #11731 for an example).
 * It is not used in later passes, up to code generation.

At first it's hard to see how the simplifier might invalidate it (and
indeed for a while I thought it couldn't: #19482), but it's not quite
as simple as I thought.  Consider this:
  {-# STRICTNESS SIG &lt;SP(M,A)&gt; #-}
  f p = let v = case p of (a,b) -&gt; a
        in p `seq` (v,v)

I think we'll give `f` the strictness signature `&lt;SP(M,A)&gt;`, where the
`M` says that we'll evaluate the first component of the pair at most
once.  Why?  Because the RHS of the thunk `v` is evaluated at most
once.

But now let's worker/wrapper f:
  {-# STRICTNESS SIG &lt;M&gt; #-}
  $wf p1 = let p2 = absentError &quot;urk&quot; in
           let p = (p1,p2) in
           let v = case p of (a,b) -&gt; a
           in p `seq` (v,v)

where I've gotten the demand on `p1` by decomposing the P(M,A) argument demand.
This rapidly simplifies to
  {-# STRICTNESS SIG &lt;M&gt; #-}
  $wf p1 = let v = p1 in
           (v,v)

and thence to `(p1,p1)` by inlining the trivial let. Now the demand on `p1` should
not be at most once!!

Conclusion: used-once info is fragile to simplification, because of
the non-monotonic behaviour of let's, which turn used-many into
used-once.  So indeed we should zap this info in worker/wrapper.

Conclusion: kill it during worker/wrapper, using `zapUsedOnceInfo`.
Both the *demand signature* of the binder, and the *demand-info* of
the binder.  Moreover, do so recursively.

You might wonder: why do we generate used-once info if we then throw
it away.  The main reason is that we do a final run of the demand analyser,
immediately before CoreTidy, which is /not/ followed by worker/wrapper; it
is there only to generate used-once info for single-entry thunks.

Note [Don't eta expand in w/w]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A binding where the manifestArity of the RHS is less than idArity of
the binder means GHC.Core.Opt.Arity didn't eta expand that binding
When this happens, it does so for a reason (see Note [Arity invariants for bindings]
in GHC.Core.Opt.Arity) and we probably have a PAP, cast or trivial expression
as RHS.

Below is a historical account of what happened when w/w still did eta expansion.
Nowadays, it doesn't do that, but will simply w/w for the wrong arity, unleashing
a demand signature meant for e.g. 2 args to be unleashed for e.g. 1 arg
(manifest arity). That's at least as terrible as doing eta expansion, so don't
do it.
---
When worker/wrapper did eta expansion, it implictly eta expanded the binding to
idArity, overriding GHC.Core.Opt.Arity's decision. Other than playing fast and loose with
divergence, it's also broken for newtypes:

  f = (\xy.blah) |&gt; co
    where
      co :: (Int -&gt; Int -&gt; Char) ~ T

Then idArity is 2 (despite the type T), and it can have a DmdSig based on a
threshold of 2. But we can't w/w it without a type error.

The situation is less grave for PAPs, but the implicit eta expansion caused a
compiler allocation regression in T15164, where huge recursive instance method
groups, mostly consisting of PAPs, got w/w'd. This caused great churn in the
simplifier, when simply waiting for the PAPs to inline arrived at the same
output program.

Note there is the worry here that such PAPs and trivial RHSs might not *always*
be inlined. That would lead to reboxing, because the analysis tacitly assumes
that we W/W'd for idArity and will propagate analysis information under that
assumption. So far, this doesn't seem to matter in practice.
See https://gitlab.haskell.org/ghc/ghc/merge_requests/312#note_192064.

Note [Inline pragma for certainlyWillInline]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (#19824 comment on 15 May 21):
  f _ (x,y) = ...big...
  v = ...big...
  g x = f v x + 1

So `f` will generate a worker/wrapper split; and `g` (since it is small)
will trigger the certainlyWillInline case of splitFun.  The danger is that
we end up with
  g {- StableUnfolding = \x -&gt; f v x + 1 -}
    = ...blah...

Since (a) that unfolding for g is AlwaysActive
      (b) the unfolding for f's wrapper is ActiveAfterInitial
the call of f will never inline in g's stable unfolding, thereby
keeping `v` alive.

I thought of changing g's unfolding to be ActiveAfterInitial, but that
too is bad: it delays g's inlining into other modules, which makes fewer
specialisations happen. Example in perf/should_run/DeriveNull.

So I decided to live with the problem.  In fact v's RHS will be replaced
by LitRubbish (see Note [Drop absent bindings]) so there is no great harm.
-}</span><span>
</span><span id="line-757"></span><span>
</span><span id="line-758"></span><span>
</span><span id="line-759"></span><span class="hs-comment">---------------------</span><span>
</span><span id="line-760"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#splitFun"><span class="hs-identifier hs-type">splitFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-761"></span><span id="splitFun"><span class="annot"><span class="annottext">splitFun :: WwOpts -&gt; Var -&gt; CoreExpr -&gt; UniqSM [(Var, CoreExpr)]
</span><a href="GHC.Core.Opt.WorkWrap.html#splitFun"><span class="hs-identifier hs-var hs-var">splitFun</span></a></span></span><span> </span><span id="local-6989586621681826258"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826258"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span id="local-6989586621681826259"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826259"><span class="hs-identifier hs-var">fn_id</span></a></span></span><span> </span><span id="local-6989586621681826260"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826260"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-762"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681826261"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681826261"><span class="hs-identifier hs-var">arg_vars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681826262"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826262"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; CoreExpr -&gt; Maybe ([Var], CoreExpr)
</span><a href="GHC.Core.html#collectNValBinders_maybe"><span class="hs-identifier hs-var">collectNValBinders_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; Arity
forall a. [a] -&gt; Arity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Arity
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681826265"><span class="hs-identifier hs-var">wrap_dmds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826260"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-763"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; String
-&gt; SDoc
-&gt; UniqSM [(Var, CoreExpr)]
-&gt; UniqSM [(Var, CoreExpr)]
forall a. HasCallStack =&gt; Bool -&gt; String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Trace.html#warnPprTrace"><span class="hs-identifier hs-var">warnPprTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681826265"><span class="hs-identifier hs-var">wrap_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; Arity -&gt; Bool
forall a. [a] -&gt; Arity -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthIs"><span class="hs-operator hs-var">`lengthIs`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; Arity
</span><a href="GHC.Types.Id.Info.html#arityInfo"><span class="hs-identifier hs-var">arityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826269"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-764"></span><span>                 </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;splitFun&quot;</span></span><span>
</span><span id="line-765"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826259"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Demand] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681826265"><span class="hs-identifier hs-var">wrap_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Cpr -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621681826271"><span class="hs-identifier hs-var">cpr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM [(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)])
-&gt; UniqSM [(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-766"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681826272"><span class="annot"><span class="annottext">Maybe WwResult
</span><a href="#local-6989586621681826272"><span class="hs-identifier hs-var">mb_stuff</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WwOpts
-&gt; Var
-&gt; [Var]
-&gt; Type
-&gt; [Demand]
-&gt; Cpr
-&gt; UniqSM (Maybe WwResult)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWwBodies"><span class="hs-identifier hs-var">mkWwBodies</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826258"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826259"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681826261"><span class="hs-identifier hs-var">arg_vars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CoreExpr -&gt; Type
CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826262"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681826265"><span class="hs-identifier hs-var">wrap_dmds</span></a></span><span> </span><span class="annot"><span class="annottext">Cpr
</span><a href="#local-6989586621681826271"><span class="hs-identifier hs-var">cpr</span></a></span><span>
</span><span id="line-767"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe WwResult
</span><a href="#local-6989586621681826272"><span class="hs-identifier hs-var">mb_stuff</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-768"></span><span>            </span><span class="annot"><span class="annottext">Maybe WwResult
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- No useful wrapper; leave the binding alone</span><span>
</span><span id="line-769"></span><span>                       </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826259"><span class="hs-identifier hs-var">fn_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826260"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-770"></span><span>
</span><span id="line-771"></span><span>            </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681826274"><span class="annot"><span class="annottext">WwResult
</span><a href="#local-6989586621681826274"><span class="hs-identifier hs-var">stuff</span></a></span></span><span>
</span><span id="line-772"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681826275"><span class="annot"><span class="annottext">opt_wwd_rhs :: CoreExpr
</span><a href="#local-6989586621681826275"><span class="hs-identifier hs-var hs-var">opt_wwd_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; SimpleOpts -&gt; CoreExpr -&gt; CoreExpr
SimpleOpts -&gt; CoreExpr -&gt; CoreExpr
</span><a href="GHC.Core.SimpleOpt.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WwOpts -&gt; SimpleOpts
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_simple_opts"><span class="hs-identifier hs-var">wo_simple_opts</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826258"><span class="hs-identifier hs-var">ww_opts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826260"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-773"></span><span>                  </span><span class="hs-comment">-- We need to stabilise the WW'd (and optimised) RHS below</span><span>
</span><span id="line-774"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681826278"><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681826278"><span class="hs-identifier hs-var">stable_unf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts -&gt; IdInfo -&gt; CoreExpr -&gt; Maybe Unfolding
</span><a href="GHC.Core.Unfold.Make.html#certainlyWillInline"><span class="hs-identifier hs-var">certainlyWillInline</span></a></span><span> </span><span class="annot"><span class="annottext">UnfoldingOpts
</span><a href="#local-6989586621681826280"><span class="hs-identifier hs-var">uf_opts</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826269"><span class="hs-identifier hs-var">fn_info</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826275"><span class="hs-identifier hs-var">opt_wwd_rhs</span></a></span><span>
</span><span id="line-775"></span><span>                </span><span class="hs-comment">-- We could make a w/w split, but in fact the RHS is small</span><span>
</span><span id="line-776"></span><span>                </span><span class="hs-comment">-- See Note [Don't w/w inline small non-loop-breaker things]</span><span>
</span><span id="line-777"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681826281"><span class="annot"><span class="annottext">id_w_unf :: Var
</span><a href="#local-6989586621681826281"><span class="hs-identifier hs-var hs-var">id_w_unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826259"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Unfolding -&gt; Var
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681826278"><span class="hs-identifier hs-var">stable_unf</span></a></span><span>
</span><span id="line-778"></span><span>                </span><span class="hs-comment">-- See Note [Inline pragma for certainlyWillInline]</span><span>
</span><span id="line-779"></span><span>              </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826281"><span class="hs-identifier hs-var">id_w_unf</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826260"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-780"></span><span>
</span><span id="line-781"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-782"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621681826283"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681826283"><span class="hs-identifier hs-var">work_uniq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UniqSM Unique
forall (m :: * -&gt; *). MonadUnique m =&gt; m Unique
</span><a href="GHC.Types.Unique.Supply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a></span><span>
</span><span id="line-783"></span><span>                    </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WwOpts
-&gt; Var
-&gt; IdInfo
-&gt; [Var]
-&gt; CoreExpr
-&gt; Unique
-&gt; Divergence
-&gt; WwResult
-&gt; [(Var, CoreExpr)]
</span><a href="GHC.Core.Opt.WorkWrap.html#mkWWBindPair"><span class="hs-identifier hs-var">mkWWBindPair</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826258"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826259"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826269"><span class="hs-identifier hs-var">fn_info</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681826261"><span class="hs-identifier hs-var">arg_vars</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826262"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-784"></span><span>                                           </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681826283"><span class="hs-identifier hs-var">work_uniq</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681826286"><span class="hs-identifier hs-var">div</span></a></span><span> </span><span class="annot"><span class="annottext">WwResult
</span><a href="#local-6989586621681826274"><span class="hs-identifier hs-var">stuff</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-785"></span><span>
</span><span id="line-786"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>    </span><span class="hs-comment">-- See Note [Don't eta expand in w/w]</span><span>
</span><span id="line-787"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826259"><span class="hs-identifier hs-var">fn_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826260"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-788"></span><span>
</span><span id="line-789"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-790"></span><span>    </span><span id="local-6989586621681826280"><span class="annot"><span class="annottext">uf_opts :: UnfoldingOpts
</span><a href="#local-6989586621681826280"><span class="hs-identifier hs-var hs-var">uf_opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimpleOpts -&gt; UnfoldingOpts
</span><a href="GHC.Core.SimpleOpt.html#so_uf_opts"><span class="hs-identifier hs-var">so_uf_opts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WwOpts -&gt; SimpleOpts
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_simple_opts"><span class="hs-identifier hs-var">wo_simple_opts</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826258"><span class="hs-identifier hs-var">ww_opts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-791"></span><span>    </span><span id="local-6989586621681826269"><span class="annot"><span class="annottext">fn_info :: IdInfo
</span><a href="#local-6989586621681826269"><span class="hs-identifier hs-var hs-var">fn_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Var -&gt; IdInfo
Var -&gt; IdInfo
</span><a href="GHC.Types.Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826259"><span class="hs-identifier hs-var">fn_id</span></a></span><span>
</span><span id="line-792"></span><span>
</span><span id="line-793"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681826265"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681826265"><span class="hs-identifier hs-var">wrap_dmds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681826286"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681826286"><span class="hs-identifier hs-var">div</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DmdSig -&gt; ([Demand], Divergence)
</span><a href="GHC.Types.Demand.html#splitDmdSig"><span class="hs-identifier hs-var">splitDmdSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; DmdSig
</span><a href="GHC.Types.Id.Info.html#dmdSigInfo"><span class="hs-identifier hs-var">dmdSigInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826269"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-794"></span><span>
</span><span id="line-795"></span><span>    </span><span id="local-6989586621681826288"><span class="annot"><span class="annottext">cpr_ty :: CprType
</span><a href="#local-6989586621681826288"><span class="hs-identifier hs-var hs-var">cpr_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CprSig -&gt; CprType
</span><a href="GHC.Types.Cpr.html#getCprSig"><span class="hs-identifier hs-var">getCprSig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; CprSig
</span><a href="GHC.Types.Id.Info.html#cprSigInfo"><span class="hs-identifier hs-var">cprSigInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826269"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-796"></span><span>    </span><span class="hs-comment">-- Arity of the CPR sig should match idArity when it's not a join point.</span><span>
</span><span id="line-797"></span><span>    </span><span class="hs-comment">-- See Note [Arity trimming for CPR signatures] in GHC.Core.Opt.CprAnal</span><span>
</span><span id="line-798"></span><span>    </span><span id="local-6989586621681826271"><span class="annot"><span class="annottext">cpr :: Cpr
</span><a href="#local-6989586621681826271"><span class="hs-identifier hs-var hs-var">cpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; Cpr -&gt; Cpr
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826259"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681826288"><span class="hs-identifier hs-var">cpr_ty</span></a></span><span> </span><span class="annot"><span class="annottext">CprType -&gt; CprType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="GHC.Types.Cpr.html#topCprType"><span class="hs-identifier hs-var">topCprType</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">CprType -&gt; Arity
</span><a href="GHC.Types.Cpr.html#ct_arty"><span class="hs-identifier hs-var">ct_arty</span></a></span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681826288"><span class="hs-identifier hs-var">cpr_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Arity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Arity
</span><a href="GHC.Types.Id.Info.html#arityInfo"><span class="hs-identifier hs-var">arityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826269"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-799"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826259"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ct_arty:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; SDoc
forall doc. IsLine doc =&gt; Arity -&gt; doc
</span><a href="GHC.Utils.Outputable.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CprType -&gt; Arity
</span><a href="GHC.Types.Cpr.html#ct_arty"><span class="hs-identifier hs-var">ct_arty</span></a></span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681826288"><span class="hs-identifier hs-var">cpr_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-800"></span><span>                      </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;arityInfo:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; Arity
</span><a href="GHC.Types.Id.Info.html#arityInfo"><span class="hs-identifier hs-var">arityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826269"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Cpr -&gt; Cpr) -&gt; Cpr -&gt; Cpr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-801"></span><span>          </span><span class="annot"><span class="annottext">CprType -&gt; Cpr
</span><a href="GHC.Types.Cpr.html#ct_cpr"><span class="hs-identifier hs-var">ct_cpr</span></a></span><span> </span><span class="annot"><span class="annottext">CprType
</span><a href="#local-6989586621681826288"><span class="hs-identifier hs-var">cpr_ty</span></a></span><span>
</span><span id="line-802"></span><span>
</span><span id="line-803"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#mkWWBindPair"><span class="hs-identifier hs-type">mkWWBindPair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Id.Info.html#IdInfo"><span class="hs-identifier hs-type">IdInfo</span></a></span><span>
</span><span id="line-804"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Demand.html#Divergence"><span class="hs-identifier hs-type">Divergence</span></a></span><span>
</span><span id="line-805"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span class="annot"><a href="GHC.Types.Basic.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Expr"><span class="hs-identifier hs-type">Expr</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-807"></span><span id="mkWWBindPair"><span class="annot"><span class="annottext">mkWWBindPair :: WwOpts
-&gt; Var
-&gt; IdInfo
-&gt; [Var]
-&gt; CoreExpr
-&gt; Unique
-&gt; Divergence
-&gt; WwResult
-&gt; [(Var, CoreExpr)]
</span><a href="GHC.Core.Opt.WorkWrap.html#mkWWBindPair"><span class="hs-identifier hs-var hs-var">mkWWBindPair</span></a></span></span><span> </span><span id="local-6989586621681826298"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826298"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span id="local-6989586621681826299"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826299"><span class="hs-identifier hs-var">fn_id</span></a></span></span><span> </span><span id="local-6989586621681826300"><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826300"><span class="hs-identifier hs-var">fn_info</span></a></span></span><span> </span><span id="local-6989586621681826301"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681826301"><span class="hs-identifier hs-var">fn_args</span></a></span></span><span> </span><span id="local-6989586621681826302"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826302"><span class="hs-identifier hs-var">fn_body</span></a></span></span><span> </span><span id="local-6989586621681826303"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681826303"><span class="hs-identifier hs-var">work_uniq</span></a></span></span><span> </span><span id="local-6989586621681826304"><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681826304"><span class="hs-identifier hs-var">div</span></a></span></span><span>
</span><span id="line-808"></span><span>             </span><span class="hs-special">(</span><span id="local-6989586621681826305"><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681826305"><span class="hs-identifier hs-var">work_demands</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681826306"><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681826306"><span class="hs-identifier hs-var">join_arity</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681826307"><span class="annot"><span class="annottext">Var -&gt; CoreExpr
</span><a href="#local-6989586621681826307"><span class="hs-identifier hs-var">wrap_fn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681826308"><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681826308"><span class="hs-identifier hs-var">work_fn</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-809"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;mkWWBindPair&quot; (ppr fn_id &lt;+&gt; ppr wrap_id &lt;+&gt; ppr work_id $$ ppr wrap_rhs) $</span><span>
</span><span id="line-810"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826309"><span class="hs-identifier hs-var">work_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826310"><span class="hs-identifier hs-var">work_rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826311"><span class="hs-identifier hs-var">wrap_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826312"><span class="hs-identifier hs-var">wrap_rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-811"></span><span>     </span><span class="hs-comment">-- Worker first, because wrapper mentions it</span><span>
</span><span id="line-812"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-813"></span><span>    </span><span id="local-6989586621681826313"><span class="annot"><span class="annottext">arity :: Arity
</span><a href="#local-6989586621681826313"><span class="hs-identifier hs-var hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Arity
</span><a href="GHC.Types.Id.Info.html#arityInfo"><span class="hs-identifier hs-var">arityInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826300"><span class="hs-identifier hs-var">fn_info</span></a></span><span>
</span><span id="line-814"></span><span>            </span><span class="hs-comment">-- The arity is set by the simplifier using exprEtaExpandArity</span><span>
</span><span id="line-815"></span><span>            </span><span class="hs-comment">-- So it may be more than the number of top-level-visible lambdas</span><span>
</span><span id="line-816"></span><span>
</span><span id="line-817"></span><span>    </span><span id="local-6989586621681826314"><span class="annot"><span class="annottext">simpl_opts :: SimpleOpts
</span><a href="#local-6989586621681826314"><span class="hs-identifier hs-var hs-var">simpl_opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WwOpts -&gt; SimpleOpts
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#wo_simple_opts"><span class="hs-identifier hs-var">wo_simple_opts</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826298"><span class="hs-identifier hs-var">ww_opts</span></a></span><span>
</span><span id="line-818"></span><span>
</span><span id="line-819"></span><span>    </span><span id="local-6989586621681826310"><span class="annot"><span class="annottext">work_rhs :: CoreExpr
</span><a href="#local-6989586621681826310"><span class="hs-identifier hs-var hs-var">work_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681826308"><span class="hs-identifier hs-var">work_fn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Var] -&gt; CoreExpr -&gt; CoreExpr
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681826301"><span class="hs-identifier hs-var">fn_args</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826302"><span class="hs-identifier hs-var">fn_body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-820"></span><span>    </span><span id="local-6989586621681826316"><span class="annot"><span class="annottext">work_act :: Activation
</span><a href="#local-6989586621681826316"><span class="hs-identifier hs-var hs-var">work_act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InlineSpec
</span><a href="#local-6989586621681826317"><span class="hs-identifier hs-var">fn_inline_spec</span></a></span><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- See Note [Worker activation]</span><span>
</span><span id="line-821"></span><span>                   </span><span class="annot"><a href="GHC.Types.Basic.html#NoInline"><span class="hs-identifier hs-type">NoInline</span></a></span><span> </span><span class="annot"><span class="annottext">SourceText
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InlinePragma -&gt; Activation
</span><a href="GHC.Types.Basic.html#inl_act"><span class="hs-identifier hs-var">inl_act</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="#local-6989586621681826320"><span class="hs-identifier hs-var">fn_inl_prag</span></a></span><span>
</span><span id="line-822"></span><span>                   </span><span class="annot"><span class="annottext">InlineSpec
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InlinePragma -&gt; Activation
</span><a href="GHC.Types.Basic.html#inl_act"><span class="hs-identifier hs-var">inl_act</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="#local-6989586621681826321"><span class="hs-identifier hs-var">wrap_prag</span></a></span><span>
</span><span id="line-823"></span><span>
</span><span id="line-824"></span><span>    </span><span id="local-6989586621681826322"><span class="annot"><span class="annottext">work_prag :: InlinePragma
</span><a href="#local-6989586621681826322"><span class="hs-identifier hs-var hs-var">work_prag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#InlinePragma"><span class="hs-identifier hs-type">InlinePragma</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">inl_src :: SourceText
</span><a href="GHC.Types.Basic.html#inl_src"><span class="hs-identifier hs-var">inl_src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SourceText
</span><a href="GHC.Types.SourceText.html#SourceText"><span class="hs-identifier hs-var">SourceText</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;{-# INLINE&quot;</span></span><span>
</span><span id="line-825"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_inline :: InlineSpec
</span><a href="GHC.Types.Basic.html#inl_inline"><span class="hs-identifier hs-var">inl_inline</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InlineSpec
</span><a href="#local-6989586621681826317"><span class="hs-identifier hs-var">fn_inline_spec</span></a></span><span>
</span><span id="line-826"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_sat :: Maybe Arity
</span><a href="GHC.Types.Basic.html#inl_sat"><span class="hs-identifier hs-var">inl_sat</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Arity
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-827"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_act :: Activation
</span><a href="GHC.Types.Basic.html#inl_act"><span class="hs-identifier hs-var">inl_act</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621681826316"><span class="hs-identifier hs-var">work_act</span></a></span><span>
</span><span id="line-828"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_rule :: RuleMatchInfo
</span><a href="GHC.Types.Basic.html#inl_rule"><span class="hs-identifier hs-var">inl_rule</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchInfo
</span><a href="GHC.Types.Basic.html#FunLike"><span class="hs-identifier hs-var">FunLike</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-829"></span><span>      </span><span class="hs-comment">-- inl_inline: copy from fn_id; see Note [Worker/wrapper for INLINABLE functions]</span><span>
</span><span id="line-830"></span><span>      </span><span class="hs-comment">-- inl_act:    see Note [Worker activation]</span><span>
</span><span id="line-831"></span><span>      </span><span class="hs-comment">-- inl_rule:   it does not make sense for workers to be constructorlike.</span><span>
</span><span id="line-832"></span><span>
</span><span id="line-833"></span><span>    </span><span id="local-6989586621681826330"><span class="annot"><span class="annottext">work_join_arity :: Maybe Arity
</span><a href="#local-6989586621681826330"><span class="hs-identifier hs-var hs-var">work_join_arity</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826299"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Maybe Arity
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681826306"><span class="hs-identifier hs-var">join_arity</span></a></span><span>
</span><span id="line-834"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Arity
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-835"></span><span>      </span><span class="hs-comment">-- worker is join point iff wrapper is join point</span><span>
</span><span id="line-836"></span><span>      </span><span class="hs-comment">-- (see Note [Don't w/w join points for CPR])</span><span>
</span><span id="line-837"></span><span>
</span><span id="line-838"></span><span>    </span><span id="local-6989586621681826309"><span class="annot"><span class="annottext">work_id :: Var
</span><a href="#local-6989586621681826309"><span class="hs-identifier hs-var hs-var">work_id</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="GHC.Types.Id.html#asWorkerLikeId"><span class="hs-identifier hs-var">asWorkerLikeId</span></a></span><span> </span><span class="annot"><span class="annottext">(Var -&gt; Var) -&gt; Var -&gt; Var
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-839"></span><span>               </span><span class="annot"><span class="annottext">Unique -&gt; Var -&gt; Type -&gt; Var
</span><a href="GHC.Types.Id.html#mkWorkerId"><span class="hs-identifier hs-var">mkWorkerId</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621681826303"><span class="hs-identifier hs-var">work_uniq</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826299"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CoreExpr -&gt; Type
CoreExpr -&gt; Type
</span><a href="GHC.Core.Utils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826310"><span class="hs-identifier hs-var">work_rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-840"></span><span>                </span><span class="annot"><span class="annottext">Var -&gt; OccInfo -&gt; Var
</span><a href="GHC.Types.Id.html#setIdOccInfo"><span class="hs-operator hs-var">`setIdOccInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; OccInfo
</span><a href="GHC.Types.Id.Info.html#occInfo"><span class="hs-identifier hs-var">occInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826300"><span class="hs-identifier hs-var">fn_info</span></a></span><span>
</span><span id="line-841"></span><span>                        </span><span class="hs-comment">-- Copy over occurrence info from parent</span><span>
</span><span id="line-842"></span><span>                        </span><span class="hs-comment">-- Notably whether it's a loop breaker</span><span>
</span><span id="line-843"></span><span>                        </span><span class="hs-comment">-- Doesn't matter much, since we will simplify next, but</span><span>
</span><span id="line-844"></span><span>                        </span><span class="hs-comment">-- seems right-er to do so</span><span>
</span><span id="line-845"></span><span>
</span><span id="line-846"></span><span>                </span><span class="annot"><span class="annottext">Var -&gt; InlinePragma -&gt; Var
</span><a href="GHC.Types.Id.html#setInlinePragma"><span class="hs-operator hs-var">`setInlinePragma`</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="#local-6989586621681826322"><span class="hs-identifier hs-var">work_prag</span></a></span><span>
</span><span id="line-847"></span><span>
</span><span id="line-848"></span><span>                </span><span class="annot"><span class="annottext">Var -&gt; Unfolding -&gt; Var
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts -&gt; (CoreExpr -&gt; CoreExpr) -&gt; Unfolding -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkWorkerUnfolding"><span class="hs-identifier hs-var">mkWorkerUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681826314"><span class="hs-identifier hs-var">simpl_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681826308"><span class="hs-identifier hs-var">work_fn</span></a></span><span> </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681826337"><span class="hs-identifier hs-var">fn_unfolding</span></a></span><span>
</span><span id="line-849"></span><span>                        </span><span class="hs-comment">-- See Note [Worker/wrapper for INLINABLE functions]</span><span>
</span><span id="line-850"></span><span>
</span><span id="line-851"></span><span>                </span><span class="annot"><span class="annottext">Var -&gt; DmdSig -&gt; Var
</span><a href="GHC.Types.Id.html#setIdDmdSig"><span class="hs-operator hs-var">`setIdDmdSig`</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; Divergence -&gt; DmdSig
</span><a href="GHC.Types.Demand.html#mkClosedDmdSig"><span class="hs-identifier hs-var">mkClosedDmdSig</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681826305"><span class="hs-identifier hs-var">work_demands</span></a></span><span> </span><span class="annot"><span class="annottext">Divergence
</span><a href="#local-6989586621681826304"><span class="hs-identifier hs-var">div</span></a></span><span>
</span><span id="line-852"></span><span>                        </span><span class="hs-comment">-- Even though we may not be at top level,</span><span>
</span><span id="line-853"></span><span>                        </span><span class="hs-comment">-- it's ok to give it an empty DmdEnv</span><span>
</span><span id="line-854"></span><span>
</span><span id="line-855"></span><span>                </span><span class="annot"><span class="annottext">Var -&gt; CprSig -&gt; Var
</span><a href="GHC.Types.Id.html#setIdCprSig"><span class="hs-operator hs-var">`setIdCprSig`</span></a></span><span> </span><span class="annot"><span class="annottext">CprSig
</span><a href="GHC.Types.Cpr.html#topCprSig"><span class="hs-identifier hs-var">topCprSig</span></a></span><span>
</span><span id="line-856"></span><span>
</span><span id="line-857"></span><span>                </span><span class="annot"><span class="annottext">Var -&gt; Demand -&gt; Var
</span><a href="GHC.Types.Id.html#setIdDemandInfo"><span class="hs-operator hs-var">`setIdDemandInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="#local-6989586621681826341"><span class="hs-identifier hs-var">worker_demand</span></a></span><span>
</span><span id="line-858"></span><span>
</span><span id="line-859"></span><span>                </span><span class="annot"><span class="annottext">Var -&gt; Arity -&gt; Var
</span><a href="GHC.Types.Id.html#setIdArity"><span class="hs-operator hs-var">`setIdArity`</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681826343"><span class="hs-identifier hs-var">work_arity</span></a></span><span>
</span><span id="line-860"></span><span>                        </span><span class="hs-comment">-- Set the arity so that the Core Lint check that the</span><span>
</span><span id="line-861"></span><span>                        </span><span class="hs-comment">-- arity is consistent with the demand type goes</span><span>
</span><span id="line-862"></span><span>                        </span><span class="hs-comment">-- through</span><span>
</span><span id="line-863"></span><span>
</span><span id="line-864"></span><span>                </span><span class="annot"><span class="annottext">Var -&gt; Maybe Arity -&gt; Var
</span><a href="GHC.Types.Id.html#asJoinId_maybe"><span class="hs-operator hs-var">`asJoinId_maybe`</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Arity
</span><a href="#local-6989586621681826330"><span class="hs-identifier hs-var">work_join_arity</span></a></span><span>
</span><span id="line-865"></span><span>
</span><span id="line-866"></span><span>    </span><span id="local-6989586621681826343"><span class="annot"><span class="annottext">work_arity :: Arity
</span><a href="#local-6989586621681826343"><span class="hs-identifier hs-var hs-var">work_arity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Demand] -&gt; Arity
forall a. [a] -&gt; Arity
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Arity
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#length/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[Demand]
</span><a href="#local-6989586621681826305"><span class="hs-identifier hs-var">work_demands</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-867"></span><span>
</span><span id="line-868"></span><span>    </span><span class="hs-comment">-- See Note [Demand on the worker]</span><span>
</span><span id="line-869"></span><span>    </span><span id="local-6989586621681826345"><span class="annot"><span class="annottext">single_call :: Bool
</span><a href="#local-6989586621681826345"><span class="hs-identifier hs-var hs-var">single_call</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Demand -&gt; Bool
</span><a href="GHC.Types.Demand.html#saturatedByOneShots"><span class="hs-identifier hs-var">saturatedByOneShots</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681826313"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; Demand
</span><a href="GHC.Types.Id.Info.html#demandInfo"><span class="hs-identifier hs-var">demandInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826300"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-870"></span><span>    </span><span id="local-6989586621681826341"><span class="annot"><span class="annottext">worker_demand :: Demand
</span><a href="#local-6989586621681826341"><span class="hs-identifier hs-var hs-var">worker_demand</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681826345"><span class="hs-identifier hs-var">single_call</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; Demand
</span><a href="GHC.Types.Demand.html#mkWorkerDemand"><span class="hs-identifier hs-var">mkWorkerDemand</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681826343"><span class="hs-identifier hs-var">work_arity</span></a></span><span>
</span><span id="line-871"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Demand
</span><a href="GHC.Types.Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a></span><span>
</span><span id="line-872"></span><span>
</span><span id="line-873"></span><span>    </span><span id="local-6989586621681826312"><span class="annot"><span class="annottext">wrap_rhs :: CoreExpr
</span><a href="#local-6989586621681826312"><span class="hs-identifier hs-var hs-var">wrap_rhs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; CoreExpr
</span><a href="#local-6989586621681826307"><span class="hs-identifier hs-var">wrap_fn</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826309"><span class="hs-identifier hs-var">work_id</span></a></span><span>
</span><span id="line-874"></span><span>    </span><span id="local-6989586621681826321"><span class="annot"><span class="annottext">wrap_prag :: InlinePragma
</span><a href="#local-6989586621681826321"><span class="hs-identifier hs-var hs-var">wrap_prag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InlinePragma -&gt; [CoreRule] -&gt; InlinePragma
</span><a href="GHC.Core.Opt.WorkWrap.html#mkStrWrapperInlinePrag"><span class="hs-identifier hs-var">mkStrWrapperInlinePrag</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="#local-6989586621681826320"><span class="hs-identifier hs-var">fn_inl_prag</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681826350"><span class="hs-identifier hs-var">fn_rules</span></a></span><span>
</span><span id="line-875"></span><span>    </span><span id="local-6989586621681826351"><span class="annot"><span class="annottext">wrap_unf :: Unfolding
</span><a href="#local-6989586621681826351"><span class="hs-identifier hs-var hs-var">wrap_unf</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimpleOpts -&gt; CoreExpr -&gt; Arity -&gt; Unfolding
</span><a href="GHC.Core.Unfold.Make.html#mkWrapperUnfolding"><span class="hs-identifier hs-var">mkWrapperUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleOpts
</span><a href="#local-6989586621681826314"><span class="hs-identifier hs-var">simpl_opts</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826312"><span class="hs-identifier hs-var">wrap_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Arity
</span><a href="#local-6989586621681826313"><span class="hs-identifier hs-var">arity</span></a></span><span>
</span><span id="line-876"></span><span>
</span><span id="line-877"></span><span>    </span><span id="local-6989586621681826311"><span class="annot"><span class="annottext">wrap_id :: Var
</span><a href="#local-6989586621681826311"><span class="hs-identifier hs-var hs-var">wrap_id</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826299"><span class="hs-identifier hs-var">fn_id</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Unfolding -&gt; Var
</span><a href="GHC.Types.Id.html#setIdUnfolding"><span class="hs-operator hs-var">`setIdUnfolding`</span></a></span><span>  </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681826351"><span class="hs-identifier hs-var">wrap_unf</span></a></span><span>
</span><span id="line-878"></span><span>                      </span><span class="annot"><span class="annottext">Var -&gt; InlinePragma -&gt; Var
</span><a href="GHC.Types.Id.html#setInlinePragma"><span class="hs-operator hs-var">`setInlinePragma`</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="#local-6989586621681826321"><span class="hs-identifier hs-var">wrap_prag</span></a></span><span>
</span><span id="line-879"></span><span>                      </span><span class="annot"><span class="annottext">Var -&gt; OccInfo -&gt; Var
</span><a href="GHC.Types.Id.html#setIdOccInfo"><span class="hs-operator hs-var">`setIdOccInfo`</span></a></span><span>    </span><span class="annot"><span class="annottext">OccInfo
</span><a href="GHC.Types.Basic.html#noOccInfo"><span class="hs-identifier hs-var">noOccInfo</span></a></span><span>
</span><span id="line-880"></span><span>                        </span><span class="hs-comment">-- Zap any loop-breaker-ness, to avoid bleating from Lint</span><span>
</span><span id="line-881"></span><span>                        </span><span class="hs-comment">-- about a loop breaker with an INLINE rule</span><span>
</span><span id="line-882"></span><span>
</span><span id="line-883"></span><span>    </span><span id="local-6989586621681826320"><span class="annot"><span class="annottext">fn_inl_prag :: InlinePragma
</span><a href="#local-6989586621681826320"><span class="hs-identifier hs-var hs-var">fn_inl_prag</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; InlinePragma
</span><a href="GHC.Types.Id.Info.html#inlinePragInfo"><span class="hs-identifier hs-var">inlinePragInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826300"><span class="hs-identifier hs-var">fn_info</span></a></span><span>
</span><span id="line-884"></span><span>    </span><span id="local-6989586621681826317"><span class="annot"><span class="annottext">fn_inline_spec :: InlineSpec
</span><a href="#local-6989586621681826317"><span class="hs-identifier hs-var hs-var">fn_inline_spec</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InlinePragma -&gt; InlineSpec
</span><a href="GHC.Types.Basic.html#inl_inline"><span class="hs-identifier hs-var">inl_inline</span></a></span><span> </span><span class="annot"><span class="annottext">InlinePragma
</span><a href="#local-6989586621681826320"><span class="hs-identifier hs-var">fn_inl_prag</span></a></span><span>
</span><span id="line-885"></span><span>    </span><span id="local-6989586621681826337"><span class="annot"><span class="annottext">fn_unfolding :: Unfolding
</span><a href="#local-6989586621681826337"><span class="hs-identifier hs-var hs-var">fn_unfolding</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdInfo -&gt; Unfolding
</span><a href="GHC.Types.Id.Info.html#realUnfoldingInfo"><span class="hs-identifier hs-var">realUnfoldingInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826300"><span class="hs-identifier hs-var">fn_info</span></a></span><span>
</span><span id="line-886"></span><span>    </span><span id="local-6989586621681826350"><span class="annot"><span class="annottext">fn_rules :: [CoreRule]
</span><a href="#local-6989586621681826350"><span class="hs-identifier hs-var hs-var">fn_rules</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleInfo -&gt; [CoreRule]
</span><a href="GHC.Types.Id.Info.html#ruleInfoRules"><span class="hs-identifier hs-var">ruleInfoRules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdInfo -&gt; RuleInfo
</span><a href="GHC.Types.Id.Info.html#ruleInfo"><span class="hs-identifier hs-var">ruleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IdInfo
</span><a href="#local-6989586621681826300"><span class="hs-identifier hs-var">fn_info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-887"></span><span>
</span><span id="line-888"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#mkStrWrapperInlinePrag"><span class="hs-identifier hs-type">mkStrWrapperInlinePrag</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#InlinePragma"><span class="hs-identifier hs-type">InlinePragma</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#InlinePragma"><span class="hs-identifier hs-type">InlinePragma</span></a></span><span>
</span><span id="line-889"></span><span id="mkStrWrapperInlinePrag"><span class="annot"><span class="annottext">mkStrWrapperInlinePrag :: InlinePragma -&gt; [CoreRule] -&gt; InlinePragma
</span><a href="GHC.Core.Opt.WorkWrap.html#mkStrWrapperInlinePrag"><span class="hs-identifier hs-var hs-var">mkStrWrapperInlinePrag</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#InlinePragma"><span class="hs-identifier hs-type">InlinePragma</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">inl_inline :: InlinePragma -&gt; InlineSpec
</span><a href="GHC.Types.Basic.html#inl_inline"><span class="hs-identifier hs-var">inl_inline</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681826357"><span class="annot"><span class="annottext">InlineSpec
</span><a href="#local-6989586621681826357"><span class="hs-identifier hs-var">fn_inl</span></a></span></span><span>
</span><span id="line-890"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_act :: InlinePragma -&gt; Activation
</span><a href="GHC.Types.Basic.html#inl_act"><span class="hs-identifier hs-var">inl_act</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681826358"><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621681826358"><span class="hs-identifier hs-var">fn_act</span></a></span></span><span>
</span><span id="line-891"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_rule :: InlinePragma -&gt; RuleMatchInfo
</span><a href="GHC.Types.Basic.html#inl_rule"><span class="hs-identifier hs-var">inl_rule</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681826359"><span class="annot"><span class="annottext">RuleMatchInfo
</span><a href="#local-6989586621681826359"><span class="hs-identifier hs-var">rule_info</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681826360"><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681826360"><span class="hs-identifier hs-var">rules</span></a></span></span><span>
</span><span id="line-892"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#InlinePragma"><span class="hs-identifier hs-type">InlinePragma</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">inl_src :: SourceText
</span><a href="GHC.Types.Basic.html#inl_src"><span class="hs-identifier hs-var">inl_src</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SourceText
</span><a href="GHC.Types.SourceText.html#SourceText"><span class="hs-identifier hs-var">SourceText</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;{-# INLINE&quot;</span></span><span>
</span><span id="line-893"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_sat :: Maybe Arity
</span><a href="GHC.Types.Basic.html#inl_sat"><span class="hs-identifier hs-var">inl_sat</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Arity
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-894"></span><span>
</span><span id="line-895"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_inline :: InlineSpec
</span><a href="GHC.Types.Basic.html#inl_inline"><span class="hs-identifier hs-var">inl_inline</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InlineSpec
</span><a href="#local-6989586621681826357"><span class="hs-identifier hs-var">fn_inl</span></a></span><span>
</span><span id="line-896"></span><span>                      </span><span class="hs-comment">-- See Note [Worker/wrapper for INLINABLE functions]</span><span>
</span><span id="line-897"></span><span>
</span><span id="line-898"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_act :: Activation
</span><a href="GHC.Types.Basic.html#inl_act"><span class="hs-identifier hs-var">inl_act</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompilerPhase -&gt; Activation
</span><a href="GHC.Types.Basic.html#activeAfter"><span class="hs-identifier hs-var">activeAfter</span></a></span><span> </span><span class="annot"><span class="annottext">CompilerPhase
</span><a href="#local-6989586621681826362"><span class="hs-identifier hs-var">wrapper_phase</span></a></span><span>
</span><span id="line-899"></span><span>                      </span><span class="hs-comment">-- See Note [Wrapper activation]</span><span>
</span><span id="line-900"></span><span>
</span><span id="line-901"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">inl_rule :: RuleMatchInfo
</span><a href="GHC.Types.Basic.html#inl_rule"><span class="hs-identifier hs-var">inl_rule</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleMatchInfo
</span><a href="#local-6989586621681826359"><span class="hs-identifier hs-var">rule_info</span></a></span><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- RuleMatchInfo is (and must be) unaffected</span><span>
</span><span id="line-902"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-903"></span><span>    </span><span class="hs-comment">-- See Note [Wrapper activation]</span><span>
</span><span id="line-904"></span><span>    </span><span id="local-6989586621681826362"><span class="annot"><span class="annottext">wrapper_phase :: CompilerPhase
</span><a href="#local-6989586621681826362"><span class="hs-identifier hs-var hs-var">wrapper_phase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreRule -&gt; CompilerPhase -&gt; CompilerPhase)
-&gt; CompilerPhase -&gt; [CoreRule] -&gt; CompilerPhase
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CompilerPhase -&gt; CompilerPhase -&gt; CompilerPhase
</span><a href="GHC.Types.Basic.html#laterPhase"><span class="hs-identifier hs-var">laterPhase</span></a></span><span> </span><span class="annot"><span class="annottext">(CompilerPhase -&gt; CompilerPhase -&gt; CompilerPhase)
-&gt; (CoreRule -&gt; CompilerPhase)
-&gt; CoreRule
-&gt; CompilerPhase
-&gt; CompilerPhase
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule -&gt; CompilerPhase
</span><a href="#local-6989586621681826365"><span class="hs-identifier hs-var">get_rule_phase</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CompilerPhase
</span><a href="#local-6989586621681826366"><span class="hs-identifier hs-var">earliest_inline_phase</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreRule]
</span><a href="#local-6989586621681826360"><span class="hs-identifier hs-var">rules</span></a></span><span>
</span><span id="line-905"></span><span>    </span><span id="local-6989586621681826366"><span class="annot"><span class="annottext">earliest_inline_phase :: CompilerPhase
</span><a href="#local-6989586621681826366"><span class="hs-identifier hs-var hs-var">earliest_inline_phase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Activation -&gt; CompilerPhase
</span><a href="GHC.Types.Basic.html#beginPhase"><span class="hs-identifier hs-var">beginPhase</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="#local-6989586621681826358"><span class="hs-identifier hs-var">fn_act</span></a></span><span> </span><span class="annot"><span class="annottext">CompilerPhase -&gt; CompilerPhase -&gt; CompilerPhase
</span><a href="GHC.Types.Basic.html#laterPhase"><span class="hs-operator hs-var">`laterPhase`</span></a></span><span> </span><span class="annot"><span class="annottext">CompilerPhase -&gt; CompilerPhase
</span><a href="GHC.Types.Basic.html#nextPhase"><span class="hs-identifier hs-var">nextPhase</span></a></span><span> </span><span class="annot"><span class="annottext">CompilerPhase
</span><a href="GHC.Types.Basic.html#InitialPhase"><span class="hs-identifier hs-var">InitialPhase</span></a></span><span>
</span><span id="line-906"></span><span>          </span><span class="hs-comment">-- laterPhase (nextPhase InitialPhase) is a temporary hack</span><span>
</span><span id="line-907"></span><span>          </span><span class="hs-comment">-- to inline no earlier than phase 2.  I got regressions in</span><span>
</span><span id="line-908"></span><span>          </span><span class="hs-comment">-- 'mate', due to changes in full laziness due to Note [Case</span><span>
</span><span id="line-909"></span><span>          </span><span class="hs-comment">-- MFEs], when I did earlier inlining.</span><span>
</span><span id="line-910"></span><span>
</span><span id="line-911"></span><span>    </span><span class="annot"><a href="#local-6989586621681826365"><span class="hs-identifier hs-type">get_rule_phase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#CompilerPhase"><span class="hs-identifier hs-type">CompilerPhase</span></a></span><span>
</span><span id="line-912"></span><span>    </span><span class="hs-comment">-- The phase /after/ the rule is first active</span><span>
</span><span id="line-913"></span><span>    </span><span id="local-6989586621681826365"><span class="annot"><span class="annottext">get_rule_phase :: CoreRule -&gt; CompilerPhase
</span><a href="#local-6989586621681826365"><span class="hs-identifier hs-var hs-var">get_rule_phase</span></a></span></span><span> </span><span id="local-6989586621681826370"><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621681826370"><span class="hs-identifier hs-var">rule</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompilerPhase -&gt; CompilerPhase
</span><a href="GHC.Types.Basic.html#nextPhase"><span class="hs-identifier hs-var">nextPhase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Activation -&gt; CompilerPhase
</span><a href="GHC.Types.Basic.html#beginPhase"><span class="hs-identifier hs-var">beginPhase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreRule -&gt; Activation
</span><a href="GHC.Core.html#ruleActivation"><span class="hs-identifier hs-var">ruleActivation</span></a></span><span> </span><span class="annot"><span class="annottext">CoreRule
</span><a href="#local-6989586621681826370"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-914"></span><span>
</span><span id="line-915"></span><span class="hs-comment">{-
Note [Demand on the worker]
~~~~~~~~~~~~~~~~~~~~~~~~~~~

If the original function is called once, according to its demand info, then
so is the worker. This is important so that the occurrence analyser can
attach OneShot annotations to the worker&#8217;s lambda binders.


Example:

  -- Original function
  f [Demand=&lt;L,1*C(1,U)&gt;] :: (a,a) -&gt; a
  f = \p -&gt; ...

  -- Wrapper
  f [Demand=&lt;L,1*C(1,U)&gt;] :: a -&gt; a -&gt; a
  f = \p -&gt; case p of (a,b) -&gt; $wf a b

  -- Worker
  $wf [Demand=&lt;L,1*C(1,C(1,U))&gt;] :: Int -&gt; Int
  $wf = \a b -&gt; ...

We need to check whether the original function is called once, with
sufficiently many arguments. This is done using saturatedByOneShots, which
takes the arity of the original function (resp. the wrapper) and the demand on
the original function.

The demand on the worker is then calculated using mkWorkerDemand, and always of
the form [Demand=&lt;L,1*(C(1,...(C(1,U))))&gt;]

Note [Thunk splitting]
~~~~~~~~~~~~~~~~~~~~~~
Suppose x is used strictly; never mind whether it has the CPR
property.  I'll use a '*' to mean &quot;x* is demanded strictly&quot;.

      let
        x* = x-rhs
      in body

splitThunk transforms like this:
      let
        x* = let x = x-rhs in
             case x of { I# a -&gt; I# a }
      in body

This is a little strange: we are re-using the same `x` in the RHS; and
the RHS takes `x` apart and reboxes it. But because the outer 'let' is
strict, and the inner let mentions `x` only once, the simplifier
transform it to
      case x-rhs of
        I# a -&gt; let x* = I# a
                in body

That is good: in `body` we know the form of `x`, which
  * gives the CPR property, and
  * allows case-of-case to happen on x

Notes
* I tried transforming like this:
      let
        x* = let x = x-rhs in
             case x of { I# a -&gt; x }
      in body
  where I return `x` itself, rather than reboxing it.  But this
  turned out to cause some regressions, which I never fully
  investigated.

* Suppose x-rhs is itself a case:
        x-rhs = case e of { T -&gt; I# e1; F -&gt; I# e2 }
  Then we'll get
      join j a = let x* = I# a in body
      in case e of { T -&gt; j e1; F -&gt; j e2 }
  which is good (no boxing).  But in the original, unsplit program
  we would transform
      let x* = case e of ... in body
  ==&gt; join j2 x = body
      in case e of { T -&gt; j2 (I# e1); F -&gt; j (I# e2) }
  which is not good (boxing).

* In fact, splitThunk uses the function argument w/w splitting
  function, mkWWstr_one, so that if x's demand is deeper (say U(U(L,L),L))
  then the splitting will go deeper too.

* For recursive thunks, the Simplifier is unable to float `x-rhs` out of
  `x*`'s RHS, because `x*` occurs freely in `x-rhs`, and will just change it
  back to the original definition, so we just split non-recursive thunks.

Note [Thunk splitting for top-level binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Top-level bindings are never strict. Yet they can be absent, as T14270 shows:

  module T14270 (mkTrApp) where
  mkTrApp x y
    | Just ... &lt;- ... typeRepKind x ...
    = undefined
    | otherwise
    = undefined
  typeRepKind = Tick scc undefined

(T19180 is a profiling-free test case for this)
Note that `typeRepKind` is not exported and its only use site in
`mkTrApp` guards a bottoming expression. Thus, demand analysis
figures out that `typeRepKind` is absent and splits the thunk to

  typeRepKind =
    let typeRepKind = Tick scc undefined in
    let typeRepKind = absentError in
    typeRepKind

But now we have a local binding with an External Name
(See Note [About the NameSorts]). That will trigger a CoreLint error, which we
get around by localising the Id for the auxiliary bindings in 'splitThunk'.
-}</span><span>
</span><span id="line-1029"></span><span>
</span><span id="line-1030"></span><span class="hs-comment">-- | See Note [Thunk splitting].</span><span>
</span><span id="line-1031"></span><span class="hs-comment">--</span><span>
</span><span id="line-1032"></span><span class="hs-comment">-- splitThunk converts the *non-recursive* binding</span><span>
</span><span id="line-1033"></span><span class="hs-comment">--      x = e</span><span>
</span><span id="line-1034"></span><span class="hs-comment">-- into</span><span>
</span><span id="line-1035"></span><span class="hs-comment">--      x = let x' = e in</span><span>
</span><span id="line-1036"></span><span class="hs-comment">--          case x' of I# y -&gt; let x' = I# y in x'</span><span>
</span><span id="line-1037"></span><span class="hs-comment">-- See comments above. Is it not beautifully short?</span><span>
</span><span id="line-1038"></span><span class="hs-comment">-- Moreover, it works just as well when there are</span><span>
</span><span id="line-1039"></span><span class="hs-comment">-- several binders, and if the binders are lifted</span><span>
</span><span id="line-1040"></span><span class="hs-comment">-- E.g.     x = e</span><span>
</span><span id="line-1041"></span><span class="hs-comment">--     --&gt;  x = let x' = e in</span><span>
</span><span id="line-1042"></span><span class="hs-comment">--              case x' of (a,b) -&gt; let x' = (a,b)  in x'</span><span>
</span><span id="line-1043"></span><span class="hs-comment">-- Here, x' is a localised version of x, in case x is a</span><span>
</span><span id="line-1044"></span><span class="hs-comment">-- top-level Id with an External Name, because Lint rejects local binders with</span><span>
</span><span id="line-1045"></span><span class="hs-comment">-- External Names; see Note [About the NameSorts] in GHC.Types.Name.</span><span>
</span><span id="line-1046"></span><span class="hs-comment">--</span><span>
</span><span id="line-1047"></span><span class="hs-comment">-- How can we do thunk-splitting on a top-level binder?  See</span><span>
</span><span id="line-1048"></span><span class="hs-comment">-- Note [Thunk splitting for top-level binders].</span><span>
</span><span id="line-1049"></span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.html#splitThunk"><span class="hs-identifier hs-type">splitThunk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.WorkWrap.Utils.html#WwOpts"><span class="hs-identifier hs-type">WwOpts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#Expr"><span class="hs-identifier hs-type">Expr</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Unique.Supply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Expr"><span class="hs-identifier hs-type">Expr</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1050"></span><span id="splitThunk"><span class="annot"><span class="annottext">splitThunk :: WwOpts -&gt; RecFlag -&gt; Var -&gt; CoreExpr -&gt; UniqSM [(Var, CoreExpr)]
</span><a href="GHC.Core.Opt.WorkWrap.html#splitThunk"><span class="hs-identifier hs-var hs-var">splitThunk</span></a></span></span><span> </span><span id="local-6989586621681826372"><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826372"><span class="hs-identifier hs-var">ww_opts</span></a></span></span><span> </span><span id="local-6989586621681826373"><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681826373"><span class="hs-identifier hs-var">is_rec</span></a></span></span><span> </span><span id="local-6989586621681826374"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826374"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621681826375"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826375"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-1051"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UniqSM [(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826374"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(UniqSM [(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)])
-&gt; UniqSM [(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1052"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681826377"><span class="annot"><span class="annottext">x' :: Var
</span><a href="#local-6989586621681826377"><span class="hs-identifier hs-var hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="GHC.Types.Id.html#localiseId"><span class="hs-identifier hs-var">localiseId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826374"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-comment">-- See comment above</span><span>
</span><span id="line-1053"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681826379"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681826379"><span class="hs-identifier hs-var">useful</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681826380"><span class="annot"><span class="annottext">[(Var, StrictnessMark)]
</span><a href="#local-6989586621681826380"><span class="hs-identifier hs-var">_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681826381"><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681826381"><span class="hs-identifier hs-var">wrap_fn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681826382"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826382"><span class="hs-identifier hs-var">fn_arg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1054"></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WwOpts
-&gt; Var
-&gt; StrictnessMark
-&gt; UniqSM
     (Bool, [(Var, StrictnessMark)], CoreExpr -&gt; CoreExpr, CoreExpr)
</span><a href="GHC.Core.Opt.WorkWrap.Utils.html#mkWWstr_one"><span class="hs-identifier hs-var">mkWWstr_one</span></a></span><span> </span><span class="annot"><span class="annottext">WwOpts
</span><a href="#local-6989586621681826372"><span class="hs-identifier hs-var">ww_opts</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826377"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">StrictnessMark
</span><a href="GHC.Core.DataCon.html#NotMarkedStrict"><span class="hs-identifier hs-var">NotMarkedStrict</span></a></span><span>
</span><span id="line-1055"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681826384"><span class="annot"><span class="annottext">res :: [(Var, CoreExpr)]
</span><a href="#local-6989586621681826384"><span class="hs-identifier hs-var hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826374"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; CoreExpr -&gt; CoreExpr
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; CoreExpr -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826377"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826375"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreExpr -&gt; CoreExpr
</span><a href="#local-6989586621681826381"><span class="hs-identifier hs-var">wrap_fn</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826382"><span class="hs-identifier hs-var">fn_arg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1056"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681826379"><span class="hs-identifier hs-var">useful</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; SDoc
-&gt; ([(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)])
-&gt; [(Var, CoreExpr)]
-&gt; UniqSM [(Var, CoreExpr)]
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isNonRec"><span class="hs-identifier hs-var">isNonRec</span></a></span><span> </span><span class="annot"><span class="annottext">RecFlag
</span><a href="#local-6989586621681826373"><span class="hs-identifier hs-var">is_rec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826374"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- The thunk must be non-recursive</span><span>
</span><span id="line-1057"></span><span>                   </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)]
</span><a href="#local-6989586621681826384"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-1058"></span><span>                   </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[(Var, CoreExpr)] -&gt; UniqSM [(Var, CoreExpr)]
forall a. a -&gt; UniqSM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681826374"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621681826375"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1059"></span></pre></body></html>