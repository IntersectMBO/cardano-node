<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The AQUA Project, Glasgow University, 1993-1998

\section{Common subexpression}
-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Core.Opt.CSE</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseProgram"><span class="hs-identifier">cseProgram</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseOneExpr"><span class="hs-identifier">cseOneExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html"><span class="hs-identifier">GHC.Core.Subst</span></a></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier">Var</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier">mkInScopeSet</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#idType"><span class="hs-identifier">idType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#idHasRules"><span class="hs-identifier">idHasRules</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#zapStableUnfolding"><span class="hs-identifier">zapStableUnfolding</span></a></span><span>
</span><span id="line-15"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#idInlineActivation"><span class="hs-identifier">idInlineActivation</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#setInlineActivation"><span class="hs-identifier">setInlineActivation</span></a></span><span>
</span><span id="line-16"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#zapIdOccInfo"><span class="hs-identifier">zapIdOccInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#zapIdUsageInfo"><span class="hs-identifier">zapIdUsageInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#idInlinePragma"><span class="hs-identifier">idInlinePragma</span></a></span><span>
</span><span id="line-17"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier">isJoinId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#isJoinId_maybe"><span class="hs-identifier">isJoinId_maybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier">idUnfolding</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html"><span class="hs-identifier">GHC.Core.Utils</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkAltExpr"><span class="hs-identifier">mkAltExpr</span></a></span><span>
</span><span id="line-19"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#exprIsTickedString"><span class="hs-identifier">exprIsTickedString</span></a></span><span>
</span><span id="line-20"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#stripTicksE"><span class="hs-identifier">stripTicksE</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#stripTicksT"><span class="hs-identifier">stripTicksT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.Utils.html#mkTicks"><span class="hs-identifier">mkTicks</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html"><span class="hs-identifier">GHC.Core.FVs</span></a></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier">exprFreeVars</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.Type.html#tyConAppArgs"><span class="hs-identifier">tyConAppArgs</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Tickish.html"><span class="hs-identifier">GHC.Types.Tickish</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Map.Expr.html"><span class="hs-identifier">GHC.Core.Map.Expr</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier">filterOut</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-identifier">equalLength</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Functor.Identity.html#/Data.Functor.Identity.html"><span class="hs-identifier">Data.Functor.Identity</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Functor.Identity.html#Identity/Data.Functor.Identity.html#Identity"><span class="hs-identifier">Identity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.List.html#/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Traversable.html#mapAccumL/Data.Traversable.html#mapAccumL"><span class="hs-identifier">mapAccumL</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-comment">{-
                        Simple common sub-expression
                        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we see
        x1 = C a b
        x2 = C x1 b
we build up a reverse mapping:   C a b  -&gt; x1
                                 C x1 b -&gt; x2
and apply that to the rest of the program.

When we then see
        y1 = C a b
        y2 = C y1 b
we replace the C a b with x1.  But then we *dont* want to
add   x1 -&gt; y1  to the mapping.  Rather, we want the reverse, y1 -&gt; x1
so that a subsequent binding
        y2 = C y1 b
will get transformed to C x1 b, and then to x2.

So we carry an extra var-&gt;var substitution which we apply *before* looking up in the
reverse mapping.


Note [Shadowing]
~~~~~~~~~~~~~~~~
We have to be careful about shadowing.
For example, consider
        f = \x -&gt; let y = x+x in
                      h = \x -&gt; x+x
                  in ...

Here we must *not* do CSE on the inner x+x!  The simplifier used to guarantee no
shadowing, but it doesn't any more (it proved too hard), so we clone as we go.
We can simply add clones to the substitution already described.

A similar tricky situation is this, with x_123 and y_123 sharing the same unique:

    let x_123 = e1 in
    let y_123 = e2 in
    let foo = e1

Naively applying e1 = x_123 during CSE we would get:

    let x_123 = e1 in
    let y_123 = e2 in
    let foo = x_123

But x_123 is shadowed by y_123 and things would go terribly wrong! One more reason
why we have to substitute binders as we go so we will properly get:

    let x1 = e1 in
    let x2 = e2 in
    let foo = x1

Note [CSE for bindings]
~~~~~~~~~~~~~~~~~~~~~~~
Let-bindings have two cases, implemented by extendCSEnvWithBinding.

* SUBSTITUTE: applies when the RHS is a variable

     let x = y in ...(h x)....

  Here we want to extend the /substitution/ with x -&gt; y, so that the
  (h x) in the body might CSE with an enclosing (let v = h y in ...).
  NB: the substitution maps InIds, so we extend the substitution with
      a binding for the original InId 'x'

  How can we have a variable on the RHS? Doesn't the simplifier inline them?

    - First, the original RHS might have been (g z) which has CSE'd
      with an enclosing (let y = g z in ...).  This is super-important.
      See #5996:
         x1 = C a b
         x2 = C x1 b
         y1 = C a b
         y2 = C y1 b
      Here we CSE y1's rhs to 'x1', and then we must add (y1-&gt;x1) to
      the substitution so that we can CSE the binding for y2.

    - Second, we use extendCSEnvWithBinding for case expression scrutinees too;
      see Note [CSE for case expressions]

* EXTEND THE REVERSE MAPPING: applies in all other cases

     let x = h y in ...(h y)...

  Here we want to extend the /reverse mapping (cs_map)/ so that
  we CSE the (h y) call to x.

  Note that we use EXTEND even for a trivial expression, provided it
  is not a variable or literal. In particular this /includes/ type
  applications. This can be important (#13156); e.g.
     case f @ Int of { r1 -&gt;
     case f @ Int of { r2 -&gt; ...
  Here we want to common-up the two uses of (f @ Int) so we can
  remove one of the case expressions.

  See also Note [Corner case for case expressions] for another
  reason not to use SUBSTITUTE for all trivial expressions.

Notice that
  - The SUBSTITUTE situation extends the substitution (cs_subst)
  - The EXTEND situation extends the reverse mapping (cs_map)

Notice also that in the SUBSTITUTE case we leave behind a binding
  x = y
even though we /also/ carry a substitution x -&gt; y.  Can we just drop
the binding instead?  Well, not at top level! See Note [Top level and
postInlineUnconditionally] in GHC.Core.Opt.Simplify.Utils; and in any
case CSE applies only to the /bindings/ of the program, and we leave
it to the simplifier to propagate effects to the RULES. Finally, it
doesn't seem worth the effort to discard the nested bindings because
the simplifier will do it next.

Note [CSE for case expressions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  case scrut_expr of x { ...alts... }
This is very like a strict let-binding
  let !x = scrut_expr in ...
So we use (extendCSEnvWithBinding x scrut_expr) to process scrut_expr and x, and as a
result all the stuff under Note [CSE for bindings] applies directly.

For example:

* Trivial scrutinee
     f = \x -&gt; case x of wild {
                 (a:as) -&gt; case a of wild1 {
                             (p,q) -&gt; ...(wild1:as)...

  Here, (wild1:as) is morally the same as (a:as) and hence equal to
  wild. But that's not quite obvious.  In the rest of the compiler we
  want to keep it as (wild1:as), but for CSE purpose that's a bad
  idea.

  By using extendCSEnvWithBinding we add the binding (wild1 -&gt; a) to the substitution,
  which does exactly the right thing.

  (Notice this is exactly backwards to what the simplifier does, which
  is to try to replaces uses of 'a' with uses of 'wild1'.)

  This is the main reason that extendCSEnvWithBinding is called with a trivial rhs.

* Non-trivial scrutinee
     case (f x) of y { pat -&gt; ...let z = f x in ... }

  By using extendCSEnvWithBinding we'll add (f x :-&gt; y) to the cs_map, and
  thereby CSE the inner (f x) to y.

Note [CSE for INLINE and NOINLINE]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There are some subtle interactions of CSE with functions that the user
has marked as INLINE or NOINLINE. (Examples from Roman Leshchinskiy.)
Consider

        yes :: Int  {-# NOINLINE yes #-}
        yes = undefined

        no :: Int   {-# NOINLINE no #-}
        no = undefined

        foo :: Int -&gt; Int -&gt; Int  {-# NOINLINE foo #-}
        foo m n = n

        {-# RULES &quot;foo/no&quot; foo no = id #-}

        bar :: Int -&gt; Int
        bar = foo yes

We do not expect the rule to fire.  But if we do CSE, then we risk
getting yes=no, and the rule does fire.  Actually, it won't because
NOINLINE means that 'yes' will never be inlined, not even if we have
yes=no.  So that's fine (now; perhaps in the olden days, yes=no would
have substituted even if 'yes' was NOINLINE).

But we do need to take care.  Consider

        {-# NOINLINE bar #-}
        bar = &lt;rhs&gt;     -- Same rhs as foo

        foo = &lt;rhs&gt;

If CSE produces
        foo = bar
then foo will never be inlined to &lt;rhs&gt; (when it should be, if &lt;rhs&gt;
is small).  The conclusion here is this:

   We should not add
       &lt;rhs&gt; :-&gt; bar
  to the CSEnv if 'bar' has any constraints on when it can inline;
  that is, if its 'activation' not always active.  Otherwise we
  might replace &lt;rhs&gt; by 'bar', and then later be unable to see that it
  really was &lt;rhs&gt;.

An exception to the rule is when the INLINE pragma is not from the user, e.g. from
WorkWrap (see Note [Wrapper activation]). We can tell because noUserInlineSpec
is then true.

Note that we do not (currently) do CSE on the unfolding stored inside
an Id, even if it is a 'stable' unfolding.  That means that when an
unfolding happens, it is always faithful to what the stable unfolding
originally was.

Note [CSE for stable unfoldings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   {-# Unf = Stable (\pq. build blah) #-}
   foo = x

Here 'foo' has a stable unfolding, but its (optimised) RHS is trivial.
(Turns out that this actually happens for the enumFromTo method of
the Integer instance of Enum in GHC.Enum.)  Suppose moreover that foo's
stable unfolding originates from an INLINE or INLINEABLE pragma on foo.
Then we obviously do NOT want to extend the substitution with (foo-&gt;x),
because we promised to inline foo as what the user wrote.  See similar Note
[Stable unfoldings and postInlineUnconditionally] in GHC.Core.Opt.Simplify.Utils.

Nor do we want to change the reverse mapping. Suppose we have

   foo {-# Unf = Stable (\pq. build blah) #-}
       = &lt;expr&gt;
   bar = &lt;expr&gt;

There could conceivably be merit in rewriting the RHS of bar:
   bar = foo
but now bar's inlining behaviour will change, and importing
modules might see that.  So it seems dodgy and we don't do it.

Wrinkles

* Stable unfoldings are also created during worker/wrapper when we
  decide that a function's definition is so small that it should
  always inline, or indeed for the wrapper function itself.  In this
  case we still want to do CSE (#13340). Hence the use of
  isStableUserUnfolding/isStableSystemUnfolding rather than
  isStableUnfolding.

* Consider
     foo = &lt;expr&gt;
     bar {-# Unf = Stable ... #-}
        = &lt;expr&gt;
  where the unfolding was added by strictness analysis, say.  Then
  CSE goes ahead, so we get
     bar = foo
  and probably use SUBSTITUTE that will make 'bar' dead.  But just
  possibly not -- see Note [Dealing with ticks].  In that case we might
  be left with
     bar = tick t1 (tick t2 foo)
  in which case we would really like to get rid of the stable unfolding
  (generated by the strictness analyser, say).

  Hence the zapStableUnfolding in cse_bind.  Not a big deal, and only
  makes a difference when ticks get into the picture.

Note [Corner case for case expressions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here is another reason that we do not use SUBSTITUTE for
all trivial expressions. Consider
   case x |&gt; co of (y::Array# Int) { ... }

We do not want to extend the substitution with (y -&gt; x |&gt; co); since y
is of unlifted type, this would destroy the let-can-float invariant if
(x |&gt; co) was not ok-for-speculation.

But surely (x |&gt; co) is ok-for-speculation, because it's a trivial
expression, and x's type is also unlifted, presumably.  Well, maybe
not if you are using unsafe casts.  I actually found a case where we
had
   (x :: HValue) |&gt; (UnsafeCo :: HValue ~ Array# Int)

Note [CSE for join points?]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
We must not be naive about join points in CSE:
   join j = e in
   if b then jump j else 1 + e
The expression (1 + jump j) is not good (see Note [Invariants on join points] in
GHC.Core). This seems to come up quite seldom, but it happens (first seen
compiling ppHtml in Haddock.Backends.Xhtml).

We could try and be careful by tracking which join points are still valid at
each subexpression, but since join points aren't allocated or shared, there's
less to gain by trying to CSE them. (#13219)

Note [Look inside join-point binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Another way how CSE for join points is tricky is

  let join foo x = (x, 42)
      join bar x = (x, 42)
  in &#8230; jump foo 1 &#8230; jump bar 2 &#8230;

naively, CSE would turn this into

  let join foo x = (x, 42)
      join bar = foo
  in &#8230; jump foo 1 &#8230; jump bar 2 &#8230;

but now bar is a join point that claims arity one, but its right-hand side
is not a lambda, breaking the join-point invariant (this was #15002).

So `cse_bind` must zoom past the lambdas of a join point (using
`collectNBinders`) and resume searching for CSE opportunities only in
the body of the join point.

Note [CSE for recursive bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  f = \x ... f....
  g = \y ... g ...
where the &quot;...&quot; are identical.  Could we CSE them?  In full generality
with mutual recursion it's quite hard; but for self-recursive bindings
(which are very common) it's rather easy:

* Maintain a separate cs_rec_map, that maps
      (\f. (\x. ...f...) ) -&gt; f
  Note the \f in the domain of the mapping!

* When we come across the binding for 'g', look up (\g. (\y. ...g...))
  Bingo we get a hit.  So we can replace the 'g' binding with
     g = f

We can't use cs_map for this, because the key isn't an expression of
the program; it's a kind of synthetic key for recursive bindings.

Note [Separate envs for let rhs and body]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Substituting occurrences of the binder in the rhs with the
 renamed binder is wrong for non-recursive bindings. Why?
Consider this core.

    let {x_123 = e} in
    let {y_123 = \eta0 -&gt; x_123} in ...

In the second line the y_123 on the lhs and x_123 on the rhs refer to different binders
even if they share the same unique.

If we apply the substitution `123 =&gt; x2_124}` to both the lhs and rhs we  will transform
`let y_123 = \eta0 -&gt; x_123` into `let x2_124 = \eta0 -&gt; x2_124`.
However x2_124 on the rhs is not in scope and really shouldn't have been renamed at all.
Because really this should still be x_123! In fact this exact thing happened in #21685.

To fix this we pass two different cse envs to cse_bind. One we use the cse the rhs of the binding.
And one we update with the result of cseing the rhs which we then use going forward for the
body/rest of the module.

************************************************************************
*                                                                      *
\section{Common subexpression}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseProgram"><span class="hs-identifier hs-type">cseProgram</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a></span><span>
</span><span id="line-386"></span><span id="cseProgram"><span class="annot"><span class="annottext">cseProgram :: CoreProgram -&gt; CoreProgram
</span><a href="GHC.Core.Opt.CSE.html#cseProgram"><span class="hs-identifier hs-var hs-var">cseProgram</span></a></span></span><span> </span><span id="local-6989586621681635067"><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681635067"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CSEnv, CoreProgram) -&gt; CoreProgram
forall a b. (a, b) -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Tuple.html#snd/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CSEnv -&gt; CoreBind -&gt; (CSEnv, CoreBind))
-&gt; CSEnv -&gt; CoreProgram -&gt; (CSEnv, CoreProgram)
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#mapAccumL/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelFlag -&gt; CSEnv -&gt; CoreBind -&gt; (CSEnv, CoreBind)
</span><a href="GHC.Core.Opt.CSE.html#cseBind"><span class="hs-identifier hs-var">cseBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="GHC.Core.Opt.CSE.html#emptyCSEnv"><span class="hs-identifier hs-var">emptyCSEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CoreProgram
</span><a href="#local-6989586621681635067"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-387"></span><span>
</span><span id="line-388"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseBind"><span class="hs-identifier hs-type">cseBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span id="cseBind"><span class="annot"><span class="annottext">cseBind :: TopLevelFlag -&gt; CSEnv -&gt; CoreBind -&gt; (CSEnv, CoreBind)
</span><a href="GHC.Core.Opt.CSE.html#cseBind"><span class="hs-identifier hs-var hs-var">cseBind</span></a></span></span><span> </span><span id="local-6989586621681635072"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681635072"><span class="hs-identifier hs-var">toplevel</span></a></span></span><span> </span><span id="local-6989586621681635073"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635073"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621681635075"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635075"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681635076"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635076"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635077"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Expr Var -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635078"><span class="hs-identifier hs-var">b2</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635079"><span class="hs-identifier hs-var">e2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-391"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-392"></span><span>    </span><span class="hs-comment">-- See Note [Separate envs for let rhs and body]</span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681635080"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635080"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635081"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635081"><span class="hs-identifier hs-var">b1</span></a></span></span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Var -&gt; (CSEnv, Var)
</span><a href="GHC.Core.Opt.CSE.html#addBinder"><span class="hs-identifier hs-var">addBinder</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635073"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635075"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-394"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681635077"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635077"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681635078"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635078"><span class="hs-identifier hs-var">b2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635079"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635079"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; CSEnv
-&gt; CSEnv
-&gt; (Var, Expr Var)
-&gt; Var
-&gt; (CSEnv, (Var, Expr Var))
</span><a href="GHC.Core.Opt.CSE.html#cse_bind"><span class="hs-identifier hs-var">cse_bind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681635072"><span class="hs-identifier hs-var">toplevel</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635073"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635080"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635075"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635076"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635081"><span class="hs-identifier hs-var">b1</span></a></span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseBind"><span class="hs-identifier hs-var">cseBind</span></a></span><span> </span><span id="local-6989586621681635084"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681635084"><span class="hs-identifier hs-var">toplevel</span></a></span></span><span> </span><span id="local-6989586621681635085"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635085"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span id="local-6989586621681635087"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635087"><span class="hs-identifier hs-var">in_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635088"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635088"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Core.Opt.CSE.html#noCSE"><span class="hs-identifier hs-var">noCSE</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635087"><span class="hs-identifier hs-var">in_id</span></a></span><span>
</span><span id="line-398"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635090"><span class="hs-identifier hs-var">env1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Var, Expr Var)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635091"><span class="hs-identifier hs-var">out_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635092"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>  </span><span class="hs-comment">-- See Note [CSE for recursive bindings]</span><span>
</span><span id="line-401"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681635093"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635093"><span class="hs-identifier hs-var">previous</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Var -&gt; Expr Var -&gt; Maybe (Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#lookupCSRecEnv"><span class="hs-identifier hs-var">lookupCSRecEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635085"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635091"><span class="hs-identifier hs-var">out_id</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635095"><span class="hs-identifier hs-var">rhs''</span></a></span><span>
</span><span id="line-402"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681635096"><span class="annot"><span class="annottext">previous' :: Expr Var
</span><a href="#local-6989586621681635096"><span class="hs-identifier hs-var hs-var">previous'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CoreTickish] -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Utils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681635097"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635093"><span class="hs-identifier hs-var">previous</span></a></span><span>
</span><span id="line-403"></span><span>        </span><span id="local-6989586621681635098"><span class="annot"><span class="annottext">out_id' :: Var
</span><a href="#local-6989586621681635098"><span class="hs-identifier hs-var hs-var">out_id'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Var -&gt; Var
</span><a href="GHC.Core.Opt.CSE.html#delayInlining"><span class="hs-identifier hs-var">delayInlining</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681635084"><span class="hs-identifier hs-var">toplevel</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635091"><span class="hs-identifier hs-var">out_id</span></a></span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- We have a hit in the recursive-binding cache</span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Var -&gt; Expr Var -&gt; CSEnv
</span><a href="GHC.Core.Opt.CSE.html#extendCSSubst"><span class="hs-identifier hs-var">extendCSSubst</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635090"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635087"><span class="hs-identifier hs-var">in_id</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635096"><span class="hs-identifier hs-var">previous'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Expr Var -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635098"><span class="hs-identifier hs-var">out_id'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635096"><span class="hs-identifier hs-var">previous'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-408"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Var -&gt; Expr Var -&gt; Expr Var -&gt; CSEnv
</span><a href="GHC.Core.Opt.CSE.html#extendCSRecEnv"><span class="hs-identifier hs-var">extendCSRecEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635090"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635091"><span class="hs-identifier hs-var">out_id</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635095"><span class="hs-identifier hs-var">rhs''</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635102"><span class="hs-identifier hs-var">id_expr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Var, Expr Var)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635103"><span class="hs-identifier hs-var">zapped_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635092"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681635090"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635090"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Functor.Identity.html#Identity/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-type">Identity</span></a></span><span> </span><span id="local-6989586621681635091"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635091"><span class="hs-identifier hs-var">out_id</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Identity Var -&gt; (CSEnv, Identity Var)
forall (f :: * -&gt; *).
Traversable f =&gt;
CSEnv -&gt; f Var -&gt; (CSEnv, f Var)
</span><a href="GHC.Core.Opt.CSE.html#addRecBinders"><span class="hs-identifier hs-var">addRecBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635085"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Identity Var
forall a. a -&gt; Identity a
</span><a href="../../base-4.18.2.1/src/Data.Functor.Identity.html#Identity/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-var">Identity</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635087"><span class="hs-identifier hs-var">in_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>    </span><span id="local-6989586621681635092"><span class="annot"><span class="annottext">rhs' :: Expr Var
</span><a href="#local-6989586621681635092"><span class="hs-identifier hs-var hs-var">rhs'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635090"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635088"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-413"></span><span>    </span><span id="local-6989586621681635095"><span class="annot"><span class="annottext">rhs'' :: Expr Var
</span><a href="#local-6989586621681635095"><span class="hs-identifier hs-var hs-var">rhs''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; Expr Var -&gt; Expr Var
forall b. (CoreTickish -&gt; Bool) -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.Utils.html#stripTicksE"><span class="hs-identifier hs-var">stripTicksE</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635092"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-414"></span><span>    </span><span id="local-6989586621681635097"><span class="annot"><span class="annottext">ticks :: [CoreTickish]
</span><a href="#local-6989586621681635097"><span class="hs-identifier hs-var hs-var">ticks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; Expr Var -&gt; [CoreTickish]
forall b. (CoreTickish -&gt; Bool) -&gt; Expr b -&gt; [CoreTickish]
</span><a href="GHC.Core.Utils.html#stripTicksT"><span class="hs-identifier hs-var">stripTicksT</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635092"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-415"></span><span>    </span><span id="local-6989586621681635102"><span class="annot"><span class="annottext">id_expr' :: Expr Var
</span><a href="#local-6989586621681635102"><span class="hs-identifier hs-var hs-var">id_expr'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Expr Var
forall b. Var -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635091"><span class="hs-identifier hs-var">out_id</span></a></span><span>
</span><span id="line-416"></span><span>    </span><span id="local-6989586621681635103"><span class="annot"><span class="annottext">zapped_id :: Var
</span><a href="#local-6989586621681635103"><span class="hs-identifier hs-var hs-var">zapped_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="GHC.Types.Id.html#zapIdUsageInfo"><span class="hs-identifier hs-var">zapIdUsageInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635091"><span class="hs-identifier hs-var">out_id</span></a></span><span>
</span><span id="line-417"></span><span>
</span><span id="line-418"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseBind"><span class="hs-identifier hs-var">cseBind</span></a></span><span> </span><span id="local-6989586621681635109"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681635109"><span class="hs-identifier hs-var">toplevel</span></a></span></span><span> </span><span id="local-6989586621681635110"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635110"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621681635111"><span class="annot"><span class="annottext">[(Var, Expr Var)]
</span><a href="#local-6989586621681635111"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635112"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Var, Expr Var)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">[(Var, Expr Var)]
</span><a href="#local-6989586621681635113"><span class="hs-identifier hs-var">pairs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-421"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681635114"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635114"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635115"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635115"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; [Var] -&gt; (CSEnv, [Var])
forall (f :: * -&gt; *).
Traversable f =&gt;
CSEnv -&gt; f Var -&gt; (CSEnv, f Var)
</span><a href="GHC.Core.Opt.CSE.html#addRecBinders"><span class="hs-identifier hs-var">addRecBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635110"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Var, Expr Var) -&gt; Var) -&gt; [(Var, Expr Var)] -&gt; [Var]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Var, Expr Var) -&gt; Var
forall a b. (a, b) -&gt; a
</span><a href="../../base-4.18.2.1/src/Data.Tuple.html#fst/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">[(Var, Expr Var)]
</span><a href="#local-6989586621681635111"><span class="hs-identifier hs-var">pairs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681635112"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635112"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635113"><span class="annot"><span class="annottext">[(Var, Expr Var)]
</span><a href="#local-6989586621681635113"><span class="hs-identifier hs-var">pairs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CSEnv -&gt; ((Var, Expr Var), Var) -&gt; (CSEnv, (Var, Expr Var)))
-&gt; CSEnv -&gt; [((Var, Expr Var), Var)] -&gt; (CSEnv, [(Var, Expr Var)])
forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><a href="../../base-4.18.2.1/src/Data.Traversable.html#mapAccumL/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; ((Var, Expr Var), Var) -&gt; (CSEnv, (Var, Expr Var))
</span><a href="#local-6989586621681635117"><span class="hs-identifier hs-var">do_one</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635114"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Var, Expr Var)] -&gt; [Var] -&gt; [((Var, Expr Var), Var)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../base-4.18.2.1/src/GHC.List.html#zip/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a></span><span> </span><span class="annot"><span class="annottext">[(Var, Expr Var)]
</span><a href="#local-6989586621681635111"><span class="hs-identifier hs-var">pairs</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635115"><span class="hs-identifier hs-var">bndrs1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span>    </span><span id="local-6989586621681635117"><span class="annot"><span class="annottext">do_one :: CSEnv -&gt; ((Var, Expr Var), Var) -&gt; (CSEnv, (Var, Expr Var))
</span><a href="#local-6989586621681635117"><span class="hs-identifier hs-var hs-var">do_one</span></a></span></span><span> </span><span id="local-6989586621681635118"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635118"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681635119"><span class="annot"><span class="annottext">(Var, Expr Var)
</span><a href="#local-6989586621681635119"><span class="hs-identifier hs-var">pr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635120"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635120"><span class="hs-identifier hs-var">b1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
-&gt; CSEnv
-&gt; CSEnv
-&gt; (Var, Expr Var)
-&gt; Var
-&gt; (CSEnv, (Var, Expr Var))
</span><a href="GHC.Core.Opt.CSE.html#cse_bind"><span class="hs-identifier hs-var">cse_bind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681635109"><span class="hs-identifier hs-var">toplevel</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635118"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635118"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(Var, Expr Var)
</span><a href="#local-6989586621681635119"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635120"><span class="hs-identifier hs-var">b1</span></a></span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span class="hs-comment">-- | Given a binding of @in_id@ to @in_rhs@, and a fresh name to refer</span><span>
</span><span id="line-427"></span><span class="hs-comment">-- to @in_id@ (@out_id@, created from addBinder or addRecBinders),</span><span>
</span><span id="line-428"></span><span class="hs-comment">-- first try to CSE @in_rhs@, and then add the resulting (possibly CSE'd)</span><span>
</span><span id="line-429"></span><span class="hs-comment">-- binding to the 'CSEnv', so that we attempt to CSE any expressions</span><span>
</span><span id="line-430"></span><span class="hs-comment">-- which are equal to @out_rhs@.</span><span>
</span><span id="line-431"></span><span class="hs-comment">-- We use a different env for cse on the rhs and for extendCSEnvWithBinding</span><span>
</span><span id="line-432"></span><span class="hs-comment">-- for reasons explain in See Note [Separate envs for let rhs and body]</span><span>
</span><span id="line-433"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cse_bind"><span class="hs-identifier hs-type">cse_bind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span id="cse_bind"><span class="annot"><span class="annottext">cse_bind :: TopLevelFlag
-&gt; CSEnv
-&gt; CSEnv
-&gt; (Var, Expr Var)
-&gt; Var
-&gt; (CSEnv, (Var, Expr Var))
</span><a href="GHC.Core.Opt.CSE.html#cse_bind"><span class="hs-identifier hs-var hs-var">cse_bind</span></a></span></span><span> </span><span id="local-6989586621681635125"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681635125"><span class="hs-identifier hs-var">toplevel</span></a></span></span><span> </span><span id="local-6989586621681635126"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635126"><span class="hs-identifier hs-var">env_rhs</span></a></span></span><span> </span><span id="local-6989586621681635127"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635127"><span class="hs-identifier hs-var">env_body</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681635128"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635128"><span class="hs-identifier hs-var">in_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635129"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635129"><span class="hs-identifier hs-var">in_rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681635130"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635130"><span class="hs-identifier hs-var">out_id</span></a></span></span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681635125"><span class="hs-identifier hs-var">toplevel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Var -&gt; Bool
</span><a href="GHC.Core.Utils.html#exprIsTickedString"><span class="hs-identifier hs-var">exprIsTickedString</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635129"><span class="hs-identifier hs-var">in_rhs</span></a></span><span>
</span><span id="line-436"></span><span>      </span><span class="hs-comment">-- See Note [Take care with literal strings]</span><span>
</span><span id="line-437"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635132"><span class="hs-identifier hs-var">env_body'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635133"><span class="hs-identifier hs-var">out_id'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635129"><span class="hs-identifier hs-var">in_rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681635134"><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621681635134"><span class="hs-identifier hs-var">arity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Maybe JoinArity
</span><a href="GHC.Types.Id.html#isJoinId_maybe"><span class="hs-identifier hs-var">isJoinId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635130"><span class="hs-identifier hs-var">out_id</span></a></span><span>
</span><span id="line-440"></span><span>      </span><span class="hs-comment">-- See Note [Look inside join-point binders]</span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681635135"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635135"><span class="hs-identifier hs-var">params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635136"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635136"><span class="hs-identifier hs-var">in_body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">JoinArity -&gt; Expr Var -&gt; ([Var], Expr Var)
forall b. JoinArity -&gt; Expr b -&gt; ([b], Expr b)
</span><a href="GHC.Core.html#collectNBinders"><span class="hs-identifier hs-var">collectNBinders</span></a></span><span> </span><span class="annot"><span class="annottext">JoinArity
</span><a href="#local-6989586621681635134"><span class="hs-identifier hs-var">arity</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635129"><span class="hs-identifier hs-var">in_rhs</span></a></span><span>
</span><span id="line-442"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681635138"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635138"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635139"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635139"><span class="hs-identifier hs-var">params'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; [Var] -&gt; (CSEnv, [Var])
</span><a href="GHC.Core.Opt.CSE.html#addBinders"><span class="hs-identifier hs-var">addBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635126"><span class="hs-identifier hs-var">env_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635135"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-443"></span><span>        </span><span id="local-6989586621681635141"><span class="annot"><span class="annottext">out_body :: Expr Var
</span><a href="#local-6989586621681635141"><span class="hs-identifier hs-var hs-var">out_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#tryForCSE"><span class="hs-identifier hs-var">tryForCSE</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635138"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635136"><span class="hs-identifier hs-var">in_body</span></a></span><span>
</span><span id="line-444"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635127"><span class="hs-identifier hs-var">env_body</span></a></span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635130"><span class="hs-identifier hs-var">out_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; Expr Var -&gt; Expr Var
forall b. [b] -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635139"><span class="hs-identifier hs-var">params'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635141"><span class="hs-identifier hs-var">out_body</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-447"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635132"><span class="hs-identifier hs-var">env_body'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635144"><span class="hs-identifier hs-var">out_id''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635145"><span class="hs-identifier hs-var">out_rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-449"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681635132"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635132"><span class="hs-identifier hs-var">env_body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635133"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635133"><span class="hs-identifier hs-var">out_id'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Var -&gt; Var -&gt; Expr Var -&gt; Bool -&gt; (CSEnv, Var)
</span><a href="GHC.Core.Opt.CSE.html#extendCSEnvWithBinding"><span class="hs-identifier hs-var">extendCSEnvWithBinding</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635127"><span class="hs-identifier hs-var">env_body</span></a></span><span>  </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635128"><span class="hs-identifier hs-var">in_id</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635130"><span class="hs-identifier hs-var">out_id</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635145"><span class="hs-identifier hs-var">out_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635147"><span class="hs-identifier hs-var">cse_done</span></a></span><span>
</span><span id="line-450"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681635147"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635147"><span class="hs-identifier hs-var">cse_done</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635145"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635145"><span class="hs-identifier hs-var">out_rhs</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; (Bool, Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#try_for_cse"><span class="hs-identifier hs-var">try_for_cse</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635126"><span class="hs-identifier hs-var">env_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635129"><span class="hs-identifier hs-var">in_rhs</span></a></span><span>
</span><span id="line-451"></span><span>    </span><span id="local-6989586621681635144"><span class="annot"><span class="annottext">out_id'' :: Var
</span><a href="#local-6989586621681635144"><span class="hs-identifier hs-var hs-var">out_id''</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635147"><span class="hs-identifier hs-var">cse_done</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="GHC.Types.Id.html#zapStableUnfolding"><span class="hs-identifier hs-var">zapStableUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">(Var -&gt; Var) -&gt; Var -&gt; Var
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-452"></span><span>                           </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Var -&gt; Var
</span><a href="GHC.Core.Opt.CSE.html#delayInlining"><span class="hs-identifier hs-var">delayInlining</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681635125"><span class="hs-identifier hs-var">toplevel</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635133"><span class="hs-identifier hs-var">out_id'</span></a></span><span>
</span><span id="line-453"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635133"><span class="hs-identifier hs-var">out_id'</span></a></span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#delayInlining"><span class="hs-identifier hs-type">delayInlining</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>
</span><span id="line-456"></span><span class="hs-comment">-- Add a NOINLINE[2] if the Id doesn't have an INLNE pragma already</span><span>
</span><span id="line-457"></span><span class="hs-comment">-- See Note [Delay inlining after CSE]</span><span>
</span><span id="line-458"></span><span id="delayInlining"><span class="annot"><span class="annottext">delayInlining :: TopLevelFlag -&gt; Var -&gt; Var
</span><a href="GHC.Core.Opt.CSE.html#delayInlining"><span class="hs-identifier hs-var hs-var">delayInlining</span></a></span></span><span> </span><span id="local-6989586621681635149"><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681635149"><span class="hs-identifier hs-var">top_lvl</span></a></span></span><span> </span><span id="local-6989586621681635150"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635150"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-459"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; Bool
</span><a href="GHC.Types.Basic.html#isTopLevel"><span class="hs-identifier hs-var">isTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="#local-6989586621681635149"><span class="hs-identifier hs-var">top_lvl</span></a></span><span>
</span><span id="line-460"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Activation
</span><a href="GHC.Types.Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635150"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Id.html#idHasRules"><span class="hs-identifier hs-var">idHasRules</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635150"><span class="hs-identifier hs-var">bndr</span></a></span><span>  </span><span class="hs-comment">-- Only if the Id has some RULES,</span><span>
</span><span id="line-462"></span><span>                     </span><span class="hs-comment">-- which might otherwise get lost</span><span>
</span><span id="line-463"></span><span>       </span><span class="hs-comment">-- These rules are probably auto-generated specialisations,</span><span>
</span><span id="line-464"></span><span>       </span><span class="hs-comment">-- since Ids with manual rules usually have manually-inserted</span><span>
</span><span id="line-465"></span><span>       </span><span class="hs-comment">-- delayed inlining anyway</span><span>
</span><span id="line-466"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635150"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Var -&gt; Activation -&gt; Var
</span><a href="GHC.Types.Id.html#setInlineActivation"><span class="hs-operator hs-var">`setInlineActivation`</span></a></span><span> </span><span class="annot"><span class="annottext">Activation
</span><a href="GHC.Types.Basic.html#activateAfterInitial"><span class="hs-identifier hs-var">activateAfterInitial</span></a></span><span>
</span><span id="line-467"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-468"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635150"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-469"></span><span>
</span><span id="line-470"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#extendCSEnvWithBinding"><span class="hs-identifier hs-type">extendCSEnvWithBinding</span></a></span><span>
</span><span id="line-471"></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span>            </span><span class="hs-comment">-- Includes InId-&gt;OutId cloning</span><span>
</span><span id="line-472"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span>            </span><span class="hs-comment">-- Could be a let-bound type</span><span>
</span><span id="line-473"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-comment">-- Processed binding</span><span>
</span><span id="line-474"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>             </span><span class="hs-comment">-- True &lt;=&gt; RHS was CSE'd and is a variable</span><span>
</span><span id="line-475"></span><span>                               </span><span class="hs-comment">--          or maybe (Tick t variable)</span><span>
</span><span id="line-476"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Final env, final bndr</span><span>
</span><span id="line-477"></span><span class="hs-comment">-- Extend the CSE env with a mapping [rhs -&gt; out-id]</span><span>
</span><span id="line-478"></span><span class="hs-comment">-- unless we can instead just substitute [in-id -&gt; rhs]</span><span>
</span><span id="line-479"></span><span class="hs-comment">--</span><span>
</span><span id="line-480"></span><span class="hs-comment">-- It's possible for the binder to be a type variable,</span><span>
</span><span id="line-481"></span><span class="hs-comment">-- in which case we can just substitute.</span><span>
</span><span id="line-482"></span><span class="hs-comment">-- See Note [CSE for bindings]</span><span>
</span><span id="line-483"></span><span id="extendCSEnvWithBinding"><span class="annot"><span class="annottext">extendCSEnvWithBinding :: CSEnv -&gt; Var -&gt; Var -&gt; Expr Var -&gt; Bool -&gt; (CSEnv, Var)
</span><a href="GHC.Core.Opt.CSE.html#extendCSEnvWithBinding"><span class="hs-identifier hs-var hs-var">extendCSEnvWithBinding</span></a></span></span><span> </span><span id="local-6989586621681635154"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635154"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681635155"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635155"><span class="hs-identifier hs-var">in_id</span></a></span></span><span> </span><span id="local-6989586621681635156"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635156"><span class="hs-identifier hs-var">out_id</span></a></span></span><span> </span><span id="local-6989586621681635157"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635157"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span id="local-6989586621681635158"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635158"><span class="hs-identifier hs-var">cse_done</span></a></span></span><span>
</span><span id="line-484"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Var.html#isId"><span class="hs-identifier hs-var">isId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635156"><span class="hs-identifier hs-var">out_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Var -&gt; Expr Var -&gt; CSEnv
</span><a href="GHC.Core.Opt.CSE.html#extendCSSubst"><span class="hs-identifier hs-var">extendCSSubst</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635154"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635155"><span class="hs-identifier hs-var">in_id</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635157"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">,</span><span>     </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635156"><span class="hs-identifier hs-var">out_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Core.Opt.CSE.html#noCSE"><span class="hs-identifier hs-var">noCSE</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635156"><span class="hs-identifier hs-var">out_id</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635154"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span>                              </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635156"><span class="hs-identifier hs-var">out_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635161"><span class="hs-identifier hs-var">use_subst</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Var -&gt; Expr Var -&gt; CSEnv
</span><a href="GHC.Core.Opt.CSE.html#extendCSSubst"><span class="hs-identifier hs-var">extendCSSubst</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635154"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635155"><span class="hs-identifier hs-var">in_id</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635157"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">,</span><span>     </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635156"><span class="hs-identifier hs-var">out_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635158"><span class="hs-identifier hs-var">cse_done</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635154"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span>                              </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635156"><span class="hs-identifier hs-var">out_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>                       </span><span class="hs-comment">-- See Note [Dealing with ticks]</span><span>
</span><span id="line-489"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var -&gt; CSEnv
</span><a href="GHC.Core.Opt.CSE.html#extendCSEnv"><span class="hs-identifier hs-var">extendCSEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635154"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635157"><span class="hs-identifier hs-var">rhs'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635163"><span class="hs-identifier hs-var">id_expr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635164"><span class="hs-identifier hs-var">zapped_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-491"></span><span>    </span><span id="local-6989586621681635163"><span class="annot"><span class="annottext">id_expr' :: Expr Var
</span><a href="#local-6989586621681635163"><span class="hs-identifier hs-var hs-var">id_expr'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Expr Var
forall b. Var -&gt; Expr b
</span><a href="GHC.Core.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635156"><span class="hs-identifier hs-var">out_id</span></a></span><span>
</span><span id="line-492"></span><span>    </span><span id="local-6989586621681635164"><span class="annot"><span class="annottext">zapped_id :: Var
</span><a href="#local-6989586621681635164"><span class="hs-identifier hs-var hs-var">zapped_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="GHC.Types.Id.html#zapIdUsageInfo"><span class="hs-identifier hs-var">zapIdUsageInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635156"><span class="hs-identifier hs-var">out_id</span></a></span><span>
</span><span id="line-493"></span><span>       </span><span class="hs-comment">-- Putting the Id into the cs_map makes it possible that</span><span>
</span><span id="line-494"></span><span>       </span><span class="hs-comment">-- it'll become shared more than it is now, which would</span><span>
</span><span id="line-495"></span><span>       </span><span class="hs-comment">-- invalidate (the usage part of) its demand info.</span><span>
</span><span id="line-496"></span><span>       </span><span class="hs-comment">--    This caused #100218.</span><span>
</span><span id="line-497"></span><span>       </span><span class="hs-comment">-- Easiest thing is to zap the usage info; subsequently</span><span>
</span><span id="line-498"></span><span>       </span><span class="hs-comment">-- performing late demand-analysis will restore it.  Don't zap</span><span>
</span><span id="line-499"></span><span>       </span><span class="hs-comment">-- the strictness info; it's not necessary to do so, and losing</span><span>
</span><span id="line-500"></span><span>       </span><span class="hs-comment">-- it is bad for performance if you don't do late demand</span><span>
</span><span id="line-501"></span><span>       </span><span class="hs-comment">-- analysis</span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-comment">-- Should we use SUBSTITUTE or EXTEND?</span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-comment">-- See Note [CSE for bindings]</span><span>
</span><span id="line-505"></span><span>    </span><span id="local-6989586621681635161"><span class="annot"><span class="annottext">use_subst :: Bool
</span><a href="#local-6989586621681635161"><span class="hs-identifier hs-var hs-var">use_subst</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635157"><span class="hs-identifier hs-var">rhs'</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-506"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span class="hs-comment">-- | Given a binder `let x = e`, this function</span><span>
</span><span id="line-509"></span><span class="hs-comment">-- determines whether we should add `e -&gt; x` to the cs_map</span><span>
</span><span id="line-510"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#noCSE"><span class="hs-identifier hs-type">noCSE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-511"></span><span id="noCSE"><span class="annot"><span class="annottext">noCSE :: Var -&gt; Bool
</span><a href="GHC.Core.Opt.CSE.html#noCSE"><span class="hs-identifier hs-var hs-var">noCSE</span></a></span></span><span> </span><span id="local-6989586621681635166"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635166"><span class="hs-identifier hs-var">id</span></a></span></span><span>
</span><span id="line-512"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Bool
</span><a href="GHC.Types.Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635166"><span class="hs-identifier hs-var">id</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635167"><span class="hs-identifier hs-var">no_cse</span></a></span><span>  </span><span class="hs-comment">-- See Note [CSE for join points?]</span><span>
</span><span id="line-513"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Unfolding -&gt; Bool
</span><a href="GHC.Core.html#isStableUserUnfolding"><span class="hs-identifier hs-var">isStableUserUnfolding</span></a></span><span>  </span><span class="annot"><span class="annottext">Unfolding
</span><a href="#local-6989586621681635169"><span class="hs-identifier hs-var">unf</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635167"><span class="hs-identifier hs-var">no_cse</span></a></span><span>  </span><span class="hs-comment">-- See Note [CSE for stable unfoldings]</span><span>
</span><span id="line-514"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635170"><span class="hs-identifier hs-var">user_activation_control</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635167"><span class="hs-identifier hs-var">no_cse</span></a></span><span>  </span><span class="hs-comment">-- See Note [CSE for INLINE and NOINLINE]</span><span>
</span><span id="line-515"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635171"><span class="hs-identifier hs-var">yes_cse</span></a></span><span>
</span><span id="line-516"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-517"></span><span>     </span><span id="local-6989586621681635169"><span class="annot"><span class="annottext">unf :: Unfolding
</span><a href="#local-6989586621681635169"><span class="hs-identifier hs-var hs-var">unf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IdUnfoldingFun
</span><a href="GHC.Types.Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635166"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-518"></span><span>     </span><span id="local-6989586621681635170"><span class="annot"><span class="annottext">user_activation_control :: Bool
</span><a href="#local-6989586621681635170"><span class="hs-identifier hs-var hs-var">user_activation_control</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Activation -&gt; Bool
</span><a href="GHC.Types.Basic.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Activation
</span><a href="GHC.Types.Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635166"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span>                            </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InlineSpec -&gt; Bool
</span><a href="GHC.Types.Basic.html#noUserInlineSpec"><span class="hs-identifier hs-var">noUserInlineSpec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InlinePragma -&gt; InlineSpec
</span><a href="GHC.Types.Basic.html#inlinePragmaSpec"><span class="hs-identifier hs-var">inlinePragmaSpec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; InlinePragma
</span><a href="GHC.Types.Id.html#idInlinePragma"><span class="hs-identifier hs-var">idInlinePragma</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635166"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>     </span><span id="local-6989586621681635171"><span class="annot"><span class="annottext">yes_cse :: Bool
</span><a href="#local-6989586621681635171"><span class="hs-identifier hs-var hs-var">yes_cse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-521"></span><span>     </span><span id="local-6989586621681635167"><span class="annot"><span class="annottext">no_cse :: Bool
</span><a href="#local-6989586621681635167"><span class="hs-identifier hs-var hs-var">no_cse</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span class="hs-comment">{- Note [Take care with literal strings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this example:

  x = &quot;foo&quot;#
  y = &quot;foo&quot;#
  ...x...y...x...y....

We would normally turn this into:

  x = &quot;foo&quot;#
  y = x
  ...x...x...x...x....

But this breaks an invariant of Core, namely that the RHS of a top-level binding
of type Addr# must be a string literal, not another variable. See Note
[Core top-level string literals] in GHC.Core.

For this reason, we special case top-level bindings to literal strings and leave
the original RHS unmodified. This produces:

  x = &quot;foo&quot;#
  y = &quot;foo&quot;#
  ...x...x...x...x....

Now 'y' will be discarded as dead code, and we are done.

The net effect is that for the y-binding we want to
  - Use SUBSTITUTE, by extending the substitution with  y :-&gt; x
  - but leave the original binding for y undisturbed

This is done by cse_bind.  I got it wrong the first time (#13367).

Note [Dealing with ticks]
~~~~~~~~~~~~~~~~~~~~~~~~~
Ticks complicate CSE a bit, as I discovered in the fallout from
fixing #19360.

* To get more CSE-ing, we strip all the tickishFloatable ticks from
  an expression
  - when inserting into the cs_map (see extendCSEnv)
  - when looking up in the cs_map (see call to lookupCSEnv in try_for_cse)
  Quite why only the tickishFloatable ticks, I'm not quite sure.

  AK: I think we only do this for floatable ticks since generally we don't mind them
  being less accurate as much. E.g. consider
    case e of
      C1 -&gt; f (&lt;tick1&gt; e1)
      C2 -&gt; f (&lt;tick2&gt; e1)
  If the ticks are (floatable) source notes nothing too bad happens if the debug info for
  both branches says the code comes from the same source location. Even if it will be inaccurate
  for one of the branches. We should probably still consider this worthwhile.
  However if the ticks are cost centres we really don't want the cost of both branches to be
  attributed to the same cost centre. Because a user might explicitly have inserted different
  cost centres in order to distinguish between evaluations resulting from the two different branches.
  e.g. something like this:
    case e of
      C1 -&gt; f ({ SCC &quot;evalAlt1&quot;} e1)
      C1 -&gt; f ({ SCC &quot;evalAlt2&quot;} e1)
  But it's still a bit suspicious.

* If we get a hit in cs_map, we wrap the result in the ticks from the
  thing we are looking up (see try_for_cse)

Net result: if we get a hit, we might replace
  let x = tick t1 (tick t2 e)
with
  let x = tick t1 (tick t2 y)
where 'y' is the variable that 'e' maps to.  Now consider extendCSEnvWithBinding for
the binding for 'x':

* We can't use SUBSTITUTE because those ticks might not be trivial (we
  use tickishIsCode in exprIsTrivial)

* We should not use EXTEND, because we definitely don't want to
  add  (tick t1 (tick t2 y)) :-&gt; x
  to the cs_map. Remember we strip off the ticks, so that would amount
  to adding y :-&gt; x, very silly.

TL;DR: we do neither; hence the cse_done case in extendCSEnvWithBinding.


Note [Delay inlining after CSE]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose (#15445) we have
   f,g :: Num a =&gt; a -&gt; a
   f x = ...f (x-1).....
   g y = ...g (y-1) ....

and we make some specialisations of 'g', either automatically, or via
a SPECIALISE pragma.  Then CSE kicks in and notices that the RHSs of
'f' and 'g' are identical, so we get
   f x = ...f (x-1)...
   g = f
   {-# RULES g @Int _ = $sg #-}

Now there is terrible danger that, in an importing module, we'll inline
'g' before we have a chance to run its specialisation!

Solution: during CSE, after a &quot;hit&quot; in the CSE cache
  * when adding a binding
        g = f
  * for a top-level function g
  * and g has specialisation RULES
add a NOINLINE[2] activation to it, to ensure it's not inlined
right away.

Notes:
* Why top level only?  Because for nested bindings we are already past
  phase 2 and will never return there.

* Why &quot;only if g has RULES&quot;?  Because there is no point in
  doing this if there are no RULES; and other things being
  equal it delays optimisation to delay inlining (#17409)


---- Historical note ---

This patch is simpler and more direct than an earlier
version:

  commit 2110738b280543698407924a16ac92b6d804dc36
  Author: Simon Peyton Jones &lt;simonpj@microsoft.com&gt;
  Date:   Mon Jul 30 13:43:56 2018 +0100

  Don't inline functions with RULES too early

We had to revert this patch because it made GHC itself slower.

Why? It delayed inlining of /all/ functions with RULES, and that was
very bad in GHC.Tc.Solver.Flatten.flatten_ty_con_app

* It delayed inlining of liftM
* That delayed the unravelling of the recursion in some dictionary
  bindings.
* That delayed some eta expansion, leaving
     flatten_ty_con_app = \x y. let &lt;stuff&gt; in \z. blah
* That allowed the float-out pass to put sguff between
  the \y and \z.
* And that permanently stopped eta expansion of the function,
  even once &lt;stuff&gt; was simplified.

-}</span><span>
</span><span id="line-666"></span><span>
</span><span id="line-667"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#tryForCSE"><span class="hs-identifier hs-type">tryForCSE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-668"></span><span id="tryForCSE"><span class="annot"><span class="annottext">tryForCSE :: CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#tryForCSE"><span class="hs-identifier hs-var hs-var">tryForCSE</span></a></span></span><span> </span><span id="local-6989586621681635175"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635175"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681635176"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635176"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, Expr Var) -&gt; Expr Var
forall a b. (a, b) -&gt; b
</span><a href="../../base-4.18.2.1/src/Data.Tuple.html#snd/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; (Bool, Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#try_for_cse"><span class="hs-identifier hs-var">try_for_cse</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635175"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635176"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#try_for_cse"><span class="hs-identifier hs-type">try_for_cse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-671"></span><span class="hs-comment">-- (False, e') =&gt; We did not CSE the entire expression,</span><span>
</span><span id="line-672"></span><span class="hs-comment">--                but we might have CSE'd some sub-expressions,</span><span>
</span><span id="line-673"></span><span class="hs-comment">--                yielding e'</span><span>
</span><span id="line-674"></span><span class="hs-comment">--</span><span>
</span><span id="line-675"></span><span class="hs-comment">-- (True, te') =&gt; We CSE'd the entire expression,</span><span>
</span><span id="line-676"></span><span class="hs-comment">--                yielding the trivial expression te'</span><span>
</span><span id="line-677"></span><span id="try_for_cse"><span class="annot"><span class="annottext">try_for_cse :: CSEnv -&gt; Expr Var -&gt; (Bool, Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#try_for_cse"><span class="hs-identifier hs-var hs-var">try_for_cse</span></a></span></span><span> </span><span id="local-6989586621681635177"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635177"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681635178"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635178"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-678"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681635179"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635179"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Maybe (Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#lookupCSEnv"><span class="hs-identifier hs-var">lookupCSEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635177"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635181"><span class="hs-identifier hs-var">expr''</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span>  </span><span class="annot"><span class="annottext">[CoreTickish] -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Utils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a></span><span> </span><span class="annot"><span class="annottext">[CoreTickish]
</span><a href="#local-6989586621681635182"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635179"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635183"><span class="hs-identifier hs-var">expr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-680"></span><span>    </span><span class="hs-comment">-- The varToCoreExpr is needed if we have</span><span>
</span><span id="line-681"></span><span>    </span><span class="hs-comment">--   case e of xco { ...case e of yco { ... } ... }</span><span>
</span><span id="line-682"></span><span>    </span><span class="hs-comment">-- Then CSE will substitute yco -&gt; xco;</span><span>
</span><span id="line-683"></span><span>    </span><span class="hs-comment">-- but these are /coercion/ variables</span><span>
</span><span id="line-684"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-685"></span><span>    </span><span id="local-6989586621681635183"><span class="annot"><span class="annottext">expr' :: Expr Var
</span><a href="#local-6989586621681635183"><span class="hs-identifier hs-var hs-var">expr'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635177"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635178"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-686"></span><span>    </span><span id="local-6989586621681635181"><span class="annot"><span class="annottext">expr'' :: Expr Var
</span><a href="#local-6989586621681635181"><span class="hs-identifier hs-var hs-var">expr''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; Expr Var -&gt; Expr Var
forall b. (CoreTickish -&gt; Bool) -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.Utils.html#stripTicksE"><span class="hs-identifier hs-var">stripTicksE</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635183"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-687"></span><span>    </span><span id="local-6989586621681635182"><span class="annot"><span class="annottext">ticks :: [CoreTickish]
</span><a href="#local-6989586621681635182"><span class="hs-identifier hs-var hs-var">ticks</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; Expr Var -&gt; [CoreTickish]
forall b. (CoreTickish -&gt; Bool) -&gt; Expr b -&gt; [CoreTickish]
</span><a href="GHC.Core.Utils.html#stripTicksT"><span class="hs-identifier hs-var">stripTicksT</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635183"><span class="hs-identifier hs-var">expr'</span></a></span><span>
</span><span id="line-688"></span><span>    </span><span class="hs-comment">-- We don't want to lose the source notes when a common sub</span><span>
</span><span id="line-689"></span><span>    </span><span class="hs-comment">-- expression gets eliminated. Hence we push all (!) of them on</span><span>
</span><span id="line-690"></span><span>    </span><span class="hs-comment">-- top of the replaced sub-expression. This is probably not too</span><span>
</span><span id="line-691"></span><span>    </span><span class="hs-comment">-- useful in practice, but upholds our semantics.</span><span>
</span><span id="line-692"></span><span>
</span><span id="line-693"></span><span class="hs-comment">-- | Runs CSE on a single expression.</span><span>
</span><span id="line-694"></span><span class="hs-comment">--</span><span>
</span><span id="line-695"></span><span class="hs-comment">-- This entry point is not used in the compiler itself, but is provided</span><span>
</span><span id="line-696"></span><span class="hs-comment">-- as a convenient entry point for users of the GHC API.</span><span>
</span><span id="line-697"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseOneExpr"><span class="hs-identifier hs-type">cseOneExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-698"></span><span id="cseOneExpr"><span class="annot"><span class="annottext">cseOneExpr :: Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#cseOneExpr"><span class="hs-identifier hs-var hs-var">cseOneExpr</span></a></span></span><span> </span><span id="local-6989586621681635184"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635184"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635185"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635184"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-699"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681635185"><span class="annot"><span class="annottext">env :: CSEnv
</span><a href="#local-6989586621681635185"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="GHC.Core.Opt.CSE.html#emptyCSEnv"><span class="hs-identifier hs-var">emptyCSEnv</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var">cs_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#mkEmptySubst"><span class="hs-identifier hs-type">mkEmptySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#mkInScopeSet"><span class="hs-identifier hs-type">mkInScopeSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.FVs.html#exprFreeVars"><span class="hs-identifier hs-type">exprFreeVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681635184"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-700"></span><span>
</span><span id="line-701"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-type">cseExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-702"></span><span id="cseExpr"><span class="annot"><span class="annottext">cseExpr :: CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var hs-var">cseExpr</span></a></span></span><span> </span><span id="local-6989586621681635188"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635188"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span id="local-6989586621681635190"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681635190"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Expr Var
forall b. Type -&gt; Expr b
</span><a href="GHC.Core.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Subst
</span><a href="GHC.Core.Opt.CSE.html#csEnvSubst"><span class="hs-identifier hs-var">csEnvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635188"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681635190"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-703"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span id="local-6989586621681635193"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635193"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span id="local-6989586621681635195"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681635195"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Expr Var
forall b. Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Subst
</span><a href="GHC.Core.Opt.CSE.html#csEnvSubst"><span class="hs-identifier hs-var">csEnvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635193"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681635195"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-704"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-type">Lit</span></a></span><span> </span><span id="local-6989586621681635198"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681635198"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Expr Var
forall b. Literal -&gt; Expr b
</span><a href="GHC.Core.html#Lit"><span class="hs-identifier hs-var">Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681635198"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-705"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span id="local-6989586621681635199"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635199"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681635200"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635200"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#lookupSubst"><span class="hs-identifier hs-var">lookupSubst</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635199"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635200"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-706"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span id="local-6989586621681635202"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635202"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#App"><span class="hs-identifier hs-type">App</span></a></span><span> </span><span id="local-6989586621681635204"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635204"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621681635205"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635205"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Var -&gt; Expr Var -&gt; Expr Var
forall b. Expr b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#App"><span class="hs-identifier hs-var">App</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635202"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635204"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#tryForCSE"><span class="hs-identifier hs-var">tryForCSE</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635202"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635205"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-707"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span id="local-6989586621681635206"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635206"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-type">Tick</span></a></span><span> </span><span id="local-6989586621681635208"><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681635208"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621681635209"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635209"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Expr Var -&gt; Expr Var
forall b. CoreTickish -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Tick"><span class="hs-identifier hs-var">Tick</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish
</span><a href="#local-6989586621681635208"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635206"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635209"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-708"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span id="local-6989586621681635210"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635210"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-type">Cast</span></a></span><span> </span><span id="local-6989586621681635212"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635212"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681635213"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681635213"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Var -&gt; Coercion -&gt; Expr Var
forall b. Expr b -&gt; Coercion -&gt; Expr b
</span><a href="GHC.Core.html#Cast"><span class="hs-identifier hs-var">Cast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#tryForCSE"><span class="hs-identifier hs-var">tryForCSE</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635210"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635212"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; Coercion -&gt; Coercion
Subst -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.TyCo.Subst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Subst
</span><a href="GHC.Core.Opt.CSE.html#csEnvSubst"><span class="hs-identifier hs-var">csEnvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635210"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621681635213"><span class="hs-identifier hs-var">co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-709"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span id="local-6989586621681635214"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635214"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621681635216"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635216"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681635217"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635217"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681635218"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635218"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635219"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635219"><span class="hs-identifier hs-var">b'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Var -&gt; (CSEnv, Var)
</span><a href="GHC.Core.Opt.CSE.html#addBinder"><span class="hs-identifier hs-var">addBinder</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635214"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635216"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-710"></span><span>                                    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Expr Var -&gt; Expr Var
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635219"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635218"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635217"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-711"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span id="local-6989586621681635220"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635220"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621681635222"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681635222"><span class="hs-identifier hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621681635223"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635223"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681635224"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635224"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635225"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681635225"><span class="hs-identifier hs-var">bind'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelFlag -&gt; CSEnv -&gt; CoreBind -&gt; (CSEnv, CoreBind)
</span><a href="GHC.Core.Opt.CSE.html#cseBind"><span class="hs-identifier hs-var">cseBind</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelFlag
</span><a href="GHC.Types.Basic.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635220"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681635222"><span class="hs-identifier hs-var">bind</span></a></span><span>
</span><span id="line-712"></span><span>                                    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">CoreBind -&gt; Expr Var -&gt; Expr Var
forall b. Bind b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621681635225"><span class="hs-identifier hs-var">bind'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635224"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635223"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-713"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a></span><span> </span><span id="local-6989586621681635227"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635227"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span id="local-6989586621681635229"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635229"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681635230"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635230"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681635231"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681635231"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681635232"><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635232"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Var -&gt; Type -&gt; [OutAlt] -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#cseCase"><span class="hs-identifier hs-var">cseCase</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635227"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635229"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635230"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681635231"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635232"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-714"></span><span>
</span><span id="line-715"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cseCase"><span class="hs-identifier hs-type">cseCase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#InType"><span class="hs-identifier hs-type">InType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-716"></span><span id="cseCase"><span class="annot"><span class="annottext">cseCase :: CSEnv -&gt; Expr Var -&gt; Var -&gt; Type -&gt; [OutAlt] -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#cseCase"><span class="hs-identifier hs-var hs-var">cseCase</span></a></span></span><span> </span><span id="local-6989586621681635236"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635236"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681635237"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635237"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621681635238"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635238"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681635239"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681635239"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681635240"><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635240"><span class="hs-identifier hs-var">alts</span></a></span></span><span>
</span><span id="line-717"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Var -&gt; Var -&gt; Type -&gt; [OutAlt] -&gt; Expr Var
forall b. Expr b -&gt; b -&gt; Type -&gt; [Alt b] -&gt; Expr b
</span><a href="GHC.Core.html#Case"><span class="hs-identifier hs-var">Case</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635241"><span class="hs-identifier hs-var">scrut1</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635242"><span class="hs-identifier hs-var">bndr3</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681635243"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="annot"><span class="annottext">([OutAlt] -&gt; Expr Var) -&gt; [OutAlt] -&gt; Expr Var
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-718"></span><span>    </span><span class="annot"><span class="annottext">[OutAlt] -&gt; [OutAlt]
</span><a href="GHC.Core.Opt.CSE.html#combineAlts"><span class="hs-identifier hs-var">combineAlts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(OutAlt -&gt; OutAlt) -&gt; [OutAlt] -&gt; [OutAlt]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">OutAlt -&gt; OutAlt
</span><a href="#local-6989586621681635245"><span class="hs-identifier hs-var">cse_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635240"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-720"></span><span>    </span><span id="local-6989586621681635243"><span class="annot"><span class="annottext">ty' :: Type
</span><a href="#local-6989586621681635243"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Type -&gt; Type
</span><a href="GHC.Core.TyCo.Subst.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Subst
</span><a href="GHC.Core.Opt.CSE.html#csEnvSubst"><span class="hs-identifier hs-var">csEnvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635236"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681635239"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-721"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681635246"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635246"><span class="hs-identifier hs-var">cse_done</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635241"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635241"><span class="hs-identifier hs-var">scrut1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; (Bool, Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#try_for_cse"><span class="hs-identifier hs-var">try_for_cse</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635236"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635237"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-722"></span><span>
</span><span id="line-723"></span><span>    </span><span id="local-6989586621681635247"><span class="annot"><span class="annottext">bndr1 :: Var
</span><a href="#local-6989586621681635247"><span class="hs-identifier hs-var hs-var">bndr1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Var -&gt; Var
</span><a href="GHC.Types.Id.html#zapIdOccInfo"><span class="hs-identifier hs-var">zapIdOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635238"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-724"></span><span>      </span><span class="hs-comment">-- Zapping the OccInfo is needed because the extendCSEnv</span><span>
</span><span id="line-725"></span><span>      </span><span class="hs-comment">-- in cse_alt may mean that a dead case binder</span><span>
</span><span id="line-726"></span><span>      </span><span class="hs-comment">-- becomes alive, and Lint rejects that</span><span>
</span><span id="line-727"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681635248"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635248"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635249"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635249"><span class="hs-identifier hs-var">bndr2</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Var -&gt; (CSEnv, Var)
</span><a href="GHC.Core.Opt.CSE.html#addBinder"><span class="hs-identifier hs-var">addBinder</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635236"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635247"><span class="hs-identifier hs-var">bndr1</span></a></span><span>
</span><span id="line-728"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681635250"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635250"><span class="hs-identifier hs-var">alt_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635242"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635242"><span class="hs-identifier hs-var">bndr3</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Var -&gt; Var -&gt; Expr Var -&gt; Bool -&gt; (CSEnv, Var)
</span><a href="GHC.Core.Opt.CSE.html#extendCSEnvWithBinding"><span class="hs-identifier hs-var">extendCSEnvWithBinding</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635248"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635238"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635249"><span class="hs-identifier hs-var">bndr2</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635241"><span class="hs-identifier hs-var">scrut1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681635246"><span class="hs-identifier hs-var">cse_done</span></a></span><span>
</span><span id="line-729"></span><span>         </span><span class="hs-comment">-- extendCSEnvWithBinding: see Note [CSE for case expressions]</span><span>
</span><span id="line-730"></span><span>
</span><span id="line-731"></span><span>    </span><span class="annot"><a href="#local-6989586621681635251"><span class="hs-identifier hs-type">con_target</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-732"></span><span>    </span><span id="local-6989586621681635251"><span class="annot"><span class="annottext">con_target :: Expr Var
</span><a href="#local-6989586621681635251"><span class="hs-identifier hs-var hs-var">con_target</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#lookupSubst"><span class="hs-identifier hs-var">lookupSubst</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635250"><span class="hs-identifier hs-var">alt_env</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635238"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-733"></span><span>
</span><span id="line-734"></span><span>    </span><span class="annot"><a href="#local-6989586621681635252"><span class="hs-identifier hs-type">arg_tys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutType"><span class="hs-identifier hs-type">OutType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-735"></span><span>    </span><span id="local-6989586621681635252"><span class="annot"><span class="annottext">arg_tys :: [Type]
</span><a href="#local-6989586621681635252"><span class="hs-identifier hs-var hs-var">arg_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Type -&gt; [Type]
Type -&gt; [Type]
</span><a href="GHC.Core.Type.html#tyConAppArgs"><span class="hs-identifier hs-var">tyConAppArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Type
</span><a href="GHC.Types.Id.html#idType"><span class="hs-identifier hs-var">idType</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635242"><span class="hs-identifier hs-var">bndr3</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-736"></span><span>
</span><span id="line-737"></span><span>    </span><span class="hs-comment">-- See Note [CSE for case alternatives]</span><span>
</span><span id="line-738"></span><span>    </span><span id="local-6989586621681635245"><span class="annot"><span class="annottext">cse_alt :: OutAlt -&gt; OutAlt
</span><a href="#local-6989586621681635245"><span class="hs-identifier hs-var hs-var">cse_alt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621681635256"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681635256"><span class="hs-identifier hs-var">con</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681635257"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635257"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681635258"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635258"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-739"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Var] -&gt; Expr Var -&gt; OutAlt
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; AltCon
</span><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681635256"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635259"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#tryForCSE"><span class="hs-identifier hs-var">tryForCSE</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635260"><span class="hs-identifier hs-var">new_env</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635258"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-740"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-741"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621681635261"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635261"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635259"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635259"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; [Var] -&gt; (CSEnv, [Var])
</span><a href="GHC.Core.Opt.CSE.html#addBinders"><span class="hs-identifier hs-var">addBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635250"><span class="hs-identifier hs-var">alt_env</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635257"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-742"></span><span>          </span><span id="local-6989586621681635260"><span class="annot"><span class="annottext">new_env :: CSEnv
</span><a href="#local-6989586621681635260"><span class="hs-identifier hs-var hs-var">new_env</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var -&gt; CSEnv
</span><a href="GHC.Core.Opt.CSE.html#extendCSEnv"><span class="hs-identifier hs-var">extendCSEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635261"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635262"><span class="hs-identifier hs-var">con_expr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635251"><span class="hs-identifier hs-var">con_target</span></a></span><span>
</span><span id="line-743"></span><span>          </span><span id="local-6989586621681635262"><span class="annot"><span class="annottext">con_expr :: Expr Var
</span><a href="#local-6989586621681635262"><span class="hs-identifier hs-var hs-var">con_expr</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Var] -&gt; [Type] -&gt; Expr Var
</span><a href="GHC.Core.Utils.html#mkAltExpr"><span class="hs-identifier hs-var">mkAltExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; AltCon
</span><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681635256"><span class="hs-identifier hs-var">con</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635259"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681635252"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-744"></span><span>
</span><span id="line-745"></span><span>    </span><span class="annot"><a href="#local-6989586621681635245"><span class="hs-identifier hs-var">cse_alt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span id="local-6989586621681635263"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681635263"><span class="hs-identifier hs-var">con</span></a></span></span><span> </span><span id="local-6989586621681635264"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635264"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681635265"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635265"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-746"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AltCon -&gt; [Var] -&gt; Expr Var -&gt; OutAlt
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681635263"><span class="hs-identifier hs-var">con</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635266"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Expr Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#tryForCSE"><span class="hs-identifier hs-var">tryForCSE</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635267"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635265"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-747"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-748"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621681635267"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635267"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635266"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635266"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; [Var] -&gt; (CSEnv, [Var])
</span><a href="GHC.Core.Opt.CSE.html#addBinders"><span class="hs-identifier hs-var">addBinders</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635250"><span class="hs-identifier hs-var">alt_env</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635264"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-749"></span><span>
</span><span id="line-750"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#combineAlts"><span class="hs-identifier hs-type">combineAlts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutAlt"><span class="hs-identifier hs-type">OutAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#OutAlt"><span class="hs-identifier hs-type">OutAlt</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-751"></span><span class="hs-comment">-- See Note [Combine case alternatives]</span><span>
</span><span id="line-752"></span><span id="combineAlts"><span class="annot"><span class="annottext">combineAlts :: [OutAlt] -&gt; [OutAlt]
</span><a href="GHC.Core.Opt.CSE.html#combineAlts"><span class="hs-identifier hs-var hs-var">combineAlts</span></a></span></span><span> </span><span id="local-6989586621681635268"><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635268"><span class="hs-identifier hs-var">alts</span></a></span></span><span>
</span><span id="line-753"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681635269"><span class="annot"><span class="annottext">OutAlt
</span><a href="#local-6989586621681635269"><span class="hs-identifier hs-var">alt1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635270"><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635270"><span class="hs-identifier hs-var">rest_alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[OutAlt] -&gt; (Maybe OutAlt, [OutAlt])
</span><a href="#local-6989586621681635271"><span class="hs-identifier hs-var">find_bndr_free_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635268"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-754"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681635272"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635272"><span class="hs-identifier hs-var">bndrs1</span></a></span></span><span> </span><span id="local-6989586621681635273"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635273"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutAlt
</span><a href="#local-6989586621681635269"><span class="hs-identifier hs-var">alt1</span></a></span><span>
</span><span id="line-755"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681635274"><span class="annot"><span class="annottext">filtered_alts :: [OutAlt]
</span><a href="#local-6989586621681635274"><span class="hs-identifier hs-var hs-var">filtered_alts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutAlt -&gt; Bool) -&gt; [OutAlt] -&gt; [OutAlt]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Var -&gt; OutAlt -&gt; Bool
</span><a href="#local-6989586621681635275"><span class="hs-identifier hs-var">identical_alt</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635273"><span class="hs-identifier hs-var">rhs1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635270"><span class="hs-identifier hs-var">rest_alts</span></a></span><span>
</span><span id="line-756"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutAlt] -&gt; [OutAlt] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a></span><span> </span><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635270"><span class="hs-identifier hs-var">rest_alts</span></a></span><span> </span><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635274"><span class="hs-identifier hs-var">filtered_alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-757"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; [OutAlt] -&gt; [OutAlt]
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Var] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635272"><span class="hs-identifier hs-var">bndrs1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutAlt] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635268"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([OutAlt] -&gt; [OutAlt]) -&gt; [OutAlt] -&gt; [OutAlt]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-758"></span><span>    </span><span class="annot"><span class="annottext">AltCon -&gt; [Var] -&gt; Expr Var -&gt; OutAlt
forall b. AltCon -&gt; [b] -&gt; Expr b -&gt; Alt b
</span><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-var">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><a href="GHC.Core.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635273"><span class="hs-identifier hs-var">rhs1</span></a></span><span> </span><span class="annot"><span class="annottext">OutAlt -&gt; [OutAlt] -&gt; [OutAlt]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635274"><span class="hs-identifier hs-var">filtered_alts</span></a></span><span>
</span><span id="line-759"></span><span>
</span><span id="line-760"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-761"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635268"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-762"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-763"></span><span>
</span><span id="line-764"></span><span>    </span><span class="annot"><a href="#local-6989586621681635271"><span class="hs-identifier hs-type">find_bndr_free_alt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-765"></span><span>       </span><span class="hs-comment">-- The (Just alt) is a binder-free alt</span><span>
</span><span id="line-766"></span><span>       </span><span class="hs-comment">-- See Note [Combine case alts: awkward corner]</span><span>
</span><span id="line-767"></span><span>    </span><span id="local-6989586621681635271"><span class="annot"><span class="annottext">find_bndr_free_alt :: [OutAlt] -&gt; (Maybe OutAlt, [OutAlt])
</span><a href="#local-6989586621681635271"><span class="hs-identifier hs-var hs-var">find_bndr_free_alt</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-768"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe OutAlt
forall a. Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-769"></span><span>    </span><span class="annot"><a href="#local-6989586621681635271"><span class="hs-identifier hs-var">find_bndr_free_alt</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681635281"><span class="annot"><span class="annottext">alt :: OutAlt
</span><a href="#local-6989586621681635281"><span class="hs-identifier hs-var">alt</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681635282"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635282"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621681635283"><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635283"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Var] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.2.1/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635282"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutAlt -&gt; Maybe OutAlt
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">OutAlt
</span><a href="#local-6989586621681635281"><span class="hs-identifier hs-var">alt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635283"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-771"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.2.1/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[OutAlt] -&gt; (Maybe OutAlt, [OutAlt])
</span><a href="#local-6989586621681635271"><span class="hs-identifier hs-var">find_bndr_free_alt</span></a></span><span> </span><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635283"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-772"></span><span>                       </span><span class="hs-special">(</span><span id="local-6989586621681635284"><span class="annot"><span class="annottext">Maybe OutAlt
</span><a href="#local-6989586621681635284"><span class="hs-identifier hs-var">mb_bf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635285"><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635285"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe OutAlt
</span><a href="#local-6989586621681635284"><span class="hs-identifier hs-var">mb_bf</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutAlt
</span><a href="#local-6989586621681635281"><span class="hs-identifier hs-var">alt</span></a></span><span class="annot"><span class="annottext">OutAlt -&gt; [OutAlt] -&gt; [OutAlt]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[OutAlt]
</span><a href="#local-6989586621681635285"><span class="hs-identifier hs-var">alts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-773"></span><span>
</span><span id="line-774"></span><span>    </span><span id="local-6989586621681635275"><span class="annot"><span class="annottext">identical_alt :: Expr Var -&gt; OutAlt -&gt; Bool
</span><a href="#local-6989586621681635275"><span class="hs-identifier hs-var hs-var">identical_alt</span></a></span></span><span> </span><span id="local-6989586621681635286"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635286"><span class="hs-identifier hs-var">rhs1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Alt"><span class="hs-identifier hs-type">Alt</span></a></span><span> </span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Var]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681635287"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635287"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Var -&gt; Expr Var -&gt; Bool
</span><a href="GHC.Core.Map.Expr.html#eqCoreExpr"><span class="hs-identifier hs-var">eqCoreExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635286"><span class="hs-identifier hs-var">rhs1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635287"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-775"></span><span>       </span><span class="hs-comment">-- Even if this alt has binders, they will have been cloned</span><span>
</span><span id="line-776"></span><span>       </span><span class="hs-comment">-- If any of these binders are mentioned in 'rhs', then</span><span>
</span><span id="line-777"></span><span>       </span><span class="hs-comment">-- 'rhs' won't compare equal to 'rhs1' (which is from an</span><span>
</span><span id="line-778"></span><span>       </span><span class="hs-comment">-- alt with no binders).</span><span>
</span><span id="line-779"></span><span>
</span><span id="line-780"></span><span class="hs-comment">{- Note [CSE for case alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider   case e of x
            K1 y -&gt; ....(K1 y)...
            K2   -&gt; ....K2....

We definitely want to CSE that (K1 y) into just x.

But what about the lone K2?  At first you would think &quot;no&quot; because
turning K2 into 'x' increases the number of live variables.  But

* Turning K2 into x increases the chance of combining identical alts.
  Example      case xs of
                  (_:_) -&gt; f xs
                  []    -&gt; f []
  See #17901 and simplCore/should_compile/T17901 for more examples
  of this kind.

* The next run of the simplifier will turn 'x' back into K2, so we won't
  permanently bloat the free-var count.


Note [Combine case alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
combineAlts is just a more heavyweight version of the use of
combineIdenticalAlts in GHC.Core.Opt.Simplify.Utils.prepareAlts.  The basic idea is
to transform

    DEFAULT -&gt; e1
    K x     -&gt; e1
    W y z   -&gt; e2
===&gt;
   DEFAULT -&gt; e1
   W y z   -&gt; e2

In the simplifier we use cheapEqExpr, because it is called a lot.
But here in CSE we use the full eqCoreExpr.  After all, two alternatives usually
differ near the root, so it probably isn't expensive to compare the full
alternative.  It seems like the same kind of thing that CSE is supposed
to be doing, which is why I put it here.

I actually saw some examples in the wild, where some inlining made e1 too
big for cheapEqExpr to catch it.

Note [Combine case alts: awkward corner]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We would really like to check isDeadBinder on the binders in the
alternative.  But alas, the simplifer zaps occ-info on binders in case
alternatives; see Note [Case alternative occ info] in GHC.Core.Opt.Simplify.

* One alternative (perhaps a good one) would be to do OccAnal
  just before CSE.  Then perhaps we could get rid of combineIdenticalAlts
  in the Simplifier, which might save work.

* Another would be for CSE to return free vars as it goes.

* But the current solution is to find a nullary alternative (including
  the DEFAULT alt, if any). This will not catch
      case x of
        A y   -&gt; blah
        B z p -&gt; blah
  where no alternative is nullary or DEFAULT.  But the current
  solution is at least cheap.


************************************************************************
*                                                                      *
\section{The CSE envt}
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-851"></span><span>
</span><span id="line-852"></span><span class="hs-keyword">data</span><span> </span><span id="CSEnv"><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-var">CSEnv</span></a></span></span><span>
</span><span id="line-853"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="CS"><span class="annot"><a href="GHC.Core.Opt.CSE.html#CS"><span class="hs-identifier hs-var">CS</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="cs_subst"><span class="annot"><span class="annottext">CSEnv -&gt; Subst
</span><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var hs-var">cs_subst</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>  </span><span class="hs-comment">-- Maps InBndrs to OutExprs</span><span>
</span><span id="line-854"></span><span>            </span><span class="hs-comment">-- The substitution variables to</span><span>
</span><span id="line-855"></span><span>            </span><span class="hs-comment">-- /trivial/ OutExprs, not arbitrary expressions</span><span>
</span><span id="line-856"></span><span>
</span><span id="line-857"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="cs_map"><span class="annot"><span class="annottext">CSEnv -&gt; CoreMap (Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#cs_map"><span class="hs-identifier hs-var hs-var">cs_map</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Map.Expr.html#CoreMap"><span class="hs-identifier hs-type">CoreMap</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-858"></span><span>            </span><span class="hs-comment">-- The &quot;reverse&quot; mapping.</span><span>
</span><span id="line-859"></span><span>            </span><span class="hs-comment">-- Maps a OutExpr to a /trivial/ OutExpr</span><span>
</span><span id="line-860"></span><span>            </span><span class="hs-comment">-- The key of cs_map is stripped of all Ticks</span><span>
</span><span id="line-861"></span><span>            </span><span class="hs-comment">-- It maps arbitrary expressions to trivial expressions</span><span>
</span><span id="line-862"></span><span>            </span><span class="hs-comment">-- representing the same value. E.g @C a b@ to @x1@.</span><span>
</span><span id="line-863"></span><span>
</span><span id="line-864"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="cs_rec_map"><span class="annot"><span class="annottext">CSEnv -&gt; CoreMap (Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#cs_rec_map"><span class="hs-identifier hs-var hs-var">cs_rec_map</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Map.Expr.html#CoreMap"><span class="hs-identifier hs-type">CoreMap</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-865"></span><span>            </span><span class="hs-comment">-- See Note [CSE for recursive bindings]</span><span>
</span><span id="line-866"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-867"></span><span>
</span><span id="line-868"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#emptyCSEnv"><span class="hs-identifier hs-type">emptyCSEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span>
</span><span id="line-869"></span><span id="emptyCSEnv"><span class="annot"><span class="annottext">emptyCSEnv :: CSEnv
</span><a href="GHC.Core.Opt.CSE.html#emptyCSEnv"><span class="hs-identifier hs-var hs-var">emptyCSEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CS"><span class="hs-identifier hs-type">CS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cs_map :: CoreMap (Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#cs_map"><span class="hs-identifier hs-var">cs_map</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreMap (Expr Var)
forall a. CoreMap a
</span><a href="GHC.Core.Map.Expr.html#emptyCoreMap"><span class="hs-identifier hs-var">emptyCoreMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cs_rec_map :: CoreMap (Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#cs_rec_map"><span class="hs-identifier hs-var">cs_rec_map</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreMap (Expr Var)
forall a. CoreMap a
</span><a href="GHC.Core.Map.Expr.html#emptyCoreMap"><span class="hs-identifier hs-var">emptyCoreMap</span></a></span><span>
</span><span id="line-870"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cs_subst :: Subst
</span><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var">cs_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="GHC.Core.TyCo.Subst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-871"></span><span>
</span><span id="line-872"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#lookupCSEnv"><span class="hs-identifier hs-type">lookupCSEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-873"></span><span id="lookupCSEnv"><span class="annot"><span class="annottext">lookupCSEnv :: CSEnv -&gt; Expr Var -&gt; Maybe (Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#lookupCSEnv"><span class="hs-identifier hs-var hs-var">lookupCSEnv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CS"><span class="hs-identifier hs-type">CS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cs_map :: CSEnv -&gt; CoreMap (Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#cs_map"><span class="hs-identifier hs-var">cs_map</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681635294"><span class="annot"><span class="annottext">CoreMap (Expr Var)
</span><a href="#local-6989586621681635294"><span class="hs-identifier hs-var">csmap</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681635295"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635295"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-874"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreMap (Expr Var) -&gt; Expr Var -&gt; Maybe (Expr Var)
forall a. CoreMap a -&gt; Expr Var -&gt; Maybe a
</span><a href="GHC.Core.Map.Expr.html#lookupCoreMap"><span class="hs-identifier hs-var">lookupCoreMap</span></a></span><span> </span><span class="annot"><span class="annottext">CoreMap (Expr Var)
</span><a href="#local-6989586621681635294"><span class="hs-identifier hs-var">csmap</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635295"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-875"></span><span>
</span><span id="line-876"></span><span class="annot"><span class="hs-comment">-- | @extendCSEnv env e triv_expr@ will replace any occurrence of @e@ with @triv_expr@ going forward.</span></span><span>
</span><span id="line-877"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#extendCSEnv"><span class="hs-identifier hs-type">extendCSEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span>
</span><span id="line-878"></span><span id="extendCSEnv"><span class="annot"><span class="annottext">extendCSEnv :: CSEnv -&gt; Expr Var -&gt; Expr Var -&gt; CSEnv
</span><a href="GHC.Core.Opt.CSE.html#extendCSEnv"><span class="hs-identifier hs-var hs-var">extendCSEnv</span></a></span></span><span> </span><span id="local-6989586621681635297"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635297"><span class="hs-identifier hs-var">cse</span></a></span></span><span> </span><span id="local-6989586621681635298"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635298"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621681635299"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635299"><span class="hs-identifier hs-var">triv_expr</span></a></span></span><span>
</span><span id="line-879"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635297"><span class="hs-identifier hs-var">cse</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cs_map"><span class="hs-identifier hs-var">cs_map</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Map.Expr.html#extendCoreMap"><span class="hs-identifier hs-type">extendCoreMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cs_map"><span class="hs-identifier hs-var">cs_map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681635297"><span class="hs-identifier hs-type">cse</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681635301"><span class="hs-identifier hs-type">sexpr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681635299"><span class="hs-identifier hs-type">triv_expr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-880"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-881"></span><span>    </span><span id="local-6989586621681635301"><span class="annot"><span class="annottext">sexpr :: Expr Var
</span><a href="#local-6989586621681635301"><span class="hs-identifier hs-var hs-var">sexpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CoreTickish -&gt; Bool) -&gt; Expr Var -&gt; Expr Var
forall b. (CoreTickish -&gt; Bool) -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.Utils.html#stripTicksE"><span class="hs-identifier hs-var">stripTicksE</span></a></span><span> </span><span class="annot"><span class="annottext">CoreTickish -&gt; Bool
forall (pass :: TickishPass). GenTickish pass -&gt; Bool
</span><a href="GHC.Types.Tickish.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635298"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-882"></span><span>
</span><span id="line-883"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#extendCSRecEnv"><span class="hs-identifier hs-type">extendCSRecEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span>
</span><span id="line-884"></span><span class="hs-comment">-- See Note [CSE for recursive bindings]</span><span>
</span><span id="line-885"></span><span id="extendCSRecEnv"><span class="annot"><span class="annottext">extendCSRecEnv :: CSEnv -&gt; Var -&gt; Expr Var -&gt; Expr Var -&gt; CSEnv
</span><a href="GHC.Core.Opt.CSE.html#extendCSRecEnv"><span class="hs-identifier hs-var hs-var">extendCSRecEnv</span></a></span></span><span> </span><span id="local-6989586621681635302"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635302"><span class="hs-identifier hs-var">cse</span></a></span></span><span> </span><span id="local-6989586621681635303"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635303"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681635304"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635304"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span id="local-6989586621681635305"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635305"><span class="hs-identifier hs-var">triv_expr</span></a></span></span><span>
</span><span id="line-886"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635302"><span class="hs-identifier hs-var">cse</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cs_rec_map"><span class="hs-identifier hs-var">cs_rec_map</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Map.Expr.html#extendCoreMap"><span class="hs-identifier hs-type">extendCoreMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cs_rec_map"><span class="hs-identifier hs-var">cs_rec_map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681635302"><span class="hs-identifier hs-type">cse</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681635303"><span class="hs-identifier hs-type">bndr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681635304"><span class="hs-identifier hs-type">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681635305"><span class="hs-identifier hs-type">triv_expr</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-887"></span><span>
</span><span id="line-888"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#lookupCSRecEnv"><span class="hs-identifier hs-type">lookupCSRecEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-889"></span><span class="hs-comment">-- See Note [CSE for recursive bindings]</span><span>
</span><span id="line-890"></span><span id="lookupCSRecEnv"><span class="annot"><span class="annottext">lookupCSRecEnv :: CSEnv -&gt; Var -&gt; Expr Var -&gt; Maybe (Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#lookupCSRecEnv"><span class="hs-identifier hs-var hs-var">lookupCSRecEnv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CS"><span class="hs-identifier hs-type">CS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cs_rec_map :: CSEnv -&gt; CoreMap (Expr Var)
</span><a href="GHC.Core.Opt.CSE.html#cs_rec_map"><span class="hs-identifier hs-var">cs_rec_map</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681635306"><span class="annot"><span class="annottext">CoreMap (Expr Var)
</span><a href="#local-6989586621681635306"><span class="hs-identifier hs-var">csmap</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681635307"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635307"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681635308"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635308"><span class="hs-identifier hs-var">expr</span></a></span></span><span>
</span><span id="line-891"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreMap (Expr Var) -&gt; Expr Var -&gt; Maybe (Expr Var)
forall a. CoreMap a -&gt; Expr Var -&gt; Maybe a
</span><a href="GHC.Core.Map.Expr.html#lookupCoreMap"><span class="hs-identifier hs-var">lookupCoreMap</span></a></span><span> </span><span class="annot"><span class="annottext">CoreMap (Expr Var)
</span><a href="#local-6989586621681635306"><span class="hs-identifier hs-var">csmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Var -&gt; Expr Var -&gt; Expr Var
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635307"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635308"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-892"></span><span>
</span><span id="line-893"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#csEnvSubst"><span class="hs-identifier hs-type">csEnvSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-894"></span><span id="csEnvSubst"><span class="annot"><span class="annottext">csEnvSubst :: CSEnv -&gt; Subst
</span><a href="GHC.Core.Opt.CSE.html#csEnvSubst"><span class="hs-identifier hs-var hs-var">csEnvSubst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv -&gt; Subst
</span><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var">cs_subst</span></a></span><span>
</span><span id="line-895"></span><span>
</span><span id="line-896"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#lookupSubst"><span class="hs-identifier hs-type">lookupSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-897"></span><span id="lookupSubst"><span class="annot"><span class="annottext">lookupSubst :: CSEnv -&gt; Var -&gt; Expr Var
</span><a href="GHC.Core.Opt.CSE.html#lookupSubst"><span class="hs-identifier hs-var hs-var">lookupSubst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CS"><span class="hs-identifier hs-type">CS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cs_subst :: CSEnv -&gt; Subst
</span><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var">cs_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681635309"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681635309"><span class="hs-identifier hs-var">sub</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681635310"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635310"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; Var -&gt; Expr Var
Subst -&gt; Var -&gt; Expr Var
</span><a href="GHC.Core.Subst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681635309"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635310"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-898"></span><span>
</span><span id="line-899"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#extendCSSubst"><span class="hs-identifier hs-type">extendCSSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span>
</span><span id="line-900"></span><span id="extendCSSubst"><span class="annot"><span class="annottext">extendCSSubst :: CSEnv -&gt; Var -&gt; Expr Var -&gt; CSEnv
</span><a href="GHC.Core.Opt.CSE.html#extendCSSubst"><span class="hs-identifier hs-var hs-var">extendCSSubst</span></a></span></span><span> </span><span id="local-6989586621681635313"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635313"><span class="hs-identifier hs-var">cse</span></a></span></span><span> </span><span id="local-6989586621681635314"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635314"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621681635315"><span class="annot"><span class="annottext">Expr Var
</span><a href="#local-6989586621681635315"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635313"><span class="hs-identifier hs-var">cse</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var">cs_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Core.Subst.html#extendSubst"><span class="hs-identifier hs-type">extendSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var">cs_subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681635313"><span class="hs-identifier hs-type">cse</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681635314"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681635315"><span class="hs-identifier hs-type">rhs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-901"></span><span>
</span><span id="line-902"></span><span class="hs-comment">-- | Add clones to the substitution to deal with shadowing.  See</span><span>
</span><span id="line-903"></span><span class="hs-comment">-- Note [Shadowing] for more details.  You should call this whenever</span><span>
</span><span id="line-904"></span><span class="hs-comment">-- you go under a binder.</span><span>
</span><span id="line-905"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#addBinder"><span class="hs-identifier hs-type">addBinder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-906"></span><span id="addBinder"><span class="annot"><span class="annottext">addBinder :: CSEnv -&gt; Var -&gt; (CSEnv, Var)
</span><a href="GHC.Core.Opt.CSE.html#addBinder"><span class="hs-identifier hs-var hs-var">addBinder</span></a></span></span><span> </span><span id="local-6989586621681635317"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635317"><span class="hs-identifier hs-var">cse</span></a></span></span><span> </span><span id="local-6989586621681635318"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635318"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635317"><span class="hs-identifier hs-var">cse</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var">cs_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681635319"><span class="hs-identifier hs-type">sub'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635320"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-907"></span><span>                </span><span class="hs-keyword">where</span><span>
</span><span id="line-908"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621681635319"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681635319"><span class="hs-identifier hs-var">sub'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635320"><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635320"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Var -&gt; (Subst, Var)
</span><a href="GHC.Core.Subst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Subst
</span><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var">cs_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635317"><span class="hs-identifier hs-var">cse</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Var
</span><a href="#local-6989586621681635318"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-909"></span><span>
</span><span id="line-910"></span><span class="annot"><a href="GHC.Core.Opt.CSE.html#addBinders"><span class="hs-identifier hs-type">addBinders</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-911"></span><span id="addBinders"><span class="annot"><span class="annottext">addBinders :: CSEnv -&gt; [Var] -&gt; (CSEnv, [Var])
</span><a href="GHC.Core.Opt.CSE.html#addBinders"><span class="hs-identifier hs-var hs-var">addBinders</span></a></span></span><span> </span><span id="local-6989586621681635322"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635322"><span class="hs-identifier hs-var">cse</span></a></span></span><span> </span><span id="local-6989586621681635323"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635323"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635322"><span class="hs-identifier hs-var">cse</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var">cs_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681635324"><span class="hs-identifier hs-type">sub'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635325"><span class="hs-identifier hs-var">vs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-912"></span><span>                </span><span class="hs-keyword">where</span><span>
</span><span id="line-913"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621681635324"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681635324"><span class="hs-identifier hs-var">sub'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635325"><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635325"><span class="hs-identifier hs-var">vs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; [Var] -&gt; (Subst, [Var])
forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f Var -&gt; (Subst, f Var)
</span><a href="GHC.Core.Subst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Subst
</span><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var">cs_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635322"><span class="hs-identifier hs-var">cse</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Var]
</span><a href="#local-6989586621681635323"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-914"></span><span>
</span><span id="line-915"></span><span id="local-6989586621681634969"><span class="annot"><a href="GHC.Core.Opt.CSE.html#addRecBinders"><span class="hs-identifier hs-type">addRecBinders</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.2.1/src/Data.Traversable.html#Traversable/Data.Traversable.html#Traversable"><span class="hs-identifier hs-type">Traversable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681634969"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681634969"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Opt.CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681634969"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-916"></span><span id="addRecBinders"><span class="annot"><span class="annottext">addRecBinders :: forall (f :: * -&gt; *).
Traversable f =&gt;
CSEnv -&gt; f Var -&gt; (CSEnv, f Var)
</span><a href="GHC.Core.Opt.CSE.html#addRecBinders"><span class="hs-identifier hs-var hs-var">addRecBinders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621681635329"><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635329"><span class="hs-identifier hs-var">cse</span></a></span></span><span> </span><span id="local-6989586621681635330"><span class="annot"><span class="annottext">f Var
</span><a href="#local-6989586621681635330"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-917"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681635331"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621681635331"><span class="hs-identifier hs-var">sub'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681635332"><span class="annot"><span class="annottext">f Var
</span><a href="#local-6989586621681635332"><span class="hs-identifier hs-var">vs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; f Var -&gt; (Subst, f Var)
forall (f :: * -&gt; *).
Traversable f =&gt;
Subst -&gt; f Var -&gt; (Subst, f Var)
</span><a href="GHC.Core.Subst.html#substRecBndrs"><span class="hs-identifier hs-var">substRecBndrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv -&gt; Subst
</span><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var">cs_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635329"><span class="hs-identifier hs-var">cse</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f Var
</span><a href="#local-6989586621681635330"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-918"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSEnv
</span><a href="#local-6989586621681635329"><span class="hs-identifier hs-var">cse</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#cs_subst"><span class="hs-identifier hs-var">cs_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681635331"><span class="hs-identifier hs-type">sub'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">f Var
</span><a href="#local-6989586621681635332"><span class="hs-identifier hs-var">vs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-919"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Core.Opt.CSE.html#addRecBinders"><span class="hs-pragma hs-type">addRecBinders</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-920"></span></pre></body></html>