<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="annot"><span class="hs-comment">-- | Temporary file-system management</span></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Utils.TmpFs</span><span>
</span><span id="line-5"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier">TmpFs</span></a></span><span>
</span><span id="line-6"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#initTmpFs"><span class="hs-identifier">initTmpFs</span></a></span><span>
</span><span id="line-7"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#forkTmpFsFrom"><span class="hs-identifier">forkTmpFsFrom</span></a></span><span>
</span><span id="line-8"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#mergeTmpFsInto"><span class="hs-identifier">mergeTmpFsInto</span></a></span><span>
</span><span id="line-9"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier">PathsToClean</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#emptyPathsToClean"><span class="hs-identifier">emptyPathsToClean</span></a></span><span>
</span><span id="line-11"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempFileLifetime"><span class="hs-identifier">TempFileLifetime</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempDir"><span class="hs-identifier">TempDir</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#cleanTempDirs"><span class="hs-identifier">cleanTempDirs</span></a></span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#cleanTempFiles"><span class="hs-identifier">cleanTempFiles</span></a></span><span>
</span><span id="line-15"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#cleanCurrentModuleTempFiles"><span class="hs-identifier">cleanCurrentModuleTempFiles</span></a></span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#keepCurrentModuleTempFiles"><span class="hs-identifier">keepCurrentModuleTempFiles</span></a></span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#addFilesToClean"><span class="hs-identifier">addFilesToClean</span></a></span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#changeTempFilesLifetime"><span class="hs-identifier">changeTempFilesLifetime</span></a></span><span>
</span><span id="line-19"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#newTempName"><span class="hs-identifier">newTempName</span></a></span><span>
</span><span id="line-20"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#newTempLibName"><span class="hs-identifier">newTempLibName</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#newTempSubDir"><span class="hs-identifier">newTempSubDir</span></a></span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#withSystemTempDirectory"><span class="hs-identifier">withSystemTempDirectory</span></a></span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#withTempDirectory"><span class="hs-identifier">withTempDirectory</span></a></span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">where</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Error.html"><span class="hs-identifier">GHC.Utils.Error</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html"><span class="hs-identifier">GHC.Utils.Logger</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Exception.html"><span class="hs-identifier">GHC.Utils.Exception</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Exception</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Phases.html"><span class="hs-identifier">GHC.Driver.Phases</span></a></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.List.html#/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/Data.OldList.html#partition/Data.OldList.html#partition"><span class="hs-identifier">partition</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../containers-0.6.7/src/Data.Set.html#/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../containers-0.6.7/src/Data.Set.html#/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.6.7/src/Data.Set.Internal.html#Set/Data.Set.Internal.html#Set"><span class="hs-identifier">Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../containers-0.6.7/src/Data.Map.html#/Data.Map.html"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../containers-0.6.7/src/Data.Map.html#/Data.Map.html"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.6.7/src/Data.Map.Internal.html#Map/Data.Map.Internal.html#Map"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.IORef.html#/Data.IORef.html"><span class="hs-identifier">Data.IORef</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../directory-1.3.8.5/src/System.Directory.html#/System.Directory.html"><span class="hs-identifier">System.Directory</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../template-haskell-2.20.0.0/src/System.FilePath.html#/System.FilePath.html"><span class="hs-identifier">System.FilePath</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/System.IO.Error.html#/System.IO.Error.html"><span class="hs-identifier">System.IO.Error</span></a></span><span class="hs-cpp">

#if !defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/System.Posix.Internals.html#/System.Posix.Internals.html"><span class="hs-identifier">System.Posix.Internals</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-50"></span><span class="annot"><span class="hs-comment">-- | Temporary file-system</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">data</span><span> </span><span id="TmpFs"><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-var">TmpFs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TmpFs"><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-var">TmpFs</span></a></span></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="tmp_dirs_to_clean"><span class="annot"><span class="annottext">TmpFs -&gt; IORef (Map FilePath FilePath)
</span><a href="GHC.Utils.TmpFs.html#tmp_dirs_to_clean"><span class="hs-identifier hs-var hs-var">tmp_dirs_to_clean</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IORef.html#IORef/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.6.7/src/Data.Map.Internal.html#Map/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>      </span><span class="hs-comment">-- ^ Maps system temporary directory (passed via settings or DynFlags) to</span><span>
</span><span id="line-54"></span><span>      </span><span class="hs-comment">-- an actual temporary directory for this process.</span><span>
</span><span id="line-55"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-56"></span><span>      </span><span class="hs-comment">-- It's a Map probably to support changing the system temporary directory</span><span>
</span><span id="line-57"></span><span>      </span><span class="hs-comment">-- over time.</span><span>
</span><span id="line-58"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-59"></span><span>      </span><span class="hs-comment">-- Shared with forked TmpFs.</span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tmp_next_suffix"><span class="annot"><span class="annottext">TmpFs -&gt; IORef Int
</span><a href="GHC.Utils.TmpFs.html#tmp_next_suffix"><span class="hs-identifier hs-var hs-var">tmp_next_suffix</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IORef.html#IORef/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-62"></span><span>      </span><span class="hs-comment">-- ^ The next available suffix to uniquely name a temp file, updated</span><span>
</span><span id="line-63"></span><span>      </span><span class="hs-comment">-- atomically.</span><span>
</span><span id="line-64"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-65"></span><span>      </span><span class="hs-comment">-- Shared with forked TmpFs.</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tmp_files_to_clean"><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_files_to_clean"><span class="hs-identifier hs-var hs-var">tmp_files_to_clean</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IORef.html#IORef/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span>
</span><span id="line-68"></span><span>      </span><span class="hs-comment">-- ^ Files to clean (per session or per module)</span><span>
</span><span id="line-69"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-70"></span><span>      </span><span class="hs-comment">-- Not shared with forked TmpFs.</span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tmp_subdirs_to_clean"><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_subdirs_to_clean"><span class="hs-identifier hs-var hs-var">tmp_subdirs_to_clean</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IORef.html#IORef/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span>
</span><span id="line-72"></span><span>      </span><span class="hs-comment">-- ^ Subdirs to clean (per session or per module)</span><span>
</span><span id="line-73"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-74"></span><span>      </span><span class="hs-comment">-- Not shared with forked TmpFs.</span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="annot"><span class="hs-comment">-- | A collection of paths that must be deleted before ghc exits.</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">data</span><span> </span><span id="PathsToClean"><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-var">PathsToClean</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PathsToClean"><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-var">PathsToClean</span></a></span></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="ptcGhcSession"><span class="annot"><span class="annottext">PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcGhcSession"><span class="hs-identifier hs-var hs-var">ptcGhcSession</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.6.7/src/Data.Set.Internal.html#Set/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>        </span><span class="annot"><span class="hs-comment">-- ^ Paths that will be deleted at the end of runGhc(T)</span></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="ptcCurrentModule"><span class="annot"><span class="annottext">PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var hs-var">ptcCurrentModule</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../containers-0.6.7/src/Data.Set.Internal.html#Set/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>        </span><span class="hs-comment">-- ^ Paths that will be deleted the next time</span><span>
</span><span id="line-84"></span><span>        </span><span class="hs-comment">-- 'cleanCurrentModuleTempFiles' is called, or otherwise at the end of</span><span>
</span><span id="line-85"></span><span>        </span><span class="hs-comment">-- the session.</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-comment">-- | Used when a temp file is created. This determines which component Set of</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- PathsToClean will get the temp file</span><span>
</span><span id="line-90"></span><span class="hs-keyword">data</span><span> </span><span id="TempFileLifetime"><span class="annot"><a href="GHC.Utils.TmpFs.html#TempFileLifetime"><span class="hs-identifier hs-var">TempFileLifetime</span></a></span></span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TFL_CurrentModule"><span class="annot"><a href="GHC.Utils.TmpFs.html#TFL_CurrentModule"><span class="hs-identifier hs-var">TFL_CurrentModule</span></a></span></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-comment">-- ^ A file with lifetime TFL_CurrentModule will be cleaned up at the</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-comment">-- end of upweep_mod</span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TFL_GhcSession"><span class="annot"><a href="GHC.Utils.TmpFs.html#TFL_GhcSession"><span class="hs-identifier hs-var">TFL_GhcSession</span></a></span></span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-comment">-- ^ A file with lifetime TFL_GhcSession will be cleaned up at the end of</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-comment">-- runGhc(T)</span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681622180"><span id="local-6989586621681622182"><span id="local-6989586621681622186"><span class="annot"><span class="annottext">Int -&gt; TempFileLifetime -&gt; ShowS
[TempFileLifetime] -&gt; ShowS
TempFileLifetime -&gt; FilePath
(Int -&gt; TempFileLifetime -&gt; ShowS)
-&gt; (TempFileLifetime -&gt; FilePath)
-&gt; ([TempFileLifetime] -&gt; ShowS)
-&gt; Show TempFileLifetime
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; FilePath) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; TempFileLifetime -&gt; ShowS
showsPrec :: Int -&gt; TempFileLifetime -&gt; ShowS
$cshow :: TempFileLifetime -&gt; FilePath
show :: TempFileLifetime -&gt; FilePath
$cshowList :: [TempFileLifetime] -&gt; ShowS
showList :: [TempFileLifetime] -&gt; ShowS
</span><a href="../../base-4.18.3.0/src/GHC.Show.html#Show/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-keyword">newtype</span><span> </span><span id="TempDir"><span class="annot"><a href="GHC.Utils.TmpFs.html#TempDir"><span class="hs-identifier hs-var">TempDir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TempDir"><span class="annot"><a href="GHC.Utils.TmpFs.html#TempDir"><span class="hs-identifier hs-var">TempDir</span></a></span></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="annot"><span class="hs-comment">-- | An empty PathsToClean</span></span><span>
</span><span id="line-102"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#emptyPathsToClean"><span class="hs-identifier hs-type">emptyPathsToClean</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span>
</span><span id="line-103"></span><span id="emptyPathsToClean"><span class="annot"><span class="annottext">emptyPathsToClean :: PathsToClean
</span><a href="GHC.Utils.TmpFs.html#emptyPathsToClean"><span class="hs-identifier hs-var hs-var">emptyPathsToClean</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; Set FilePath -&gt; PathsToClean
</span><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-var">PathsToClean</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
forall a. Set a
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#empty/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set.empty</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
forall a. Set a
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#empty/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set.empty</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="annot"><span class="hs-comment">-- | Merge two PathsToClean</span></span><span>
</span><span id="line-106"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#mergePathsToClean"><span class="hs-identifier hs-type">mergePathsToClean</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span>
</span><span id="line-107"></span><span id="mergePathsToClean"><span class="annot"><span class="annottext">mergePathsToClean :: PathsToClean -&gt; PathsToClean -&gt; PathsToClean
</span><a href="GHC.Utils.TmpFs.html#mergePathsToClean"><span class="hs-identifier hs-var hs-var">mergePathsToClean</span></a></span></span><span> </span><span id="local-6989586621681622192"><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622192"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621681622193"><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622193"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ptcGhcSession :: Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcGhcSession"><span class="hs-identifier hs-var">ptcGhcSession</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; Set FilePath -&gt; Set FilePath
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#union/Data.Set.Internal.html#union"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcGhcSession"><span class="hs-identifier hs-var">ptcGhcSession</span></a></span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622192"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcGhcSession"><span class="hs-identifier hs-var">ptcGhcSession</span></a></span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622193"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ptcCurrentModule :: Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var">ptcCurrentModule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; Set FilePath -&gt; Set FilePath
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#union/Data.Set.Internal.html#union"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var">ptcCurrentModule</span></a></span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622192"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var">ptcCurrentModule</span></a></span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622193"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="annot"><span class="hs-comment">-- | Initialise an empty TmpFs</span></span><span>
</span><span id="line-113"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#initTmpFs"><span class="hs-identifier hs-type">initTmpFs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span>
</span><span id="line-114"></span><span id="initTmpFs"><span class="annot"><span class="annottext">initTmpFs :: IO TmpFs
</span><a href="GHC.Utils.TmpFs.html#initTmpFs"><span class="hs-identifier hs-var hs-var">initTmpFs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-115"></span><span>    </span><span id="local-6989586621681622195"><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622195"><span class="hs-identifier hs-var">files</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PathsToClean -&gt; IO (IORef PathsToClean)
forall a. a -&gt; IO (IORef a)
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#newIORef/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="GHC.Utils.TmpFs.html#emptyPathsToClean"><span class="hs-identifier hs-var">emptyPathsToClean</span></a></span><span>
</span><span id="line-116"></span><span>    </span><span id="local-6989586621681622197"><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622197"><span class="hs-identifier hs-var">subdirs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PathsToClean -&gt; IO (IORef PathsToClean)
forall a. a -&gt; IO (IORef a)
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#newIORef/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="GHC.Utils.TmpFs.html#emptyPathsToClean"><span class="hs-identifier hs-var">emptyPathsToClean</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span id="local-6989586621681622198"><span class="annot"><span class="annottext">IORef (Map FilePath FilePath)
</span><a href="#local-6989586621681622198"><span class="hs-identifier hs-var">dirs</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map FilePath FilePath -&gt; IO (IORef (Map FilePath FilePath))
forall a. a -&gt; IO (IORef a)
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#newIORef/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Map FilePath FilePath
forall k a. Map k a
</span><a href="../../containers-0.6.7/src/Data.Map.Internal.html#empty/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span id="local-6989586621681622200"><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621681622200"><span class="hs-identifier hs-var">next</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (IORef Int)
forall a. a -&gt; IO (IORef a)
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#newIORef/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-119"></span><span>    </span><span class="annot"><span class="annottext">TmpFs -&gt; IO TmpFs
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(TmpFs -&gt; IO TmpFs) -&gt; TmpFs -&gt; IO TmpFs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span>
</span><span id="line-120"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tmp_files_to_clean :: IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_files_to_clean"><span class="hs-identifier hs-var">tmp_files_to_clean</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622195"><span class="hs-identifier hs-var">files</span></a></span><span>
</span><span id="line-121"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tmp_subdirs_to_clean :: IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_subdirs_to_clean"><span class="hs-identifier hs-var">tmp_subdirs_to_clean</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622197"><span class="hs-identifier hs-var">subdirs</span></a></span><span>
</span><span id="line-122"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tmp_dirs_to_clean :: IORef (Map FilePath FilePath)
</span><a href="GHC.Utils.TmpFs.html#tmp_dirs_to_clean"><span class="hs-identifier hs-var">tmp_dirs_to_clean</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Map FilePath FilePath)
</span><a href="#local-6989586621681622198"><span class="hs-identifier hs-var">dirs</span></a></span><span>
</span><span id="line-123"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tmp_next_suffix :: IORef Int
</span><a href="GHC.Utils.TmpFs.html#tmp_next_suffix"><span class="hs-identifier hs-var">tmp_next_suffix</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621681622200"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-124"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-comment">-- | Initialise an empty TmpFs sharing unique numbers and per-process temporary</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- directories with the given TmpFs</span><span>
</span><span id="line-128"></span><span class="hs-comment">--</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- It's not safe to use the subdirs created by the original TmpFs with the</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- forked one. Use @newTempSubDir@ to create new subdirs instead.</span><span>
</span><span id="line-131"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#forkTmpFsFrom"><span class="hs-identifier hs-type">forkTmpFsFrom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span>
</span><span id="line-132"></span><span id="forkTmpFsFrom"><span class="annot"><span class="annottext">forkTmpFsFrom :: TmpFs -&gt; IO TmpFs
</span><a href="GHC.Utils.TmpFs.html#forkTmpFsFrom"><span class="hs-identifier hs-var hs-var">forkTmpFsFrom</span></a></span></span><span> </span><span id="local-6989586621681622201"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622201"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>    </span><span id="local-6989586621681622202"><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622202"><span class="hs-identifier hs-var">files</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PathsToClean -&gt; IO (IORef PathsToClean)
forall a. a -&gt; IO (IORef a)
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#newIORef/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="GHC.Utils.TmpFs.html#emptyPathsToClean"><span class="hs-identifier hs-var">emptyPathsToClean</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span id="local-6989586621681622203"><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622203"><span class="hs-identifier hs-var">subdirs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PathsToClean -&gt; IO (IORef PathsToClean)
forall a. a -&gt; IO (IORef a)
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#newIORef/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="GHC.Utils.TmpFs.html#emptyPathsToClean"><span class="hs-identifier hs-var">emptyPathsToClean</span></a></span><span>
</span><span id="line-135"></span><span>    </span><span class="annot"><span class="annottext">TmpFs -&gt; IO TmpFs
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(TmpFs -&gt; IO TmpFs) -&gt; TmpFs -&gt; IO TmpFs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span>
</span><span id="line-136"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tmp_files_to_clean :: IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_files_to_clean"><span class="hs-identifier hs-var">tmp_files_to_clean</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622202"><span class="hs-identifier hs-var">files</span></a></span><span>
</span><span id="line-137"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tmp_subdirs_to_clean :: IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_subdirs_to_clean"><span class="hs-identifier hs-var">tmp_subdirs_to_clean</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622203"><span class="hs-identifier hs-var">subdirs</span></a></span><span>
</span><span id="line-138"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tmp_dirs_to_clean :: IORef (Map FilePath FilePath)
</span><a href="GHC.Utils.TmpFs.html#tmp_dirs_to_clean"><span class="hs-identifier hs-var">tmp_dirs_to_clean</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TmpFs -&gt; IORef (Map FilePath FilePath)
</span><a href="GHC.Utils.TmpFs.html#tmp_dirs_to_clean"><span class="hs-identifier hs-var">tmp_dirs_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622201"><span class="hs-identifier hs-var">old</span></a></span><span>
</span><span id="line-139"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tmp_next_suffix :: IORef Int
</span><a href="GHC.Utils.TmpFs.html#tmp_next_suffix"><span class="hs-identifier hs-var">tmp_next_suffix</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TmpFs -&gt; IORef Int
</span><a href="GHC.Utils.TmpFs.html#tmp_next_suffix"><span class="hs-identifier hs-var">tmp_next_suffix</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622201"><span class="hs-identifier hs-var">old</span></a></span><span>
</span><span id="line-140"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-comment">-- | Merge the first TmpFs into the second.</span><span>
</span><span id="line-143"></span><span class="hs-comment">--</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- The first TmpFs is returned emptied.</span><span>
</span><span id="line-145"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#mergeTmpFsInto"><span class="hs-identifier hs-type">mergeTmpFsInto</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span id="mergeTmpFsInto"><span class="annot"><span class="annottext">mergeTmpFsInto :: TmpFs -&gt; TmpFs -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#mergeTmpFsInto"><span class="hs-identifier hs-var hs-var">mergeTmpFsInto</span></a></span></span><span> </span><span id="local-6989586621681622204"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622204"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621681622205"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622205"><span class="hs-identifier hs-var">dst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>    </span><span id="local-6989586621681622206"><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622206"><span class="hs-identifier hs-var">src_files</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
-&gt; (PathsToClean -&gt; (PathsToClean, PathsToClean))
-&gt; IO PathsToClean
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#atomicModifyIORef%27/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_files_to_clean"><span class="hs-identifier hs-var">tmp_files_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622204"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681622208"><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622208"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PathsToClean
</span><a href="GHC.Utils.TmpFs.html#emptyPathsToClean"><span class="hs-identifier hs-var">emptyPathsToClean</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622208"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>    </span><span id="local-6989586621681622209"><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622209"><span class="hs-identifier hs-var">src_subdirs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
-&gt; (PathsToClean -&gt; (PathsToClean, PathsToClean))
-&gt; IO PathsToClean
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#atomicModifyIORef%27/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_subdirs_to_clean"><span class="hs-identifier hs-var">tmp_subdirs_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622204"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681622210"><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622210"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PathsToClean
</span><a href="GHC.Utils.TmpFs.html#emptyPathsToClean"><span class="hs-identifier hs-var">emptyPathsToClean</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622210"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><span class="annottext">IORef PathsToClean -&gt; (PathsToClean -&gt; (PathsToClean, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#atomicModifyIORef%27/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_files_to_clean"><span class="hs-identifier hs-var">tmp_files_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622205"><span class="hs-identifier hs-var">dst</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681622211"><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622211"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PathsToClean -&gt; PathsToClean -&gt; PathsToClean
</span><a href="GHC.Utils.TmpFs.html#mergePathsToClean"><span class="hs-identifier hs-var">mergePathsToClean</span></a></span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622206"><span class="hs-identifier hs-var">src_files</span></a></span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622211"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><span class="annottext">IORef PathsToClean -&gt; (PathsToClean -&gt; (PathsToClean, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#atomicModifyIORef%27/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_subdirs_to_clean"><span class="hs-identifier hs-var">tmp_subdirs_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622205"><span class="hs-identifier hs-var">dst</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681622212"><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622212"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PathsToClean -&gt; PathsToClean -&gt; PathsToClean
</span><a href="GHC.Utils.TmpFs.html#mergePathsToClean"><span class="hs-identifier hs-var">mergePathsToClean</span></a></span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622209"><span class="hs-identifier hs-var">src_subdirs</span></a></span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622212"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#cleanTempDirs"><span class="hs-identifier hs-type">cleanTempDirs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span id="cleanTempDirs"><span class="annot"><span class="annottext">cleanTempDirs :: Logger -&gt; TmpFs -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#cleanTempDirs"><span class="hs-identifier hs-var hs-var">cleanTempDirs</span></a></span></span><span> </span><span id="local-6989586621681622213"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622213"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681622214"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622214"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span>
</span><span id="line-155"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><a href="../../base-4.18.3.0/src/GHC.IO.html#mask_/GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a></span><span>
</span><span id="line-156"></span><span>   </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681622216"><span class="annot"><span class="annottext">ref :: IORef (Map FilePath FilePath)
</span><a href="#local-6989586621681622216"><span class="hs-identifier hs-var hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TmpFs -&gt; IORef (Map FilePath FilePath)
</span><a href="GHC.Utils.TmpFs.html#tmp_dirs_to_clean"><span class="hs-identifier hs-var">tmp_dirs_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622214"><span class="hs-identifier hs-var">tmpfs</span></a></span><span>
</span><span id="line-157"></span><span>        </span><span id="local-6989586621681622217"><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621681622217"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Map FilePath FilePath)
-&gt; (Map FilePath FilePath
    -&gt; (Map FilePath FilePath, Map FilePath FilePath))
-&gt; IO (Map FilePath FilePath)
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#atomicModifyIORef%27/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map FilePath FilePath)
</span><a href="#local-6989586621681622216"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">((Map FilePath FilePath
  -&gt; (Map FilePath FilePath, Map FilePath FilePath))
 -&gt; IO (Map FilePath FilePath))
-&gt; (Map FilePath FilePath
    -&gt; (Map FilePath FilePath, Map FilePath FilePath))
-&gt; IO (Map FilePath FilePath)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681622218"><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621681622218"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map FilePath FilePath
forall k a. Map k a
</span><a href="../../containers-0.6.7/src/Data.Map.Internal.html#empty/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621681622218"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>        </span><span class="annot"><span class="annottext">Logger -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#removeTmpDirs"><span class="hs-identifier hs-var">removeTmpDirs</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622213"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map FilePath FilePath -&gt; [FilePath]
forall k a. Map k a -&gt; [a]
</span><a href="../../containers-0.6.7/src/Data.Map.Internal.html#elems/Data.Map.Internal.html#elems"><span class="hs-identifier hs-var">Map.elems</span></a></span><span> </span><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621681622217"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span class="annot"><span class="hs-comment">-- | Delete all paths in @tmp_files_to_clean@ and @tmp_subdirs_to_clean@.</span></span><span>
</span><span id="line-161"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#cleanTempFiles"><span class="hs-identifier hs-type">cleanTempFiles</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span id="cleanTempFiles"><span class="annot"><span class="annottext">cleanTempFiles :: Logger -&gt; TmpFs -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#cleanTempFiles"><span class="hs-identifier hs-var hs-var">cleanTempFiles</span></a></span></span><span> </span><span id="local-6989586621681622221"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622221"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681622222"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622222"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span>
</span><span id="line-163"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><a href="../../base-4.18.3.0/src/GHC.IO.html#mask_/GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a></span><span>
</span><span id="line-164"></span><span>   </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">([FilePath] -&gt; IO ()) -&gt; IORef PathsToClean -&gt; IO ()
forall {b}. ([FilePath] -&gt; IO b) -&gt; IORef PathsToClean -&gt; IO b
</span><a href="#local-6989586621681622223"><span class="hs-identifier hs-var">removeWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#removeTmpFiles"><span class="hs-identifier hs-var">removeTmpFiles</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622221"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_files_to_clean"><span class="hs-identifier hs-var">tmp_files_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622222"><span class="hs-identifier hs-var">tmpfs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>        </span><span class="annot"><span class="annottext">([FilePath] -&gt; IO ()) -&gt; IORef PathsToClean -&gt; IO ()
forall {b}. ([FilePath] -&gt; IO b) -&gt; IORef PathsToClean -&gt; IO b
</span><a href="#local-6989586621681622223"><span class="hs-identifier hs-var">removeWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#removeTmpSubdirs"><span class="hs-identifier hs-var">removeTmpSubdirs</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622221"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_subdirs_to_clean"><span class="hs-identifier hs-var">tmp_subdirs_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622222"><span class="hs-identifier hs-var">tmpfs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-167"></span><span>    </span><span id="local-6989586621681622223"><span class="annot"><span class="annottext">removeWith :: ([FilePath] -&gt; IO b) -&gt; IORef PathsToClean -&gt; IO b
</span><a href="#local-6989586621681622223"><span class="hs-identifier hs-var hs-var">removeWith</span></a></span></span><span> </span><span id="local-6989586621681622227"><span class="annot"><span class="annottext">[FilePath] -&gt; IO b
</span><a href="#local-6989586621681622227"><span class="hs-identifier hs-var">remove</span></a></span></span><span> </span><span id="local-6989586621681622228"><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622228"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-168"></span><span>      </span><span id="local-6989586621681622229"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622229"><span class="hs-identifier hs-var">to_delete</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
-&gt; (PathsToClean -&gt; (PathsToClean, [FilePath])) -&gt; IO [FilePath]
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#atomicModifyIORef%27/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622228"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">((PathsToClean -&gt; (PathsToClean, [FilePath])) -&gt; IO [FilePath])
-&gt; (PathsToClean -&gt; (PathsToClean, [FilePath])) -&gt; IO [FilePath]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-169"></span><span>        </span><span class="hs-glyph">\</span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span>
</span><span id="line-170"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ptcCurrentModule :: PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var">ptcCurrentModule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681622230"><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622230"><span class="hs-identifier hs-var">cm_paths</span></a></span></span><span>
</span><span id="line-171"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ptcGhcSession :: PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcGhcSession"><span class="hs-identifier hs-var">ptcGhcSession</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681622231"><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622231"><span class="hs-identifier hs-var">gs_paths</span></a></span></span><span>
</span><span id="line-172"></span><span>            </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">PathsToClean
</span><a href="GHC.Utils.TmpFs.html#emptyPathsToClean"><span class="hs-identifier hs-var">emptyPathsToClean</span></a></span><span>
</span><span id="line-173"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; [FilePath]
forall a. Set a -&gt; [a]
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#toList/Data.Set.Internal.html#toList"><span class="hs-identifier hs-var">Set.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622230"><span class="hs-identifier hs-var">cm_paths</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; [FilePath] -&gt; [FilePath]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; [FilePath]
forall a. Set a -&gt; [a]
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#toList/Data.Set.Internal.html#toList"><span class="hs-identifier hs-var">Set.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622231"><span class="hs-identifier hs-var">gs_paths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>      </span><span class="annot"><span class="annottext">[FilePath] -&gt; IO b
</span><a href="#local-6989586621681622227"><span class="hs-identifier hs-var">remove</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622229"><span class="hs-identifier hs-var">to_delete</span></a></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="hs-comment">-- | Keep all the paths in @tmp_files_to_clean@ and @tmp_subdirs_to_clean@</span><span>
</span><span id="line-177"></span><span class="hs-comment">-- that have lifetime TFL_CurrentModule. This function is used when `-keep-tmp-files` is</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- used in an OPTIONS_GHC pragma.</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- This function removes the temporary file from the TmpFs so we no longer remove</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- it at the env when cleanTempFiles is called.</span><span>
</span><span id="line-181"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#keepCurrentModuleTempFiles"><span class="hs-identifier hs-type">keepCurrentModuleTempFiles</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Stack.Types.html#HasCallStack/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span id="keepCurrentModuleTempFiles"><span class="annot"><span class="annottext">keepCurrentModuleTempFiles :: HasCallStack =&gt; Logger -&gt; TmpFs -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#keepCurrentModuleTempFiles"><span class="hs-identifier hs-var hs-var">keepCurrentModuleTempFiles</span></a></span></span><span> </span><span id="local-6989586621681622243"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622243"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681622244"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622244"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span>
</span><span id="line-183"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><a href="../../base-4.18.3.0/src/GHC.IO.html#mask_/GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a></span><span>
</span><span id="line-184"></span><span>   </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621681622245"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622245"><span class="hs-identifier hs-var">to_keep_files</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean -&gt; IO [FilePath]
</span><a href="#local-6989586621681622246"><span class="hs-identifier hs-var">keep</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_files_to_clean"><span class="hs-identifier hs-var">tmp_files_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622244"><span class="hs-identifier hs-var">tmpfs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>        </span><span id="local-6989586621681622247"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622247"><span class="hs-identifier hs-var">to_keep_subdirs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean -&gt; IO [FilePath]
</span><a href="#local-6989586621681622246"><span class="hs-identifier hs-var">keep</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_subdirs_to_clean"><span class="hs-identifier hs-var">tmp_subdirs_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622244"><span class="hs-identifier hs-var">tmpfs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>        </span><span class="hs-comment">-- Remove any folders which contain any files we want to keep from the</span><span>
</span><span id="line-187"></span><span>        </span><span class="hs-comment">-- directories we are tracking. A new temporary directory will be created</span><span>
</span><span id="line-188"></span><span>        </span><span class="hs-comment">-- the next time a temporary file is needed (by perhaps another module).</span><span>
</span><span id="line-189"></span><span>        </span><span class="annot"><span class="annottext">[FilePath] -&gt; IORef (Map FilePath FilePath) -&gt; IO ()
forall {k}. [FilePath] -&gt; IORef (Map k FilePath) -&gt; IO ()
</span><a href="#local-6989586621681622248"><span class="hs-identifier hs-var">keepDirs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622245"><span class="hs-identifier hs-var">to_keep_files</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; [FilePath] -&gt; [FilePath]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622247"><span class="hs-identifier hs-var">to_keep_subdirs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef (Map FilePath FilePath)
</span><a href="GHC.Utils.TmpFs.html#tmp_dirs_to_clean"><span class="hs-identifier hs-var">tmp_dirs_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622244"><span class="hs-identifier hs-var">tmpfs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621681622248"><span class="annot"><span class="annottext">keepDirs :: [FilePath] -&gt; IORef (Map k FilePath) -&gt; IO ()
</span><a href="#local-6989586621681622248"><span class="hs-identifier hs-var hs-var">keepDirs</span></a></span></span><span> </span><span id="local-6989586621681622252"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622252"><span class="hs-identifier hs-var">keeps</span></a></span></span><span> </span><span id="local-6989586621681622253"><span class="annot"><span class="annottext">IORef (Map k FilePath)
</span><a href="#local-6989586621681622253"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681622254"><span class="annot"><span class="annottext">keep_dirs :: Set FilePath
</span><a href="#local-6989586621681622254"><span class="hs-identifier hs-var hs-var">keep_dirs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; Set FilePath
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#fromList/Data.Set.Internal.html#fromList"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShowS -&gt; [FilePath] -&gt; [FilePath]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">ShowS
</span><a href="../../filepath-1.4.301.0/src/System.FilePath.Posix.html#takeDirectory/System.FilePath.Posix.html#takeDirectory"><span class="hs-identifier hs-var">takeDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622252"><span class="hs-identifier hs-var">keeps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>      </span><span class="annot"><span class="annottext">IORef (Map k FilePath)
-&gt; (Map k FilePath -&gt; (Map k FilePath, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#atomicModifyIORef%27/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map k FilePath)
</span><a href="#local-6989586621681622253"><span class="hs-identifier hs-var">ref</span></a></span><span>  </span><span class="annot"><span class="annottext">((Map k FilePath -&gt; (Map k FilePath, ())) -&gt; IO ())
-&gt; (Map k FilePath -&gt; (Map k FilePath, ())) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681622257"><span class="annot"><span class="annottext">Map k FilePath
</span><a href="#local-6989586621681622257"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FilePath -&gt; Bool) -&gt; Map k FilePath -&gt; Map k FilePath
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><a href="../../containers-0.6.7/src/Data.Map.Internal.html#filter/Data.Map.Internal.html#filter"><span class="hs-identifier hs-var">Map.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681622259"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622259"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622259"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Set FilePath -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#notMember/Data.Set.Internal.html#notMember"><span class="hs-operator hs-var">`Set.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622254"><span class="hs-identifier hs-var">keep_dirs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map k FilePath
</span><a href="#local-6989586621681622257"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span>    </span><span id="local-6989586621681622246"><span class="annot"><span class="annottext">keep :: IORef PathsToClean -&gt; IO [FilePath]
</span><a href="#local-6989586621681622246"><span class="hs-identifier hs-var hs-var">keep</span></a></span></span><span> </span><span id="local-6989586621681622261"><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622261"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-196"></span><span>        </span><span id="local-6989586621681622262"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622262"><span class="hs-identifier hs-var">to_keep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
-&gt; (PathsToClean -&gt; (PathsToClean, [FilePath])) -&gt; IO [FilePath]
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#atomicModifyIORef%27/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622261"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">((PathsToClean -&gt; (PathsToClean, [FilePath])) -&gt; IO [FilePath])
-&gt; (PathsToClean -&gt; (PathsToClean, [FilePath])) -&gt; IO [FilePath]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-197"></span><span>            </span><span class="hs-glyph">\</span><span id="local-6989586621681622263"><span class="annot"><span class="annottext">ptc :: PathsToClean
</span><a href="#local-6989586621681622263"><span class="hs-identifier hs-var">ptc</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ptcCurrentModule :: PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var">ptcCurrentModule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681622264"><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622264"><span class="hs-identifier hs-var">cm_paths</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-198"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622263"><span class="hs-identifier hs-var">ptc</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var">ptcCurrentModule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../containers-0.6.7/src/Data.Set.Internal.html#empty/Data.Set.Internal.html#empty"><span class="hs-identifier hs-type">Set.empty</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; [FilePath]
forall a. Set a -&gt; [a]
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#toList/Data.Set.Internal.html#toList"><span class="hs-identifier hs-var">Set.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622264"><span class="hs-identifier hs-var">cm_paths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>        </span><span class="annot"><span class="annottext">Logger -&gt; Int -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Error.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622243"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Keeping:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FilePath -&gt; SDoc) -&gt; [FilePath] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622262"><span class="hs-identifier hs-var">to_keep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>        </span><span class="annot"><span class="annottext">[FilePath] -&gt; IO [FilePath]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622262"><span class="hs-identifier hs-var">to_keep</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="hs-comment">-- | Delete all paths in @tmp_files_to_clean@ and @tmp_subdirs_to_clean@</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- That have lifetime TFL_CurrentModule.</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- If a file must be cleaned eventually, but must survive a</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- cleanCurrentModuleTempFiles, ensure it has lifetime TFL_GhcSession.</span><span>
</span><span id="line-206"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#cleanCurrentModuleTempFiles"><span class="hs-identifier hs-type">cleanCurrentModuleTempFiles</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span id="cleanCurrentModuleTempFiles"><span class="annot"><span class="annottext">cleanCurrentModuleTempFiles :: Logger -&gt; TmpFs -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#cleanCurrentModuleTempFiles"><span class="hs-identifier hs-var hs-var">cleanCurrentModuleTempFiles</span></a></span></span><span> </span><span id="local-6989586621681622269"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622269"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681622270"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622270"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span>
</span><span id="line-208"></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><a href="../../base-4.18.3.0/src/GHC.IO.html#mask_/GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a></span><span>
</span><span id="line-209"></span><span>   </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">([FilePath] -&gt; IO ()) -&gt; IORef PathsToClean -&gt; IO ()
forall {b}. ([FilePath] -&gt; IO b) -&gt; IORef PathsToClean -&gt; IO b
</span><a href="#local-6989586621681622271"><span class="hs-identifier hs-var">removeWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#removeTmpFiles"><span class="hs-identifier hs-var">removeTmpFiles</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622269"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_files_to_clean"><span class="hs-identifier hs-var">tmp_files_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622270"><span class="hs-identifier hs-var">tmpfs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>        </span><span class="annot"><span class="annottext">([FilePath] -&gt; IO ()) -&gt; IORef PathsToClean -&gt; IO ()
forall {b}. ([FilePath] -&gt; IO b) -&gt; IORef PathsToClean -&gt; IO b
</span><a href="#local-6989586621681622271"><span class="hs-identifier hs-var">removeWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#removeTmpSubdirs"><span class="hs-identifier hs-var">removeTmpSubdirs</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622269"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_subdirs_to_clean"><span class="hs-identifier hs-var">tmp_subdirs_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622270"><span class="hs-identifier hs-var">tmpfs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-212"></span><span>    </span><span id="local-6989586621681622271"><span class="annot"><span class="annottext">removeWith :: ([FilePath] -&gt; IO b) -&gt; IORef PathsToClean -&gt; IO b
</span><a href="#local-6989586621681622271"><span class="hs-identifier hs-var hs-var">removeWith</span></a></span></span><span> </span><span id="local-6989586621681622273"><span class="annot"><span class="annottext">[FilePath] -&gt; IO b
</span><a href="#local-6989586621681622273"><span class="hs-identifier hs-var">remove</span></a></span></span><span> </span><span id="local-6989586621681622274"><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622274"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-213"></span><span>        </span><span id="local-6989586621681622275"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622275"><span class="hs-identifier hs-var">to_delete</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
-&gt; (PathsToClean -&gt; (PathsToClean, [FilePath])) -&gt; IO [FilePath]
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#atomicModifyIORef%27/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622274"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">((PathsToClean -&gt; (PathsToClean, [FilePath])) -&gt; IO [FilePath])
-&gt; (PathsToClean -&gt; (PathsToClean, [FilePath])) -&gt; IO [FilePath]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-214"></span><span>            </span><span class="hs-glyph">\</span><span id="local-6989586621681622276"><span class="annot"><span class="annottext">ptc :: PathsToClean
</span><a href="#local-6989586621681622276"><span class="hs-identifier hs-var">ptc</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ptcCurrentModule :: PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var">ptcCurrentModule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681622277"><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622277"><span class="hs-identifier hs-var">cm_paths</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-215"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PathsToClean
</span><a href="#local-6989586621681622276"><span class="hs-identifier hs-var">ptc</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var">ptcCurrentModule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../containers-0.6.7/src/Data.Set.Internal.html#empty/Data.Set.Internal.html#empty"><span class="hs-identifier hs-type">Set.empty</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; [FilePath]
forall a. Set a -&gt; [a]
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#toList/Data.Set.Internal.html#toList"><span class="hs-identifier hs-var">Set.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622277"><span class="hs-identifier hs-var">cm_paths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>        </span><span class="annot"><span class="annottext">[FilePath] -&gt; IO b
</span><a href="#local-6989586621681622273"><span class="hs-identifier hs-var">remove</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622275"><span class="hs-identifier hs-var">to_delete</span></a></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="hs-comment">-- | Ensure that new_files are cleaned on the next call of</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- 'cleanTempFiles' or 'cleanCurrentModuleTempFiles', depending on lifetime.</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- If any of new_files are already tracked, they will have their lifetime</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- updated.</span><span>
</span><span id="line-222"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#addFilesToClean"><span class="hs-identifier hs-type">addFilesToClean</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempFileLifetime"><span class="hs-identifier hs-type">TempFileLifetime</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span id="addFilesToClean"><span class="annot"><span class="annottext">addFilesToClean :: TmpFs -&gt; TempFileLifetime -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#addFilesToClean"><span class="hs-identifier hs-var hs-var">addFilesToClean</span></a></span></span><span> </span><span id="local-6989586621681622278"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622278"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span> </span><span id="local-6989586621681622279"><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622279"><span class="hs-identifier hs-var">lifetime</span></a></span></span><span> </span><span id="local-6989586621681622280"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622280"><span class="hs-identifier hs-var">new_files</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-224"></span><span>  </span><span class="annot"><span class="annottext">IORef PathsToClean -&gt; TempFileLifetime -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#addToClean"><span class="hs-identifier hs-var">addToClean</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_files_to_clean"><span class="hs-identifier hs-var">tmp_files_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622278"><span class="hs-identifier hs-var">tmpfs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622279"><span class="hs-identifier hs-var">lifetime</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622280"><span class="hs-identifier hs-var">new_files</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#addSubdirsToClean"><span class="hs-identifier hs-type">addSubdirsToClean</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempFileLifetime"><span class="hs-identifier hs-type">TempFileLifetime</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span id="addSubdirsToClean"><span class="annot"><span class="annottext">addSubdirsToClean :: TmpFs -&gt; TempFileLifetime -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#addSubdirsToClean"><span class="hs-identifier hs-var hs-var">addSubdirsToClean</span></a></span></span><span> </span><span id="local-6989586621681622283"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622283"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span> </span><span id="local-6989586621681622284"><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622284"><span class="hs-identifier hs-var">lifetime</span></a></span></span><span> </span><span id="local-6989586621681622285"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622285"><span class="hs-identifier hs-var">new_subdirs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-228"></span><span>  </span><span class="annot"><span class="annottext">IORef PathsToClean -&gt; TempFileLifetime -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#addToClean"><span class="hs-identifier hs-var">addToClean</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_subdirs_to_clean"><span class="hs-identifier hs-var">tmp_subdirs_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622283"><span class="hs-identifier hs-var">tmpfs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622284"><span class="hs-identifier hs-var">lifetime</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622285"><span class="hs-identifier hs-var">new_subdirs</span></a></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#addToClean"><span class="hs-identifier hs-type">addToClean</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IORef.html#IORef/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempFileLifetime"><span class="hs-identifier hs-type">TempFileLifetime</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span id="addToClean"><span class="annot"><span class="annottext">addToClean :: IORef PathsToClean -&gt; TempFileLifetime -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#addToClean"><span class="hs-identifier hs-var hs-var">addToClean</span></a></span></span><span> </span><span id="local-6989586621681622286"><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622286"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621681622287"><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622287"><span class="hs-identifier hs-var">lifetime</span></a></span></span><span> </span><span id="local-6989586621681622288"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622288"><span class="hs-identifier hs-var">new_filepaths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean -&gt; (PathsToClean -&gt; PathsToClean) -&gt; IO ()
forall a. IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><a href="../../base-4.18.3.0/src/Data.IORef.html#modifyIORef%27/Data.IORef.html#modifyIORef%27"><span class="hs-identifier hs-var">modifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean
</span><a href="#local-6989586621681622286"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">((PathsToClean -&gt; PathsToClean) -&gt; IO ())
-&gt; (PathsToClean -&gt; PathsToClean) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-glyph">\</span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ptcCurrentModule :: PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var">ptcCurrentModule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681622290"><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622290"><span class="hs-identifier hs-var">cm_paths</span></a></span></span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ptcGhcSession :: PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcGhcSession"><span class="hs-identifier hs-var">ptcGhcSession</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681622291"><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622291"><span class="hs-identifier hs-var">gs_paths</span></a></span></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622287"><span class="hs-identifier hs-var">lifetime</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-236"></span><span>      </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="GHC.Utils.TmpFs.html#TFL_CurrentModule"><span class="hs-identifier hs-var">TFL_CurrentModule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span>
</span><span id="line-237"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ptcCurrentModule :: Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var">ptcCurrentModule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622290"><span class="hs-identifier hs-var">cm_paths</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; Set FilePath -&gt; Set FilePath
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#union/Data.Set.Internal.html#union"><span class="hs-operator hs-var">`Set.union`</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622292"><span class="hs-identifier hs-var">new_filepaths_set</span></a></span><span>
</span><span id="line-238"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ptcGhcSession :: Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcGhcSession"><span class="hs-identifier hs-var">ptcGhcSession</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622291"><span class="hs-identifier hs-var">gs_paths</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; Set FilePath -&gt; Set FilePath
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#difference/Data.Set.Internal.html#difference"><span class="hs-operator hs-var">`Set.difference`</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622292"><span class="hs-identifier hs-var">new_filepaths_set</span></a></span><span>
</span><span id="line-239"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-240"></span><span>      </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="GHC.Utils.TmpFs.html#TFL_GhcSession"><span class="hs-identifier hs-var">TFL_GhcSession</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span>
</span><span id="line-241"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ptcCurrentModule :: Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var">ptcCurrentModule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622290"><span class="hs-identifier hs-var">cm_paths</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; Set FilePath -&gt; Set FilePath
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#difference/Data.Set.Internal.html#difference"><span class="hs-operator hs-var">`Set.difference`</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622292"><span class="hs-identifier hs-var">new_filepaths_set</span></a></span><span>
</span><span id="line-242"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ptcGhcSession :: Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcGhcSession"><span class="hs-identifier hs-var">ptcGhcSession</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622291"><span class="hs-identifier hs-var">gs_paths</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath -&gt; Set FilePath -&gt; Set FilePath
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#union/Data.Set.Internal.html#union"><span class="hs-operator hs-var">`Set.union`</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622292"><span class="hs-identifier hs-var">new_filepaths_set</span></a></span><span>
</span><span id="line-243"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-245"></span><span>    </span><span id="local-6989586621681622292"><span class="annot"><span class="annottext">new_filepaths_set :: Set FilePath
</span><a href="#local-6989586621681622292"><span class="hs-identifier hs-var hs-var">new_filepaths_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; Set FilePath
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#fromList/Data.Set.Internal.html#fromList"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622288"><span class="hs-identifier hs-var">new_filepaths</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="hs-comment">-- | Update the lifetime of files already being tracked. If any files are</span><span>
</span><span id="line-248"></span><span class="hs-comment">-- not being tracked they will be discarded.</span><span>
</span><span id="line-249"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#changeTempFilesLifetime"><span class="hs-identifier hs-type">changeTempFilesLifetime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempFileLifetime"><span class="hs-identifier hs-type">TempFileLifetime</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span id="changeTempFilesLifetime"><span class="annot"><span class="annottext">changeTempFilesLifetime :: TmpFs -&gt; TempFileLifetime -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#changeTempFilesLifetime"><span class="hs-identifier hs-var hs-var">changeTempFilesLifetime</span></a></span></span><span> </span><span id="local-6989586621681622294"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622294"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span> </span><span id="local-6989586621681622295"><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622295"><span class="hs-identifier hs-var">lifetime</span></a></span></span><span> </span><span id="local-6989586621681622296"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622296"><span class="hs-identifier hs-var">files</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><a href="GHC.Utils.TmpFs.html#PathsToClean"><span class="hs-identifier hs-type">PathsToClean</span></a></span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ptcCurrentModule :: PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcCurrentModule"><span class="hs-identifier hs-var">ptcCurrentModule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681622297"><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622297"><span class="hs-identifier hs-var">cm_paths</span></a></span></span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ptcGhcSession :: PathsToClean -&gt; Set FilePath
</span><a href="GHC.Utils.TmpFs.html#ptcGhcSession"><span class="hs-identifier hs-var">ptcGhcSession</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681622298"><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622298"><span class="hs-identifier hs-var">gs_paths</span></a></span></span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef PathsToClean -&gt; IO PathsToClean
forall a. IORef a -&gt; IO a
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#readIORef/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef PathsToClean
</span><a href="GHC.Utils.TmpFs.html#tmp_files_to_clean"><span class="hs-identifier hs-var">tmp_files_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622294"><span class="hs-identifier hs-var">tmpfs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681622300"><span class="annot"><span class="annottext">old_set :: Set FilePath
</span><a href="#local-6989586621681622300"><span class="hs-identifier hs-var hs-var">old_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622295"><span class="hs-identifier hs-var">lifetime</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-256"></span><span>        </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="GHC.Utils.TmpFs.html#TFL_CurrentModule"><span class="hs-identifier hs-var">TFL_CurrentModule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622298"><span class="hs-identifier hs-var">gs_paths</span></a></span><span>
</span><span id="line-257"></span><span>        </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="GHC.Utils.TmpFs.html#TFL_GhcSession"><span class="hs-identifier hs-var">TFL_GhcSession</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622297"><span class="hs-identifier hs-var">cm_paths</span></a></span><span>
</span><span id="line-258"></span><span>      </span><span id="local-6989586621681622301"><span class="annot"><span class="annottext">existing_files :: [FilePath]
</span><a href="#local-6989586621681622301"><span class="hs-identifier hs-var hs-var">existing_files</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622302"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681622302"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622302"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622296"><span class="hs-identifier hs-var">files</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622302"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Set FilePath -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../containers-0.6.7/src/Data.Set.Internal.html#member/Data.Set.Internal.html#member"><span class="hs-operator hs-var">`Set.member`</span></a></span><span> </span><span class="annot"><span class="annottext">Set FilePath
</span><a href="#local-6989586621681622300"><span class="hs-identifier hs-var">old_set</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">TmpFs -&gt; TempFileLifetime -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#addFilesToClean"><span class="hs-identifier hs-var">addFilesToClean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622294"><span class="hs-identifier hs-var">tmpfs</span></a></span><span> </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622295"><span class="hs-identifier hs-var">lifetime</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622301"><span class="hs-identifier hs-var">existing_files</span></a></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="hs-comment">-- Return a unique numeric temp file suffix</span><span>
</span><span id="line-262"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#newTempSuffix"><span class="hs-identifier hs-type">newTempSuffix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-263"></span><span id="newTempSuffix"><span class="annot"><span class="annottext">newTempSuffix :: TmpFs -&gt; IO Int
</span><a href="GHC.Utils.TmpFs.html#newTempSuffix"><span class="hs-identifier hs-var hs-var">newTempSuffix</span></a></span></span><span> </span><span id="local-6989586621681622305"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622305"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><span class="annottext">IORef Int -&gt; (Int -&gt; (Int, Int)) -&gt; IO Int
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#atomicModifyIORef%27/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TmpFs -&gt; IORef Int
</span><a href="GHC.Utils.TmpFs.html#tmp_next_suffix"><span class="hs-identifier hs-var">tmp_next_suffix</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622305"><span class="hs-identifier hs-var">tmpfs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Int -&gt; (Int, Int)) -&gt; IO Int) -&gt; (Int -&gt; (Int, Int)) -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681622306"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622306"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622306"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#%2B/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622306"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span class="hs-comment">-- Find a temporary name that doesn't already exist.</span><span>
</span><span id="line-267"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#newTempName"><span class="hs-identifier hs-type">newTempName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempDir"><span class="hs-identifier hs-type">TempDir</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempFileLifetime"><span class="hs-identifier hs-type">TempFileLifetime</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#Suffix"><span class="hs-identifier hs-type">Suffix</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-268"></span><span id="newTempName"><span class="annot"><span class="annottext">newTempName :: Logger
-&gt; TmpFs -&gt; TempDir -&gt; TempFileLifetime -&gt; FilePath -&gt; IO FilePath
</span><a href="GHC.Utils.TmpFs.html#newTempName"><span class="hs-identifier hs-var hs-var">newTempName</span></a></span></span><span> </span><span id="local-6989586621681622309"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622309"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681622310"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622310"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span> </span><span id="local-6989586621681622311"><span class="annot"><span class="annottext">TempDir
</span><a href="#local-6989586621681622311"><span class="hs-identifier hs-var">tmp_dir</span></a></span></span><span> </span><span id="local-6989586621681622312"><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622312"><span class="hs-identifier hs-var">lifetime</span></a></span></span><span> </span><span id="local-6989586621681622313"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622313"><span class="hs-identifier hs-var">extn</span></a></span></span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621681622314"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622314"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; TmpFs -&gt; TempDir -&gt; IO FilePath
</span><a href="GHC.Utils.TmpFs.html#getTempDir"><span class="hs-identifier hs-var">getTempDir</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622309"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622310"><span class="hs-identifier hs-var">tmpfs</span></a></span><span> </span><span class="annot"><span class="annottext">TempDir
</span><a href="#local-6989586621681622311"><span class="hs-identifier hs-var">tmp_dir</span></a></span><span>
</span><span id="line-270"></span><span>       </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
</span><a href="#local-6989586621681622316"><span class="hs-identifier hs-var">findTempName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622314"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../filepath-1.4.301.0/src/System.FilePath.Posix.html#%3C%2F%3E/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;ghc_&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Deterministic base name]</span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-272"></span><span>    </span><span class="annot"><a href="#local-6989586621681622316"><span class="hs-identifier hs-type">findTempName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span id="local-6989586621681622316"><span class="annot"><span class="annottext">findTempName :: FilePath -&gt; IO FilePath
</span><a href="#local-6989586621681622316"><span class="hs-identifier hs-var hs-var">findTempName</span></a></span></span><span> </span><span id="local-6989586621681622318"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622318"><span class="hs-identifier hs-var">prefix</span></a></span></span><span>
</span><span id="line-274"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621681622319"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622319"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TmpFs -&gt; IO Int
</span><a href="GHC.Utils.TmpFs.html#newTempSuffix"><span class="hs-identifier hs-var">newTempSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622310"><span class="hs-identifier hs-var">tmpfs</span></a></span><span>
</span><span id="line-275"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681622320"><span class="annot"><span class="annottext">filename :: FilePath
</span><a href="#local-6989586621681622320"><span class="hs-identifier hs-var hs-var">filename</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622318"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../base-4.18.3.0/src/GHC.Show.html#show/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622319"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../filepath-1.4.301.0/src/System.FilePath.Posix.html#%3C.%3E/System.FilePath.Posix.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622313"><span class="hs-identifier hs-var">extn</span></a></span><span>
</span><span id="line-276"></span><span>           </span><span id="local-6989586621681622323"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681622323"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO Bool
</span><a href="../../directory-1.3.8.5/src/System.Directory.html#doesFileExist/System.Directory.html#doesFileExist"><span class="hs-identifier hs-var">doesFileExist</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622320"><span class="hs-identifier hs-var">filename</span></a></span><span>
</span><span id="line-277"></span><span>           </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681622323"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
</span><a href="#local-6989586621681622316"><span class="hs-identifier hs-var">findTempName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622318"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-278"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- clean it up later</span><span>
</span><span id="line-279"></span><span>                        </span><span class="annot"><span class="annottext">TmpFs -&gt; TempFileLifetime -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#addFilesToClean"><span class="hs-identifier hs-var">addFilesToClean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622310"><span class="hs-identifier hs-var">tmpfs</span></a></span><span> </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622312"><span class="hs-identifier hs-var">lifetime</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622320"><span class="hs-identifier hs-var">filename</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-280"></span><span>                        </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622320"><span class="hs-identifier hs-var">filename</span></a></span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span class="hs-comment">-- | Create a new temporary subdirectory that doesn't already exist</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- The temporary subdirectory is automatically removed at the end of the</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- GHC session, but its contents aren't. Make sure to leave the directory</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- empty before the end of the session, either by removing content</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- directly or by using @addFilesToClean@.</span><span>
</span><span id="line-287"></span><span class="hs-comment">--</span><span>
</span><span id="line-288"></span><span class="hs-comment">-- If the created subdirectory is not empty, it will not be removed (along</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- with its parent temporary directory) and a warning message will be</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- printed at verbosity 2 and higher.</span><span>
</span><span id="line-291"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#newTempSubDir"><span class="hs-identifier hs-type">newTempSubDir</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempDir"><span class="hs-identifier hs-type">TempDir</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-292"></span><span id="newTempSubDir"><span class="annot"><span class="annottext">newTempSubDir :: Logger -&gt; TmpFs -&gt; TempDir -&gt; IO FilePath
</span><a href="GHC.Utils.TmpFs.html#newTempSubDir"><span class="hs-identifier hs-var hs-var">newTempSubDir</span></a></span></span><span> </span><span id="local-6989586621681622325"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622325"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681622326"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622326"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span> </span><span id="local-6989586621681622327"><span class="annot"><span class="annottext">TempDir
</span><a href="#local-6989586621681622327"><span class="hs-identifier hs-var">tmp_dir</span></a></span></span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621681622328"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622328"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; TmpFs -&gt; TempDir -&gt; IO FilePath
</span><a href="GHC.Utils.TmpFs.html#getTempDir"><span class="hs-identifier hs-var">getTempDir</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622325"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622326"><span class="hs-identifier hs-var">tmpfs</span></a></span><span> </span><span class="annot"><span class="annottext">TempDir
</span><a href="#local-6989586621681622327"><span class="hs-identifier hs-var">tmp_dir</span></a></span><span>
</span><span id="line-294"></span><span>       </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
</span><a href="#local-6989586621681622329"><span class="hs-identifier hs-var">findTempDir</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622328"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../filepath-1.4.301.0/src/System.FilePath.Posix.html#%3C%2F%3E/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;ghc_&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-296"></span><span>    </span><span class="annot"><a href="#local-6989586621681622329"><span class="hs-identifier hs-type">findTempDir</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span id="local-6989586621681622329"><span class="annot"><span class="annottext">findTempDir :: FilePath -&gt; IO FilePath
</span><a href="#local-6989586621681622329"><span class="hs-identifier hs-var hs-var">findTempDir</span></a></span></span><span> </span><span id="local-6989586621681622330"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622330"><span class="hs-identifier hs-var">prefix</span></a></span></span><span>
</span><span id="line-298"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621681622331"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622331"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TmpFs -&gt; IO Int
</span><a href="GHC.Utils.TmpFs.html#newTempSuffix"><span class="hs-identifier hs-var">newTempSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622326"><span class="hs-identifier hs-var">tmpfs</span></a></span><span>
</span><span id="line-299"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681622332"><span class="annot"><span class="annottext">name :: FilePath
</span><a href="#local-6989586621681622332"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622330"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../base-4.18.3.0/src/GHC.Show.html#show/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622331"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-300"></span><span>           </span><span id="local-6989586621681622333"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681622333"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO Bool
</span><a href="../../directory-1.3.8.5/src/System.Directory.html#doesDirectoryExist/System.Directory.html#doesDirectoryExist"><span class="hs-identifier hs-var">doesDirectoryExist</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622332"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-301"></span><span>           </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681622333"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
</span><a href="#local-6989586621681622329"><span class="hs-identifier hs-var">findTempDir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622330"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-302"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><span id="line-303"></span><span>                  </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../directory-1.3.8.5/src/System.Directory.html#createDirectory/System.Directory.html#createDirectory"><span class="hs-identifier hs-var">createDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622332"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-304"></span><span>                  </span><span class="annot"><span class="annottext">TmpFs -&gt; TempFileLifetime -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#addSubdirsToClean"><span class="hs-identifier hs-var">addSubdirsToClean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622326"><span class="hs-identifier hs-var">tmpfs</span></a></span><span> </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="GHC.Utils.TmpFs.html#TFL_GhcSession"><span class="hs-identifier hs-var">TFL_GhcSession</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622332"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-305"></span><span>                  </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622332"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>            </span><span class="annot"><span class="annottext">IO FilePath -&gt; (IOException -&gt; IO FilePath) -&gt; IO FilePath
forall a. IO a -&gt; (IOException -&gt; IO a) -&gt; IO a
</span><a href="GHC.Utils.Exception.html#catchIO"><span class="hs-operator hs-var">`Exception.catchIO`</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681622337"><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621681622337"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">IOException -&gt; Bool
</span><a href="../../base-4.18.3.0/src/System.IO.Error.html#isAlreadyExistsError/System.IO.Error.html#isAlreadyExistsError"><span class="hs-identifier hs-var">isAlreadyExistsError</span></a></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621681622337"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-307"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
</span><a href="#local-6989586621681622329"><span class="hs-identifier hs-var">findTempDir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622330"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IOException -&gt; IO FilePath
forall a. IOException -&gt; IO a
</span><a href="../../base-4.18.3.0/src/GHC.IO.Exception.html#ioError/GHC.IO.Exception.html#ioError"><span class="hs-identifier hs-var">ioError</span></a></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621681622337"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#newTempLibName"><span class="hs-identifier hs-type">newTempLibName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempDir"><span class="hs-identifier hs-type">TempDir</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempFileLifetime"><span class="hs-identifier hs-type">TempFileLifetime</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html#Suffix"><span class="hs-identifier hs-type">Suffix</span></a></span><span>
</span><span id="line-310"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#String/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span id="newTempLibName"><span class="annot"><span class="annottext">newTempLibName :: Logger
-&gt; TmpFs
-&gt; TempDir
-&gt; TempFileLifetime
-&gt; FilePath
-&gt; IO (FilePath, FilePath, FilePath)
</span><a href="GHC.Utils.TmpFs.html#newTempLibName"><span class="hs-identifier hs-var hs-var">newTempLibName</span></a></span></span><span> </span><span id="local-6989586621681622340"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622340"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681622341"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622341"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span> </span><span id="local-6989586621681622342"><span class="annot"><span class="annottext">TempDir
</span><a href="#local-6989586621681622342"><span class="hs-identifier hs-var">tmp_dir</span></a></span></span><span> </span><span id="local-6989586621681622343"><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622343"><span class="hs-identifier hs-var">lifetime</span></a></span></span><span> </span><span id="local-6989586621681622344"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622344"><span class="hs-identifier hs-var">extn</span></a></span></span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621681622345"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622345"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; TmpFs -&gt; TempDir -&gt; IO FilePath
</span><a href="GHC.Utils.TmpFs.html#getTempDir"><span class="hs-identifier hs-var">getTempDir</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622340"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622341"><span class="hs-identifier hs-var">tmpfs</span></a></span><span> </span><span class="annot"><span class="annottext">TempDir
</span><a href="#local-6989586621681622342"><span class="hs-identifier hs-var">tmp_dir</span></a></span><span>
</span><span id="line-313"></span><span>       </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; IO (FilePath, FilePath, FilePath)
</span><a href="#local-6989586621681622346"><span class="hs-identifier hs-var">findTempName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622345"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;ghc_&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-315"></span><span>    </span><span class="annot"><a href="#local-6989586621681622346"><span class="hs-identifier hs-type">findTempName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#String/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#String/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>    </span><span id="local-6989586621681622346"><span class="annot"><span class="annottext">findTempName :: FilePath -&gt; FilePath -&gt; IO (FilePath, FilePath, FilePath)
</span><a href="#local-6989586621681622346"><span class="hs-identifier hs-var hs-var">findTempName</span></a></span></span><span> </span><span id="local-6989586621681622347"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622347"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span id="local-6989586621681622348"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622348"><span class="hs-identifier hs-var">prefix</span></a></span></span><span>
</span><span id="line-317"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621681622349"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622349"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TmpFs -&gt; IO Int
</span><a href="GHC.Utils.TmpFs.html#newTempSuffix"><span class="hs-identifier hs-var">newTempSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622341"><span class="hs-identifier hs-var">tmpfs</span></a></span><span> </span><span class="hs-comment">-- See Note [Deterministic base name]</span><span>
</span><span id="line-318"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681622350"><span class="annot"><span class="annottext">libname :: FilePath
</span><a href="#local-6989586621681622350"><span class="hs-identifier hs-var hs-var">libname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622348"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../base-4.18.3.0/src/GHC.Show.html#show/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622349"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-319"></span><span>               </span><span id="local-6989586621681622351"><span class="annot"><span class="annottext">filename :: FilePath
</span><a href="#local-6989586621681622351"><span class="hs-identifier hs-var hs-var">filename</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622347"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../filepath-1.4.301.0/src/System.FilePath.Posix.html#%3C%2F%3E/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;lib&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622350"><span class="hs-identifier hs-var">libname</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../filepath-1.4.301.0/src/System.FilePath.Posix.html#%3C.%3E/System.FilePath.Posix.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622344"><span class="hs-identifier hs-var">extn</span></a></span><span>
</span><span id="line-320"></span><span>           </span><span id="local-6989586621681622352"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681622352"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO Bool
</span><a href="../../directory-1.3.8.5/src/System.Directory.html#doesFileExist/System.Directory.html#doesFileExist"><span class="hs-identifier hs-var">doesFileExist</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622351"><span class="hs-identifier hs-var">filename</span></a></span><span>
</span><span id="line-321"></span><span>           </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681622352"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; IO (FilePath, FilePath, FilePath)
</span><a href="#local-6989586621681622346"><span class="hs-identifier hs-var">findTempName</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622347"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622348"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-322"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- clean it up later</span><span>
</span><span id="line-323"></span><span>                        </span><span class="annot"><span class="annottext">TmpFs -&gt; TempFileLifetime -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#addFilesToClean"><span class="hs-identifier hs-var">addFilesToClean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622341"><span class="hs-identifier hs-var">tmpfs</span></a></span><span> </span><span class="annot"><span class="annottext">TempFileLifetime
</span><a href="#local-6989586621681622343"><span class="hs-identifier hs-var">lifetime</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622351"><span class="hs-identifier hs-var">filename</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-324"></span><span>                        </span><span class="annot"><span class="annottext">(FilePath, FilePath, FilePath) -&gt; IO (FilePath, FilePath, FilePath)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622351"><span class="hs-identifier hs-var">filename</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622347"><span class="hs-identifier hs-var">dir</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622350"><span class="hs-identifier hs-var">libname</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span class="hs-comment">-- Return our temporary directory within tmp_dir, creating one if we</span><span>
</span><span id="line-328"></span><span class="hs-comment">-- don't have one yet.</span><span>
</span><span id="line-329"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#getTempDir"><span class="hs-identifier hs-type">getTempDir</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TmpFs"><span class="hs-identifier hs-type">TmpFs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempDir"><span class="hs-identifier hs-type">TempDir</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-330"></span><span id="getTempDir"><span class="annot"><span class="annottext">getTempDir :: Logger -&gt; TmpFs -&gt; TempDir -&gt; IO FilePath
</span><a href="GHC.Utils.TmpFs.html#getTempDir"><span class="hs-identifier hs-var hs-var">getTempDir</span></a></span></span><span> </span><span id="local-6989586621681622353"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622353"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681622354"><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622354"><span class="hs-identifier hs-var">tmpfs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.TmpFs.html#TempDir"><span class="hs-identifier hs-type">TempDir</span></a></span><span> </span><span id="local-6989586621681622355"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622355"><span class="hs-identifier hs-var">tmp_dir</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-331"></span><span>    </span><span id="local-6989586621681622356"><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621681622356"><span class="hs-identifier hs-var">mapping</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Map FilePath FilePath) -&gt; IO (Map FilePath FilePath)
forall a. IORef a -&gt; IO a
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#readIORef/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map FilePath FilePath)
</span><a href="#local-6989586621681622357"><span class="hs-identifier hs-var">dir_ref</span></a></span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Map FilePath FilePath -&gt; Maybe FilePath
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../containers-0.6.7/src/Data.Map.Internal.html#lookup/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622355"><span class="hs-identifier hs-var">tmp_dir</span></a></span><span> </span><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621681622356"><span class="hs-identifier hs-var">mapping</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-333"></span><span>        </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-334"></span><span>            </span><span id="local-6989586621681622359"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622359"><span class="hs-identifier hs-var">pid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int
</span><a href="GHC.Utils.TmpFs.html#getProcessID"><span class="hs-identifier hs-var">getProcessID</span></a></span><span>
</span><span id="line-335"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681622361"><span class="annot"><span class="annottext">prefix :: FilePath
</span><a href="#local-6989586621681622361"><span class="hs-identifier hs-var hs-var">prefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622355"><span class="hs-identifier hs-var">tmp_dir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../filepath-1.4.301.0/src/System.FilePath.Posix.html#%3C%2F%3E/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;ghc&quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../base-4.18.3.0/src/GHC.Show.html#show/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622359"><span class="hs-identifier hs-var">pid</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;_&quot;</span></span><span>
</span><span id="line-336"></span><span>            </span><span class="annot"><span class="annottext">IO FilePath -&gt; IO FilePath
forall a. IO a -&gt; IO a
</span><a href="../../base-4.18.3.0/src/GHC.IO.html#mask_/GHC.IO.html#mask_"><span class="hs-identifier hs-var">mask_</span></a></span><span> </span><span class="annot"><span class="annottext">(IO FilePath -&gt; IO FilePath) -&gt; IO FilePath -&gt; IO FilePath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
</span><a href="#local-6989586621681622362"><span class="hs-identifier hs-var">mkTempDir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622361"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-337"></span><span>        </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681622363"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622363"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622363"><span class="hs-identifier hs-var">dir</span></a></span><span>
</span><span id="line-338"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-339"></span><span>    </span><span id="local-6989586621681622357"><span class="annot"><span class="annottext">dir_ref :: IORef (Map FilePath FilePath)
</span><a href="#local-6989586621681622357"><span class="hs-identifier hs-var hs-var">dir_ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TmpFs -&gt; IORef (Map FilePath FilePath)
</span><a href="GHC.Utils.TmpFs.html#tmp_dirs_to_clean"><span class="hs-identifier hs-var">tmp_dirs_to_clean</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622354"><span class="hs-identifier hs-var">tmpfs</span></a></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>    </span><span class="annot"><a href="#local-6989586621681622362"><span class="hs-identifier hs-type">mkTempDir</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-342"></span><span>    </span><span id="local-6989586621681622362"><span class="annot"><span class="annottext">mkTempDir :: FilePath -&gt; IO FilePath
</span><a href="#local-6989586621681622362"><span class="hs-identifier hs-var hs-var">mkTempDir</span></a></span></span><span> </span><span id="local-6989586621681622364"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622364"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-343"></span><span>        </span><span id="local-6989586621681622365"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622365"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TmpFs -&gt; IO Int
</span><a href="GHC.Utils.TmpFs.html#newTempSuffix"><span class="hs-identifier hs-var">newTempSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">TmpFs
</span><a href="#local-6989586621681622354"><span class="hs-identifier hs-var">tmpfs</span></a></span><span>
</span><span id="line-344"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681622366"><span class="annot"><span class="annottext">our_dir :: FilePath
</span><a href="#local-6989586621681622366"><span class="hs-identifier hs-var hs-var">our_dir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622364"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../base-4.18.3.0/src/GHC.Show.html#show/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622365"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span>        </span><span class="hs-comment">-- 1. Speculatively create our new directory.</span><span>
</span><span id="line-347"></span><span>        </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../directory-1.3.8.5/src/System.Directory.html#createDirectory/System.Directory.html#createDirectory"><span class="hs-identifier hs-var">createDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622366"><span class="hs-identifier hs-var">our_dir</span></a></span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span>        </span><span class="hs-comment">-- 2. Update the tmp_dirs_to_clean mapping unless an entry already exists</span><span>
</span><span id="line-350"></span><span>        </span><span class="hs-comment">-- (i.e. unless another thread beat us to it).</span><span>
</span><span id="line-351"></span><span>        </span><span id="local-6989586621681622367"><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621681622367"><span class="hs-identifier hs-var">their_dir</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Map FilePath FilePath)
-&gt; (Map FilePath FilePath
    -&gt; (Map FilePath FilePath, Maybe FilePath))
-&gt; IO (Maybe FilePath)
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="../../base-4.18.3.0/src/GHC.IORef.html#atomicModifyIORef%27/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map FilePath FilePath)
</span><a href="#local-6989586621681622357"><span class="hs-identifier hs-var">dir_ref</span></a></span><span> </span><span class="annot"><span class="annottext">((Map FilePath FilePath -&gt; (Map FilePath FilePath, Maybe FilePath))
 -&gt; IO (Maybe FilePath))
-&gt; (Map FilePath FilePath
    -&gt; (Map FilePath FilePath, Maybe FilePath))
-&gt; IO (Maybe FilePath)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681622368"><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621681622368"><span class="hs-identifier hs-var">mapping</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-352"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Map FilePath FilePath -&gt; Maybe FilePath
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../../containers-0.6.7/src/Data.Map.Internal.html#lookup/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622355"><span class="hs-identifier hs-var">tmp_dir</span></a></span><span> </span><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621681622368"><span class="hs-identifier hs-var">mapping</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-353"></span><span>                </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681622369"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622369"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621681622368"><span class="hs-identifier hs-var">mapping</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Maybe FilePath
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622369"><span class="hs-identifier hs-var">dir</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>                </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
-&gt; FilePath -&gt; Map FilePath FilePath -&gt; Map FilePath FilePath
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../../containers-0.6.7/src/Data.Map.Internal.html#insert/Data.Map.Internal.html#insert"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622355"><span class="hs-identifier hs-var">tmp_dir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622366"><span class="hs-identifier hs-var">our_dir</span></a></span><span> </span><span class="annot"><span class="annottext">Map FilePath FilePath
</span><a href="#local-6989586621681622368"><span class="hs-identifier hs-var">mapping</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span>        </span><span class="hs-comment">-- 3. If there was an existing entry, return it and delete the</span><span>
</span><span id="line-357"></span><span>        </span><span class="hs-comment">-- directory we created.  Otherwise return the directory we created.</span><span>
</span><span id="line-358"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621681622367"><span class="hs-identifier hs-var">their_dir</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-359"></span><span>            </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-360"></span><span>                </span><span class="annot"><span class="annottext">Logger -&gt; Int -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Error.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622353"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; IO ()) -&gt; SDoc -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-361"></span><span>                    </span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Created temporary directory:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622366"><span class="hs-identifier hs-var">our_dir</span></a></span><span>
</span><span id="line-362"></span><span>                </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622366"><span class="hs-identifier hs-var">our_dir</span></a></span><span>
</span><span id="line-363"></span><span>            </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681622371"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622371"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-364"></span><span>                </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../directory-1.3.8.5/src/System.Directory.html#removeDirectory/System.Directory.html#removeDirectory"><span class="hs-identifier hs-var">removeDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622366"><span class="hs-identifier hs-var">our_dir</span></a></span><span>
</span><span id="line-365"></span><span>                </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622371"><span class="hs-identifier hs-var">dir</span></a></span><span>
</span><span id="line-366"></span><span>      </span><span class="annot"><span class="annottext">IO FilePath -&gt; (IOException -&gt; IO FilePath) -&gt; IO FilePath
forall a. IO a -&gt; (IOException -&gt; IO a) -&gt; IO a
</span><a href="GHC.Utils.Exception.html#catchIO"><span class="hs-operator hs-var">`Exception.catchIO`</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681622373"><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621681622373"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">IOException -&gt; Bool
</span><a href="../../base-4.18.3.0/src/System.IO.Error.html#isAlreadyExistsError/System.IO.Error.html#isAlreadyExistsError"><span class="hs-identifier hs-var">isAlreadyExistsError</span></a></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621681622373"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-367"></span><span>                      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
</span><a href="#local-6989586621681622362"><span class="hs-identifier hs-var">mkTempDir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622364"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IOException -&gt; IO FilePath
forall a. IOException -&gt; IO a
</span><a href="../../base-4.18.3.0/src/GHC.IO.Exception.html#ioError/GHC.IO.Exception.html#ioError"><span class="hs-identifier hs-var">ioError</span></a></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621681622373"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span class="hs-comment">{- Note [Deterministic base name]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The filename of temporary files, especially the basename of C files, can end
up in the output in some form, e.g. as part of linker debug information. In the
interest of bit-wise exactly reproducible compilation (#4012), the basename of
the temporary file no longer contains random information (it used to contain
the process id).

This is ok, as the temporary directory used contains the pid (see getTempDir).
-}</span><span>
</span><span id="line-380"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#removeTmpDirs"><span class="hs-identifier hs-type">removeTmpDirs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-381"></span><span id="removeTmpDirs"><span class="annot"><span class="annottext">removeTmpDirs :: Logger -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#removeTmpDirs"><span class="hs-identifier hs-var hs-var">removeTmpDirs</span></a></span></span><span> </span><span id="local-6989586621681622374"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622374"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681622375"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622375"><span class="hs-identifier hs-var">ds</span></a></span></span><span>
</span><span id="line-382"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; FilePath -&gt; FilePath -&gt; IO () -&gt; IO ()
forall a. Logger -&gt; FilePath -&gt; FilePath -&gt; IO a -&gt; IO a
</span><a href="GHC.Utils.Error.html#traceCmd"><span class="hs-identifier hs-var">traceCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622374"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Deleting temp dirs&quot;</span></span><span>
</span><span id="line-383"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Deleting: &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; FilePath
</span><a href="../../base-4.18.3.0/src/Data.OldList.html#unwords/Data.OldList.html#unwords"><span class="hs-identifier hs-var">unwords</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622375"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FilePath -&gt; IO ()) -&gt; [FilePath] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#mapM_/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; (FilePath -&gt; IO ()) -&gt; FilePath -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#removeWith"><span class="hs-identifier hs-var">removeWith</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622374"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../directory-1.3.8.5/src/System.Directory.html#removeDirectory/System.Directory.html#removeDirectory"><span class="hs-identifier hs-var">removeDirectory</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622375"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>
</span><span id="line-386"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#removeTmpFiles"><span class="hs-identifier hs-type">removeTmpFiles</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-387"></span><span id="removeTmpFiles"><span class="annot"><span class="annottext">removeTmpFiles :: Logger -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#removeTmpFiles"><span class="hs-identifier hs-var hs-var">removeTmpFiles</span></a></span></span><span> </span><span id="local-6989586621681622380"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622380"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681622381"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622381"><span class="hs-identifier hs-var">fs</span></a></span></span><span>
</span><span id="line-388"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
</span><a href="#local-6989586621681622382"><span class="hs-identifier hs-var">warnNon</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-389"></span><span>    </span><span class="annot"><span class="annottext">Logger -&gt; FilePath -&gt; FilePath -&gt; IO () -&gt; IO ()
forall a. Logger -&gt; FilePath -&gt; FilePath -&gt; IO a -&gt; IO a
</span><a href="GHC.Utils.Error.html#traceCmd"><span class="hs-identifier hs-var">traceCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622380"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Deleting temp files&quot;</span></span><span>
</span><span id="line-390"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Deleting: &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; FilePath
</span><a href="../../base-4.18.3.0/src/Data.OldList.html#unwords/Data.OldList.html#unwords"><span class="hs-identifier hs-var">unwords</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622383"><span class="hs-identifier hs-var">deletees</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-391"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FilePath -&gt; IO ()) -&gt; [FilePath] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#mapM_/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; (FilePath -&gt; IO ()) -&gt; FilePath -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#removeWith"><span class="hs-identifier hs-var">removeWith</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622380"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../directory-1.3.8.5/src/System.Directory.html#removeFile/System.Directory.html#removeFile"><span class="hs-identifier hs-var">removeFile</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622383"><span class="hs-identifier hs-var">deletees</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-393"></span><span>     </span><span class="hs-comment">-- Flat out refuse to delete files that are likely to be source input</span><span>
</span><span id="line-394"></span><span>     </span><span class="hs-comment">-- files (is there a worse bug than having a compiler delete your source</span><span>
</span><span id="line-395"></span><span>     </span><span class="hs-comment">-- files?)</span><span>
</span><span id="line-396"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-397"></span><span>     </span><span class="hs-comment">-- Deleting source files is a sign of a bug elsewhere, so prominently flag</span><span>
</span><span id="line-398"></span><span>     </span><span class="hs-comment">-- the condition.</span><span>
</span><span id="line-399"></span><span>    </span><span id="local-6989586621681622382"><span class="annot"><span class="annottext">warnNon :: IO () -&gt; IO ()
</span><a href="#local-6989586621681622382"><span class="hs-identifier hs-var hs-var">warnNon</span></a></span></span><span> </span><span id="local-6989586621681622385"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621681622385"><span class="hs-identifier hs-var">act</span></a></span></span><span>
</span><span id="line-400"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622387"><span class="hs-identifier hs-var">non_deletees</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621681622385"><span class="hs-identifier hs-var">act</span></a></span><span>
</span><span id="line-401"></span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-402"></span><span>        </span><span class="annot"><span class="annottext">Logger -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Error.html#putMsg"><span class="hs-identifier hs-var">putMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622380"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;WARNING - NOT deleting source files:&quot;</span></span><span>
</span><span id="line-403"></span><span>                   </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsLine doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FilePath -&gt; SDoc) -&gt; [FilePath] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622387"><span class="hs-identifier hs-var">non_deletees</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-404"></span><span>        </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621681622385"><span class="hs-identifier hs-var">act</span></a></span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681622387"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622387"><span class="hs-identifier hs-var">non_deletees</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681622383"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622383"><span class="hs-identifier hs-var">deletees</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Bool) -&gt; [FilePath] -&gt; ([FilePath], [FilePath])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><a href="../../base-4.18.3.0/src/Data.OldList.html#partition/Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; Bool
</span><a href="GHC.Driver.Phases.html#isHaskellUserSrcFilename"><span class="hs-identifier hs-var">isHaskellUserSrcFilename</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622381"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#removeTmpSubdirs"><span class="hs-identifier hs-type">removeTmpSubdirs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span id="removeTmpSubdirs"><span class="annot"><span class="annottext">removeTmpSubdirs :: Logger -&gt; [FilePath] -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#removeTmpSubdirs"><span class="hs-identifier hs-var hs-var">removeTmpSubdirs</span></a></span></span><span> </span><span id="local-6989586621681622390"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622390"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681622391"><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622391"><span class="hs-identifier hs-var">fs</span></a></span></span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; FilePath -&gt; FilePath -&gt; IO () -&gt; IO ()
forall a. Logger -&gt; FilePath -&gt; FilePath -&gt; IO a -&gt; IO a
</span><a href="GHC.Utils.Error.html#traceCmd"><span class="hs-identifier hs-var">traceCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622390"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Deleting temp subdirs&quot;</span></span><span>
</span><span id="line-411"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Deleting: &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath] -&gt; FilePath
</span><a href="../../base-4.18.3.0/src/Data.OldList.html#unwords/Data.OldList.html#unwords"><span class="hs-identifier hs-var">unwords</span></a></span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622391"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FilePath -&gt; IO ()) -&gt; [FilePath] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#mapM_/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Logger -&gt; (FilePath -&gt; IO ()) -&gt; FilePath -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#removeWith"><span class="hs-identifier hs-var">removeWith</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622390"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../directory-1.3.8.5/src/System.Directory.html#removeDirectory/System.Directory.html#removeDirectory"><span class="hs-identifier hs-var">removeDirectory</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FilePath]
</span><a href="#local-6989586621681622391"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#removeWith"><span class="hs-identifier hs-type">removeWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Utils.Logger.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span id="removeWith"><span class="annot"><span class="annottext">removeWith :: Logger -&gt; (FilePath -&gt; IO ()) -&gt; FilePath -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#removeWith"><span class="hs-identifier hs-var hs-var">removeWith</span></a></span></span><span> </span><span id="local-6989586621681622392"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622392"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621681622393"><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="#local-6989586621681622393"><span class="hs-identifier hs-var">remover</span></a></span></span><span> </span><span id="local-6989586621681622394"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622394"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="#local-6989586621681622393"><span class="hs-identifier hs-var">remover</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622394"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; (IOException -&gt; IO ()) -&gt; IO ()
forall a. IO a -&gt; (IOException -&gt; IO a) -&gt; IO a
</span><a href="GHC.Utils.Exception.html#catchIO"><span class="hs-operator hs-var">`Exception.catchIO`</span></a></span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681622395"><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621681622395"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-417"></span><span>   </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681622396"><span class="annot"><span class="annottext">msg :: SDoc
</span><a href="#local-6989586621681622396"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">IOException -&gt; Bool
</span><a href="../../base-4.18.3.0/src/System.IO.Error.html#isDoesNotExistError/System.IO.Error.html#isDoesNotExistError"><span class="hs-identifier hs-var">isDoesNotExistError</span></a></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621681622395"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-418"></span><span>             </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Warning: deleting non-existent&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622394"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-419"></span><span>             </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;Warning: exception raised when deleting&quot;</span></span><span>
</span><span id="line-420"></span><span>                                            </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622394"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a></span><span>
</span><span id="line-421"></span><span>               </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; SDoc
forall doc. IsLine doc =&gt; FilePath -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IOException -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../base-4.18.3.0/src/GHC.Show.html#show/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621681622395"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Logger -&gt; Int -&gt; SDoc -&gt; IO ()
</span><a href="GHC.Utils.Error.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621681622392"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621681622396"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-special">)</span><span class="hs-cpp">

#if defined(mingw32_HOST_OS)
</span><span class="hs-comment">-- relies on Int == Int32 on Windows</span><span>
</span><span id="line-427"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;_getpid&quot;</span><span> </span><span class="hs-identifier">getProcessID</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Int</span><span class="hs-cpp">
#else
</span><span class="annot"><a href="GHC.Utils.TmpFs.html#getProcessID"><span class="hs-identifier hs-type">getProcessID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-430"></span><span id="getProcessID"><span class="annot"><span class="annottext">getProcessID :: IO Int
</span><a href="GHC.Utils.TmpFs.html#getProcessID"><span class="hs-identifier hs-var hs-var">getProcessID</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO CPid
</span><a href="../../base-4.18.3.0/src/System.Posix.Internals.html#c_getpid/System.Posix.Internals.html#c_getpid"><span class="hs-identifier hs-var">System.Posix.Internals.c_getpid</span></a></span><span> </span><span class="annot"><span class="annottext">IO CPid -&gt; (CPid -&gt; IO Int) -&gt; IO Int
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3E%3E%3D/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO Int
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IO Int) -&gt; (CPid -&gt; Int) -&gt; CPid -&gt; IO Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CPid -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Real.html#fromIntegral/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-433"></span><span class="hs-comment">-- The following three functions are from the `temporary` package.</span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span class="hs-comment">-- | Create and use a temporary directory in the system standard temporary</span><span>
</span><span id="line-436"></span><span class="hs-comment">-- directory.</span><span>
</span><span id="line-437"></span><span class="hs-comment">--</span><span>
</span><span id="line-438"></span><span class="hs-comment">-- Behaves exactly the same as 'withTempDirectory', except that the parent</span><span>
</span><span id="line-439"></span><span class="hs-comment">-- temporary directory will be that returned by 'getTemporaryDirectory'.</span><span>
</span><span id="line-440"></span><span id="local-6989586621681622036"><span class="annot"><a href="GHC.Utils.TmpFs.html#withSystemTempDirectory"><span class="hs-identifier hs-type">withSystemTempDirectory</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#String/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ Directory name template. See 'openTempFile'.</span></span><span>
</span><span id="line-441"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681622036"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ Callback that can use the directory</span></span><span>
</span><span id="line-442"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681622036"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-443"></span><span id="withSystemTempDirectory"><span class="annot"><span class="annottext">withSystemTempDirectory :: forall a. FilePath -&gt; (FilePath -&gt; IO a) -&gt; IO a
</span><a href="GHC.Utils.TmpFs.html#withSystemTempDirectory"><span class="hs-identifier hs-var hs-var">withSystemTempDirectory</span></a></span></span><span> </span><span id="local-6989586621681622405"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622405"><span class="hs-identifier hs-var">template</span></a></span></span><span> </span><span id="local-6989586621681622406"><span class="annot"><span class="annottext">FilePath -&gt; IO a
</span><a href="#local-6989586621681622406"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-444"></span><span>  </span><span class="annot"><span class="annottext">IO FilePath
</span><a href="../../directory-1.3.8.5/src/System.Directory.html#getTemporaryDirectory/System.Directory.html#getTemporaryDirectory"><span class="hs-identifier hs-var">getTemporaryDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">IO FilePath -&gt; (FilePath -&gt; IO a) -&gt; IO a
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3E%3E%3D/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681622407"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622407"><span class="hs-identifier hs-var">tmpDir</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; (FilePath -&gt; IO a) -&gt; IO a
forall a. FilePath -&gt; FilePath -&gt; (FilePath -&gt; IO a) -&gt; IO a
</span><a href="GHC.Utils.TmpFs.html#withTempDirectory"><span class="hs-identifier hs-var">withTempDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622407"><span class="hs-identifier hs-var">tmpDir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622405"><span class="hs-identifier hs-var">template</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO a
</span><a href="#local-6989586621681622406"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span class="hs-comment">-- | Create and use a temporary directory.</span><span>
</span><span id="line-448"></span><span class="hs-comment">--</span><span>
</span><span id="line-449"></span><span class="hs-comment">-- Creates a new temporary directory inside the given directory, making use</span><span>
</span><span id="line-450"></span><span class="hs-comment">-- of the template. The temp directory is deleted after use. For example:</span><span>
</span><span id="line-451"></span><span class="hs-comment">--</span><span>
</span><span id="line-452"></span><span class="hs-comment">-- &gt; withTempDirectory &quot;src&quot; &quot;sdist.&quot; $ \tmpDir -&gt; do ...</span><span>
</span><span id="line-453"></span><span class="hs-comment">--</span><span>
</span><span id="line-454"></span><span class="hs-comment">-- The @tmpDir@ will be a new subdirectory of the given directory, e.g.</span><span>
</span><span id="line-455"></span><span class="hs-comment">-- @src/sdist.342@.</span><span>
</span><span id="line-456"></span><span id="local-6989586621681622038"><span class="annot"><a href="GHC.Utils.TmpFs.html#withTempDirectory"><span class="hs-identifier hs-type">withTempDirectory</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Temp directory to create the directory in</span></span><span>
</span><span id="line-457"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#String/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ Directory name template. See 'openTempFile'.</span></span><span>
</span><span id="line-458"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681622038"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ Callback that can use the directory</span></span><span>
</span><span id="line-459"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681622038"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-460"></span><span id="withTempDirectory"><span class="annot"><span class="annottext">withTempDirectory :: forall a. FilePath -&gt; FilePath -&gt; (FilePath -&gt; IO a) -&gt; IO a
</span><a href="GHC.Utils.TmpFs.html#withTempDirectory"><span class="hs-identifier hs-var hs-var">withTempDirectory</span></a></span></span><span> </span><span id="local-6989586621681622408"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622408"><span class="hs-identifier hs-var">targetDir</span></a></span></span><span> </span><span id="local-6989586621681622409"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622409"><span class="hs-identifier hs-var">template</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-461"></span><span>  </span><span class="annot"><span class="annottext">IO FilePath -&gt; (FilePath -&gt; IO ()) -&gt; (FilePath -&gt; IO a) -&gt; IO a
forall a b c. IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><a href="../../base-4.18.3.0/src/Control.Exception.Base.html#bracket/Control.Exception.Base.html#bracket"><span class="hs-identifier hs-var">Exception.bracket</span></a></span><span>
</span><span id="line-462"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; FilePath -&gt; IO FilePath
</span><a href="GHC.Utils.TmpFs.html#createTempDirectory"><span class="hs-identifier hs-var">createTempDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622408"><span class="hs-identifier hs-var">targetDir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622409"><span class="hs-identifier hs-var">template</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#ignoringIOErrors"><span class="hs-identifier hs-var">ignoringIOErrors</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; (FilePath -&gt; IO ()) -&gt; FilePath -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../directory-1.3.8.5/src/System.Directory.html#removeDirectoryRecursive/System.Directory.html#removeDirectoryRecursive"><span class="hs-identifier hs-var">removeDirectoryRecursive</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>
</span><span id="line-465"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#ignoringIOErrors"><span class="hs-identifier hs-type">ignoringIOErrors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-466"></span><span id="ignoringIOErrors"><span class="annot"><span class="annottext">ignoringIOErrors :: IO () -&gt; IO ()
</span><a href="GHC.Utils.TmpFs.html#ignoringIOErrors"><span class="hs-identifier hs-var hs-var">ignoringIOErrors</span></a></span></span><span> </span><span id="local-6989586621681622414"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621681622414"><span class="hs-identifier hs-var">ioe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621681622414"><span class="hs-identifier hs-var">ioe</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; (IOException -&gt; IO ()) -&gt; IO ()
forall a. IO a -&gt; (IOException -&gt; IO a) -&gt; IO a
</span><a href="GHC.Utils.Exception.html#catchIO"><span class="hs-operator hs-var">`Exception.catchIO`</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IOException -&gt; IO ()
forall a b. a -&gt; b -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#const/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span class="annot"><a href="GHC.Utils.TmpFs.html#createTempDirectory"><span class="hs-identifier hs-type">createTempDirectory</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#String/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.IO.html#FilePath/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-470"></span><span id="createTempDirectory"><span class="annot"><span class="annottext">createTempDirectory :: FilePath -&gt; FilePath -&gt; IO FilePath
</span><a href="GHC.Utils.TmpFs.html#createTempDirectory"><span class="hs-identifier hs-var hs-var">createTempDirectory</span></a></span></span><span> </span><span id="local-6989586621681622416"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622416"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span id="local-6989586621681622417"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622417"><span class="hs-identifier hs-var">template</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-471"></span><span>  </span><span id="local-6989586621681622418"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622418"><span class="hs-identifier hs-var">pid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int
</span><a href="GHC.Utils.TmpFs.html#getProcessID"><span class="hs-identifier hs-var">getProcessID</span></a></span><span>
</span><span id="line-472"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; IO FilePath
</span><a href="#local-6989586621681622419"><span class="hs-identifier hs-var">findTempName</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622418"><span class="hs-identifier hs-var">pid</span></a></span><span>
</span><span id="line-473"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681622419"><span class="annot"><span class="annottext">findTempName :: Int -&gt; IO FilePath
</span><a href="#local-6989586621681622419"><span class="hs-identifier hs-var hs-var">findTempName</span></a></span></span><span> </span><span id="local-6989586621681622420"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622420"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-474"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681622421"><span class="annot"><span class="annottext">path :: FilePath
</span><a href="#local-6989586621681622421"><span class="hs-identifier hs-var hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622416"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
</span><a href="../../filepath-1.4.301.0/src/System.FilePath.Posix.html#%3C%2F%3E/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622417"><span class="hs-identifier hs-var">template</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../base-4.18.3.0/src/GHC.Show.html#show/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622420"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-475"></span><span>            </span><span class="annot"><span class="annottext">FilePath -&gt; IO ()
</span><a href="../../directory-1.3.8.5/src/System.Directory.html#createDirectory/System.Directory.html#createDirectory"><span class="hs-identifier hs-var">createDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622421"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-476"></span><span>            </span><span class="annot"><span class="annottext">FilePath -&gt; IO FilePath
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621681622421"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-477"></span><span>          </span><span class="annot"><span class="annottext">IO FilePath -&gt; (IOException -&gt; IO FilePath) -&gt; IO FilePath
forall a. IO a -&gt; (IOException -&gt; IO a) -&gt; IO a
</span><a href="GHC.Utils.Exception.html#catchIO"><span class="hs-operator hs-var">`Exception.catchIO`</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681622422"><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621681622422"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">IOException -&gt; Bool
</span><a href="../../base-4.18.3.0/src/System.IO.Error.html#isAlreadyExistsError/System.IO.Error.html#isAlreadyExistsError"><span class="hs-identifier hs-var">isAlreadyExistsError</span></a></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621681622422"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-478"></span><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO FilePath
</span><a href="#local-6989586621681622419"><span class="hs-identifier hs-var">findTempName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681622420"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#%2B/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IOException -&gt; IO FilePath
forall a. IOException -&gt; IO a
</span><a href="../../base-4.18.3.0/src/GHC.IO.Exception.html#ioError/GHC.IO.Exception.html#ioError"><span class="hs-identifier hs-var">ioError</span></a></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621681622422"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-479"></span></pre></body></html>