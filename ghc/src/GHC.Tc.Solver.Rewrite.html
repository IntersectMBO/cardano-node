<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns  #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveFunctor #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Tc.Solver.Rewrite</span><span class="hs-special">(</span><span>
</span><span id="line-6"></span><span>   </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite"><span class="hs-identifier">rewrite</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewriteForErrors"><span class="hs-identifier">rewriteForErrors</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewriteArgsNom"><span class="hs-identifier">rewriteArgsNom</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>   </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewriteType"><span class="hs-identifier">rewriteType</span></a></span><span>
</span><span id="line-8"></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html"><span class="hs-identifier">GHC.Core.TyCo.Ppr</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html#pprTyVar"><span class="hs-identifier">pprTyVar</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html"><span class="hs-identifier">GHC.Tc.Types</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcGblEnv"><span class="hs-identifier">TcGblEnv</span></a></span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#tcg_tc_plugin_rewriters"><span class="hs-identifier">tcg_tc_plugin_rewriters</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>                      </span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginRewriter"><span class="hs-identifier">TcPluginRewriter</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginRewriteResult"><span class="hs-identifier">TcPluginRewriteResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>                      </span><span class="annot"><a href="GHC.Tc.Types.html#RewriteEnv"><span class="hs-identifier">RewriteEnv</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>                      </span><span class="annot"><a href="GHC.Tc.Types.html#runTcPluginM"><span class="hs-identifier">runTcPluginM</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html"><span class="hs-identifier">GHC.Tc.Types.Constraint</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html"><span class="hs-identifier">GHC.Tc.Utils.TcType</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Evidence.html"><span class="hs-identifier">GHC.Tc.Types.Evidence</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html"><span class="hs-identifier">GHC.Core.TyCo.Rep</span></a></span><span>   </span><span class="hs-comment">-- performs delicate algorithm on types</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Coercion.html"><span class="hs-identifier">GHC.Core.Coercion</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html"><span class="hs-identifier">GHC.Core.Reduction</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html"><span class="hs-identifier">GHC.Types.Unique.FM</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Set.html"><span class="hs-identifier">GHC.Types.Var.Set</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html"><span class="hs-identifier">GHC.Driver.Session</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html"><span class="hs-identifier">GHC.Utils.Panic.Plain</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html"><span class="hs-identifier">GHC.Tc.Solver.Monad</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TcS</span></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Exts.html#/GHC.Exts.html"><span class="hs-identifier">GHC.Exts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">oneShot</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Control.Monad.html#/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Control.Applicative.html#/Control.Applicative.html"><span class="hs-identifier">Control.Applicative</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#liftA3/GHC.Base.html#liftA3"><span class="hs-identifier">liftA3</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Builtin.Types.Prim.html#tYPETyCon"><span class="hs-identifier">tYPETyCon</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.List.html#/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Foldable.html#find/Data.Foldable.html#find"><span class="hs-identifier">find</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.List.Infinite.html"><span class="hs-identifier">GHC.Data.List.Infinite</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.List.Infinite.html#Infinite"><span class="hs-identifier">Infinite</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="GHC.Data.List.Infinite.html"><span class="hs-identifier">GHC.Data.List.Infinite</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Inf</span></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
*                RewriteEnv &amp; RewriteM
*             The rewriting environment &amp; monad
*                                                                      *
************************************************************************
-}</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="annot"><span class="hs-comment">-- | The 'RewriteM' monad is a wrapper around 'TcS' with a 'RewriteEnv'</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">newtype</span><span> </span><span id="RewriteM"><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-var">RewriteM</span></a></span></span><span> </span><span id="local-6989586621682006114"><span class="annot"><a href="#local-6989586621682006114"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="RewriteM"><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-var">RewriteM</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="runRewriteM"><span class="annot"><span class="annottext">forall a. RewriteM a -&gt; RewriteEnv -&gt; TcS a
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewriteM"><span class="hs-identifier hs-var hs-var">runRewriteM</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RewriteEnv"><span class="hs-identifier hs-type">RewriteEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006114"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682006487"><span id="local-6989586621682006490"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; RewriteM a -&gt; RewriteM b)
-&gt; (forall a b. a -&gt; RewriteM b -&gt; RewriteM a) -&gt; Functor RewriteM
forall a b. a -&gt; RewriteM b -&gt; RewriteM a
forall a b. (a -&gt; b) -&gt; RewriteM a -&gt; RewriteM b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
$cfmap :: forall a b. (a -&gt; b) -&gt; RewriteM a -&gt; RewriteM b
fmap :: forall a b. (a -&gt; b) -&gt; RewriteM a -&gt; RewriteM b
$c&lt;$ :: forall a b. a -&gt; RewriteM b -&gt; RewriteM a
&lt;$ :: forall a b. a -&gt; RewriteM b -&gt; RewriteM a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#Functor/GHC.Base.html#Functor"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-comment">-- | Smart constructor for 'RewriteM', as describe in Note [The one-shot state</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- monad trick] in &quot;GHC.Utils.Monad&quot;.</span><span>
</span><span id="line-62"></span><span id="local-6989586621682006122"><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#mkRewriteM"><span class="hs-identifier hs-type">mkRewriteM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#RewriteEnv"><span class="hs-identifier hs-type">RewriteEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006122"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006122"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-63"></span><span id="mkRewriteM"><span class="annot"><span class="annottext">mkRewriteM :: forall a. (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#mkRewriteM"><span class="hs-identifier hs-var hs-var">mkRewriteM</span></a></span></span><span> </span><span id="local-6989586621682006494"><span class="annot"><span class="annottext">RewriteEnv -&gt; TcS a
</span><a href="#local-6989586621682006494"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewriteEnv -&gt; TcS a) -&gt; RewriteM a
forall a. (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-var">RewriteM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RewriteEnv -&gt; TcS a) -&gt; RewriteEnv -&gt; TcS a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-identifier hs-var">oneShot</span></span><span> </span><span class="annot"><span class="annottext">RewriteEnv -&gt; TcS a
</span><a href="#local-6989586621682006494"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#mkRewriteM"><span class="hs-pragma hs-type">mkRewriteM</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682006499"><span id="local-6989586621682006502"><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#Monad/GHC.Base.html#Monad"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-67"></span><span>  </span><span id="local-6989586621682006506"><span class="annot"><span class="annottext">RewriteM a
</span><a href="#local-6989586621682006506"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621682006507"><span class="annot"><span class="annottext">&gt;&gt;= :: forall a b. RewriteM a -&gt; (a -&gt; RewriteM b) -&gt; RewriteM b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3E%3E%3D/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var hs-var hs-var hs-var">&gt;&gt;=</span></a></span></span><span> </span><span id="local-6989586621682006508"><span class="annot"><span class="annottext">a -&gt; RewriteM b
</span><a href="#local-6989586621682006508"><span class="hs-identifier hs-var">k</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewriteEnv -&gt; TcS b) -&gt; RewriteM b
forall a. (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#mkRewriteM"><span class="hs-identifier hs-var">mkRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">((RewriteEnv -&gt; TcS b) -&gt; RewriteM b)
-&gt; (RewriteEnv -&gt; TcS b) -&gt; RewriteM b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682006509"><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006509"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-68"></span><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006510"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682006510"><span class="hs-identifier hs-var">a</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM a -&gt; RewriteEnv -&gt; TcS a
forall a. RewriteM a -&gt; RewriteEnv -&gt; TcS a
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewriteM"><span class="hs-identifier hs-var">runRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteM a
</span><a href="#local-6989586621682006506"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006509"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-69"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">RewriteM b -&gt; RewriteEnv -&gt; TcS b
forall a. RewriteM a -&gt; RewriteEnv -&gt; TcS a
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewriteM"><span class="hs-identifier hs-var">runRewriteM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; RewriteM b
</span><a href="#local-6989586621682006508"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682006510"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006509"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621682006516"><span id="local-6989586621682006519"><span id="local-6989586621682006522"><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#Applicative/GHC.Base.html#Applicative"><span class="hs-identifier hs-type">Applicative</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-72"></span><span>  </span><span id="local-6989586621682006526"><span class="annot"><span class="annottext">pure :: forall a. a -&gt; RewriteM a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var hs-var hs-var hs-var">pure</span></a></span></span><span> </span><span id="local-6989586621682006527"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682006527"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewriteEnv -&gt; TcS a) -&gt; RewriteM a
forall a. (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#mkRewriteM"><span class="hs-identifier hs-var">mkRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">((RewriteEnv -&gt; TcS a) -&gt; RewriteM a)
-&gt; (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">RewriteEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; TcS a
forall a. a -&gt; TcS a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682006527"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-73"></span><span>  </span><span id="local-6989586621682006529"><span class="annot"><span class="annottext">&lt;*&gt; :: forall a b. RewriteM (a -&gt; b) -&gt; RewriteM a -&gt; RewriteM b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%3C%2A%3E/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var hs-var hs-var hs-var">(&lt;*&gt;)</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriteM (a -&gt; b) -&gt; RewriteM a -&gt; RewriteM b
forall (m :: * -&gt; *) a b. Monad m =&gt; m (a -&gt; b) -&gt; m a -&gt; m b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#ap/GHC.Base.html#ap"><span class="hs-identifier hs-var">ap</span></a></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#HasDynFlags"><span class="hs-identifier hs-type">HasDynFlags</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-76"></span><span>  </span><span id="local-6989586621682006536"><span class="annot"><span class="annottext">getDynFlags :: RewriteM DynFlags
</span><a href="#local-6989586621682006536"><span class="hs-identifier hs-var hs-var hs-var hs-var">getDynFlags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcS DynFlags -&gt; RewriteM DynFlags
forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var">liftTcS</span></a></span><span> </span><span class="annot"><span class="annottext">TcS DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.Session.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span id="local-6989586621682006159"><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-type">liftTcS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006159"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006159"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-79"></span><span id="liftTcS"><span class="annot"><span class="annottext">liftTcS :: forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var hs-var">liftTcS</span></a></span></span><span> </span><span id="local-6989586621682006539"><span class="annot"><span class="annottext">TcS a
</span><a href="#local-6989586621682006539"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewriteEnv -&gt; TcS a) -&gt; RewriteM a
forall a. (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#mkRewriteM"><span class="hs-identifier hs-var">mkRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">((RewriteEnv -&gt; TcS a) -&gt; RewriteM a)
-&gt; (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">RewriteEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcS a
</span><a href="#local-6989586621682006539"><span class="hs-identifier hs-var">thing_inside</span></a></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- convenient wrapper when you have a CtEvidence describing</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- the rewriting operation</span><span>
</span><span id="line-84"></span><span id="local-6989586621682006161"><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#runRewriteCtEv"><span class="hs-identifier hs-type">runRewriteCtEv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006161"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682006161"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-85"></span><span id="runRewriteCtEv"><span class="annot"><span class="annottext">runRewriteCtEv :: forall a. CtEvidence -&gt; RewriteM a -&gt; TcS (a, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewriteCtEv"><span class="hs-identifier hs-var hs-var">runRewriteCtEv</span></a></span></span><span> </span><span id="local-6989586621682006541"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006541"><span class="hs-identifier hs-var">ev</span></a></span></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; CtFlavour -&gt; EqRel -&gt; RewriteM a -&gt; TcS (a, RewriterSet)
forall a.
CtLoc -&gt; CtFlavour -&gt; EqRel -&gt; RewriteM a -&gt; TcS (a, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewrite"><span class="hs-identifier hs-var">runRewrite</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006541"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#ctEvFlavour"><span class="hs-identifier hs-var">ctEvFlavour</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006541"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#ctEvEqRel"><span class="hs-identifier hs-var">ctEvEqRel</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006541"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-comment">-- Run thing_inside (which does the rewriting)</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- Also returns the set of Wanteds which rewrote a Wanted;</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- See Note [Wanteds rewrite Wanteds] in GHC.Tc.Types.Constraint</span><span>
</span><span id="line-91"></span><span id="local-6989586621682006165"><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#runRewrite"><span class="hs-identifier hs-type">runRewrite</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtFlavour"><span class="hs-identifier hs-type">CtFlavour</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006165"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621682006165"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-92"></span><span id="runRewrite"><span class="annot"><span class="annottext">runRewrite :: forall a.
CtLoc -&gt; CtFlavour -&gt; EqRel -&gt; RewriteM a -&gt; TcS (a, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewrite"><span class="hs-identifier hs-var hs-var">runRewrite</span></a></span></span><span> </span><span id="local-6989586621682006550"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621682006550"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621682006551"><span class="annot"><span class="annottext">CtFlavour
</span><a href="#local-6989586621682006551"><span class="hs-identifier hs-var">flav</span></a></span></span><span> </span><span id="local-6989586621682006552"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006552"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span id="local-6989586621682006553"><span class="annot"><span class="annottext">RewriteM a
</span><a href="#local-6989586621682006553"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006554"><span class="annot"><span class="annottext">TcRef RewriterSet
</span><a href="#local-6989586621682006554"><span class="hs-identifier hs-var">rewriters_ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriterSet -&gt; TcS (TcRef RewriterSet)
forall a. a -&gt; TcS (TcRef a)
</span><a href="GHC.Tc.Solver.Monad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a></span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#emptyRewriterSet"><span class="hs-identifier hs-var">emptyRewriterSet</span></a></span><span>
</span><span id="line-94"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682006557"><span class="annot"><span class="annottext">fmode :: RewriteEnv
</span><a href="#local-6989586621682006557"><span class="hs-identifier hs-var hs-var">fmode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RE"><span class="hs-identifier hs-type">RE</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">re_loc :: CtLoc
</span><a href="GHC.Tc.Types.html#re_loc"><span class="hs-identifier hs-var">re_loc</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621682006550"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-95"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">re_flavour :: CtFlavour
</span><a href="GHC.Tc.Types.html#re_flavour"><span class="hs-identifier hs-var">re_flavour</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtFlavour
</span><a href="#local-6989586621682006551"><span class="hs-identifier hs-var">flav</span></a></span><span>
</span><span id="line-96"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">re_eq_rel :: EqRel
</span><a href="GHC.Tc.Types.html#re_eq_rel"><span class="hs-identifier hs-var">re_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006552"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-97"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">re_rewriters :: TcRef RewriterSet
</span><a href="GHC.Tc.Types.html#re_rewriters"><span class="hs-identifier hs-var">re_rewriters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcRef RewriterSet
</span><a href="#local-6989586621682006554"><span class="hs-identifier hs-var">rewriters_ref</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-98"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006563"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682006563"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM a -&gt; RewriteEnv -&gt; TcS a
forall a. RewriteM a -&gt; RewriteEnv -&gt; TcS a
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewriteM"><span class="hs-identifier hs-var">runRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteM a
</span><a href="#local-6989586621682006553"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006557"><span class="hs-identifier hs-var">fmode</span></a></span><span>
</span><span id="line-99"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006564"><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621682006564"><span class="hs-identifier hs-var">rewriters</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcRef RewriterSet -&gt; TcS RewriterSet
forall a. TcRef a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a></span><span> </span><span class="annot"><span class="annottext">TcRef RewriterSet
</span><a href="#local-6989586621682006554"><span class="hs-identifier hs-var">rewriters_ref</span></a></span><span>
</span><span id="line-100"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(a, RewriterSet) -&gt; TcS (a, RewriterSet)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621682006563"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621682006564"><span class="hs-identifier hs-var">rewriters</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#traceRewriteM"><span class="hs-identifier hs-type">traceRewriteM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Base.html#String/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span id="traceRewriteM"><span class="annot"><span class="annottext">traceRewriteM :: String -&gt; SDoc -&gt; RewriteM ()
</span><a href="GHC.Tc.Solver.Rewrite.html#traceRewriteM"><span class="hs-identifier hs-var hs-var">traceRewriteM</span></a></span></span><span> </span><span id="local-6989586621682006567"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682006567"><span class="hs-identifier hs-var">herald</span></a></span></span><span> </span><span id="local-6989586621682006568"><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682006568"><span class="hs-identifier hs-var">doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcS () -&gt; RewriteM ()
forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var">liftTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS () -&gt; RewriteM ()) -&gt; TcS () -&gt; RewriteM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621682006567"><span class="hs-identifier hs-var">herald</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621682006568"><span class="hs-identifier hs-var">doc</span></a></span><span>
</span><span id="line-104"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#traceRewriteM"><span class="hs-pragma hs-type">traceRewriteM</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>  </span><span class="hs-comment">-- see Note [INLINE conditional tracing utilities]</span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#getRewriteEnv"><span class="hs-identifier hs-type">getRewriteEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RewriteEnv"><span class="hs-identifier hs-type">RewriteEnv</span></a></span><span>
</span><span id="line-107"></span><span id="getRewriteEnv"><span class="annot"><span class="annottext">getRewriteEnv :: RewriteM RewriteEnv
</span><a href="GHC.Tc.Solver.Rewrite.html#getRewriteEnv"><span class="hs-identifier hs-var hs-var">getRewriteEnv</span></a></span></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewriteEnv -&gt; TcS RewriteEnv) -&gt; RewriteM RewriteEnv
forall a. (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#mkRewriteM"><span class="hs-identifier hs-var">mkRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">((RewriteEnv -&gt; TcS RewriteEnv) -&gt; RewriteM RewriteEnv)
-&gt; (RewriteEnv -&gt; TcS RewriteEnv) -&gt; RewriteM RewriteEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682006571"><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006571"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RewriteEnv -&gt; TcS RewriteEnv
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006571"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span id="local-6989586621682006170"><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#getRewriteEnvField"><span class="hs-identifier hs-type">getRewriteEnvField</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#RewriteEnv"><span class="hs-identifier hs-type">RewriteEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621682006170"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006170"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-111"></span><span id="getRewriteEnvField"><span class="annot"><span class="annottext">getRewriteEnvField :: forall a. (RewriteEnv -&gt; a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#getRewriteEnvField"><span class="hs-identifier hs-var hs-var">getRewriteEnvField</span></a></span></span><span> </span><span id="local-6989586621682006574"><span class="annot"><span class="annottext">RewriteEnv -&gt; a
</span><a href="#local-6989586621682006574"><span class="hs-identifier hs-var">accessor</span></a></span></span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewriteEnv -&gt; TcS a) -&gt; RewriteM a
forall a. (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#mkRewriteM"><span class="hs-identifier hs-var">mkRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">((RewriteEnv -&gt; TcS a) -&gt; RewriteM a)
-&gt; (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682006575"><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006575"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; TcS a
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewriteEnv -&gt; a
</span><a href="#local-6989586621682006574"><span class="hs-identifier hs-var">accessor</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006575"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#getEqRel"><span class="hs-identifier hs-type">getEqRel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span>
</span><span id="line-115"></span><span id="getEqRel"><span class="annot"><span class="annottext">getEqRel :: RewriteM EqRel
</span><a href="GHC.Tc.Solver.Rewrite.html#getEqRel"><span class="hs-identifier hs-var hs-var">getEqRel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewriteEnv -&gt; EqRel) -&gt; RewriteM EqRel
forall a. (RewriteEnv -&gt; a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#getRewriteEnvField"><span class="hs-identifier hs-var">getRewriteEnvField</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv -&gt; EqRel
</span><a href="GHC.Tc.Types.html#re_eq_rel"><span class="hs-identifier hs-var">re_eq_rel</span></a></span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#getRole"><span class="hs-identifier hs-type">getRole</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>
</span><span id="line-118"></span><span id="getRole"><span class="annot"><span class="annottext">getRole :: RewriteM Role
</span><a href="GHC.Tc.Solver.Rewrite.html#getRole"><span class="hs-identifier hs-var hs-var">getRole</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">(EqRel -&gt; Role) -&gt; RewriteM EqRel -&gt; RewriteM Role
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteM EqRel
</span><a href="GHC.Tc.Solver.Rewrite.html#getEqRel"><span class="hs-identifier hs-var">getEqRel</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#getFlavour"><span class="hs-identifier hs-type">getFlavour</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtFlavour"><span class="hs-identifier hs-type">CtFlavour</span></a></span><span>
</span><span id="line-121"></span><span id="getFlavour"><span class="annot"><span class="annottext">getFlavour :: RewriteM CtFlavour
</span><a href="GHC.Tc.Solver.Rewrite.html#getFlavour"><span class="hs-identifier hs-var hs-var">getFlavour</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewriteEnv -&gt; CtFlavour) -&gt; RewriteM CtFlavour
forall a. (RewriteEnv -&gt; a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#getRewriteEnvField"><span class="hs-identifier hs-var">getRewriteEnvField</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv -&gt; CtFlavour
</span><a href="GHC.Tc.Types.html#re_flavour"><span class="hs-identifier hs-var">re_flavour</span></a></span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#getFlavourRole"><span class="hs-identifier hs-type">getFlavourRole</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtFlavourRole"><span class="hs-identifier hs-type">CtFlavourRole</span></a></span><span>
</span><span id="line-124"></span><span id="getFlavourRole"><span class="annot"><span class="annottext">getFlavourRole :: RewriteM CtFlavourRole
</span><a href="GHC.Tc.Solver.Rewrite.html#getFlavourRole"><span class="hs-identifier hs-var hs-var">getFlavourRole</span></a></span></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006582"><span class="annot"><span class="annottext">CtFlavour
</span><a href="#local-6989586621682006582"><span class="hs-identifier hs-var">flavour</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM CtFlavour
</span><a href="GHC.Tc.Solver.Rewrite.html#getFlavour"><span class="hs-identifier hs-var">getFlavour</span></a></span><span>
</span><span id="line-126"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006583"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006583"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM EqRel
</span><a href="GHC.Tc.Solver.Rewrite.html#getEqRel"><span class="hs-identifier hs-var">getEqRel</span></a></span><span>
</span><span id="line-127"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">CtFlavourRole -&gt; RewriteM CtFlavourRole
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtFlavour
</span><a href="#local-6989586621682006582"><span class="hs-identifier hs-var">flavour</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006583"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#getLoc"><span class="hs-identifier hs-type">getLoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span>
</span><span id="line-130"></span><span id="getLoc"><span class="annot"><span class="annottext">getLoc :: RewriteM CtLoc
</span><a href="GHC.Tc.Solver.Rewrite.html#getLoc"><span class="hs-identifier hs-var hs-var">getLoc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewriteEnv -&gt; CtLoc) -&gt; RewriteM CtLoc
forall a. (RewriteEnv -&gt; a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#getRewriteEnvField"><span class="hs-identifier hs-var">getRewriteEnvField</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv -&gt; CtLoc
</span><a href="GHC.Tc.Types.html#re_loc"><span class="hs-identifier hs-var">re_loc</span></a></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#checkStackDepth"><span class="hs-identifier hs-type">checkStackDepth</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span id="checkStackDepth"><span class="annot"><span class="annottext">checkStackDepth :: Xi -&gt; RewriteM ()
</span><a href="GHC.Tc.Solver.Rewrite.html#checkStackDepth"><span class="hs-identifier hs-var hs-var">checkStackDepth</span></a></span></span><span> </span><span id="local-6989586621682006587"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006587"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006588"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621682006588"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM CtLoc
</span><a href="GHC.Tc.Solver.Rewrite.html#getLoc"><span class="hs-identifier hs-var">getLoc</span></a></span><span>
</span><span id="line-135"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcS () -&gt; RewriteM ()
forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var">liftTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS () -&gt; RewriteM ()) -&gt; TcS () -&gt; RewriteM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc -&gt; Xi -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#checkReductionDepth"><span class="hs-identifier hs-var">checkReductionDepth</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621682006588"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006587"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="annot"><span class="hs-comment">-- | Change the 'EqRel' in a 'RewriteM'.</span></span><span>
</span><span id="line-138"></span><span id="local-6989586621682006177"><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#setEqRel"><span class="hs-identifier hs-type">setEqRel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006177"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006177"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-139"></span><span id="setEqRel"><span class="annot"><span class="annottext">setEqRel :: forall a. EqRel -&gt; RewriteM a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#setEqRel"><span class="hs-identifier hs-var hs-var">setEqRel</span></a></span></span><span> </span><span id="local-6989586621682006592"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006592"><span class="hs-identifier hs-var">new_eq_rel</span></a></span></span><span> </span><span id="local-6989586621682006593"><span class="annot"><span class="annottext">RewriteM a
</span><a href="#local-6989586621682006593"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewriteEnv -&gt; TcS a) -&gt; RewriteM a
forall a. (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#mkRewriteM"><span class="hs-identifier hs-var">mkRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">((RewriteEnv -&gt; TcS a) -&gt; RewriteM a)
-&gt; (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682006594"><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006594"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006592"><span class="hs-identifier hs-var">new_eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; EqRel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RewriteEnv -&gt; EqRel
</span><a href="GHC.Tc.Types.html#re_eq_rel"><span class="hs-identifier hs-var">re_eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006594"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">RewriteM a -&gt; RewriteEnv -&gt; TcS a
forall a. RewriteM a -&gt; RewriteEnv -&gt; TcS a
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewriteM"><span class="hs-identifier hs-var">runRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteM a
</span><a href="#local-6989586621682006593"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006594"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">RewriteM a -&gt; RewriteEnv -&gt; TcS a
forall a. RewriteM a -&gt; RewriteEnv -&gt; TcS a
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewriteM"><span class="hs-identifier hs-var">runRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteM a
</span><a href="#local-6989586621682006593"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006594"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#re_eq_rel"><span class="hs-identifier hs-var">re_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682006592"><span class="hs-identifier hs-type">new_eq_rel</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#setEqRel"><span class="hs-pragma hs-type">setEqRel</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span id="local-6989586621682006180"><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#bumpDepth"><span class="hs-identifier hs-type">bumpDepth</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006180"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006180"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-147"></span><span id="bumpDepth"><span class="annot"><span class="annottext">bumpDepth :: forall a. RewriteM a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#bumpDepth"><span class="hs-identifier hs-var hs-var">bumpDepth</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span id="local-6989586621682006596"><span class="annot"><span class="annottext">RewriteEnv -&gt; TcS a
</span><a href="#local-6989586621682006596"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewriteEnv -&gt; TcS a) -&gt; RewriteM a
forall a. (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#mkRewriteM"><span class="hs-identifier hs-var">mkRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">((RewriteEnv -&gt; TcS a) -&gt; RewriteM a)
-&gt; (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682006597"><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006597"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-comment">-- bumpDepth can be called a lot during rewriting so we force the</span><span>
</span><span id="line-150"></span><span>      </span><span class="hs-comment">-- new env to avoid accumulating thunks.</span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621682006598"><span class="annot"><span class="annottext">env' :: RewriteEnv
</span><a href="#local-6989586621682006598"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006597"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#re_loc"><span class="hs-identifier hs-var">re_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#bumpCtLocDepth"><span class="hs-identifier hs-type">bumpCtLocDepth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.html#re_loc"><span class="hs-identifier hs-var">re_loc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682006597"><span class="hs-identifier hs-type">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">RewriteEnv -&gt; TcS a
</span><a href="#local-6989586621682006596"><span class="hs-identifier hs-var">thing_inside</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006598"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-comment">-- See Note [Wanteds rewrite Wanteds] in GHC.Tc.Types.Constraint</span><span>
</span><span id="line-155"></span><span class="hs-comment">-- Precondition: the CtEvidence is a CtWanted of an equality</span><span>
</span><span id="line-156"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#recordRewriter"><span class="hs-identifier hs-type">recordRewriter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span id="recordRewriter"><span class="annot"><span class="annottext">recordRewriter :: CtEvidence -&gt; RewriteM ()
</span><a href="GHC.Tc.Solver.Rewrite.html#recordRewriter"><span class="hs-identifier hs-var hs-var">recordRewriter</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtWanted"><span class="hs-identifier hs-type">CtWanted</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ctev_dest :: CtEvidence -&gt; TcEvDest
</span><a href="GHC.Tc.Types.Constraint.html#ctev_dest"><span class="hs-identifier hs-var">ctev_dest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#HoleDest"><span class="hs-identifier hs-type">HoleDest</span></a></span><span> </span><span id="local-6989586621682006604"><span class="annot"><span class="annottext">CoercionHole
</span><a href="#local-6989586621682006604"><span class="hs-identifier hs-var">hole</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RewriteEnv -&gt; TcS ()) -&gt; RewriteM ()
forall a. (RewriteEnv -&gt; TcS a) -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-var">RewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">((RewriteEnv -&gt; TcS ()) -&gt; RewriteM ())
-&gt; (RewriteEnv -&gt; TcS ()) -&gt; RewriteM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682006605"><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006605"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TcRef RewriterSet -&gt; (RewriterSet -&gt; RewriterSet) -&gt; TcS ()
forall a. TcRef a -&gt; (a -&gt; a) -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewriteEnv -&gt; TcRef RewriterSet
</span><a href="GHC.Tc.Types.html#re_rewriters"><span class="hs-identifier hs-var">re_rewriters</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006605"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RewriterSet -&gt; CoercionHole -&gt; RewriterSet
</span><a href="GHC.Tc.Types.Constraint.html#addRewriterSet"><span class="hs-operator hs-var">`addRewriterSet`</span></a></span><span> </span><span class="annot"><span class="annottext">CoercionHole
</span><a href="#local-6989586621682006604"><span class="hs-identifier hs-var">hole</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#recordRewriter"><span class="hs-identifier hs-var">recordRewriter</span></a></span><span> </span><span id="local-6989586621682006608"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006608"><span class="hs-identifier hs-var">other</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RewriteM ()
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;recordRewriter&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006608"><span class="hs-identifier hs-var">other</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="hs-comment">{-
Note [Rewriter EqRels]
~~~~~~~~~~~~~~~~~~~~~~~
When rewriting, we need to know which equality relation -- nominal
or representation -- we should be respecting. The only difference is
that we rewrite variables by representational equalities when re_eq_rel
is ReprEq, and that we unwrap newtypes when rewriting w.r.t.
representational equality.

Note [Rewriter CtLoc]
~~~~~~~~~~~~~~~~~~~~~~
The rewriter does eager type-family reduction.
Type families might loop, and we
don't want GHC to do so. A natural solution is to have a bounded depth
to these processes. A central difficulty is that such a solution isn't
quite compositional. For example, say it takes F Int 10 steps to get to Bool.
How many steps does it take to get from F Int -&gt; F Int to Bool -&gt; Bool?
10? 20? What about getting from Const Char (F Int) to Char? 11? 1? Hard to
know and hard to track. So, we punt, essentially. We store a CtLoc in
the RewriteEnv and just update the environment when recurring. In the
TyConApp case, where there may be multiple type families to rewrite,
we just copy the current CtLoc into each branch. If any branch hits the
stack limit, then the whole thing fails.

A consequence of this is that setting the stack limits appropriately
will be essentially impossible. So, the official recommendation if a
stack limit is hit is to disable the check entirely. Otherwise, there
will be baffling, unpredictable errors.

Note [Phantoms in the rewriter]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have

data Proxy p = Proxy

and we're rewriting (Proxy ty) w.r.t. ReprEq. Then, we know that `ty`
is really irrelevant -- it will be ignored when solving for representational
equality later on. So, we omit rewriting `ty` entirely. This may
violate the expectation of &quot;xi&quot;s for a bit, but the canonicaliser will
soon throw out the phantoms when decomposing a TyConApp. (Or, the
canonicaliser will emit an insoluble, in which case we get
a better error message anyway.)

-}</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
*      Externally callable rewriting functions                         *
*                                                                      *
************************************************************************
-}</span></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="hs-comment">-- | See Note [Rewriting].</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- If (xi, co, rewriters) &lt;- rewrite mode ev ty, then co :: xi ~r ty</span><span>
</span><span id="line-215"></span><span class="hs-comment">-- where r is the role in @ev@.</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- rewriters is the set of coercion holes that have been used to rewrite</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- See Note [Wanteds rewrite Wanteds] in GHC.Tc.Types.Constraint</span><span>
</span><span id="line-218"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite"><span class="hs-identifier hs-type">rewrite</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span id="rewrite"><span class="annot"><span class="annottext">rewrite :: CtEvidence -&gt; Xi -&gt; TcS (Reduction, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite"><span class="hs-identifier hs-var hs-var">rewrite</span></a></span></span><span> </span><span id="local-6989586621682006612"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006612"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621682006613"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006613"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rewrite {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006613"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006614"><span class="annot"><span class="annottext">result :: (Reduction, RewriterSet)
</span><a href="#local-6989586621682006614"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621682006615"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006615"><span class="hs-identifier hs-var">redn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; RewriteM Reduction -&gt; TcS (Reduction, RewriterSet)
forall a. CtEvidence -&gt; RewriteM a -&gt; TcS (a, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewriteCtEv"><span class="hs-identifier hs-var">runRewriteCtEv</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006612"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006613"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rewrite }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">(Xi -&gt; SDoc) -&gt; Xi -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; Xi
</span><a href="GHC.Core.Reduction.html#reductionReducedType"><span class="hs-identifier hs-var">reductionReducedType</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006615"><span class="hs-identifier hs-var">redn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Reduction, RewriterSet) -&gt; TcS (Reduction, RewriterSet)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction, RewriterSet)
</span><a href="#local-6989586621682006614"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">-- | See Note [Rewriting]</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- `rewriteForErrors` is a variant of 'rewrite' that rewrites</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- w.r.t. nominal equality only, as this is better than full rewriting</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- for error messages. (This was important when we flirted with rewriting</span><span>
</span><span id="line-230"></span><span class="hs-comment">-- newtypes but perhaps less so now.)</span><span>
</span><span id="line-231"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewriteForErrors"><span class="hs-identifier hs-type">rewriteForErrors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-232"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span id="rewriteForErrors"><span class="annot"><span class="annottext">rewriteForErrors :: CtEvidence -&gt; Xi -&gt; TcS (Reduction, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#rewriteForErrors"><span class="hs-identifier hs-var hs-var">rewriteForErrors</span></a></span></span><span> </span><span id="local-6989586621682006618"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006618"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621682006619"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006619"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rewriteForErrors {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006619"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006620"><span class="annot"><span class="annottext">result :: (Reduction, RewriterSet)
</span><a href="#local-6989586621682006620"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621682006621"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006621"><span class="hs-identifier hs-var">redn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006622"><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621682006622"><span class="hs-identifier hs-var">rewriters</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-236"></span><span>           </span><span class="annot"><span class="annottext">CtLoc
-&gt; CtFlavour
-&gt; EqRel
-&gt; RewriteM Reduction
-&gt; TcS (Reduction, RewriterSet)
forall a.
CtLoc -&gt; CtFlavour -&gt; EqRel -&gt; RewriteM a -&gt; TcS (a, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewrite"><span class="hs-identifier hs-var">runRewrite</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; CtLoc
</span><a href="GHC.Tc.Types.Constraint.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006618"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtEvidence -&gt; CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#ctEvFlavour"><span class="hs-identifier hs-var">ctEvFlavour</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006618"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006619"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rewriteForErrors }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">(Xi -&gt; SDoc) -&gt; Xi -&gt; SDoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; Xi
</span><a href="GHC.Core.Reduction.html#reductionReducedType"><span class="hs-identifier hs-var">reductionReducedType</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006621"><span class="hs-identifier hs-var">redn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Reduction, RewriterSet) -&gt; TcS (Reduction, RewriterSet)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">((Reduction, RewriterSet) -&gt; TcS (Reduction, RewriterSet))
-&gt; (Reduction, RewriterSet) -&gt; TcS (Reduction, RewriterSet)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#ctEvEqRel"><span class="hs-identifier hs-var">ctEvEqRel</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006618"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-239"></span><span>           </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Reduction, RewriterSet)
</span><a href="#local-6989586621682006620"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-240"></span><span>           </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkSubRedn"><span class="hs-identifier hs-var">mkSubRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006621"><span class="hs-identifier hs-var">redn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621682006622"><span class="hs-identifier hs-var">rewriters</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="hs-comment">-- See Note [Rewriting]</span><span>
</span><span id="line-243"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewriteArgsNom"><span class="hs-identifier hs-type">rewriteArgsNom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-244"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reductions"><span class="hs-identifier hs-type">Reductions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#RewriterSet"><span class="hs-identifier hs-type">RewriterSet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- Externally-callable, hence runRewrite</span><span>
</span><span id="line-246"></span><span class="hs-comment">-- Rewrite a vector of types all at once; in fact they are</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- always the arguments of type family or class, so</span><span>
</span><span id="line-248"></span><span class="hs-comment">--      ctEvFlavour ev = Nominal</span><span>
</span><span id="line-249"></span><span class="hs-comment">-- and we want to rewrite all at nominal role</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- The kind passed in is the kind of the type family or class, call it T</span><span>
</span><span id="line-251"></span><span class="hs-comment">-- The kind of T args must be constant (i.e. not depend on the args)</span><span>
</span><span id="line-252"></span><span class="hs-comment">--</span><span>
</span><span id="line-253"></span><span class="hs-comment">-- Final return value returned which Wanteds rewrote another Wanted</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- See Note [Wanteds rewrite Wanteds] in GHC.Tc.Types.Constraint</span><span>
</span><span id="line-255"></span><span id="rewriteArgsNom"><span class="annot"><span class="annottext">rewriteArgsNom :: CtEvidence -&gt; TyCon -&gt; [Xi] -&gt; TcS (Reductions, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#rewriteArgsNom"><span class="hs-identifier hs-var hs-var">rewriteArgsNom</span></a></span></span><span> </span><span id="local-6989586621682006626"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006626"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621682006627"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006627"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682006628"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006628"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rewrite_args {&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Xi -&gt; SDoc) -&gt; [Xi] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Xi -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006628"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span> </span><span id="local-6989586621682006631"><span class="annot"><span class="annottext">redns :: Reductions
</span><a href="#local-6989586621682006631"><span class="hs-identifier hs-var">redns</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reductions"><span class="hs-identifier hs-type">Reductions</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621682006633"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006633"><span class="hs-identifier hs-var">tys'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682006634"><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682006634"><span class="hs-identifier hs-var">kind_co</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006635"><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621682006635"><span class="hs-identifier hs-var">rewriters</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtEvidence
-&gt; RewriteM ArgsReductions -&gt; TcS (ArgsReductions, RewriterSet)
forall a. CtEvidence -&gt; RewriteM a -&gt; TcS (a, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewriteCtEv"><span class="hs-identifier hs-var">runRewriteCtEv</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006626"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Maybe (Infinite Role) -&gt; [Xi] -&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_tc"><span class="hs-identifier hs-var">rewrite_args_tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006627"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Infinite Role)
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006628"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TcS ()
forall (m :: * -&gt; *). (HasCallStack, Applicative m) =&gt; Bool -&gt; m ()
</span><a href="GHC.Utils.Panic.Plain.html#massert"><span class="hs-identifier hs-var">massert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MCoercionN -&gt; Bool
</span><a href="GHC.Core.Coercion.html#isReflMCo"><span class="hs-identifier hs-var">isReflMCo</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682006634"><span class="hs-identifier hs-var">kind_co</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rewrite }&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Xi -&gt; SDoc) -&gt; [Xi] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Xi -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006633"><span class="hs-identifier hs-var">tys'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Reductions, RewriterSet) -&gt; TcS (Reductions, RewriterSet)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reductions
</span><a href="#local-6989586621682006631"><span class="hs-identifier hs-var">redns</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><a href="#local-6989586621682006635"><span class="hs-identifier hs-var">rewriters</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span class="hs-comment">-- | Rewrite a type w.r.t. nominal equality. This is useful to rewrite</span><span>
</span><span id="line-264"></span><span class="hs-comment">-- a type w.r.t. any givens. It does not do type-family reduction. This</span><span>
</span><span id="line-265"></span><span class="hs-comment">-- will never emit new constraints. Call this when the inert set contains</span><span>
</span><span id="line-266"></span><span class="hs-comment">-- only givens.</span><span>
</span><span id="line-267"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewriteType"><span class="hs-identifier hs-type">rewriteType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span>
</span><span id="line-268"></span><span id="rewriteType"><span class="annot"><span class="annottext">rewriteType :: CtLoc -&gt; Xi -&gt; TcS Xi
</span><a href="GHC.Tc.Solver.Rewrite.html#rewriteType"><span class="hs-identifier hs-var hs-var">rewriteType</span></a></span></span><span> </span><span id="local-6989586621682006639"><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621682006639"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621682006640"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006640"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682006641"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006641"><span class="hs-identifier hs-var">redn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RewriterSet
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CtLoc
-&gt; CtFlavour
-&gt; EqRel
-&gt; RewriteM Reduction
-&gt; TcS (Reduction, RewriterSet)
forall a.
CtLoc -&gt; CtFlavour -&gt; EqRel -&gt; RewriteM a -&gt; TcS (a, RewriterSet)
</span><a href="GHC.Tc.Solver.Rewrite.html#runRewrite"><span class="hs-identifier hs-var">runRewrite</span></a></span><span> </span><span class="annot"><span class="annottext">CtLoc
</span><a href="#local-6989586621682006639"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#Given"><span class="hs-identifier hs-var">Given</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span class="annot"><span class="annottext">(RewriteM Reduction -&gt; TcS (Reduction, RewriterSet))
-&gt; RewriteM Reduction -&gt; TcS (Reduction, RewriterSet)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-270"></span><span>                       </span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006640"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-271"></span><span>                     </span><span class="hs-comment">-- use Given flavor so that it is rewritten</span><span>
</span><span id="line-272"></span><span>                     </span><span class="hs-comment">-- only w.r.t. Givens, never Wanteds</span><span>
</span><span id="line-273"></span><span>                     </span><span class="hs-comment">-- (Shouldn't matter, if only Givens are present</span><span>
</span><span id="line-274"></span><span>                     </span><span class="hs-comment">-- anyway)</span><span>
</span><span id="line-275"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; TcS Xi
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Xi -&gt; TcS Xi) -&gt; Xi -&gt; TcS Xi
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; Xi
</span><a href="GHC.Core.Reduction.html#reductionReducedType"><span class="hs-identifier hs-var">reductionReducedType</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006641"><span class="hs-identifier hs-var">redn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span class="annot"><span class="hs-comment">{- *********************************************************************
*                                                                      *
*           The main rewriting functions
*                                                                      *
********************************************************************* -}</span></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="hs-comment">{- Note [Rewriting]
~~~~~~~~~~~~~~~~~~~~
  rewrite ty  ==&gt;  Reduction co xi
    where
      xi has no reducible type functions
         has no skolems that are mapped in the inert set
         has no filled-in metavariables
      co :: ty ~ xi (coercions in reductions are always left-to-right)

Key invariants:
  (F0) co :: zonk(ty') ~ xi   where zonk(ty') ~ zonk(ty)
  (F1) typeKind(xi) succeeds and returns a fully zonked kind
  (F2) typeKind(xi) `eqType` zonk(typeKind(ty))

Note that it is rewrite's job to try to reduce *every type function it sees*.

Rewriting also:
  * zonks, removing any metavariables, and
  * applies the substitution embodied in the inert set

Because rewriting zonks and the returned coercion (&quot;co&quot; above) is also
zonked, it's possible that (co :: ty ~ xi) isn't quite true. So, instead,
we can rely on this fact:

  (F0) co :: zonk(ty') ~ xi, where zonk(ty') ~ zonk(ty)

Note that the right-hand type of co is *always* precisely xi. The left-hand
type may or may not be ty, however: if ty has unzonked filled-in metavariables,
then the left-hand type of co will be the zonk-equal to ty.
It is for this reason that we occasionally have to explicitly zonk,
when (co :: ty ~ xi) is important even before we zonk the whole program.
For example, see the RTRNotFollowed case in rewriteTyVar.

Why have these invariants on rewriting? Because we sometimes use typeKind
during canonicalisation, and we want this kind to be zonked (e.g., see
GHC.Tc.Solver.Canonical.canEqCanLHS).

Rewriting is always homogeneous. That is, the kind of the result of rewriting is
always the same as the kind of the input, modulo zonking. More formally:

  (F2) zonk(typeKind(ty)) `eqType` typeKind(xi)

This invariant means that the kind of a rewritten type might not itself be rewritten.

Note that we prefer to leave type synonyms unexpanded when possible,
so when the rewriter encounters one, it first asks whether its
transitive expansion contains any type function applications or is
forgetful -- that is, omits one or more type variables in its RHS.  If so,
it expands the synonym and proceeds; if not, it simply returns the
unexpanded synonym. See also Note [Rewriting synonyms].

Where do we actually perform rewriting within a type? See Note [Rewritable] in
GHC.Tc.Solver.InertSet.

Note [rewrite_args performance]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In programs with lots of type-level evaluation, rewrite_args becomes
part of a tight loop. For example, see test perf/compiler/T9872a, which
calls rewrite_args a whopping 7,106,808 times. It is thus important
that rewrite_args be efficient.

Performance testing showed that the current implementation is indeed
efficient. It's critically important that zipWithAndUnzipM be
specialized to TcS, and it's also quite helpful to actually `inline`
it. On test T9872a, here are the allocation stats (Dec 16, 2014):

 * Unspecialized, uninlined:     8,472,613,440 bytes allocated in the heap
 * Specialized, uninlined:       6,639,253,488 bytes allocated in the heap
 * Specialized, inlined:         6,281,539,792 bytes allocated in the heap

To improve performance even further, rewrite_args_nom is split off
from rewrite_args, as nominal equality is the common case. This would
be natural to write using mapAndUnzipM, but even inlined, that function
is not as performant as a hand-written loop.

 * mapAndUnzipM, inlined:        7,463,047,432 bytes allocated in the heap
 * hand-written recursion:       5,848,602,848 bytes allocated in the heap

If you make any change here, pay close attention to the T9872{a,b,c} tests
and T5321Fun.

If we need to make this yet more performant, a possible way forward is to
duplicate the rewriter code for the nominal case, and make that case
faster. This doesn't seem quite worth it, yet.

Note [rewrite_exact_fam_app performance]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Once we've got a rewritten rhs, we extend the famapp-cache to record
the result. Doing so can save lots of work when the same redex shows up more
than once. Note that we record the link from the redex all the way to its
*final* value, not just the single step reduction.

If we can reduce the family application right away (the first call
to try_to_reduce), we do *not* add to the cache. There are two possibilities
here: 1) we just read the result from the cache, or 2) we used one type
family instance. In either case, recording the result in the cache doesn't
save much effort the next time around. And adding to the cache here is
actually disastrous: it more than doubles the allocations for T9872a. So
we skip adding to the cache here.
-}</span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_tc"><span class="hs-pragma hs-type">rewrite_args_tc</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-385"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_tc"><span class="hs-identifier hs-type">rewrite_args_tc</span></a></span><span>
</span><span id="line-386"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span>         </span><span class="hs-comment">-- T</span><span>
</span><span id="line-387"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.List.Infinite.html#Infinite"><span class="hs-identifier hs-type">Infinite</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Nothing: ambient role is Nominal; all args are Nominal</span><span>
</span><span id="line-388"></span><span>                   </span><span class="hs-comment">-- Otherwise: no assumptions; use roles provided</span><span>
</span><span id="line-389"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span> </span><span class="hs-comment">-- See the commentary on rewrite_args</span><span>
</span><span id="line-391"></span><span id="rewrite_args_tc"><span class="annot"><span class="annottext">rewrite_args_tc :: TyCon -&gt; Maybe (Infinite Role) -&gt; [Xi] -&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_tc"><span class="hs-identifier hs-var hs-var">rewrite_args_tc</span></a></span></span><span> </span><span id="local-6989586621682006643"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006643"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
-&gt; Bool
-&gt; Xi
-&gt; TcTyCoVarSet
-&gt; Maybe (Infinite Role)
-&gt; [Xi]
-&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args"><span class="hs-identifier hs-var">rewrite_args</span></a></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006645"><span class="hs-identifier hs-var">all_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006646"><span class="hs-identifier hs-var">any_named_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006647"><span class="hs-identifier hs-var">inner_ki</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyCoVarSet
</span><a href="GHC.Types.Var.Set.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a></span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-comment">-- NB: TyCon kinds are always closed</span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-394"></span><span>  </span><span class="hs-comment">-- There are many bang patterns in here. It's been observed that they</span><span>
</span><span id="line-395"></span><span>  </span><span class="hs-comment">-- greatly improve performance of an optimized build.</span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-comment">-- The T9872 test cases are good witnesses of this fact.</span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682006649"><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006649"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006650"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006650"><span class="hs-identifier hs-var">named</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyConBinder] -&gt; ([PiTyBinder], Bool)
</span><a href="GHC.Tc.Solver.Rewrite.html#ty_con_binders_ty_binders%27"><span class="hs-identifier hs-var">ty_con_binders_ty_binders'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [TyConBinder]
</span><a href="GHC.Core.TyCon.html#tyConBinders"><span class="hs-identifier hs-var">tyConBinders</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006643"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-comment">-- it's possible that the result kind has arrows (for, e.g., a type family)</span><span>
</span><span id="line-401"></span><span>    </span><span class="hs-comment">-- so we must split it</span><span>
</span><span id="line-402"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682006653"><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006653"><span class="hs-identifier hs-var">inner_bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006647"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006647"><span class="hs-identifier hs-var">inner_ki</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006654"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006654"><span class="hs-identifier hs-var">inner_named</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; ([PiTyBinder], Xi, Bool)
</span><a href="GHC.Tc.Solver.Rewrite.html#split_pi_tys%27"><span class="hs-identifier hs-var">split_pi_tys'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Xi
</span><a href="GHC.Core.TyCon.html#tyConResKind"><span class="hs-identifier hs-var">tyConResKind</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006643"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682006645"><span class="annot"><span class="annottext">all_bndrs :: [PiTyBinder]
</span><a href="#local-6989586621682006645"><span class="hs-identifier hs-var hs-var">all_bndrs</span></a></span></span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006649"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder] -&gt; [PiTyBinder] -&gt; [PiTyBinder]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="GHC.Utils.Misc.html#chkAppend"><span class="hs-operator hs-var">`chkAppend`</span></a></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006653"><span class="hs-identifier hs-var">inner_bndrs</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621682006646"><span class="annot"><span class="annottext">any_named_bndrs :: Bool
</span><a href="#local-6989586621682006646"><span class="hs-identifier hs-var hs-var">any_named_bndrs</span></a></span></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006650"><span class="hs-identifier hs-var">named</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006654"><span class="hs-identifier hs-var">inner_named</span></a></span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-comment">-- NB: Those bangs there drop allocations in T9872{a,c,d} by 8%.</span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args"><span class="hs-pragma hs-type">rewrite_args</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-408"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args"><span class="hs-identifier hs-type">rewrite_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#PiTyBinder"><span class="hs-identifier hs-type">PiTyBinder</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-comment">-- Binders, and True iff any of them are</span><span>
</span><span id="line-409"></span><span>                                     </span><span class="hs-comment">-- named.</span><span>
</span><span id="line-410"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTyCoVarSet"><span class="hs-identifier hs-type">TcTyCoVarSet</span></a></span><span> </span><span class="hs-comment">-- function kind; kind's free vars</span><span>
</span><span id="line-411"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.List.Infinite.html#Infinite"><span class="hs-identifier hs-type">Infinite</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- these are in 1-to-1 correspondence</span><span>
</span><span id="line-412"></span><span>                                          </span><span class="hs-comment">-- Nothing: use all Nominal</span><span>
</span><span id="line-413"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span>
</span><span id="line-414"></span><span class="hs-comment">-- This function returns ArgsReductions (Reductions cos xis) res_co</span><span>
</span><span id="line-415"></span><span class="hs-comment">--   coercions: co_i :: ty_i ~ xi_i, at roles given</span><span>
</span><span id="line-416"></span><span class="hs-comment">--   types:     xi_i</span><span>
</span><span id="line-417"></span><span class="hs-comment">--   coercion:  res_co :: typeKind(fun tys) ~N typeKind(fun xis)</span><span>
</span><span id="line-418"></span><span class="hs-comment">-- That is, the result coercion relates the kind of some function (whose kind is</span><span>
</span><span id="line-419"></span><span class="hs-comment">-- passed as the first parameter) instantiated at tys to the kind of that</span><span>
</span><span id="line-420"></span><span class="hs-comment">-- function instantiated at the xis. This is useful in keeping rewriting</span><span>
</span><span id="line-421"></span><span class="hs-comment">-- homogeneous. The list of roles must be at least as long as the list of</span><span>
</span><span id="line-422"></span><span class="hs-comment">-- types.</span><span>
</span><span id="line-423"></span><span id="rewrite_args"><span class="annot"><span class="annottext">rewrite_args :: [PiTyBinder]
-&gt; Bool
-&gt; Xi
-&gt; TcTyCoVarSet
-&gt; Maybe (Infinite Role)
-&gt; [Xi]
-&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args"><span class="hs-identifier hs-var hs-var">rewrite_args</span></a></span></span><span> </span><span id="local-6989586621682006660"><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006660"><span class="hs-identifier hs-var">orig_binders</span></a></span></span><span>
</span><span id="line-424"></span><span>             </span><span id="local-6989586621682006661"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006661"><span class="hs-identifier hs-var">any_named_bndrs</span></a></span></span><span>
</span><span id="line-425"></span><span>             </span><span id="local-6989586621682006662"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006662"><span class="hs-identifier hs-var">orig_inner_ki</span></a></span></span><span>
</span><span id="line-426"></span><span>             </span><span id="local-6989586621682006663"><span class="annot"><span class="annottext">TcTyCoVarSet
</span><a href="#local-6989586621682006663"><span class="hs-identifier hs-var">orig_fvs</span></a></span></span><span>
</span><span id="line-427"></span><span>             </span><span id="local-6989586621682006664"><span class="annot"><span class="annottext">Maybe (Infinite Role)
</span><a href="#local-6989586621682006664"><span class="hs-identifier hs-var">orig_m_roles</span></a></span></span><span>
</span><span id="line-428"></span><span>             </span><span id="local-6989586621682006665"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006665"><span class="hs-identifier hs-var">orig_tys</span></a></span></span><span>
</span><span id="line-429"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Infinite Role)
</span><a href="#local-6989586621682006664"><span class="hs-identifier hs-var">orig_m_roles</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006661"><span class="hs-identifier hs-var">any_named_bndrs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-430"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Infinite Role)
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Xi] -&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_fast"><span class="hs-identifier hs-var">rewrite_args_fast</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006665"><span class="hs-identifier hs-var">orig_tys</span></a></span><span>
</span><span id="line-431"></span><span>      </span><span class="annot"><span class="annottext">(Maybe (Infinite Role), Bool)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
-&gt; Xi
-&gt; TcTyCoVarSet
-&gt; Infinite Role
-&gt; [Xi]
-&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_slow"><span class="hs-identifier hs-var">rewrite_args_slow</span></a></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006660"><span class="hs-identifier hs-var">orig_binders</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006662"><span class="hs-identifier hs-var">orig_inner_ki</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyCoVarSet
</span><a href="#local-6989586621682006663"><span class="hs-identifier hs-var">orig_fvs</span></a></span><span> </span><span class="annot"><span class="annottext">Infinite Role
</span><a href="#local-6989586621682006668"><span class="hs-identifier hs-var">orig_roles</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006665"><span class="hs-identifier hs-var">orig_tys</span></a></span><span>
</span><span id="line-432"></span><span>        </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621682006668"><span class="annot"><span class="annottext">orig_roles :: Infinite Role
</span><a href="#local-6989586621682006668"><span class="hs-identifier hs-var hs-var">orig_roles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Infinite Role -&gt; Maybe (Infinite Role) -&gt; Infinite Role
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../base-4.18.3.0/src/Data.Maybe.html#fromMaybe/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Infinite Role
forall a. a -&gt; Infinite a
</span><a href="GHC.Data.List.Infinite.html#repeat"><span class="hs-identifier hs-var">Inf.repeat</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (Infinite Role)
</span><a href="#local-6989586621682006664"><span class="hs-identifier hs-var">orig_m_roles</span></a></span><span>
</span><span id="line-433"></span><span>
</span><span id="line-434"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_fast"><span class="hs-pragma hs-type">rewrite_args_fast</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-435"></span><span class="hs-comment">-- | fast path rewrite_args, in which none of the binders are named and</span><span>
</span><span id="line-436"></span><span class="hs-comment">-- therefore we can avoid tracking a lifting context.</span><span>
</span><span id="line-437"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_fast"><span class="hs-identifier hs-type">rewrite_args_fast</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span>
</span><span id="line-438"></span><span id="rewrite_args_fast"><span class="annot"><span class="annottext">rewrite_args_fast :: [Xi] -&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_fast"><span class="hs-identifier hs-var hs-var">rewrite_args_fast</span></a></span></span><span> </span><span id="local-6989586621682006672"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006672"><span class="hs-identifier hs-var">orig_tys</span></a></span></span><span>
</span><span id="line-439"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Reductions -&gt; ArgsReductions)
-&gt; RewriteM Reductions -&gt; RewriteM ArgsReductions
forall a b. (a -&gt; b) -&gt; RewriteM a -&gt; RewriteM b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#fmap/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Reductions -&gt; ArgsReductions
</span><a href="#local-6989586621682006673"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Xi] -&gt; RewriteM Reductions
</span><a href="#local-6989586621682006674"><span class="hs-identifier hs-var">iterate</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006672"><span class="hs-identifier hs-var">orig_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-440"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span>    </span><span class="annot"><a href="#local-6989586621682006674"><span class="hs-identifier hs-type">iterate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reductions"><span class="hs-identifier hs-type">Reductions</span></a></span><span>
</span><span id="line-443"></span><span>    </span><span id="local-6989586621682006674"><span class="annot"><span class="annottext">iterate :: [Xi] -&gt; RewriteM Reductions
</span><a href="#local-6989586621682006674"><span class="hs-identifier hs-var hs-var">iterate</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682006675"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006675"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621682006676"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006676"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-444"></span><span>      </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>  </span><span id="local-6989586621682006678"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006678"><span class="hs-identifier hs-var">co</span></a></span></span><span>  </span><span id="local-6989586621682006679"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006679"><span class="hs-identifier hs-var">xi</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006675"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-445"></span><span>      </span><span class="annot"><a href="GHC.Core.Reduction.html#Reductions"><span class="hs-identifier hs-type">Reductions</span></a></span><span> </span><span id="local-6989586621682006680"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682006680"><span class="hs-identifier hs-var">cos</span></a></span></span><span> </span><span id="local-6989586621682006681"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006681"><span class="hs-identifier hs-var">xis</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Xi] -&gt; RewriteM Reductions
</span><a href="#local-6989586621682006674"><span class="hs-identifier hs-var">iterate</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006676"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-446"></span><span>      </span><span class="annot"><span class="annottext">Reductions -&gt; RewriteM Reductions
forall a. a -&gt; RewriteM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Reductions -&gt; RewriteM Reductions)
-&gt; Reductions -&gt; RewriteM Reductions
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion] -&gt; [Xi] -&gt; Reductions
</span><a href="GHC.Core.Reduction.html#Reductions"><span class="hs-identifier hs-var">Reductions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006678"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; [Coercion] -&gt; [Coercion]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682006680"><span class="hs-identifier hs-var">cos</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006679"><span class="hs-identifier hs-var">xi</span></a></span><span> </span><span class="annot"><span class="annottext">Xi -&gt; [Xi] -&gt; [Xi]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006681"><span class="hs-identifier hs-var">xis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>    </span><span class="annot"><a href="#local-6989586621682006674"><span class="hs-identifier hs-var">iterate</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reductions -&gt; RewriteM Reductions
forall a. a -&gt; RewriteM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Reductions -&gt; RewriteM Reductions)
-&gt; Reductions -&gt; RewriteM Reductions
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion] -&gt; [Xi] -&gt; Reductions
</span><a href="GHC.Core.Reduction.html#Reductions"><span class="hs-identifier hs-var">Reductions</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621682006673"><span class="hs-pragma hs-type">finish</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-450"></span><span>    </span><span class="annot"><a href="#local-6989586621682006673"><span class="hs-identifier hs-type">finish</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reductions"><span class="hs-identifier hs-type">Reductions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span>
</span><span id="line-451"></span><span>    </span><span id="local-6989586621682006673"><span class="annot"><span class="annottext">finish :: Reductions -&gt; ArgsReductions
</span><a href="#local-6989586621682006673"><span class="hs-identifier hs-var hs-var">finish</span></a></span></span><span> </span><span id="local-6989586621682006682"><span class="annot"><span class="annottext">Reductions
</span><a href="#local-6989586621682006682"><span class="hs-identifier hs-var">redns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reductions -&gt; MCoercionN -&gt; ArgsReductions
</span><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-var">ArgsReductions</span></a></span><span> </span><span class="annot"><span class="annottext">Reductions
</span><a href="#local-6989586621682006682"><span class="hs-identifier hs-var">redns</span></a></span><span> </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="GHC.Core.TyCo.Rep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a></span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_slow"><span class="hs-pragma hs-type">rewrite_args_slow</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-454"></span><span class="hs-comment">-- | Slow path, compared to rewrite_args_fast, because this one must track</span><span>
</span><span id="line-455"></span><span class="hs-comment">-- a lifting context.</span><span>
</span><span id="line-456"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_slow"><span class="hs-identifier hs-type">rewrite_args_slow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#PiTyBinder"><span class="hs-identifier hs-type">PiTyBinder</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcTyCoVarSet"><span class="hs-identifier hs-type">TcTyCoVarSet</span></a></span><span>
</span><span id="line-457"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.List.Infinite.html#Infinite"><span class="hs-identifier hs-type">Infinite</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-458"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span>
</span><span id="line-459"></span><span id="rewrite_args_slow"><span class="annot"><span class="annottext">rewrite_args_slow :: [PiTyBinder]
-&gt; Xi
-&gt; TcTyCoVarSet
-&gt; Infinite Role
-&gt; [Xi]
-&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_slow"><span class="hs-identifier hs-var hs-var">rewrite_args_slow</span></a></span></span><span> </span><span id="local-6989586621682006684"><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006684"><span class="hs-identifier hs-var">binders</span></a></span></span><span> </span><span id="local-6989586621682006685"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006685"><span class="hs-identifier hs-var">inner_ki</span></a></span></span><span> </span><span id="local-6989586621682006686"><span class="annot"><span class="annottext">TcTyCoVarSet
</span><a href="#local-6989586621682006686"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span id="local-6989586621682006687"><span class="annot"><span class="annottext">Infinite Role
</span><a href="#local-6989586621682006687"><span class="hs-identifier hs-var">roles</span></a></span></span><span> </span><span id="local-6989586621682006688"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006688"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-460"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006689"><span class="annot"><span class="annottext">[Reduction]
</span><a href="#local-6989586621682006689"><span class="hs-identifier hs-var">rewritten_args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Role -&gt; Xi -&gt; RewriteM Reduction)
-&gt; [Role] -&gt; [Xi] -&gt; RewriteM [Reduction]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><a href="../../base-4.18.3.0/src/Control.Monad.html#zipWithM/Control.Monad.html#zipWithM"><span class="hs-identifier hs-var">zipWithM</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Xi -&gt; RewriteM Reduction
</span><a href="#local-6989586621682006691"><span class="hs-identifier hs-var">rw</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Infinite Role -&gt; [Role]
forall a. Infinite a -&gt; [a]
</span><a href="GHC.Data.List.Infinite.html#toList"><span class="hs-identifier hs-var">Inf.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Infinite Role
</span><a href="#local-6989586621682006687"><span class="hs-identifier hs-var">roles</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006688"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-461"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ArgsReductions -&gt; RewriteM ArgsReductions
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PiTyBinder]
-&gt; Xi
-&gt; TcTyCoVarSet
-&gt; Infinite Role
-&gt; [Reduction]
-&gt; ArgsReductions
(() :: Constraint) =&gt;
[PiTyBinder]
-&gt; Xi
-&gt; TcTyCoVarSet
-&gt; Infinite Role
-&gt; [Reduction]
-&gt; ArgsReductions
</span><a href="GHC.Core.Reduction.html#simplifyArgsWorker"><span class="hs-identifier hs-var">simplifyArgsWorker</span></a></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006684"><span class="hs-identifier hs-var">binders</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006685"><span class="hs-identifier hs-var">inner_ki</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyCoVarSet
</span><a href="#local-6989586621682006686"><span class="hs-identifier hs-var">fvs</span></a></span><span> </span><span class="annot"><span class="annottext">Infinite Role
</span><a href="#local-6989586621682006687"><span class="hs-identifier hs-var">roles</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduction]
</span><a href="#local-6989586621682006689"><span class="hs-identifier hs-var">rewritten_args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-462"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621682006691"><span class="hs-pragma hs-type">rw</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-464"></span><span>    </span><span class="annot"><a href="#local-6989586621682006691"><span class="hs-identifier hs-type">rw</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-465"></span><span>    </span><span id="local-6989586621682006691"><span class="annot"><span class="annottext">rw :: Role -&gt; Xi -&gt; RewriteM Reduction
</span><a href="#local-6989586621682006691"><span class="hs-identifier hs-var hs-var">rw</span></a></span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span id="local-6989586621682006694"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006694"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-466"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; RewriteM Reduction -&gt; RewriteM Reduction
forall a. EqRel -&gt; RewriteM a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#setEqRel"><span class="hs-identifier hs-var">setEqRel</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span class="annot"><span class="annottext">(RewriteM Reduction -&gt; RewriteM Reduction)
-&gt; RewriteM Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-467"></span><span>        </span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006694"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>    </span><span class="annot"><a href="#local-6989586621682006691"><span class="hs-identifier hs-var">rw</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span id="local-6989586621682006696"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006696"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-470"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; RewriteM Reduction -&gt; RewriteM Reduction
forall a. EqRel -&gt; RewriteM a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#setEqRel"><span class="hs-identifier hs-var">setEqRel</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span class="annot"><span class="annottext">(RewriteM Reduction -&gt; RewriteM Reduction)
-&gt; RewriteM Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-471"></span><span>        </span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006696"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span>    </span><span class="annot"><a href="#local-6989586621682006691"><span class="hs-identifier hs-var">rw</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a></span><span> </span><span id="local-6989586621682006698"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006698"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-474"></span><span>    </span><span class="hs-comment">-- See Note [Phantoms in the rewriter]</span><span>
</span><span id="line-475"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006699"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006699"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS Xi -&gt; RewriteM Xi
forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var">liftTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS Xi -&gt; RewriteM Xi) -&gt; TcS Xi -&gt; RewriteM Xi
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Xi -&gt; TcS Xi
</span><a href="GHC.Tc.Solver.Monad.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006698"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-476"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteM Reduction)
-&gt; Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Xi -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006699"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span class="hs-comment">------------------</span><span>
</span><span id="line-479"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-type">rewrite_one</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-480"></span><span class="hs-comment">-- Rewrite a type to get rid of type function applications, returning</span><span>
</span><span id="line-481"></span><span class="hs-comment">-- the new type-function-free type, and a collection of new equality</span><span>
</span><span id="line-482"></span><span class="hs-comment">-- constraints.  See Note [Rewriting] for more detail.</span><span>
</span><span id="line-483"></span><span class="hs-comment">--</span><span>
</span><span id="line-484"></span><span class="hs-comment">-- Postcondition:</span><span>
</span><span id="line-485"></span><span class="hs-comment">-- the role on the result coercion matches the EqRel in the RewriteEnv</span><span>
</span><span id="line-486"></span><span>
</span><span id="line-487"></span><span id="rewrite_one"><span class="annot"><span class="annottext">rewrite_one :: Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var hs-var">rewrite_one</span></a></span></span><span> </span><span id="local-6989586621682006702"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006702"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-488"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682006703"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006703"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; Maybe Xi
</span><a href="GHC.Tc.Solver.Monad.html#rewriterView"><span class="hs-identifier hs-var">rewriterView</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006702"><span class="hs-identifier hs-var">ty</span></a></span><span>  </span><span class="hs-comment">-- See Note [Rewriting synonyms]</span><span>
</span><span id="line-489"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006703"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span id="local-6989586621682006705"><span class="annot"><span class="annottext">xi :: Xi
</span><a href="#local-6989586621682006705"><span class="hs-identifier hs-var">xi</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#LitTy"><span class="hs-identifier hs-type">LitTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006707"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006707"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM Role
</span><a href="GHC.Tc.Solver.Rewrite.html#getRole"><span class="hs-identifier hs-var">getRole</span></a></span><span>
</span><span id="line-493"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteM Reduction)
-&gt; Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Xi -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006707"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006705"><span class="hs-identifier hs-var">xi</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyVarTy"><span class="hs-identifier hs-type">TyVarTy</span></a></span><span> </span><span id="local-6989586621682006709"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006709"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewriteTyVar"><span class="hs-identifier hs-var">rewriteTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006709"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-497"></span><span>
</span><span id="line-498"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621682006712"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006712"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682006713"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006713"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; [Xi] -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_app_tys"><span class="hs-identifier hs-var">rewrite_app_tys</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006712"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006713"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#TyConApp"><span class="hs-identifier hs-type">TyConApp</span></a></span><span> </span><span id="local-6989586621682006716"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006716"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682006717"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006717"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>  </span><span class="hs-comment">-- If it's a type family application, try to reduce it</span><span>
</span><span id="line-503"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006716"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-504"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Xi] -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_fam_app"><span class="hs-identifier hs-var">rewrite_fam_app</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006716"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006717"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-505"></span><span>
</span><span id="line-506"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-comment">-- We just recursively rewrite the arguments.</span><span>
</span><span id="line-507"></span><span>              </span><span class="hs-comment">-- See Note [Do not rewrite newtypes]</span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Xi] -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_ty_con_app"><span class="hs-identifier hs-var">rewrite_ty_con_app</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006716"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006717"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-509"></span><span>
</span><span id="line-510"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: Xi -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006723"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682006723"><span class="hs-identifier hs-var">vis</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: Xi -&gt; Xi
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006725"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006725"><span class="hs-identifier hs-var">mult</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: Xi -&gt; Xi
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006727"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006727"><span class="hs-identifier hs-var">ty1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: Xi -&gt; Xi
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006729"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006729"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-511"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006730"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006730"><span class="hs-identifier hs-var">arg_redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006727"><span class="hs-identifier hs-var">ty1</span></a></span><span>
</span><span id="line-512"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006731"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006731"><span class="hs-identifier hs-var">res_redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006729"><span class="hs-identifier hs-var">ty2</span></a></span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span>        </span><span class="hs-comment">-- Important: look at the *reduced* type, so that any unzonked variables</span><span>
</span><span id="line-515"></span><span>        </span><span class="hs-comment">-- in kinds are gone and the getRuntimeRep succeeds.</span><span>
</span><span id="line-516"></span><span>        </span><span class="hs-comment">-- cf. Note [Decomposing FunTy] in GHC.Tc.Solver.Canonical.</span><span>
</span><span id="line-517"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682006732"><span class="annot"><span class="annottext">arg_rep :: Xi
</span><a href="#local-6989586621682006732"><span class="hs-identifier hs-var hs-var">arg_rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Xi -&gt; Xi
Xi -&gt; Xi
</span><a href="GHC.Core.Type.html#getRuntimeRep"><span class="hs-identifier hs-var">getRuntimeRep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reduction -&gt; Xi
</span><a href="GHC.Core.Reduction.html#reductionReducedType"><span class="hs-identifier hs-var">reductionReducedType</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006730"><span class="hs-identifier hs-var">arg_redn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span>             </span><span id="local-6989586621682006734"><span class="annot"><span class="annottext">res_rep :: Xi
</span><a href="#local-6989586621682006734"><span class="hs-identifier hs-var hs-var">res_rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Xi -&gt; Xi
Xi -&gt; Xi
</span><a href="GHC.Core.Type.html#getRuntimeRep"><span class="hs-identifier hs-var">getRuntimeRep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reduction -&gt; Xi
</span><a href="GHC.Core.Reduction.html#reductionReducedType"><span class="hs-identifier hs-var">reductionReducedType</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006731"><span class="hs-identifier hs-var">res_redn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span>
</span><span id="line-520"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682006735"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006735"><span class="hs-identifier hs-var">w_redn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006736"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006736"><span class="hs-identifier hs-var">arg_rep_redn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006737"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006737"><span class="hs-identifier hs-var">res_rep_redn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqRel
-&gt; RewriteM (Reduction, Reduction, Reduction)
-&gt; RewriteM (Reduction, Reduction, Reduction)
forall a. EqRel -&gt; RewriteM a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#setEqRel"><span class="hs-identifier hs-var">setEqRel</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span class="annot"><span class="annottext">(RewriteM (Reduction, Reduction, Reduction)
 -&gt; RewriteM (Reduction, Reduction, Reduction))
-&gt; RewriteM (Reduction, Reduction, Reduction)
-&gt; RewriteM (Reduction, Reduction, Reduction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-521"></span><span>           </span><span class="annot"><span class="annottext">(Reduction
 -&gt; Reduction -&gt; Reduction -&gt; (Reduction, Reduction, Reduction))
-&gt; RewriteM Reduction
-&gt; RewriteM Reduction
-&gt; RewriteM Reduction
-&gt; RewriteM (Reduction, Reduction, Reduction)
forall (f :: * -&gt; *) a b c d.
Applicative f =&gt;
(a -&gt; b -&gt; c -&gt; d) -&gt; f a -&gt; f b -&gt; f c -&gt; f d
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#liftA3/GHC.Base.html#liftA3"><span class="hs-identifier hs-var">liftA3</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006725"><span class="hs-identifier hs-var">mult</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-522"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006732"><span class="hs-identifier hs-var">arg_rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006734"><span class="hs-identifier hs-var">res_rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-524"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006738"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006738"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM Role
</span><a href="GHC.Tc.Solver.Rewrite.html#getRole"><span class="hs-identifier hs-var">getRole</span></a></span><span>
</span><span id="line-525"></span><span>
</span><span id="line-526"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682006739"><span class="annot"><span class="annottext">arg_rep_co :: Coercion
</span><a href="#local-6989586621682006739"><span class="hs-identifier hs-var hs-var">arg_rep_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; Coercion
</span><a href="GHC.Core.Reduction.html#reductionCoercion"><span class="hs-identifier hs-var">reductionCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006736"><span class="hs-identifier hs-var">arg_rep_redn</span></a></span><span>
</span><span id="line-527"></span><span>                </span><span class="hs-comment">-- :: arg_rep ~ arg_rep_xi</span><span>
</span><span id="line-528"></span><span>             </span><span id="local-6989586621682006741"><span class="annot"><span class="annottext">arg_ki_co :: Coercion
</span><a href="#local-6989586621682006741"><span class="hs-identifier hs-var hs-var">arg_ki_co</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="GHC.Builtin.Types.Prim.html#tYPETyCon"><span class="hs-identifier hs-var">tYPETyCon</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006739"><span class="hs-identifier hs-var">arg_rep_co</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-529"></span><span>                </span><span class="hs-comment">-- :: TYPE arg_rep ~ TYPE arg_rep_xi</span><span>
</span><span id="line-530"></span><span>             </span><span id="local-6989586621682006743"><span class="annot"><span class="annottext">casted_arg_redn :: Reduction
</span><a href="#local-6989586621682006743"><span class="hs-identifier hs-var hs-var">casted_arg_redn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; Reduction -&gt; Coercion -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkCoherenceRightRedn"><span class="hs-identifier hs-var">mkCoherenceRightRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006738"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006730"><span class="hs-identifier hs-var">arg_redn</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006741"><span class="hs-identifier hs-var">arg_ki_co</span></a></span><span>
</span><span id="line-531"></span><span>                </span><span class="hs-comment">-- :: ty1 ~&gt; arg_xi |&gt; arg_ki_co</span><span>
</span><span id="line-532"></span><span>
</span><span id="line-533"></span><span>             </span><span id="local-6989586621682006745"><span class="annot"><span class="annottext">res_rep_co :: Coercion
</span><a href="#local-6989586621682006745"><span class="hs-identifier hs-var hs-var">res_rep_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; Coercion
</span><a href="GHC.Core.Reduction.html#reductionCoercion"><span class="hs-identifier hs-var">reductionCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006737"><span class="hs-identifier hs-var">res_rep_redn</span></a></span><span>
</span><span id="line-534"></span><span>             </span><span id="local-6989586621682006746"><span class="annot"><span class="annottext">res_ki_co :: Coercion
</span><a href="#local-6989586621682006746"><span class="hs-identifier hs-var hs-var">res_ki_co</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="GHC.Builtin.Types.Prim.html#tYPETyCon"><span class="hs-identifier hs-var">tYPETyCon</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006745"><span class="hs-identifier hs-var">res_rep_co</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-535"></span><span>             </span><span id="local-6989586621682006747"><span class="annot"><span class="annottext">casted_res_redn :: Reduction
</span><a href="#local-6989586621682006747"><span class="hs-identifier hs-var hs-var">casted_res_redn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; Reduction -&gt; Coercion -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkCoherenceRightRedn"><span class="hs-identifier hs-var">mkCoherenceRightRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006738"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006731"><span class="hs-identifier hs-var">res_redn</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006746"><span class="hs-identifier hs-var">res_ki_co</span></a></span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span>          </span><span class="hs-comment">-- We must rewrite the representations, because that's what would</span><span>
</span><span id="line-538"></span><span>          </span><span class="hs-comment">-- be done if we used TyConApp instead of FunTy. These rewritten</span><span>
</span><span id="line-539"></span><span>          </span><span class="hs-comment">-- representations are seen only in casts of the arg and res, below.</span><span>
</span><span id="line-540"></span><span>          </span><span class="hs-comment">-- Forgetting this caused #19677.</span><span>
</span><span id="line-541"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteM Reduction)
-&gt; Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Role
-&gt; FunTyFlag -&gt; Reduction -&gt; Reduction -&gt; Reduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkFunRedn"><span class="hs-identifier hs-var">mkFunRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006738"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682006723"><span class="hs-identifier hs-var">vis</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006735"><span class="hs-identifier hs-var">w_redn</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006743"><span class="hs-identifier hs-var">casted_arg_redn</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006747"><span class="hs-identifier hs-var">casted_res_redn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-542"></span><span>
</span><span id="line-543"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span id="local-6989586621682006749"><span class="annot"><span class="annottext">ty :: Xi
</span><a href="#local-6989586621682006749"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span class="hs-comment">-- TODO (RAE): This is inadequate, as it doesn't rewrite the kind of</span><span>
</span><span id="line-545"></span><span class="hs-comment">-- the bound tyvar. Doing so will require carrying around a substitution</span><span>
</span><span id="line-546"></span><span class="hs-comment">-- and the usual substTyVarBndr-like silliness. Argh.</span><span>
</span><span id="line-547"></span><span>
</span><span id="line-548"></span><span class="hs-comment">-- We allow for-alls when, but only when, no type function</span><span>
</span><span id="line-549"></span><span class="hs-comment">-- applications inside the forall involve the bound type variables.</span><span>
</span><span id="line-550"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682006751"><span class="annot"><span class="annottext">[TyVarBinder]
</span><a href="#local-6989586621682006751"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006752"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006752"><span class="hs-identifier hs-var">rho</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; ([TyVarBinder], Xi)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitForAllTyVarBinders"><span class="hs-identifier hs-var">tcSplitForAllTyVarBinders</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006749"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-551"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006754"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006754"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006752"><span class="hs-identifier hs-var">rho</span></a></span><span>
</span><span id="line-552"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteM Reduction)
-&gt; Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVarBinder] -&gt; Reduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkHomoForAllRedn"><span class="hs-identifier hs-var">mkHomoForAllRedn</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVarBinder]
</span><a href="#local-6989586621682006751"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006754"><span class="hs-identifier hs-var">redn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CastTy"><span class="hs-identifier hs-type">CastTy</span></a></span><span> </span><span id="local-6989586621682006757"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006757"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621682006758"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006758"><span class="hs-identifier hs-var">g</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-555"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006759"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006759"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006757"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-556"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006760"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006760"><span class="hs-identifier hs-var">g'</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; RewriteM Coercion
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_co"><span class="hs-identifier hs-var">rewrite_co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006758"><span class="hs-identifier hs-var">g</span></a></span><span>
</span><span id="line-557"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006762"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006762"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM Role
</span><a href="GHC.Tc.Solver.Rewrite.html#getRole"><span class="hs-identifier hs-var">getRole</span></a></span><span>
</span><span id="line-558"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteM Reduction)
-&gt; Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Xi -&gt; Coercion -&gt; Reduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkCastRedn1"><span class="hs-identifier hs-var">mkCastRedn1</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006762"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006757"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006760"><span class="hs-identifier hs-var">g'</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006759"><span class="hs-identifier hs-var">redn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-559"></span><span>      </span><span class="hs-comment">-- This calls castCoercionKind1.</span><span>
</span><span id="line-560"></span><span>      </span><span class="hs-comment">-- It makes a /big/ difference to call castCoercionKind1 not</span><span>
</span><span id="line-561"></span><span>      </span><span class="hs-comment">-- the more general castCoercionKind2.</span><span>
</span><span id="line-562"></span><span>      </span><span class="hs-comment">-- See Note [castCoercionKind1] in GHC.Core.Coercion</span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#CoercionTy"><span class="hs-identifier hs-type">CoercionTy</span></a></span><span> </span><span id="local-6989586621682006765"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006765"><span class="hs-identifier hs-var">co</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-565"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006766"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006766"><span class="hs-identifier hs-var">co'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; RewriteM Coercion
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_co"><span class="hs-identifier hs-var">rewrite_co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006765"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-566"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006767"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006767"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM Role
</span><a href="GHC.Tc.Solver.Rewrite.html#getRole"><span class="hs-identifier hs-var">getRole</span></a></span><span>
</span><span id="line-567"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteM Reduction)
-&gt; Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Coercion -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflCoRedn"><span class="hs-identifier hs-var">mkReflCoRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006767"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006766"><span class="hs-identifier hs-var">co'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-568"></span><span>
</span><span id="line-569"></span><span class="hs-comment">-- | &quot;Rewrite&quot; a coercion. Really, just zonk it so we can uphold</span><span>
</span><span id="line-570"></span><span class="hs-comment">-- (F1) of Note [Rewriting]</span><span>
</span><span id="line-571"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_co"><span class="hs-identifier hs-type">rewrite_co</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a></span><span>
</span><span id="line-572"></span><span id="rewrite_co"><span class="annot"><span class="annottext">rewrite_co :: Coercion -&gt; RewriteM Coercion
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_co"><span class="hs-identifier hs-var hs-var">rewrite_co</span></a></span></span><span> </span><span id="local-6989586621682006769"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006769"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcS Coercion -&gt; RewriteM Coercion
forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var">liftTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS Coercion -&gt; RewriteM Coercion)
-&gt; TcS Coercion -&gt; RewriteM Coercion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; TcS Coercion
</span><a href="GHC.Tc.Solver.Monad.html#zonkCo"><span class="hs-identifier hs-var">zonkCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006769"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span class="annot"><span class="hs-comment">-- | Rewrite a reduction, composing the resulting coercions.</span></span><span>
</span><span id="line-575"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_reduction"><span class="hs-identifier hs-type">rewrite_reduction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-576"></span><span id="rewrite_reduction"><span class="annot"><span class="annottext">rewrite_reduction :: Reduction -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_reduction"><span class="hs-identifier hs-var hs-var">rewrite_reduction</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span id="local-6989586621682006772"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006772"><span class="hs-identifier hs-var">co</span></a></span></span><span> </span><span id="local-6989586621682006773"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006773"><span class="hs-identifier hs-var">xi</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-577"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006774"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006774"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM Reduction -&gt; RewriteM Reduction
forall a. RewriteM a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#bumpDepth"><span class="hs-identifier hs-var">bumpDepth</span></a></span><span> </span><span class="annot"><span class="annottext">(RewriteM Reduction -&gt; RewriteM Reduction)
-&gt; RewriteM Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006773"><span class="hs-identifier hs-var">xi</span></a></span><span>
</span><span id="line-578"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteM Reduction)
-&gt; Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006772"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Reduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkTransRedn"><span class="hs-operator hs-var">`mkTransRedn`</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006774"><span class="hs-identifier hs-var">redn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span class="hs-comment">-- rewrite (nested) AppTys</span><span>
</span><span id="line-581"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_app_tys"><span class="hs-identifier hs-type">rewrite_app_tys</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-582"></span><span class="hs-comment">-- commoning up nested applications allows us to look up the function's kind</span><span>
</span><span id="line-583"></span><span class="hs-comment">-- only once. Without commoning up like this, we would spend a quadratic amount</span><span>
</span><span id="line-584"></span><span class="hs-comment">-- of time looking up functions' types</span><span>
</span><span id="line-585"></span><span id="rewrite_app_tys"><span class="annot"><span class="annottext">rewrite_app_tys :: Xi -&gt; [Xi] -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_app_tys"><span class="hs-identifier hs-var hs-var">rewrite_app_tys</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#AppTy"><span class="hs-identifier hs-type">AppTy</span></a></span><span> </span><span id="local-6989586621682006776"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006776"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621682006777"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006777"><span class="hs-identifier hs-var">ty2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682006778"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006778"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; [Xi] -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_app_tys"><span class="hs-identifier hs-var">rewrite_app_tys</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006776"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006777"><span class="hs-identifier hs-var">ty2</span></a></span><span class="annot"><span class="annottext">Xi -&gt; [Xi] -&gt; [Xi]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006778"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_app_tys"><span class="hs-identifier hs-var">rewrite_app_tys</span></a></span><span> </span><span id="local-6989586621682006779"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006779"><span class="hs-identifier hs-var">fun_ty</span></a></span></span><span> </span><span id="local-6989586621682006780"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006780"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span>
</span><span id="line-587"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006781"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006781"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_one"><span class="hs-identifier hs-var">rewrite_one</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006779"><span class="hs-identifier hs-var">fun_ty</span></a></span><span>
</span><span id="line-588"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; [Xi] -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_app_ty_args"><span class="hs-identifier hs-var">rewrite_app_ty_args</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006781"><span class="hs-identifier hs-var">redn</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006780"><span class="hs-identifier hs-var">arg_tys</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span class="hs-comment">-- Given a rewritten function (with the coercion produced by rewriting) and</span><span>
</span><span id="line-591"></span><span class="hs-comment">-- a bunch of unrewritten arguments, rewrite the arguments and apply.</span><span>
</span><span id="line-592"></span><span class="hs-comment">-- The coercion argument's role matches the role stored in the RewriteM monad.</span><span>
</span><span id="line-593"></span><span class="hs-comment">--</span><span>
</span><span id="line-594"></span><span class="hs-comment">-- The bang patterns used here were observed to improve performance. If you</span><span>
</span><span id="line-595"></span><span class="hs-comment">-- wish to remove them, be sure to check for regressions in allocations.</span><span>
</span><span id="line-596"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_app_ty_args"><span class="hs-identifier hs-type">rewrite_app_ty_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-597"></span><span id="rewrite_app_ty_args"><span class="annot"><span class="annottext">rewrite_app_ty_args :: Reduction -&gt; [Xi] -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_app_ty_args"><span class="hs-identifier hs-var hs-var">rewrite_app_ty_args</span></a></span></span><span> </span><span id="local-6989586621682006783"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006783"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-598"></span><span>  </span><span class="hs-comment">-- this will be a common case when called from rewrite_fam_app, so shortcut</span><span>
</span><span id="line-599"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006783"><span class="hs-identifier hs-var">redn</span></a></span><span>
</span><span id="line-600"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_app_ty_args"><span class="hs-identifier hs-var">rewrite_app_ty_args</span></a></span><span> </span><span id="local-6989586621682006784"><span class="annot"><span class="annottext">fun_redn :: Reduction
</span><a href="#local-6989586621682006784"><span class="hs-identifier hs-var">fun_redn</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span id="local-6989586621682006785"><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006785"><span class="hs-identifier hs-var">fun_co</span></a></span></span><span> </span><span id="local-6989586621682006786"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006786"><span class="hs-identifier hs-var">fun_xi</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682006787"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006787"><span class="hs-identifier hs-var">arg_tys</span></a></span></span><span>
</span><span id="line-601"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006788"><span class="annot"><span class="annottext">HetReduction
</span><a href="#local-6989586621682006788"><span class="hs-identifier hs-var">het_redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Xi -&gt; Maybe (TyCon, [Xi])
Xi -&gt; Maybe (TyCon, [Xi])
</span><a href="GHC.Core.Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006786"><span class="hs-identifier hs-var">fun_xi</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-602"></span><span>           </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682006790"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006790"><span class="hs-identifier hs-var">tc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006791"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006791"><span class="hs-identifier hs-var">xis</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-603"></span><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682006792"><span class="annot"><span class="annottext">tc_roles :: Infinite Role
</span><a href="#local-6989586621682006792"><span class="hs-identifier hs-var hs-var">tc_roles</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Infinite Role
</span><a href="GHC.Core.Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006790"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-604"></span><span>                      </span><span id="local-6989586621682006794"><span class="annot"><span class="annottext">arg_roles :: Infinite Role
</span><a href="#local-6989586621682006794"><span class="hs-identifier hs-var hs-var">arg_roles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Xi] -&gt; Infinite Role -&gt; Infinite Role
forall a b. [a] -&gt; Infinite b -&gt; Infinite b
</span><a href="GHC.Data.List.Infinite.html#dropList"><span class="hs-identifier hs-var">Inf.dropList</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006791"><span class="hs-identifier hs-var">xis</span></a></span><span> </span><span class="annot"><span class="annottext">Infinite Role
</span><a href="#local-6989586621682006792"><span class="hs-identifier hs-var">tc_roles</span></a></span><span>
</span><span id="line-605"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reductions"><span class="hs-identifier hs-type">Reductions</span></a></span><span> </span><span id="local-6989586621682006796"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682006796"><span class="hs-identifier hs-var">arg_cos</span></a></span></span><span> </span><span id="local-6989586621682006797"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006797"><span class="hs-identifier hs-var">arg_xis</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682006798"><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682006798"><span class="hs-identifier hs-var">kind_co</span></a></span></span><span>
</span><span id="line-606"></span><span>                    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; Infinite Role -&gt; [Xi] -&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_vector"><span class="hs-identifier hs-var">rewrite_vector</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Xi -&gt; Xi
Xi -&gt; Xi
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006786"><span class="hs-identifier hs-var">fun_xi</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Infinite Role
</span><a href="#local-6989586621682006794"><span class="hs-identifier hs-var">arg_roles</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006787"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-607"></span><span>
</span><span id="line-608"></span><span>                  </span><span class="hs-comment">-- We start with a reduction of the form</span><span>
</span><span id="line-609"></span><span>                  </span><span class="hs-comment">--   fun_co :: ty ~ T xi_1 ... xi_n</span><span>
</span><span id="line-610"></span><span>                  </span><span class="hs-comment">-- and further arguments a_1, ..., a_m.</span><span>
</span><span id="line-611"></span><span>                  </span><span class="hs-comment">-- We rewrite these arguments, and obtain coercions:</span><span>
</span><span id="line-612"></span><span>                  </span><span class="hs-comment">--   arg_co_i :: a_i ~ zeta_i</span><span>
</span><span id="line-613"></span><span>                  </span><span class="hs-comment">-- Now, we need to apply fun_co to the arg_cos. The problem is</span><span>
</span><span id="line-614"></span><span>                  </span><span class="hs-comment">-- that using mkAppCo is wrong because that function expects</span><span>
</span><span id="line-615"></span><span>                  </span><span class="hs-comment">-- its second coercion to be Nominal, and the arg_cos might</span><span>
</span><span id="line-616"></span><span>                  </span><span class="hs-comment">-- not be. The solution is to use transitivity:</span><span>
</span><span id="line-617"></span><span>                  </span><span class="hs-comment">-- fun_co &lt;a_1&gt; ... &lt;a_m&gt; ;; T &lt;xi_1&gt; .. &lt;xi_n&gt; arg_co_1 ... arg_co_m</span><span>
</span><span id="line-618"></span><span>                </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006801"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006801"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM EqRel
</span><a href="GHC.Tc.Solver.Rewrite.html#getEqRel"><span class="hs-identifier hs-var">getEqRel</span></a></span><span>
</span><span id="line-619"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682006802"><span class="annot"><span class="annottext">app_xi :: Xi
</span><a href="#local-6989586621682006802"><span class="hs-identifier hs-var hs-var">app_xi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Xi] -&gt; Xi
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006790"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006791"><span class="hs-identifier hs-var">xis</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi] -&gt; [Xi] -&gt; [Xi]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006797"><span class="hs-identifier hs-var">arg_xis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-620"></span><span>                      </span><span id="local-6989586621682006804"><span class="annot"><span class="annottext">app_co :: Coercion
</span><a href="#local-6989586621682006804"><span class="hs-identifier hs-var hs-var">app_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006801"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-621"></span><span>                        </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkAppCos"><span class="hs-identifier hs-var">mkAppCos</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006785"><span class="hs-identifier hs-var">fun_co</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682006796"><span class="hs-identifier hs-var">arg_cos</span></a></span><span>
</span><span id="line-622"></span><span>                        </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkAppCos"><span class="hs-identifier hs-var">mkAppCos</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006785"><span class="hs-identifier hs-var">fun_co</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Xi -&gt; Coercion) -&gt; [Xi] -&gt; [Coercion]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Xi -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006787"><span class="hs-identifier hs-var">arg_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-623"></span><span>                                  </span><span class="annot"><span class="annottext">Coercion -&gt; Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTransCo"><span class="hs-operator hs-var">`mkTransCo`</span></a></span><span>
</span><span id="line-624"></span><span>                                  </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Representational"><span class="hs-identifier hs-var">Representational</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006790"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-625"></span><span>                                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Role -&gt; Xi -&gt; Coercion) -&gt; [Role] -&gt; [Xi] -&gt; [Coercion]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#zipWith/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Xi -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Infinite Role -&gt; [Role]
forall a. Infinite a -&gt; [a]
</span><a href="GHC.Data.List.Infinite.html#toList"><span class="hs-identifier hs-var">Inf.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Infinite Role
</span><a href="#local-6989586621682006792"><span class="hs-identifier hs-var">tc_roles</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006791"><span class="hs-identifier hs-var">xis</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion] -&gt; [Coercion] -&gt; [Coercion]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682006796"><span class="hs-identifier hs-var">arg_cos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>
</span><span id="line-627"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">HetReduction -&gt; RewriteM HetReduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(HetReduction -&gt; RewriteM HetReduction)
-&gt; HetReduction -&gt; RewriteM HetReduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-628"></span><span>                    </span><span class="annot"><span class="annottext">Reduction -&gt; MCoercionN -&gt; HetReduction
</span><a href="GHC.Core.Reduction.html#mkHetReduction"><span class="hs-identifier hs-var">mkHetReduction</span></a></span><span>
</span><span id="line-629"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion -&gt; Xi -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReduction"><span class="hs-identifier hs-var">mkReduction</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006804"><span class="hs-identifier hs-var">app_co</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006802"><span class="hs-identifier hs-var">app_xi</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-630"></span><span>                      </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682006798"><span class="hs-identifier hs-var">kind_co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-631"></span><span>           </span><span class="annot"><span class="annottext">Maybe (TyCon, [Xi])
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-632"></span><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span> </span><span id="local-6989586621682006812"><span class="annot"><span class="annottext">Reductions
</span><a href="#local-6989586621682006812"><span class="hs-identifier hs-var">redns</span></a></span></span><span> </span><span id="local-6989586621682006813"><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682006813"><span class="hs-identifier hs-var">kind_co</span></a></span></span><span>
</span><span id="line-633"></span><span>                    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; Infinite Role -&gt; [Xi] -&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_vector"><span class="hs-identifier hs-var">rewrite_vector</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Xi -&gt; Xi
Xi -&gt; Xi
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006786"><span class="hs-identifier hs-var">fun_xi</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Infinite Role
forall a. a -&gt; Infinite a
</span><a href="GHC.Data.List.Infinite.html#repeat"><span class="hs-identifier hs-var">Inf.repeat</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006787"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-634"></span><span>                </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">HetReduction -&gt; RewriteM HetReduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(HetReduction -&gt; RewriteM HetReduction)
-&gt; HetReduction -&gt; RewriteM HetReduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; MCoercionN -&gt; HetReduction
</span><a href="GHC.Core.Reduction.html#mkHetReduction"><span class="hs-identifier hs-var">mkHetReduction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reduction -&gt; Reductions -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkAppRedns"><span class="hs-identifier hs-var">mkAppRedns</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006784"><span class="hs-identifier hs-var">fun_redn</span></a></span><span> </span><span class="annot"><span class="annottext">Reductions
</span><a href="#local-6989586621682006812"><span class="hs-identifier hs-var">redns</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682006813"><span class="hs-identifier hs-var">kind_co</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-635"></span><span>
</span><span id="line-636"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006815"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006815"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM Role
</span><a href="GHC.Tc.Solver.Rewrite.html#getRole"><span class="hs-identifier hs-var">getRole</span></a></span><span>
</span><span id="line-637"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; HetReduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#homogeniseHetRedn"><span class="hs-identifier hs-var">homogeniseHetRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006815"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">HetReduction
</span><a href="#local-6989586621682006788"><span class="hs-identifier hs-var">het_redn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-638"></span><span>
</span><span id="line-639"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_ty_con_app"><span class="hs-identifier hs-type">rewrite_ty_con_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-640"></span><span id="rewrite_ty_con_app"><span class="annot"><span class="annottext">rewrite_ty_con_app :: TyCon -&gt; [Xi] -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_ty_con_app"><span class="hs-identifier hs-var hs-var">rewrite_ty_con_app</span></a></span></span><span> </span><span id="local-6989586621682006817"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006817"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682006818"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006818"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-641"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006819"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006819"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM Role
</span><a href="GHC.Tc.Solver.Rewrite.html#getRole"><span class="hs-identifier hs-var">getRole</span></a></span><span>
</span><span id="line-642"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682006820"><span class="annot"><span class="annottext">m_roles :: Maybe (Infinite Role)
</span><a href="#local-6989586621682006820"><span class="hs-identifier hs-var hs-var">m_roles</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Language.Haskell.Syntax.Basic.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006819"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Infinite Role)
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-643"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Infinite Role -&gt; Maybe (Infinite Role)
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Infinite Role -&gt; Maybe (Infinite Role))
-&gt; Infinite Role -&gt; Maybe (Infinite Role)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; TyCon -&gt; Infinite Role
</span><a href="GHC.Core.Coercion.html#tyConRolesX"><span class="hs-identifier hs-var">tyConRolesX</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006819"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006817"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-644"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span> </span><span id="local-6989586621682006822"><span class="annot"><span class="annottext">Reductions
</span><a href="#local-6989586621682006822"><span class="hs-identifier hs-var">redns</span></a></span></span><span> </span><span id="local-6989586621682006823"><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682006823"><span class="hs-identifier hs-var">kind_co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe (Infinite Role) -&gt; [Xi] -&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_tc"><span class="hs-identifier hs-var">rewrite_args_tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006817"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Infinite Role)
</span><a href="#local-6989586621682006820"><span class="hs-identifier hs-var">m_roles</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006818"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-645"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682006824"><span class="annot"><span class="annottext">tyconapp_redn :: HetReduction
</span><a href="#local-6989586621682006824"><span class="hs-identifier hs-var hs-var">tyconapp_redn</span></a></span></span><span>
</span><span id="line-646"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; MCoercionN -&gt; HetReduction
</span><a href="GHC.Core.Reduction.html#mkHetReduction"><span class="hs-identifier hs-var">mkHetReduction</span></a></span><span>
</span><span id="line-647"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TyCon -&gt; Reductions -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkTyConAppRedn"><span class="hs-identifier hs-var">mkTyConAppRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006819"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006817"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Reductions
</span><a href="#local-6989586621682006822"><span class="hs-identifier hs-var">redns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-648"></span><span>                    </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682006823"><span class="hs-identifier hs-var">kind_co</span></a></span><span>
</span><span id="line-649"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteM Reduction)
-&gt; Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; HetReduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#homogeniseHetRedn"><span class="hs-identifier hs-var">homogeniseHetRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006819"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">HetReduction
</span><a href="#local-6989586621682006824"><span class="hs-identifier hs-var">tyconapp_redn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-650"></span><span>
</span><span id="line-651"></span><span class="hs-comment">-- Rewrite a vector (list of arguments).</span><span>
</span><span id="line-652"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_vector"><span class="hs-identifier hs-type">rewrite_vector</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a></span><span>   </span><span class="hs-comment">-- of the function being applied to these arguments</span><span>
</span><span id="line-653"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.List.Infinite.html#Infinite"><span class="hs-identifier hs-type">Infinite</span></a></span><span> </span><span class="annot"><a href="Language.Haskell.Syntax.Basic.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-comment">-- If we're rewriting w.r.t. ReprEq, what roles do the</span><span>
</span><span id="line-654"></span><span>                         </span><span class="hs-comment">-- args have?</span><span>
</span><span id="line-655"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- the args to rewrite</span><span>
</span><span id="line-656"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span>
</span><span id="line-657"></span><span id="rewrite_vector"><span class="annot"><span class="annottext">rewrite_vector :: Xi -&gt; Infinite Role -&gt; [Xi] -&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_vector"><span class="hs-identifier hs-var hs-var">rewrite_vector</span></a></span></span><span> </span><span id="local-6989586621682006826"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006826"><span class="hs-identifier hs-var">ki</span></a></span></span><span> </span><span id="local-6989586621682006827"><span class="annot"><span class="annottext">Infinite Role
</span><a href="#local-6989586621682006827"><span class="hs-identifier hs-var">roles</span></a></span></span><span> </span><span id="local-6989586621682006828"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006828"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-658"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006829"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006829"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM EqRel
</span><a href="GHC.Tc.Solver.Rewrite.html#getEqRel"><span class="hs-identifier hs-var">getEqRel</span></a></span><span>
</span><span id="line-659"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682006830"><span class="annot"><span class="annottext">mb_roles :: Maybe (Infinite Role)
</span><a href="#local-6989586621682006830"><span class="hs-identifier hs-var hs-var">mb_roles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006829"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Infinite Role)
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Infinite Role -&gt; Maybe (Infinite Role)
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Infinite Role
</span><a href="#local-6989586621682006827"><span class="hs-identifier hs-var">roles</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-660"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
-&gt; Bool
-&gt; Xi
-&gt; TcTyCoVarSet
-&gt; Maybe (Infinite Role)
-&gt; [Xi]
-&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args"><span class="hs-identifier hs-var">rewrite_args</span></a></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006831"><span class="hs-identifier hs-var">bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006832"><span class="hs-identifier hs-var">any_named_bndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006833"><span class="hs-identifier hs-var">inner_ki</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyCoVarSet
</span><a href="#local-6989586621682006834"><span class="hs-identifier hs-var">fvs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Infinite Role)
</span><a href="#local-6989586621682006830"><span class="hs-identifier hs-var">mb_roles</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006828"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-661"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-663"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621682006831"><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006831"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006833"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006833"><span class="hs-identifier hs-var">inner_ki</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006832"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006832"><span class="hs-identifier hs-var">any_named_bndrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; ([PiTyBinder], Xi, Bool)
</span><a href="GHC.Tc.Solver.Rewrite.html#split_pi_tys%27"><span class="hs-identifier hs-var">split_pi_tys'</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006826"><span class="hs-identifier hs-var">ki</span></a></span><span>
</span><span id="line-664"></span><span>    </span><span id="local-6989586621682006834"><span class="annot"><span class="annottext">fvs :: TcTyCoVarSet
</span><a href="#local-6989586621682006834"><span class="hs-identifier hs-var hs-var">fvs</span></a></span></span><span>                                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; TcTyCoVarSet
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006826"><span class="hs-identifier hs-var">ki</span></a></span><span>
</span><span id="line-665"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_vector"><span class="hs-pragma hs-type">rewrite_vector</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-666"></span><span>
</span><span id="line-667"></span><span>
</span><span id="line-668"></span><span class="hs-comment">{- Note [Do not rewrite newtypes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We flirted with unwrapping newtypes in the rewriter -- see GHC.Tc.Solver.Canonical
Note [Unwrap newtypes first]. But that turned out to be a bad idea because
of recursive newtypes, as that Note says.  So be careful if you re-add it!

Note [Rewriting synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Not expanding synonyms aggressively improves error messages, and
keeps types smaller. But we need to take care.

Suppose
   type Syn a = Int
   type instance F Bool = Syn (F Bool)
   [G] F Bool ~ Syn (F Bool)

If we don't expand the synonym, we'll get a spurious occurs-check
failure. This is normally what occCheckExpand takes care of, but
the LHS is a type family application, and occCheckExpand (already
complex enough as it is) does not know how to expand to avoid
a type family application.

In addition, expanding the forgetful synonym like this
will generally yield a *smaller* type. To wit, if we spot
S ( ... F tys ... ), where S is forgetful, we don't want to bother
doing hard work simplifying (F tys). We thus expand forgetful
synonyms, but not others.

isForgetfulSynTyCon returns True more often than it needs to, so
we err on the side of more expansion.

We also, of course, must expand type synonyms that mention type families,
so those families can get reduced.

************************************************************************
*                                                                      *
             Rewriting a type-family application
*                                                                      *
************************************************************************

Note [How to normalise a family application]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Given an exactly saturated family application, how should we normalise it?
This Note spells out the algorithm and its reasoning.

First, we attempt to directly rewrite the type family application,
without simplifying any of the arguments first, in an attempt to avoid
doing unnecessary work.

STEP 1a. Call the rewriting plugins. If any plugin rewrites the type family
application, jump to FINISH.

STEP 1b. Try the famapp-cache. If we get a cache hit, jump to FINISH.

STEP 1c. Try top-level instances. Remember: we haven't simplified the arguments
  yet. Example:
    type instance F (Maybe a) = Int
    target: F (Maybe (G Bool))
  Instead of first trying to simplify (G Bool), we use the instance first. This
  avoids the work of simplifying G Bool.

  If an instance is found, jump to FINISH.

STEP 2: At this point we rewrite all arguments. This might expose more
  information, which might allow plugins to make progress, or allow us to
  pick up a top-level instance.

STEP 3. Try the inerts. Note that we try the inerts *after* rewriting the
  arguments, because the inerts will have rewritten LHSs.

  If an inert is found, jump to FINISH.

Next, we try STEP 1 again, as we might be able to make further progress after
having rewritten the arguments:

STEP 4a. Query the rewriting plugins again.

  If any plugin supplies a rewriting, jump to FINISH.

STEP 4b. Try the famapp-cache again.

  If we get a cache hit, jump to FINISH.

STEP 4c. Try top-level instances again.

  If an instance is found, jump to FINISH.

STEP 5: GIVEUP. No progress to be made. Return what we have. (Do not FINISH.)

FINISH 1. We've made a reduction, but the new type may still have more
  work to do. So rewrite the new type.

FINISH 2. Add the result to the famapp-cache, connecting the type we started
  with to the one we ended with.

Because STEP 1{a,b,c} and STEP 4{a,b,c} happen the same way, they are abstracted into
try_to_reduce.

FINISH is naturally implemented in `finish`. But, Note [rewrite_exact_fam_app performance]
tells us that we should not add to the famapp-cache after STEP 1. So `finish`
is inlined in that case, and only FINISH 1 is performed.

-}</span><span>
</span><span id="line-771"></span><span>
</span><span id="line-772"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_fam_app"><span class="hs-identifier hs-type">rewrite_fam_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-773"></span><span>  </span><span class="hs-comment">--   rewrite_fam_app            can be over-saturated</span><span>
</span><span id="line-774"></span><span>  </span><span class="hs-comment">--   rewrite_exact_fam_app      lifts out the application to top level</span><span>
</span><span id="line-775"></span><span>  </span><span class="hs-comment">-- Postcondition: Coercion :: Xi ~ F tys</span><span>
</span><span id="line-776"></span><span id="rewrite_fam_app"><span class="annot"><span class="annottext">rewrite_fam_app :: TyCon -&gt; [Xi] -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_fam_app"><span class="hs-identifier hs-var hs-var">rewrite_fam_app</span></a></span></span><span> </span><span id="local-6989586621682006836"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006836"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682006837"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006837"><span class="hs-identifier hs-var">tys</span></a></span></span><span>  </span><span class="hs-comment">-- Can be over-saturated</span><span>
</span><span id="line-777"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; RewriteM Reduction -&gt; RewriteM Reduction
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006837"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi] -&gt; Arity -&gt; Bool
forall a. [a] -&gt; Arity -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthAtLeast"><span class="hs-operator hs-var">`lengthAtLeast`</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Arity
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006836"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-778"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006836"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Arity -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Arity
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006836"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006837"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RewriteM Reduction -&gt; RewriteM Reduction)
-&gt; RewriteM Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-779"></span><span>
</span><span id="line-780"></span><span>                 </span><span class="hs-comment">-- Type functions are saturated</span><span>
</span><span id="line-781"></span><span>                 </span><span class="hs-comment">-- The type function might be *over* saturated</span><span>
</span><span id="line-782"></span><span>                 </span><span class="hs-comment">-- in which case the remaining arguments should</span><span>
</span><span id="line-783"></span><span>                 </span><span class="hs-comment">-- be dealt with by AppTys</span><span>
</span><span id="line-784"></span><span>      </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682006842"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006842"><span class="hs-identifier hs-var">tys1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006843"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006843"><span class="hs-identifier hs-var">tys_rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Arity -&gt; [Xi] -&gt; ([Xi], [Xi])
forall a. Arity -&gt; [a] -&gt; ([a], [a])
</span><a href="../../base-4.18.3.0/src/GHC.List.html#splitAt/GHC.List.html#splitAt"><span class="hs-identifier hs-var">splitAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; Arity
</span><a href="GHC.Core.TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006836"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006837"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-785"></span><span>         </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006845"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006845"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Xi] -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_exact_fam_app"><span class="hs-identifier hs-var">rewrite_exact_fam_app</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006836"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006842"><span class="hs-identifier hs-var">tys1</span></a></span><span>
</span><span id="line-786"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; [Xi] -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_app_ty_args"><span class="hs-identifier hs-var">rewrite_app_ty_args</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006845"><span class="hs-identifier hs-var">redn</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006843"><span class="hs-identifier hs-var">tys_rest</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-787"></span><span>
</span><span id="line-788"></span><span class="hs-comment">-- the [TcType] exactly saturate the TyCon</span><span>
</span><span id="line-789"></span><span class="hs-comment">-- See Note [How to normalise a family application]</span><span>
</span><span id="line-790"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_exact_fam_app"><span class="hs-identifier hs-type">rewrite_exact_fam_app</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-791"></span><span id="rewrite_exact_fam_app"><span class="annot"><span class="annottext">rewrite_exact_fam_app :: TyCon -&gt; [Xi] -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_exact_fam_app"><span class="hs-identifier hs-var hs-var">rewrite_exact_fam_app</span></a></span></span><span> </span><span id="local-6989586621682006847"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006847"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682006848"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006848"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-792"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; RewriteM ()
</span><a href="GHC.Tc.Solver.Rewrite.html#checkStackDepth"><span class="hs-identifier hs-var">checkStackDepth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [Xi] -&gt; Xi
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006847"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006848"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-793"></span><span>
</span><span id="line-794"></span><span>       </span><span class="hs-comment">-- Query the typechecking plugins for all their rewriting functions</span><span>
</span><span id="line-795"></span><span>       </span><span class="hs-comment">-- which apply to a type family application headed by the TyCon 'tc'.</span><span>
</span><span id="line-796"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006849"><span class="annot"><span class="annottext">[TcPluginRewriter]
</span><a href="#local-6989586621682006849"><span class="hs-identifier hs-var">tc_rewriters</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; RewriteM [TcPluginRewriter]
</span><a href="GHC.Tc.Solver.Rewrite.html#getTcPluginRewritersForTyCon"><span class="hs-identifier hs-var">getTcPluginRewritersForTyCon</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006847"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-797"></span><span>
</span><span id="line-798"></span><span>       </span><span class="hs-comment">-- STEP 1. Try to reduce without reducing arguments first.</span><span>
</span><span id="line-799"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006851"><span class="annot"><span class="annottext">Maybe Reduction
</span><a href="#local-6989586621682006851"><span class="hs-identifier hs-var">result1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Xi] -&gt; [TcPluginRewriter] -&gt; RewriteM (Maybe Reduction)
</span><a href="GHC.Tc.Solver.Rewrite.html#try_to_reduce"><span class="hs-identifier hs-var">try_to_reduce</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006847"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006848"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPluginRewriter]
</span><a href="#local-6989586621682006849"><span class="hs-identifier hs-var">tc_rewriters</span></a></span><span>
</span><span id="line-800"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Reduction
</span><a href="#local-6989586621682006851"><span class="hs-identifier hs-var">result1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-801"></span><span>             </span><span class="hs-comment">-- Don't use the cache;</span><span>
</span><span id="line-802"></span><span>             </span><span class="hs-comment">-- See Note [rewrite_exact_fam_app performance]</span><span>
</span><span id="line-803"></span><span>         </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682006853"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006853"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Reduction -&gt; RewriteM Reduction
</span><a href="#local-6989586621682006854"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006853"><span class="hs-identifier hs-var">redn</span></a></span><span>
</span><span id="line-804"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Maybe Reduction
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-805"></span><span>
</span><span id="line-806"></span><span>        </span><span class="hs-comment">-- That didn't work. So reduce the arguments, in STEP 2.</span><span>
</span><span id="line-807"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006855"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006855"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM EqRel
</span><a href="GHC.Tc.Solver.Rewrite.html#getEqRel"><span class="hs-identifier hs-var">getEqRel</span></a></span><span>
</span><span id="line-808"></span><span>          </span><span class="hs-comment">-- checking eq_rel == NomEq saves ~0.5% in T9872a</span><span>
</span><span id="line-809"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#ArgsReductions"><span class="hs-identifier hs-type">ArgsReductions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Reduction.html#Reductions"><span class="hs-identifier hs-type">Reductions</span></a></span><span> </span><span id="local-6989586621682006856"><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682006856"><span class="hs-identifier hs-var">cos</span></a></span></span><span> </span><span id="local-6989586621682006857"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006857"><span class="hs-identifier hs-var">xis</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621682006858"><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682006858"><span class="hs-identifier hs-var">kind_co</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-810"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006855"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; EqRel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span>
</span><span id="line-811"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe (Infinite Role) -&gt; [Xi] -&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_tc"><span class="hs-identifier hs-var">rewrite_args_tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006847"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Infinite Role)
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006848"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-812"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; RewriteM ArgsReductions -&gt; RewriteM ArgsReductions
forall a. EqRel -&gt; RewriteM a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#setEqRel"><span class="hs-identifier hs-var">setEqRel</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span> </span><span class="annot"><span class="annottext">(RewriteM ArgsReductions -&gt; RewriteM ArgsReductions)
-&gt; RewriteM ArgsReductions -&gt; RewriteM ArgsReductions
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-813"></span><span>                 </span><span class="annot"><span class="annottext">TyCon -&gt; Maybe (Infinite Role) -&gt; [Xi] -&gt; RewriteM ArgsReductions
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_args_tc"><span class="hs-identifier hs-var">rewrite_args_tc</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006847"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Infinite Role)
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006848"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-814"></span><span>
</span><span id="line-815"></span><span>         </span><span class="hs-comment">-- If we manage to rewrite the type family application after</span><span>
</span><span id="line-816"></span><span>         </span><span class="hs-comment">-- rewriting the arguments, we will need to compose these</span><span>
</span><span id="line-817"></span><span>         </span><span class="hs-comment">-- reductions.</span><span>
</span><span id="line-818"></span><span>         </span><span class="hs-comment">--</span><span>
</span><span id="line-819"></span><span>         </span><span class="hs-comment">-- We have:</span><span>
</span><span id="line-820"></span><span>         </span><span class="hs-comment">--</span><span>
</span><span id="line-821"></span><span>         </span><span class="hs-comment">--   arg_co_i :: ty_i ~ xi_i</span><span>
</span><span id="line-822"></span><span>         </span><span class="hs-comment">--   fam_co :: F xi_1 ... xi_n ~ zeta</span><span>
</span><span id="line-823"></span><span>         </span><span class="hs-comment">--</span><span>
</span><span id="line-824"></span><span>         </span><span class="hs-comment">-- The full reduction is obtained as a composite:</span><span>
</span><span id="line-825"></span><span>         </span><span class="hs-comment">--</span><span>
</span><span id="line-826"></span><span>         </span><span class="hs-comment">--   full_co :: F ty_1 ... ty_n ~ zeta</span><span>
</span><span id="line-827"></span><span>         </span><span class="hs-comment">--   full_co = F co_1 ... co_n ;; fam_co</span><span>
</span><span id="line-828"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-829"></span><span>           </span><span id="local-6989586621682006859"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621682006859"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006855"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-830"></span><span>           </span><span id="local-6989586621682006860"><span class="annot"><span class="annottext">args_co :: Coercion
</span><a href="#local-6989586621682006860"><span class="hs-identifier hs-var hs-var">args_co</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
Role -&gt; TyCon -&gt; [Coercion] -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006859"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006847"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Coercion]
</span><a href="#local-6989586621682006856"><span class="hs-identifier hs-var">cos</span></a></span><span>
</span><span id="line-831"></span><span>       </span><span class="hs-special">;</span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621682006861"><span class="hs-identifier hs-type">homogenise</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-832"></span><span>              </span><span id="local-6989586621682006861"><span class="annot"><span class="annottext">homogenise :: Reduction -&gt; Reduction
</span><a href="#local-6989586621682006861"><span class="hs-identifier hs-var hs-var">homogenise</span></a></span></span><span> </span><span id="local-6989586621682006862"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006862"><span class="hs-identifier hs-var">redn</span></a></span></span><span>
</span><span id="line-833"></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; HetReduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#homogeniseHetRedn"><span class="hs-identifier hs-var">homogeniseHetRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006859"><span class="hs-keyword hs-var">role</span></a></span><span>
</span><span id="line-834"></span><span>                </span><span class="annot"><span class="annottext">(HetReduction -&gt; Reduction) -&gt; HetReduction -&gt; Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; MCoercionN -&gt; HetReduction
</span><a href="GHC.Core.Reduction.html#mkHetReduction"><span class="hs-identifier hs-var">mkHetReduction</span></a></span><span>
</span><span id="line-835"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006860"><span class="hs-identifier hs-var">args_co</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Reduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkTransRedn"><span class="hs-operator hs-var">`mkTransRedn`</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006862"><span class="hs-identifier hs-var">redn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-836"></span><span>                    </span><span class="annot"><span class="annottext">MCoercionN
</span><a href="#local-6989586621682006858"><span class="hs-identifier hs-var">kind_co</span></a></span><span>
</span><span id="line-837"></span><span>
</span><span id="line-838"></span><span>              </span><span class="annot"><a href="#local-6989586621682006863"><span class="hs-identifier hs-type">give_up</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-839"></span><span>              </span><span id="local-6989586621682006863"><span class="annot"><span class="annottext">give_up :: Reduction
</span><a href="#local-6989586621682006863"><span class="hs-identifier hs-var hs-var">give_up</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; Reduction
</span><a href="#local-6989586621682006861"><span class="hs-identifier hs-var">homogenise</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; Reduction) -&gt; Reduction -&gt; Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Xi -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006859"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006864"><span class="hs-identifier hs-var">reduced</span></a></span><span>
</span><span id="line-840"></span><span>                </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621682006864"><span class="annot"><span class="annottext">reduced :: Xi
</span><a href="#local-6989586621682006864"><span class="hs-identifier hs-var hs-var">reduced</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Xi] -&gt; Xi
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006847"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006857"><span class="hs-identifier hs-var">xis</span></a></span><span>
</span><span id="line-841"></span><span>
</span><span id="line-842"></span><span>         </span><span class="hs-comment">-- STEP 3: try the inerts</span><span>
</span><span id="line-843"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006865"><span class="annot"><span class="annottext">CtFlavour
</span><a href="#local-6989586621682006865"><span class="hs-identifier hs-var">flavour</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM CtFlavour
</span><a href="GHC.Tc.Solver.Rewrite.html#getFlavour"><span class="hs-identifier hs-var">getFlavour</span></a></span><span>
</span><span id="line-844"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006866"><span class="annot"><span class="annottext">Maybe (Reduction, CtFlavourRole)
</span><a href="#local-6989586621682006866"><span class="hs-identifier hs-var">result2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS (Maybe (Reduction, CtFlavourRole))
-&gt; RewriteM (Maybe (Reduction, CtFlavourRole))
forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var">liftTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS (Maybe (Reduction, CtFlavourRole))
 -&gt; RewriteM (Maybe (Reduction, CtFlavourRole)))
-&gt; TcS (Maybe (Reduction, CtFlavourRole))
-&gt; RewriteM (Maybe (Reduction, CtFlavourRole))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(CtFlavourRole -&gt; Bool)
-&gt; TyCon -&gt; [Xi] -&gt; TcS (Maybe (Reduction, CtFlavourRole))
</span><a href="GHC.Tc.Solver.Monad.html#lookupFamAppInert"><span class="hs-identifier hs-var">lookupFamAppInert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtFlavourRole -&gt; CtFlavourRole -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#eqCanRewriteFR"><span class="hs-operator hs-var">`eqCanRewriteFR`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtFlavour
</span><a href="#local-6989586621682006865"><span class="hs-identifier hs-var">flavour</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006855"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006847"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006857"><span class="hs-identifier hs-var">xis</span></a></span><span>
</span><span id="line-845"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Reduction, CtFlavourRole)
</span><a href="#local-6989586621682006866"><span class="hs-identifier hs-var">result2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-846"></span><span>         </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682006869"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006869"><span class="hs-identifier hs-var">redn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682006870"><span class="annot"><span class="annottext">CtFlavour
</span><a href="#local-6989586621682006870"><span class="hs-identifier hs-var">inert_flavour</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006871"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006871"><span class="hs-identifier hs-var">inert_eq_rel</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-847"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RewriteM ()
</span><a href="GHC.Tc.Solver.Rewrite.html#traceRewriteM"><span class="hs-identifier hs-var">traceRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rewrite family application with inert&quot;</span></span><span>
</span><span id="line-848"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006847"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006857"><span class="hs-identifier hs-var">xis</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006869"><span class="hs-identifier hs-var">redn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-849"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Reduction -&gt; RewriteM Reduction
</span><a href="#local-6989586621682006854"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtFlavour
</span><a href="#local-6989586621682006870"><span class="hs-identifier hs-var">inert_flavour</span></a></span><span> </span><span class="annot"><span class="annottext">CtFlavour -&gt; CtFlavour -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CtFlavour
</span><a href="GHC.Tc.Types.Constraint.html#Given"><span class="hs-identifier hs-var">Given</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reduction -&gt; Reduction
</span><a href="#local-6989586621682006861"><span class="hs-identifier hs-var">homogenise</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006873"><span class="hs-identifier hs-var">downgraded_redn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-850"></span><span>               </span><span class="hs-comment">-- this will sometimes duplicate an inert in the cache,</span><span>
</span><span id="line-851"></span><span>               </span><span class="hs-comment">-- but avoiding doing so had no impact on performance, and</span><span>
</span><span id="line-852"></span><span>               </span><span class="hs-comment">-- it seems easier not to weed out that special case</span><span>
</span><span id="line-853"></span><span>             </span><span class="hs-keyword">where</span><span>
</span><span id="line-854"></span><span>               </span><span id="local-6989586621682006874"><span class="annot"><span class="annottext">inert_role :: Role
</span><a href="#local-6989586621682006874"><span class="hs-identifier hs-var hs-var">inert_role</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006871"><span class="hs-identifier hs-var">inert_eq_rel</span></a></span><span>
</span><span id="line-855"></span><span>               </span><span id="local-6989586621682006875"><span class="annot"><span class="annottext">role :: Role
</span><a href="#local-6989586621682006875"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; Role
</span><a href="GHC.Core.Predicate.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006855"><span class="hs-identifier hs-var">eq_rel</span></a></span><span>
</span><span id="line-856"></span><span>               </span><span id="local-6989586621682006873"><span class="annot"><span class="annottext">downgraded_redn :: Reduction
</span><a href="#local-6989586621682006873"><span class="hs-identifier hs-var hs-var">downgraded_redn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Reduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#downgradeRedn"><span class="hs-identifier hs-var">downgradeRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006875"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006874"><span class="hs-identifier hs-var">inert_role</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006869"><span class="hs-identifier hs-var">redn</span></a></span><span>
</span><span id="line-857"></span><span>
</span><span id="line-858"></span><span>         </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Maybe (Reduction, CtFlavourRole)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-859"></span><span>
</span><span id="line-860"></span><span>         </span><span class="hs-comment">-- inerts didn't work. Try to reduce again, in STEP 4.</span><span>
</span><span id="line-861"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006877"><span class="annot"><span class="annottext">Maybe Reduction
</span><a href="#local-6989586621682006877"><span class="hs-identifier hs-var">result3</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Xi] -&gt; [TcPluginRewriter] -&gt; RewriteM (Maybe Reduction)
</span><a href="GHC.Tc.Solver.Rewrite.html#try_to_reduce"><span class="hs-identifier hs-var">try_to_reduce</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006847"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006857"><span class="hs-identifier hs-var">xis</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPluginRewriter]
</span><a href="#local-6989586621682006849"><span class="hs-identifier hs-var">tc_rewriters</span></a></span><span>
</span><span id="line-862"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Reduction
</span><a href="#local-6989586621682006877"><span class="hs-identifier hs-var">result3</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-863"></span><span>           </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682006878"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006878"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Reduction -&gt; RewriteM Reduction
</span><a href="#local-6989586621682006854"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reduction -&gt; Reduction
</span><a href="#local-6989586621682006861"><span class="hs-identifier hs-var">homogenise</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006878"><span class="hs-identifier hs-var">redn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-864"></span><span>           </span><span class="hs-comment">-- we have made no progress at all: STEP 5 (GIVEUP).</span><span>
</span><span id="line-865"></span><span>           </span><span class="annot"><span class="annottext">Maybe Reduction
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006863"><span class="hs-identifier hs-var">give_up</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-866"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-867"></span><span>      </span><span class="hs-comment">-- call this if the above attempts made progress.</span><span>
</span><span id="line-868"></span><span>      </span><span class="hs-comment">-- This recursively rewrites the result and then adds to the cache</span><span>
</span><span id="line-869"></span><span>    </span><span class="annot"><a href="#local-6989586621682006854"><span class="hs-identifier hs-type">finish</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>  </span><span class="hs-comment">-- add to the cache?</span><span>
</span><span id="line-870"></span><span>                    </span><span class="hs-comment">-- Precondition: True ==&gt; input coercion has</span><span>
</span><span id="line-871"></span><span>                    </span><span class="hs-comment">--                        no coercion holes</span><span>
</span><span id="line-872"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-873"></span><span>    </span><span id="local-6989586621682006854"><span class="annot"><span class="annottext">finish :: Bool -&gt; Reduction -&gt; RewriteM Reduction
</span><a href="#local-6989586621682006854"><span class="hs-identifier hs-var hs-var">finish</span></a></span></span><span> </span><span id="local-6989586621682006879"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006879"><span class="hs-identifier hs-var">use_cache</span></a></span></span><span> </span><span id="local-6989586621682006880"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006880"><span class="hs-identifier hs-var">redn</span></a></span></span><span>
</span><span id="line-874"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- rewrite the result: FINISH 1</span><span>
</span><span id="line-875"></span><span>             </span><span id="local-6989586621682006881"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006881"><span class="hs-identifier hs-var">final_redn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_reduction"><span class="hs-identifier hs-var">rewrite_reduction</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006880"><span class="hs-identifier hs-var">redn</span></a></span><span>
</span><span id="line-876"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006882"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006882"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM EqRel
</span><a href="GHC.Tc.Solver.Rewrite.html#getEqRel"><span class="hs-identifier hs-var">getEqRel</span></a></span><span>
</span><span id="line-877"></span><span>
</span><span id="line-878"></span><span>             </span><span class="hs-comment">-- extend the cache: FINISH 2</span><span>
</span><span id="line-879"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; RewriteM () -&gt; RewriteM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#when/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006879"><span class="hs-identifier hs-var">use_cache</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006882"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; EqRel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RewriteM () -&gt; RewriteM ()) -&gt; RewriteM () -&gt; RewriteM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-880"></span><span>             </span><span class="hs-comment">-- the cache only wants Nominal eqs</span><span>
</span><span id="line-881"></span><span>             </span><span class="annot"><span class="annottext">TcS () -&gt; RewriteM ()
forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var">liftTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS () -&gt; RewriteM ()) -&gt; TcS () -&gt; RewriteM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Xi] -&gt; Reduction -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#extendFamAppCache"><span class="hs-identifier hs-var">extendFamAppCache</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006847"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006848"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006881"><span class="hs-identifier hs-var">final_redn</span></a></span><span>
</span><span id="line-882"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006881"><span class="hs-identifier hs-var">final_redn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-883"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621682006854"><span class="hs-pragma hs-type">finish</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-884"></span><span>
</span><span id="line-885"></span><span class="hs-comment">-- Returned coercion is input ~r output, where r is the role in the RewriteM monad</span><span>
</span><span id="line-886"></span><span class="hs-comment">-- See Note [How to normalise a family application]</span><span>
</span><span id="line-887"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#try_to_reduce"><span class="hs-identifier hs-type">try_to_reduce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginRewriter"><span class="hs-identifier hs-type">TcPluginRewriter</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-888"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-889"></span><span id="try_to_reduce"><span class="annot"><span class="annottext">try_to_reduce :: TyCon -&gt; [Xi] -&gt; [TcPluginRewriter] -&gt; RewriteM (Maybe Reduction)
</span><a href="GHC.Tc.Solver.Rewrite.html#try_to_reduce"><span class="hs-identifier hs-var hs-var">try_to_reduce</span></a></span></span><span> </span><span id="local-6989586621682006886"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006886"><span class="hs-identifier hs-var">tc</span></a></span></span><span> </span><span id="local-6989586621682006887"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006887"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span id="local-6989586621682006888"><span class="annot"><span class="annottext">[TcPluginRewriter]
</span><a href="#local-6989586621682006888"><span class="hs-identifier hs-var">tc_rewriters</span></a></span></span><span>
</span><span id="line-890"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006889"><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006889"><span class="hs-identifier hs-var">rewrite_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM RewriteEnv
</span><a href="GHC.Tc.Solver.Rewrite.html#getRewriteEnv"><span class="hs-identifier hs-var">getRewriteEnv</span></a></span><span>
</span><span id="line-891"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006890"><span class="annot"><span class="annottext">Maybe Reduction
</span><a href="#local-6989586621682006890"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-892"></span><span>            </span><span class="annot"><span class="annottext">TcS (Maybe Reduction) -&gt; RewriteM (Maybe Reduction)
forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var">liftTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS (Maybe Reduction) -&gt; RewriteM (Maybe Reduction))
-&gt; TcS (Maybe Reduction) -&gt; RewriteM (Maybe Reduction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[TcS (Maybe Reduction)] -&gt; TcS (Maybe Reduction)
forall (m :: * -&gt; *) (f :: * -&gt; *) a.
(Monad m, Foldable f) =&gt;
f (m (Maybe a)) -&gt; m (Maybe a)
</span><a href="GHC.Data.Maybe.html#firstJustsM"><span class="hs-identifier hs-var">firstJustsM</span></a></span><span>
</span><span id="line-893"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">RewriteEnv -&gt; [TcPluginRewriter] -&gt; [Xi] -&gt; TcS (Maybe Reduction)
</span><a href="GHC.Tc.Solver.Rewrite.html#runTcPluginRewriters"><span class="hs-identifier hs-var">runTcPluginRewriters</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006889"><span class="hs-identifier hs-var">rewrite_env</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPluginRewriter]
</span><a href="#local-6989586621682006888"><span class="hs-identifier hs-var">tc_rewriters</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006887"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="hs-comment">-- STEP 1a &amp; STEP 4a</span><span>
</span><span id="line-894"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Xi] -&gt; TcS (Maybe Reduction)
</span><a href="GHC.Tc.Solver.Monad.html#lookupFamAppCache"><span class="hs-identifier hs-var">lookupFamAppCache</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006886"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006887"><span class="hs-identifier hs-var">tys</span></a></span><span>                          </span><span class="hs-comment">-- STEP 1b &amp; STEP 4b</span><span>
</span><span id="line-895"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [Xi] -&gt; TcS (Maybe Reduction)
</span><a href="GHC.Tc.Solver.Monad.html#matchFam"><span class="hs-identifier hs-var">matchFam</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006886"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006887"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="hs-special">]</span><span>                                 </span><span class="hs-comment">-- STEP 1c &amp; STEP 4c</span><span>
</span><span id="line-896"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteM Reduction)
-&gt; Maybe Reduction -&gt; RewriteM (Maybe Reduction)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; Maybe a -&gt; f (Maybe b)
</span><a href="../../base-4.18.3.0/src/Data.Traversable.html#traverse/Data.Traversable.html#traverse"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
</span><a href="#local-6989586621682006896"><span class="hs-identifier hs-var">downgrade</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Reduction
</span><a href="#local-6989586621682006890"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-897"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-898"></span><span>    </span><span class="hs-comment">-- The result above is always Nominal. We might want a Representational</span><span>
</span><span id="line-899"></span><span>    </span><span class="hs-comment">-- coercion; this downgrades (and prints, out of convenience).</span><span>
</span><span id="line-900"></span><span>    </span><span class="annot"><a href="#local-6989586621682006896"><span class="hs-identifier hs-type">downgrade</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-901"></span><span>    </span><span id="local-6989586621682006896"><span class="annot"><span class="annottext">downgrade :: Reduction -&gt; RewriteM Reduction
</span><a href="#local-6989586621682006896"><span class="hs-identifier hs-var hs-var">downgrade</span></a></span></span><span> </span><span id="local-6989586621682006897"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006897"><span class="hs-identifier hs-var">redn</span></a></span></span><span>
</span><span id="line-902"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RewriteM ()
</span><a href="GHC.Tc.Solver.Rewrite.html#traceRewriteM"><span class="hs-identifier hs-var">traceRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Eager T.F. reduction success&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; RewriteM ()) -&gt; SDoc -&gt; RewriteM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-903"></span><span>             </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006886"><span class="hs-identifier hs-var">tc</span></a></span><span>
</span><span id="line-904"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Xi] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006887"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-905"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006897"><span class="hs-identifier hs-var">redn</span></a></span><span>
</span><span id="line-906"></span><span>                  </span><span class="hs-special">]</span><span>
</span><span id="line-907"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006898"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006898"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM EqRel
</span><a href="GHC.Tc.Solver.Rewrite.html#getEqRel"><span class="hs-identifier hs-var">getEqRel</span></a></span><span>
</span><span id="line-908"></span><span>              </span><span class="hs-comment">-- manually doing it this way avoids allocation in the vastly</span><span>
</span><span id="line-909"></span><span>              </span><span class="hs-comment">-- common NomEq case</span><span>
</span><span id="line-910"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006898"><span class="hs-identifier hs-var">eq_rel</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-911"></span><span>               </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006897"><span class="hs-identifier hs-var">redn</span></a></span><span>
</span><span id="line-912"></span><span>               </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteM Reduction)
-&gt; Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkSubRedn"><span class="hs-identifier hs-var">mkSubRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006897"><span class="hs-identifier hs-var">redn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-913"></span><span>
</span><span id="line-914"></span><span class="hs-comment">-- Retrieve all type-checking plugins that can rewrite a (saturated) type-family application</span><span>
</span><span id="line-915"></span><span class="hs-comment">-- headed by the given 'TyCon`.</span><span>
</span><span id="line-916"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#getTcPluginRewritersForTyCon"><span class="hs-identifier hs-type">getTcPluginRewritersForTyCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginRewriter"><span class="hs-identifier hs-type">TcPluginRewriter</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-917"></span><span id="getTcPluginRewritersForTyCon"><span class="annot"><span class="annottext">getTcPluginRewritersForTyCon :: TyCon -&gt; RewriteM [TcPluginRewriter]
</span><a href="GHC.Tc.Solver.Rewrite.html#getTcPluginRewritersForTyCon"><span class="hs-identifier hs-var hs-var">getTcPluginRewritersForTyCon</span></a></span></span><span> </span><span id="local-6989586621682006899"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006899"><span class="hs-identifier hs-var">tc</span></a></span></span><span>
</span><span id="line-918"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcS [TcPluginRewriter] -&gt; RewriteM [TcPluginRewriter]
forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var">liftTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS [TcPluginRewriter] -&gt; RewriteM [TcPluginRewriter])
-&gt; TcS [TcPluginRewriter] -&gt; RewriteM [TcPluginRewriter]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006900"><span class="annot"><span class="annottext">UniqFM TyCon [TcPluginRewriter]
</span><a href="#local-6989586621682006900"><span class="hs-identifier hs-var">rewriters</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcGblEnv -&gt; UniqFM TyCon [TcPluginRewriter]
</span><a href="GHC.Tc.Types.html#tcg_tc_plugin_rewriters"><span class="hs-identifier hs-var">tcg_tc_plugin_rewriters</span></a></span><span> </span><span class="annot"><span class="annottext">(TcGblEnv -&gt; UniqFM TyCon [TcPluginRewriter])
-&gt; TcS TcGblEnv -&gt; TcS (UniqFM TyCon [TcPluginRewriter])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.18.3.0/src/Data.Functor.html#%3C%24%3E/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TcS TcGblEnv
</span><a href="GHC.Tc.Solver.Monad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a></span><span>
</span><span id="line-919"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[TcPluginRewriter] -&gt; TcS [TcPluginRewriter]
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UniqFM TyCon [TcPluginRewriter]
-&gt; [TcPluginRewriter] -&gt; TyCon -&gt; [TcPluginRewriter]
forall key elt.
Uniquable key =&gt;
UniqFM key elt -&gt; elt -&gt; key -&gt; elt
</span><a href="GHC.Types.Unique.FM.html#lookupWithDefaultUFM"><span class="hs-identifier hs-var">lookupWithDefaultUFM</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM TyCon [TcPluginRewriter]
</span><a href="#local-6989586621682006900"><span class="hs-identifier hs-var">rewriters</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682006899"><span class="hs-identifier hs-var">tc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-920"></span><span>
</span><span id="line-921"></span><span class="hs-comment">-- Run a collection of rewriting functions obtained from type-checking plugins,</span><span>
</span><span id="line-922"></span><span class="hs-comment">-- querying in sequence if any plugin wants to rewrite the type family</span><span>
</span><span id="line-923"></span><span class="hs-comment">-- applied to the given arguments.</span><span>
</span><span id="line-924"></span><span class="hs-comment">--</span><span>
</span><span id="line-925"></span><span class="hs-comment">-- Note that the 'TcPluginRewriter's provided all pertain to the same type family</span><span>
</span><span id="line-926"></span><span class="hs-comment">-- (the 'TyCon' of which has been obtained ahead of calling this function).</span><span>
</span><span id="line-927"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#runTcPluginRewriters"><span class="hs-identifier hs-type">runTcPluginRewriters</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#RewriteEnv"><span class="hs-identifier hs-type">RewriteEnv</span></a></span><span>
</span><span id="line-928"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginRewriter"><span class="hs-identifier hs-type">TcPluginRewriter</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-929"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-930"></span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-931"></span><span id="runTcPluginRewriters"><span class="annot"><span class="annottext">runTcPluginRewriters :: RewriteEnv -&gt; [TcPluginRewriter] -&gt; [Xi] -&gt; TcS (Maybe Reduction)
</span><a href="GHC.Tc.Solver.Rewrite.html#runTcPluginRewriters"><span class="hs-identifier hs-var hs-var">runTcPluginRewriters</span></a></span></span><span> </span><span id="local-6989586621682006903"><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006903"><span class="hs-identifier hs-var">rewriteEnv</span></a></span></span><span> </span><span id="local-6989586621682006904"><span class="annot"><span class="annottext">[TcPluginRewriter]
</span><a href="#local-6989586621682006904"><span class="hs-identifier hs-var">rewriterFunctions</span></a></span></span><span> </span><span id="local-6989586621682006905"><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006905"><span class="hs-identifier hs-var">tys</span></a></span></span><span>
</span><span id="line-932"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[TcPluginRewriter] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPluginRewriter]
</span><a href="#local-6989586621682006904"><span class="hs-identifier hs-var">rewriterFunctions</span></a></span><span>
</span><span id="line-933"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Reduction -&gt; TcS (Maybe Reduction)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Reduction
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-comment">-- short-circuit for common case</span><span>
</span><span id="line-934"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-935"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006907"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621682006907"><span class="hs-identifier hs-var">givens</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS [Ct]
</span><a href="GHC.Tc.Solver.Monad.html#getInertGivens"><span class="hs-identifier hs-var">getInertGivens</span></a></span><span>
</span><span id="line-936"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; [TcPluginRewriter] -&gt; TcS (Maybe Reduction)
</span><a href="#local-6989586621682006909"><span class="hs-identifier hs-var">runRewriters</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621682006907"><span class="hs-identifier hs-var">givens</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPluginRewriter]
</span><a href="#local-6989586621682006904"><span class="hs-identifier hs-var">rewriterFunctions</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-937"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-938"></span><span>  </span><span class="annot"><a href="#local-6989586621682006909"><span class="hs-identifier hs-type">runRewriters</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginRewriter"><span class="hs-identifier hs-type">TcPluginRewriter</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-939"></span><span>  </span><span id="local-6989586621682006909"><span class="annot"><span class="annottext">runRewriters :: [Ct] -&gt; [TcPluginRewriter] -&gt; TcS (Maybe Reduction)
</span><a href="#local-6989586621682006909"><span class="hs-identifier hs-var hs-var">runRewriters</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-940"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Reduction -&gt; TcS (Maybe Reduction)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Reduction
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-941"></span><span>  </span><span class="annot"><a href="#local-6989586621682006909"><span class="hs-identifier hs-var">runRewriters</span></a></span><span> </span><span id="local-6989586621682006910"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621682006910"><span class="hs-identifier hs-var">givens</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682006911"><span class="annot"><span class="annottext">TcPluginRewriter
</span><a href="#local-6989586621682006911"><span class="hs-identifier hs-var">rewriter</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621682006912"><span class="annot"><span class="annottext">[TcPluginRewriter]
</span><a href="#local-6989586621682006912"><span class="hs-identifier hs-var">rewriters</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-942"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-943"></span><span>        </span><span id="local-6989586621682006913"><span class="annot"><span class="annottext">TcPluginRewriteResult
</span><a href="#local-6989586621682006913"><span class="hs-identifier hs-var">rewriteResult</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM TcPluginRewriteResult -&gt; TcS TcPluginRewriteResult
forall a. TcM a -&gt; TcS a
</span><a href="GHC.Tc.Solver.Monad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM TcPluginRewriteResult -&gt; TcS TcPluginRewriteResult)
-&gt; (TcPluginM TcPluginRewriteResult -&gt; TcM TcPluginRewriteResult)
-&gt; TcPluginM TcPluginRewriteResult
-&gt; TcS TcPluginRewriteResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginM TcPluginRewriteResult -&gt; TcM TcPluginRewriteResult
forall a. TcPluginM a -&gt; TcM a
</span><a href="GHC.Tc.Types.html#runTcPluginM"><span class="hs-identifier hs-var">runTcPluginM</span></a></span><span> </span><span class="annot"><span class="annottext">(TcPluginM TcPluginRewriteResult -&gt; TcS TcPluginRewriteResult)
-&gt; TcPluginM TcPluginRewriteResult -&gt; TcS TcPluginRewriteResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TcPluginRewriter
</span><a href="#local-6989586621682006911"><span class="hs-identifier hs-var">rewriter</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteEnv
</span><a href="#local-6989586621682006903"><span class="hs-identifier hs-var">rewriteEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621682006910"><span class="hs-identifier hs-var">givens</span></a></span><span> </span><span class="annot"><span class="annottext">[Xi]
</span><a href="#local-6989586621682006905"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-944"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TcPluginRewriteResult
</span><a href="#local-6989586621682006913"><span class="hs-identifier hs-var">rewriteResult</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-945"></span><span>           </span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginRewriteTo"><span class="hs-identifier hs-type">TcPluginRewriteTo</span></a></span><span>
</span><span id="line-946"></span><span>             </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tcPluginReduction :: TcPluginRewriteResult -&gt; Reduction
</span><a href="GHC.Tc.Types.html#tcPluginReduction"><span class="hs-identifier hs-var">tcPluginReduction</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006918"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006918"><span class="hs-identifier hs-var">redn</span></a></span></span><span>
</span><span id="line-947"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tcRewriterNewWanteds :: TcPluginRewriteResult -&gt; [Ct]
</span><a href="GHC.Tc.Types.html#tcRewriterNewWanteds"><span class="hs-identifier hs-var">tcRewriterNewWanteds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006920"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621682006920"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span>
</span><span id="line-948"></span><span>             </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; TcS ()
</span><a href="GHC.Tc.Solver.Monad.html#emitWork"><span class="hs-identifier hs-var">emitWork</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621682006920"><span class="hs-identifier hs-var">wanteds</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Maybe Reduction -&gt; TcS (Maybe Reduction)
forall a. a -&gt; TcS a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Reduction -&gt; TcS (Maybe Reduction))
-&gt; Maybe Reduction -&gt; TcS (Maybe Reduction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; Maybe Reduction
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006918"><span class="hs-identifier hs-var">redn</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-949"></span><span>           </span><span class="annot"><a href="GHC.Tc.Types.html#TcPluginNoRewrite"><span class="hs-identifier hs-type">TcPluginNoRewrite</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Ct] -&gt; [TcPluginRewriter] -&gt; TcS (Maybe Reduction)
</span><a href="#local-6989586621682006909"><span class="hs-identifier hs-var">runRewriters</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621682006910"><span class="hs-identifier hs-var">givens</span></a></span><span> </span><span class="annot"><span class="annottext">[TcPluginRewriter]
</span><a href="#local-6989586621682006912"><span class="hs-identifier hs-var">rewriters</span></a></span><span>
</span><span id="line-950"></span><span>
</span><span id="line-951"></span><span class="hs-comment">{-
************************************************************************
*                                                                      *
             Rewriting a type variable
*                                                                      *
********************************************************************* -}</span><span>
</span><span id="line-957"></span><span>
</span><span id="line-958"></span><span class="annot"><span class="hs-comment">-- | The result of rewriting a tyvar &quot;one step&quot;.</span></span><span>
</span><span id="line-959"></span><span class="hs-keyword">data</span><span> </span><span id="RewriteTvResult"><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteTvResult"><span class="hs-identifier hs-var">RewriteTvResult</span></a></span></span><span>
</span><span id="line-960"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="RTRNotFollowed"><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RTRNotFollowed"><span class="hs-identifier hs-var">RTRNotFollowed</span></a></span></span><span>
</span><span id="line-961"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ The inert set doesn't make the tyvar equal to anything else</span></span><span>
</span><span id="line-962"></span><span>
</span><span id="line-963"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="RTRFollowed"><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RTRFollowed"><span class="hs-identifier hs-var">RTRFollowed</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-964"></span><span>      </span><span class="hs-comment">-- ^ The tyvar rewrites to a not-necessarily rewritten other type.</span><span>
</span><span id="line-965"></span><span>      </span><span class="hs-comment">-- The role is determined by the RewriteEnv.</span><span>
</span><span id="line-966"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-967"></span><span>      </span><span class="hs-comment">-- With Quick Look, the returned TcType can be a polytype;</span><span>
</span><span id="line-968"></span><span>      </span><span class="hs-comment">-- that is, in the constraint solver, a unification variable</span><span>
</span><span id="line-969"></span><span>      </span><span class="hs-comment">-- can contain a polytype.  See GHC.Tc.Gen.App</span><span>
</span><span id="line-970"></span><span>      </span><span class="hs-comment">-- Note [Instantiation variables are short lived]</span><span>
</span><span id="line-971"></span><span>
</span><span id="line-972"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewriteTyVar"><span class="hs-identifier hs-type">rewriteTyVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.Reduction.html#Reduction"><span class="hs-identifier hs-type">Reduction</span></a></span><span>
</span><span id="line-973"></span><span id="rewriteTyVar"><span class="annot"><span class="annottext">rewriteTyVar :: TcTyVar -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewriteTyVar"><span class="hs-identifier hs-var hs-var">rewriteTyVar</span></a></span></span><span> </span><span id="local-6989586621682006926"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006926"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-974"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006927"><span class="annot"><span class="annottext">RewriteTvResult
</span><a href="#local-6989586621682006927"><span class="hs-identifier hs-var">mb_yes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; RewriteM RewriteTvResult
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_tyvar1"><span class="hs-identifier hs-var">rewrite_tyvar1</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006926"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-975"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RewriteTvResult
</span><a href="#local-6989586621682006927"><span class="hs-identifier hs-var">mb_yes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-976"></span><span>           </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RTRFollowed"><span class="hs-identifier hs-type">RTRFollowed</span></a></span><span> </span><span id="local-6989586621682006929"><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006929"><span class="hs-identifier hs-var">redn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_reduction"><span class="hs-identifier hs-var">rewrite_reduction</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction
</span><a href="#local-6989586621682006929"><span class="hs-identifier hs-var">redn</span></a></span><span>
</span><span id="line-977"></span><span>
</span><span id="line-978"></span><span>           </span><span class="annot"><span class="annottext">RewriteTvResult
</span><a href="GHC.Tc.Solver.Rewrite.html#RTRNotFollowed"><span class="hs-identifier hs-var">RTRNotFollowed</span></a></span><span>   </span><span class="hs-comment">-- Done, but make sure the kind is zonked</span><span>
</span><span id="line-979"></span><span>                            </span><span class="hs-comment">-- Note [Rewriting] invariant (F0) and (F1)</span><span>
</span><span id="line-980"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006930"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006930"><span class="hs-identifier hs-var">tv'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS TcTyVar -&gt; RewriteM TcTyVar
forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var">liftTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS TcTyVar -&gt; RewriteM TcTyVar)
-&gt; TcS TcTyVar -&gt; RewriteM TcTyVar
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Xi -&gt; TcS Xi) -&gt; TcTyVar -&gt; TcS TcTyVar
forall (m :: * -&gt; *).
Monad m =&gt;
(Xi -&gt; m Xi) -&gt; TcTyVar -&gt; m TcTyVar
</span><a href="GHC.Types.Var.html#updateTyVarKindM"><span class="hs-identifier hs-var">updateTyVarKindM</span></a></span><span> </span><span class="annot"><span class="annottext">Xi -&gt; TcS Xi
</span><a href="GHC.Tc.Solver.Monad.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006926"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-981"></span><span>                   </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006932"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006932"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM Role
</span><a href="GHC.Tc.Solver.Rewrite.html#getRole"><span class="hs-identifier hs-var">getRole</span></a></span><span>
</span><span id="line-982"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682006933"><span class="annot"><span class="annottext">ty' :: Xi
</span><a href="#local-6989586621682006933"><span class="hs-identifier hs-var hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; Xi
</span><a href="GHC.Core.TyCo.Rep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006930"><span class="hs-identifier hs-var">tv'</span></a></span><span>
</span><span id="line-983"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteM Reduction
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteM Reduction)
-&gt; Reduction -&gt; RewriteM Reduction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Xi -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006932"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006933"><span class="hs-identifier hs-var">ty'</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-984"></span><span>
</span><span id="line-985"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_tyvar1"><span class="hs-identifier hs-type">rewrite_tyvar1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteTvResult"><span class="hs-identifier hs-type">RewriteTvResult</span></a></span><span>
</span><span id="line-986"></span><span class="hs-comment">-- &quot;Rewriting&quot; a type variable means to apply the substitution to it</span><span>
</span><span id="line-987"></span><span class="hs-comment">-- Specifically, look up the tyvar in</span><span>
</span><span id="line-988"></span><span class="hs-comment">--   * the internal MetaTyVar box</span><span>
</span><span id="line-989"></span><span class="hs-comment">--   * the inerts</span><span>
</span><span id="line-990"></span><span class="hs-comment">-- See also the documentation for RewriteTvResult</span><span>
</span><span id="line-991"></span><span>
</span><span id="line-992"></span><span id="rewrite_tyvar1"><span class="annot"><span class="annottext">rewrite_tyvar1 :: TcTyVar -&gt; RewriteM RewriteTvResult
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_tyvar1"><span class="hs-identifier hs-var hs-var">rewrite_tyvar1</span></a></span></span><span> </span><span id="local-6989586621682006935"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006935"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-993"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006936"><span class="annot"><span class="annottext">Maybe Xi
</span><a href="#local-6989586621682006936"><span class="hs-identifier hs-var">mb_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS (Maybe Xi) -&gt; RewriteM (Maybe Xi)
forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var">liftTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS (Maybe Xi) -&gt; RewriteM (Maybe Xi))
-&gt; TcS (Maybe Xi) -&gt; RewriteM (Maybe Xi)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; TcS (Maybe Xi)
</span><a href="GHC.Tc.Solver.Monad.html#isFilledMetaTyVar_maybe"><span class="hs-identifier hs-var">isFilledMetaTyVar_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006935"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-994"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Xi
</span><a href="#local-6989586621682006936"><span class="hs-identifier hs-var">mb_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-995"></span><span>           </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682006938"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006938"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RewriteM ()
</span><a href="GHC.Tc.Solver.Rewrite.html#traceRewriteM"><span class="hs-identifier hs-var">traceRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Following filled tyvar&quot;</span></span><span>
</span><span id="line-996"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006935"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#equals"><span class="hs-identifier hs-var">equals</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Xi -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006938"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-997"></span><span>                         </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006940"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006940"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM Role
</span><a href="GHC.Tc.Solver.Rewrite.html#getRole"><span class="hs-identifier hs-var">getRole</span></a></span><span>
</span><span id="line-998"></span><span>                         </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">RewriteTvResult -&gt; RewriteM RewriteTvResult
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(RewriteTvResult -&gt; RewriteM RewriteTvResult)
-&gt; RewriteTvResult -&gt; RewriteM RewriteTvResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteTvResult
</span><a href="GHC.Tc.Solver.Rewrite.html#RTRFollowed"><span class="hs-identifier hs-var">RTRFollowed</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteTvResult) -&gt; Reduction -&gt; RewriteTvResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-999"></span><span>                             </span><span class="annot"><span class="annottext">Role -&gt; Xi -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReflRedn"><span class="hs-identifier hs-var">mkReflRedn</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621682006940"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006938"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1000"></span><span>           </span><span class="annot"><span class="annottext">Maybe Xi
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RewriteM ()
</span><a href="GHC.Tc.Solver.Rewrite.html#traceRewriteM"><span class="hs-identifier hs-var">traceRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unfilled tyvar&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
</span><a href="GHC.Core.TyCo.Ppr.html#pprTyVar"><span class="hs-identifier hs-var">pprTyVar</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006935"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1001"></span><span>                         </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682006941"><span class="annot"><span class="annottext">CtFlavourRole
</span><a href="#local-6989586621682006941"><span class="hs-identifier hs-var">fr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RewriteM CtFlavourRole
</span><a href="GHC.Tc.Solver.Rewrite.html#getFlavourRole"><span class="hs-identifier hs-var">getFlavourRole</span></a></span><span>
</span><span id="line-1002"></span><span>                         </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; CtFlavourRole -&gt; RewriteM RewriteTvResult
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_tyvar2"><span class="hs-identifier hs-var">rewrite_tyvar2</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006935"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">CtFlavourRole
</span><a href="#local-6989586621682006941"><span class="hs-identifier hs-var">fr</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1003"></span><span>
</span><span id="line-1004"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#rewrite_tyvar2"><span class="hs-identifier hs-type">rewrite_tyvar2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CtFlavourRole"><span class="hs-identifier hs-type">CtFlavourRole</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteM"><span class="hs-identifier hs-type">RewriteM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#RewriteTvResult"><span class="hs-identifier hs-type">RewriteTvResult</span></a></span><span>
</span><span id="line-1005"></span><span class="hs-comment">-- The tyvar is not a filled-in meta-tyvar</span><span>
</span><span id="line-1006"></span><span class="hs-comment">-- Try in the inert equalities</span><span>
</span><span id="line-1007"></span><span class="hs-comment">-- See Definition [Applying a generalised substitution] in GHC.Tc.Solver.Monad</span><span>
</span><span id="line-1008"></span><span class="hs-comment">-- See Note [Stability of rewriting] in GHC.Tc.Solver.Monad</span><span>
</span><span id="line-1009"></span><span>
</span><span id="line-1010"></span><span id="rewrite_tyvar2"><span class="annot"><span class="annottext">rewrite_tyvar2 :: TcTyVar -&gt; CtFlavourRole -&gt; RewriteM RewriteTvResult
</span><a href="GHC.Tc.Solver.Rewrite.html#rewrite_tyvar2"><span class="hs-identifier hs-var hs-var">rewrite_tyvar2</span></a></span></span><span> </span><span id="local-6989586621682006943"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006943"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621682006944"><span class="annot"><span class="annottext">fr :: CtFlavourRole
</span><a href="#local-6989586621682006944"><span class="hs-identifier hs-var">fr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CtFlavour
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006945"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006945"><span class="hs-identifier hs-var">eq_rel</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1011"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682006946"><span class="annot"><span class="annottext">InertEqs
</span><a href="#local-6989586621682006946"><span class="hs-identifier hs-var">ieqs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcS InertEqs -&gt; RewriteM InertEqs
forall a. TcS a -&gt; RewriteM a
</span><a href="GHC.Tc.Solver.Rewrite.html#liftTcS"><span class="hs-identifier hs-var">liftTcS</span></a></span><span> </span><span class="annot"><span class="annottext">(TcS InertEqs -&gt; RewriteM InertEqs)
-&gt; TcS InertEqs -&gt; RewriteM InertEqs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TcS InertEqs
</span><a href="GHC.Tc.Solver.Monad.html#getInertEqs"><span class="hs-identifier hs-var">getInertEqs</span></a></span><span>
</span><span id="line-1012"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InertEqs -&gt; TcTyVar -&gt; Maybe [Ct]
forall a. DVarEnv a -&gt; TcTyVar -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupDVarEnv"><span class="hs-identifier hs-var">lookupDVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">InertEqs
</span><a href="#local-6989586621682006946"><span class="hs-identifier hs-var">ieqs</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006943"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1013"></span><span>           </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682006949"><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621682006949"><span class="hs-identifier hs-var">equal_ct_list</span></a></span></span><span>
</span><span id="line-1014"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682006950"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621682006950"><span class="hs-identifier hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; Bool) -&gt; [Ct] -&gt; Maybe Ct
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#find/Data.Foldable.html#find"><span class="hs-identifier hs-var">find</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Bool
</span><a href="#local-6989586621682006951"><span class="hs-identifier hs-var">can_rewrite</span></a></span><span> </span><span class="annot"><span class="annottext">[Ct]
</span><a href="#local-6989586621682006949"><span class="hs-identifier hs-var">equal_ct_list</span></a></span><span>
</span><span id="line-1015"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#CEqCan"><span class="hs-identifier hs-type">CEqCan</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cc_ev :: Ct -&gt; CtEvidence
</span><a href="GHC.Tc.Types.Constraint.html#cc_ev"><span class="hs-identifier hs-var">cc_ev</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006954"><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006954"><span class="hs-identifier hs-var">ctev</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_lhs :: Ct -&gt; CanEqLHS
</span><a href="GHC.Tc.Types.Constraint.html#cc_lhs"><span class="hs-identifier hs-var">cc_lhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#TyVarLHS"><span class="hs-identifier hs-type">TyVarLHS</span></a></span><span> </span><span id="local-6989586621682006957"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006957"><span class="hs-identifier hs-var">tv</span></a></span></span><span>
</span><span id="line-1016"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_rhs :: Ct -&gt; Xi
</span><a href="GHC.Tc.Types.Constraint.html#cc_rhs"><span class="hs-identifier hs-var">cc_rhs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006959"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006959"><span class="hs-identifier hs-var">rhs_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cc_eq_rel :: Ct -&gt; EqRel
</span><a href="GHC.Tc.Types.Constraint.html#cc_eq_rel"><span class="hs-identifier hs-var">cc_eq_rel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006961"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006961"><span class="hs-identifier hs-var">ct_eq_rel</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621682006950"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-1017"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682006962"><span class="annot"><span class="annottext">wrw :: Bool
</span><a href="#local-6989586621682006962"><span class="hs-identifier hs-var hs-var">wrw</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#isWantedCt"><span class="hs-identifier hs-var">isWantedCt</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621682006950"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-1018"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; RewriteM ()
</span><a href="GHC.Tc.Solver.Rewrite.html#traceRewriteM"><span class="hs-identifier hs-var">traceRewriteM</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Following inert tyvar&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; RewriteM ()) -&gt; SDoc -&gt; RewriteM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1019"></span><span>                        </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TcTyVar -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006957"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc
forall doc. IsLine doc =&gt; doc
</span><a href="GHC.Utils.Outputable.html#equals"><span class="hs-identifier hs-var">equals</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Xi -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006959"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span>
</span><span id="line-1020"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006954"><span class="hs-identifier hs-var">ctev</span></a></span><span>
</span><span id="line-1021"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;wanted_rewrite_wanted:&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006962"><span class="hs-identifier hs-var">wrw</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-1022"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; RewriteM () -&gt; RewriteM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#when/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006962"><span class="hs-identifier hs-var">wrw</span></a></span><span> </span><span class="annot"><span class="annottext">(RewriteM () -&gt; RewriteM ()) -&gt; RewriteM () -&gt; RewriteM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence -&gt; RewriteM ()
</span><a href="GHC.Tc.Solver.Rewrite.html#recordRewriter"><span class="hs-identifier hs-var">recordRewriter</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006954"><span class="hs-identifier hs-var">ctev</span></a></span><span>
</span><span id="line-1023"></span><span>
</span><span id="line-1024"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682006965"><span class="annot"><span class="annottext">rewriting_co1 :: Coercion
</span><a href="#local-6989586621682006965"><span class="hs-identifier hs-var hs-var">rewriting_co1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; CtEvidence -&gt; Coercion
CtEvidence -&gt; Coercion
</span><a href="GHC.Tc.Types.Constraint.html#ctEvCoercion"><span class="hs-identifier hs-var">ctEvCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">CtEvidence
</span><a href="#local-6989586621682006954"><span class="hs-identifier hs-var">ctev</span></a></span><span>
</span><span id="line-1025"></span><span>                         </span><span id="local-6989586621682006967"><span class="annot"><span class="annottext">rewriting_co :: Coercion
</span><a href="#local-6989586621682006967"><span class="hs-identifier hs-var hs-var">rewriting_co</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006961"><span class="hs-identifier hs-var">ct_eq_rel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006945"><span class="hs-identifier hs-var">eq_rel</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1026"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006968"><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006968"><span class="hs-identifier hs-var">_rel</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Coercion -&gt; Coercion
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel
</span><a href="#local-6989586621682006968"><span class="hs-identifier hs-var">_rel</span></a></span><span> </span><span class="annot"><span class="annottext">EqRel -&gt; EqRel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1027"></span><span>                                    </span><span class="hs-comment">-- if this assert fails, then</span><span>
</span><span id="line-1028"></span><span>                                    </span><span class="hs-comment">-- eqCanRewriteFR answered incorrectly</span><span>
</span><span id="line-1029"></span><span>                                               </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006965"><span class="hs-identifier hs-var">rewriting_co1</span></a></span><span>
</span><span id="line-1030"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006965"><span class="hs-identifier hs-var">rewriting_co1</span></a></span><span>
</span><span id="line-1031"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EqRel
</span><a href="GHC.Core.Predicate.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Coercion -&gt; Coercion
Coercion -&gt; Coercion
</span><a href="GHC.Core.Coercion.html#mkSubCo"><span class="hs-identifier hs-var">mkSubCo</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006965"><span class="hs-identifier hs-var">rewriting_co1</span></a></span><span>
</span><span id="line-1032"></span><span>
</span><span id="line-1033"></span><span>                   </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">RewriteTvResult -&gt; RewriteM RewriteTvResult
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(RewriteTvResult -&gt; RewriteM RewriteTvResult)
-&gt; RewriteTvResult -&gt; RewriteM RewriteTvResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Reduction -&gt; RewriteTvResult
</span><a href="GHC.Tc.Solver.Rewrite.html#RTRFollowed"><span class="hs-identifier hs-var">RTRFollowed</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduction -&gt; RewriteTvResult) -&gt; Reduction -&gt; RewriteTvResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion -&gt; Xi -&gt; Reduction
</span><a href="GHC.Core.Reduction.html#mkReduction"><span class="hs-identifier hs-var">mkReduction</span></a></span><span> </span><span class="annot"><span class="annottext">Coercion
</span><a href="#local-6989586621682006967"><span class="hs-identifier hs-var">rewriting_co</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006959"><span class="hs-identifier hs-var">rhs_ty</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1034"></span><span>
</span><span id="line-1035"></span><span>           </span><span id="local-6989586621682006971"><span class="annot"><span class="annottext">Maybe [Ct]
</span><a href="#local-6989586621682006971"><span class="hs-identifier hs-var">_other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RewriteTvResult -&gt; RewriteM RewriteTvResult
forall a. a -&gt; RewriteM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">RewriteTvResult
</span><a href="GHC.Tc.Solver.Rewrite.html#RTRNotFollowed"><span class="hs-identifier hs-var">RTRNotFollowed</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1036"></span><span>
</span><span id="line-1037"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1038"></span><span>    </span><span class="annot"><a href="#local-6989586621682006951"><span class="hs-identifier hs-type">can_rewrite</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1039"></span><span>    </span><span id="local-6989586621682006951"><span class="annot"><span class="annottext">can_rewrite :: Ct -&gt; Bool
</span><a href="#local-6989586621682006951"><span class="hs-identifier hs-var hs-var">can_rewrite</span></a></span></span><span> </span><span id="local-6989586621682006972"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621682006972"><span class="hs-identifier hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; CtFlavourRole
</span><a href="GHC.Tc.Types.Constraint.html#ctFlavourRole"><span class="hs-identifier hs-var">ctFlavourRole</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621682006972"><span class="hs-identifier hs-var">ct</span></a></span><span> </span><span class="annot"><span class="annottext">CtFlavourRole -&gt; CtFlavourRole -&gt; Bool
</span><a href="GHC.Tc.Types.Constraint.html#eqCanRewriteFR"><span class="hs-operator hs-var">`eqCanRewriteFR`</span></a></span><span> </span><span class="annot"><span class="annottext">CtFlavourRole
</span><a href="#local-6989586621682006944"><span class="hs-identifier hs-var">fr</span></a></span><span>
</span><span id="line-1040"></span><span>      </span><span class="hs-comment">-- This is THE key call of eqCanRewriteFR</span><span>
</span><span id="line-1041"></span><span>
</span><span id="line-1042"></span><span class="hs-comment">{-
Note [An alternative story for the inert substitution]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(This entire note is just background, left here in case we ever want
 to return the previous state of affairs)

We used (GHC 7.8) to have this story for the inert substitution inert_eqs

 * 'a' is not in fvs(ty)
 * They are *inert* in the weaker sense that there is no infinite chain of
   (i1 `eqCanRewrite` i2), (i2 `eqCanRewrite` i3), etc

This means that rewriting must be recursive, but it does allow
  [G] a ~ [b]
  [G] b ~ Maybe c

This avoids &quot;saturating&quot; the Givens, which can save a modest amount of work.
It is easy to implement, in GHC.Tc.Solver.Interact.kick_out, by only kicking out an inert
only if (a) the work item can rewrite the inert AND
        (b) the inert cannot rewrite the work item

This is significantly harder to think about. It can save a LOT of work
in occurs-check cases, but we don't care about them much.  #5837
is an example, but it causes trouble only with the old (pre-Fall 2020)
rewriting story. It is unclear if there is any gain w.r.t. to
the new story.

-}</span><span>
</span><span id="line-1070"></span><span>
</span><span id="line-1071"></span><span class="hs-comment">--------------------------------------</span><span>
</span><span id="line-1072"></span><span class="hs-comment">-- Utilities</span><span>
</span><span id="line-1073"></span><span>
</span><span id="line-1074"></span><span class="hs-comment">-- | Like 'splitPiTys'' but comes with a 'Bool' which is 'True' iff there is at</span><span>
</span><span id="line-1075"></span><span class="hs-comment">-- least one named binder.</span><span>
</span><span id="line-1076"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#split_pi_tys%27"><span class="hs-identifier hs-type">split_pi_tys'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#PiTyBinder"><span class="hs-identifier hs-type">PiTyBinder</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-1077"></span><span id="split_pi_tys%27"><span class="annot"><span class="annottext">split_pi_tys' :: Xi -&gt; ([PiTyBinder], Xi, Bool)
</span><a href="GHC.Tc.Solver.Rewrite.html#split_pi_tys%27"><span class="hs-identifier hs-var hs-var">split_pi_tys'</span></a></span></span><span> </span><span id="local-6989586621682006974"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006974"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; Xi -&gt; ([PiTyBinder], Xi, Bool)
</span><a href="#local-6989586621682006975"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006974"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006974"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1078"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1079"></span><span>     </span><span class="hs-comment">-- put common cases first</span><span>
</span><span id="line-1080"></span><span>  </span><span id="local-6989586621682006975"><span class="annot"><span class="annottext">split :: Xi -&gt; Xi -&gt; ([PiTyBinder], Xi, Bool)
</span><a href="#local-6989586621682006975"><span class="hs-identifier hs-var hs-var">split</span></a></span></span><span> </span><span class="annot"><span class="annottext">Xi
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ForAllTy"><span class="hs-identifier hs-type">ForAllTy</span></a></span><span> </span><span id="local-6989586621682006976"><span class="annot"><span class="annottext">TyVarBinder
</span><a href="#local-6989586621682006976"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682006977"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006977"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- This bang is necessary lest we see rather</span><span>
</span><span id="line-1081"></span><span>                                       </span><span class="hs-comment">-- terrible reboxing, as noted in #19102.</span><span>
</span><span id="line-1082"></span><span>                                       </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621682006978"><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006978"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006979"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006979"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; Xi -&gt; ([PiTyBinder], Xi, Bool)
</span><a href="#local-6989586621682006975"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006977"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006977"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-1083"></span><span>                                   </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVarBinder -&gt; PiTyBinder
</span><a href="GHC.Types.Var.html#Named"><span class="hs-identifier hs-var">Named</span></a></span><span> </span><span class="annot"><span class="annottext">TyVarBinder
</span><a href="#local-6989586621682006976"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">PiTyBinder -&gt; [PiTyBinder] -&gt; [PiTyBinder]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006978"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006979"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-1084"></span><span>  </span><span class="annot"><a href="#local-6989586621682006975"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#FunTy"><span class="hs-identifier hs-type">FunTy</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ft_af :: Xi -&gt; FunTyFlag
</span><a href="GHC.Core.TyCo.Rep.html#ft_af"><span class="hs-identifier hs-var">ft_af</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006981"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682006981"><span class="hs-identifier hs-var">af</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_mult :: Xi -&gt; Xi
</span><a href="GHC.Core.TyCo.Rep.html#ft_mult"><span class="hs-identifier hs-var">ft_mult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006982"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006982"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_arg :: Xi -&gt; Xi
</span><a href="GHC.Core.TyCo.Rep.html#ft_arg"><span class="hs-identifier hs-var">ft_arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006983"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006983"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ft_res :: Xi -&gt; Xi
</span><a href="GHC.Core.TyCo.Rep.html#ft_res"><span class="hs-identifier hs-var">ft_res</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682006984"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006984"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1085"></span><span>                                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- See #19102</span><span>
</span><span id="line-1086"></span><span>                                       </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621682006985"><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006985"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006986"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006986"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682006987"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006987"><span class="hs-identifier hs-var">named</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; Xi -&gt; ([PiTyBinder], Xi, Bool)
</span><a href="#local-6989586621682006975"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006984"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006984"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-1087"></span><span>                                   </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scaled Xi -&gt; FunTyFlag -&gt; PiTyBinder
</span><a href="GHC.Types.Var.html#Anon"><span class="hs-identifier hs-var">Anon</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi -&gt; Xi -&gt; Scaled Xi
forall a. Xi -&gt; a -&gt; Scaled a
</span><a href="GHC.Core.Type.html#mkScaled"><span class="hs-identifier hs-var">mkScaled</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006982"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006983"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682006981"><span class="hs-identifier hs-var">af</span></a></span><span> </span><span class="annot"><span class="annottext">PiTyBinder -&gt; [PiTyBinder] -&gt; [PiTyBinder]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682006985"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006986"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682006987"><span class="hs-identifier hs-var">named</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1088"></span><span>
</span><span id="line-1089"></span><span>  </span><span class="annot"><a href="#local-6989586621682006975"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span id="local-6989586621682006990"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006990"><span class="hs-identifier hs-var">orig_ty</span></a></span></span><span> </span><span id="local-6989586621682006991"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006991"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621682006992"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006992"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; Maybe Xi
</span><a href="GHC.Core.Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006991"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Xi -&gt; Xi -&gt; ([PiTyBinder], Xi, Bool)
</span><a href="#local-6989586621682006975"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006990"><span class="hs-identifier hs-var">orig_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006992"><span class="hs-identifier hs-var">ty'</span></a></span><span>
</span><span id="line-1090"></span><span>  </span><span class="annot"><a href="#local-6989586621682006975"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span id="local-6989586621682006994"><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006994"><span class="hs-identifier hs-var">orig_ty</span></a></span></span><span> </span><span class="annot"><span class="annottext">Xi
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Xi
</span><a href="#local-6989586621682006994"><span class="hs-identifier hs-var">orig_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-1091"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#split_pi_tys%27"><span class="hs-pragma hs-type">split_pi_tys'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1092"></span><span>
</span><span id="line-1093"></span><span class="hs-comment">-- | Like 'tyConBindersPiTyBinders' but you also get a 'Bool' which is true iff</span><span>
</span><span id="line-1094"></span><span class="hs-comment">-- there is at least one named binder.</span><span>
</span><span id="line-1095"></span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#ty_con_binders_ty_binders%27"><span class="hs-identifier hs-type">ty_con_binders_ty_binders'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCon.html#TyConBinder"><span class="hs-identifier hs-type">TyConBinder</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#PiTyBinder"><span class="hs-identifier hs-type">PiTyBinder</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-1096"></span><span id="ty_con_binders_ty_binders%27"><span class="annot"><span class="annottext">ty_con_binders_ty_binders' :: [TyConBinder] -&gt; ([PiTyBinder], Bool)
</span><a href="GHC.Tc.Solver.Rewrite.html#ty_con_binders_ty_binders%27"><span class="hs-identifier hs-var hs-var">ty_con_binders_ty_binders'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TyConBinder -&gt; ([PiTyBinder], Bool) -&gt; ([PiTyBinder], Bool))
-&gt; ([PiTyBinder], Bool) -&gt; [TyConBinder] -&gt; ([PiTyBinder], Bool)
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldr/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">TyConBinder -&gt; ([PiTyBinder], Bool) -&gt; ([PiTyBinder], Bool)
</span><a href="#local-6989586621682006997"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-1097"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1098"></span><span>    </span><span id="local-6989586621682006997"><span class="annot"><span class="annottext">go :: TyConBinder -&gt; ([PiTyBinder], Bool) -&gt; ([PiTyBinder], Bool)
</span><a href="#local-6989586621682006997"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621682006999"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006999"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#NamedTCB"><span class="hs-identifier hs-type">NamedTCB</span></a></span><span> </span><span id="local-6989586621682007001"><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682007001"><span class="hs-identifier hs-var">vis</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682007002"><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682007002"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1099"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVarBinder -&gt; PiTyBinder
</span><a href="GHC.Types.Var.html#Named"><span class="hs-identifier hs-var">Named</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; ForAllTyFlag -&gt; TyVarBinder
forall var argf. var -&gt; argf -&gt; VarBndr var argf
</span><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682006999"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">ForAllTyFlag
</span><a href="#local-6989586621682007001"><span class="hs-identifier hs-var">vis</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PiTyBinder -&gt; [PiTyBinder] -&gt; [PiTyBinder]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682007002"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-1100"></span><span>    </span><span class="annot"><a href="#local-6989586621682006997"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Bndr"><span class="hs-identifier hs-type">Bndr</span></a></span><span> </span><span id="local-6989586621682007003"><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682007003"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCon.html#AnonTCB"><span class="hs-identifier hs-type">AnonTCB</span></a></span><span> </span><span id="local-6989586621682007005"><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682007005"><span class="hs-identifier hs-var">af</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><span id="local-6989586621682007006"><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682007006"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682007007"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682007007"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1101"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scaled Xi -&gt; FunTyFlag -&gt; PiTyBinder
</span><a href="GHC.Types.Var.html#Anon"><span class="hs-identifier hs-var">Anon</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Xi -&gt; Scaled Xi
forall a. a -&gt; Scaled a
</span><a href="GHC.Core.Type.html#tymult"><span class="hs-identifier hs-var">tymult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TcTyVar -&gt; Xi
</span><a href="GHC.Types.Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a></span><span> </span><span class="annot"><span class="annottext">TcTyVar
</span><a href="#local-6989586621682007003"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FunTyFlag
</span><a href="#local-6989586621682007005"><span class="hs-identifier hs-var">af</span></a></span><span> </span><span class="annot"><span class="annottext">PiTyBinder -&gt; [PiTyBinder] -&gt; [PiTyBinder]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PiTyBinder]
</span><a href="#local-6989586621682007006"><span class="hs-identifier hs-var">bndrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682007007"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1102"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621682006997"><span class="hs-pragma hs-type">go</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1103"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Rewrite.html#ty_con_binders_ty_binders%27"><span class="hs-pragma hs-type">ty_con_binders_ty_binders'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1104"></span></pre></body></html>