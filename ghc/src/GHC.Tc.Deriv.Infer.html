<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="annot"><span class="hs-comment">-- | Functions for inferring (and simplifying) the context for derived instances.</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Tc.Deriv.Infer</span><span>
</span><span id="line-12"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Infer.html#inferConstraints"><span class="hs-identifier">inferConstraints</span></a></span><span>
</span><span id="line-13"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Infer.html#simplifyInstanceContexts"><span class="hs-identifier">simplifyInstanceContexts</span></a></span><span>
</span><span id="line-14"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">where</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html"><span class="hs-identifier">GHC.Tc.Deriv.Utils</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Env.html"><span class="hs-identifier">GHC.Tc.Utils.Env</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Generate.html"><span class="hs-identifier">GHC.Tc.Deriv.Generate</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Functor.html"><span class="hs-identifier">GHC.Tc.Deriv.Functor</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Generics.html"><span class="hs-identifier">GHC.Tc.Deriv.Generics</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcMType.html"><span class="hs-identifier">GHC.Tc.Utils.TcMType</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Monad.html"><span class="hs-identifier">GHC.Tc.Utils.Monad</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html"><span class="hs-identifier">GHC.Tc.Types.Origin</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html"><span class="hs-identifier">GHC.Tc.Types.Constraint</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.TcType.html"><span class="hs-identifier">GHC.Tc.Utils.TcType</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.html"><span class="hs-identifier">GHC.Tc.Solver</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html"><span class="hs-identifier">GHC.Tc.Solver.Monad</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Tc.Solver.Monad.html#runTcS"><span class="hs-identifier">runTcS</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Validity.html"><span class="hs-identifier">GHC.Tc.Validity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Validity.html#validDerivPred"><span class="hs-identifier">validDerivPred</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Tc.Utils.Unify.html"><span class="hs-identifier">GHC.Tc.Utils.Unify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Utils.Unify.html#buildImplicationFor"><span class="hs-identifier">buildImplicationFor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Class.html"><span class="hs-identifier">GHC.Core.Class</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCon.html"><span class="hs-identifier">GHC.Core.TyCon</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html"><span class="hs-identifier">GHC.Core.TyCo.Ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.TyCo.Ppr.html#pprTyVars"><span class="hs-identifier">pprTyVars</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Type.html"><span class="hs-identifier">GHC.Core.Type</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Predicate.html"><span class="hs-identifier">GHC.Core.Predicate</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Unify.html"><span class="hs-identifier">GHC.Core.Unify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.Unify.html#tcUnifyTy"><span class="hs-identifier">tcUnifyTy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Pair.html"><span class="hs-identifier">GHC.Data.Pair</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Types.html"><span class="hs-identifier">GHC.Builtin.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Builtin.Types.html#typeToTypeKind"><span class="hs-identifier">typeToTypeKind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Error.html"><span class="hs-identifier">GHC.Utils.Error</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.Plain.html"><span class="hs-identifier">GHC.Utils.Panic.Plain</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.html"><span class="hs-identifier">GHC.Types.Var</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html"><span class="hs-identifier">GHC.Data.Bag</span></a></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Control.Monad.html#/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#/Control.Monad.Trans.Class.html"><span class="hs-identifier">Control.Monad.Trans.Class</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier">lift</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Reader.html#/Control.Monad.Trans.Reader.html"><span class="hs-identifier">Control.Monad.Trans.Reader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Reader.html#ask/Control.Monad.Trans.Reader.html#ask"><span class="hs-identifier">ask</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Function.html#/Data.Function.html"><span class="hs-identifier">Data.Function</span></a></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Function.html#on/Data.Function.html#on"><span class="hs-identifier">on</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Functor.Classes.html#/Data.Functor.Classes.html"><span class="hs-identifier">Data.Functor.Classes</span></a></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Functor.Classes.html#liftEq/Data.Functor.Classes.html#liftEq"><span class="hs-identifier">liftEq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.List.html#/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>                  </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.18.3.0/src/Data.OldList.html#sortBy/Data.OldList.html#sortBy"><span class="hs-identifier">sortBy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/Data.Maybe.html#/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-comment">----------------------</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="annot"><a href="GHC.Tc.Deriv.Infer.html#inferConstraints"><span class="hs-identifier hs-type">inferConstraints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivSpecMechanism"><span class="hs-identifier hs-type">DerivSpecMechanism</span></a></span><span>
</span><span id="line-68"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivM"><span class="hs-identifier hs-type">DerivM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivSpecMechanism"><span class="hs-identifier hs-type">DerivSpecMechanism</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- inferConstraints figures out the constraints needed for the</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- instance declaration generated by a 'deriving' clause on a</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- data type declaration. It also returns the new in-scope type</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- variables and instance types, in case they were changed due to</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- the presence of functor-like constraints.</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- See Note [Inferring the instance context]</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">-- e.g. inferConstraints</span><span>
</span><span id="line-77"></span><span class="hs-comment">--        C Int (T [a])    -- Class and inst_tys</span><span>
</span><span id="line-78"></span><span class="hs-comment">--        :RTList a        -- Rep tycon and its arg tys</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- where T [a] ~R :RTList a</span><span>
</span><span id="line-80"></span><span class="hs-comment">--</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- Generate a sufficiently large set of constraints that typechecking the</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- generated method definitions should succeed.   This set will be simplified</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- before being used in the instance declaration</span><span>
</span><span id="line-84"></span><span id="inferConstraints"><span class="annot"><span class="annottext">inferConstraints :: DerivSpecMechanism
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
</span><a href="GHC.Tc.Deriv.Infer.html#inferConstraints"><span class="hs-identifier hs-var hs-var">inferConstraints</span></a></span></span><span> </span><span id="local-6989586621682056753"><span class="annot"><span class="annottext">DerivSpecMechanism
</span><a href="#local-6989586621682056753"><span class="hs-identifier hs-var">mechanism</span></a></span></span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivEnv"><span class="hs-identifier hs-type">DerivEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">denv_tvs :: DerivEnv -&gt; [TyVar]
</span><a href="GHC.Tc.Deriv.Utils.html#denv_tvs"><span class="hs-identifier hs-var">denv_tvs</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056756"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056756"><span class="hs-identifier hs-var">tvs</span></a></span></span><span>
</span><span id="line-86"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">denv_cls :: DerivEnv -&gt; Class
</span><a href="GHC.Tc.Deriv.Utils.html#denv_cls"><span class="hs-identifier hs-var">denv_cls</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056758"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056758"><span class="hs-identifier hs-var">main_cls</span></a></span></span><span>
</span><span id="line-87"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">denv_inst_tys :: DerivEnv -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Utils.html#denv_inst_tys"><span class="hs-identifier hs-var">denv_inst_tys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056760"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056760"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) DerivEnv
forall (m :: * -&gt; *) r. Monad m =&gt; ReaderT r m r
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Reader.html#ask/Control.Monad.Trans.Reader.html#ask"><span class="hs-identifier hs-var">ask</span></a></span><span>
</span><span id="line-88"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682056761"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056761"><span class="hs-identifier hs-var">wildcard</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DerivM Bool
</span><a href="GHC.Tc.Deriv.Utils.html#isStandaloneWildcardDeriv"><span class="hs-identifier hs-var">isStandaloneWildcardDeriv</span></a></span><span>
</span><span id="line-89"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621682056763"><span class="hs-identifier hs-type">infer_constraints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivM"><span class="hs-identifier hs-type">DerivM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivSpecMechanism"><span class="hs-identifier hs-type">DerivSpecMechanism</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>             </span><span id="local-6989586621682056763"><span class="annot"><span class="annottext">infer_constraints :: DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
</span><a href="#local-6989586621682056763"><span class="hs-identifier hs-var hs-var">infer_constraints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-91"></span><span>               </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DerivSpecMechanism
</span><a href="#local-6989586621682056753"><span class="hs-identifier hs-var">mechanism</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-92"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivSpecStock"><span class="hs-identifier hs-type">DerivSpecStock</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">dsm_stock_dit :: DerivSpecMechanism -&gt; DerivInstTys
</span><a href="GHC.Tc.Deriv.Utils.html#dsm_stock_dit"><span class="hs-identifier hs-var">dsm_stock_dit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056766"><span class="annot"><span class="annottext">DerivInstTys
</span><a href="#local-6989586621682056766"><span class="hs-identifier hs-var">dit</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-93"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682056767"><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056767"><span class="hs-identifier hs-var">thetas</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056768"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056768"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056769"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056769"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056770"><span class="annot"><span class="annottext">DerivInstTys
</span><a href="#local-6989586621682056770"><span class="hs-identifier hs-var">dit'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DerivInstTys
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
</span><a href="GHC.Tc.Deriv.Infer.html#inferConstraintsStock"><span class="hs-identifier hs-var">inferConstraintsStock</span></a></span><span> </span><span class="annot"><span class="annottext">DerivInstTys
</span><a href="#local-6989586621682056766"><span class="hs-identifier hs-var">dit</span></a></span><span>
</span><span id="line-94"></span><span>                         </span><span class="annot"><span class="annottext">(ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
forall a. a -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056767"><span class="hs-identifier hs-var">thetas</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056768"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056769"><span class="hs-identifier hs-var">inst_tys</span></a></span><span>
</span><span id="line-95"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DerivSpecMechanism
</span><a href="#local-6989586621682056753"><span class="hs-identifier hs-var">mechanism</span></a></span><span class="hs-special">{</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#dsm_stock_dit"><span class="hs-identifier hs-var">dsm_stock_dit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621682056770"><span class="hs-identifier hs-type">dit'</span></a></span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>                 </span><span class="annot"><span class="annottext">DerivSpecMechanism
</span><a href="GHC.Tc.Deriv.Utils.html#DerivSpecAnyClass"><span class="hs-identifier hs-var">DerivSpecAnyClass</span></a></span><span>
</span><span id="line-97"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DerivM ThetaSpec
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
</span><a href="#local-6989586621682056773"><span class="hs-identifier hs-var">infer_constraints_simple</span></a></span><span> </span><span class="annot"><span class="annottext">DerivM ThetaSpec
</span><a href="GHC.Tc.Deriv.Infer.html#inferConstraintsAnyclass"><span class="hs-identifier hs-var">inferConstraintsAnyclass</span></a></span><span>
</span><span id="line-98"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivSpecNewtype"><span class="hs-identifier hs-type">DerivSpecNewtype</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">dsm_newtype_dit :: DerivSpecMechanism -&gt; DerivInstTys
</span><a href="GHC.Tc.Deriv.Utils.html#dsm_newtype_dit"><span class="hs-identifier hs-var">dsm_newtype_dit</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-99"></span><span>                                      </span><span class="annot"><a href="GHC.Tc.Deriv.Generate.html#DerivInstTys"><span class="hs-identifier hs-type">DerivInstTys</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">dit_cls_tys :: DerivInstTys -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Generate.html#dit_cls_tys"><span class="hs-identifier hs-var">dit_cls_tys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056779"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056779"><span class="hs-identifier hs-var">cls_tys</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-100"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dsm_newtype_rep_ty :: DerivSpecMechanism -&gt; PredType
</span><a href="GHC.Tc.Deriv.Utils.html#dsm_newtype_rep_ty"><span class="hs-identifier hs-var">dsm_newtype_rep_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056781"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056781"><span class="hs-identifier hs-var">rep_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-101"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DerivM ThetaSpec
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
</span><a href="#local-6989586621682056773"><span class="hs-identifier hs-var">infer_constraints_simple</span></a></span><span> </span><span class="annot"><span class="annottext">(DerivM ThetaSpec
 -&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism))
-&gt; DerivM ThetaSpec
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-102"></span><span>                      </span><span class="annot"><span class="annottext">[PredType] -&gt; PredType -&gt; DerivM ThetaSpec
</span><a href="GHC.Tc.Deriv.Infer.html#inferConstraintsCoerceBased"><span class="hs-identifier hs-var">inferConstraintsCoerceBased</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056779"><span class="hs-identifier hs-var">cls_tys</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056781"><span class="hs-identifier hs-var">rep_ty</span></a></span><span>
</span><span id="line-103"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivSpecVia"><span class="hs-identifier hs-type">DerivSpecVia</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">dsm_via_cls_tys :: DerivSpecMechanism -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Utils.html#dsm_via_cls_tys"><span class="hs-identifier hs-var">dsm_via_cls_tys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056785"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056785"><span class="hs-identifier hs-var">cls_tys</span></a></span></span><span>
</span><span id="line-104"></span><span>                              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dsm_via_ty :: DerivSpecMechanism -&gt; PredType
</span><a href="GHC.Tc.Deriv.Utils.html#dsm_via_ty"><span class="hs-identifier hs-var">dsm_via_ty</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056787"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056787"><span class="hs-identifier hs-var">via_ty</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-105"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DerivM ThetaSpec
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
</span><a href="#local-6989586621682056773"><span class="hs-identifier hs-var">infer_constraints_simple</span></a></span><span> </span><span class="annot"><span class="annottext">(DerivM ThetaSpec
 -&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism))
-&gt; DerivM ThetaSpec
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-106"></span><span>                      </span><span class="annot"><span class="annottext">[PredType] -&gt; PredType -&gt; DerivM ThetaSpec
</span><a href="GHC.Tc.Deriv.Infer.html#inferConstraintsCoerceBased"><span class="hs-identifier hs-var">inferConstraintsCoerceBased</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056785"><span class="hs-identifier hs-var">cls_tys</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056787"><span class="hs-identifier hs-var">via_ty</span></a></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span>             </span><span class="hs-comment">-- Most deriving strategies do not need to do anything special to</span><span>
</span><span id="line-109"></span><span>             </span><span class="hs-comment">-- the type variables and arguments to the class in the derived</span><span>
</span><span id="line-110"></span><span>             </span><span class="hs-comment">-- instance, so they can pass through unchanged. The exception to</span><span>
</span><span id="line-111"></span><span>             </span><span class="hs-comment">-- this rule is stock deriving. See</span><span>
</span><span id="line-112"></span><span>             </span><span class="hs-comment">-- Note [Inferring the instance context].</span><span>
</span><span id="line-113"></span><span>             </span><span class="annot"><a href="#local-6989586621682056773"><span class="hs-identifier hs-type">infer_constraints_simple</span></a></span><span>
</span><span id="line-114"></span><span>               </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivM"><span class="hs-identifier hs-type">DerivM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span>
</span><span id="line-115"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivM"><span class="hs-identifier hs-type">DerivM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivSpecMechanism"><span class="hs-identifier hs-type">DerivSpecMechanism</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>             </span><span id="local-6989586621682056773"><span class="annot"><span class="annottext">infer_constraints_simple :: DerivM ThetaSpec
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
</span><a href="#local-6989586621682056773"><span class="hs-identifier hs-var hs-var">infer_constraints_simple</span></a></span></span><span> </span><span id="local-6989586621682056788"><span class="annot"><span class="annottext">DerivM ThetaSpec
</span><a href="#local-6989586621682056788"><span class="hs-identifier hs-var">infer_thetas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>               </span><span id="local-6989586621682056789"><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056789"><span class="hs-identifier hs-var">thetas</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DerivM ThetaSpec
</span><a href="#local-6989586621682056788"><span class="hs-identifier hs-var">infer_thetas</span></a></span><span>
</span><span id="line-118"></span><span>               </span><span class="annot"><span class="annottext">(ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
forall a. a -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056789"><span class="hs-identifier hs-var">thetas</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056756"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056760"><span class="hs-identifier hs-var">inst_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DerivSpecMechanism
</span><a href="#local-6989586621682056753"><span class="hs-identifier hs-var">mechanism</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span>             </span><span class="hs-comment">-- Constraints arising from superclasses</span><span>
</span><span id="line-121"></span><span>             </span><span class="hs-comment">-- See Note [Superclasses of derived instance]</span><span>
</span><span id="line-122"></span><span>             </span><span id="local-6989586621682056790"><span class="annot"><span class="annottext">cls_tvs :: [TyVar]
</span><a href="#local-6989586621682056790"><span class="hs-identifier hs-var hs-var">cls_tvs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [TyVar]
</span><a href="GHC.Core.Class.html#classTyVars"><span class="hs-identifier hs-var">classTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056758"><span class="hs-identifier hs-var">main_cls</span></a></span><span>
</span><span id="line-123"></span><span>             </span><span id="local-6989586621682056792"><span class="annot"><span class="annottext">sc_constraints :: ThetaSpec
</span><a href="#local-6989586621682056792"><span class="hs-identifier hs-var hs-var">sc_constraints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SDoc -&gt; ThetaSpec -&gt; ThetaSpec
forall a. HasCallStack =&gt; Bool -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.html#assertPpr"><span class="hs-identifier hs-var">assertPpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [PredType] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056790"><span class="hs-identifier hs-var">cls_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056760"><span class="hs-identifier hs-var">inst_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056758"><span class="hs-identifier hs-var">main_cls</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056760"><span class="hs-identifier hs-var">inst_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ThetaSpec -&gt; ThetaSpec) -&gt; ThetaSpec -&gt; ThetaSpec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-125"></span><span>                              </span><span class="annot"><span class="annottext">CtOrigin -&gt; TypeOrKind -&gt; [PredType] -&gt; ThetaSpec
</span><a href="GHC.Tc.Deriv.Utils.html#mkDirectThetaSpec"><span class="hs-identifier hs-var">mkDirectThetaSpec</span></a></span><span>
</span><span id="line-126"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; CtOrigin
</span><a href="GHC.Tc.Deriv.Utils.html#mkDerivOrigin"><span class="hs-identifier hs-var">mkDerivOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056761"><span class="hs-identifier hs-var">wildcard</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a></span><span>
</span><span id="line-127"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; [PredType] -&gt; [PredType]
Subst -&gt; [PredType] -&gt; [PredType]
</span><a href="GHC.Core.TyCo.Subst.html#substTheta"><span class="hs-identifier hs-var">substTheta</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682056801"><span class="hs-identifier hs-var">cls_subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [PredType]
</span><a href="GHC.Core.Class.html#classSCTheta"><span class="hs-identifier hs-var">classSCTheta</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056758"><span class="hs-identifier hs-var">main_cls</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>             </span><span id="local-6989586621682056801"><span class="annot"><span class="annottext">cls_subst :: Subst
</span><a href="#local-6989586621682056801"><span class="hs-identifier hs-var hs-var">cls_subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Subst -&gt; Subst
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; [PredType] -&gt; Bool
forall a b. [a] -&gt; [b] -&gt; Bool
</span><a href="GHC.Utils.Misc.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056790"><span class="hs-identifier hs-var">cls_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056760"><span class="hs-identifier hs-var">inst_tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Subst) -&gt; Subst -&gt; Subst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-129"></span><span>                         </span><span class="annot"><span class="annottext">[TyVar] -&gt; [PredType] -&gt; Subst
(() :: Constraint) =&gt; [TyVar] -&gt; [PredType] -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#zipTvSubst"><span class="hs-identifier hs-var">zipTvSubst</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056790"><span class="hs-identifier hs-var">cls_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056760"><span class="hs-identifier hs-var">inst_tys</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682056805"><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056805"><span class="hs-identifier hs-var">inferred_constraints</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056806"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056806"><span class="hs-identifier hs-var">tvs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056807"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056807"><span class="hs-identifier hs-var">inst_tys'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056808"><span class="annot"><span class="annottext">DerivSpecMechanism
</span><a href="#local-6989586621682056808"><span class="hs-identifier hs-var">mechanism'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
</span><a href="#local-6989586621682056763"><span class="hs-identifier hs-var">infer_constraints</span></a></span><span>
</span><span id="line-133"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcRn () -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ReaderT DerivEnv m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRn () -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) ())
-&gt; TcRn () -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inferConstraints&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcRn ()) -&gt; SDoc -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-134"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Class -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056758"><span class="hs-identifier hs-var">main_cls</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056807"><span class="hs-identifier hs-var">inst_tys'</span></a></span><span>
</span><span id="line-135"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThetaSpec -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056805"><span class="hs-identifier hs-var">inferred_constraints</span></a></span><span>
</span><span id="line-136"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-137"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivSpecMechanism)
forall a. a -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056792"><span class="hs-identifier hs-var">sc_constraints</span></a></span><span> </span><span class="annot"><span class="annottext">ThetaSpec -&gt; ThetaSpec -&gt; ThetaSpec
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056805"><span class="hs-identifier hs-var">inferred_constraints</span></a></span><span>
</span><span id="line-138"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056806"><span class="hs-identifier hs-var">tvs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056807"><span class="hs-identifier hs-var">inst_tys'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DerivSpecMechanism
</span><a href="#local-6989586621682056808"><span class="hs-identifier hs-var">mechanism'</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="hs-comment">-- | Like 'inferConstraints', but used only in the case of the @stock@ deriving</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- strategy. The constraints are inferred by inspecting the fields of each data</span><span>
</span><span id="line-142"></span><span class="hs-comment">-- constructor. In this example:</span><span>
</span><span id="line-143"></span><span class="hs-comment">--</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- &gt; data Foo = MkFoo Int Char deriving Show</span><span>
</span><span id="line-145"></span><span class="hs-comment">--</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- We would infer the following constraints ('ThetaSpec's):</span><span>
</span><span id="line-147"></span><span class="hs-comment">--</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- &gt; (Show Int, Show Char)</span><span>
</span><span id="line-149"></span><span class="hs-comment">--</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- Note that this function also returns the type variables ('TyVar's) and</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- class arguments ('TcType's) for the resulting instance. This is because</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- when deriving 'Functor'-like classes, we must sometimes perform kind</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- substitutions to ensure the resulting instance is well kinded, which may</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- affect the type variables and class arguments. In this example:</span><span>
</span><span id="line-155"></span><span class="hs-comment">--</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- &gt; newtype Compose (f :: k -&gt; Type) (g :: Type -&gt; k) (a :: Type) =</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- &gt;   Compose (f (g a)) deriving stock Functor</span><span>
</span><span id="line-158"></span><span class="hs-comment">--</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- We must unify @k@ with @Type@ in order for the resulting 'Functor' instance</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- to be well kinded, so we return @[]@/@[Type, f, g]@ for the</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- 'TyVar's/'TcType's, /not/ @[k]@/@[k, f, g]@.</span><span>
</span><span id="line-162"></span><span class="hs-comment">-- See Note [Inferring the instance context].</span><span>
</span><span id="line-163"></span><span class="annot"><a href="GHC.Tc.Deriv.Infer.html#inferConstraintsStock"><span class="hs-identifier hs-type">inferConstraintsStock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Generate.html#DerivInstTys"><span class="hs-identifier hs-type">DerivInstTys</span></a></span><span>
</span><span id="line-164"></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivM"><span class="hs-identifier hs-type">DerivM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Generate.html#DerivInstTys"><span class="hs-identifier hs-type">DerivInstTys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span id="inferConstraintsStock"><span class="annot"><span class="annottext">inferConstraintsStock :: DerivInstTys
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
</span><a href="GHC.Tc.Deriv.Infer.html#inferConstraintsStock"><span class="hs-identifier hs-var hs-var">inferConstraintsStock</span></a></span></span><span> </span><span id="local-6989586621682056811"><span class="annot"><span class="annottext">dit :: DerivInstTys
</span><a href="#local-6989586621682056811"><span class="hs-identifier hs-var">dit</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Deriv.Generate.html#DerivInstTys"><span class="hs-identifier hs-type">DerivInstTys</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">dit_cls_tys :: DerivInstTys -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Generate.html#dit_cls_tys"><span class="hs-identifier hs-var">dit_cls_tys</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056812"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056812"><span class="hs-identifier hs-var">cls_tys</span></a></span></span><span>
</span><span id="line-166"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dit_tc :: DerivInstTys -&gt; TyCon
</span><a href="GHC.Tc.Deriv.Generate.html#dit_tc"><span class="hs-identifier hs-var">dit_tc</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056814"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682056814"><span class="hs-identifier hs-var">tc</span></a></span></span><span>
</span><span id="line-167"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dit_tc_args :: DerivInstTys -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Generate.html#dit_tc_args"><span class="hs-identifier hs-var">dit_tc_args</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056816"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056816"><span class="hs-identifier hs-var">tc_args</span></a></span></span><span>
</span><span id="line-168"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dit_rep_tc :: DerivInstTys -&gt; TyCon
</span><a href="GHC.Tc.Deriv.Generate.html#dit_rep_tc"><span class="hs-identifier hs-var">dit_rep_tc</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056818"><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682056818"><span class="hs-identifier hs-var">rep_tc</span></a></span></span><span>
</span><span id="line-169"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dit_rep_tc_args :: DerivInstTys -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Generate.html#dit_rep_tc_args"><span class="hs-identifier hs-var">dit_rep_tc_args</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056820"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056820"><span class="hs-identifier hs-var">rep_tc_args</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivEnv"><span class="hs-identifier hs-type">DerivEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">denv_tvs :: DerivEnv -&gt; [TyVar]
</span><a href="GHC.Tc.Deriv.Utils.html#denv_tvs"><span class="hs-identifier hs-var">denv_tvs</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056821"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056821"><span class="hs-identifier hs-var">tvs</span></a></span></span><span>
</span><span id="line-171"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">denv_cls :: DerivEnv -&gt; Class
</span><a href="GHC.Tc.Deriv.Utils.html#denv_cls"><span class="hs-identifier hs-var">denv_cls</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056822"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056822"><span class="hs-identifier hs-var">main_cls</span></a></span></span><span>
</span><span id="line-172"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">denv_inst_tys :: DerivEnv -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Utils.html#denv_inst_tys"><span class="hs-identifier hs-var">denv_inst_tys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056823"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056823"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) DerivEnv
forall (m :: * -&gt; *) r. Monad m =&gt; ReaderT r m r
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Reader.html#ask/Control.Monad.Trans.Reader.html#ask"><span class="hs-identifier hs-var">ask</span></a></span><span>
</span><span id="line-173"></span><span>       </span><span id="local-6989586621682056824"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056824"><span class="hs-identifier hs-var">wildcard</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DerivM Bool
</span><a href="GHC.Tc.Deriv.Utils.html#isStandaloneWildcardDeriv"><span class="hs-identifier hs-var">isStandaloneWildcardDeriv</span></a></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span>       </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682056825"><span class="annot"><span class="annottext">inst_ty :: PredType
</span><a href="#local-6989586621682056825"><span class="hs-identifier hs-var hs-var">inst_ty</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [PredType] -&gt; PredType
</span><a href="GHC.Core.Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682056814"><span class="hs-identifier hs-var">tc</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056816"><span class="hs-identifier hs-var">tc_args</span></a></span><span>
</span><span id="line-176"></span><span>           </span><span id="local-6989586621682056827"><span class="annot"><span class="annottext">tc_binders :: [TyConBinder]
</span><a href="#local-6989586621682056827"><span class="hs-identifier hs-var hs-var">tc_binders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [TyConBinder]
</span><a href="GHC.Core.TyCon.html#tyConBinders"><span class="hs-identifier hs-var">tyConBinders</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682056818"><span class="hs-identifier hs-var">rep_tc</span></a></span><span>
</span><span id="line-177"></span><span>           </span><span id="local-6989586621682056829"><span class="annot"><span class="annottext">choose_level :: TyConBinder -&gt; TypeOrKind
</span><a href="#local-6989586621682056829"><span class="hs-identifier hs-var hs-var">choose_level</span></a></span></span><span> </span><span id="local-6989586621682056830"><span class="annot"><span class="annottext">TyConBinder
</span><a href="#local-6989586621682056830"><span class="hs-identifier hs-var">bndr</span></a></span></span><span>
</span><span id="line-178"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TyConBinder -&gt; Bool
</span><a href="GHC.Core.TyCon.html#isNamedTyConBinder"><span class="hs-identifier hs-var">isNamedTyConBinder</span></a></span><span> </span><span class="annot"><span class="annottext">TyConBinder
</span><a href="#local-6989586621682056830"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a></span><span>
</span><span id="line-179"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a></span><span>
</span><span id="line-180"></span><span>           </span><span id="local-6989586621682056833"><span class="annot"><span class="annottext">t_or_ks :: [TypeOrKind]
</span><a href="#local-6989586621682056833"><span class="hs-identifier hs-var hs-var">t_or_ks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TyConBinder -&gt; TypeOrKind) -&gt; [TyConBinder] -&gt; [TypeOrKind]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">TyConBinder -&gt; TypeOrKind
</span><a href="#local-6989586621682056829"><span class="hs-identifier hs-var">choose_level</span></a></span><span> </span><span class="annot"><span class="annottext">[TyConBinder]
</span><a href="#local-6989586621682056827"><span class="hs-identifier hs-var">tc_binders</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeOrKind] -&gt; [TypeOrKind] -&gt; [TypeOrKind]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind -&gt; [TypeOrKind]
forall a. a -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#repeat/GHC.List.html#repeat"><span class="hs-identifier hs-var">repeat</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a></span><span>
</span><span id="line-181"></span><span>              </span><span class="hs-comment">-- want to report *kind* errors when possible</span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span>              </span><span class="hs-comment">-- Constraints arising from the arguments of each constructor</span><span>
</span><span id="line-184"></span><span>           </span><span class="annot"><a href="#local-6989586621682056835"><span class="hs-identifier hs-type">con_arg_constraints</span></a></span><span>
</span><span id="line-185"></span><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span>
</span><span id="line-186"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a></span><span>
</span><span id="line-187"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-188"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Utils.TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Generate.html#DerivInstTys"><span class="hs-identifier hs-type">DerivInstTys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>           </span><span id="local-6989586621682056835"><span class="annot"><span class="annottext">con_arg_constraints :: ([TyVar]
 -&gt; CtOrigin
 -&gt; TypeOrKind
 -&gt; PredType
 -&gt; [(ThetaSpec, Maybe Subst)])
-&gt; (ThetaSpec, [TyVar], [PredType], DerivInstTys)
</span><a href="#local-6989586621682056835"><span class="hs-identifier hs-var hs-var">con_arg_constraints</span></a></span></span><span> </span><span id="local-6989586621682056837"><span class="annot"><span class="annottext">[TyVar]
-&gt; CtOrigin -&gt; TypeOrKind -&gt; PredType -&gt; [(ThetaSpec, Maybe Subst)]
</span><a href="#local-6989586621682056837"><span class="hs-identifier hs-var">get_arg_constraints</span></a></span></span><span>
</span><span id="line-191"></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Constraints from the fields of each data constructor.</span><span>
</span><span id="line-192"></span><span>                   </span><span class="hs-special">(</span><span id="local-6989586621682056838"><span class="annot"><span class="annottext">[ThetaSpec]
</span><a href="#local-6989586621682056838"><span class="hs-identifier hs-var">predss</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056839"><span class="annot"><span class="annottext">[Maybe Subst]
</span><a href="#local-6989586621682056839"><span class="hs-identifier hs-var">mbSubsts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(ThetaSpec, Maybe Subst)] -&gt; ([ThetaSpec], [Maybe Subst])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><a href="../../base-4.18.3.0/src/GHC.List.html#unzip/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a></span><span>
</span><span id="line-193"></span><span>                     </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">(ThetaSpec, Maybe Subst)
</span><a href="#local-6989586621682056841"><span class="hs-identifier hs-var">preds_and_mbSubst</span></a></span><span>
</span><span id="line-194"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682056842"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682056842"><span class="hs-identifier hs-var">data_con</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [DataCon]
</span><a href="GHC.Core.TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682056818"><span class="hs-identifier hs-var">rep_tc</span></a></span><span>
</span><span id="line-195"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682056844"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682056844"><span class="hs-identifier hs-var">arg_n</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056845"><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056845"><span class="hs-identifier hs-var">arg_t_or_k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056846"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056846"><span class="hs-identifier hs-var">arg_ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>                         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Int]
-&gt; [TypeOrKind] -&gt; [PredType] -&gt; [(Int, TypeOrKind, PredType)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#zip3/GHC.List.html#zip3"><span class="hs-identifier hs-var">zip3</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[TypeOrKind]
</span><a href="#local-6989586621682056833"><span class="hs-identifier hs-var">t_or_ks</span></a></span><span> </span><span class="annot"><span class="annottext">([PredType] -&gt; [(Int, TypeOrKind, PredType)])
-&gt; [PredType] -&gt; [(Int, TypeOrKind, PredType)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-197"></span><span>                            </span><span class="annot"><span class="annottext">DataCon -&gt; DerivInstTys -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Generate.html#derivDataConInstArgTys"><span class="hs-identifier hs-var">derivDataConInstArgTys</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682056842"><span class="hs-identifier hs-var">data_con</span></a></span><span> </span><span class="annot"><span class="annottext">DerivInstTys
</span><a href="#local-6989586621682056811"><span class="hs-identifier hs-var">dit</span></a></span><span>
</span><span id="line-198"></span><span>                       </span><span class="hs-comment">-- No constraints for unlifted types</span><span>
</span><span id="line-199"></span><span>                       </span><span class="hs-comment">-- See Note [Deriving and unboxed types]</span><span>
</span><span id="line-200"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; PredType -&gt; Bool
PredType -&gt; Bool
</span><a href="GHC.Core.Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056846"><span class="hs-identifier hs-var">arg_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682056851"><span class="annot"><span class="annottext">orig :: CtOrigin
</span><a href="#local-6989586621682056851"><span class="hs-identifier hs-var hs-var">orig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; Int -&gt; Bool -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#DerivOriginDC"><span class="hs-identifier hs-var">DerivOriginDC</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682056842"><span class="hs-identifier hs-var">data_con</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682056844"><span class="hs-identifier hs-var">arg_n</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056824"><span class="hs-identifier hs-var">wildcard</span></a></span><span>
</span><span id="line-202"></span><span>                     </span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056841"><span class="annot"><span class="annottext">(ThetaSpec, Maybe Subst)
</span><a href="#local-6989586621682056841"><span class="hs-identifier hs-var">preds_and_mbSubst</span></a></span></span><span>
</span><span id="line-203"></span><span>                         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TyVar]
-&gt; CtOrigin -&gt; TypeOrKind -&gt; PredType -&gt; [(ThetaSpec, Maybe Subst)]
</span><a href="#local-6989586621682056837"><span class="hs-identifier hs-var">get_arg_constraints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [TyVar]
</span><a href="GHC.Core.DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682056842"><span class="hs-identifier hs-var">data_con</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>                                                </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056851"><span class="hs-identifier hs-var">orig</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056845"><span class="hs-identifier hs-var">arg_t_or_k</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056846"><span class="hs-identifier hs-var">arg_ty</span></a></span><span>
</span><span id="line-205"></span><span>                     </span><span class="hs-special">]</span><span>
</span><span id="line-206"></span><span>                   </span><span class="hs-comment">-- Stupid constraints from DatatypeContexts. Note that we</span><span>
</span><span id="line-207"></span><span>                   </span><span class="hs-comment">-- must gather these constraints from the data constructors,</span><span>
</span><span id="line-208"></span><span>                   </span><span class="hs-comment">-- not from the parent type constructor, as the latter could</span><span>
</span><span id="line-209"></span><span>                   </span><span class="hs-comment">-- lead to redundant constraints due to thinning.</span><span>
</span><span id="line-210"></span><span>                   </span><span class="hs-comment">-- See Note [The stupid context] in GHC.Core.DataCon.</span><span>
</span><span id="line-211"></span><span>                   </span><span id="local-6989586621682056854"><span class="annot"><span class="annottext">stupid_theta :: [PredType]
</span><a href="#local-6989586621682056854"><span class="hs-identifier hs-var hs-var">stupid_theta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-212"></span><span>                     </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [PredType] -&gt; PredType -&gt; PredType
(() :: Constraint) =&gt; [TyVar] -&gt; [PredType] -&gt; PredType -&gt; PredType
</span><a href="GHC.Core.TyCo.Subst.html#substTyWith"><span class="hs-identifier hs-var">substTyWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [TyVar]
</span><a href="GHC.Core.DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682056856"><span class="hs-identifier hs-var">data_con</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; [PredType] -&gt; [PredType]
</span><a href="GHC.Core.DataCon.html#dataConInstUnivs"><span class="hs-identifier hs-var">dataConInstUnivs</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682056856"><span class="hs-identifier hs-var">data_con</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056820"><span class="hs-identifier hs-var">rep_tc_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>                                   </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056858"><span class="hs-identifier hs-var">stupid_pred</span></a></span><span>
</span><span id="line-215"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682056856"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682056856"><span class="hs-identifier hs-var">data_con</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyCon -&gt; [DataCon]
</span><a href="GHC.Core.TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682056818"><span class="hs-identifier hs-var">rep_tc</span></a></span><span>
</span><span id="line-216"></span><span>                     </span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056858"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056858"><span class="hs-identifier hs-var">stupid_pred</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [PredType]
</span><a href="GHC.Core.DataCon.html#dataConStupidTheta"><span class="hs-identifier hs-var">dataConStupidTheta</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621682056856"><span class="hs-identifier hs-var">data_con</span></a></span><span>
</span><span id="line-217"></span><span>                     </span><span class="hs-special">]</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span>                   </span><span id="local-6989586621682056860"><span class="annot"><span class="annottext">preds :: ThetaSpec
</span><a href="#local-6989586621682056860"><span class="hs-identifier hs-var hs-var">preds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ThetaSpec] -&gt; ThetaSpec
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#concat/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="annot"><span class="annottext">[ThetaSpec]
</span><a href="#local-6989586621682056838"><span class="hs-identifier hs-var">predss</span></a></span><span>
</span><span id="line-220"></span><span>                   </span><span class="hs-comment">-- If the constraints require a subtype to be of kind</span><span>
</span><span id="line-221"></span><span>                   </span><span class="hs-comment">-- (* -&gt; *) (which is the case for functor-like</span><span>
</span><span id="line-222"></span><span>                   </span><span class="hs-comment">-- constraints), then we explicitly unify the subtype's</span><span>
</span><span id="line-223"></span><span>                   </span><span class="hs-comment">-- kinds with (* -&gt; *).</span><span>
</span><span id="line-224"></span><span>                   </span><span class="hs-comment">-- See Note [Inferring the instance context]</span><span>
</span><span id="line-225"></span><span>                   </span><span id="local-6989586621682056862"><span class="annot"><span class="annottext">subst :: Subst
</span><a href="#local-6989586621682056862"><span class="hs-identifier hs-var hs-var">subst</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Subst -&gt; Subst -&gt; Subst) -&gt; Subst -&gt; [Subst] -&gt; Subst
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#foldl%27/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">Subst -&gt; Subst -&gt; Subst
</span><a href="GHC.Core.TyCo.Subst.html#composeTCvSubst"><span class="hs-identifier hs-var">composeTCvSubst</span></a></span><span>
</span><span id="line-226"></span><span>                                         </span><span class="annot"><span class="annottext">Subst
</span><a href="GHC.Core.TyCo.Subst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Maybe Subst] -&gt; [Subst]
forall a. [Maybe a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/Data.Maybe.html#catMaybes/Data.Maybe.html#catMaybes"><span class="hs-identifier hs-var">catMaybes</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Subst]
</span><a href="#local-6989586621682056839"><span class="hs-identifier hs-var">mbSubsts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>                   </span><span id="local-6989586621682056867"><span class="annot"><span class="annottext">unmapped_tvs :: [TyVar]
</span><a href="#local-6989586621682056867"><span class="hs-identifier hs-var hs-var">unmapped_tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; Bool) -&gt; [TyVar] -&gt; [TyVar]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#filter/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682056868"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682056868"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682056868"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Subst -&gt; Bool
</span><a href="GHC.Core.TyCo.Subst.html#notElemSubst"><span class="hs-operator hs-var">`notElemSubst`</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682056862"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-228"></span><span>                                             </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682056868"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; Subst -&gt; Bool
</span><a href="GHC.Core.TyCo.Subst.html#isInScope"><span class="hs-operator hs-var">`isInScope`</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682056862"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056821"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-229"></span><span>                   </span><span class="hs-special">(</span><span id="local-6989586621682056872"><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682056872"><span class="hs-identifier hs-var">subst'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; [TyVar] -&gt; (Subst, [TyVar])
Subst -&gt; [TyVar] -&gt; (Subst, [TyVar])
</span><a href="GHC.Core.TyCo.Subst.html#substTyVarBndrs"><span class="hs-identifier hs-var">substTyVarBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682056862"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056867"><span class="hs-identifier hs-var">unmapped_tvs</span></a></span><span>
</span><span id="line-230"></span><span>                   </span><span id="local-6989586621682056874"><span class="annot"><span class="annottext">stupid_theta_origin :: ThetaSpec
</span><a href="#local-6989586621682056874"><span class="hs-identifier hs-var hs-var">stupid_theta_origin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; TypeOrKind -&gt; [PredType] -&gt; ThetaSpec
</span><a href="GHC.Tc.Deriv.Utils.html#mkDirectThetaSpec"><span class="hs-identifier hs-var">mkDirectThetaSpec</span></a></span><span>
</span><span id="line-231"></span><span>                                           </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056875"><span class="hs-identifier hs-var">deriv_origin</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a></span><span>
</span><span id="line-232"></span><span>                                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; [PredType] -&gt; [PredType]
Subst -&gt; [PredType] -&gt; [PredType]
</span><a href="GHC.Core.TyCo.Subst.html#substTheta"><span class="hs-identifier hs-var">substTheta</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682056872"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056854"><span class="hs-identifier hs-var">stupid_theta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>                   </span><span id="local-6989586621682056876"><span class="annot"><span class="annottext">preds' :: ThetaSpec
</span><a href="#local-6989586621682056876"><span class="hs-identifier hs-var hs-var">preds'</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PredSpec -&gt; PredSpec) -&gt; ThetaSpec -&gt; ThetaSpec
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; Subst -&gt; PredSpec -&gt; PredSpec
Subst -&gt; PredSpec -&gt; PredSpec
</span><a href="GHC.Tc.Deriv.Utils.html#substPredSpec"><span class="hs-identifier hs-var">substPredSpec</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682056872"><span class="hs-identifier hs-var">subst'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056860"><span class="hs-identifier hs-var">preds</span></a></span><span>
</span><span id="line-234"></span><span>                   </span><span id="local-6989586621682056878"><span class="annot"><span class="annottext">inst_tys' :: [PredType]
</span><a href="#local-6989586621682056878"><span class="hs-identifier hs-var hs-var">inst_tys'</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; Subst -&gt; [PredType] -&gt; [PredType]
Subst -&gt; [PredType] -&gt; [PredType]
</span><a href="GHC.Core.TyCo.Subst.html#substTys"><span class="hs-identifier hs-var">substTys</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682056872"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056823"><span class="hs-identifier hs-var">inst_tys</span></a></span><span>
</span><span id="line-235"></span><span>                   </span><span id="local-6989586621682056880"><span class="annot"><span class="annottext">dit' :: DerivInstTys
</span><a href="#local-6989586621682056880"><span class="hs-identifier hs-var hs-var">dit'</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst -&gt; DerivInstTys -&gt; DerivInstTys
</span><a href="GHC.Tc.Deriv.Generate.html#substDerivInstTys"><span class="hs-identifier hs-var">substDerivInstTys</span></a></span><span> </span><span class="annot"><span class="annottext">Subst
</span><a href="#local-6989586621682056872"><span class="hs-identifier hs-var">subst'</span></a></span><span> </span><span class="annot"><span class="annottext">DerivInstTys
</span><a href="#local-6989586621682056811"><span class="hs-identifier hs-var">dit</span></a></span><span>
</span><span id="line-236"></span><span>                   </span><span id="local-6989586621682056882"><span class="annot"><span class="annottext">tvs' :: [TyVar]
</span><a href="#local-6989586621682056882"><span class="hs-identifier hs-var hs-var">tvs'</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PredType] -&gt; [TyVar]
</span><a href="GHC.Core.TyCo.FVs.html#tyCoVarsOfTypesWellScoped"><span class="hs-identifier hs-var">tyCoVarsOfTypesWellScoped</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056878"><span class="hs-identifier hs-var">inst_tys'</span></a></span><span>
</span><span id="line-237"></span><span>               </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056874"><span class="hs-identifier hs-var">stupid_theta_origin</span></a></span><span> </span><span class="annot"><span class="annottext">ThetaSpec -&gt; ThetaSpec -&gt; ThetaSpec
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056876"><span class="hs-identifier hs-var">preds'</span></a></span><span>
</span><span id="line-238"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056882"><span class="hs-identifier hs-var">tvs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056878"><span class="hs-identifier hs-var">inst_tys'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DerivInstTys
</span><a href="#local-6989586621682056880"><span class="hs-identifier hs-var">dit'</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>           </span><span id="local-6989586621682056884"><span class="annot"><span class="annottext">is_generic :: Bool
</span><a href="#local-6989586621682056884"><span class="hs-identifier hs-var hs-var">is_generic</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056822"><span class="hs-identifier hs-var">main_cls</span></a></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#genClassKey"><span class="hs-identifier hs-var">genClassKey</span></a></span><span>
</span><span id="line-241"></span><span>           </span><span id="local-6989586621682056887"><span class="annot"><span class="annottext">is_generic1 :: Bool
</span><a href="#local-6989586621682056887"><span class="hs-identifier hs-var hs-var">is_generic1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056822"><span class="hs-identifier hs-var">main_cls</span></a></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#gen1ClassKey"><span class="hs-identifier hs-var">gen1ClassKey</span></a></span><span>
</span><span id="line-242"></span><span>           </span><span class="hs-comment">-- is_functor_like: see Note [Inferring the instance context]</span><span>
</span><span id="line-243"></span><span>           </span><span id="local-6989586621682056889"><span class="annot"><span class="annottext">is_functor_like :: Bool
</span><a href="#local-6989586621682056889"><span class="hs-identifier hs-var hs-var">is_functor_like</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; PredType -&gt; PredType
PredType -&gt; PredType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056825"><span class="hs-identifier hs-var">inst_ty</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; PredType -&gt; PredType -&gt; Bool
PredType -&gt; PredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#tcEqKind"><span class="hs-operator hs-var">`tcEqKind`</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="GHC.Builtin.Types.html#typeToTypeKind"><span class="hs-identifier hs-var">typeToTypeKind</span></a></span><span>
</span><span id="line-244"></span><span>                          </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056887"><span class="hs-identifier hs-var">is_generic1</span></a></span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span>           </span><span class="annot"><a href="#local-6989586621682056893"><span class="hs-identifier hs-type">get_gen1_constraints</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-247"></span><span>                </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span>
</span><span id="line-248"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The universally quantified type variables for the</span><span>
</span><span id="line-249"></span><span>                        </span><span class="hs-comment">-- data constructor</span><span>
</span><span id="line-250"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-251"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-252"></span><span>           </span><span id="local-6989586621682056893"><span class="annot"><span class="annottext">get_gen1_constraints :: Class
-&gt; [TyVar]
-&gt; CtOrigin
-&gt; TypeOrKind
-&gt; PredType
-&gt; [(ThetaSpec, Maybe Subst)]
</span><a href="#local-6989586621682056893"><span class="hs-identifier hs-var hs-var">get_gen1_constraints</span></a></span></span><span> </span><span id="local-6989586621682056894"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056894"><span class="hs-identifier hs-var">functor_cls</span></a></span></span><span> </span><span id="local-6989586621682056895"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056895"><span class="hs-identifier hs-var">dc_univs</span></a></span></span><span> </span><span id="local-6989586621682056896"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056896"><span class="hs-identifier hs-var">orig</span></a></span></span><span> </span><span id="local-6989586621682056897"><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056897"><span class="hs-identifier hs-var">t_or_k</span></a></span></span><span> </span><span id="local-6989586621682056898"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056898"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-253"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtOrigin
-&gt; TypeOrKind -&gt; Class -&gt; [PredType] -&gt; [(ThetaSpec, Maybe Subst)]
</span><a href="#local-6989586621682056899"><span class="hs-identifier hs-var">mk_functor_like_constraints</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056896"><span class="hs-identifier hs-var">orig</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056897"><span class="hs-identifier hs-var">t_or_k</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056894"><span class="hs-identifier hs-var">functor_cls</span></a></span><span> </span><span class="annot"><span class="annottext">([PredType] -&gt; [(ThetaSpec, Maybe Subst)])
-&gt; [PredType] -&gt; [(ThetaSpec, Maybe Subst)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-254"></span><span>                </span><span class="annot"><span class="annottext">TyVar -&gt; PredType -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Generics.html#get_gen1_constrained_tys"><span class="hs-identifier hs-var">get_gen1_constrained_tys</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682056901"><span class="hs-identifier hs-var">last_dc_univ</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056898"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-255"></span><span>             </span><span class="hs-keyword">where</span><span>
</span><span id="line-256"></span><span>               </span><span class="hs-comment">-- If we are deriving an instance of 'Generic1' and have made</span><span>
</span><span id="line-257"></span><span>               </span><span class="hs-comment">-- it this far, then there should be at least one universal type</span><span>
</span><span id="line-258"></span><span>               </span><span class="hs-comment">-- variable, making this use of 'last' safe.</span><span>
</span><span id="line-259"></span><span>               </span><span id="local-6989586621682056901"><span class="annot"><span class="annottext">last_dc_univ :: TyVar
</span><a href="#local-6989586621682056901"><span class="hs-identifier hs-var hs-var">last_dc_univ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TyVar -&gt; TyVar
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056895"><span class="hs-identifier hs-var">dc_univs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; TyVar) -&gt; TyVar -&gt; TyVar
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-260"></span><span>                              </span><span class="annot"><span class="annottext">[TyVar] -&gt; TyVar
forall a. HasCallStack =&gt; [a] -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.List.html#last/GHC.List.html#last"><span class="hs-identifier hs-var">last</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056895"><span class="hs-identifier hs-var">dc_univs</span></a></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>           </span><span class="annot"><a href="#local-6989586621682056904"><span class="hs-identifier hs-type">get_std_constrained_tys</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-263"></span><span>                </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The universally quantified type variables for the</span><span>
</span><span id="line-264"></span><span>                        </span><span class="hs-comment">-- data constructor</span><span>
</span><span id="line-265"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-266"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-267"></span><span>           </span><span id="local-6989586621682056904"><span class="annot"><span class="annottext">get_std_constrained_tys :: [TyVar]
-&gt; CtOrigin -&gt; TypeOrKind -&gt; PredType -&gt; [(ThetaSpec, Maybe Subst)]
</span><a href="#local-6989586621682056904"><span class="hs-identifier hs-var hs-var">get_std_constrained_tys</span></a></span></span><span> </span><span id="local-6989586621682056905"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056905"><span class="hs-identifier hs-var">dc_univs</span></a></span></span><span> </span><span id="local-6989586621682056906"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056906"><span class="hs-identifier hs-var">orig</span></a></span></span><span> </span><span id="local-6989586621682056907"><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056907"><span class="hs-identifier hs-var">t_or_k</span></a></span></span><span> </span><span id="local-6989586621682056908"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056908"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-268"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056889"><span class="hs-identifier hs-var">is_functor_like</span></a></span><span>
</span><span id="line-269"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtOrigin
-&gt; TypeOrKind -&gt; Class -&gt; [PredType] -&gt; [(ThetaSpec, Maybe Subst)]
</span><a href="#local-6989586621682056899"><span class="hs-identifier hs-var">mk_functor_like_constraints</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056906"><span class="hs-identifier hs-var">orig</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056907"><span class="hs-identifier hs-var">t_or_k</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056822"><span class="hs-identifier hs-var">main_cls</span></a></span><span> </span><span class="annot"><span class="annottext">([PredType] -&gt; [(ThetaSpec, Maybe Subst)])
-&gt; [PredType] -&gt; [(ThetaSpec, Maybe Subst)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-270"></span><span>                 </span><span class="annot"><span class="annottext">TyVar -&gt; PredType -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Functor.html#deepSubtypesContaining"><span class="hs-identifier hs-var">deepSubtypesContaining</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682056910"><span class="hs-identifier hs-var">last_dc_univ</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056908"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-271"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-272"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CtOrigin -&gt; TypeOrKind -&gt; Class -&gt; PredType -&gt; PredSpec
</span><a href="#local-6989586621682056911"><span class="hs-identifier hs-var">mk_cls_pred</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056906"><span class="hs-identifier hs-var">orig</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056907"><span class="hs-identifier hs-var">t_or_k</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056822"><span class="hs-identifier hs-var">main_cls</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056908"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-273"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Subst
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-274"></span><span>             </span><span class="hs-keyword">where</span><span>
</span><span id="line-275"></span><span>               </span><span class="hs-comment">-- If 'is_functor_like' holds, then there should be at least one</span><span>
</span><span id="line-276"></span><span>               </span><span class="hs-comment">-- universal type variable, making this use of 'last' safe.</span><span>
</span><span id="line-277"></span><span>               </span><span id="local-6989586621682056910"><span class="annot"><span class="annottext">last_dc_univ :: TyVar
</span><a href="#local-6989586621682056910"><span class="hs-identifier hs-var hs-var">last_dc_univ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TyVar -&gt; TyVar
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056905"><span class="hs-identifier hs-var">dc_univs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TyVar -&gt; TyVar) -&gt; TyVar -&gt; TyVar
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-278"></span><span>                              </span><span class="annot"><span class="annottext">[TyVar] -&gt; TyVar
forall a. HasCallStack =&gt; [a] -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.List.html#last/GHC.List.html#last"><span class="hs-identifier hs-var">last</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056905"><span class="hs-identifier hs-var">dc_univs</span></a></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span>           </span><span class="annot"><a href="#local-6989586621682056899"><span class="hs-identifier hs-type">mk_functor_like_constraints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Origin.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a></span><span>
</span><span id="line-281"></span><span>                                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Class.html#Class"><span class="hs-identifier hs-type">Class</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-282"></span><span>                                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Subst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-283"></span><span>           </span><span class="hs-comment">-- 'cls' is usually main_cls (Functor or Traversable etc), but if</span><span>
</span><span id="line-284"></span><span>           </span><span class="hs-comment">-- main_cls = Generic1, then 'cls' can be Functor; see</span><span>
</span><span id="line-285"></span><span>           </span><span class="hs-comment">-- get_gen1_constraints</span><span>
</span><span id="line-286"></span><span>           </span><span class="hs-comment">--</span><span>
</span><span id="line-287"></span><span>           </span><span class="hs-comment">-- For each type, generate two constraints,</span><span>
</span><span id="line-288"></span><span>           </span><span class="hs-comment">-- [cls ty, kind(ty) ~ (*-&gt;*)], and a kind substitution that results</span><span>
</span><span id="line-289"></span><span>           </span><span class="hs-comment">-- from unifying  kind(ty) with * -&gt; *. If the unification is</span><span>
</span><span id="line-290"></span><span>           </span><span class="hs-comment">-- successful, it will ensure that the resulting instance is well</span><span>
</span><span id="line-291"></span><span>           </span><span class="hs-comment">-- kinded. If not, the second constraint will result in an error</span><span>
</span><span id="line-292"></span><span>           </span><span class="hs-comment">-- message which points out the kind mismatch.</span><span>
</span><span id="line-293"></span><span>           </span><span class="hs-comment">-- See Note [Inferring the instance context]</span><span>
</span><span id="line-294"></span><span>           </span><span id="local-6989586621682056899"><span class="annot"><span class="annottext">mk_functor_like_constraints :: CtOrigin
-&gt; TypeOrKind -&gt; Class -&gt; [PredType] -&gt; [(ThetaSpec, Maybe Subst)]
</span><a href="#local-6989586621682056899"><span class="hs-identifier hs-var hs-var">mk_functor_like_constraints</span></a></span></span><span> </span><span id="local-6989586621682056912"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056912"><span class="hs-identifier hs-var">orig</span></a></span></span><span> </span><span id="local-6989586621682056913"><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056913"><span class="hs-identifier hs-var">t_or_k</span></a></span></span><span> </span><span id="local-6989586621682056914"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056914"><span class="hs-identifier hs-var">cls</span></a></span></span><span>
</span><span id="line-295"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PredType -&gt; (ThetaSpec, Maybe Subst))
-&gt; [PredType] -&gt; [(ThetaSpec, Maybe Subst)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">((PredType -&gt; (ThetaSpec, Maybe Subst))
 -&gt; [PredType] -&gt; [(ThetaSpec, Maybe Subst)])
-&gt; (PredType -&gt; (ThetaSpec, Maybe Subst))
-&gt; [PredType]
-&gt; [(ThetaSpec, Maybe Subst)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621682056915"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056915"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682056916"><span class="annot"><span class="annottext">ki :: PredType
</span><a href="#local-6989586621682056916"><span class="hs-identifier hs-var hs-var">ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; PredType -&gt; PredType
PredType -&gt; PredType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056915"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-296"></span><span>                             </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; TypeOrKind -&gt; Class -&gt; PredType -&gt; PredSpec
</span><a href="#local-6989586621682056911"><span class="hs-identifier hs-var">mk_cls_pred</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056912"><span class="hs-identifier hs-var">orig</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056913"><span class="hs-identifier hs-var">t_or_k</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056914"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056915"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-297"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#SimplePredSpec"><span class="hs-identifier hs-type">SimplePredSpec</span></a></span><span>
</span><span id="line-298"></span><span>                                   </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sps_pred :: PredType
</span><a href="GHC.Tc.Deriv.Utils.html#sps_pred"><span class="hs-identifier hs-var">sps_pred</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PredType -&gt; PredType -&gt; PredType
</span><a href="GHC.Core.Coercion.html#mkPrimEqPred"><span class="hs-identifier hs-var">mkPrimEqPred</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056916"><span class="hs-identifier hs-var">ki</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="GHC.Builtin.Types.html#typeToTypeKind"><span class="hs-identifier hs-var">typeToTypeKind</span></a></span><span>
</span><span id="line-299"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sps_origin :: CtOrigin
</span><a href="GHC.Tc.Deriv.Utils.html#sps_origin"><span class="hs-identifier hs-var">sps_origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056912"><span class="hs-identifier hs-var">orig</span></a></span><span>
</span><span id="line-300"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sps_type_or_kind :: TypeOrKind
</span><a href="GHC.Tc.Deriv.Utils.html#sps_type_or_kind"><span class="hs-identifier hs-var">sps_type_or_kind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a></span><span>
</span><span id="line-301"></span><span>                                   </span><span class="hs-special">}</span><span>
</span><span id="line-302"></span><span>                               </span><span class="hs-special">]</span><span>
</span><span id="line-303"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PredType -&gt; PredType -&gt; Maybe Subst
</span><a href="GHC.Core.Unify.html#tcUnifyTy"><span class="hs-identifier hs-var">tcUnifyTy</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056916"><span class="hs-identifier hs-var">ki</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="GHC.Builtin.Types.html#typeToTypeKind"><span class="hs-identifier hs-var">typeToTypeKind</span></a></span><span>
</span><span id="line-304"></span><span>                             </span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span>           </span><span class="hs-comment">-- Extra Data constraints</span><span>
</span><span id="line-307"></span><span>           </span><span class="hs-comment">-- The Data class (only) requires that for</span><span>
</span><span id="line-308"></span><span>           </span><span class="hs-comment">--    instance (...) =&gt; Data (T t1 t2)</span><span>
</span><span id="line-309"></span><span>           </span><span class="hs-comment">-- IF   t1:*, t2:*</span><span>
</span><span id="line-310"></span><span>           </span><span class="hs-comment">-- THEN (Data t1, Data t2) are among the (...) constraints</span><span>
</span><span id="line-311"></span><span>           </span><span class="hs-comment">-- Reason: when the IF holds, we generate a method</span><span>
</span><span id="line-312"></span><span>           </span><span class="hs-comment">--             dataCast2 f = gcast2 f</span><span>
</span><span id="line-313"></span><span>           </span><span class="hs-comment">--         and we need the Data constraints to typecheck the method</span><span>
</span><span id="line-314"></span><span>           </span><span id="local-6989586621682056922"><span class="annot"><span class="annottext">extra_constraints :: ThetaSpec
</span><a href="#local-6989586621682056922"><span class="hs-identifier hs-var hs-var">extra_constraints</span></a></span></span><span>
</span><span id="line-315"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056822"><span class="hs-identifier hs-var">main_cls</span></a></span><span> </span><span class="annot"><span class="annottext">Class -&gt; Unique -&gt; Bool
forall a. Uniquable a =&gt; a -&gt; Unique -&gt; Bool
</span><a href="GHC.Types.Unique.html#hasKey"><span class="hs-operator hs-var">`hasKey`</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="GHC.Builtin.Names.html#dataClassKey"><span class="hs-identifier hs-var">dataClassKey</span></a></span><span>
</span><span id="line-316"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(PredType -&gt; Bool) -&gt; [PredType] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#all/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PredType -&gt; Bool
</span><a href="GHC.Core.Type.html#isLiftedTypeKind"><span class="hs-identifier hs-var">isLiftedTypeKind</span></a></span><span> </span><span class="annot"><span class="annottext">(PredType -&gt; Bool) -&gt; (PredType -&gt; PredType) -&gt; PredType -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(() :: Constraint) =&gt; PredType -&gt; PredType
PredType -&gt; PredType
</span><a href="GHC.Core.Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056820"><span class="hs-identifier hs-var">rep_tc_args</span></a></span><span>
</span><span id="line-317"></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CtOrigin -&gt; TypeOrKind -&gt; Class -&gt; PredType -&gt; PredSpec
</span><a href="#local-6989586621682056911"><span class="hs-identifier hs-var">mk_cls_pred</span></a></span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056875"><span class="hs-identifier hs-var">deriv_origin</span></a></span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056927"><span class="hs-identifier hs-var">t_or_k</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056822"><span class="hs-identifier hs-var">main_cls</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056928"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-318"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682056927"><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056927"><span class="hs-identifier hs-var">t_or_k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056928"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056928"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TypeOrKind] -&gt; [PredType] -&gt; [(TypeOrKind, PredType)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#zip/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeOrKind]
</span><a href="#local-6989586621682056833"><span class="hs-identifier hs-var">t_or_ks</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056820"><span class="hs-identifier hs-var">rep_tc_args</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-319"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-320"></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span>           </span><span id="local-6989586621682056911"><span class="annot"><span class="annottext">mk_cls_pred :: CtOrigin -&gt; TypeOrKind -&gt; Class -&gt; PredType -&gt; PredSpec
</span><a href="#local-6989586621682056911"><span class="hs-identifier hs-var hs-var">mk_cls_pred</span></a></span></span><span> </span><span id="local-6989586621682056929"><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056929"><span class="hs-identifier hs-var">orig</span></a></span></span><span> </span><span id="local-6989586621682056930"><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056930"><span class="hs-identifier hs-var">t_or_k</span></a></span></span><span> </span><span id="local-6989586621682056931"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056931"><span class="hs-identifier hs-var">cls</span></a></span></span><span> </span><span id="local-6989586621682056932"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056932"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-323"></span><span>                </span><span class="hs-comment">-- Don't forget to apply to cls_tys' too</span><span>
</span><span id="line-324"></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#SimplePredSpec"><span class="hs-identifier hs-type">SimplePredSpec</span></a></span><span>
</span><span id="line-325"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sps_pred :: PredType
</span><a href="GHC.Tc.Deriv.Utils.html#sps_pred"><span class="hs-identifier hs-var">sps_pred</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [PredType] -&gt; PredType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056931"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056934"><span class="hs-identifier hs-var">cls_tys'</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType] -&gt; [PredType] -&gt; [PredType]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056932"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sps_origin :: CtOrigin
</span><a href="GHC.Tc.Deriv.Utils.html#sps_origin"><span class="hs-identifier hs-var">sps_origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056929"><span class="hs-identifier hs-var">orig</span></a></span><span>
</span><span id="line-327"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sps_type_or_kind :: TypeOrKind
</span><a href="GHC.Tc.Deriv.Utils.html#sps_type_or_kind"><span class="hs-identifier hs-var">sps_type_or_kind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="#local-6989586621682056930"><span class="hs-identifier hs-var">t_or_k</span></a></span><span>
</span><span id="line-328"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-329"></span><span>           </span><span id="local-6989586621682056934"><span class="annot"><span class="annottext">cls_tys' :: [PredType]
</span><a href="#local-6989586621682056934"><span class="hs-identifier hs-var hs-var">cls_tys'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056887"><span class="hs-identifier hs-var">is_generic1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-330"></span><span>                      </span><span class="hs-comment">-- In the awkward Generic1 case, cls_tys' should be</span><span>
</span><span id="line-331"></span><span>                      </span><span class="hs-comment">-- empty, since we are applying the class Functor.</span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056812"><span class="hs-identifier hs-var">cls_tys</span></a></span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span>           </span><span id="local-6989586621682056875"><span class="annot"><span class="annottext">deriv_origin :: CtOrigin
</span><a href="#local-6989586621682056875"><span class="hs-identifier hs-var hs-var">deriv_origin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; CtOrigin
</span><a href="GHC.Tc.Deriv.Utils.html#mkDerivOrigin"><span class="hs-identifier hs-var">mkDerivOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056824"><span class="hs-identifier hs-var">wildcard</span></a></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span>       </span><span class="hs-keyword">if</span><span>    </span><span class="hs-comment">-- Generic constraints are easy</span><span>
</span><span id="line-338"></span><span>          </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056884"><span class="hs-identifier hs-var">is_generic</span></a></span><span>
</span><span id="line-339"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ThetaSpec, [TyVar], [PredType], DerivInstTys)
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
forall a. a -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056821"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056823"><span class="hs-identifier hs-var">inst_tys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DerivInstTys
</span><a href="#local-6989586621682056811"><span class="hs-identifier hs-var">dit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>             </span><span class="hs-comment">-- Generic1 needs Functor</span><span>
</span><span id="line-342"></span><span>             </span><span class="hs-comment">-- See Note [Getting base classes]</span><span>
</span><span id="line-343"></span><span>          </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056887"><span class="hs-identifier hs-var">is_generic1</span></a></span><span>
</span><span id="line-344"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyCon -&gt; [TyVar]
</span><a href="GHC.Core.TyCon.html#tyConTyVars"><span class="hs-identifier hs-var">tyConTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">TyCon
</span><a href="#local-6989586621682056818"><span class="hs-identifier hs-var">rep_tc</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; Int -&gt; Bool
forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthExceeds"><span class="hs-operator hs-var">`lengthExceeds`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
 -&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys))
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-345"></span><span>              </span><span class="hs-comment">-- Generic1 has a single kind variable</span><span>
</span><span id="line-346"></span><span>              </span><span class="annot"><span class="annottext">Bool
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="GHC.Utils.Panic.Plain.html#assert"><span class="hs-identifier hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056812"><span class="hs-identifier hs-var">cls_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType] -&gt; Int -&gt; Bool
forall a. [a] -&gt; Int -&gt; Bool
</span><a href="GHC.Utils.Misc.html#lengthIs"><span class="hs-operator hs-var">`lengthIs`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
 -&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys))
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-347"></span><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621682056938"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056938"><span class="hs-identifier hs-var">functorClass</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IOEnv (Env TcGblEnv TcLclEnv) Class
-&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) Class
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ReaderT DerivEnv m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) Class
 -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) Class)
-&gt; IOEnv (Env TcGblEnv TcLclEnv) Class
-&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) Class
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; IOEnv (Env TcGblEnv TcLclEnv) Class
</span><a href="GHC.Tc.Utils.Env.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="GHC.Builtin.Names.html#functorClassName"><span class="hs-identifier hs-var">functorClassName</span></a></span><span>
</span><span id="line-348"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(ThetaSpec, [TyVar], [PredType], DerivInstTys)
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
forall a. a -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">((ThetaSpec, [TyVar], [PredType], DerivInstTys)
 -&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys))
-&gt; (ThetaSpec, [TyVar], [PredType], DerivInstTys)
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">([TyVar]
 -&gt; CtOrigin
 -&gt; TypeOrKind
 -&gt; PredType
 -&gt; [(ThetaSpec, Maybe Subst)])
-&gt; (ThetaSpec, [TyVar], [PredType], DerivInstTys)
</span><a href="#local-6989586621682056835"><span class="hs-identifier hs-var">con_arg_constraints</span></a></span><span>
</span><span id="line-349"></span><span>                        </span><span class="annot"><span class="annottext">(([TyVar]
  -&gt; CtOrigin
  -&gt; TypeOrKind
  -&gt; PredType
  -&gt; [(ThetaSpec, Maybe Subst)])
 -&gt; (ThetaSpec, [TyVar], [PredType], DerivInstTys))
-&gt; ([TyVar]
    -&gt; CtOrigin
    -&gt; TypeOrKind
    -&gt; PredType
    -&gt; [(ThetaSpec, Maybe Subst)])
-&gt; (ThetaSpec, [TyVar], [PredType], DerivInstTys)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Class
-&gt; [TyVar]
-&gt; CtOrigin
-&gt; TypeOrKind
-&gt; PredType
-&gt; [(ThetaSpec, Maybe Subst)]
</span><a href="#local-6989586621682056893"><span class="hs-identifier hs-var">get_gen1_constraints</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056938"><span class="hs-identifier hs-var">functorClass</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span>             </span><span class="hs-comment">-- The others are a bit more complicated</span><span>
</span><span id="line-352"></span><span>          </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-353"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682056941"><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056941"><span class="hs-identifier hs-var">arg_constraints</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056942"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056942"><span class="hs-identifier hs-var">tvs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056943"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056943"><span class="hs-identifier hs-var">inst_tys'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056944"><span class="annot"><span class="annottext">DerivInstTys
</span><a href="#local-6989586621682056944"><span class="hs-identifier hs-var">dit'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([TyVar]
 -&gt; CtOrigin
 -&gt; TypeOrKind
 -&gt; PredType
 -&gt; [(ThetaSpec, Maybe Subst)])
-&gt; (ThetaSpec, [TyVar], [PredType], DerivInstTys)
</span><a href="#local-6989586621682056835"><span class="hs-identifier hs-var">con_arg_constraints</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
-&gt; CtOrigin -&gt; TypeOrKind -&gt; PredType -&gt; [(ThetaSpec, Maybe Subst)]
</span><a href="#local-6989586621682056904"><span class="hs-identifier hs-var">get_std_constrained_tys</span></a></span><span>
</span><span id="line-355"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">TcRn () -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ReaderT DerivEnv m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(TcRn () -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) ())
-&gt; TcRn () -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inferConstraintsStock&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcRn ()) -&gt; SDoc -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span>
</span><span id="line-356"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Class -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056822"><span class="hs-identifier hs-var">main_cls</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056943"><span class="hs-identifier hs-var">inst_tys'</span></a></span><span>
</span><span id="line-357"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThetaSpec -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056941"><span class="hs-identifier hs-var">arg_constraints</span></a></span><span>
</span><span id="line-358"></span><span>                        </span><span class="hs-special">]</span><span>
</span><span id="line-359"></span><span>                 </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(ThetaSpec, [TyVar], [PredType], DerivInstTys)
-&gt; DerivM (ThetaSpec, [TyVar], [PredType], DerivInstTys)
forall a. a -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056922"><span class="hs-identifier hs-var">extra_constraints</span></a></span><span> </span><span class="annot"><span class="annottext">ThetaSpec -&gt; ThetaSpec -&gt; ThetaSpec
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682056941"><span class="hs-identifier hs-var">arg_constraints</span></a></span><span>
</span><span id="line-360"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056942"><span class="hs-identifier hs-var">tvs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056943"><span class="hs-identifier hs-var">inst_tys'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DerivInstTys
</span><a href="#local-6989586621682056944"><span class="hs-identifier hs-var">dit'</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span class="hs-comment">-- | Like 'inferConstraints', but used only in the case of @DeriveAnyClass@,</span><span>
</span><span id="line-363"></span><span class="hs-comment">-- which gathers its constraints based on the type signatures of the class's</span><span>
</span><span id="line-364"></span><span class="hs-comment">-- methods instead of the types of the data constructor's field.</span><span>
</span><span id="line-365"></span><span class="hs-comment">--</span><span>
</span><span id="line-366"></span><span class="hs-comment">-- See Note [Gathering and simplifying constraints for DeriveAnyClass]</span><span>
</span><span id="line-367"></span><span class="hs-comment">-- for an explanation of how these constraints are used to determine the</span><span>
</span><span id="line-368"></span><span class="hs-comment">-- derived instance context.</span><span>
</span><span id="line-369"></span><span class="annot"><a href="GHC.Tc.Deriv.Infer.html#inferConstraintsAnyclass"><span class="hs-identifier hs-type">inferConstraintsAnyclass</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivM"><span class="hs-identifier hs-type">DerivM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span>
</span><span id="line-370"></span><span id="inferConstraintsAnyclass"><span class="annot"><span class="annottext">inferConstraintsAnyclass :: DerivM ThetaSpec
</span><a href="GHC.Tc.Deriv.Infer.html#inferConstraintsAnyclass"><span class="hs-identifier hs-var hs-var">inferConstraintsAnyclass</span></a></span></span><span>
</span><span id="line-371"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivEnv"><span class="hs-identifier hs-type">DerivEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">denv_cls :: DerivEnv -&gt; Class
</span><a href="GHC.Tc.Deriv.Utils.html#denv_cls"><span class="hs-identifier hs-var">denv_cls</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056945"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056945"><span class="hs-identifier hs-var">cls</span></a></span></span><span>
</span><span id="line-372"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">denv_inst_tys :: DerivEnv -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Utils.html#denv_inst_tys"><span class="hs-identifier hs-var">denv_inst_tys</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056946"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056946"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) DerivEnv
forall (m :: * -&gt; *) r. Monad m =&gt; ReaderT r m r
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Reader.html#ask/Control.Monad.Trans.Reader.html#ask"><span class="hs-identifier hs-var">ask</span></a></span><span>
</span><span id="line-373"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682056947"><span class="annot"><span class="annottext">gen_dms :: [(TyVar, PredType)]
</span><a href="#local-6989586621682056947"><span class="hs-identifier hs-var hs-var">gen_dms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682056948"><span class="hs-identifier hs-var">sel_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056949"><span class="hs-identifier hs-var">dm_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682056948"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682056948"><span class="hs-identifier hs-var">sel_id</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#GenericDM"><span class="hs-identifier hs-type">GenericDM</span></a></span><span> </span><span id="local-6989586621682056949"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056949"><span class="hs-identifier hs-var">dm_ty</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [(TyVar, DefMethInfo)]
</span><a href="GHC.Core.Class.html#classOpItems"><span class="hs-identifier hs-var">classOpItems</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056945"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-375"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682056952"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056952"><span class="hs-identifier hs-var">wildcard</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DerivM Bool
</span><a href="GHC.Tc.Deriv.Utils.html#isStandaloneWildcardDeriv"><span class="hs-identifier hs-var">isStandaloneWildcardDeriv</span></a></span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621682056953"><span class="hs-identifier hs-type">meth_pred</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#PredSpec"><span class="hs-identifier hs-type">PredSpec</span></a></span><span>
</span><span id="line-378"></span><span>               </span><span class="hs-comment">-- (Id,Type) are the selector Id and the generic default method type</span><span>
</span><span id="line-379"></span><span>               </span><span class="hs-comment">-- NB: the latter is /not/ quantified over the class variables</span><span>
</span><span id="line-380"></span><span>               </span><span class="hs-comment">-- See Note [Gathering and simplifying constraints for DeriveAnyClass]</span><span>
</span><span id="line-381"></span><span>             </span><span id="local-6989586621682056953"><span class="annot"><span class="annottext">meth_pred :: (TyVar, PredType) -&gt; PredSpec
</span><a href="#local-6989586621682056953"><span class="hs-identifier hs-var hs-var">meth_pred</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682056955"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682056955"><span class="hs-identifier hs-var">sel_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056956"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056956"><span class="hs-identifier hs-var">gen_dm_ty</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682056957"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056957"><span class="hs-identifier hs-var">sel_tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056958"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056958"><span class="hs-identifier hs-var">_cls_pred</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682056959"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056959"><span class="hs-identifier hs-var">meth_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PredType -&gt; ([TyVar], PredType, PredType)
</span><a href="GHC.Tc.Utils.TcType.html#tcSplitMethodTy"><span class="hs-identifier hs-var">tcSplitMethodTy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyVar -&gt; PredType
</span><a href="GHC.Types.Var.html#varType"><span class="hs-identifier hs-var">varType</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682056955"><span class="hs-identifier hs-var">sel_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>                     </span><span id="local-6989586621682056962"><span class="annot"><span class="annottext">meth_ty' :: PredType
</span><a href="#local-6989586621682056962"><span class="hs-identifier hs-var hs-var">meth_ty'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [PredType] -&gt; PredType -&gt; PredType
(() :: Constraint) =&gt; [TyVar] -&gt; [PredType] -&gt; PredType -&gt; PredType
</span><a href="GHC.Core.TyCo.Subst.html#substTyWith"><span class="hs-identifier hs-var">substTyWith</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056957"><span class="hs-identifier hs-var">sel_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056946"><span class="hs-identifier hs-var">inst_tys</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056959"><span class="hs-identifier hs-var">meth_ty</span></a></span><span>
</span><span id="line-384"></span><span>                     </span><span id="local-6989586621682056963"><span class="annot"><span class="annottext">gen_dm_ty' :: PredType
</span><a href="#local-6989586621682056963"><span class="hs-identifier hs-var hs-var">gen_dm_ty'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; [PredType] -&gt; PredType -&gt; PredType
(() :: Constraint) =&gt; [TyVar] -&gt; [PredType] -&gt; PredType -&gt; PredType
</span><a href="GHC.Core.TyCo.Subst.html#substTyWith"><span class="hs-identifier hs-var">substTyWith</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056957"><span class="hs-identifier hs-var">sel_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056946"><span class="hs-identifier hs-var">inst_tys</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056956"><span class="hs-identifier hs-var">gen_dm_ty</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-385"></span><span>                 </span><span class="hs-comment">-- This is the only place where a SubTypePredSpec is</span><span>
</span><span id="line-386"></span><span>                 </span><span class="hs-comment">-- constructed instead of a SimplePredSpec. See</span><span>
</span><span id="line-387"></span><span>                 </span><span class="hs-comment">-- Note [Gathering and simplifying constraints for DeriveAnyClass]</span><span>
</span><span id="line-388"></span><span>                 </span><span class="hs-comment">-- for a more in-depth explanation.</span><span>
</span><span id="line-389"></span><span>                 </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#SubTypePredSpec"><span class="hs-identifier hs-type">SubTypePredSpec</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">stps_ty_actual :: PredType
</span><a href="GHC.Tc.Deriv.Utils.html#stps_ty_actual"><span class="hs-identifier hs-var">stps_ty_actual</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056963"><span class="hs-identifier hs-var">gen_dm_ty'</span></a></span><span>
</span><span id="line-390"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">stps_ty_expected :: PredType
</span><a href="GHC.Tc.Deriv.Utils.html#stps_ty_expected"><span class="hs-identifier hs-var">stps_ty_expected</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056962"><span class="hs-identifier hs-var">meth_ty'</span></a></span><span>
</span><span id="line-391"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">stps_origin :: CtOrigin
</span><a href="GHC.Tc.Deriv.Utils.html#stps_origin"><span class="hs-identifier hs-var">stps_origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; CtOrigin
</span><a href="GHC.Tc.Deriv.Utils.html#mkDerivOrigin"><span class="hs-identifier hs-var">mkDerivOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056952"><span class="hs-identifier hs-var">wildcard</span></a></span><span>
</span><span id="line-392"></span><span>                                 </span><span class="hs-special">}</span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">ThetaSpec -&gt; DerivM ThetaSpec
forall a. a -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ThetaSpec -&gt; DerivM ThetaSpec) -&gt; ThetaSpec -&gt; DerivM ThetaSpec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((TyVar, PredType) -&gt; PredSpec) -&gt; [(TyVar, PredType)] -&gt; ThetaSpec
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(TyVar, PredType) -&gt; PredSpec
</span><a href="#local-6989586621682056953"><span class="hs-identifier hs-var">meth_pred</span></a></span><span> </span><span class="annot"><span class="annottext">[(TyVar, PredType)]
</span><a href="#local-6989586621682056947"><span class="hs-identifier hs-var">gen_dms</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span class="hs-comment">-- Like 'inferConstraints', but used only for @GeneralizedNewtypeDeriving@ and</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- @DerivingVia@. Since both strategies generate code involving 'coerce', the</span><span>
</span><span id="line-398"></span><span class="hs-comment">-- inferred constraints set up the scaffolding needed to typecheck those uses</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- of 'coerce'. In this example:</span><span>
</span><span id="line-400"></span><span class="hs-comment">--</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- &gt; newtype Age = MkAge Int deriving newtype Num</span><span>
</span><span id="line-402"></span><span class="hs-comment">--</span><span>
</span><span id="line-403"></span><span class="hs-comment">-- We would infer the following constraints ('ThetaSpec'):</span><span>
</span><span id="line-404"></span><span class="hs-comment">--</span><span>
</span><span id="line-405"></span><span class="hs-comment">-- &gt; (Num Int, Coercible Age Int)</span><span>
</span><span id="line-406"></span><span class="annot"><a href="GHC.Tc.Deriv.Infer.html#inferConstraintsCoerceBased"><span class="hs-identifier hs-type">inferConstraintsCoerceBased</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-407"></span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivM"><span class="hs-identifier hs-type">DerivM</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span>
</span><span id="line-408"></span><span id="inferConstraintsCoerceBased"><span class="annot"><span class="annottext">inferConstraintsCoerceBased :: [PredType] -&gt; PredType -&gt; DerivM ThetaSpec
</span><a href="GHC.Tc.Deriv.Infer.html#inferConstraintsCoerceBased"><span class="hs-identifier hs-var hs-var">inferConstraintsCoerceBased</span></a></span></span><span> </span><span id="local-6989586621682056968"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056968"><span class="hs-identifier hs-var">cls_tys</span></a></span></span><span> </span><span id="local-6989586621682056969"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056969"><span class="hs-identifier hs-var">rep_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-409"></span><span>  </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivEnv"><span class="hs-identifier hs-type">DerivEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">denv_tvs :: DerivEnv -&gt; [TyVar]
</span><a href="GHC.Tc.Deriv.Utils.html#denv_tvs"><span class="hs-identifier hs-var">denv_tvs</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056970"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056970"><span class="hs-identifier hs-var">tvs</span></a></span></span><span>
</span><span id="line-410"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">denv_cls :: DerivEnv -&gt; Class
</span><a href="GHC.Tc.Deriv.Utils.html#denv_cls"><span class="hs-identifier hs-var">denv_cls</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056971"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056971"><span class="hs-identifier hs-var">cls</span></a></span></span><span>
</span><span id="line-411"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">denv_inst_tys :: DerivEnv -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Utils.html#denv_inst_tys"><span class="hs-identifier hs-var">denv_inst_tys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682056972"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056972"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) DerivEnv
forall (m :: * -&gt; *) r. Monad m =&gt; ReaderT r m r
</span><a href="../../transformers-0.6.1.0/src/Control.Monad.Trans.Reader.html#ask/Control.Monad.Trans.Reader.html#ask"><span class="hs-identifier hs-var">ask</span></a></span><span>
</span><span id="line-412"></span><span>  </span><span id="local-6989586621682056973"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056973"><span class="hs-identifier hs-var">sa_wildcard</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DerivM Bool
</span><a href="GHC.Tc.Deriv.Utils.html#isStandaloneWildcardDeriv"><span class="hs-identifier hs-var">isStandaloneWildcardDeriv</span></a></span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- The following functions are polymorphic over the representation</span><span>
</span><span id="line-414"></span><span>      </span><span class="hs-comment">-- type, since we might either give it the underlying type of a</span><span>
</span><span id="line-415"></span><span>      </span><span class="hs-comment">-- newtype (for GeneralizedNewtypeDeriving) or a @via@ type</span><span>
</span><span id="line-416"></span><span>      </span><span class="hs-comment">-- (for DerivingVia).</span><span>
</span><span id="line-417"></span><span>      </span><span id="local-6989586621682056974"><span class="annot"><span class="annottext">rep_tys :: PredType -&gt; [PredType]
</span><a href="#local-6989586621682056974"><span class="hs-identifier hs-var hs-var">rep_tys</span></a></span></span><span> </span><span id="local-6989586621682056975"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056975"><span class="hs-identifier hs-var">ty</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056968"><span class="hs-identifier hs-var">cls_tys</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType] -&gt; [PredType] -&gt; [PredType]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%2B%2B/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056975"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-418"></span><span>      </span><span id="local-6989586621682056976"><span class="annot"><span class="annottext">rep_pred :: PredType -&gt; PredType
</span><a href="#local-6989586621682056976"><span class="hs-identifier hs-var hs-var">rep_pred</span></a></span></span><span> </span><span id="local-6989586621682056977"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056977"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [PredType] -&gt; PredType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056971"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PredType -&gt; [PredType]
</span><a href="#local-6989586621682056974"><span class="hs-identifier hs-var">rep_tys</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056977"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>      </span><span id="local-6989586621682056978"><span class="annot"><span class="annottext">rep_pred_o :: PredType -&gt; PredSpec
</span><a href="#local-6989586621682056978"><span class="hs-identifier hs-var hs-var">rep_pred_o</span></a></span></span><span> </span><span id="local-6989586621682056979"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056979"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#SimplePredSpec"><span class="hs-identifier hs-type">SimplePredSpec</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sps_pred :: PredType
</span><a href="GHC.Tc.Deriv.Utils.html#sps_pred"><span class="hs-identifier hs-var">sps_pred</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PredType -&gt; PredType
</span><a href="#local-6989586621682056976"><span class="hs-identifier hs-var">rep_pred</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056979"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-420"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sps_origin :: CtOrigin
</span><a href="GHC.Tc.Deriv.Utils.html#sps_origin"><span class="hs-identifier hs-var">sps_origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CtOrigin
</span><a href="#local-6989586621682056980"><span class="hs-identifier hs-var">deriv_origin</span></a></span><span>
</span><span id="line-421"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sps_type_or_kind :: TypeOrKind
</span><a href="GHC.Tc.Deriv.Utils.html#sps_type_or_kind"><span class="hs-identifier hs-var">sps_type_or_kind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a></span><span>
</span><span id="line-422"></span><span>                                     </span><span class="hs-special">}</span><span>
</span><span id="line-423"></span><span>              </span><span class="hs-comment">-- rep_pred is the representation dictionary, from where</span><span>
</span><span id="line-424"></span><span>              </span><span class="hs-comment">-- we are going to get all the methods for the final</span><span>
</span><span id="line-425"></span><span>              </span><span class="hs-comment">-- dictionary</span><span>
</span><span id="line-426"></span><span>      </span><span id="local-6989586621682056980"><span class="annot"><span class="annottext">deriv_origin :: CtOrigin
</span><a href="#local-6989586621682056980"><span class="hs-identifier hs-var hs-var">deriv_origin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; CtOrigin
</span><a href="GHC.Tc.Deriv.Utils.html#mkDerivOrigin"><span class="hs-identifier hs-var">mkDerivOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056973"><span class="hs-identifier hs-var">sa_wildcard</span></a></span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span>      </span><span class="hs-comment">-- Next we collect constraints for the class methods</span><span>
</span><span id="line-429"></span><span>      </span><span class="hs-comment">-- If there are no methods, we don't need any constraints</span><span>
</span><span id="line-430"></span><span>      </span><span class="hs-comment">-- Otherwise we need (C rep_ty), for the representation methods,</span><span>
</span><span id="line-431"></span><span>      </span><span class="hs-comment">-- and constraints to coerce each individual method</span><span>
</span><span id="line-432"></span><span>      </span><span class="annot"><a href="#local-6989586621682056981"><span class="hs-identifier hs-type">meth_preds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span>
</span><span id="line-433"></span><span>      </span><span id="local-6989586621682056981"><span class="annot"><span class="annottext">meth_preds :: PredType -&gt; ThetaSpec
</span><a href="#local-6989586621682056981"><span class="hs-identifier hs-var hs-var">meth_preds</span></a></span></span><span> </span><span id="local-6989586621682056982"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056982"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-434"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Foldable.html#null/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056983"><span class="hs-identifier hs-var">meths</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- No methods =&gt; no constraints</span><span>
</span><span id="line-435"></span><span>                          </span><span class="hs-comment">-- (#12814)</span><span>
</span><span id="line-436"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PredType -&gt; PredSpec
</span><a href="#local-6989586621682056978"><span class="hs-identifier hs-var">rep_pred_o</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056982"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">PredSpec -&gt; ThetaSpec -&gt; ThetaSpec
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">PredType -&gt; ThetaSpec
</span><a href="#local-6989586621682056984"><span class="hs-identifier hs-var">coercible_constraints</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056982"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-437"></span><span>      </span><span id="local-6989586621682056983"><span class="annot"><span class="annottext">meths :: [TyVar]
</span><a href="#local-6989586621682056983"><span class="hs-identifier hs-var hs-var">meths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [TyVar]
</span><a href="GHC.Core.Class.html#classMethods"><span class="hs-identifier hs-var">classMethods</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056971"><span class="hs-identifier hs-var">cls</span></a></span><span>
</span><span id="line-438"></span><span>      </span><span id="local-6989586621682056984"><span class="annot"><span class="annottext">coercible_constraints :: PredType -&gt; ThetaSpec
</span><a href="#local-6989586621682056984"><span class="hs-identifier hs-var hs-var">coercible_constraints</span></a></span></span><span> </span><span id="local-6989586621682056986"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056986"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-439"></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#SimplePredSpec"><span class="hs-identifier hs-type">SimplePredSpec</span></a></span><span>
</span><span id="line-440"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sps_pred :: PredType
</span><a href="GHC.Tc.Deriv.Utils.html#sps_pred"><span class="hs-identifier hs-var">sps_pred</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PredType -&gt; PredType -&gt; PredType
</span><a href="GHC.Core.Coercion.html#mkReprPrimEqPred"><span class="hs-identifier hs-var">mkReprPrimEqPred</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056988"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056989"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-441"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sps_origin :: CtOrigin
</span><a href="GHC.Tc.Deriv.Utils.html#sps_origin"><span class="hs-identifier hs-var">sps_origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyVar -&gt; PredType -&gt; PredType -&gt; Bool -&gt; CtOrigin
</span><a href="GHC.Tc.Types.Origin.html#DerivOriginCoerce"><span class="hs-identifier hs-var">DerivOriginCoerce</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682056991"><span class="hs-identifier hs-var">meth</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056988"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056989"><span class="hs-identifier hs-var">t2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621682056973"><span class="hs-identifier hs-var">sa_wildcard</span></a></span><span>
</span><span id="line-442"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sps_type_or_kind :: TypeOrKind
</span><a href="GHC.Tc.Deriv.Utils.html#sps_type_or_kind"><span class="hs-identifier hs-var">sps_type_or_kind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeOrKind
</span><a href="GHC.Types.Basic.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a></span><span>
</span><span id="line-443"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-444"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621682056991"><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682056991"><span class="hs-identifier hs-var">meth</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056983"><span class="hs-identifier hs-var">meths</span></a></span><span>
</span><span id="line-445"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a></span><span> </span><span id="local-6989586621682056988"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056988"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621682056989"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056989"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class
-&gt; [TyVar] -&gt; [PredType] -&gt; PredType -&gt; TyVar -&gt; Pair PredType
</span><a href="GHC.Tc.Deriv.Generate.html#mkCoerceClassMethEqn"><span class="hs-identifier hs-var">mkCoerceClassMethEqn</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682056971"><span class="hs-identifier hs-var">cls</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682056970"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-446"></span><span>                                       </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682056972"><span class="hs-identifier hs-var">inst_tys</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056986"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">TyVar
</span><a href="#local-6989586621682056991"><span class="hs-identifier hs-var">meth</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span>  </span><span class="annot"><span class="annottext">ThetaSpec -&gt; DerivM ThetaSpec
forall a. a -&gt; ReaderT DerivEnv (IOEnv (Env TcGblEnv TcLclEnv)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#pure/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PredType -&gt; ThetaSpec
</span><a href="#local-6989586621682056981"><span class="hs-identifier hs-var">meth_preds</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682056969"><span class="hs-identifier hs-var">rep_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span class="hs-comment">{- Note [Inferring the instance context]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There are two sorts of 'deriving', as represented by the two constructors
for DerivContext:

  * InferContext mb_wildcard: This can either be:
    - The deriving clause for a data type.
        (e.g, data T a = T1 a deriving( Eq ))
      In this case, mb_wildcard = Nothing.
    - A standalone declaration with an extra-constraints wildcard
        (e.g., deriving instance _ =&gt; Eq (Foo a))
      In this case, mb_wildcard = Just loc, where loc is the location
      of the extra-constraints wildcard.

    Here we must infer an instance context,
    and generate instance declaration
      instance Eq a =&gt; Eq (T a) where ...

  * SupplyContext theta: standalone deriving
      deriving instance Eq a =&gt; Eq (T a)
    Here we only need to fill in the bindings;
    the instance context (theta) is user-supplied

For the InferContext case, we must figure out the
instance context (inferConstraintsStock). Suppose we are inferring
the instance context for
    C t1 .. tn (T s1 .. sm)
There are two cases

  * (T s1 .. sm) :: *         (the normal case)
    Then we behave like Eq and guess (C t1 .. tn t)
    for each data constructor arg of type t.  More
    details below.

  * (T s1 .. sm) :: * -&gt; *    (the functor-like case)
    Then we behave like Functor.

In both cases we produce a bunch of un-simplified constraints
and them simplify them in simplifyInstanceContexts; see
Note [Simplifying the instance context].

In the functor-like case, we may need to unify some kind variables with * in
order for the generated instance to be well-kinded. An example from #10524:

  newtype Compose (f :: k2 -&gt; *) (g :: k1 -&gt; k2) (a :: k1)
    = Compose (f (g a)) deriving Functor

Earlier in the deriving pipeline, GHC unifies the kind of Compose f g
(k1 -&gt; *) with the kind of Functor's argument (* -&gt; *), so k1 := *. But this
alone isn't enough, since k2 wasn't unified with *:

  instance (Functor (f :: k2 -&gt; *), Functor (g :: * -&gt; k2)) =&gt;
    Functor (Compose f g) where ...

The two Functor constraints are ill-kinded. To ensure this doesn't happen, we:

  1. Collect all of a datatype's subtypes which require functor-like
     constraints.
  2. For each subtype, create a substitution by unifying the subtype's kind
     with (* -&gt; *).
  3. Compose all the substitutions into one, then apply that substitution to
     all of the in-scope type variables and the instance types.

Note [Getting base classes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Functor and Typeable are defined in package 'base', and that is not available
when compiling 'ghc-prim'.  So we must be careful that 'deriving' for stuff in
ghc-prim does not use Functor or Typeable implicitly via these lookups.

Note [Deriving and unboxed types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We have some special hacks to support things like
   data T = MkT Int# deriving ( Show )

Specifically, we use GHC.Tc.Deriv.Generate.box to box the Int# into an Int
(which we know how to show), and append a '#'. Parentheses are not required
for unboxed values (`MkT -3#` is a valid expression).

Note [Superclasses of derived instance]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general, a derived instance decl needs the superclasses of the derived
class too.  So if we have
        data T a = ...deriving( Ord )
then the initial context for Ord (T a) should include Eq (T a).  Often this is
redundant; we'll also generate an Ord constraint for each constructor argument,
and that will probably generate enough constraints to make the Eq (T a) constraint
be satisfied too.  But not always; consider:

 data S a = S
 instance Eq (S a)
 instance Ord (S a)

 data T a = MkT (S a) deriving( Ord )
 instance Num a =&gt; Eq (T a)

The derived instance for (Ord (T a)) must have a (Num a) constraint!
Similarly consider:
        data T a = MkT deriving( Data )
Here there *is* no argument field, but we must nevertheless generate
a context for the Data instances:
        instance Typeable a =&gt; Data (T a) where ...


************************************************************************
*                                                                      *
         Finding the fixed point of deriving equations
*                                                                      *
************************************************************************

Note [Simplifying the instance context]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

        data T a b = C1 (Foo a) (Bar b)
                   | C2 Int (T b a)
                   | C3 (T a a)
                   deriving (Eq)

We want to come up with an instance declaration of the form

        instance (Ping a, Pong b, ...) =&gt; Eq (T a b) where
                x == y = ...

It is pretty easy, albeit tedious, to fill in the code &quot;...&quot;.  The
trick is to figure out what the context for the instance decl is,
namely Ping, Pong and friends.

Let's call the context reqd for the T instance of class C at types
(a,b, ...)  C (T a b).  Thus:

        Eq (T a b) = (Ping a, Pong b, ...)

Now we can get a (recursive) equation from the data decl.  This part
is done by inferConstraintsStock.

        Eq (T a b) = Eq (Foo a) u Eq (Bar b)    -- From C1
                   u Eq (T b a) u Eq Int        -- From C2
                   u Eq (T a a)                 -- From C3


Foo and Bar may have explicit instances for Eq, in which case we can
just substitute for them.  Alternatively, either or both may have
their Eq instances given by deriving clauses, in which case they
form part of the system of equations.

Now all we need do is simplify and solve the equations, iterating to
find the least fixpoint.  This is done by simplifyInstanceConstraints.
Notice that the order of the arguments can
switch around, as here in the recursive calls to T.

Let's suppose Eq (Foo a) = Eq a, and Eq (Bar b) = Ping b.

We start with:

        Eq (T a b) = {}         -- The empty set

Next iteration:
        Eq (T a b) = Eq (Foo a) u Eq (Bar b)    -- From C1
                   u Eq (T b a) u Eq Int        -- From C2
                   u Eq (T a a)                 -- From C3

        After simplification:
                   = Eq a u Ping b u {} u {} u {}
                   = Eq a u Ping b

Next iteration:

        Eq (T a b) = Eq (Foo a) u Eq (Bar b)    -- From C1
                   u Eq (T b a) u Eq Int        -- From C2
                   u Eq (T a a)                 -- From C3

        After simplification:
                   = Eq a u Ping b
                   u (Eq b u Ping a)
                   u (Eq a u Ping a)

                   = Eq a u Ping b u Eq b u Ping a

The next iteration gives the same result, so this is the fixpoint.  We
need to make a canonical form of the RHS to ensure convergence.  We do
this by simplifying the RHS to a form in which

        - the classes constrain only tyvars
        - the list is sorted by tyvar (major key) and then class (minor key)
        - no duplicates, of course

Note [Deterministic simplifyInstanceContexts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Canonicalisation uses nonDetCmpType which is nondeterministic. Sorting
with nonDetCmpType puts the returned lists in a nondeterministic order.
If we were to return them, we'd get class constraints in
nondeterministic order.

Consider:

  data ADT a b = Z a b deriving Eq

The generated code could be either:

  instance (Eq a, Eq b) =&gt; Eq (Z a b) where

Or:

  instance (Eq b, Eq a) =&gt; Eq (Z a b) where

To prevent the order from being nondeterministic we only
canonicalize when comparing and return them in the same order as
simplifyDeriv returned them.
See also Note [nonDetCmpType nondeterminism]
-}</span><span>
</span><span id="line-660"></span><span>
</span><span id="line-661"></span><span>
</span><span id="line-662"></span><span class="annot"><a href="GHC.Tc.Deriv.Infer.html#simplifyInstanceContexts"><span class="hs-identifier hs-type">simplifyInstanceContexts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-663"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-664"></span><span class="hs-comment">-- Used only for deriving clauses or standalone deriving with an</span><span>
</span><span id="line-665"></span><span class="hs-comment">-- extra-constraints wildcard (InferContext)</span><span>
</span><span id="line-666"></span><span class="hs-comment">-- See Note [Simplifying the instance context]</span><span>
</span><span id="line-667"></span><span>
</span><span id="line-668"></span><span id="simplifyInstanceContexts"><span class="annot"><span class="annottext">simplifyInstanceContexts :: [DerivSpec ThetaSpec] -&gt; TcM [DerivSpec [PredType]]
</span><a href="GHC.Tc.Deriv.Infer.html#simplifyInstanceContexts"><span class="hs-identifier hs-var hs-var">simplifyInstanceContexts</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DerivSpec [PredType]] -&gt; TcM [DerivSpec [PredType]]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span class="annot"><a href="GHC.Tc.Deriv.Infer.html#simplifyInstanceContexts"><span class="hs-identifier hs-var">simplifyInstanceContexts</span></a></span><span> </span><span id="local-6989586621682056995"><span class="annot"><span class="annottext">[DerivSpec ThetaSpec]
</span><a href="#local-6989586621682056995"><span class="hs-identifier hs-var">infer_specs</span></a></span></span><span>
</span><span id="line-671"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplifyInstanceContexts&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcRn ()) -&gt; SDoc -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DerivSpec ThetaSpec -&gt; SDoc) -&gt; [DerivSpec ThetaSpec] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">DerivSpec ThetaSpec -&gt; SDoc
forall theta. Outputable theta =&gt; DerivSpec theta -&gt; SDoc
</span><a href="GHC.Tc.Deriv.Utils.html#pprDerivSpec"><span class="hs-identifier hs-var">pprDerivSpec</span></a></span><span> </span><span class="annot"><span class="annottext">[DerivSpec ThetaSpec]
</span><a href="#local-6989586621682056995"><span class="hs-identifier hs-var">infer_specs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-672"></span><span>        </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682056997"><span class="annot"><span class="annottext">[DerivSpec [PredType]]
</span><a href="#local-6989586621682056997"><span class="hs-identifier hs-var">final_specs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [[PredType]] -&gt; TcM [DerivSpec [PredType]]
</span><a href="#local-6989586621682056998"><span class="hs-identifier hs-var">iterate_deriv</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">[[PredType]]
</span><a href="#local-6989586621682056999"><span class="hs-identifier hs-var">initial_solutions</span></a></span><span>
</span><span id="line-673"></span><span>          </span><span class="hs-comment">-- After simplification finishes, zonk the TcTyVars as described</span><span>
</span><span id="line-674"></span><span>          </span><span class="hs-comment">-- in Note [Overlap and deriving].</span><span>
</span><span id="line-675"></span><span>        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">(DerivSpec [PredType]
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) (DerivSpec [PredType]))
-&gt; [DerivSpec [PredType]] -&gt; TcM [DerivSpec [PredType]]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><a href="../../base-4.18.3.0/src/Data.Traversable.html#traverse/Data.Traversable.html#traverse"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">DerivSpec [PredType]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) (DerivSpec [PredType])
</span><a href="GHC.Tc.Deriv.Utils.html#zonkDerivSpec"><span class="hs-identifier hs-var">zonkDerivSpec</span></a></span><span> </span><span class="annot"><span class="annottext">[DerivSpec [PredType]]
</span><a href="#local-6989586621682056997"><span class="hs-identifier hs-var">final_specs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-676"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-677"></span><span>    </span><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><span id="line-678"></span><span>        </span><span class="hs-comment">-- The initial solutions for the equations claim that each</span><span>
</span><span id="line-679"></span><span>        </span><span class="hs-comment">-- instance has an empty context; this solution is certainly</span><span>
</span><span id="line-680"></span><span>        </span><span class="hs-comment">-- in canonical form.</span><span>
</span><span id="line-681"></span><span>    </span><span class="annot"><a href="#local-6989586621682056999"><span class="hs-identifier hs-type">initial_solutions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-682"></span><span>    </span><span id="local-6989586621682056999"><span class="annot"><span class="annottext">initial_solutions :: [[PredType]]
</span><a href="#local-6989586621682056999"><span class="hs-identifier hs-var hs-var">initial_solutions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DerivSpec ThetaSpec
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DerivSpec ThetaSpec]
</span><a href="#local-6989586621682056995"><span class="hs-identifier hs-var">infer_specs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-683"></span><span>
</span><span id="line-684"></span><span>    </span><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><span id="line-685"></span><span>        </span><span class="hs-comment">-- iterate_deriv calculates the next batch of solutions,</span><span>
</span><span id="line-686"></span><span>        </span><span class="hs-comment">-- compares it with the current one; finishes if they are the</span><span>
</span><span id="line-687"></span><span>        </span><span class="hs-comment">-- same, otherwise recurses with the new solutions.</span><span>
</span><span id="line-688"></span><span>        </span><span class="hs-comment">-- It fails if any iteration fails</span><span>
</span><span id="line-689"></span><span>    </span><span class="annot"><a href="#local-6989586621682056998"><span class="hs-identifier hs-type">iterate_deriv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-690"></span><span>    </span><span id="local-6989586621682056998"><span class="annot"><span class="annottext">iterate_deriv :: Int -&gt; [[PredType]] -&gt; TcM [DerivSpec [PredType]]
</span><a href="#local-6989586621682056998"><span class="hs-identifier hs-var hs-var">iterate_deriv</span></a></span></span><span> </span><span id="local-6989586621682057002"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682057002"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621682057003"><span class="annot"><span class="annottext">[[PredType]]
</span><a href="#local-6989586621682057003"><span class="hs-identifier hs-var">current_solns</span></a></span></span><span>
</span><span id="line-691"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682057002"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">20</span></span><span>  </span><span class="hs-comment">-- Looks as if we are in an infinite loop</span><span>
</span><span id="line-692"></span><span>                </span><span class="hs-comment">-- This can happen if we have -XUndecidableInstances</span><span>
</span><span id="line-693"></span><span>                </span><span class="hs-comment">-- (See GHC.Tc.Solver.tcSimplifyDeriv.)</span><span>
</span><span id="line-694"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcM [DerivSpec [PredType]]
forall a. HasCallStack =&gt; String -&gt; SDoc -&gt; a
</span><a href="GHC.Utils.Panic.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;solveDerivEqns: probable loop&quot;</span></span><span>
</span><span id="line-695"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DerivSpec ThetaSpec -&gt; SDoc) -&gt; [DerivSpec ThetaSpec] -&gt; [SDoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">DerivSpec ThetaSpec -&gt; SDoc
forall theta. Outputable theta =&gt; DerivSpec theta -&gt; SDoc
</span><a href="GHC.Tc.Deriv.Utils.html#pprDerivSpec"><span class="hs-identifier hs-var">pprDerivSpec</span></a></span><span> </span><span class="annot"><span class="annottext">[DerivSpec ThetaSpec]
</span><a href="#local-6989586621682056995"><span class="hs-identifier hs-var">infer_specs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[[PredType]] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[[PredType]]
</span><a href="#local-6989586621682057003"><span class="hs-identifier hs-var">current_solns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-696"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-697"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>      </span><span class="hs-comment">-- Extend the inst info from the explicit instance decls</span><span>
</span><span id="line-698"></span><span>                  </span><span class="hs-comment">-- with the current set of solutions, and simplify each RHS</span><span>
</span><span id="line-699"></span><span>             </span><span id="local-6989586621682057007"><span class="annot"><span class="annottext">[ClsInst]
</span><a href="#local-6989586621682057007"><span class="hs-identifier hs-var">inst_specs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([PredType]
 -&gt; DerivSpec ThetaSpec -&gt; IOEnv (Env TcGblEnv TcLclEnv) ClsInst)
-&gt; [[PredType]]
-&gt; [DerivSpec ThetaSpec]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [ClsInst]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><a href="../../base-4.18.3.0/src/Control.Monad.html#zipWithM/Control.Monad.html#zipWithM"><span class="hs-identifier hs-var">zipWithM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621682057009"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682057009"><span class="hs-identifier hs-var">soln</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DerivSpec [PredType] -&gt; IOEnv (Env TcGblEnv TcLclEnv) ClsInst
</span><a href="GHC.Tc.Deriv.Utils.html#newDerivClsInst"><span class="hs-identifier hs-var">newDerivClsInst</span></a></span><span> </span><span class="annot"><span class="annottext">(DerivSpec [PredType] -&gt; IOEnv (Env TcGblEnv TcLclEnv) ClsInst)
-&gt; (DerivSpec ThetaSpec -&gt; DerivSpec [PredType])
-&gt; DerivSpec ThetaSpec
-&gt; IOEnv (Env TcGblEnv TcLclEnv) ClsInst
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType] -&gt; DerivSpec ThetaSpec -&gt; DerivSpec [PredType]
forall theta' theta. theta' -&gt; DerivSpec theta -&gt; DerivSpec theta'
</span><a href="GHC.Tc.Deriv.Utils.html#setDerivSpecTheta"><span class="hs-identifier hs-var">setDerivSpecTheta</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682057009"><span class="hs-identifier hs-var">soln</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-700"></span><span>                                    </span><span class="annot"><span class="annottext">[[PredType]]
</span><a href="#local-6989586621682057003"><span class="hs-identifier hs-var">current_solns</span></a></span><span> </span><span class="annot"><span class="annottext">[DerivSpec ThetaSpec]
</span><a href="#local-6989586621682056995"><span class="hs-identifier hs-var">infer_specs</span></a></span><span>
</span><span id="line-701"></span><span>           </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682057012"><span class="annot"><span class="annottext">[[PredType]]
</span><a href="#local-6989586621682057012"><span class="hs-identifier hs-var">new_solns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcM [[PredType]] -&gt; TcM [[PredType]]
forall r. TcM r -&gt; TcM r
</span><a href="GHC.Tc.Utils.Monad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM [[PredType]] -&gt; TcM [[PredType]])
-&gt; TcM [[PredType]] -&gt; TcM [[PredType]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-702"></span><span>                          </span><span class="annot"><span class="annottext">[ClsInst] -&gt; TcM [[PredType]] -&gt; TcM [[PredType]]
forall a. [ClsInst] -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Deriv.Utils.html#extendLocalInstEnv"><span class="hs-identifier hs-var">extendLocalInstEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[ClsInst]
</span><a href="#local-6989586621682057007"><span class="hs-identifier hs-var">inst_specs</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM [[PredType]] -&gt; TcM [[PredType]])
-&gt; TcM [[PredType]] -&gt; TcM [[PredType]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-703"></span><span>                          </span><span class="annot"><span class="annottext">(DerivSpec ThetaSpec -&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType])
-&gt; [DerivSpec ThetaSpec] -&gt; TcM [[PredType]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapM/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">DerivSpec ThetaSpec -&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType]
</span><a href="GHC.Tc.Deriv.Infer.html#simplifyDeriv"><span class="hs-identifier hs-var">simplifyDeriv</span></a></span><span> </span><span class="annot"><span class="annottext">[DerivSpec ThetaSpec]
</span><a href="#local-6989586621682056995"><span class="hs-identifier hs-var">infer_specs</span></a></span><span>
</span><span id="line-704"></span><span>
</span><span id="line-705"></span><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[PredType]]
</span><a href="#local-6989586621682057003"><span class="hs-identifier hs-var">current_solns</span></a></span><span> </span><span class="annot"><span class="annottext">[[PredType]] -&gt; [[PredType]] -&gt; Bool
</span><a href="#local-6989586621682057017"><span class="hs-operator hs-var">`eqSolution`</span></a></span><span> </span><span class="annot"><span class="annottext">[[PredType]]
</span><a href="#local-6989586621682057012"><span class="hs-identifier hs-var">new_solns</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-706"></span><span>                </span><span class="annot"><span class="annottext">[DerivSpec [PredType]] -&gt; TcM [DerivSpec [PredType]]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[PredType] -&gt; DerivSpec ThetaSpec -&gt; DerivSpec [PredType]
forall theta' theta. theta' -&gt; DerivSpec theta -&gt; DerivSpec theta'
</span><a href="GHC.Tc.Deriv.Utils.html#setDerivSpecTheta"><span class="hs-identifier hs-var">setDerivSpecTheta</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682057018"><span class="hs-identifier hs-var">soln</span></a></span><span> </span><span class="annot"><span class="annottext">DerivSpec ThetaSpec
</span><a href="#local-6989586621682057019"><span class="hs-identifier hs-var">spec</span></a></span><span>
</span><span id="line-707"></span><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682057019"><span class="annot"><span class="annottext">DerivSpec ThetaSpec
</span><a href="#local-6989586621682057019"><span class="hs-identifier hs-var">spec</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682057018"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682057018"><span class="hs-identifier hs-var">soln</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DerivSpec ThetaSpec]
-&gt; [[PredType]] -&gt; [(DerivSpec ThetaSpec, [PredType])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../base-4.18.3.0/src/GHC.List.html#zip/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a></span><span> </span><span class="annot"><span class="annottext">[DerivSpec ThetaSpec]
</span><a href="#local-6989586621682056995"><span class="hs-identifier hs-var">infer_specs</span></a></span><span> </span><span class="annot"><span class="annottext">[[PredType]]
</span><a href="#local-6989586621682057003"><span class="hs-identifier hs-var">current_solns</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-708"></span><span>             </span><span class="hs-keyword">else</span><span>
</span><span id="line-709"></span><span>                </span><span class="annot"><span class="annottext">Int -&gt; [[PredType]] -&gt; TcM [DerivSpec [PredType]]
</span><a href="#local-6989586621682056998"><span class="hs-identifier hs-var">iterate_deriv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621682057002"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Num.html#%2B/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[[PredType]]
</span><a href="#local-6989586621682057012"><span class="hs-identifier hs-var">new_solns</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-710"></span><span>
</span><span id="line-711"></span><span>    </span><span id="local-6989586621682057017"><span class="annot"><span class="annottext">eqSolution :: [[PredType]] -&gt; [[PredType]] -&gt; Bool
</span><a href="#local-6989586621682057017"><span class="hs-identifier hs-var hs-var">eqSolution</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([PredType] -&gt; [PredType] -&gt; Bool)
-&gt; [[PredType]] -&gt; [[PredType]] -&gt; Bool
forall a b. (a -&gt; b -&gt; Bool) -&gt; [a] -&gt; [b] -&gt; Bool
forall (f :: * -&gt; *) a b.
Eq1 f =&gt;
(a -&gt; b -&gt; Bool) -&gt; f a -&gt; f b -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Functor.Classes.html#liftEq/Data.Functor.Classes.html#liftEq"><span class="hs-identifier hs-var">liftEq</span></a></span><span> </span><span class="annot"><span class="annottext">(([PredType] -&gt; [PredType] -&gt; Bool)
 -&gt; [[PredType]] -&gt; [[PredType]] -&gt; Bool)
-&gt; ((PredType -&gt; PredType -&gt; Bool)
    -&gt; [PredType] -&gt; [PredType] -&gt; Bool)
-&gt; (PredType -&gt; PredType -&gt; Bool)
-&gt; [[PredType]]
-&gt; [[PredType]]
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#./GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(PredType -&gt; PredType -&gt; Bool) -&gt; [PredType] -&gt; [PredType] -&gt; Bool
forall a b. (a -&gt; b -&gt; Bool) -&gt; [a] -&gt; [b] -&gt; Bool
forall (f :: * -&gt; *) a b.
Eq1 f =&gt;
(a -&gt; b -&gt; Bool) -&gt; f a -&gt; f b -&gt; Bool
</span><a href="../../base-4.18.3.0/src/Data.Functor.Classes.html#liftEq/Data.Functor.Classes.html#liftEq"><span class="hs-identifier hs-var">liftEq</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PredType -&gt; PredType -&gt; Bool
</span><a href="GHC.Core.TyCo.Compare.html#eqType"><span class="hs-identifier hs-var">eqType</span></a></span><span> </span><span class="annot"><span class="annottext">([[PredType]] -&gt; [[PredType]] -&gt; Bool)
-&gt; ([[PredType]] -&gt; [[PredType]])
-&gt; [[PredType]]
-&gt; [[PredType]]
-&gt; Bool
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="../../base-4.18.3.0/src/Data.Function.html#on/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span> </span><span class="annot"><span class="annottext">[[PredType]] -&gt; [[PredType]]
</span><a href="#local-6989586621682057025"><span class="hs-identifier hs-var">canSolution</span></a></span><span>
</span><span id="line-712"></span><span>       </span><span class="hs-comment">-- Canonicalise for comparison</span><span>
</span><span id="line-713"></span><span>       </span><span class="hs-comment">-- See Note [Deterministic simplifyInstanceContexts]</span><span>
</span><span id="line-714"></span><span>    </span><span id="local-6989586621682057025"><span class="annot"><span class="annottext">canSolution :: [[PredType]] -&gt; [[PredType]]
</span><a href="#local-6989586621682057025"><span class="hs-identifier hs-var hs-var">canSolution</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([PredType] -&gt; [PredType]) -&gt; [[PredType]] -&gt; [[PredType]]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#map/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PredType -&gt; PredType -&gt; Ordering) -&gt; [PredType] -&gt; [PredType]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><a href="../../base-4.18.3.0/src/Data.OldList.html#sortBy/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a></span><span> </span><span class="annot"><span class="annottext">PredType -&gt; PredType -&gt; Ordering
</span><a href="GHC.Core.TyCo.Compare.html#nonDetCmpType"><span class="hs-identifier hs-var">nonDetCmpType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-715"></span><span>
</span><span id="line-716"></span><span class="annot"><a href="GHC.Tc.Deriv.Infer.html#derivInstCtxt"><span class="hs-identifier hs-type">derivInstCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a></span><span>
</span><span id="line-717"></span><span id="derivInstCtxt"><span class="annot"><span class="annottext">derivInstCtxt :: PredType -&gt; SDoc
</span><a href="GHC.Tc.Deriv.Infer.html#derivInstCtxt"><span class="hs-identifier hs-var hs-var">derivInstCtxt</span></a></span></span><span> </span><span id="local-6989586621682057028"><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682057028"><span class="hs-identifier hs-var">pred</span></a></span></span><span>
</span><span id="line-718"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc
forall doc. IsLine doc =&gt; String -&gt; doc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;When deriving the instance for&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
forall doc. IsLine doc =&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682057028"><span class="hs-identifier hs-var">pred</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-719"></span><span>
</span><span id="line-720"></span><span class="hs-comment">{-
***********************************************************************************
*                                                                                 *
*            Simplify derived constraints
*                                                                                 *
***********************************************************************************
-}</span><span>
</span><span id="line-727"></span><span>
</span><span id="line-728"></span><span>
</span><span id="line-729"></span><span class="hs-comment">-- | Given @instance (wanted) =&gt; C inst_ty@, simplify 'wanted' as much</span><span>
</span><span id="line-730"></span><span class="hs-comment">-- as possible. Fail if not possible.</span><span>
</span><span id="line-731"></span><span class="annot"><a href="GHC.Tc.Deriv.Infer.html#simplifyDeriv"><span class="hs-identifier hs-type">simplifyDeriv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a></span><span> </span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#ThetaSpec"><span class="hs-identifier hs-type">ThetaSpec</span></a></span><span>
</span><span id="line-732"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Tc.Types.html#TcM"><span class="hs-identifier hs-type">TcM</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a></span><span> </span><span class="hs-comment">-- ^ Needed constraints (after simplification),</span><span>
</span><span id="line-733"></span><span>                               </span><span class="hs-comment">-- i.e. @['PredType']@.</span><span>
</span><span id="line-734"></span><span id="simplifyDeriv"><span class="annot"><span class="annottext">simplifyDeriv :: DerivSpec ThetaSpec -&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType]
</span><a href="GHC.Tc.Deriv.Infer.html#simplifyDeriv"><span class="hs-identifier hs-var hs-var">simplifyDeriv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Tc.Deriv.Utils.html#DS"><span class="hs-identifier hs-type">DS</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ds_loc :: forall theta. DerivSpec theta -&gt; SrcSpan
</span><a href="GHC.Tc.Deriv.Utils.html#ds_loc"><span class="hs-identifier hs-var">ds_loc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682057033"><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621682057033"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ds_tvs :: forall theta. DerivSpec theta -&gt; [TyVar]
</span><a href="GHC.Tc.Deriv.Utils.html#ds_tvs"><span class="hs-identifier hs-var">ds_tvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682057035"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682057035"><span class="hs-identifier hs-var">tvs</span></a></span></span><span>
</span><span id="line-735"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ds_cls :: forall theta. DerivSpec theta -&gt; Class
</span><a href="GHC.Tc.Deriv.Utils.html#ds_cls"><span class="hs-identifier hs-var">ds_cls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682057037"><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682057037"><span class="hs-identifier hs-var">clas</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ds_tys :: forall theta. DerivSpec theta -&gt; [PredType]
</span><a href="GHC.Tc.Deriv.Utils.html#ds_tys"><span class="hs-identifier hs-var">ds_tys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682057039"><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682057039"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ds_theta :: forall theta. DerivSpec theta -&gt; theta
</span><a href="GHC.Tc.Deriv.Utils.html#ds_theta"><span class="hs-identifier hs-var">ds_theta</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682057041"><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682057041"><span class="hs-identifier hs-var">deriv_rhs</span></a></span></span><span>
</span><span id="line-736"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ds_skol_info :: forall theta. DerivSpec theta -&gt; SkolemInfo
</span><a href="GHC.Tc.Deriv.Utils.html#ds_skol_info"><span class="hs-identifier hs-var">ds_skol_info</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682057043"><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621682057043"><span class="hs-identifier hs-var">skol_info</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ds_user_ctxt :: forall theta. DerivSpec theta -&gt; UserTypeCtxt
</span><a href="GHC.Tc.Deriv.Utils.html#ds_user_ctxt"><span class="hs-identifier hs-var">ds_user_ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621682057045"><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621682057045"><span class="hs-identifier hs-var">user_ctxt</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcSpan
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType]
forall a. SrcSpan -&gt; TcRn a -&gt; TcRn a
</span><a href="GHC.Tc.Utils.Monad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621682057033"><span class="hs-identifier hs-var">loc</span></a></span><span>  </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) [PredType]
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType])
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-738"></span><span>    </span><span class="annot"><span class="annottext">SDoc
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType]
forall a. SDoc -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PredType -&gt; SDoc
</span><a href="GHC.Tc.Deriv.Infer.html#derivInstCtxt"><span class="hs-identifier hs-var">derivInstCtxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Class -&gt; [PredType] -&gt; PredType
</span><a href="GHC.Core.Predicate.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682057037"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682057039"><span class="hs-identifier hs-var">inst_tys</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IOEnv (Env TcGblEnv TcLclEnv) [PredType]
 -&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType])
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType]
-&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-739"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-740"></span><span>       </span><span class="hs-comment">-- See [STEP DAC BUILD]</span><span>
</span><span id="line-741"></span><span>       </span><span class="hs-comment">-- Generate the implication constraints, one for each method, to solve</span><span>
</span><span id="line-742"></span><span>       </span><span class="hs-comment">-- with the skolemized variables.  Start &quot;one level down&quot; because</span><span>
</span><span id="line-743"></span><span>       </span><span class="hs-comment">-- we are going to wrap the result in an implication with tvs,</span><span>
</span><span id="line-744"></span><span>       </span><span class="hs-comment">-- in step [DAC RESIDUAL]</span><span>
</span><span id="line-745"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682057048"><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621682057048"><span class="hs-identifier hs-var">tc_lvl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621682057049"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621682057049"><span class="hs-identifier hs-var">wanteds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt -&gt; ThetaSpec -&gt; TcM (TcLevel, WantedConstraints)
</span><a href="GHC.Tc.Deriv.Utils.html#captureThetaSpecConstraints"><span class="hs-identifier hs-var">captureThetaSpecConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">UserTypeCtxt
</span><a href="#local-6989586621682057045"><span class="hs-identifier hs-var">user_ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682057041"><span class="hs-identifier hs-var">deriv_rhs</span></a></span><span>
</span><span id="line-746"></span><span>
</span><span id="line-747"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplifyDeriv inputs&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcRn ()) -&gt; SDoc -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-748"></span><span>         </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; SDoc
</span><a href="GHC.Core.TyCo.Ppr.html#pprTyVars"><span class="hs-identifier hs-var">pprTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682057035"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">ThetaSpec -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682057041"><span class="hs-identifier hs-var">deriv_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621682057049"><span class="hs-identifier hs-var">wanteds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SkolemInfo -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621682057043"><span class="hs-identifier hs-var">skol_info</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-749"></span><span>
</span><span id="line-750"></span><span>       </span><span class="hs-comment">-- See [STEP DAC SOLVE]</span><span>
</span><span id="line-751"></span><span>       </span><span class="hs-comment">-- Simplify the constraints, starting at the same level at which</span><span>
</span><span id="line-752"></span><span>       </span><span class="hs-comment">-- they are generated (c.f. the call to runTcSWithEvBinds in</span><span>
</span><span id="line-753"></span><span>       </span><span class="hs-comment">-- simplifyInfer)</span><span>
</span><span id="line-754"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682057051"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621682057051"><span class="hs-identifier hs-var">solved_wanteds</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EvBindMap
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcLevel
-&gt; TcM (WantedConstraints, EvBindMap)
-&gt; TcM (WantedConstraints, EvBindMap)
forall a. TcLevel -&gt; TcM a -&gt; TcM a
</span><a href="GHC.Tc.Utils.Monad.html#setTcLevel"><span class="hs-identifier hs-var">setTcLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621682057048"><span class="hs-identifier hs-var">tc_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">(TcM (WantedConstraints, EvBindMap)
 -&gt; TcM (WantedConstraints, EvBindMap))
-&gt; TcM (WantedConstraints, EvBindMap)
-&gt; TcM (WantedConstraints, EvBindMap)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-755"></span><span>                                </span><span class="annot"><span class="annottext">TcS WantedConstraints -&gt; TcM (WantedConstraints, EvBindMap)
forall a. TcS a -&gt; TcM (a, EvBindMap)
</span><a href="GHC.Tc.Solver.Monad.html#runTcS"><span class="hs-identifier hs-var">runTcS</span></a></span><span>            </span><span class="annot"><span class="annottext">(TcS WantedConstraints -&gt; TcM (WantedConstraints, EvBindMap))
-&gt; TcS WantedConstraints -&gt; TcM (WantedConstraints, EvBindMap)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-756"></span><span>                                </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcS WantedConstraints
</span><a href="GHC.Tc.Solver.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621682057049"><span class="hs-identifier hs-var">wanteds</span></a></span><span>
</span><span id="line-757"></span><span>
</span><span id="line-758"></span><span>       </span><span class="hs-comment">-- It's not yet zonked!  Obviously zonk it before peering at it</span><span>
</span><span id="line-759"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682057054"><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621682057054"><span class="hs-identifier hs-var">solved_wanteds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WantedConstraints -&gt; TcM WantedConstraints
</span><a href="GHC.Tc.Utils.TcMType.html#zonkWC"><span class="hs-identifier hs-var">zonkWC</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621682057051"><span class="hs-identifier hs-var">solved_wanteds</span></a></span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span>       </span><span class="hs-comment">-- See [STEP DAC HOIST]</span><span>
</span><span id="line-762"></span><span>       </span><span class="hs-comment">-- From the simplified constraints extract a subset 'good' that will</span><span>
</span><span id="line-763"></span><span>       </span><span class="hs-comment">-- become the context 'min_theta' for the derived instance.</span><span>
</span><span id="line-764"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682057056"><span class="annot"><span class="annottext">residual_simple :: Cts
</span><a href="#local-6989586621682057056"><span class="hs-identifier hs-var hs-var">residual_simple</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; WantedConstraints -&gt; Cts
</span><a href="GHC.Tc.Solver.html#approximateWC"><span class="hs-identifier hs-var">approximateWC</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621682057054"><span class="hs-identifier hs-var">solved_wanteds</span></a></span><span>
</span><span id="line-765"></span><span>             </span><span id="local-6989586621682057058"><span class="annot"><span class="annottext">head_size :: PatersonSize
</span><a href="#local-6989586621682057058"><span class="hs-identifier hs-var hs-var">head_size</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Class -&gt; [PredType] -&gt; PatersonSize
</span><a href="GHC.Tc.Utils.TcType.html#pSizeClassPred"><span class="hs-identifier hs-var">pSizeClassPred</span></a></span><span> </span><span class="annot"><span class="annottext">Class
</span><a href="#local-6989586621682057037"><span class="hs-identifier hs-var">clas</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682057039"><span class="hs-identifier hs-var">inst_tys</span></a></span><span>
</span><span id="line-766"></span><span>             </span><span id="local-6989586621682057060"><span class="annot"><span class="annottext">good :: Bag PredType
</span><a href="#local-6989586621682057060"><span class="hs-identifier hs-var hs-var">good</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ct -&gt; Maybe PredType) -&gt; Cts -&gt; Bag PredType
forall a b. (a -&gt; Maybe b) -&gt; Bag a -&gt; Bag b
</span><a href="GHC.Data.Bag.html#mapMaybeBag"><span class="hs-identifier hs-var">mapMaybeBag</span></a></span><span> </span><span class="annot"><span class="annottext">Ct -&gt; Maybe PredType
</span><a href="#local-6989586621682057062"><span class="hs-identifier hs-var">get_good</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621682057056"><span class="hs-identifier hs-var">residual_simple</span></a></span><span>
</span><span id="line-767"></span><span>
</span><span id="line-768"></span><span>             </span><span class="hs-comment">-- Returns @Just p@ (where @p@ is the type of the Ct) if a Ct is</span><span>
</span><span id="line-769"></span><span>             </span><span class="hs-comment">-- suitable to be inferred in the context of a derived instance.</span><span>
</span><span id="line-770"></span><span>             </span><span class="hs-comment">-- Returns @Nothing@ if the Ct is too exotic.</span><span>
</span><span id="line-771"></span><span>             </span><span class="hs-comment">-- See Note [Exotic derived instance contexts] for what</span><span>
</span><span id="line-772"></span><span>             </span><span class="hs-comment">-- constitutes an exotic constraint.</span><span>
</span><span id="line-773"></span><span>             </span><span class="annot"><a href="#local-6989586621682057062"><span class="hs-identifier hs-type">get_good</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Tc.Types.Constraint.html#Ct"><span class="hs-identifier hs-type">Ct</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Maybe/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Core.TyCo.Rep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a></span><span>
</span><span id="line-774"></span><span>             </span><span id="local-6989586621682057062"><span class="annot"><span class="annottext">get_good :: Ct -&gt; Maybe PredType
</span><a href="#local-6989586621682057062"><span class="hs-identifier hs-var hs-var">get_good</span></a></span></span><span> </span><span id="local-6989586621682057063"><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621682057063"><span class="hs-identifier hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatersonSize -&gt; PredType -&gt; Bool
</span><a href="GHC.Tc.Validity.html#validDerivPred"><span class="hs-identifier hs-var">validDerivPred</span></a></span><span> </span><span class="annot"><span class="annottext">PatersonSize
</span><a href="#local-6989586621682057058"><span class="hs-identifier hs-var">head_size</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682057064"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PredType -&gt; Maybe PredType
forall a. a -&gt; Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Just/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">PredType
</span><a href="#local-6989586621682057064"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-775"></span><span>                         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#otherwise/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe PredType
forall a. Maybe a
</span><a href="../../base-4.18.3.0/src/GHC.Maybe.html#Nothing/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-776"></span><span>               </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621682057064"><span class="annot"><span class="annottext">p :: PredType
</span><a href="#local-6989586621682057064"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ct -&gt; PredType
</span><a href="GHC.Tc.Types.Constraint.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a></span><span> </span><span class="annot"><span class="annottext">Ct
</span><a href="#local-6989586621682057063"><span class="hs-identifier hs-var">ct</span></a></span><span>
</span><span id="line-777"></span><span>
</span><span id="line-778"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;simplifyDeriv outputs&quot;</span></span><span> </span><span class="annot"><span class="annottext">(SDoc -&gt; TcRn ()) -&gt; SDoc -&gt; TcRn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#%24/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-779"></span><span>         </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
forall doc. IsDoc doc =&gt; [doc] -&gt; doc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[TyVar] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682057035"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Cts -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Cts
</span><a href="#local-6989586621682057056"><span class="hs-identifier hs-var">residual_simple</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bag PredType -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">Bag PredType
</span><a href="#local-6989586621682057060"><span class="hs-identifier hs-var">good</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-780"></span><span>
</span><span id="line-781"></span><span>       </span><span class="hs-comment">-- Return the good unsolved constraints (unskolemizing on the way out.)</span><span>
</span><span id="line-782"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682057066"><span class="annot"><span class="annottext">min_theta :: [PredType]
</span><a href="#local-6989586621682057066"><span class="hs-identifier hs-var hs-var">min_theta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PredType -&gt; PredType) -&gt; [PredType] -&gt; [PredType]
forall a. (a -&gt; PredType) -&gt; [a] -&gt; [a]
</span><a href="GHC.Tc.Utils.TcType.html#mkMinimalBySCs"><span class="hs-identifier hs-var">mkMinimalBySCs</span></a></span><span> </span><span class="annot"><span class="annottext">PredType -&gt; PredType
forall a. a -&gt; a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#id/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bag PredType -&gt; [PredType]
forall a. Bag a -&gt; [a]
</span><a href="GHC.Data.Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a></span><span> </span><span class="annot"><span class="annottext">Bag PredType
</span><a href="#local-6989586621682057060"><span class="hs-identifier hs-var">good</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-783"></span><span>             </span><span class="hs-comment">-- An important property of mkMinimalBySCs (used above) is that in</span><span>
</span><span id="line-784"></span><span>             </span><span class="hs-comment">-- addition to removing constraints that are made redundant by</span><span>
</span><span id="line-785"></span><span>             </span><span class="hs-comment">-- superclass relationships, it also removes _duplicate_</span><span>
</span><span id="line-786"></span><span>             </span><span class="hs-comment">-- constraints.</span><span>
</span><span id="line-787"></span><span>             </span><span class="hs-comment">-- See Note [Gathering and simplifying constraints for</span><span>
</span><span id="line-788"></span><span>             </span><span class="hs-comment">--           DeriveAnyClass]</span><span>
</span><span id="line-789"></span><span>
</span><span id="line-790"></span><span>       </span><span class="hs-comment">-- See [STEP DAC RESIDUAL]</span><span>
</span><span id="line-791"></span><span>       </span><span class="hs-comment">-- Ensure that min_theta is enough to solve /all/ the constraints in</span><span>
</span><span id="line-792"></span><span>       </span><span class="hs-comment">-- solved_wanteds, by solving the implication constraint</span><span>
</span><span id="line-793"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-794"></span><span>       </span><span class="hs-comment">--    forall tvs. min_theta =&gt; solved_wanteds</span><span>
</span><span id="line-795"></span><span>       </span><span class="hs-special">;</span><span> </span><span id="local-6989586621682057070"><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682057070"><span class="hs-identifier hs-var">min_theta_vars</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PredType -&gt; IOEnv (Env TcGblEnv TcLclEnv) TyVar)
-&gt; [PredType] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [TyVar]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="../../base-4.18.3.0/src/Data.Traversable.html#mapM/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">PredType -&gt; IOEnv (Env TcGblEnv TcLclEnv) TyVar
forall gbl lcl. PredType -&gt; TcRnIf gbl lcl TyVar
</span><a href="GHC.Tc.Utils.TcMType.html#newEvVar"><span class="hs-identifier hs-var">newEvVar</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682057066"><span class="hs-identifier hs-var">min_theta</span></a></span><span>
</span><span id="line-796"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621682057072"><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621682057072"><span class="hs-identifier hs-var">leftover_implic</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TcEvBinds
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-797"></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TcLevel
-&gt; SkolemInfoAnon
-&gt; [TyVar]
-&gt; [TyVar]
-&gt; WantedConstraints
-&gt; TcM (Bag Implication, TcEvBinds)
</span><a href="GHC.Tc.Utils.Unify.html#buildImplicationFor"><span class="hs-identifier hs-var">buildImplicationFor</span></a></span><span> </span><span class="annot"><span class="annottext">TcLevel
</span><a href="#local-6989586621682057048"><span class="hs-identifier hs-var">tc_lvl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SkolemInfo -&gt; SkolemInfoAnon
</span><a href="GHC.Tc.Types.Origin.html#getSkolemInfo"><span class="hs-identifier hs-var">getSkolemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SkolemInfo
</span><a href="#local-6989586621682057043"><span class="hs-identifier hs-var">skol_info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682057035"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-798"></span><span>                                  </span><span class="annot"><span class="annottext">[TyVar]
</span><a href="#local-6989586621682057070"><span class="hs-identifier hs-var">min_theta_vars</span></a></span><span> </span><span class="annot"><span class="annottext">WantedConstraints
</span><a href="#local-6989586621682057054"><span class="hs-identifier hs-var">solved_wanteds</span></a></span><span>
</span><span id="line-799"></span><span>       </span><span class="hs-comment">-- This call to simplifyTop is purely for error reporting</span><span>
</span><span id="line-800"></span><span>       </span><span class="hs-comment">-- See Note [Error reporting for deriving clauses]</span><span>
</span><span id="line-801"></span><span>       </span><span class="hs-comment">-- See also Note [Exotic derived instance contexts], which are caught</span><span>
</span><span id="line-802"></span><span>       </span><span class="hs-comment">-- in this line of code.</span><span>
</span><span id="line-803"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bag Implication -&gt; TcRn ()
</span><a href="GHC.Tc.Solver.html#simplifyTopImplic"><span class="hs-identifier hs-var">simplifyTopImplic</span></a></span><span> </span><span class="annot"><span class="annottext">Bag Implication
</span><a href="#local-6989586621682057072"><span class="hs-identifier hs-var">leftover_implic</span></a></span><span>
</span><span id="line-804"></span><span>
</span><span id="line-805"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SDoc -&gt; TcRn ()
</span><a href="GHC.Tc.Utils.Monad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;GHC.Tc.Deriv&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThetaSpec -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ThetaSpec
</span><a href="#local-6989586621682057041"><span class="hs-identifier hs-var">deriv_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
forall doc. IsDoc doc =&gt; doc -&gt; doc -&gt; doc
</span><a href="GHC.Utils.Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType] -&gt; SDoc
forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682057066"><span class="hs-identifier hs-var">min_theta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span>
</span><span id="line-807"></span><span>         </span><span class="hs-comment">-- Claim: the result instance declaration is guaranteed valid</span><span>
</span><span id="line-808"></span><span>         </span><span class="hs-comment">-- Hence no need to call:</span><span>
</span><span id="line-809"></span><span>         </span><span class="hs-comment">--     checkValidInstance tyvars theta clas inst_tys</span><span>
</span><span id="line-810"></span><span>         </span><span class="hs-comment">-- See Note [Exotic derived instance contexts]</span><span>
</span><span id="line-811"></span><span>
</span><span id="line-812"></span><span>       </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">[PredType] -&gt; IOEnv (Env TcGblEnv TcLclEnv) [PredType]
forall a. a -&gt; IOEnv (Env TcGblEnv TcLclEnv) a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.18.3.0/src/GHC.Base.html#return/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">[PredType]
</span><a href="#local-6989586621682057066"><span class="hs-identifier hs-var">min_theta</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-813"></span><span>
</span><span id="line-814"></span><span class="hs-comment">{-
Note [Overlap and deriving]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider some overlapping instances:
  instance Show a =&gt; Show [a] where ..
  instance Show [Char] where ...

Now a data type with deriving:
  data T a = MkT [a] deriving( Show )

We want to get the derived instance
  instance Show [a] =&gt; Show (T a) where...
and NOT
  instance Show a =&gt; Show (T a) where...
so that the (Show (T Char)) instance does the Right Thing

It's very like the situation when we're inferring the type
of a function
   f x = show [x]
and we want to infer
   f :: Show [a] =&gt; a -&gt; String

As a result, we use vanilla, non-overlappable skolems when inferring the
context for the derived instances. Hence, we instantiate the type variables
using tcInstSkolTyVars, not tcInstSuperSkolTyVars.

We do this skolemisation in GHC.Tc.Deriv.mkEqnHelp, a function which occurs
very early in the deriving pipeline, so that by the time GHC needs to infer the
instance context, all of the types in the computed DerivSpec have been
skolemised appropriately. After the instance context inference has completed,
GHC zonks the TcTyVars in the DerivSpec to ensure that types like
a[sk:1] do not appear in -ddump-deriv output.

All of this is only needed when inferring an instance context, i.e., the
InferContext case. For the SupplyContext case, we don't bother skolemising
at all.

Note [Gathering and simplifying constraints for DeriveAnyClass]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
DeriveAnyClass works quite differently from stock and newtype deriving in
the way it gathers and simplifies constraints to be used in a derived
instance's context. Stock and newtype deriving gather constraints by looking
at the data constructors of the data type for which we are deriving an
instance. But DeriveAnyClass doesn't need to know about a data type's
definition at all!

To see why, consider this example of DeriveAnyClass:

  class Foo a where
    bar :: forall b. Ix b =&gt; a -&gt; b -&gt; String
    default bar :: (Show a, Ix c) =&gt; a -&gt; c -&gt; String
    bar x y = show x ++ show (range (y,y))

    baz :: Eq a =&gt; a -&gt; a -&gt; Bool
    default baz :: (Ord a, Show a) =&gt; a -&gt; a -&gt; Bool
    baz x y = compare x y == EQ

Because 'bar' and 'baz' have default signatures, this generates a top-level
definition for these generic default methods

  $gdm_bar :: forall a. Foo a
           =&gt; forall c. (Show a, Ix c)
           =&gt; a -&gt; c -&gt; String
  $gdm_bar x y = show x ++ show (range (y,y))

(and similarly for baz).  Now consider a 'deriving' clause
  data Maybe s = ... deriving anyclass Foo

This derives an instance of the form:
  instance (CX) =&gt; Foo (Maybe s) where
    bar = $gdm_bar
    baz = $gdm_baz

Now it is GHC's job to fill in a suitable instance context (CX).  If
GHC were typechecking the binding
   bar = $gdm_bar
it would
   * skolemise the expected type of bar
   * instantiate the type of $gdm_bar with meta-type variables
   * build an implication constraint

[STEP DAC BUILD]
So that's what we do. Fortunately, there is already functionality within GHC
to that does all of the above&#8212;namely, tcSubTypeSigma. In the example above,
we want to use tcSubTypeSigma to check the following subtyping relation:

     forall c. (Show a, Ix c) =&gt; Maybe s -&gt; c -&gt; String -- actual type
  &lt;= forall b.         (Ix b) =&gt; Maybe s -&gt; b -&gt; String -- expected type

That is, we check that the type of $gdm_bar (the actual type) is more
polymorphic than the type of bar (the expected type). We use SubTypePredSpec,
a special form of PredSpec that is only used by DeriveAnyClass, to store
the actual and expected types.

(Aside: having a separate SubTypePredSpec is not strictly necessary, as we
could theoretically construct this implication constraint by hand and store it
in a SimplePredSpec. In fact, GHC used to do this. However, this is easier
said than done, and there were numerous subtle bugs that resulted from getting
this step wrong, such as #20719. Ultimately, we decided that special-casing a
PredSpec specifically for DeriveAnyClass was worth it.)

tcSubTypeSigma will ultimately spit out an implication constraint, which will
look something like this (call it C1):

   forall[2] b. Ix b =&gt; (Show (Maybe s), Ix cc,
                        Maybe s -&gt; b -&gt; String
                            ~ Maybe s -&gt; cc -&gt; String)

Here:
* The level of this forall constraint is forall[2], because we are later
  going to wrap it in a forall[1] in [STEP DAC RESIDUAL]

* The 'b' comes from the quantified type variable in the expected type
  of bar. The 'cc' is a unification variable that comes from instantiating the
  quantified type variable 'c' in $gdm_bar's type. The finer details of
  skolemisation and metavariable instantiation are handled behind the scenes
  by tcSubTypeSigma.

* It is important that `b` be distinct from `cc`. In this example, this is
  clearly the case, but it is not always so obvious when the type variables are
  hidden behind type synonyms. Suppose the example were written like this,
  for example:

    type Method a = forall b. Ix b =&gt; a -&gt; b -&gt; String
    class Foo a where
      bar :: Method a
      default bar :: Show a =&gt; Method a
      bar = ...

  Both method signatures quantify a `b` once the `Method` type synonym is
  expanded. To ensure that GHC doesn't confuse the two `b`s during
  typechecking, tcSubTypeSigma instantiates the `b` in the original signature
  with a fresh skolem and the `b` in the default signature with a fresh
  unification variable. Doing so prevents #20719 from happening.

* The (Ix b) constraint comes from the context of bar's type. The
  (Show (Maybe s)) and (Ix cc) constraints come from the context of $gdm_bar's
  type.

* The equality constraint (Maybe s -&gt; b -&gt; String) ~ (Maybe s -&gt; cc -&gt; String)
  comes from marrying up the instantiated type of $gdm_bar with the specified
  type of bar. Notice that the type variables from the instance, 's' in this
  case, are global to this constraint.

Note that it is vital that we instantiate the `c` in $gdm_bar's type with a new
unification variable for each iteration of simplifyDeriv. If we re-use the same
unification variable across multiple iterations, then bad things can happen,
such as #14933.

Similarly for 'baz', tcSubTypeSigma gives the constraint C2

   forall[2]. Eq (Maybe s) =&gt; (Ord a, Show a,
                              Maybe s -&gt; Maybe s -&gt; Bool
                                ~ Maybe s -&gt; Maybe s -&gt; Bool)

In this case baz has no local quantification, so the implication
constraint has no local skolems and there are no unification
variables.

[STEP DAC SOLVE]
We can combine these two implication constraints into a single
constraint (C1, C2), and simplify, unifying cc:=b, to get:

   forall[2] b. Ix b =&gt; Show a
   /\
   forall[2]. Eq (Maybe s) =&gt; (Ord a, Show a)

[STEP DAC HOIST]
Let's call that (C1', C2').  Now we need to hoist the unsolved
constraints out of the implications to become our candidate for
(CX). That is done by approximateWC, which will return:

  (Show a, Ord a, Show a)

Now we can use mkMinimalBySCs to remove superclasses and duplicates, giving

  (Show a, Ord a)

And that's what GHC uses for CX.

[STEP DAC RESIDUAL]
In this case we have solved all the leftover constraints, but what if
we don't?  Simple!  We just form the final residual constraint

   forall[1] s. CX =&gt; (C1',C2')

and simplify that. In simple cases it'll succeed easily, because CX
literally contains the constraints in C1', C2', but if there is anything
more complicated it will be reported in a civilised way.

Note [Error reporting for deriving clauses]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A surprisingly tricky aspect of deriving to get right is reporting sensible
error messages. In particular, if simplifyDeriv reaches a constraint that it
cannot solve, which might include:

1. Insoluble constraints
2. &quot;Exotic&quot; constraints (See Note [Exotic derived instance contexts])

Then we report an error immediately in simplifyDeriv.

Another possible choice is to punt and let another part of the typechecker
(e.g., simplifyInstanceContexts) catch the errors. But this tends to lead
to worse error messages, so we do it directly in simplifyDeriv.

simplifyDeriv checks for errors in a clever way. If the deriving machinery
infers the context (Foo a)--that is, if this instance is to be generated:

  instance Foo a =&gt; ...

Then we form an implication of the form:

  forall a. Foo a =&gt; &lt;residual_wanted_constraints&gt;

And pass it to the simplifier. If the context (Foo a) is enough to discharge
all the constraints in &lt;residual_wanted_constraints&gt;, then everything is
hunky-dory. But if &lt;residual_wanted_constraints&gt; contains, say, an insoluble
constraint, then (Foo a) won't be able to solve it, causing GHC to error.

Note [Exotic derived instance contexts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a 'derived' instance declaration, we *infer* the context.  It's a
bit unclear what rules we should apply for this; the Haskell report is
silent.  Obviously, constraints like (Eq a) are fine, but what about
        data T f a = MkT (f a) deriving( Eq )
where we'd get an Eq (f a) constraint.  That's probably fine too.

One could go further: consider
        data T a b c = MkT (Foo a b c) deriving( Eq )
        instance (C Int a, Eq b, Eq c) =&gt; Eq (Foo a b c)

Notice that this instance (just) satisfies the Paterson termination
conditions.  Then we *could* derive an instance decl like this:

        instance (C Int a, Eq b, Eq c) =&gt; Eq (T a b c)
even though there is no instance for (C Int a), because there just
*might* be an instance for, say, (C Int Bool) at a site where we
need the equality instance for T's.

However, this seems pretty exotic, and it's quite tricky to allow
this, and yet give sensible error messages in the (much more common)
case where we really want that instance decl for C.

So for now we simply require that the derived instance context
should have only type-variable constraints.

Here is another example:
        data Fix f = In (f (Fix f)) deriving( Eq )
Here, if we are prepared to allow -XUndecidableInstances we
could derive the instance
        instance Eq (f (Fix f)) =&gt; Eq (Fix f)
but this is so delicate that I don't think it should happen inside
'deriving'. If you want this, write it yourself!

NB: if you want to lift this condition, make sure you still meet the
termination conditions!  If not, the deriving mechanism generates
larger and larger constraints.  Example:
  data Succ a = S a
  data Seq a = Cons a (Seq (Succ a)) | Nil deriving Show

Note the lack of a Show instance for Succ.  First we'll generate
  instance (Show (Succ a), Show a) =&gt; Show (Seq a)
and then
  instance (Show (Succ (Succ a)), Show (Succ a), Show a) =&gt; Show (Seq a)
and so on.  Instead we want to complain of no instance for (Show (Succ a)).

The bottom line
~~~~~~~~~~~~~~~
Allow constraints which consist only of type variables, with no repeats.
-}</span><span>
</span><span id="line-1084"></span></pre></body></html>