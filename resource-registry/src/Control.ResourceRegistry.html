<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DerivingVia #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE QuantifiedConstraints #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-orphans            #-}</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-comment">-- | Note on terminology: when thread A forks thread B, we will say that thread A</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- is the \&quot;parent\&quot; and thread B is the \&quot;child\&quot;. No further relationship</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- between the two threads is implied by this terminology. In particular, note</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- that the child may outlive the parent. We will use \&quot;fork\&quot; and \&quot;spawn\&quot;</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- interchangeably.</span><span>
</span><span id="line-23"></span><span class="hs-comment">--</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- = Motivation</span><span>
</span><span id="line-25"></span><span class="hs-comment">--</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- Whenever we allocate resources, we must keep track of them so that we can</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- deallocate them when they are no longer required. The most important tool we</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- have to achieve this is 'bracket':</span><span>
</span><span id="line-29"></span><span class="hs-comment">--</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- &gt; bracket allocateResource releaseResource $ \r -&gt;</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- &gt;   .. use r ..</span><span>
</span><span id="line-32"></span><span class="hs-comment">--</span><span>
</span><span id="line-33"></span><span class="hs-comment">-- Often 'bracket' comes in the guise of a with-style combinator</span><span>
</span><span id="line-34"></span><span class="hs-comment">--</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- &gt; withResource $ \r -&gt;</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- &gt;   .. use r ..</span><span>
</span><span id="line-37"></span><span class="hs-comment">--</span><span>
</span><span id="line-38"></span><span class="hs-comment">-- Where this pattern is applicable, it should be used and there is no need to</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- use the 'ResourceRegistry'. However, 'bracket' introduces strict lexical</span><span>
</span><span id="line-40"></span><span class="hs-comment">-- scoping: the resource is available inside the scope of the bracket, and</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- will be deallocated once we leave that scope. That pattern is sometimes</span><span>
</span><span id="line-42"></span><span class="hs-comment">-- hard to use.</span><span>
</span><span id="line-43"></span><span class="hs-comment">--</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- For example, suppose we have this interface to an SQL server</span><span>
</span><span id="line-45"></span><span class="hs-comment">--</span><span>
</span><span id="line-46"></span><span class="hs-comment">-- &gt; query :: Query -&gt; IO QueryHandle</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- &gt; close :: QueryHandle -&gt; IO ()</span><span>
</span><span id="line-48"></span><span class="hs-comment">-- &gt; next  :: QueryHandle -&gt; IO Row</span><span>
</span><span id="line-49"></span><span class="hs-comment">--</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- and suppose furthermore that we are writing a simple webserver that allows a</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- client to send multiple SQL queries, get rows from any open query, and close</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- queries when no longer required:</span><span>
</span><span id="line-53"></span><span class="hs-comment">--</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- &gt; server :: IO ()</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- &gt; server = go Map.empty</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- &gt;   where</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- &gt;     go :: Map QueryId QueryHandle -&gt; IO ()</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- &gt;     go handles = getRequest &gt;&gt;= \case</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- &gt;         New q -&gt; do</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- &gt;           h   &lt;- query q                        -- allocate</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- &gt;           qId &lt;- generateQueryId</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- &gt;           sendResponse qId</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- &gt;           go $ Map.insert qId h handles</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- &gt;         Close qId -&gt; do</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- &gt;           close (handles ! qId)                 -- release</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- &gt;           go $ Map.delete qId handles</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- &gt;         Next qId -&gt; do</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- &gt;           sendResponse =&lt;&lt; next (handles ! qId)</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- &gt;           go handles</span><span>
</span><span id="line-70"></span><span class="hs-comment">--</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- The server opens and closes query handles in response to client requests.</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- Restructuring this code to use 'bracket' would be awkward, but as it stands</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- this code does not ensure that resources get deallocated; for example, if</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- the server thread is killed ('killThread'), resources will be leaked.</span><span>
</span><span id="line-75"></span><span class="hs-comment">--</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- Another, perhaps simpler, example is spawning threads. Threads too should</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- be considered to be resources that we should keep track of and deallocate</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- when they are no longer required, primarily because when we deallocate</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- (terminate) those threads they too will have a chance to deallocate /their/</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- resources. As for other resources, we have a with-style combinator for this</span><span>
</span><span id="line-81"></span><span class="hs-comment">--</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- &gt; withAsync $ \thread -&gt; ..</span><span>
</span><span id="line-83"></span><span class="hs-comment">--</span><span>
</span><span id="line-84"></span><span class="hs-comment">-- Lexical scoping of threads is often inconvenient, however, more so than for</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- regular resources. The temptation is therefore to simply fork a thread and</span><span>
</span><span id="line-86"></span><span class="hs-comment">-- forget about it, but if we are serious about resource deallocation this is</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- not an acceptable solution.</span><span>
</span><span id="line-88"></span><span class="hs-comment">--</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- = The resource registry</span><span>
</span><span id="line-90"></span><span class="hs-comment">--</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- The resource registry is essentially a piece of state tracking which</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- resources have been allocated. The registry itself is allocated with a</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- with-style combinator 'withRegistry', and when we leave that scope any</span><span>
</span><span id="line-94"></span><span class="hs-comment">-- resources not yet deallocated will be released at that point. Typically</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- the registry is only used as a fall-back, ensuring that resources will</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- deallocated even in the presence of exceptions. For example, here's how</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- we might rewrite the above server example using a registry:</span><span>
</span><span id="line-98"></span><span class="hs-comment">--</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- &gt; server' :: IO ()</span><span>
</span><span id="line-100"></span><span class="hs-comment">-- &gt; server' =</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- &gt;     withRegistry $ \registry -&gt; go registry Map.empty</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- &gt;   where</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- &gt;     go :: ResourceRegistry IO</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- &gt;        -&gt; Map QueryId (ResourceKey, QueryHandle)</span><span>
</span><span id="line-105"></span><span class="hs-comment">-- &gt;        -&gt; IO ()</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- &gt;     go registry handles = getRequest &gt;&gt;= \case</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- &gt;         New q -&gt; do</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- &gt;           (key, h) &lt;- allocate registry (query q) close  -- allocate</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- &gt;           qId      &lt;- generateQueryId</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- &gt;           sendResponse qId</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- &gt;           go registry $ Map.insert qId (key, h) handles</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- &gt;         Close qId -&gt; do</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- &gt;           release registry (fst (handles ! qId))         -- release</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- &gt;           go registry $ Map.delete qId handles</span><span>
</span><span id="line-115"></span><span class="hs-comment">-- &gt;         Next qId -&gt; do</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- &gt;           sendResponse =&lt;&lt; next (snd (handles ! qId))</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- &gt;           go registry handles</span><span>
</span><span id="line-118"></span><span class="hs-comment">--</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- We allocate the query with the help of the registry, providing the registry</span><span>
</span><span id="line-120"></span><span class="hs-comment">-- with the means to deallocate the query should that be required. We can /and</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- should/ still manually release resources also: in this particular example,</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- the (lexical) scope of the registry is the entire server thread, so delaying</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- releasing queries until we exit that scope will probably mean we hold on to</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- resources for too long. The registry is only there as a fall-back.</span><span>
</span><span id="line-125"></span><span class="hs-comment">--</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- = Spawning threads</span><span>
</span><span id="line-127"></span><span class="hs-comment">--</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- We already observed in the introduction that insisting on lexical scoping</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- for threads is often inconvenient, and that simply using</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- 'Control.Monad.Class.MonadFork.forkIO' is no solution as it means we might</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- leak resources. There is however another problem with</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- 'Control.Monad.Class.MonadFork.forkIO'. Consider this snippet:</span><span>
</span><span id="line-133"></span><span class="hs-comment">--</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- &gt; withRegistry $ \registry -&gt;</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- &gt;   r &lt;- allocate registry allocateResource releaseResource</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- &gt;   forkIO $ .. use r ..</span><span>
</span><span id="line-137"></span><span class="hs-comment">--</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- It is easy to see that this code is problematic: we allocate a resource @r@,</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- then spawn a thread that uses @r@, and finally leave the scope of</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- 'withRegistry', thereby deallocating @r@ -- leaving the thread to run with</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- a now deallocated resource.</span><span>
</span><span id="line-142"></span><span class="hs-comment">--</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- It is /only/ safe for threads to use a given registry, and/or its registered</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- resources, if the lifetime of those threads is tied to the lifetime of the</span><span>
</span><span id="line-145"></span><span class="hs-comment">-- registry. There would be no problem with the example above if the thread</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- would be terminated when we exit the scope of 'withRegistry'.</span><span>
</span><span id="line-147"></span><span class="hs-comment">--</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- The 'forkThread' combinator provided by the registry therefore does two</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- things: it allocates the thread as a resource in the registry, so that it can</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- kill the thread when releasing all resources in the registry. It also records</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- the thread ID in a set of known threads. Whenever the registry is accessed</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- from a thread /not/ in this set, the registry throws a runtime exception,</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- since such a thread might outlive the registry and hence its contents. The</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- intention is that this guards against dangerous patterns like the one above.</span><span>
</span><span id="line-155"></span><span class="hs-comment">--</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- = Linking</span><span>
</span><span id="line-157"></span><span class="hs-comment">--</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- When thread A spawns thread B using 'withAsync', the lifetime of B is tied</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- to the lifetime of A:</span><span>
</span><span id="line-160"></span><span class="hs-comment">--</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- &gt; withAsync .. $ \threadB -&gt; ..</span><span>
</span><span id="line-162"></span><span class="hs-comment">--</span><span>
</span><span id="line-163"></span><span class="hs-comment">-- After all, when A exits the scope of the 'withAsync', thread B will be</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- killed. The reverse is however not true: thread B can terminate before</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- thread A. It is often useful for thread A to be able to declare a dependency</span><span>
</span><span id="line-166"></span><span class="hs-comment">-- on thread B: if B somehow fails, that is, terminates with an exception, we</span><span>
</span><span id="line-167"></span><span class="hs-comment">-- want that exception to be rethrown in thread A as well. A can achieve this</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- by /linking/ to B:</span><span>
</span><span id="line-169"></span><span class="hs-comment">--</span><span>
</span><span id="line-170"></span><span class="hs-comment">-- &gt; withAsync .. $ \threadB -&gt; do</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- &gt;   link threadB</span><span>
</span><span id="line-172"></span><span class="hs-comment">-- &gt;   ..</span><span>
</span><span id="line-173"></span><span class="hs-comment">--</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- Linking a parent to a child is however of limited value if the lifetime of</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- the child is not limited by the lifetime of the parent. For example, if A</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- does</span><span>
</span><span id="line-177"></span><span class="hs-comment">--</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- &gt; threadB &lt;- async $ ..</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- &gt; link threadB</span><span>
</span><span id="line-180"></span><span class="hs-comment">--</span><span>
</span><span id="line-181"></span><span class="hs-comment">-- and A terminates before B does, any exception thrown by B might be send to a</span><span>
</span><span id="line-182"></span><span class="hs-comment">-- thread that no longer exists. This is particularly problematic when we start</span><span>
</span><span id="line-183"></span><span class="hs-comment">-- chaining threads: if A spawns-and-links-to B which spawns-and-links-to C, and</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- C throws an exception, perhaps the intention is that this gets rethrown to B,</span><span>
</span><span id="line-185"></span><span class="hs-comment">-- and then rethrown to A, terminating all three threads; however, if B has</span><span>
</span><span id="line-186"></span><span class="hs-comment">-- terminated before the exception is thrown, C will throw the exception to a</span><span>
</span><span id="line-187"></span><span class="hs-comment">-- non-existent thread and A is never notified.</span><span>
</span><span id="line-188"></span><span class="hs-comment">--</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- For this reason, the registry's 'linkToRegistry' combinator does not link the</span><span>
</span><span id="line-190"></span><span class="hs-comment">-- specified thread to the thread calling 'linkToRegistry', but rather to the</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- thread that created the registry. After all, the lifetime of threads spawned</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- with 'forkThread' can certainly exceed the lifetime of their parent threads,</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- but the lifetime of /all/ threads spawned using the registry will be limited</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- by the scope of that registry, and hence the lifetime of the thread that</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- created it. So, when we call 'linkToRegistry', the exception will be thrown</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- the thread that created the registry, which (if not caught) will cause that</span><span>
</span><span id="line-197"></span><span class="hs-comment">-- that to exit the scope of 'withRegistry', thereby terminating all threads in</span><span>
</span><span id="line-198"></span><span class="hs-comment">-- that registry.</span><span>
</span><span id="line-199"></span><span class="hs-comment">--</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- = Combining the registry and with-style allocation</span><span>
</span><span id="line-201"></span><span class="hs-comment">--</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- It is perfectly possible (indeed, advisable) to use 'bracket' and</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- bracket-like allocation functions alongside the registry, but note that the</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- usual caveats with 'bracket' and forking threads still applies. In</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- particular, spawning threads inside the 'bracket' that make use of the</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- bracketed resource is problematic; this is of course true whether or not a</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- registry is used.</span><span>
</span><span id="line-208"></span><span class="hs-comment">--</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- In principle this also includes 'withAsync'; however, since 'withAsync'</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- results in a thread that is not known to the registry, such a thread will not</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- be able to use the registry (the registry would throw an unknown thread</span><span>
</span><span id="line-212"></span><span class="hs-comment">-- exception, as described above). For this purpose we provide 'withThread';</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- 'withThread' (as opposed to 'forkThread') should be used when a parent thread</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- wants to handle exceptions in the child thread; see 'withThread' for</span><span>
</span><span id="line-215"></span><span class="hs-comment">-- detailed discussion.</span><span>
</span><span id="line-216"></span><span class="hs-comment">--</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- It is /also/ fine to includes nested calls to 'withRegistry'. Since the</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- lifetime of such a registry (and all resources within) is tied to the thread</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- calling 'withRegistry', which itself is tied to the &quot;parent registry&quot; in</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- which it was created, this creates a hierarchy of registries. It is of course</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- essential for compositionality that we should be able to create local</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- registries, but even if we do have easy access to a parent regisry, creating</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- a local one where possibly is useful as it limits the scope of the resources</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- created within, and hence their maximum lifetimes.</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Control.ResourceRegistry</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><span class="hs-comment">-- * The resource registry proper</span></span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier">Context</span></a></span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier">ResourceId</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier">ResourceRegistry</span></a></span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Exceptions</span></span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryClosedException"><span class="hs-identifier">RegistryClosedException</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistryThreadException"><span class="hs-identifier">ResourceRegistryThreadException</span></a></span><span>
</span><span id="line-234"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Creating and releasing the registry itself</span></span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#bracketWithPrivateRegistry"><span class="hs-identifier">bracketWithPrivateRegistry</span></a></span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#registryThread"><span class="hs-identifier">registryThread</span></a></span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#withRegistry"><span class="hs-identifier">withRegistry</span></a></span><span>
</span><span id="line-238"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Allocating and releasing regular resources</span></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier">ResourceKey</span></a></span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#allocate"><span class="hs-identifier">allocate</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#allocateEither"><span class="hs-identifier">allocateEither</span></a></span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#release"><span class="hs-identifier">release</span></a></span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#releaseAll"><span class="hs-identifier">releaseAll</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#unsafeRelease"><span class="hs-identifier">unsafeRelease</span></a></span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#unsafeReleaseAll"><span class="hs-identifier">unsafeReleaseAll</span></a></span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Threads</span></span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier">Thread</span></a></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#cancelThread"><span class="hs-identifier">cancelThread</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#forkLinkedThread"><span class="hs-identifier">forkLinkedThread</span></a></span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#forkThread"><span class="hs-identifier">forkThread</span></a></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#linkToRegistry"><span class="hs-identifier">linkToRegistry</span></a></span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#threadId"><span class="hs-identifier">threadId</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#waitAnyThread"><span class="hs-identifier">waitAnyThread</span></a></span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#waitThread"><span class="hs-identifier">waitThread</span></a></span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#withThread"><span class="hs-identifier">withThread</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Temporary registry</span></span><span>
</span><span id="line-257"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#TempRegistryException"><span class="hs-identifier">TempRegistryException</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier">WithTempRegistry</span></a></span><span>
</span><span id="line-259"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#allocateTemp"><span class="hs-identifier">allocateTemp</span></a></span><span>
</span><span id="line-260"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#modifyWithTempRegistry"><span class="hs-identifier">modifyWithTempRegistry</span></a></span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#runInnerWithTempRegistry"><span class="hs-identifier">runInnerWithTempRegistry</span></a></span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#runWithTempRegistry"><span class="hs-identifier">runWithTempRegistry</span></a></span><span>
</span><span id="line-263"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Unsafe combinators primarily for testing</span></span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#closeRegistry"><span class="hs-identifier">closeRegistry</span></a></span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#countResources"><span class="hs-identifier">countResources</span></a></span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#unsafeNewRegistry"><span class="hs-identifier">unsafeNewRegistry</span></a></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Applicative.html"><span class="hs-identifier">Control.Applicative</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%7C%3E"><span class="hs-operator">(&lt;|&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadSTM.Strict</span></span><span>
</span><span id="line-271"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.Exception.html#asyncExceptionFromException"><span class="hs-identifier">asyncExceptionFromException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-273"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadAsync</span></span><span>
</span><span id="line-274"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadFork</span></span><span>
</span><span id="line-275"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></span><span>
</span><span id="line-276"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.Reader.html"><span class="hs-identifier">Control.Monad.Reader</span></a></span><span>
</span><span id="line-277"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Strict.html"><span class="hs-identifier">Control.Monad.State.Strict</span></a></span><span>
</span><span id="line-278"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Bifunctor.html"><span class="hs-identifier">Data.Bifunctor</span></a></span><span>
</span><span id="line-279"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bimap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Bimap</span></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bimap</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Bimap</span></span><span>
</span><span id="line-281"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html"><span class="hs-identifier">Data.Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#partitionEithers"><span class="hs-identifier">partitionEithers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.Strict.html"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.Strict.html"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-284"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#catMaybes"><span class="hs-identifier">catMaybes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#listToMaybe"><span class="hs-identifier">listToMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier">Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-287"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Void.html"><span class="hs-identifier">Data.Void</span></a></span><span>
</span><span id="line-288"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier">Word64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Generic"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#CallStack"><span class="hs-identifier">CallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GHC</span></span><span>
</span><span id="line-292"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">NoThunks.Class</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Context</span></span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>
</span><span id="line-294"></span><span class="annot"><span class="hs-comment">-- | Tracks resources during their lifetime.</span></span><span>
</span><span id="line-295"></span><span class="hs-keyword">data</span><span> </span><span id="ResourceRegistry"><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-var">ResourceRegistry</span></a></span></span><span> </span><span id="local-6989586621679081369"><span class="annot"><a href="#local-6989586621679081369"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ResourceRegistry"><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-var">ResourceRegistry</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-296"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Context in which the registry was created</span></span><span>
</span><span id="line-297"></span><span>      </span><span id="registryContext"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ResourceRegistry m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#registryContext"><span class="hs-identifier hs-var hs-var">registryContext</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081369"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Registry state</span></span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="registryState"><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ResourceRegistry m -&gt; StrictTVar m (RegistryState m)
</span><a href="Control.ResourceRegistry.html#registryState"><span class="hs-identifier hs-var hs-var">registryState</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679081369"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081369"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082114"><span id="local-6989586621679082116"><span class="annot"><span class="annottext">(forall x. ResourceRegistry m -&gt; Rep (ResourceRegistry m) x)
-&gt; (forall x. Rep (ResourceRegistry m) x -&gt; ResourceRegistry m)
-&gt; Generic (ResourceRegistry m)
forall x. Rep (ResourceRegistry m) x -&gt; ResourceRegistry m
forall x. ResourceRegistry m -&gt; Rep (ResourceRegistry m) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (m :: * -&gt; *) x.
Rep (ResourceRegistry m) x -&gt; ResourceRegistry m
forall (m :: * -&gt; *) x.
ResourceRegistry m -&gt; Rep (ResourceRegistry m) x
$cfrom :: forall (m :: * -&gt; *) x.
ResourceRegistry m -&gt; Rep (ResourceRegistry m) x
from :: forall x. ResourceRegistry m -&gt; Rep (ResourceRegistry m) x
$cto :: forall (m :: * -&gt; *) x.
Rep (ResourceRegistry m) x -&gt; ResourceRegistry m
to :: forall x. Rep (ResourceRegistry m) x -&gt; ResourceRegistry m
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span id="local-6989586621679081423"><span id="local-6989586621679082121"><span id="local-6989586621679082126"><span id="local-6989586621679082133"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679081386"><span class="annot"><a href="#local-6989586621679081386"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679081386"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679081423"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081386"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081423"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Internal: registry state
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span class="hs-comment">-- | The age of a resource</span><span>
</span><span id="line-312"></span><span class="hs-comment">--</span><span>
</span><span id="line-313"></span><span class="hs-comment">-- Age here is represented by an meaningless number. The one and only property</span><span>
</span><span id="line-314"></span><span class="hs-comment">-- that matters is that the age of resource A that was successfully allocated</span><span>
</span><span id="line-315"></span><span class="hs-comment">-- before resource B was (in the same registry) will be greater than the age of</span><span>
</span><span id="line-316"></span><span class="hs-comment">-- resource B.</span><span>
</span><span id="line-317"></span><span class="hs-comment">--</span><span>
</span><span id="line-318"></span><span class="hs-comment">-- For the current implementation, that property will be true unless the</span><span>
</span><span id="line-319"></span><span class="hs-comment">-- registry lives long enough to have contained 2^64 separately allocated</span><span>
</span><span id="line-320"></span><span class="hs-comment">-- resources.</span><span>
</span><span id="line-321"></span><span class="hs-comment">--</span><span>
</span><span id="line-322"></span><span class="hs-comment">-- This data is not exposed by the 'ResourceRegistry' interface.</span><span>
</span><span id="line-323"></span><span class="hs-keyword">newtype</span><span> </span><span id="Age"><span class="annot"><a href="Control.ResourceRegistry.html#Age"><span class="hs-identifier hs-var">Age</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Age"><span class="annot"><a href="Control.ResourceRegistry.html#Age"><span class="hs-identifier hs-var">Age</span></a></span></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span>   </span><span class="hs-special">(</span><span id="local-6989586621679082173"><span id="local-6989586621679082178"><span id="local-6989586621679082182"><span class="annot"><span class="annottext">Int -&gt; Age -&gt; ShowS
[Age] -&gt; ShowS
Age -&gt; String
(Int -&gt; Age -&gt; ShowS)
-&gt; (Age -&gt; String) -&gt; ([Age] -&gt; ShowS) -&gt; Show Age
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; Age -&gt; ShowS
showsPrec :: Int -&gt; Age -&gt; ShowS
$cshow :: Age -&gt; String
show :: Age -&gt; String
$cshowList :: [Age] -&gt; ShowS
showList :: [Age] -&gt; ShowS
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082186"><span id="local-6989586621679082191"><span class="annot"><span class="annottext">Age -&gt; Age -&gt; Bool
(Age -&gt; Age -&gt; Bool) -&gt; (Age -&gt; Age -&gt; Bool) -&gt; Eq Age
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: Age -&gt; Age -&gt; Bool
== :: Age -&gt; Age -&gt; Bool
$c/= :: Age -&gt; Age -&gt; Bool
/= :: Age -&gt; Age -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082199"><span id="local-6989586621679082204"><span id="local-6989586621679082208"><span id="local-6989586621679082212"><span id="local-6989586621679082216"><span id="local-6989586621679082220"><span id="local-6989586621679082224"><span class="annot"><span class="annottext">Eq Age
Eq Age =&gt;
(Age -&gt; Age -&gt; Ordering)
-&gt; (Age -&gt; Age -&gt; Bool)
-&gt; (Age -&gt; Age -&gt; Bool)
-&gt; (Age -&gt; Age -&gt; Bool)
-&gt; (Age -&gt; Age -&gt; Bool)
-&gt; (Age -&gt; Age -&gt; Age)
-&gt; (Age -&gt; Age -&gt; Age)
-&gt; Ord Age
Age -&gt; Age -&gt; Bool
Age -&gt; Age -&gt; Ordering
Age -&gt; Age -&gt; Age
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: Age -&gt; Age -&gt; Ordering
compare :: Age -&gt; Age -&gt; Ordering
$c&lt; :: Age -&gt; Age -&gt; Bool
&lt; :: Age -&gt; Age -&gt; Bool
$c&lt;= :: Age -&gt; Age -&gt; Bool
&lt;= :: Age -&gt; Age -&gt; Bool
$c&gt; :: Age -&gt; Age -&gt; Bool
&gt; :: Age -&gt; Age -&gt; Bool
$c&gt;= :: Age -&gt; Age -&gt; Bool
&gt;= :: Age -&gt; Age -&gt; Bool
$cmax :: Age -&gt; Age -&gt; Age
max :: Age -&gt; Age -&gt; Age
$cmin :: Age -&gt; Age -&gt; Age
min :: Age -&gt; Age -&gt; Age
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679082230"><span id="local-6989586621679082236"><span id="local-6989586621679082241"><span class="annot"><span class="annottext">Context -&gt; Age -&gt; IO (Maybe ThunkInfo)
Proxy Age -&gt; String
(Context -&gt; Age -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; Age -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy Age -&gt; String)
-&gt; NoThunks Age
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
$cnoThunks :: Context -&gt; Age -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; Age -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; Age -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; Age -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: Proxy Age -&gt; String
showTypeOf :: Proxy Age -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">InspectHeapNamed</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Age&quot;</span></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Age"><span class="hs-identifier hs-type">Age</span></a></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span class="annot"><span class="hs-comment">-- | The age of the first resource successfully allocated in a fresh registry</span></span><span>
</span><span id="line-329"></span><span class="annot"><a href="Control.ResourceRegistry.html#ageOfFirstResource"><span class="hs-identifier hs-type">ageOfFirstResource</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Age"><span class="hs-identifier hs-type">Age</span></a></span><span>
</span><span id="line-330"></span><span id="ageOfFirstResource"><span class="annot"><span class="annottext">ageOfFirstResource :: Age
</span><a href="Control.ResourceRegistry.html#ageOfFirstResource"><span class="hs-identifier hs-var hs-var">ageOfFirstResource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Age
</span><a href="Control.ResourceRegistry.html#Age"><span class="hs-identifier hs-var">Age</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
forall a. Bounded a =&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Enum.html#maxBound"><span class="hs-identifier hs-var">maxBound</span></a></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span class="hs-comment">-- | Map the age of the latest resource to be successfully allocated to the age</span><span>
</span><span id="line-333"></span><span class="hs-comment">-- of the next resource to be successfully allocated in the same registry</span><span>
</span><span id="line-334"></span><span class="annot"><a href="Control.ResourceRegistry.html#nextYoungerAge"><span class="hs-identifier hs-type">nextYoungerAge</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Age"><span class="hs-identifier hs-type">Age</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Age"><span class="hs-identifier hs-type">Age</span></a></span><span>
</span><span id="line-335"></span><span id="nextYoungerAge"><span class="annot"><span class="annottext">nextYoungerAge :: Age -&gt; Age
</span><a href="Control.ResourceRegistry.html#nextYoungerAge"><span class="hs-identifier hs-var hs-var">nextYoungerAge</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Age"><span class="hs-identifier hs-type">Age</span></a></span><span> </span><span id="local-6989586621679082249"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679082249"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Age
</span><a href="Control.ResourceRegistry.html#Age"><span class="hs-identifier hs-var">Age</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679082249"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span class="annot"><span class="hs-comment">-- | Internal registry state</span></span><span>
</span><span id="line-338"></span><span class="hs-keyword">data</span><span> </span><span id="RegistryState"><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-var">RegistryState</span></a></span></span><span> </span><span id="local-6989586621679081437"><span class="annot"><a href="#local-6989586621679081437"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RegistryState"><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-var">RegistryState</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-339"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Forked threads</span></span><span>
</span><span id="line-340"></span><span>      </span><span id="registryThreads"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). RegistryState m -&gt; KnownThreads m
</span><a href="Control.ResourceRegistry.html#registryThreads"><span class="hs-identifier hs-var hs-var">registryThreads</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#KnownThreads"><span class="hs-identifier hs-type">KnownThreads</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081437"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>
</span><span id="line-342"></span><span>      </span><span class="hs-comment">-- | Currently allocated resources</span><span>
</span><span id="line-343"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-344"></span><span>      </span><span class="hs-comment">-- INVARIANT: We record exactly the ages of currently allocated resources,</span><span>
</span><span id="line-345"></span><span>      </span><span class="hs-comment">-- @'Bimap.keys' . 'registryAges' = 'Map.keys' . 'registryResources'@.</span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="registryResources"><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
RegistryState m -&gt; Map ResourceId (Resource m)
</span><a href="Control.ResourceRegistry.html#registryResources"><span class="hs-identifier hs-var hs-var">registryResources</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Resource"><span class="hs-identifier hs-type">Resource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081437"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Next available resource key</span></span><span>
</span><span id="line-349"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="registryNextKey"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). RegistryState m -&gt; ResourceId
</span><a href="Control.ResourceRegistry.html#registryNextKey"><span class="hs-identifier hs-var hs-var">registryNextKey</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span>      </span><span class="hs-comment">-- | The age of each currently allocated resource</span><span>
</span><span id="line-352"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-353"></span><span>      </span><span class="hs-comment">-- We use a 'Bimap' so we can maintain the keys in sorted order by age,</span><span>
</span><span id="line-354"></span><span>      </span><span class="hs-comment">-- which is necessary when closing the registry.</span><span>
</span><span id="line-355"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="registryAges"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). RegistryState m -&gt; Bimap ResourceId Age
</span><a href="Control.ResourceRegistry.html#registryAges"><span class="hs-identifier hs-var hs-var">registryAges</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bimap</span></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Age"><span class="hs-identifier hs-type">Age</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span>      </span><span class="annot"><span class="hs-comment">-- | The age of the next resource</span></span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="registryNextAge"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). RegistryState m -&gt; Age
</span><a href="Control.ResourceRegistry.html#registryNextAge"><span class="hs-identifier hs-var hs-var">registryNextAge</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Control.ResourceRegistry.html#Age"><span class="hs-identifier hs-type">Age</span></a></span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span>      </span><span class="hs-comment">-- | Does the registry still accept new allocations?</span><span>
</span><span id="line-361"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-362"></span><span>      </span><span class="hs-comment">-- See 'RegistryClosedException' for discussion.</span><span>
</span><span id="line-363"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="registryStatus"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). RegistryState m -&gt; RegistryStatus
</span><a href="Control.ResourceRegistry.html#registryStatus"><span class="hs-identifier hs-var hs-var">registryStatus</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryStatus"><span class="hs-identifier hs-type">RegistryStatus</span></a></span><span>
</span><span id="line-364"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-365"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082261"><span id="local-6989586621679082263"><span class="annot"><span class="annottext">(forall x. RegistryState m -&gt; Rep (RegistryState m) x)
-&gt; (forall x. Rep (RegistryState m) x -&gt; RegistryState m)
-&gt; Generic (RegistryState m)
forall x. Rep (RegistryState m) x -&gt; RegistryState m
forall x. RegistryState m -&gt; Rep (RegistryState m) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (m :: * -&gt; *) x. Rep (RegistryState m) x -&gt; RegistryState m
forall (m :: * -&gt; *) x. RegistryState m -&gt; Rep (RegistryState m) x
$cfrom :: forall (m :: * -&gt; *) x. RegistryState m -&gt; Rep (RegistryState m) x
from :: forall x. RegistryState m -&gt; Rep (RegistryState m) x
$cto :: forall (m :: * -&gt; *) x. Rep (RegistryState m) x -&gt; RegistryState m
to :: forall x. Rep (RegistryState m) x -&gt; RegistryState m
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082266"><span id="local-6989586621679082269"><span id="local-6989586621679082275"><span class="annot"><span class="annottext">Context -&gt; RegistryState m -&gt; IO (Maybe ThunkInfo)
Proxy (RegistryState m) -&gt; String
(Context -&gt; RegistryState m -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; RegistryState m -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (RegistryState m) -&gt; String)
-&gt; NoThunks (RegistryState m)
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
forall (m :: * -&gt; *).
Context -&gt; RegistryState m -&gt; IO (Maybe ThunkInfo)
forall (m :: * -&gt; *). Proxy (RegistryState m) -&gt; String
$cnoThunks :: forall (m :: * -&gt; *).
Context -&gt; RegistryState m -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; RegistryState m -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall (m :: * -&gt; *).
Context -&gt; RegistryState m -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; RegistryState m -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: forall (m :: * -&gt; *). Proxy (RegistryState m) -&gt; String
showTypeOf :: Proxy (RegistryState m) -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span class="annot"><span class="hs-comment">-- | The currently allocated keys in youngest-to-oldest order</span></span><span>
</span><span id="line-368"></span><span id="local-6989586621679081459"><span class="annot"><a href="Control.ResourceRegistry.html#getYoungestToOldest"><span class="hs-identifier hs-type">getYoungestToOldest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081459"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-369"></span><span id="getYoungestToOldest"><span class="annot"><span class="annottext">getYoungestToOldest :: forall (m :: * -&gt; *). RegistryState m -&gt; [ResourceId]
</span><a href="Control.ResourceRegistry.html#getYoungestToOldest"><span class="hs-identifier hs-var hs-var">getYoungestToOldest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Age, ResourceId) -&gt; ResourceId)
-&gt; [(Age, ResourceId)] -&gt; [ResourceId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Age, ResourceId) -&gt; ResourceId
forall a b. (a, b) -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">([(Age, ResourceId)] -&gt; [ResourceId])
-&gt; (RegistryState m -&gt; [(Age, ResourceId)])
-&gt; RegistryState m
-&gt; [ResourceId]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Bimap ResourceId Age -&gt; [(Age, ResourceId)]
forall a b. Bimap a b -&gt; [(b, a)]
</span><span class="hs-identifier hs-var">Bimap.toAscListR</span></span><span> </span><span class="annot"><span class="annottext">(Bimap ResourceId Age -&gt; [(Age, ResourceId)])
-&gt; (RegistryState m -&gt; Bimap ResourceId Age)
-&gt; RegistryState m
-&gt; [(Age, ResourceId)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">RegistryState m -&gt; Bimap ResourceId Age
forall (m :: * -&gt; *). RegistryState m -&gt; Bimap ResourceId Age
</span><a href="Control.ResourceRegistry.html#registryAges"><span class="hs-identifier hs-var">registryAges</span></a></span><span>
</span><span id="line-370"></span><span>
</span><span id="line-371"></span><span class="hs-comment">-- | Threads known to the registry</span><span>
</span><span id="line-372"></span><span class="hs-comment">--</span><span>
</span><span id="line-373"></span><span class="hs-comment">-- This is the set of threads spawned using 'forkThread'. The lifetimes of all</span><span>
</span><span id="line-374"></span><span class="hs-comment">-- of these threads are limited by the lifetime of the registry.</span><span>
</span><span id="line-375"></span><span class="hs-comment">--</span><span>
</span><span id="line-376"></span><span class="hs-comment">-- Does not include the thread ID of the thread that created the registry. After</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- all, this thread may well outlive the registry (though the registry cannot</span><span>
</span><span id="line-378"></span><span class="hs-comment">-- outlive it).</span><span>
</span><span id="line-379"></span><span class="hs-comment">--</span><span>
</span><span id="line-380"></span><span class="hs-comment">-- Invariant (informal): the set of registered threads is a subset of the</span><span>
</span><span id="line-381"></span><span class="hs-comment">-- registered resources ('registryResources'). (This invariant is temporarily</span><span>
</span><span id="line-382"></span><span class="hs-comment">-- broken when we start a new thread in 'forkThread' but will be re-established</span><span>
</span><span id="line-383"></span><span class="hs-comment">-- before that thread starts execution proper.)</span><span>
</span><span id="line-384"></span><span class="hs-keyword">newtype</span><span> </span><span id="KnownThreads"><span class="annot"><a href="Control.ResourceRegistry.html#KnownThreads"><span class="hs-identifier hs-var">KnownThreads</span></a></span></span><span> </span><span id="local-6989586621679081507"><span class="annot"><a href="#local-6989586621679081507"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="KnownThreads"><span class="annot"><a href="Control.ResourceRegistry.html#KnownThreads"><span class="hs-identifier hs-var">KnownThreads</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679081507"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679082340"><span id="local-6989586621679082345"><span id="local-6989586621679082350"><span class="annot"><span class="annottext">Context -&gt; KnownThreads m -&gt; IO (Maybe ThunkInfo)
Proxy (KnownThreads m) -&gt; String
(Context -&gt; KnownThreads m -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; KnownThreads m -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (KnownThreads m) -&gt; String)
-&gt; NoThunks (KnownThreads m)
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
forall (m :: * -&gt; *).
Context -&gt; KnownThreads m -&gt; IO (Maybe ThunkInfo)
forall (m :: * -&gt; *). Proxy (KnownThreads m) -&gt; String
$cnoThunks :: forall (m :: * -&gt; *).
Context -&gt; KnownThreads m -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; KnownThreads m -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall (m :: * -&gt; *).
Context -&gt; KnownThreads m -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; KnownThreads m -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: forall (m :: * -&gt; *). Proxy (KnownThreads m) -&gt; String
showTypeOf :: Proxy (KnownThreads m) -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">InspectHeapNamed</span></span><span> </span><span class="annot"><span class="hs-string">&quot;KnownThreads&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#KnownThreads"><span class="hs-identifier hs-type">KnownThreads</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081507"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span class="annot"><span class="hs-comment">-- | Status of the registry (open or closed)</span></span><span>
</span><span id="line-388"></span><span class="hs-keyword">data</span><span> </span><span id="RegistryStatus"><span class="annot"><a href="Control.ResourceRegistry.html#RegistryStatus"><span class="hs-identifier hs-var">RegistryStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-389"></span><span>    </span><span id="RegistryOpen"><span class="annot"><a href="Control.ResourceRegistry.html#RegistryOpen"><span class="hs-identifier hs-var">RegistryOpen</span></a></span></span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span>    </span><span class="annot"><span class="hs-comment">-- | We record the 'CallStack' to the call to 'close</span></span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="RegistryClosed"><span class="annot"><a href="Control.ResourceRegistry.html#RegistryClosed"><span class="hs-identifier hs-var">RegistryClosed</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082357"><span id="local-6989586621679082359"><span class="annot"><span class="annottext">(forall x. RegistryStatus -&gt; Rep RegistryStatus x)
-&gt; (forall x. Rep RegistryStatus x -&gt; RegistryStatus)
-&gt; Generic RegistryStatus
forall x. Rep RegistryStatus x -&gt; RegistryStatus
forall x. RegistryStatus -&gt; Rep RegistryStatus x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. RegistryStatus -&gt; Rep RegistryStatus x
from :: forall x. RegistryStatus -&gt; Rep RegistryStatus x
$cto :: forall x. Rep RegistryStatus x -&gt; RegistryStatus
to :: forall x. Rep RegistryStatus x -&gt; RegistryStatus
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082362"><span id="local-6989586621679082365"><span id="local-6989586621679082371"><span class="annot"><span class="annottext">Context -&gt; RegistryStatus -&gt; IO (Maybe ThunkInfo)
Proxy RegistryStatus -&gt; String
(Context -&gt; RegistryStatus -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; RegistryStatus -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy RegistryStatus -&gt; String)
-&gt; NoThunks RegistryStatus
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
$cnoThunks :: Context -&gt; RegistryStatus -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; RegistryStatus -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; RegistryStatus -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; RegistryStatus -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: Proxy RegistryStatus -&gt; String
showTypeOf :: Proxy RegistryStatus -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span class="hs-comment">-- | Resource key</span><span>
</span><span id="line-396"></span><span class="hs-comment">--</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- Resource keys are tied to a particular registry.</span><span>
</span><span id="line-398"></span><span class="hs-keyword">data</span><span> </span><span id="ResourceKey"><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-var">ResourceKey</span></a></span></span><span> </span><span id="local-6989586621679081624"><span class="annot"><a href="#local-6989586621679081624"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ResourceKey"><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-var">ResourceKey</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081624"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span>
</span><span id="line-399"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679082394"><span id="local-6989586621679082396"><span class="annot"><span class="annottext">(forall x. ResourceKey m -&gt; Rep (ResourceKey m) x)
-&gt; (forall x. Rep (ResourceKey m) x -&gt; ResourceKey m)
-&gt; Generic (ResourceKey m)
forall x. Rep (ResourceKey m) x -&gt; ResourceKey m
forall x. ResourceKey m -&gt; Rep (ResourceKey m) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (m :: * -&gt; *) x. Rep (ResourceKey m) x -&gt; ResourceKey m
forall (m :: * -&gt; *) x. ResourceKey m -&gt; Rep (ResourceKey m) x
$cfrom :: forall (m :: * -&gt; *) x. ResourceKey m -&gt; Rep (ResourceKey m) x
from :: forall x. ResourceKey m -&gt; Rep (ResourceKey m) x
$cto :: forall (m :: * -&gt; *) x. Rep (ResourceKey m) x -&gt; ResourceKey m
to :: forall x. Rep (ResourceKey m) x -&gt; ResourceKey m
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span id="local-6989586621679081484"><span id="local-6989586621679082400"><span id="local-6989586621679082404"><span id="local-6989586621679082410"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081484"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-type">ResourceKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081484"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span class="annot"><span class="hs-comment">-- | Return the 'ResourceId' of a 'ResourceKey'.</span></span><span>
</span><span id="line-405"></span><span id="local-6989586621679081485"><span class="annot"><a href="Control.ResourceRegistry.html#resourceKeyId"><span class="hs-identifier hs-type">resourceKeyId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-type">ResourceKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081485"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span></span><span>
</span><span id="line-406"></span><span id="resourceKeyId"><span class="annot"><span class="annottext">resourceKeyId :: forall (m :: * -&gt; *). ResourceKey m -&gt; ResourceId
</span><a href="Control.ResourceRegistry.html#resourceKeyId"><span class="hs-identifier hs-var hs-var">resourceKeyId</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-type">ResourceKey</span></a></span><span> </span><span id="local-6989586621679082429"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082429"><span class="hs-identifier hs-var">_rr</span></a></span></span><span> </span><span id="local-6989586621679082430"><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679082430"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679082430"><span class="hs-identifier hs-var">rid</span></a></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span class="hs-comment">-- | Resource ID</span><span>
</span><span id="line-409"></span><span class="hs-comment">--</span><span>
</span><span id="line-410"></span><span class="hs-comment">-- This uniquifying data is not exposed by the 'ResourceRegistry' interface.</span><span>
</span><span id="line-411"></span><span class="hs-keyword">newtype</span><span> </span><span id="ResourceId"><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-var">ResourceId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ResourceId"><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-var">ResourceId</span></a></span></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span>   </span><span class="hs-special">(</span><span id="local-6989586621679082432"><span id="local-6989586621679082437"><span id="local-6989586621679082441"><span class="annot"><span class="annottext">Int -&gt; ResourceId -&gt; ShowS
[ResourceId] -&gt; ShowS
ResourceId -&gt; String
(Int -&gt; ResourceId -&gt; ShowS)
-&gt; (ResourceId -&gt; String)
-&gt; ([ResourceId] -&gt; ShowS)
-&gt; Show ResourceId
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; ResourceId -&gt; ShowS
showsPrec :: Int -&gt; ResourceId -&gt; ShowS
$cshow :: ResourceId -&gt; String
show :: ResourceId -&gt; String
$cshowList :: [ResourceId] -&gt; ShowS
showList :: [ResourceId] -&gt; ShowS
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082444"><span id="local-6989586621679082448"><span class="annot"><span class="annottext">ResourceId -&gt; ResourceId -&gt; Bool
(ResourceId -&gt; ResourceId -&gt; Bool)
-&gt; (ResourceId -&gt; ResourceId -&gt; Bool) -&gt; Eq ResourceId
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: ResourceId -&gt; ResourceId -&gt; Bool
== :: ResourceId -&gt; ResourceId -&gt; Bool
$c/= :: ResourceId -&gt; ResourceId -&gt; Bool
/= :: ResourceId -&gt; ResourceId -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082454"><span id="local-6989586621679082457"><span id="local-6989586621679082460"><span id="local-6989586621679082464"><span id="local-6989586621679082467"><span id="local-6989586621679082470"><span id="local-6989586621679082473"><span class="annot"><span class="annottext">Eq ResourceId
Eq ResourceId =&gt;
(ResourceId -&gt; ResourceId -&gt; Ordering)
-&gt; (ResourceId -&gt; ResourceId -&gt; Bool)
-&gt; (ResourceId -&gt; ResourceId -&gt; Bool)
-&gt; (ResourceId -&gt; ResourceId -&gt; Bool)
-&gt; (ResourceId -&gt; ResourceId -&gt; Bool)
-&gt; (ResourceId -&gt; ResourceId -&gt; ResourceId)
-&gt; (ResourceId -&gt; ResourceId -&gt; ResourceId)
-&gt; Ord ResourceId
ResourceId -&gt; ResourceId -&gt; Bool
ResourceId -&gt; ResourceId -&gt; Ordering
ResourceId -&gt; ResourceId -&gt; ResourceId
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: ResourceId -&gt; ResourceId -&gt; Ordering
compare :: ResourceId -&gt; ResourceId -&gt; Ordering
$c&lt; :: ResourceId -&gt; ResourceId -&gt; Bool
&lt; :: ResourceId -&gt; ResourceId -&gt; Bool
$c&lt;= :: ResourceId -&gt; ResourceId -&gt; Bool
&lt;= :: ResourceId -&gt; ResourceId -&gt; Bool
$c&gt; :: ResourceId -&gt; ResourceId -&gt; Bool
&gt; :: ResourceId -&gt; ResourceId -&gt; Bool
$c&gt;= :: ResourceId -&gt; ResourceId -&gt; Bool
&gt;= :: ResourceId -&gt; ResourceId -&gt; Bool
$cmax :: ResourceId -&gt; ResourceId -&gt; ResourceId
max :: ResourceId -&gt; ResourceId -&gt; ResourceId
$cmin :: ResourceId -&gt; ResourceId -&gt; ResourceId
min :: ResourceId -&gt; ResourceId -&gt; ResourceId
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082476"><span id="local-6989586621679082481"><span id="local-6989586621679082485"><span id="local-6989586621679082489"><span id="local-6989586621679082493"><span id="local-6989586621679082497"><span id="local-6989586621679082501"><span id="local-6989586621679082505"><span class="annot"><span class="annottext">Int -&gt; ResourceId
ResourceId -&gt; Int
ResourceId -&gt; [ResourceId]
ResourceId -&gt; ResourceId
ResourceId -&gt; ResourceId -&gt; [ResourceId]
ResourceId -&gt; ResourceId -&gt; ResourceId -&gt; [ResourceId]
(ResourceId -&gt; ResourceId)
-&gt; (ResourceId -&gt; ResourceId)
-&gt; (Int -&gt; ResourceId)
-&gt; (ResourceId -&gt; Int)
-&gt; (ResourceId -&gt; [ResourceId])
-&gt; (ResourceId -&gt; ResourceId -&gt; [ResourceId])
-&gt; (ResourceId -&gt; ResourceId -&gt; [ResourceId])
-&gt; (ResourceId -&gt; ResourceId -&gt; ResourceId -&gt; [ResourceId])
-&gt; Enum ResourceId
forall a.
(a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (Int -&gt; a)
-&gt; (a -&gt; Int)
-&gt; (a -&gt; [a])
-&gt; (a -&gt; a -&gt; [a])
-&gt; (a -&gt; a -&gt; [a])
-&gt; (a -&gt; a -&gt; a -&gt; [a])
-&gt; Enum a
$csucc :: ResourceId -&gt; ResourceId
succ :: ResourceId -&gt; ResourceId
$cpred :: ResourceId -&gt; ResourceId
pred :: ResourceId -&gt; ResourceId
$ctoEnum :: Int -&gt; ResourceId
toEnum :: Int -&gt; ResourceId
$cfromEnum :: ResourceId -&gt; Int
fromEnum :: ResourceId -&gt; Int
$cenumFrom :: ResourceId -&gt; [ResourceId]
enumFrom :: ResourceId -&gt; [ResourceId]
$cenumFromThen :: ResourceId -&gt; ResourceId -&gt; [ResourceId]
enumFromThen :: ResourceId -&gt; ResourceId -&gt; [ResourceId]
$cenumFromTo :: ResourceId -&gt; ResourceId -&gt; [ResourceId]
enumFromTo :: ResourceId -&gt; ResourceId -&gt; [ResourceId]
$cenumFromThenTo :: ResourceId -&gt; ResourceId -&gt; ResourceId -&gt; [ResourceId]
enumFromThenTo :: ResourceId -&gt; ResourceId -&gt; ResourceId -&gt; [ResourceId]
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Enum.html#Enum"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Enum</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082511"><span id="local-6989586621679082516"><span id="local-6989586621679082520"><span class="annot"><span class="annottext">Context -&gt; ResourceId -&gt; IO (Maybe ThunkInfo)
Proxy ResourceId -&gt; String
(Context -&gt; ResourceId -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; ResourceId -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy ResourceId -&gt; String)
-&gt; NoThunks ResourceId
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
$cnoThunks :: Context -&gt; ResourceId -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; ResourceId -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; ResourceId -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; ResourceId -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: Proxy ResourceId -&gt; String
showTypeOf :: Proxy ResourceId -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>
</span><span id="line-415"></span><span class="annot"><span class="hs-comment">-- | Information about a resource</span></span><span>
</span><span id="line-416"></span><span class="hs-keyword">data</span><span> </span><span id="Resource"><span class="annot"><a href="Control.ResourceRegistry.html#Resource"><span class="hs-identifier hs-var">Resource</span></a></span></span><span> </span><span id="local-6989586621679081488"><span class="annot"><a href="#local-6989586621679081488"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Resource"><span class="annot"><a href="Control.ResourceRegistry.html#Resource"><span class="hs-identifier hs-var">Resource</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-417"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Context in which the resource was created</span></span><span>
</span><span id="line-418"></span><span>      </span><span id="resourceContext"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Resource m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#resourceContext"><span class="hs-identifier hs-var hs-var">resourceContext</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081488"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Deallocate the resource</span></span><span>
</span><span id="line-421"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="resourceRelease"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Resource m -&gt; Release m
</span><a href="Control.ResourceRegistry.html#resourceRelease"><span class="hs-identifier hs-var hs-var">resourceRelease</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Release"><span class="hs-identifier hs-type">Release</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081488"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082527"><span id="local-6989586621679082529"><span class="annot"><span class="annottext">(forall x. Resource m -&gt; Rep (Resource m) x)
-&gt; (forall x. Rep (Resource m) x -&gt; Resource m)
-&gt; Generic (Resource m)
forall x. Rep (Resource m) x -&gt; Resource m
forall x. Resource m -&gt; Rep (Resource m) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (m :: * -&gt; *) x. Rep (Resource m) x -&gt; Resource m
forall (m :: * -&gt; *) x. Resource m -&gt; Rep (Resource m) x
$cfrom :: forall (m :: * -&gt; *) x. Resource m -&gt; Rep (Resource m) x
from :: forall x. Resource m -&gt; Rep (Resource m) x
$cto :: forall (m :: * -&gt; *) x. Rep (Resource m) x -&gt; Resource m
to :: forall x. Rep (Resource m) x -&gt; Resource m
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082532"><span id="local-6989586621679082535"><span id="local-6989586621679082541"><span class="annot"><span class="annottext">Context -&gt; Resource m -&gt; IO (Maybe ThunkInfo)
Proxy (Resource m) -&gt; String
(Context -&gt; Resource m -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; Resource m -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (Resource m) -&gt; String)
-&gt; NoThunks (Resource m)
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
forall (m :: * -&gt; *). Context -&gt; Resource m -&gt; IO (Maybe ThunkInfo)
forall (m :: * -&gt; *). Proxy (Resource m) -&gt; String
$cnoThunks :: forall (m :: * -&gt; *). Context -&gt; Resource m -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; Resource m -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall (m :: * -&gt; *). Context -&gt; Resource m -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; Resource m -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: forall (m :: * -&gt; *). Proxy (Resource m) -&gt; String
showTypeOf :: Proxy (Resource m) -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span class="hs-comment">-- | Release the resource, return 'True' when the resource was actually</span><span>
</span><span id="line-426"></span><span class="hs-comment">-- released, return 'False' when the resource was already released.</span><span>
</span><span id="line-427"></span><span class="hs-comment">--</span><span>
</span><span id="line-428"></span><span class="hs-comment">-- If unsure, returning 'True' is always fine.</span><span>
</span><span id="line-429"></span><span class="hs-keyword">newtype</span><span> </span><span id="Release"><span class="annot"><a href="Control.ResourceRegistry.html#Release"><span class="hs-identifier hs-var">Release</span></a></span></span><span> </span><span id="local-6989586621679081935"><span class="annot"><a href="#local-6989586621679081935"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Release"><span class="annot"><a href="Control.ResourceRegistry.html#Release"><span class="hs-identifier hs-var">Release</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081935"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679082568"><span id="local-6989586621679082574"><span id="local-6989586621679082579"><span class="annot"><span class="annottext">Context -&gt; Release m -&gt; IO (Maybe ThunkInfo)
Proxy (Release m) -&gt; String
(Context -&gt; Release m -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; Release m -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (Release m) -&gt; String)
-&gt; NoThunks (Release m)
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
forall (m :: * -&gt; *). Context -&gt; Release m -&gt; IO (Maybe ThunkInfo)
forall (m :: * -&gt; *). Proxy (Release m) -&gt; String
$cnoThunks :: forall (m :: * -&gt; *). Context -&gt; Release m -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; Release m -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall (m :: * -&gt; *). Context -&gt; Release m -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; Release m -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: forall (m :: * -&gt; *). Proxy (Release m) -&gt; String
showTypeOf :: Proxy (Release m) -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OnlyCheckWhnfNamed</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Release&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Release"><span class="hs-identifier hs-type">Release</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081935"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span id="local-6989586621679081500"><span class="annot"><a href="Control.ResourceRegistry.html#releaseResource"><span class="hs-identifier hs-type">releaseResource</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Resource"><span class="hs-identifier hs-type">Resource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081500"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081500"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-433"></span><span id="releaseResource"><span class="annot"><span class="annottext">releaseResource :: forall (m :: * -&gt; *). Resource m -&gt; m Bool
</span><a href="Control.ResourceRegistry.html#releaseResource"><span class="hs-identifier hs-var hs-var">releaseResource</span></a></span></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Resource"><span class="hs-identifier hs-type">Resource</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">resourceRelease :: forall (m :: * -&gt; *). Resource m -&gt; Release m
</span><a href="Control.ResourceRegistry.html#resourceRelease"><span class="hs-identifier hs-var">resourceRelease</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Release"><span class="hs-identifier hs-type">Release</span></a></span><span> </span><span id="local-6989586621679082584"><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679082584"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679082584"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679081503"><span id="local-6989586621679082586"><span id="local-6989586621679082591"><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Release"><span class="hs-identifier hs-type">Release</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081503"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-436"></span><span>  </span><span id="local-6989586621679082593"><span class="annot"><span class="annottext">show :: Release m -&gt; String
</span><a href="#local-6989586621679082593"><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="annot"><span class="annottext">Release m
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&lt;&lt;release&gt;&gt;&quot;</span></span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Internal: pure functions on the registry state
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span id="local-6989586621679081504"><span class="annot"><a href="Control.ResourceRegistry.html#modifyKnownThreads"><span class="hs-identifier hs-type">modifyKnownThreads</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-443"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679081504"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679081504"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#KnownThreads"><span class="hs-identifier hs-type">KnownThreads</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081504"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-445"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#KnownThreads"><span class="hs-identifier hs-type">KnownThreads</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081504"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-446"></span><span id="modifyKnownThreads"><span class="annot"><span class="annottext">modifyKnownThreads :: forall (m :: * -&gt; *).
(Set (ThreadId m) -&gt; Set (ThreadId m))
-&gt; KnownThreads m -&gt; KnownThreads m
</span><a href="Control.ResourceRegistry.html#modifyKnownThreads"><span class="hs-identifier hs-var hs-var">modifyKnownThreads</span></a></span></span><span> </span><span id="local-6989586621679082596"><span class="annot"><span class="annottext">Set (ThreadId m) -&gt; Set (ThreadId m)
</span><a href="#local-6989586621679082596"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#KnownThreads"><span class="hs-identifier hs-type">KnownThreads</span></a></span><span> </span><span id="local-6989586621679082597"><span class="annot"><span class="annottext">Set (ThreadId m)
</span><a href="#local-6989586621679082597"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set (ThreadId m) -&gt; KnownThreads m
forall (m :: * -&gt; *). Set (ThreadId m) -&gt; KnownThreads m
</span><a href="Control.ResourceRegistry.html#KnownThreads"><span class="hs-identifier hs-var">KnownThreads</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set (ThreadId m) -&gt; Set (ThreadId m)
</span><a href="#local-6989586621679082596"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Set (ThreadId m)
</span><a href="#local-6989586621679082597"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span class="annot"><span class="hs-comment">-- | Auxiliary for functions that should be disallowed when registry is closed</span></span><span>
</span><span id="line-449"></span><span id="local-6989586621679081508"><span id="local-6989586621679081509"><span class="annot"><a href="Control.ResourceRegistry.html#unlessClosed"><span class="hs-identifier hs-type">unlessClosed</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-450"></span><span>     </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081508"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679081509"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081508"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081509"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-452"></span><span id="unlessClosed"><span class="annot"><span class="annottext">unlessClosed :: forall (m :: * -&gt; *) a.
State (RegistryState m) a
-&gt; State (RegistryState m) (Either PrettyCallStack a)
</span><a href="Control.ResourceRegistry.html#unlessClosed"><span class="hs-identifier hs-var hs-var">unlessClosed</span></a></span></span><span> </span><span id="local-6989586621679082610"><span class="annot"><span class="annottext">State (RegistryState m) a
</span><a href="#local-6989586621679082610"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-453"></span><span>    </span><span id="local-6989586621679082611"><span class="annot"><span class="annottext">RegistryStatus
</span><a href="#local-6989586621679082611"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(RegistryState m -&gt; RegistryStatus)
-&gt; StateT (RegistryState m) Identity RegistryStatus
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">RegistryState m -&gt; RegistryStatus
forall (m :: * -&gt; *). RegistryState m -&gt; RegistryStatus
</span><a href="Control.ResourceRegistry.html#registryStatus"><span class="hs-identifier hs-var">registryStatus</span></a></span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RegistryStatus
</span><a href="#local-6989586621679082611"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-455"></span><span>      </span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryClosed"><span class="hs-identifier hs-type">RegistryClosed</span></a></span><span> </span><span id="local-6989586621679082613"><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679082613"><span class="hs-identifier hs-var">closed</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either PrettyCallStack a
-&gt; State (RegistryState m) (Either PrettyCallStack a)
forall a. a -&gt; StateT (RegistryState m) Identity a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either PrettyCallStack a
 -&gt; State (RegistryState m) (Either PrettyCallStack a))
-&gt; Either PrettyCallStack a
-&gt; State (RegistryState m) (Either PrettyCallStack a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyCallStack -&gt; Either PrettyCallStack a
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679082613"><span class="hs-identifier hs-var">closed</span></a></span><span>
</span><span id="line-456"></span><span>      </span><span class="annot"><span class="annottext">RegistryStatus
</span><a href="Control.ResourceRegistry.html#RegistryOpen"><span class="hs-identifier hs-var">RegistryOpen</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; Either PrettyCallStack a
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Either PrettyCallStack a)
-&gt; State (RegistryState m) a
-&gt; State (RegistryState m) (Either PrettyCallStack a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">State (RegistryState m) a
</span><a href="#local-6989586621679082610"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span class="annot"><span class="hs-comment">-- | Allocate key for new resource</span></span><span>
</span><span id="line-459"></span><span id="local-6989586621679081535"><span class="annot"><a href="Control.ResourceRegistry.html#allocKey"><span class="hs-identifier hs-type">allocKey</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081535"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-460"></span><span id="allocKey"><span class="annot"><span class="annottext">allocKey :: forall (m :: * -&gt; *).
State (RegistryState m) (Either PrettyCallStack ResourceId)
</span><a href="Control.ResourceRegistry.html#allocKey"><span class="hs-identifier hs-var hs-var">allocKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State (RegistryState m) ResourceId
-&gt; State (RegistryState m) (Either PrettyCallStack ResourceId)
forall (m :: * -&gt; *) a.
State (RegistryState m) a
-&gt; State (RegistryState m) (Either PrettyCallStack a)
</span><a href="Control.ResourceRegistry.html#unlessClosed"><span class="hs-identifier hs-var">unlessClosed</span></a></span><span> </span><span class="annot"><span class="annottext">(State (RegistryState m) ResourceId
 -&gt; State (RegistryState m) (Either PrettyCallStack ResourceId))
-&gt; State (RegistryState m) ResourceId
-&gt; State (RegistryState m) (Either PrettyCallStack ResourceId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-461"></span><span>    </span><span id="local-6989586621679082623"><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679082623"><span class="hs-identifier hs-var">nextKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(RegistryState m -&gt; ResourceId)
-&gt; State (RegistryState m) ResourceId
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">RegistryState m -&gt; ResourceId
forall (m :: * -&gt; *). RegistryState m -&gt; ResourceId
</span><a href="Control.ResourceRegistry.html#registryNextKey"><span class="hs-identifier hs-var">registryNextKey</span></a></span><span>
</span><span id="line-462"></span><span>    </span><span class="annot"><span class="annottext">(RegistryState m -&gt; RegistryState m)
-&gt; StateT (RegistryState m) Identity ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">((RegistryState m -&gt; RegistryState m)
 -&gt; StateT (RegistryState m) Identity ())
-&gt; (RegistryState m -&gt; RegistryState m)
-&gt; StateT (RegistryState m) Identity ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679082625"><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082625"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082625"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="Control.ResourceRegistry.html#registryNextKey"><span class="hs-identifier hs-var">registryNextKey</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Enum.html#succ"><span class="hs-identifier hs-type">succ</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082623"><span class="hs-identifier hs-type">nextKey</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-463"></span><span>    </span><span class="annot"><span class="annottext">ResourceId -&gt; State (RegistryState m) ResourceId
forall a. a -&gt; StateT (RegistryState m) Identity a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679082623"><span class="hs-identifier hs-var">nextKey</span></a></span><span>
</span><span id="line-464"></span><span>
</span><span id="line-465"></span><span class="annot"><span class="hs-comment">-- | Insert new resource</span></span><span>
</span><span id="line-466"></span><span id="local-6989586621679081539"><span class="annot"><a href="Control.ResourceRegistry.html#insertResource"><span class="hs-identifier hs-type">insertResource</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-467"></span><span>     </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span>
</span><span id="line-468"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Resource"><span class="hs-identifier hs-type">Resource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081539"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-469"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081539"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-470"></span><span id="insertResource"><span class="annot"><span class="annottext">insertResource :: forall (m :: * -&gt; *).
ResourceId
-&gt; Resource m
-&gt; State (RegistryState m) (Either PrettyCallStack ())
</span><a href="Control.ResourceRegistry.html#insertResource"><span class="hs-identifier hs-var hs-var">insertResource</span></a></span></span><span> </span><span id="local-6989586621679082633"><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679082633"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621679082634"><span class="annot"><span class="annottext">Resource m
</span><a href="#local-6989586621679082634"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State (RegistryState m) ()
-&gt; State (RegistryState m) (Either PrettyCallStack ())
forall (m :: * -&gt; *) a.
State (RegistryState m) a
-&gt; State (RegistryState m) (Either PrettyCallStack a)
</span><a href="Control.ResourceRegistry.html#unlessClosed"><span class="hs-identifier hs-var">unlessClosed</span></a></span><span> </span><span class="annot"><span class="annottext">(State (RegistryState m) ()
 -&gt; State (RegistryState m) (Either PrettyCallStack ()))
-&gt; State (RegistryState m) ()
-&gt; State (RegistryState m) (Either PrettyCallStack ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-471"></span><span>    </span><span class="annot"><span class="annottext">(RegistryState m -&gt; RegistryState m) -&gt; State (RegistryState m) ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">((RegistryState m -&gt; RegistryState m)
 -&gt; State (RegistryState m) ())
-&gt; (RegistryState m -&gt; RegistryState m)
-&gt; State (RegistryState m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679082635"><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082635"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082635"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-472"></span><span>        </span><span class="annot"><a href="Control.ResourceRegistry.html#registryResources"><span class="hs-identifier hs-var">registryResources</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#insert"><span class="hs-identifier hs-type">Map.insert</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082633"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082634"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#registryResources"><span class="hs-identifier hs-var">registryResources</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082635"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#registryAges"><span class="hs-identifier hs-var">registryAges</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bimap.insert</span></span><span>
</span><span id="line-474"></span><span>                              </span><span class="annot"><a href="#local-6989586621679082633"><span class="hs-identifier hs-type">key</span></a></span><span>
</span><span id="line-475"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#registryNextAge"><span class="hs-identifier hs-var">registryNextAge</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082635"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#registryAges"><span class="hs-identifier hs-var">registryAges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082635"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#registryNextAge"><span class="hs-identifier hs-var">registryNextAge</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#nextYoungerAge"><span class="hs-identifier hs-type">nextYoungerAge</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#registryNextAge"><span class="hs-identifier hs-var">registryNextAge</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082635"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span class="annot"><span class="hs-comment">-- | Remove resource from the registry (if it exists)</span></span><span>
</span><span id="line-481"></span><span id="local-6989586621679081545"><span class="annot"><a href="Control.ResourceRegistry.html#removeResource"><span class="hs-identifier hs-type">removeResource</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081545"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Resource"><span class="hs-identifier hs-type">Resource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081545"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-482"></span><span id="removeResource"><span class="annot"><span class="annottext">removeResource :: forall (m :: * -&gt; *).
ResourceId -&gt; State (RegistryState m) (Maybe (Resource m))
</span><a href="Control.ResourceRegistry.html#removeResource"><span class="hs-identifier hs-var hs-var">removeResource</span></a></span></span><span> </span><span id="local-6989586621679082641"><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679082641"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RegistryState m -&gt; (Maybe (Resource m), RegistryState m))
-&gt; StateT (RegistryState m) Identity (Maybe (Resource m))
forall a.
(RegistryState m -&gt; (a, RegistryState m))
-&gt; StateT (RegistryState m) Identity a
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; (a, s)) -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#state"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">((RegistryState m -&gt; (Maybe (Resource m), RegistryState m))
 -&gt; StateT (RegistryState m) Identity (Maybe (Resource m)))
-&gt; (RegistryState m -&gt; (Maybe (Resource m), RegistryState m))
-&gt; StateT (RegistryState m) Identity (Maybe (Resource m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679082643"><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082643"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-483"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679082645"><span class="annot"><span class="annottext">Maybe (Resource m)
</span><a href="#local-6989586621679082645"><span class="hs-identifier hs-var">mbResource</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082646"><span class="annot"><span class="annottext">Map ResourceId (Resource m)
</span><a href="#local-6989586621679082646"><span class="hs-identifier hs-var">resources'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ResourceId -&gt; Resource m -&gt; Maybe (Resource m))
-&gt; ResourceId
-&gt; Map ResourceId (Resource m)
-&gt; (Maybe (Resource m), Map ResourceId (Resource m))
forall k a.
Ord k =&gt;
(k -&gt; a -&gt; Maybe a) -&gt; k -&gt; Map k a -&gt; (Maybe a, Map k a)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#updateLookupWithKey"><span class="hs-identifier hs-var">Map.updateLookupWithKey</span></a></span><span>
</span><span id="line-484"></span><span>                                     </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">ResourceId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Resource m
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Resource m)
forall a. Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span>                                     </span><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679082641"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-486"></span><span>                                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RegistryState m -&gt; Map ResourceId (Resource m)
forall (m :: * -&gt; *).
RegistryState m -&gt; Map ResourceId (Resource m)
</span><a href="Control.ResourceRegistry.html#registryResources"><span class="hs-identifier hs-var">registryResources</span></a></span><span> </span><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082643"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span>        </span><span id="local-6989586621679082650"><span class="annot"><span class="annottext">st' :: RegistryState m
</span><a href="#local-6989586621679082650"><span class="hs-identifier hs-var hs-var">st'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082643"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-489"></span><span>            </span><span class="annot"><a href="Control.ResourceRegistry.html#registryResources"><span class="hs-identifier hs-var">registryResources</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679082646"><span class="hs-identifier hs-type">resources'</span></a></span><span>
</span><span id="line-490"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#registryAges"><span class="hs-identifier hs-var">registryAges</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bimap.delete</span></span><span> </span><span class="annot"><a href="#local-6989586621679082641"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#registryAges"><span class="hs-identifier hs-var">registryAges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082643"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-491"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-492"></span><span>    </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Resource m)
</span><a href="#local-6989586621679082645"><span class="hs-identifier hs-var">mbResource</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082650"><span class="hs-identifier hs-var">st'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span class="annot"><span class="hs-comment">-- | Insert thread into the set of known threads</span></span><span>
</span><span id="line-495"></span><span id="local-6989586621679081554"><span class="annot"><a href="Control.ResourceRegistry.html#insertThread"><span class="hs-identifier hs-type">insertThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081554"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679081554"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081554"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-496"></span><span id="insertThread"><span class="annot"><span class="annottext">insertThread :: forall (m :: * -&gt; *).
MonadThread m =&gt;
ThreadId m -&gt; State (RegistryState m) ()
</span><a href="Control.ResourceRegistry.html#insertThread"><span class="hs-identifier hs-var hs-var">insertThread</span></a></span></span><span> </span><span id="local-6989586621679082659"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679082659"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-497"></span><span>    </span><span class="annot"><span class="annottext">(RegistryState m -&gt; RegistryState m)
-&gt; StateT (RegistryState m) Identity ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">((RegistryState m -&gt; RegistryState m)
 -&gt; StateT (RegistryState m) Identity ())
-&gt; (RegistryState m -&gt; RegistryState m)
-&gt; StateT (RegistryState m) Identity ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679082660"><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082660"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082660"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-498"></span><span>        </span><span class="annot"><a href="Control.ResourceRegistry.html#registryThreads"><span class="hs-identifier hs-var">registryThreads</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#modifyKnownThreads"><span class="hs-identifier hs-type">modifyKnownThreads</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#insert"><span class="hs-identifier hs-type">Set.insert</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082659"><span class="hs-identifier hs-type">tid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-type">$</span></a></span><span>
</span><span id="line-499"></span><span>                            </span><span class="annot"><a href="Control.ResourceRegistry.html#registryThreads"><span class="hs-identifier hs-var">registryThreads</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082660"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-500"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-501"></span><span>
</span><span id="line-502"></span><span class="annot"><span class="hs-comment">-- | Remove thread from set of known threads</span></span><span>
</span><span id="line-503"></span><span id="local-6989586621679082662"><span class="annot"><a href="Control.ResourceRegistry.html#removeThread"><span class="hs-identifier hs-type">removeThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679082662"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679082662"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082662"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-504"></span><span id="removeThread"><span class="annot"><span class="annottext">removeThread :: forall (m :: * -&gt; *).
MonadThread m =&gt;
ThreadId m -&gt; State (RegistryState m) ()
</span><a href="Control.ResourceRegistry.html#removeThread"><span class="hs-identifier hs-var hs-var">removeThread</span></a></span></span><span> </span><span id="local-6989586621679082669"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679082669"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-505"></span><span>    </span><span class="annot"><span class="annottext">(RegistryState m -&gt; RegistryState m)
-&gt; StateT (RegistryState m) Identity ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">((RegistryState m -&gt; RegistryState m)
 -&gt; StateT (RegistryState m) Identity ())
-&gt; (RegistryState m -&gt; RegistryState m)
-&gt; StateT (RegistryState m) Identity ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679082670"><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082670"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082670"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-506"></span><span>        </span><span class="annot"><a href="Control.ResourceRegistry.html#registryThreads"><span class="hs-identifier hs-var">registryThreads</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#modifyKnownThreads"><span class="hs-identifier hs-type">modifyKnownThreads</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#delete"><span class="hs-identifier hs-type">Set.delete</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082669"><span class="hs-identifier hs-type">tid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-type">$</span></a></span><span>
</span><span id="line-507"></span><span>                            </span><span class="annot"><a href="Control.ResourceRegistry.html#registryThreads"><span class="hs-identifier hs-var">registryThreads</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082670"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-508"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-509"></span><span>
</span><span id="line-510"></span><span class="hs-comment">-- | Close the registry</span><span>
</span><span id="line-511"></span><span class="hs-comment">--</span><span>
</span><span id="line-512"></span><span class="hs-comment">-- Returns the keys currently allocated if the registry is not already closed.</span><span>
</span><span id="line-513"></span><span class="hs-comment">--</span><span>
</span><span id="line-514"></span><span class="hs-comment">-- POSTCONDITION: They are returned in youngest-to-oldest order.</span><span>
</span><span id="line-515"></span><span id="local-6989586621679081559"><span class="annot"><a href="Control.ResourceRegistry.html#close"><span class="hs-identifier hs-type">close</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-516"></span><span>     </span><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span>
</span><span id="line-517"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081559"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-518"></span><span id="close"><span class="annot"><span class="annottext">close :: forall (m :: * -&gt; *).
PrettyCallStack
-&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId])
</span><a href="Control.ResourceRegistry.html#close"><span class="hs-identifier hs-var hs-var">close</span></a></span></span><span> </span><span id="local-6989586621679082677"><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679082677"><span class="hs-identifier hs-var">closeCallStack</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State (RegistryState m) [ResourceId]
-&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId])
forall (m :: * -&gt; *) a.
State (RegistryState m) a
-&gt; State (RegistryState m) (Either PrettyCallStack a)
</span><a href="Control.ResourceRegistry.html#unlessClosed"><span class="hs-identifier hs-var">unlessClosed</span></a></span><span> </span><span class="annot"><span class="annottext">(State (RegistryState m) [ResourceId]
 -&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId]))
-&gt; State (RegistryState m) [ResourceId]
-&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-519"></span><span>    </span><span class="annot"><span class="annottext">(RegistryState m -&gt; RegistryState m)
-&gt; StateT (RegistryState m) Identity ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">((RegistryState m -&gt; RegistryState m)
 -&gt; StateT (RegistryState m) Identity ())
-&gt; (RegistryState m -&gt; RegistryState m)
-&gt; StateT (RegistryState m) Identity ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679082678"><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082678"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RegistryState m
</span><a href="#local-6989586621679082678"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="Control.ResourceRegistry.html#registryStatus"><span class="hs-identifier hs-var">registryStatus</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryClosed"><span class="hs-identifier hs-type">RegistryClosed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082677"><span class="hs-identifier hs-type">closeCallStack</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-520"></span><span>    </span><span class="annot"><span class="annottext">(RegistryState m -&gt; [ResourceId])
-&gt; State (RegistryState m) [ResourceId]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">RegistryState m -&gt; [ResourceId]
forall (m :: * -&gt; *). RegistryState m -&gt; [ResourceId]
</span><a href="Control.ResourceRegistry.html#getYoungestToOldest"><span class="hs-identifier hs-var">getYoungestToOldest</span></a></span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span class="annot"><span class="hs-comment">-- | Convenience function for updating the registry state</span></span><span>
</span><span id="line-523"></span><span class="annot"><a href="Control.ResourceRegistry.html#updateState"><span class="hs-identifier hs-type">updateState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-524"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679081561"><span class="annot"><a href="#local-6989586621679081561"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679081563"><span class="annot"><a href="#local-6989586621679081563"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-525"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081561"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-526"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081561"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-527"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081561"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679081563"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-528"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081561"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081563"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-529"></span><span id="updateState"><span class="annot"><span class="annottext">updateState :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
ResourceRegistry m -&gt; State (RegistryState m) a -&gt; m a
</span><a href="Control.ResourceRegistry.html#updateState"><span class="hs-identifier hs-var hs-var">updateState</span></a></span></span><span> </span><span id="local-6989586621679082685"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082685"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679082686"><span class="annot"><span class="annottext">State (RegistryState m) a
</span><a href="#local-6989586621679082686"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-530"></span><span>    </span><span class="annot"><span class="annottext">STM m a -&gt; m a
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m a -&gt; m a) -&gt; STM m a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (RegistryState m)
-&gt; (RegistryState m -&gt; (a, RegistryState m)) -&gt; STM m a
forall (m :: * -&gt; *) s a.
MonadSTM m =&gt;
StrictTVar m s -&gt; (s -&gt; (a, s)) -&gt; STM m a
</span><span class="hs-identifier hs-var">stateTVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; StrictTVar m (RegistryState m)
forall (m :: * -&gt; *).
ResourceRegistry m -&gt; StrictTVar m (RegistryState m)
</span><a href="Control.ResourceRegistry.html#registryState"><span class="hs-identifier hs-var">registryState</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082685"><span class="hs-identifier hs-var">rr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State (RegistryState m) a
-&gt; RegistryState m -&gt; (a, RegistryState m)
forall s a. State s a -&gt; s -&gt; (a, s)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#runState"><span class="hs-identifier hs-var">runState</span></a></span><span> </span><span class="annot"><span class="annottext">State (RegistryState m) a
</span><a href="#local-6989586621679082686"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span class="hs-comment">-- | Attempt to allocate a resource in a registry which is closed</span><span>
</span><span id="line-533"></span><span class="hs-comment">--</span><span>
</span><span id="line-534"></span><span class="hs-comment">-- When calling 'closeRegistry' (typically, leaving the scope of</span><span>
</span><span id="line-535"></span><span class="hs-comment">-- 'withRegistry'), all resources in the registry must be released. If a</span><span>
</span><span id="line-536"></span><span class="hs-comment">-- concurrent thread is still allocating resources, we end up with a race</span><span>
</span><span id="line-537"></span><span class="hs-comment">-- between the thread trying to allocate new resources and the registry trying</span><span>
</span><span id="line-538"></span><span class="hs-comment">-- to free them all. To avoid this, before releasing anything, the registry will</span><span>
</span><span id="line-539"></span><span class="hs-comment">-- record itself as closed. Any attempt by a concurrent thread to allocate a new</span><span>
</span><span id="line-540"></span><span class="hs-comment">-- resource will then result in a 'RegistryClosedException'.</span><span>
</span><span id="line-541"></span><span class="hs-comment">--</span><span>
</span><span id="line-542"></span><span class="hs-comment">-- It is probably not particularly useful for threads to try and catch this</span><span>
</span><span id="line-543"></span><span class="hs-comment">-- exception (apart from in a generic handler that does local resource cleanup).</span><span>
</span><span id="line-544"></span><span class="hs-comment">-- The thread will anyway soon receive a 'Control.Exception.ThreadKilled'</span><span>
</span><span id="line-545"></span><span class="hs-comment">-- exception.</span><span>
</span><span id="line-546"></span><span class="hs-keyword">data</span><span> </span><span id="RegistryClosedException"><span class="annot"><a href="Control.ResourceRegistry.html#RegistryClosedException"><span class="hs-identifier hs-var">RegistryClosedException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-547"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679082690"><span class="annot"><a href="#local-6989586621679082690"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679082690"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="RegistryClosedException"><span class="annot"><a href="Control.ResourceRegistry.html#RegistryClosedException"><span class="hs-identifier hs-var">RegistryClosedException</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-548"></span><span>        </span><span class="annot"><span class="hs-comment">-- | The context in which the registry was created</span></span><span>
</span><span id="line-549"></span><span>        </span><span id="registryClosedRegistryContext"><span class="annot"><span class="annottext">()
</span><a href="Control.ResourceRegistry.html#registryClosedRegistryContext"><span class="hs-identifier hs-var hs-var">registryClosedRegistryContext</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082690"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span>        </span><span class="hs-comment">-- | Callstack to the call to 'closeRegistry'</span><span>
</span><span id="line-552"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-553"></span><span>        </span><span class="hs-comment">-- Note that 'closeRegistry' can only be called from the same thread</span><span>
</span><span id="line-554"></span><span>        </span><span class="hs-comment">-- that created the registry.</span><span>
</span><span id="line-555"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="registryClosedCloseCallStack"><span class="annot"><span class="annottext">RegistryClosedException -&gt; PrettyCallStack
</span><a href="Control.ResourceRegistry.html#registryClosedCloseCallStack"><span class="hs-identifier hs-var hs-var">registryClosedCloseCallStack</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span>
</span><span id="line-556"></span><span>
</span><span id="line-557"></span><span>        </span><span class="annot"><span class="hs-comment">-- | Context of the call resulting in the exception</span></span><span>
</span><span id="line-558"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="registryClosedAllocContext"><span class="annot"><span class="annottext">()
</span><a href="Control.ResourceRegistry.html#registryClosedAllocContext"><span class="hs-identifier hs-var hs-var">registryClosedAllocContext</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082690"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-559"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-560"></span><span>
</span><span id="line-561"></span><span id="local-6989586621679082696"><span id="local-6989586621679082698"><span id="local-6989586621679082702"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryClosedException"><span class="hs-identifier hs-type">RegistryClosedException</span></a></span></span></span></span><span>
</span><span id="line-562"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679082709"><span id="local-6989586621679082713"><span id="local-6989586621679082716"><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryClosedException"><span class="hs-identifier hs-type">RegistryClosedException</span></a></span></span></span></span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Creating and releasing the registry itself
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-567"></span><span>
</span><span id="line-568"></span><span class="hs-comment">-- | Create a new registry</span><span>
</span><span id="line-569"></span><span class="hs-comment">--</span><span>
</span><span id="line-570"></span><span class="hs-comment">-- You are strongly encouraged to use 'withRegistry' instead.</span><span>
</span><span id="line-571"></span><span class="hs-comment">-- Exported primarily for the benefit of tests.</span><span>
</span><span id="line-572"></span><span id="local-6989586621679081579"><span class="annot"><a href="Control.ResourceRegistry.html#unsafeNewRegistry"><span class="hs-identifier hs-type">unsafeNewRegistry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-573"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081579"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081579"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-574"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081579"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081579"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-575"></span><span id="unsafeNewRegistry"><span class="annot"><span class="annottext">unsafeNewRegistry :: forall (m :: * -&gt; *).
(MonadSTM m, MonadThread m, HasCallStack) =&gt;
m (ResourceRegistry m)
</span><a href="Control.ResourceRegistry.html#unsafeNewRegistry"><span class="hs-identifier hs-var hs-var">unsafeNewRegistry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-576"></span><span>    </span><span id="local-6989586621679082731"><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679082731"><span class="hs-identifier hs-var">context</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Context m)
forall (m :: * -&gt; *).
(MonadThread m, HasCallStack) =&gt;
m (Context m)
</span><a href="Control.ResourceRegistry.html#captureContext"><span class="hs-identifier hs-var">captureContext</span></a></span><span>
</span><span id="line-577"></span><span>    </span><span id="local-6989586621679082733"><span class="annot"><span class="annottext">StrictTVar m (RegistryState m)
</span><a href="#local-6989586621679082733"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegistryState m -&gt; m (StrictTVar m (RegistryState m))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">RegistryState m
forall (m :: * -&gt; *). RegistryState m
</span><a href="#local-6989586621679082735"><span class="hs-identifier hs-var">initState</span></a></span><span>
</span><span id="line-578"></span><span>    </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; m (ResourceRegistry m)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-579"></span><span>          </span><span class="annot"><span class="annottext">registryContext :: Context m
</span><a href="Control.ResourceRegistry.html#registryContext"><span class="hs-identifier hs-var">registryContext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679082731"><span class="hs-identifier hs-var">context</span></a></span><span>
</span><span id="line-580"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">registryState :: StrictTVar m (RegistryState m)
</span><a href="Control.ResourceRegistry.html#registryState"><span class="hs-identifier hs-var">registryState</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (RegistryState m)
</span><a href="#local-6989586621679082733"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-581"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-582"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-583"></span><span>    </span><span id="local-6989586621679081584"><span class="annot"><a href="#local-6989586621679082735"><span class="hs-identifier hs-type">initState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081584"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-584"></span><span>    </span><span id="local-6989586621679082735"><span class="annot"><span class="annottext">initState :: forall (m :: * -&gt; *). RegistryState m
</span><a href="#local-6989586621679082735"><span class="hs-identifier hs-var hs-var">initState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-585"></span><span>          </span><span class="annot"><span class="annottext">registryThreads :: KnownThreads m
</span><a href="Control.ResourceRegistry.html#registryThreads"><span class="hs-identifier hs-var">registryThreads</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set (ThreadId m) -&gt; KnownThreads m
forall (m :: * -&gt; *). Set (ThreadId m) -&gt; KnownThreads m
</span><a href="Control.ResourceRegistry.html#KnownThreads"><span class="hs-identifier hs-var">KnownThreads</span></a></span><span> </span><span class="annot"><span class="annottext">Set (ThreadId m)
forall a. Set a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set.empty</span></a></span><span>
</span><span id="line-586"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">registryResources :: Map ResourceId (Resource m)
</span><a href="Control.ResourceRegistry.html#registryResources"><span class="hs-identifier hs-var">registryResources</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map ResourceId (Resource m)
forall k a. Map k a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-587"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">registryNextKey :: ResourceId
</span><a href="Control.ResourceRegistry.html#registryNextKey"><span class="hs-identifier hs-var">registryNextKey</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ResourceId
</span><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-var">ResourceId</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-588"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">registryAges :: Bimap ResourceId Age
</span><a href="Control.ResourceRegistry.html#registryAges"><span class="hs-identifier hs-var">registryAges</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bimap ResourceId Age
forall a b. Bimap a b
</span><span class="hs-identifier hs-var">Bimap.empty</span></span><span>
</span><span id="line-589"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">registryNextAge :: Age
</span><a href="Control.ResourceRegistry.html#registryNextAge"><span class="hs-identifier hs-var">registryNextAge</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Age
</span><a href="Control.ResourceRegistry.html#ageOfFirstResource"><span class="hs-identifier hs-var">ageOfFirstResource</span></a></span><span>
</span><span id="line-590"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">registryStatus :: RegistryStatus
</span><a href="Control.ResourceRegistry.html#registryStatus"><span class="hs-identifier hs-var">registryStatus</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RegistryStatus
</span><a href="Control.ResourceRegistry.html#RegistryOpen"><span class="hs-identifier hs-var">RegistryOpen</span></a></span><span>
</span><span id="line-591"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span class="hs-comment">-- | Close the registry</span><span>
</span><span id="line-594"></span><span class="hs-comment">--</span><span>
</span><span id="line-595"></span><span class="hs-comment">-- This can only be called from the same thread that created the registry.</span><span>
</span><span id="line-596"></span><span class="hs-comment">-- This is a no-op if the registry is already closed.</span><span>
</span><span id="line-597"></span><span class="hs-comment">--</span><span>
</span><span id="line-598"></span><span class="hs-comment">-- This entire function runs with exceptions masked, so that we are not</span><span>
</span><span id="line-599"></span><span class="hs-comment">-- interrupted while we release all resources.</span><span>
</span><span id="line-600"></span><span class="hs-comment">--</span><span>
</span><span id="line-601"></span><span class="hs-comment">-- Resources will be allocated from young to old, so that resources allocated</span><span>
</span><span id="line-602"></span><span class="hs-comment">-- later can safely refer to resources created earlier.</span><span>
</span><span id="line-603"></span><span class="hs-comment">--</span><span>
</span><span id="line-604"></span><span class="hs-comment">-- The release functions are run in the scope of an exception handler, so that</span><span>
</span><span id="line-605"></span><span class="hs-comment">-- if releasing one resource throws an exception, we still attempt to release</span><span>
</span><span id="line-606"></span><span class="hs-comment">-- the other resources. Should we catch an exception whilst we close the</span><span>
</span><span id="line-607"></span><span class="hs-comment">-- registry, we will rethrow it after having attempted to release all resources.</span><span>
</span><span id="line-608"></span><span class="hs-comment">-- If there is more than one, we will pick a random one to rethrow, though we</span><span>
</span><span id="line-609"></span><span class="hs-comment">-- will prioritize asynchronous exceptions over other exceptions. This may be</span><span>
</span><span id="line-610"></span><span class="hs-comment">-- important for exception handlers that catch all-except-asynchronous</span><span>
</span><span id="line-611"></span><span class="hs-comment">-- exceptions.</span><span>
</span><span id="line-612"></span><span id="local-6989586621679081591"><span class="annot"><a href="Control.ResourceRegistry.html#closeRegistry"><span class="hs-identifier hs-type">closeRegistry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-613"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081591"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081591"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081591"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081591"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-615"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081591"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-616"></span><span id="closeRegistry"><span class="annot"><span class="annottext">closeRegistry :: forall (m :: * -&gt; *).
(MonadMask m, MonadThread m, MonadSTM m, HasCallStack) =&gt;
ResourceRegistry m -&gt; m ()
</span><a href="Control.ResourceRegistry.html#closeRegistry"><span class="hs-identifier hs-var hs-var">closeRegistry</span></a></span></span><span> </span><span id="local-6989586621679082777"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082777"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall a. m a -&gt; m a
forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-617"></span><span>    </span><span id="local-6989586621679082779"><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679082779"><span class="hs-identifier hs-var">context</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Context m)
forall (m :: * -&gt; *).
(MonadThread m, HasCallStack) =&gt;
m (Context m)
</span><a href="Control.ResourceRegistry.html#captureContext"><span class="hs-identifier hs-var">captureContext</span></a></span><span>
</span><span id="line-618"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context m -&gt; ThreadId m
forall (m :: * -&gt; *). Context m -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#contextThreadId"><span class="hs-identifier hs-var">contextThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679082779"><span class="hs-identifier hs-var">context</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; ThreadId m -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Context m -&gt; ThreadId m
forall (m :: * -&gt; *). Context m -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#contextThreadId"><span class="hs-identifier hs-var">contextThreadId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; Context m
forall (m :: * -&gt; *). ResourceRegistry m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#registryContext"><span class="hs-identifier hs-var">registryContext</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082777"><span class="hs-identifier hs-var">rr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-619"></span><span>      </span><span class="annot"><span class="annottext">ResourceRegistryThreadException -&gt; m ()
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(ResourceRegistryThreadException -&gt; m ())
-&gt; ResourceRegistryThreadException -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistryClosedFromWrongThread"><span class="hs-identifier hs-type">ResourceRegistryClosedFromWrongThread</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-620"></span><span>          </span><span class="annot"><span class="annottext">resourceRegistryCreatedIn :: Context m
</span><a href="Control.ResourceRegistry.html#resourceRegistryCreatedIn"><span class="hs-identifier hs-var">resourceRegistryCreatedIn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; Context m
forall (m :: * -&gt; *). ResourceRegistry m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#registryContext"><span class="hs-identifier hs-var">registryContext</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082777"><span class="hs-identifier hs-var">rr</span></a></span><span>
</span><span id="line-621"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">resourceRegistryUsedIn :: Context m
</span><a href="Control.ResourceRegistry.html#resourceRegistryUsedIn"><span class="hs-identifier hs-var">resourceRegistryUsedIn</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679082779"><span class="hs-identifier hs-var">context</span></a></span><span>
</span><span id="line-622"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-623"></span><span>
</span><span id="line-624"></span><span>    </span><span class="hs-comment">-- Close the registry so that we cannot allocate any further resources</span><span>
</span><span id="line-625"></span><span>    </span><span id="local-6989586621679082786"><span class="annot"><span class="annottext">Either PrettyCallStack [ResourceId]
</span><a href="#local-6989586621679082786"><span class="hs-identifier hs-var">alreadyClosed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId])
-&gt; m (Either PrettyCallStack [ResourceId])
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
ResourceRegistry m -&gt; State (RegistryState m) a -&gt; m a
</span><a href="Control.ResourceRegistry.html#updateState"><span class="hs-identifier hs-var">updateState</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082777"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">(State (RegistryState m) (Either PrettyCallStack [ResourceId])
 -&gt; m (Either PrettyCallStack [ResourceId]))
-&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId])
-&gt; m (Either PrettyCallStack [ResourceId])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyCallStack
-&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId])
forall (m :: * -&gt; *).
PrettyCallStack
-&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId])
</span><a href="Control.ResourceRegistry.html#close"><span class="hs-identifier hs-var">close</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context m -&gt; PrettyCallStack
forall (m :: * -&gt; *). Context m -&gt; PrettyCallStack
</span><a href="Control.ResourceRegistry.html#contextCallStack"><span class="hs-identifier hs-var">contextCallStack</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679082779"><span class="hs-identifier hs-var">context</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either PrettyCallStack [ResourceId]
</span><a href="#local-6989586621679082786"><span class="hs-identifier hs-var">alreadyClosed</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-627"></span><span>      </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyCallStack
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-628"></span><span>        </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>      </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679082788"><span class="annot"><span class="annottext">[ResourceId]
</span><a href="#local-6989586621679082788"><span class="hs-identifier hs-var">keys</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-630"></span><span>        </span><span class="hs-comment">-- At this point we have not /removed/ any elements from the map,</span><span>
</span><span id="line-631"></span><span>        </span><span class="hs-comment">-- allowing concurrent threads to do their own cleanup of resources</span><span>
</span><span id="line-632"></span><span>        </span><span class="hs-comment">-- (this may for instance be important if a thread deallocates its</span><span>
</span><span id="line-633"></span><span>        </span><span class="hs-comment">-- resources in a particular order -- note that cancelling a thread</span><span>
</span><span id="line-634"></span><span>        </span><span class="hs-comment">-- is a synchronous operation, so we will wait for it to finish</span><span>
</span><span id="line-635"></span><span>        </span><span class="hs-comment">-- releasing its resources.)</span><span>
</span><span id="line-636"></span><span>        </span><span class="hs-comment">-- /If/ a concurrent thread does some cleanup, then some of the calls</span><span>
</span><span id="line-637"></span><span>        </span><span class="hs-comment">-- to 'release' that we do here might be no-ops.</span><span>
</span><span id="line-638"></span><span>       </span><span class="annot"><span class="annottext">m [Context m] -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m [Context m] -&gt; m ()) -&gt; m [Context m] -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; [ResourceId]
-&gt; (ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; m [Context m]
forall (m :: * -&gt; *).
MonadCatch m =&gt;
ResourceRegistry m
-&gt; [ResourceId]
-&gt; (ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; m [Context m]
</span><a href="Control.ResourceRegistry.html#releaseResources"><span class="hs-identifier hs-var">releaseResources</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082777"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">[ResourceId]
</span><a href="#local-6989586621679082788"><span class="hs-identifier hs-var">keys</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceKey m -&gt; m (Maybe (Context m))
forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m, MonadThread m, HasCallStack) =&gt;
ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="Control.ResourceRegistry.html#release"><span class="hs-identifier hs-var">release</span></a></span><span>
</span><span id="line-639"></span><span>
</span><span id="line-640"></span><span class="hs-comment">-- | Helper for 'closeRegistry', 'releaseAll', and 'unsafeReleaseAll': release</span><span>
</span><span id="line-641"></span><span class="hs-comment">-- the resources allocated with the given 'ResourceId's.</span><span>
</span><span id="line-642"></span><span class="hs-comment">--</span><span>
</span><span id="line-643"></span><span class="hs-comment">-- Returns the contexts of the resources that were actually released.</span><span>
</span><span id="line-644"></span><span id="local-6989586621679081608"><span class="annot"><a href="Control.ResourceRegistry.html#releaseResources"><span class="hs-identifier hs-type">releaseResources</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-645"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679081608"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-646"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081608"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-647"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-648"></span><span>     </span><span class="hs-comment">-- ^ PRECONDITION: The currently allocated keys,</span><span>
</span><span id="line-649"></span><span>     </span><span class="hs-comment">-- youngest-to-oldest</span><span>
</span><span id="line-650"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-type">ResourceKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081608"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081608"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081608"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-651"></span><span>     </span><span class="hs-comment">-- ^ How to release the resource, e.g., 'release' or</span><span>
</span><span id="line-652"></span><span>     </span><span class="hs-comment">-- 'unsafeRelease'.</span><span>
</span><span id="line-653"></span><span>  </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="annot"><a href="#local-6989586621679081608"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081608"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-654"></span><span id="releaseResources"><span class="annot"><span class="annottext">releaseResources :: forall (m :: * -&gt; *).
MonadCatch m =&gt;
ResourceRegistry m
-&gt; [ResourceId]
-&gt; (ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; m [Context m]
</span><a href="Control.ResourceRegistry.html#releaseResources"><span class="hs-identifier hs-var hs-var">releaseResources</span></a></span></span><span> </span><span id="local-6989586621679082813"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082813"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679082814"><span class="annot"><span class="annottext">[ResourceId]
</span><a href="#local-6989586621679082814"><span class="hs-identifier hs-var">sortedKeys</span></a></span></span><span> </span><span id="local-6989586621679082815"><span class="annot"><span class="annottext">ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="#local-6989586621679082815"><span class="hs-identifier hs-var">releaser</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-655"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679082816"><span class="annot"><span class="annottext">[SomeException]
</span><a href="#local-6989586621679082816"><span class="hs-identifier hs-var">exs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082817"><span class="annot"><span class="annottext">[Maybe (Context m)]
</span><a href="#local-6989586621679082817"><span class="hs-identifier hs-var">mbContexts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([Either SomeException (Maybe (Context m))]
 -&gt; ([SomeException], [Maybe (Context m)]))
-&gt; m [Either SomeException (Maybe (Context m))]
-&gt; m ([SomeException], [Maybe (Context m)])
forall a b. (a -&gt; b) -&gt; m a -&gt; m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">[Either SomeException (Maybe (Context m))]
-&gt; ([SomeException], [Maybe (Context m)])
forall a b. [Either a b] -&gt; ([a], [b])
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#partitionEithers"><span class="hs-identifier hs-var">partitionEithers</span></a></span><span> </span><span class="annot"><span class="annottext">(m [Either SomeException (Maybe (Context m))]
 -&gt; m ([SomeException], [Maybe (Context m)]))
-&gt; m [Either SomeException (Maybe (Context m))]
-&gt; m ([SomeException], [Maybe (Context m)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-656"></span><span>      </span><span class="annot"><span class="annottext">[ResourceId]
-&gt; (ResourceId -&gt; m (Either SomeException (Maybe (Context m))))
-&gt; m [Either SomeException (Maybe (Context m))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Traversable.html#forM"><span class="hs-identifier hs-var">forM</span></a></span><span> </span><span class="annot"><span class="annottext">[ResourceId]
</span><a href="#local-6989586621679082814"><span class="hs-identifier hs-var">sortedKeys</span></a></span><span> </span><span class="annot"><span class="annottext">((ResourceId -&gt; m (Either SomeException (Maybe (Context m))))
 -&gt; m [Either SomeException (Maybe (Context m))])
-&gt; (ResourceId -&gt; m (Either SomeException (Maybe (Context m))))
-&gt; m [Either SomeException (Maybe (Context m))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe (Context m))
-&gt; m (Either SomeException (Maybe (Context m)))
forall e a. Exception e =&gt; m a -&gt; m (Either e a)
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="annot"><span class="annottext">(m (Maybe (Context m))
 -&gt; m (Either SomeException (Maybe (Context m))))
-&gt; (ResourceId -&gt; m (Maybe (Context m)))
-&gt; ResourceId
-&gt; m (Either SomeException (Maybe (Context m)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="#local-6989586621679082815"><span class="hs-identifier hs-var">releaser</span></a></span><span> </span><span class="annot"><span class="annottext">(ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; (ResourceId -&gt; ResourceKey m)
-&gt; ResourceId
-&gt; m (Maybe (Context m))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; ResourceId -&gt; ResourceKey m
forall (m :: * -&gt; *).
ResourceRegistry m -&gt; ResourceId -&gt; ResourceKey m
</span><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-var">ResourceKey</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082813"><span class="hs-identifier hs-var">rr</span></a></span><span>
</span><span id="line-657"></span><span>
</span><span id="line-658"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[SomeException] -&gt; Maybe SomeException
</span><a href="#local-6989586621679082820"><span class="hs-identifier hs-var">prioritize</span></a></span><span> </span><span class="annot"><span class="annottext">[SomeException]
</span><a href="#local-6989586621679082816"><span class="hs-identifier hs-var">exs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-659"></span><span>      </span><span class="annot"><span class="annottext">Maybe SomeException
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Context m] -&gt; m [Context m]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Maybe (Context m)] -&gt; [Context m]
forall a. [Maybe a] -&gt; [a]
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#catMaybes"><span class="hs-identifier hs-var">catMaybes</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe (Context m)]
</span><a href="#local-6989586621679082817"><span class="hs-identifier hs-var">mbContexts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-660"></span><span>      </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679082821"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679082821"><span class="hs-identifier hs-var">e</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m [Context m]
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679082821"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-661"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-662"></span><span>    </span><span class="annot"><a href="#local-6989586621679082820"><span class="hs-identifier hs-type">prioritize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Exception.Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Exception.Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span>
</span><span id="line-663"></span><span>    </span><span id="local-6989586621679082820"><span class="annot"><span class="annottext">prioritize :: [SomeException] -&gt; Maybe SomeException
</span><a href="#local-6989586621679082820"><span class="hs-identifier hs-var hs-var">prioritize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-664"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679082822"><span class="annot"><span class="annottext">[SomeException]
</span><a href="#local-6989586621679082822"><span class="hs-identifier hs-var">asyncEx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082823"><span class="annot"><span class="annottext">[SomeException]
</span><a href="#local-6989586621679082823"><span class="hs-identifier hs-var">otherEx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[SomeException] -&gt; Maybe SomeException
forall a. [a] -&gt; Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#listToMaybe"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[SomeException]
</span><a href="#local-6989586621679082822"><span class="hs-identifier hs-var">asyncEx</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SomeException -&gt; Maybe SomeException -&gt; Maybe SomeException
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%7C%3E"><span class="hs-operator hs-var">&lt;|&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[SomeException] -&gt; Maybe SomeException
forall a. [a] -&gt; Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#listToMaybe"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[SomeException]
</span><a href="#local-6989586621679082823"><span class="hs-identifier hs-var">otherEx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-665"></span><span>        </span><span class="annot"><span class="annottext">(([SomeException], [SomeException]) -&gt; Maybe SomeException)
-&gt; ([SomeException] -&gt; ([SomeException], [SomeException]))
-&gt; [SomeException]
-&gt; Maybe SomeException
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">([Maybe SomeException] -&gt; [SomeException])
-&gt; ([Maybe SomeException], [SomeException])
-&gt; ([SomeException], [SomeException])
forall a b c. (a -&gt; b) -&gt; (a, c) -&gt; (b, c)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Bifunctor.html#first"><span class="hs-identifier hs-var">first</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe SomeException] -&gt; [SomeException]
forall a. [Maybe a] -&gt; [a]
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#catMaybes"><span class="hs-identifier hs-var">catMaybes</span></a></span><span>
</span><span id="line-666"></span><span>        </span><span class="annot"><span class="annottext">(([Maybe SomeException], [SomeException])
 -&gt; ([SomeException], [SomeException]))
-&gt; ([SomeException] -&gt; ([Maybe SomeException], [SomeException]))
-&gt; [SomeException]
-&gt; ([SomeException], [SomeException])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[(Maybe SomeException, SomeException)]
-&gt; ([Maybe SomeException], [SomeException])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a></span><span>
</span><span id="line-667"></span><span>        </span><span class="annot"><span class="annottext">([(Maybe SomeException, SomeException)]
 -&gt; ([Maybe SomeException], [SomeException]))
-&gt; ([SomeException] -&gt; [(Maybe SomeException, SomeException)])
-&gt; [SomeException]
-&gt; ([Maybe SomeException], [SomeException])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; (Maybe SomeException, SomeException))
-&gt; [SomeException] -&gt; [(Maybe SomeException, SomeException)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679082826"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679082826"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; Maybe SomeException
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.Exception.html#asyncExceptionFromException"><span class="hs-identifier hs-var">asyncExceptionFromException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679082826"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679082826"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-668"></span><span>
</span><span id="line-669"></span><span class="hs-comment">-- | Create a new registry</span><span>
</span><span id="line-670"></span><span class="hs-comment">--</span><span>
</span><span id="line-671"></span><span class="hs-comment">-- See documentation of 'ResourceRegistry' for a detailed discussion.</span><span>
</span><span id="line-672"></span><span id="local-6989586621679081636"><span id="local-6989586621679081637"><span class="annot"><a href="Control.ResourceRegistry.html#withRegistry"><span class="hs-identifier hs-type">withRegistry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-673"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081636"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081636"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081636"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-674"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081636"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081636"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081637"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-675"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081636"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081637"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-676"></span><span id="withRegistry"><span class="annot"><span class="annottext">withRegistry :: forall (m :: * -&gt; *) a.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
(ResourceRegistry m -&gt; m a) -&gt; m a
</span><a href="Control.ResourceRegistry.html#withRegistry"><span class="hs-identifier hs-var hs-var">withRegistry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (ResourceRegistry m)
-&gt; (ResourceRegistry m -&gt; m ())
-&gt; (ResourceRegistry m -&gt; m a)
-&gt; m a
forall a b c. m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
forall (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="annot"><span class="annottext">m (ResourceRegistry m)
forall (m :: * -&gt; *).
(MonadSTM m, MonadThread m, HasCallStack) =&gt;
m (ResourceRegistry m)
</span><a href="Control.ResourceRegistry.html#unsafeNewRegistry"><span class="hs-identifier hs-var">unsafeNewRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; m ()
forall (m :: * -&gt; *).
(MonadMask m, MonadThread m, MonadSTM m, HasCallStack) =&gt;
ResourceRegistry m -&gt; m ()
</span><a href="Control.ResourceRegistry.html#closeRegistry"><span class="hs-identifier hs-var">closeRegistry</span></a></span><span>
</span><span id="line-677"></span><span>
</span><span id="line-678"></span><span class="hs-comment">-- | Create a new private registry for use by a bracketed resource</span><span>
</span><span id="line-679"></span><span class="hs-comment">--</span><span>
</span><span id="line-680"></span><span class="hs-comment">-- Use this combinator as a more specific and easier-to-maintain alternative to</span><span>
</span><span id="line-681"></span><span class="hs-comment">-- the following.</span><span>
</span><span id="line-682"></span><span class="hs-comment">--</span><span>
</span><span id="line-683"></span><span class="hs-comment">-- &gt; 'withRegistry' $ \rr -&gt;</span><span>
</span><span id="line-684"></span><span class="hs-comment">-- &gt;   'bracket' (newFoo rr) closeFoo $ \foo -&gt;</span><span>
</span><span id="line-685"></span><span class="hs-comment">-- &gt;     (... rr does not occur in this scope ...)</span><span>
</span><span id="line-686"></span><span class="hs-comment">--</span><span>
</span><span id="line-687"></span><span class="hs-comment">-- NB The scoped body can use `withRegistry` if it also needs its own, separate</span><span>
</span><span id="line-688"></span><span class="hs-comment">-- registry.</span><span>
</span><span id="line-689"></span><span class="hs-comment">--</span><span>
</span><span id="line-690"></span><span class="hs-comment">-- Use this combinator to emphasize that the registry is private to (ie only</span><span>
</span><span id="line-691"></span><span class="hs-comment">-- used by and/or via) the bracketed resource and that it thus has nearly the</span><span>
</span><span id="line-692"></span><span class="hs-comment">-- same lifetime. This combinator ensures the following specific invariants</span><span>
</span><span id="line-693"></span><span class="hs-comment">-- regarding lifetimes and order of releases.</span><span>
</span><span id="line-694"></span><span class="hs-comment">--</span><span>
</span><span id="line-695"></span><span class="hs-comment">-- o The registry itself is older than the bracketed resource.</span><span>
</span><span id="line-696"></span><span class="hs-comment">--</span><span>
</span><span id="line-697"></span><span class="hs-comment">-- o The only registered resources older than the bracketed resource were</span><span>
</span><span id="line-698"></span><span class="hs-comment">--   allocated in the registry by the function that allocated the bracketed</span><span>
</span><span id="line-699"></span><span class="hs-comment">--   resource.</span><span>
</span><span id="line-700"></span><span class="hs-comment">--</span><span>
</span><span id="line-701"></span><span class="hs-comment">-- o Because of the older resources, the bracketed resource is itself also</span><span>
</span><span id="line-702"></span><span class="hs-comment">--   registered in the registry; that's the only way we can be sure to release</span><span>
</span><span id="line-703"></span><span class="hs-comment">--   all resources in the right order.</span><span>
</span><span id="line-704"></span><span class="hs-comment">--</span><span>
</span><span id="line-705"></span><span class="hs-comment">-- NB Because the registry is private to the resource, the @a@ type could save</span><span>
</span><span id="line-706"></span><span class="hs-comment">-- the handle to @registry@ and safely close the registry if the scoped body</span><span>
</span><span id="line-707"></span><span class="hs-comment">-- calls @closeA@ before the bracket ends. Though we have not used the type</span><span>
</span><span id="line-708"></span><span class="hs-comment">-- system to guarantee that the interface of the @a@ type cannot leak the</span><span>
</span><span id="line-709"></span><span class="hs-comment">-- registry to the body, this combinator does its part to keep the registry</span><span>
</span><span id="line-710"></span><span class="hs-comment">-- private to the bracketed resource.</span><span>
</span><span id="line-711"></span><span class="hs-comment">--</span><span>
</span><span id="line-712"></span><span class="hs-comment">-- See documentation of 'ResourceRegistry' for a more general discussion.</span><span>
</span><span id="line-713"></span><span id="local-6989586621679081643"><span id="local-6989586621679081644"><span id="local-6989586621679081645"><span class="annot"><a href="Control.ResourceRegistry.html#bracketWithPrivateRegistry"><span class="hs-identifier hs-type">bracketWithPrivateRegistry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-714"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081643"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081643"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081643"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-715"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081643"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081643"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081644"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-716"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081644"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081643"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Release the resource</span></span><span>
</span><span id="line-717"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081644"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081643"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081645"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-718"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081643"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081645"><span class="hs-identifier hs-type">r</span></a></span></span></span></span><span>
</span><span id="line-719"></span><span id="bracketWithPrivateRegistry"><span class="annot"><span class="annottext">bracketWithPrivateRegistry :: forall (m :: * -&gt; *) a r.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
(ResourceRegistry m -&gt; m a) -&gt; (a -&gt; m ()) -&gt; (a -&gt; m r) -&gt; m r
</span><a href="Control.ResourceRegistry.html#bracketWithPrivateRegistry"><span class="hs-identifier hs-var hs-var">bracketWithPrivateRegistry</span></a></span></span><span> </span><span id="local-6989586621679082859"><span class="annot"><span class="annottext">ResourceRegistry m -&gt; m a
</span><a href="#local-6989586621679082859"><span class="hs-identifier hs-var">newA</span></a></span></span><span> </span><span id="local-6989586621679082860"><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679082860"><span class="hs-identifier hs-var">closeA</span></a></span></span><span> </span><span id="local-6989586621679082861"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679082861"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-720"></span><span>    </span><span class="annot"><span class="annottext">(ResourceRegistry m -&gt; m r) -&gt; m r
forall (m :: * -&gt; *) a.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
(ResourceRegistry m -&gt; m a) -&gt; m a
</span><a href="Control.ResourceRegistry.html#withRegistry"><span class="hs-identifier hs-var">withRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">((ResourceRegistry m -&gt; m r) -&gt; m r)
-&gt; (ResourceRegistry m -&gt; m r) -&gt; m r
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679082862"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082862"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-721"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679082863"><span class="annot"><span class="annottext">ResourceKey m
</span><a href="#local-6989586621679082863"><span class="hs-identifier hs-var">_key</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082864"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679082864"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; (ResourceId -&gt; m a) -&gt; (a -&gt; m ()) -&gt; m (ResourceKey m, a)
forall (m :: * -&gt; *) a.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
ResourceRegistry m
-&gt; (ResourceId -&gt; m a) -&gt; (a -&gt; m ()) -&gt; m (ResourceKey m, a)
</span><a href="Control.ResourceRegistry.html#allocate"><span class="hs-identifier hs-var">allocate</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082862"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679082865"><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679082865"><span class="hs-identifier hs-var">_key</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; m a
</span><a href="#local-6989586621679082859"><span class="hs-identifier hs-var">newA</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082862"><span class="hs-identifier hs-var">registry</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679082860"><span class="hs-identifier hs-var">closeA</span></a></span><span>
</span><span id="line-722"></span><span>      </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679082861"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679082864"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-723"></span><span>
</span><span id="line-724"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Temporary registry
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-727"></span><span>
</span><span id="line-728"></span><span class="hs-comment">-- | Run an action with a temporary resource registry.</span><span>
</span><span id="line-729"></span><span class="hs-comment">--</span><span>
</span><span id="line-730"></span><span class="hs-comment">-- When allocating resources that are meant to end up in some final state,</span><span>
</span><span id="line-731"></span><span class="hs-comment">-- e.g., stored in a 'Control.Monad.Class.MonadSTM.TVar', after which they are</span><span>
</span><span id="line-732"></span><span class="hs-comment">-- guaranteed to be released correctly, it is possible that an exception is</span><span>
</span><span id="line-733"></span><span class="hs-comment">-- thrown after allocating such a resource, but before it was stored in the</span><span>
</span><span id="line-734"></span><span class="hs-comment">-- final state. In that case, the resource would be leaked.</span><span>
</span><span id="line-735"></span><span class="hs-comment">-- 'runWithTempRegistry' solves that problem.</span><span>
</span><span id="line-736"></span><span class="hs-comment">--</span><span>
</span><span id="line-737"></span><span class="hs-comment">-- When no exception is thrown before the end of 'runWithTempRegistry', the</span><span>
</span><span id="line-738"></span><span class="hs-comment">-- user must have transferred all the resources it allocated to their final</span><span>
</span><span id="line-739"></span><span class="hs-comment">-- state. This means that these resources don't have to be released by the</span><span>
</span><span id="line-740"></span><span class="hs-comment">-- temporary registry anymore, the final state is now in charge of releasing</span><span>
</span><span id="line-741"></span><span class="hs-comment">-- them.</span><span>
</span><span id="line-742"></span><span class="hs-comment">--</span><span>
</span><span id="line-743"></span><span class="hs-comment">-- In case an exception is thrown before the end of 'runWithTempRegistry',</span><span>
</span><span id="line-744"></span><span class="hs-comment">-- /all/ resources allocated in the temporary registry will be released.</span><span>
</span><span id="line-745"></span><span class="hs-comment">--</span><span>
</span><span id="line-746"></span><span class="hs-comment">-- Resources must be allocated using 'allocateTemp'.</span><span>
</span><span id="line-747"></span><span class="hs-comment">--</span><span>
</span><span id="line-748"></span><span class="hs-comment">-- To make sure that the user doesn't forget to transfer a resource to the</span><span>
</span><span id="line-749"></span><span class="hs-comment">-- final state @st@, the user must pass a function to 'allocateTemp' that</span><span>
</span><span id="line-750"></span><span class="hs-comment">-- checks whether a given @st@ contains the resource, i.e., whether the</span><span>
</span><span id="line-751"></span><span class="hs-comment">-- resource was successfully transferred to its final destination.</span><span>
</span><span id="line-752"></span><span class="hs-comment">--</span><span>
</span><span id="line-753"></span><span class="hs-comment">-- When no exception is thrown before the end of 'runWithTempRegistry', we</span><span>
</span><span id="line-754"></span><span class="hs-comment">-- check whether all allocated resources have been transferred to the final</span><span>
</span><span id="line-755"></span><span class="hs-comment">-- state @st@. If there's a resource that hasn't been transferred to the final</span><span>
</span><span id="line-756"></span><span class="hs-comment">-- state /and/ that hasn't be released or closed before (see the release</span><span>
</span><span id="line-757"></span><span class="hs-comment">-- function passed to 'allocateTemp'), a 'TempRegistryRemainingResource'</span><span>
</span><span id="line-758"></span><span class="hs-comment">-- exception will be thrown.</span><span>
</span><span id="line-759"></span><span class="hs-comment">--</span><span>
</span><span id="line-760"></span><span class="hs-comment">-- For that reason, 'WithTempRegistry' is parameterised over the final state</span><span>
</span><span id="line-761"></span><span class="hs-comment">-- type @st@ and the given 'WithTempRegistry' action must return the final</span><span>
</span><span id="line-762"></span><span class="hs-comment">-- state.</span><span>
</span><span id="line-763"></span><span class="hs-comment">--</span><span>
</span><span id="line-764"></span><span class="hs-comment">-- NOTE: we explicitly don't let 'runWithTempRegistry' return the final state,</span><span>
</span><span id="line-765"></span><span class="hs-comment">-- because the state /must/ have been stored somewhere safely, transferring</span><span>
</span><span id="line-766"></span><span class="hs-comment">-- the resources, before the temporary registry is closed.</span><span>
</span><span id="line-767"></span><span id="local-6989586621679081651"><span id="local-6989586621679081652"><span id="local-6989586621679081653"><span class="annot"><a href="Control.ResourceRegistry.html#runWithTempRegistry"><span class="hs-identifier hs-type">runWithTempRegistry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-768"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081651"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081651"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081651"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-769"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081652"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081653"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679081652"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081653"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-771"></span><span id="runWithTempRegistry"><span class="annot"><span class="annottext">runWithTempRegistry :: forall (m :: * -&gt; *) st a.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
WithTempRegistry st m (a, st) -&gt; m a
</span><a href="Control.ResourceRegistry.html#runWithTempRegistry"><span class="hs-identifier hs-var hs-var">runWithTempRegistry</span></a></span></span><span> </span><span id="local-6989586621679082910"><span class="annot"><span class="annottext">WithTempRegistry st m (a, st)
</span><a href="#local-6989586621679082910"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ResourceRegistry m -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
(ResourceRegistry m -&gt; m a) -&gt; m a
</span><a href="Control.ResourceRegistry.html#withRegistry"><span class="hs-identifier hs-var">withRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">((ResourceRegistry m -&gt; m a) -&gt; m a)
-&gt; (ResourceRegistry m -&gt; m a) -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679082911"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082911"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-772"></span><span>    </span><span id="local-6989586621679082912"><span class="annot"><span class="annottext">StrictTVar m (TransferredTo st)
</span><a href="#local-6989586621679082912"><span class="hs-identifier hs-var">varTransferredTo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TransferredTo st -&gt; m (StrictTVar m (TransferredTo st))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TransferredTo st
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-773"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679082913"><span class="annot"><span class="annottext">tempRegistry :: TempRegistry st m
</span><a href="#local-6989586621679082913"><span class="hs-identifier hs-var hs-var">tempRegistry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#TempRegistry"><span class="hs-identifier hs-type">TempRegistry</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-774"></span><span>            </span><span class="annot"><span class="annottext">tempResourceRegistry :: ResourceRegistry m
</span><a href="Control.ResourceRegistry.html#tempResourceRegistry"><span class="hs-identifier hs-var">tempResourceRegistry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082911"><span class="hs-identifier hs-var">rr</span></a></span><span>
</span><span id="line-775"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tempTransferredTo :: StrictTVar m (TransferredTo st)
</span><a href="Control.ResourceRegistry.html#tempTransferredTo"><span class="hs-identifier hs-var">tempTransferredTo</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (TransferredTo st)
</span><a href="#local-6989586621679082912"><span class="hs-identifier hs-var">varTransferredTo</span></a></span><span>
</span><span id="line-776"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-777"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679082917"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679082917"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082918"><span class="annot"><span class="annottext">st
</span><a href="#local-6989586621679082918"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT (TempRegistry st m) m (a, st)
-&gt; TempRegistry st m -&gt; m (a, st)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Reader.html#runReaderT"><span class="hs-identifier hs-var">runReaderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithTempRegistry st m (a, st)
-&gt; ReaderT (TempRegistry st m) m (a, st)
forall st (m :: * -&gt; *) a.
WithTempRegistry st m a -&gt; ReaderT (TempRegistry st m) m a
</span><a href="Control.ResourceRegistry.html#unWithTempRegistry"><span class="hs-identifier hs-var">unWithTempRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">WithTempRegistry st m (a, st)
</span><a href="#local-6989586621679082910"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TempRegistry st m
</span><a href="#local-6989586621679082913"><span class="hs-identifier hs-var">tempRegistry</span></a></span><span>
</span><span id="line-778"></span><span>    </span><span class="hs-comment">-- We won't reach this point if an exception is thrown, so we won't check</span><span>
</span><span id="line-779"></span><span>    </span><span class="hs-comment">-- for remaining resources in that case.</span><span>
</span><span id="line-780"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-781"></span><span>    </span><span class="hs-comment">-- No need to mask here, whether we throw the async exception or</span><span>
</span><span id="line-782"></span><span>    </span><span class="hs-comment">-- 'TempRegistryRemainingResource' doesn't matter.</span><span>
</span><span id="line-783"></span><span>    </span><span id="local-6989586621679082921"><span class="annot"><span class="annottext">TransferredTo st
</span><a href="#local-6989586621679082921"><span class="hs-identifier hs-var">transferredTo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (TransferredTo st) -&gt; m (TransferredTo st)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; m a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (TransferredTo st)
</span><a href="#local-6989586621679082912"><span class="hs-identifier hs-var">varTransferredTo</span></a></span><span>
</span><span id="line-784"></span><span>    </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; TransferredTo st -&gt; st -&gt; m ()
forall (m :: * -&gt; *) st.
MonadSTM m =&gt;
ResourceRegistry m -&gt; TransferredTo st -&gt; st -&gt; m ()
</span><a href="Control.ResourceRegistry.html#untrackTransferredTo"><span class="hs-identifier hs-var">untrackTransferredTo</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082911"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">TransferredTo st
</span><a href="#local-6989586621679082921"><span class="hs-identifier hs-var">transferredTo</span></a></span><span> </span><span class="annot"><span class="annottext">st
</span><a href="#local-6989586621679082918"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-785"></span><span>
</span><span id="line-786"></span><span>    </span><span id="local-6989586621679082924"><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679082924"><span class="hs-identifier hs-var">context</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Context m)
forall (m :: * -&gt; *).
(MonadThread m, HasCallStack) =&gt;
m (Context m)
</span><a href="Control.ResourceRegistry.html#captureContext"><span class="hs-identifier hs-var">captureContext</span></a></span><span>
</span><span id="line-787"></span><span>    </span><span id="local-6989586621679082925"><span class="annot"><span class="annottext">[Context m]
</span><a href="#local-6989586621679082925"><span class="hs-identifier hs-var">remainingResources</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; Context m
-&gt; (ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; m [Context m]
forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m, MonadThread m) =&gt;
ResourceRegistry m
-&gt; Context m
-&gt; (ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; m [Context m]
</span><a href="Control.ResourceRegistry.html#releaseAllHelper"><span class="hs-identifier hs-var">releaseAllHelper</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082911"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679082924"><span class="hs-identifier hs-var">context</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceKey m -&gt; m (Maybe (Context m))
forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m, MonadThread m, HasCallStack) =&gt;
ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="Control.ResourceRegistry.html#release"><span class="hs-identifier hs-var">release</span></a></span><span>
</span><span id="line-788"></span><span>
</span><span id="line-789"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Context m) -&gt; (Context m -&gt; m ()) -&gt; m ()
forall {f :: * -&gt; *} {t}.
Applicative f =&gt;
Maybe t -&gt; (t -&gt; f ()) -&gt; f ()
</span><a href="#local-6989586621679082927"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Context m] -&gt; Maybe (Context m)
forall a. [a] -&gt; Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#listToMaybe"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[Context m]
</span><a href="#local-6989586621679082925"><span class="hs-identifier hs-var">remainingResources</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Context m -&gt; m ()) -&gt; m ()) -&gt; (Context m -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679082928"><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679082928"><span class="hs-identifier hs-var">remainingResource</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-790"></span><span>      </span><span class="annot"><span class="annottext">TempRegistryException -&gt; m ()
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(TempRegistryException -&gt; m ()) -&gt; TempRegistryException -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#TempRegistryRemainingResource"><span class="hs-identifier hs-type">TempRegistryRemainingResource</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-791"></span><span>          </span><span class="annot"><span class="annottext">tempRegistryContext :: Context m
</span><a href="Control.ResourceRegistry.html#tempRegistryContext"><span class="hs-identifier hs-var">tempRegistryContext</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; Context m
forall (m :: * -&gt; *). ResourceRegistry m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#registryContext"><span class="hs-identifier hs-var">registryContext</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679082911"><span class="hs-identifier hs-var">rr</span></a></span><span>
</span><span id="line-792"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tempRegistryResource :: Context m
</span><a href="Control.ResourceRegistry.html#tempRegistryResource"><span class="hs-identifier hs-var">tempRegistryResource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679082928"><span class="hs-identifier hs-var">remainingResource</span></a></span><span>
</span><span id="line-793"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-794"></span><span>    </span><span class="annot"><span class="annottext">a -&gt; m a
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679082917"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-795"></span><span>
</span><span id="line-796"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-797"></span><span>        </span><span id="local-6989586621679082927"><span class="annot"><span class="annottext">whenJust :: Maybe t -&gt; (t -&gt; f ()) -&gt; f ()
</span><a href="#local-6989586621679082927"><span class="hs-identifier hs-var hs-var">whenJust</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679082935"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679082935"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679082936"><span class="annot"><span class="annottext">t -&gt; f ()
</span><a href="#local-6989586621679082936"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; f ()
</span><a href="#local-6989586621679082936"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679082935"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-798"></span><span>        </span><span class="annot"><a href="#local-6989586621679082927"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe t
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; f ()
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; f ()
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-799"></span><span>
</span><span id="line-800"></span><span class="hs-comment">-- | Embed a self-contained 'WithTempRegistry' computation into a larger one.</span><span>
</span><span id="line-801"></span><span class="hs-comment">--</span><span>
</span><span id="line-802"></span><span class="hs-comment">-- The internal 'WithTempRegistry' is effectively passed to</span><span>
</span><span id="line-803"></span><span class="hs-comment">-- 'runWithTempRegistry'. It therefore must have no dangling resources, for</span><span>
</span><span id="line-804"></span><span class="hs-comment">-- example. This is the meaning of /self-contained/ above.</span><span>
</span><span id="line-805"></span><span class="hs-comment">--</span><span>
</span><span id="line-806"></span><span class="hs-comment">-- The key difference beyond 'runWithTempRegistry' is that the resulting</span><span>
</span><span id="line-807"></span><span class="hs-comment">-- composite resource is also guaranteed to be registered in the outer</span><span>
</span><span id="line-808"></span><span class="hs-comment">-- 'WithTempRegistry' computation's registry once the inner registry is closed.</span><span>
</span><span id="line-809"></span><span class="hs-comment">-- Combined with the following assumption, this establishes the invariant that</span><span>
</span><span id="line-810"></span><span class="hs-comment">-- all resources are (transitively) in a temporary registry.</span><span>
</span><span id="line-811"></span><span class="hs-comment">--</span><span>
</span><span id="line-812"></span><span class="hs-comment">-- As the resource might require some implementation details to be closed, the</span><span>
</span><span id="line-813"></span><span class="hs-comment">-- function to close it will also be provided by the inner computation.</span><span>
</span><span id="line-814"></span><span class="hs-comment">--</span><span>
</span><span id="line-815"></span><span class="hs-comment">-- ASSUMPTION: closing @res@ closes every resource contained in @innerSt@</span><span>
</span><span id="line-816"></span><span class="hs-comment">--</span><span>
</span><span id="line-817"></span><span class="hs-comment">-- NOTE: In the current implementation, there will be a brief moment where the</span><span>
</span><span id="line-818"></span><span class="hs-comment">-- inner registry still contains the inner computation's resources and also the</span><span>
</span><span id="line-819"></span><span class="hs-comment">-- outer registry simultaneously contains the new composite resource. If an</span><span>
</span><span id="line-820"></span><span class="hs-comment">-- async exception is received at that time, then the inner resources will be</span><span>
</span><span id="line-821"></span><span class="hs-comment">-- closed and then the composite resource will be closed. This means there's a</span><span>
</span><span id="line-822"></span><span class="hs-comment">-- risk of /double freeing/, which can be harmless if anticipated.</span><span>
</span><span id="line-823"></span><span class="annot"><a href="Control.ResourceRegistry.html#runInnerWithTempRegistry"><span class="hs-identifier hs-type">runInnerWithTempRegistry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-824"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679081679"><span class="annot"><a href="#local-6989586621679081679"><span class="hs-identifier hs-type">innerSt</span></a></span></span><span> </span><span id="local-6989586621679081682"><span class="annot"><a href="#local-6989586621679081682"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679081678"><span class="annot"><a href="#local-6989586621679081678"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679081681"><span class="annot"><a href="#local-6989586621679081681"><span class="hs-identifier hs-type">res</span></a></span></span><span> </span><span id="local-6989586621679081680"><span class="annot"><a href="#local-6989586621679081680"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-825"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081678"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081678"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081678"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-826"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081679"><span class="hs-identifier hs-type">innerSt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081678"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081680"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679081679"><span class="hs-identifier hs-type">innerSt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679081681"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-827"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ The embedded computation; see ASSUMPTION above</span></span><span>
</span><span id="line-828"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081681"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081678"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-829"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ How to free; same as for 'allocateTemp'</span></span><span>
</span><span id="line-830"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081682"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081681"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-831"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ How to check; same as for 'allocateTemp'</span></span><span>
</span><span id="line-832"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081682"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081678"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081680"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-833"></span><span id="runInnerWithTempRegistry"><span class="annot"><span class="annottext">runInnerWithTempRegistry :: forall innerSt st (m :: * -&gt; *) res a.
(MonadSTM m, MonadMask m, MonadThread m) =&gt;
WithTempRegistry innerSt m (a, innerSt, res)
-&gt; (res -&gt; m Bool)
-&gt; (st -&gt; res -&gt; Bool)
-&gt; WithTempRegistry st m a
</span><a href="Control.ResourceRegistry.html#runInnerWithTempRegistry"><span class="hs-identifier hs-var hs-var">runInnerWithTempRegistry</span></a></span></span><span> </span><span id="local-6989586621679082964"><span class="annot"><span class="annottext">WithTempRegistry innerSt m (a, innerSt, res)
</span><a href="#local-6989586621679082964"><span class="hs-identifier hs-var">inner</span></a></span></span><span> </span><span id="local-6989586621679082965"><span class="annot"><span class="annottext">res -&gt; m Bool
</span><a href="#local-6989586621679082965"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span id="local-6989586621679082966"><span class="annot"><span class="annottext">st -&gt; res -&gt; Bool
</span><a href="#local-6989586621679082966"><span class="hs-identifier hs-var">isTransferred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-834"></span><span>    </span><span id="local-6989586621679082967"><span class="annot"><span class="annottext">TempRegistry st m
</span><a href="#local-6989586621679082967"><span class="hs-identifier hs-var">outerTR</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT (TempRegistry st m) m (TempRegistry st m)
-&gt; WithTempRegistry st m (TempRegistry st m)
forall st (m :: * -&gt; *) a.
ReaderT (TempRegistry st m) m a -&gt; WithTempRegistry st m a
</span><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-var">WithTempRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT (TempRegistry st m) m (TempRegistry st m)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.Reader.Class.html#ask"><span class="hs-identifier hs-var">ask</span></a></span><span>
</span><span id="line-835"></span><span>
</span><span id="line-836"></span><span>    </span><span class="annot"><span class="annottext">m a -&gt; WithTempRegistry st m a
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; WithTempRegistry st m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m a -&gt; WithTempRegistry st m a) -&gt; m a -&gt; WithTempRegistry st m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WithTempRegistry innerSt m (a, innerSt) -&gt; m a
forall (m :: * -&gt; *) st a.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
WithTempRegistry st m (a, st) -&gt; m a
</span><a href="Control.ResourceRegistry.html#runWithTempRegistry"><span class="hs-identifier hs-var">runWithTempRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry innerSt m (a, innerSt) -&gt; m a)
-&gt; WithTempRegistry innerSt m (a, innerSt) -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-837"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679082970"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679082970"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082971"><span class="annot"><span class="annottext">innerSt
</span><a href="#local-6989586621679082971"><span class="hs-identifier hs-var">innerSt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679082972"><span class="annot"><span class="annottext">res
</span><a href="#local-6989586621679082972"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WithTempRegistry innerSt m (a, innerSt, res)
</span><a href="#local-6989586621679082964"><span class="hs-identifier hs-var">inner</span></a></span><span>
</span><span id="line-838"></span><span>
</span><span id="line-839"></span><span>      </span><span class="hs-comment">-- Allocate in the outer layer.</span><span>
</span><span id="line-840"></span><span>      </span><span class="annot"><span class="annottext">res
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span>   </span><span class="annot"><span class="annottext">TempRegistry st m
-&gt; WithTempRegistry st m res -&gt; WithTempRegistry innerSt m res
</span><a href="#local-6989586621679082973"><span class="hs-identifier hs-var">withFixedTempRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">TempRegistry st m
</span><a href="#local-6989586621679082967"><span class="hs-identifier hs-var">outerTR</span></a></span><span>
</span><span id="line-841"></span><span>           </span><span class="annot"><span class="annottext">(WithTempRegistry st m res -&gt; WithTempRegistry innerSt m res)
-&gt; WithTempRegistry st m res -&gt; WithTempRegistry innerSt m res
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m res
-&gt; (res -&gt; m Bool)
-&gt; (st -&gt; res -&gt; Bool)
-&gt; WithTempRegistry st m res
forall (m :: * -&gt; *) a st.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
m a
-&gt; (a -&gt; m Bool) -&gt; (st -&gt; a -&gt; Bool) -&gt; WithTempRegistry st m a
</span><a href="Control.ResourceRegistry.html#allocateTemp"><span class="hs-identifier hs-var">allocateTemp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">res -&gt; m res
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">res
</span><a href="#local-6989586621679082972"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">res -&gt; m Bool
</span><a href="#local-6989586621679082965"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="annot"><span class="annottext">st -&gt; res -&gt; Bool
</span><a href="#local-6989586621679082966"><span class="hs-identifier hs-var">isTransferred</span></a></span><span>
</span><span id="line-842"></span><span>
</span><span id="line-843"></span><span>      </span><span class="hs-comment">-- TODO This point here is where an async exception could cause both the</span><span>
</span><span id="line-844"></span><span>      </span><span class="hs-comment">-- inner resources to be closed and the outer resource to be closed later.</span><span>
</span><span id="line-845"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-846"></span><span>      </span><span class="hs-comment">-- If we want to do better than that, we'll need a variant of</span><span>
</span><span id="line-847"></span><span>      </span><span class="hs-comment">-- 'runWithTempRegistry' that lets us perform some action with async</span><span>
</span><span id="line-848"></span><span>      </span><span class="hs-comment">-- exceptions masked &quot;at the same time&quot; it closes its registry.</span><span>
</span><span id="line-849"></span><span>
</span><span id="line-850"></span><span>      </span><span class="hs-comment">-- Note that everything in `inner` allocated via `allocateTemp` must</span><span>
</span><span id="line-851"></span><span>      </span><span class="hs-comment">-- either be closed or else present in `innerSt` by this point --</span><span>
</span><span id="line-852"></span><span>      </span><span class="hs-comment">-- `runWithTempRegistry` would have thrown if not.</span><span>
</span><span id="line-853"></span><span>      </span><span class="annot"><span class="annottext">(a, innerSt) -&gt; WithTempRegistry innerSt m (a, innerSt)
forall a. a -&gt; WithTempRegistry innerSt m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679082970"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">innerSt
</span><a href="#local-6989586621679082971"><span class="hs-identifier hs-var">innerSt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-854"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-855"></span><span>    </span><span class="annot"><a href="#local-6989586621679082973"><span class="hs-identifier hs-type">withFixedTempRegistry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-856"></span><span>           </span><span class="annot"><a href="Control.ResourceRegistry.html#TempRegistry"><span class="hs-identifier hs-type">TempRegistry</span></a></span><span>     </span><span class="annot"><a href="#local-6989586621679081682"><span class="hs-identifier hs-type">st</span></a></span><span>      </span><span class="annot"><a href="#local-6989586621679081678"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-857"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081682"><span class="hs-identifier hs-type">st</span></a></span><span>      </span><span class="annot"><a href="#local-6989586621679081678"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081681"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-858"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081679"><span class="hs-identifier hs-type">innerSt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081678"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081681"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-859"></span><span>    </span><span id="local-6989586621679082973"><span class="annot"><span class="annottext">withFixedTempRegistry :: TempRegistry st m
-&gt; WithTempRegistry st m res -&gt; WithTempRegistry innerSt m res
</span><a href="#local-6989586621679082973"><span class="hs-identifier hs-var hs-var">withFixedTempRegistry</span></a></span></span><span> </span><span id="local-6989586621679082974"><span class="annot"><span class="annottext">TempRegistry st m
</span><a href="#local-6989586621679082974"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Reader.html#ReaderT"><span class="hs-identifier hs-type">ReaderT</span></a></span><span> </span><span id="local-6989586621679082976"><span class="annot"><span class="annottext">TempRegistry st m -&gt; m res
</span><a href="#local-6989586621679082976"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-860"></span><span>      </span><span class="annot"><span class="annottext">ReaderT (TempRegistry innerSt m) m res
-&gt; WithTempRegistry innerSt m res
forall st (m :: * -&gt; *) a.
ReaderT (TempRegistry st m) m a -&gt; WithTempRegistry st m a
</span><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-var">WithTempRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT (TempRegistry innerSt m) m res
 -&gt; WithTempRegistry innerSt m res)
-&gt; ReaderT (TempRegistry innerSt m) m res
-&gt; WithTempRegistry innerSt m res
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(TempRegistry innerSt m -&gt; m res)
-&gt; ReaderT (TempRegistry innerSt m) m res
forall r (m :: * -&gt; *) a. (r -&gt; m a) -&gt; ReaderT r m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Reader.html#ReaderT"><span class="hs-identifier hs-var">ReaderT</span></a></span><span> </span><span class="annot"><span class="annottext">((TempRegistry innerSt m -&gt; m res)
 -&gt; ReaderT (TempRegistry innerSt m) m res)
-&gt; (TempRegistry innerSt m -&gt; m res)
-&gt; ReaderT (TempRegistry innerSt m) m res
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">TempRegistry innerSt m
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TempRegistry st m -&gt; m res
</span><a href="#local-6989586621679082976"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">TempRegistry st m
</span><a href="#local-6989586621679082974"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-861"></span><span>
</span><span id="line-862"></span><span class="hs-comment">-- | When 'runWithTempRegistry' exits successfully while there are still</span><span>
</span><span id="line-863"></span><span class="hs-comment">-- resources remaining in the temporary registry that haven't been transferred</span><span>
</span><span id="line-864"></span><span class="hs-comment">-- to the final state.</span><span>
</span><span id="line-865"></span><span class="hs-keyword">data</span><span> </span><span id="TempRegistryException"><span class="annot"><a href="Control.ResourceRegistry.html#TempRegistryException"><span class="hs-identifier hs-var">TempRegistryException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-866"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679082977"><span class="annot"><a href="#local-6989586621679082977"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679082977"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="TempRegistryRemainingResource"><span class="annot"><a href="Control.ResourceRegistry.html#TempRegistryRemainingResource"><span class="hs-identifier hs-var">TempRegistryRemainingResource</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-867"></span><span>        </span><span class="annot"><span class="hs-comment">-- | The context in which the temporary registry was created.</span></span><span>
</span><span id="line-868"></span><span>        </span><span id="tempRegistryContext"><span class="annot"><span class="annottext">()
</span><a href="Control.ResourceRegistry.html#tempRegistryContext"><span class="hs-identifier hs-var hs-var">tempRegistryContext</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082977"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-869"></span><span>
</span><span id="line-870"></span><span>        </span><span class="hs-comment">-- | The context in which the resource was allocated that was not</span><span>
</span><span id="line-871"></span><span>        </span><span class="hs-comment">-- transferred to the final state.</span><span>
</span><span id="line-872"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="tempRegistryResource"><span class="annot"><span class="annottext">()
</span><a href="Control.ResourceRegistry.html#tempRegistryResource"><span class="hs-identifier hs-var hs-var">tempRegistryResource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082977"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-873"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-874"></span><span>
</span><span id="line-875"></span><span id="local-6989586621679082979"><span id="local-6989586621679082981"><span id="local-6989586621679082985"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#TempRegistryException"><span class="hs-identifier hs-type">TempRegistryException</span></a></span></span></span></span><span>
</span><span id="line-876"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679082992"><span id="local-6989586621679082995"><span id="local-6989586621679082998"><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#TempRegistryException"><span class="hs-identifier hs-type">TempRegistryException</span></a></span></span></span></span><span>
</span><span id="line-877"></span><span>
</span><span id="line-878"></span><span class="hs-comment">-- | Given a final state, return the 'ResourceId's of the resources that have</span><span>
</span><span id="line-879"></span><span class="hs-comment">-- been /transferred to/ that state.</span><span>
</span><span id="line-880"></span><span class="hs-keyword">newtype</span><span> </span><span id="TransferredTo"><span class="annot"><a href="Control.ResourceRegistry.html#TransferredTo"><span class="hs-identifier hs-var">TransferredTo</span></a></span></span><span> </span><span id="local-6989586621679081708"><span class="annot"><a href="#local-6989586621679081708"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TransferredTo"><span class="annot"><a href="Control.ResourceRegistry.html#TransferredTo"><span class="hs-identifier hs-var">TransferredTo</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-881"></span><span>      </span><span id="runTransferredTo"><span class="annot"><span class="annottext">forall st. TransferredTo st -&gt; st -&gt; Set ResourceId
</span><a href="Control.ResourceRegistry.html#runTransferredTo"><span class="hs-identifier hs-var hs-var">runTransferredTo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679081708"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span>
</span><span id="line-882"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-883"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679083003"><span id="local-6989586621679083009"><span id="local-6989586621679083016"><span class="annot"><span class="annottext">NonEmpty (TransferredTo st) -&gt; TransferredTo st
TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st
(TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st)
-&gt; (NonEmpty (TransferredTo st) -&gt; TransferredTo st)
-&gt; (forall b.
    Integral b =&gt;
    b -&gt; TransferredTo st -&gt; TransferredTo st)
-&gt; Semigroup (TransferredTo st)
forall b. Integral b =&gt; b -&gt; TransferredTo st -&gt; TransferredTo st
forall st. NonEmpty (TransferredTo st) -&gt; TransferredTo st
forall st. TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st
forall a.
(a -&gt; a -&gt; a)
-&gt; (NonEmpty a -&gt; a)
-&gt; (forall b. Integral b =&gt; b -&gt; a -&gt; a)
-&gt; Semigroup a
forall st b.
Integral b =&gt;
b -&gt; TransferredTo st -&gt; TransferredTo st
$c&lt;&gt; :: forall st. TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st
&lt;&gt; :: TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st
$csconcat :: forall st. NonEmpty (TransferredTo st) -&gt; TransferredTo st
sconcat :: NonEmpty (TransferredTo st) -&gt; TransferredTo st
$cstimes :: forall st b.
Integral b =&gt;
b -&gt; TransferredTo st -&gt; TransferredTo st
stimes :: forall b. Integral b =&gt; b -&gt; TransferredTo st -&gt; TransferredTo st
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Semigroup"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Semigroup</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679083031"><span id="local-6989586621679083037"><span id="local-6989586621679083042"><span class="annot"><span class="annottext">Semigroup (TransferredTo st)
TransferredTo st
Semigroup (TransferredTo st) =&gt;
TransferredTo st
-&gt; (TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st)
-&gt; ([TransferredTo st] -&gt; TransferredTo st)
-&gt; Monoid (TransferredTo st)
[TransferredTo st] -&gt; TransferredTo st
TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st
forall st. Semigroup (TransferredTo st)
forall st. TransferredTo st
forall a.
Semigroup a =&gt;
a -&gt; (a -&gt; a -&gt; a) -&gt; ([a] -&gt; a) -&gt; Monoid a
forall st. [TransferredTo st] -&gt; TransferredTo st
forall st. TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st
$cmempty :: forall st. TransferredTo st
mempty :: TransferredTo st
$cmappend :: forall st. TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st
mappend :: TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st
$cmconcat :: forall st. [TransferredTo st] -&gt; TransferredTo st
mconcat :: [TransferredTo st] -&gt; TransferredTo st
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Monoid"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monoid</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-884"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679083052"><span id="local-6989586621679083057"><span id="local-6989586621679083062"><span class="annot"><span class="annottext">Context -&gt; TransferredTo st -&gt; IO (Maybe ThunkInfo)
Proxy (TransferredTo st) -&gt; String
(Context -&gt; TransferredTo st -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; TransferredTo st -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (TransferredTo st) -&gt; String)
-&gt; NoThunks (TransferredTo st)
forall st. Context -&gt; TransferredTo st -&gt; IO (Maybe ThunkInfo)
forall st. Proxy (TransferredTo st) -&gt; String
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
$cnoThunks :: forall st. Context -&gt; TransferredTo st -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; TransferredTo st -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall st. Context -&gt; TransferredTo st -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; TransferredTo st -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: forall st. Proxy (TransferredTo st) -&gt; String
showTypeOf :: Proxy (TransferredTo st) -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OnlyCheckWhnfNamed</span></span><span> </span><span class="annot"><span class="hs-string">&quot;TransferredTo&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#TransferredTo"><span class="hs-identifier hs-type">TransferredTo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081708"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-885"></span><span>
</span><span id="line-886"></span><span class="annot"><span class="hs-comment">-- | The environment used to run a 'WithTempRegistry' action.</span></span><span>
</span><span id="line-887"></span><span class="hs-keyword">data</span><span> </span><span id="TempRegistry"><span class="annot"><a href="Control.ResourceRegistry.html#TempRegistry"><span class="hs-identifier hs-var">TempRegistry</span></a></span></span><span> </span><span id="local-6989586621679081725"><span class="annot"><a href="#local-6989586621679081725"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679081726"><span class="annot"><a href="#local-6989586621679081726"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TempRegistry"><span class="annot"><a href="Control.ResourceRegistry.html#TempRegistry"><span class="hs-identifier hs-var">TempRegistry</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-888"></span><span>      </span><span id="tempResourceRegistry"><span class="annot"><span class="annottext">forall st (m :: * -&gt; *). TempRegistry st m -&gt; ResourceRegistry m
</span><a href="Control.ResourceRegistry.html#tempResourceRegistry"><span class="hs-identifier hs-var hs-var">tempResourceRegistry</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081726"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-889"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="tempTransferredTo"><span class="annot"><span class="annottext">forall st (m :: * -&gt; *).
TempRegistry st m -&gt; StrictTVar m (TransferredTo st)
</span><a href="Control.ResourceRegistry.html#tempTransferredTo"><span class="hs-identifier hs-var hs-var">tempTransferredTo</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679081726"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#TransferredTo"><span class="hs-identifier hs-type">TransferredTo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081725"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-890"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Used as a @Writer@.</span></span><span>
</span><span id="line-891"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-892"></span><span>
</span><span id="line-893"></span><span class="hs-comment">-- | An action with a temporary registry in scope, see 'runWithTempRegistry'</span><span>
</span><span id="line-894"></span><span class="hs-comment">-- for more details.</span><span>
</span><span id="line-895"></span><span class="hs-comment">--</span><span>
</span><span id="line-896"></span><span class="hs-comment">-- The most important function to run in this monad is 'allocateTemp'.</span><span>
</span><span id="line-897"></span><span class="hs-keyword">newtype</span><span> </span><span id="WithTempRegistry"><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-var">WithTempRegistry</span></a></span></span><span> </span><span id="local-6989586621679081667"><span class="annot"><a href="#local-6989586621679081667"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679081668"><span class="annot"><a href="#local-6989586621679081668"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679081669"><span class="annot"><a href="#local-6989586621679081669"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="WithTempRegistry"><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-var">WithTempRegistry</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-898"></span><span>      </span><span id="unWithTempRegistry"><span class="annot"><span class="annottext">forall st (m :: * -&gt; *) a.
WithTempRegistry st m a -&gt; ReaderT (TempRegistry st m) m a
</span><a href="Control.ResourceRegistry.html#unWithTempRegistry"><span class="hs-identifier hs-var hs-var">unWithTempRegistry</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Reader.html#ReaderT"><span class="hs-identifier hs-type">ReaderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#TempRegistry"><span class="hs-identifier hs-type">TempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081667"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081668"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679081668"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081669"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-899"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-900"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span> </span><span id="local-6989586621679083069"><span id="local-6989586621679083074"><span class="annot"><span class="annottext">(forall a b.
 (a -&gt; b) -&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m b)
-&gt; (forall a b.
    a -&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a)
-&gt; Functor (WithTempRegistry st m)
forall a b. a -&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
forall a b.
(a -&gt; b) -&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m b
forall st (m :: * -&gt; *) a b.
Functor m =&gt;
a -&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) a b.
Functor m =&gt;
(a -&gt; b) -&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
$cfmap :: forall st (m :: * -&gt; *) a b.
Functor m =&gt;
(a -&gt; b) -&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m b
fmap :: forall a b.
(a -&gt; b) -&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m b
$c&lt;$ :: forall st (m :: * -&gt; *) a b.
Functor m =&gt;
a -&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
&lt;$ :: forall a b. a -&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Functor"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></a></span></span></span><span>
</span><span id="line-901"></span><span>                   </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679083084"><span id="local-6989586621679083089"><span id="local-6989586621679083093"><span id="local-6989586621679083097"><span id="local-6989586621679083101"><span class="annot"><span class="annottext">Functor (WithTempRegistry st m)
Functor (WithTempRegistry st m) =&gt;
(forall a. a -&gt; WithTempRegistry st m a)
-&gt; (forall a b.
    WithTempRegistry st m (a -&gt; b)
    -&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c)
    -&gt; WithTempRegistry st m a
    -&gt; WithTempRegistry st m b
    -&gt; WithTempRegistry st m c)
-&gt; (forall a b.
    WithTempRegistry st m a
    -&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m b)
-&gt; (forall a b.
    WithTempRegistry st m a
    -&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a)
-&gt; Applicative (WithTempRegistry st m)
forall a. a -&gt; WithTempRegistry st m a
forall a b.
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
forall a b.
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m b
forall a b.
WithTempRegistry st m (a -&gt; b)
-&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m b
forall a b c.
(a -&gt; b -&gt; c)
-&gt; WithTempRegistry st m a
-&gt; WithTempRegistry st m b
-&gt; WithTempRegistry st m c
forall st (m :: * -&gt; *).
Applicative m =&gt;
Functor (WithTempRegistry st m)
forall st (m :: * -&gt; *) a.
Applicative m =&gt;
a -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) a b.
Applicative m =&gt;
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) a b.
Applicative m =&gt;
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m b
forall st (m :: * -&gt; *) a b.
Applicative m =&gt;
WithTempRegistry st m (a -&gt; b)
-&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m b
forall st (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; c)
-&gt; WithTempRegistry st m a
-&gt; WithTempRegistry st m b
-&gt; WithTempRegistry st m c
forall (f :: * -&gt; *).
Functor f =&gt;
(forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
$cpure :: forall st (m :: * -&gt; *) a.
Applicative m =&gt;
a -&gt; WithTempRegistry st m a
pure :: forall a. a -&gt; WithTempRegistry st m a
$c&lt;*&gt; :: forall st (m :: * -&gt; *) a b.
Applicative m =&gt;
WithTempRegistry st m (a -&gt; b)
-&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m b
&lt;*&gt; :: forall a b.
WithTempRegistry st m (a -&gt; b)
-&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m b
$cliftA2 :: forall st (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; c)
-&gt; WithTempRegistry st m a
-&gt; WithTempRegistry st m b
-&gt; WithTempRegistry st m c
liftA2 :: forall a b c.
(a -&gt; b -&gt; c)
-&gt; WithTempRegistry st m a
-&gt; WithTempRegistry st m b
-&gt; WithTempRegistry st m c
$c*&gt; :: forall st (m :: * -&gt; *) a b.
Applicative m =&gt;
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m b
*&gt; :: forall a b.
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m b
$c&lt;* :: forall st (m :: * -&gt; *) a b.
Applicative m =&gt;
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
&lt;* :: forall a b.
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Applicative"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></a></span></span></span></span></span></span><span>
</span><span id="line-902"></span><span>                   </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679083110"><span id="local-6989586621679083115"><span id="local-6989586621679083119"><span class="annot"><span class="annottext">Applicative (WithTempRegistry st m)
Applicative (WithTempRegistry st m) =&gt;
(forall a b.
 WithTempRegistry st m a
 -&gt; (a -&gt; WithTempRegistry st m b) -&gt; WithTempRegistry st m b)
-&gt; (forall a b.
    WithTempRegistry st m a
    -&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m b)
-&gt; (forall a. a -&gt; WithTempRegistry st m a)
-&gt; Monad (WithTempRegistry st m)
forall a. a -&gt; WithTempRegistry st m a
forall a b.
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m b
forall a b.
WithTempRegistry st m a
-&gt; (a -&gt; WithTempRegistry st m b) -&gt; WithTempRegistry st m b
forall st (m :: * -&gt; *).
Monad m =&gt;
Applicative (WithTempRegistry st m)
forall st (m :: * -&gt; *) a. Monad m =&gt; a -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) a b.
Monad m =&gt;
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m b
forall st (m :: * -&gt; *) a b.
Monad m =&gt;
WithTempRegistry st m a
-&gt; (a -&gt; WithTempRegistry st m b) -&gt; WithTempRegistry st m b
forall (m :: * -&gt; *).
Applicative m =&gt;
(forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
$c&gt;&gt;= :: forall st (m :: * -&gt; *) a b.
Monad m =&gt;
WithTempRegistry st m a
-&gt; (a -&gt; WithTempRegistry st m b) -&gt; WithTempRegistry st m b
&gt;&gt;= :: forall a b.
WithTempRegistry st m a
-&gt; (a -&gt; WithTempRegistry st m b) -&gt; WithTempRegistry st m b
$c&gt;&gt; :: forall st (m :: * -&gt; *) a b.
Monad m =&gt;
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m b
&gt;&gt; :: forall a b.
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m b
$creturn :: forall st (m :: * -&gt; *) a. Monad m =&gt; a -&gt; WithTempRegistry st m a
return :: forall a. a -&gt; WithTempRegistry st m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Monad"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></a></span></span></span></span><span>
</span><span id="line-903"></span><span>                   </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679083130"><span id="local-6989586621679083137"><span id="local-6989586621679083141"><span id="local-6989586621679083145"><span class="annot"><span class="annottext">Monad (WithTempRegistry st m)
Monad (WithTempRegistry st m) =&gt;
(forall e a. Exception e =&gt; e -&gt; WithTempRegistry st m a)
-&gt; (forall a b c.
    WithTempRegistry st m a
    -&gt; (a -&gt; WithTempRegistry st m b)
    -&gt; (a -&gt; WithTempRegistry st m c)
    -&gt; WithTempRegistry st m c)
-&gt; (forall a b c.
    WithTempRegistry st m a
    -&gt; WithTempRegistry st m b
    -&gt; WithTempRegistry st m c
    -&gt; WithTempRegistry st m c)
-&gt; (forall a b.
    WithTempRegistry st m a
    -&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a)
-&gt; MonadThrow (WithTempRegistry st m)
forall e a. Exception e =&gt; e -&gt; WithTempRegistry st m a
forall a b.
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
forall a b c.
WithTempRegistry st m a
-&gt; WithTempRegistry st m b
-&gt; WithTempRegistry st m c
-&gt; WithTempRegistry st m c
forall a b c.
WithTempRegistry st m a
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; (a -&gt; WithTempRegistry st m c)
-&gt; WithTempRegistry st m c
forall st (m :: * -&gt; *).
MonadThrow m =&gt;
Monad (WithTempRegistry st m)
forall st (m :: * -&gt; *) e a.
(MonadThrow m, Exception e) =&gt;
e -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) a b.
MonadThrow m =&gt;
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
WithTempRegistry st m a
-&gt; WithTempRegistry st m b
-&gt; WithTempRegistry st m c
-&gt; WithTempRegistry st m c
forall st (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
WithTempRegistry st m a
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; (a -&gt; WithTempRegistry st m c)
-&gt; WithTempRegistry st m c
forall (m :: * -&gt; *).
Monad m =&gt;
(forall e a. Exception e =&gt; e -&gt; m a)
-&gt; (forall a b c. m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c)
-&gt; (forall a b c. m a -&gt; m b -&gt; m c -&gt; m c)
-&gt; (forall a b. m a -&gt; m b -&gt; m a)
-&gt; MonadThrow m
$cthrowIO :: forall st (m :: * -&gt; *) e a.
(MonadThrow m, Exception e) =&gt;
e -&gt; WithTempRegistry st m a
throwIO :: forall e a. Exception e =&gt; e -&gt; WithTempRegistry st m a
$cbracket :: forall st (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
WithTempRegistry st m a
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; (a -&gt; WithTempRegistry st m c)
-&gt; WithTempRegistry st m c
bracket :: forall a b c.
WithTempRegistry st m a
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; (a -&gt; WithTempRegistry st m c)
-&gt; WithTempRegistry st m c
$cbracket_ :: forall st (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
WithTempRegistry st m a
-&gt; WithTempRegistry st m b
-&gt; WithTempRegistry st m c
-&gt; WithTempRegistry st m c
bracket_ :: forall a b c.
WithTempRegistry st m a
-&gt; WithTempRegistry st m b
-&gt; WithTempRegistry st m c
-&gt; WithTempRegistry st m c
$cfinally :: forall st (m :: * -&gt; *) a b.
MonadThrow m =&gt;
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
finally :: forall a b.
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadThrow</span></span></span></span></span></span><span>
</span><span id="line-904"></span><span>                   </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679083157"><span id="local-6989586621679083166"><span id="local-6989586621679083174"><span id="local-6989586621679083182"><span id="local-6989586621679083190"><span id="local-6989586621679083198"><span id="local-6989586621679083204"><span id="local-6989586621679083208"><span id="local-6989586621679083212"><span class="annot"><span class="annottext">MonadThrow (WithTempRegistry st m)
MonadThrow (WithTempRegistry st m) =&gt;
(forall e a.
 Exception e =&gt;
 WithTempRegistry st m a
 -&gt; (e -&gt; WithTempRegistry st m a) -&gt; WithTempRegistry st m a)
-&gt; (forall e b a.
    Exception e =&gt;
    (e -&gt; Maybe b)
    -&gt; WithTempRegistry st m a
    -&gt; (b -&gt; WithTempRegistry st m a)
    -&gt; WithTempRegistry st m a)
-&gt; (forall e a.
    Exception e =&gt;
    WithTempRegistry st m a -&gt; WithTempRegistry st m (Either e a))
-&gt; (forall e b a.
    Exception e =&gt;
    (e -&gt; Maybe b)
    -&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m (Either b a))
-&gt; (forall e a.
    Exception e =&gt;
    (e -&gt; WithTempRegistry st m a)
    -&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m a)
-&gt; (forall e b a.
    Exception e =&gt;
    (e -&gt; Maybe b)
    -&gt; (b -&gt; WithTempRegistry st m a)
    -&gt; WithTempRegistry st m a
    -&gt; WithTempRegistry st m a)
-&gt; (forall a b.
    WithTempRegistry st m a
    -&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a)
-&gt; (forall a b c.
    WithTempRegistry st m a
    -&gt; (a -&gt; WithTempRegistry st m b)
    -&gt; (a -&gt; WithTempRegistry st m c)
    -&gt; WithTempRegistry st m c)
-&gt; (forall a b c.
    WithTempRegistry st m a
    -&gt; (a -&gt; ExitCase b -&gt; WithTempRegistry st m c)
    -&gt; (a -&gt; WithTempRegistry st m b)
    -&gt; WithTempRegistry st m (b, c))
-&gt; MonadCatch (WithTempRegistry st m)
forall e a.
Exception e =&gt;
WithTempRegistry st m a -&gt; WithTempRegistry st m (Either e a)
forall e a.
Exception e =&gt;
WithTempRegistry st m a
-&gt; (e -&gt; WithTempRegistry st m a) -&gt; WithTempRegistry st m a
forall e a.
Exception e =&gt;
(e -&gt; WithTempRegistry st m a)
-&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m a
forall a b.
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
forall e b a.
Exception e =&gt;
(e -&gt; Maybe b)
-&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m (Either b a)
forall e b a.
Exception e =&gt;
(e -&gt; Maybe b)
-&gt; WithTempRegistry st m a
-&gt; (b -&gt; WithTempRegistry st m a)
-&gt; WithTempRegistry st m a
forall e b a.
Exception e =&gt;
(e -&gt; Maybe b)
-&gt; (b -&gt; WithTempRegistry st m a)
-&gt; WithTempRegistry st m a
-&gt; WithTempRegistry st m a
forall a b c.
WithTempRegistry st m a
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; (a -&gt; WithTempRegistry st m c)
-&gt; WithTempRegistry st m c
forall a b c.
WithTempRegistry st m a
-&gt; (a -&gt; ExitCase b -&gt; WithTempRegistry st m c)
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; WithTempRegistry st m (b, c)
forall st (m :: * -&gt; *).
MonadCatch m =&gt;
MonadThrow (WithTempRegistry st m)
forall st (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
WithTempRegistry st m a -&gt; WithTempRegistry st m (Either e a)
forall st (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
WithTempRegistry st m a
-&gt; (e -&gt; WithTempRegistry st m a) -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; WithTempRegistry st m a)
-&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) a b.
MonadCatch m =&gt;
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) e b a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; Maybe b)
-&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m (Either b a)
forall st (m :: * -&gt; *) e b a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; Maybe b)
-&gt; WithTempRegistry st m a
-&gt; (b -&gt; WithTempRegistry st m a)
-&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) e b a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; Maybe b)
-&gt; (b -&gt; WithTempRegistry st m a)
-&gt; WithTempRegistry st m a
-&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) a b c.
MonadCatch m =&gt;
WithTempRegistry st m a
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; (a -&gt; WithTempRegistry st m c)
-&gt; WithTempRegistry st m c
forall st (m :: * -&gt; *) a b c.
MonadCatch m =&gt;
WithTempRegistry st m a
-&gt; (a -&gt; ExitCase b -&gt; WithTempRegistry st m c)
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; WithTempRegistry st m (b, c)
forall (m :: * -&gt; *).
MonadThrow m =&gt;
(forall e a. Exception e =&gt; m a -&gt; (e -&gt; m a) -&gt; m a)
-&gt; (forall e b a.
    Exception e =&gt;
    (e -&gt; Maybe b) -&gt; m a -&gt; (b -&gt; m a) -&gt; m a)
-&gt; (forall e a. Exception e =&gt; m a -&gt; m (Either e a))
-&gt; (forall e b a.
    Exception e =&gt;
    (e -&gt; Maybe b) -&gt; m a -&gt; m (Either b a))
-&gt; (forall e a. Exception e =&gt; (e -&gt; m a) -&gt; m a -&gt; m a)
-&gt; (forall e b a.
    Exception e =&gt;
    (e -&gt; Maybe b) -&gt; (b -&gt; m a) -&gt; m a -&gt; m a)
-&gt; (forall a b. m a -&gt; m b -&gt; m a)
-&gt; (forall a b c. m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c)
-&gt; (forall a b c.
    m a -&gt; (a -&gt; ExitCase b -&gt; m c) -&gt; (a -&gt; m b) -&gt; m (b, c))
-&gt; MonadCatch m
$ccatch :: forall st (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
WithTempRegistry st m a
-&gt; (e -&gt; WithTempRegistry st m a) -&gt; WithTempRegistry st m a
catch :: forall e a.
Exception e =&gt;
WithTempRegistry st m a
-&gt; (e -&gt; WithTempRegistry st m a) -&gt; WithTempRegistry st m a
$ccatchJust :: forall st (m :: * -&gt; *) e b a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; Maybe b)
-&gt; WithTempRegistry st m a
-&gt; (b -&gt; WithTempRegistry st m a)
-&gt; WithTempRegistry st m a
catchJust :: forall e b a.
Exception e =&gt;
(e -&gt; Maybe b)
-&gt; WithTempRegistry st m a
-&gt; (b -&gt; WithTempRegistry st m a)
-&gt; WithTempRegistry st m a
$ctry :: forall st (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
WithTempRegistry st m a -&gt; WithTempRegistry st m (Either e a)
try :: forall e a.
Exception e =&gt;
WithTempRegistry st m a -&gt; WithTempRegistry st m (Either e a)
$ctryJust :: forall st (m :: * -&gt; *) e b a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; Maybe b)
-&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m (Either b a)
tryJust :: forall e b a.
Exception e =&gt;
(e -&gt; Maybe b)
-&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m (Either b a)
$chandle :: forall st (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; WithTempRegistry st m a)
-&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m a
handle :: forall e a.
Exception e =&gt;
(e -&gt; WithTempRegistry st m a)
-&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m a
$chandleJust :: forall st (m :: * -&gt; *) e b a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; Maybe b)
-&gt; (b -&gt; WithTempRegistry st m a)
-&gt; WithTempRegistry st m a
-&gt; WithTempRegistry st m a
handleJust :: forall e b a.
Exception e =&gt;
(e -&gt; Maybe b)
-&gt; (b -&gt; WithTempRegistry st m a)
-&gt; WithTempRegistry st m a
-&gt; WithTempRegistry st m a
$conException :: forall st (m :: * -&gt; *) a b.
MonadCatch m =&gt;
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
onException :: forall a b.
WithTempRegistry st m a
-&gt; WithTempRegistry st m b -&gt; WithTempRegistry st m a
$cbracketOnError :: forall st (m :: * -&gt; *) a b c.
MonadCatch m =&gt;
WithTempRegistry st m a
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; (a -&gt; WithTempRegistry st m c)
-&gt; WithTempRegistry st m c
bracketOnError :: forall a b c.
WithTempRegistry st m a
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; (a -&gt; WithTempRegistry st m c)
-&gt; WithTempRegistry st m c
$cgeneralBracket :: forall st (m :: * -&gt; *) a b c.
MonadCatch m =&gt;
WithTempRegistry st m a
-&gt; (a -&gt; ExitCase b -&gt; WithTempRegistry st m c)
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; WithTempRegistry st m (b, c)
generalBracket :: forall a b c.
WithTempRegistry st m a
-&gt; (a -&gt; ExitCase b -&gt; WithTempRegistry st m c)
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; WithTempRegistry st m (b, c)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadCatch</span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-905"></span><span>                   </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679083222"><span id="local-6989586621679083227"><span id="local-6989586621679083231"><span id="local-6989586621679083235"><span class="annot"><span class="annottext">MonadCatch (WithTempRegistry st m)
MonadCatch (WithTempRegistry st m) =&gt;
(forall b.
 ((forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a)
  -&gt; WithTempRegistry st m b)
 -&gt; WithTempRegistry st m b)
-&gt; (forall b.
    ((forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a)
     -&gt; WithTempRegistry st m b)
    -&gt; WithTempRegistry st m b)
-&gt; (forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a)
-&gt; (forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a)
-&gt; MonadMask (WithTempRegistry st m)
forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a
forall b.
((forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a)
 -&gt; WithTempRegistry st m b)
-&gt; WithTempRegistry st m b
forall st (m :: * -&gt; *).
MonadMask m =&gt;
MonadCatch (WithTempRegistry st m)
forall st (m :: * -&gt; *) a.
MonadMask m =&gt;
WithTempRegistry st m a -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a)
 -&gt; WithTempRegistry st m b)
-&gt; WithTempRegistry st m b
forall (m :: * -&gt; *).
MonadCatch m =&gt;
(forall b. ((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b)
-&gt; (forall b. ((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b)
-&gt; (forall a. m a -&gt; m a)
-&gt; (forall a. m a -&gt; m a)
-&gt; MonadMask m
$cmask :: forall st (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a)
 -&gt; WithTempRegistry st m b)
-&gt; WithTempRegistry st m b
mask :: forall b.
((forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a)
 -&gt; WithTempRegistry st m b)
-&gt; WithTempRegistry st m b
$cuninterruptibleMask :: forall st (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a)
 -&gt; WithTempRegistry st m b)
-&gt; WithTempRegistry st m b
uninterruptibleMask :: forall b.
((forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a)
 -&gt; WithTempRegistry st m b)
-&gt; WithTempRegistry st m b
$cmask_ :: forall st (m :: * -&gt; *) a.
MonadMask m =&gt;
WithTempRegistry st m a -&gt; WithTempRegistry st m a
mask_ :: forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a
$cuninterruptibleMask_ :: forall st (m :: * -&gt; *) a.
MonadMask m =&gt;
WithTempRegistry st m a -&gt; WithTempRegistry st m a
uninterruptibleMask_ :: forall a. WithTempRegistry st m a -&gt; WithTempRegistry st m a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadMask</span></span></span></span></span></span><span>
</span><span id="line-906"></span><span>                   </span><span class="hs-special">)</span><span>
</span><span id="line-907"></span><span>
</span><span id="line-908"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679081690"><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#MonadTrans"><span class="hs-identifier hs-type">MonadTrans</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081690"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-909"></span><span>  </span><span id="local-6989586621679083248"><span class="annot"><span class="annottext">lift :: forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; WithTempRegistry st m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var hs-var hs-var hs-var">lift</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT (TempRegistry st m) m a -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) a.
ReaderT (TempRegistry st m) m a -&gt; WithTempRegistry st m a
</span><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-var">WithTempRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT (TempRegistry st m) m a -&gt; WithTempRegistry st m a)
-&gt; (m a -&gt; ReaderT (TempRegistry st m) m a)
-&gt; m a
-&gt; WithTempRegistry st m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; ReaderT (TempRegistry st m) m a
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ReaderT (TempRegistry st m) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span>
</span><span id="line-910"></span><span>
</span><span id="line-911"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679081881"><span id="local-6989586621679081882"><span id="local-6989586621679081883"><span id="local-6989586621679083254"><span id="local-6989586621679083258"><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#MonadState"><span class="hs-identifier hs-type">MonadState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081881"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081882"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#MonadState"><span class="hs-identifier hs-type">MonadState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081881"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081883"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081882"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-912"></span><span>  </span><span id="local-6989586621679083265"><span class="annot"><span class="annottext">state :: forall a. (s -&gt; (a, s)) -&gt; WithTempRegistry st m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#state"><span class="hs-identifier hs-var hs-var hs-var hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT (TempRegistry st m) m a -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) a.
ReaderT (TempRegistry st m) m a -&gt; WithTempRegistry st m a
</span><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-var">WithTempRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT (TempRegistry st m) m a -&gt; WithTempRegistry st m a)
-&gt; ((s -&gt; (a, s)) -&gt; ReaderT (TempRegistry st m) m a)
-&gt; (s -&gt; (a, s))
-&gt; WithTempRegistry st m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(s -&gt; (a, s)) -&gt; ReaderT (TempRegistry st m) m a
forall a. (s -&gt; (a, s)) -&gt; ReaderT (TempRegistry st m) m a
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; (a, s)) -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#state"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-913"></span><span>
</span><span id="line-914"></span><span class="hs-comment">-- | Untrack all the resources from the registry that have been transferred to</span><span>
</span><span id="line-915"></span><span class="hs-comment">-- the given state.</span><span>
</span><span id="line-916"></span><span class="hs-comment">--</span><span>
</span><span id="line-917"></span><span class="hs-comment">-- Untracking a resource means removing it from the registry without releasing</span><span>
</span><span id="line-918"></span><span class="hs-comment">-- it.</span><span>
</span><span id="line-919"></span><span class="hs-comment">--</span><span>
</span><span id="line-920"></span><span class="hs-comment">-- NOTE: does not check that it's called by the same thread that allocated the</span><span>
</span><span id="line-921"></span><span class="hs-comment">-- resources, as it's an internal function only used in 'runWithTempRegistry'.</span><span>
</span><span id="line-922"></span><span id="local-6989586621679081672"><span id="local-6989586621679081673"><span class="annot"><a href="Control.ResourceRegistry.html#untrackTransferredTo"><span class="hs-identifier hs-type">untrackTransferredTo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-923"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081672"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-924"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081672"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-925"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#TransferredTo"><span class="hs-identifier hs-type">TransferredTo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081673"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-926"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081673"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-927"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081672"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-928"></span><span id="untrackTransferredTo"><span class="annot"><span class="annottext">untrackTransferredTo :: forall (m :: * -&gt; *) st.
MonadSTM m =&gt;
ResourceRegistry m -&gt; TransferredTo st -&gt; st -&gt; m ()
</span><a href="Control.ResourceRegistry.html#untrackTransferredTo"><span class="hs-identifier hs-var hs-var">untrackTransferredTo</span></a></span></span><span> </span><span id="local-6989586621679083272"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083272"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679083273"><span class="annot"><span class="annottext">TransferredTo st
</span><a href="#local-6989586621679083273"><span class="hs-identifier hs-var">transferredTo</span></a></span></span><span> </span><span id="local-6989586621679083274"><span class="annot"><span class="annottext">st
</span><a href="#local-6989586621679083274"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-929"></span><span>    </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; State (RegistryState m) () -&gt; m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
ResourceRegistry m -&gt; State (RegistryState m) a -&gt; m a
</span><a href="Control.ResourceRegistry.html#updateState"><span class="hs-identifier hs-var">updateState</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083272"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">(State (RegistryState m) () -&gt; m ())
-&gt; State (RegistryState m) () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ResourceId
 -&gt; StateT (RegistryState m) Identity (Maybe (Resource m)))
-&gt; Set ResourceId -&gt; State (RegistryState m) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId
-&gt; StateT (RegistryState m) Identity (Maybe (Resource m))
forall (m :: * -&gt; *).
ResourceId -&gt; State (RegistryState m) (Maybe (Resource m))
</span><a href="Control.ResourceRegistry.html#removeResource"><span class="hs-identifier hs-var">removeResource</span></a></span><span> </span><span class="annot"><span class="annottext">Set ResourceId
</span><a href="#local-6989586621679083276"><span class="hs-identifier hs-var">rids</span></a></span><span>
</span><span id="line-930"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-931"></span><span>    </span><span id="local-6989586621679083276"><span class="annot"><span class="annottext">rids :: Set ResourceId
</span><a href="#local-6989586621679083276"><span class="hs-identifier hs-var hs-var">rids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransferredTo st -&gt; st -&gt; Set ResourceId
forall st. TransferredTo st -&gt; st -&gt; Set ResourceId
</span><a href="Control.ResourceRegistry.html#runTransferredTo"><span class="hs-identifier hs-var">runTransferredTo</span></a></span><span> </span><span class="annot"><span class="annottext">TransferredTo st
</span><a href="#local-6989586621679083273"><span class="hs-identifier hs-var">transferredTo</span></a></span><span> </span><span class="annot"><span class="annottext">st
</span><a href="#local-6989586621679083274"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-932"></span><span>
</span><span id="line-933"></span><span class="hs-comment">-- | Allocate a resource in a temporary registry until it has been transferred</span><span>
</span><span id="line-934"></span><span class="hs-comment">-- to the final state @st@. See 'runWithTempRegistry' for more details.</span><span>
</span><span id="line-935"></span><span id="local-6989586621679081702"><span id="local-6989586621679081703"><span id="local-6989586621679081704"><span class="annot"><a href="Control.ResourceRegistry.html#allocateTemp"><span class="hs-identifier hs-type">allocateTemp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-936"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081702"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081702"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081702"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-937"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081702"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081703"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-938"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Allocate the resource</span></span><span>
</span><span id="line-939"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081703"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081702"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-940"></span><span>     </span><span class="hs-comment">-- ^ Release the resource, return 'True' when the resource was actually</span><span>
</span><span id="line-941"></span><span>     </span><span class="hs-comment">-- released, return 'False' when the resource was already released.</span><span>
</span><span id="line-942"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-943"></span><span>     </span><span class="hs-comment">-- Note that it is safe to always return 'True' when unsure.</span><span>
</span><span id="line-944"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081704"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081703"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-945"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Check whether the resource is in the given state</span></span><span>
</span><span id="line-946"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081704"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081702"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081703"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-947"></span><span id="allocateTemp"><span class="annot"><span class="annottext">allocateTemp :: forall (m :: * -&gt; *) a st.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
m a
-&gt; (a -&gt; m Bool) -&gt; (st -&gt; a -&gt; Bool) -&gt; WithTempRegistry st m a
</span><a href="Control.ResourceRegistry.html#allocateTemp"><span class="hs-identifier hs-var hs-var">allocateTemp</span></a></span></span><span> </span><span id="local-6989586621679083305"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679083305"><span class="hs-identifier hs-var">alloc</span></a></span></span><span> </span><span id="local-6989586621679083306"><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679083306"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span id="local-6989586621679083307"><span class="annot"><span class="annottext">st -&gt; a -&gt; Bool
</span><a href="#local-6989586621679083307"><span class="hs-identifier hs-var">isTransferred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT (TempRegistry st m) m a -&gt; WithTempRegistry st m a
forall st (m :: * -&gt; *) a.
ReaderT (TempRegistry st m) m a -&gt; WithTempRegistry st m a
</span><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-var">WithTempRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT (TempRegistry st m) m a -&gt; WithTempRegistry st m a)
-&gt; ReaderT (TempRegistry st m) m a -&gt; WithTempRegistry st m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-948"></span><span>    </span><span class="annot"><a href="Control.ResourceRegistry.html#TempRegistry"><span class="hs-identifier hs-type">TempRegistry</span></a></span><span> </span><span id="local-6989586621679083308"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083308"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679083309"><span class="annot"><span class="annottext">StrictTVar m (TransferredTo st)
</span><a href="#local-6989586621679083309"><span class="hs-identifier hs-var">varTransferredTo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT (TempRegistry st m) m (TempRegistry st m)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.Reader.Class.html#ask"><span class="hs-identifier hs-var">ask</span></a></span><span>
</span><span id="line-949"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679083310"><span class="annot"><span class="annottext">ResourceKey m
</span><a href="#local-6989586621679083310"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679083311"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083311"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (ResourceKey m, a)
-&gt; ReaderT (TempRegistry st m) m (ResourceKey m, a)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ReaderT (TempRegistry st m) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either Void (ResourceKey m, a) -&gt; (ResourceKey m, a)
forall a. Either Void a -&gt; a
</span><a href="Control.ResourceRegistry.html#mustBeRight"><span class="hs-identifier hs-var">mustBeRight</span></a></span><span> </span><span class="annot"><span class="annottext">(Either Void (ResourceKey m, a) -&gt; (ResourceKey m, a))
-&gt; m (Either Void (ResourceKey m, a)) -&gt; m (ResourceKey m, a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-950"></span><span>      </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; (ResourceId -&gt; m (Either Void a))
-&gt; (a -&gt; m Bool)
-&gt; m (Either Void (ResourceKey m, a))
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
ResourceRegistry m
-&gt; (ResourceId -&gt; m (Either e a))
-&gt; (a -&gt; m Bool)
-&gt; m (Either e (ResourceKey m, a))
</span><a href="Control.ResourceRegistry.html#allocateEither"><span class="hs-identifier hs-var">allocateEither</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083308"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a -&gt; Either Void a) -&gt; m a -&gt; m (Either Void a)
forall a b. (a -&gt; b) -&gt; m a -&gt; m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Either Void a
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(m a -&gt; m (Either Void a))
-&gt; (ResourceId -&gt; m a) -&gt; ResourceId -&gt; m (Either Void a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; ResourceId -&gt; m a
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679083305"><span class="hs-identifier hs-var">alloc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679083306"><span class="hs-identifier hs-var">free</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-951"></span><span>    </span><span class="annot"><span class="annottext">m () -&gt; ReaderT (TempRegistry st m) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ReaderT (TempRegistry st m) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; ReaderT (TempRegistry st m) m ())
-&gt; m () -&gt; ReaderT (TempRegistry st m) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (TransferredTo st)
-&gt; (TransferredTo st -&gt; TransferredTo st) -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><span class="hs-identifier hs-var">modifyTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (TransferredTo st)
</span><a href="#local-6989586621679083309"><span class="hs-identifier hs-var">varTransferredTo</span></a></span><span> </span><span class="annot"><span class="annottext">((TransferredTo st -&gt; TransferredTo st) -&gt; STM m ())
-&gt; (TransferredTo st -&gt; TransferredTo st) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st
forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#mappend"><span class="hs-identifier hs-var">mappend</span></a></span><span> </span><span class="annot"><span class="annottext">(TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st)
-&gt; TransferredTo st -&gt; TransferredTo st -&gt; TransferredTo st
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-952"></span><span>      </span><span class="annot"><span class="annottext">(st -&gt; Set ResourceId) -&gt; TransferredTo st
forall st. (st -&gt; Set ResourceId) -&gt; TransferredTo st
</span><a href="Control.ResourceRegistry.html#TransferredTo"><span class="hs-identifier hs-var">TransferredTo</span></a></span><span> </span><span class="annot"><span class="annottext">((st -&gt; Set ResourceId) -&gt; TransferredTo st)
-&gt; (st -&gt; Set ResourceId) -&gt; TransferredTo st
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679083315"><span class="annot"><span class="annottext">st
</span><a href="#local-6989586621679083315"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-953"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">st -&gt; a -&gt; Bool
</span><a href="#local-6989586621679083307"><span class="hs-identifier hs-var">isTransferred</span></a></span><span> </span><span class="annot"><span class="annottext">st
</span><a href="#local-6989586621679083315"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083311"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-954"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ResourceId -&gt; Set ResourceId
forall a. a -&gt; Set a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#singleton"><span class="hs-identifier hs-var">Set.singleton</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResourceKey m -&gt; ResourceId
forall (m :: * -&gt; *). ResourceKey m -&gt; ResourceId
</span><a href="Control.ResourceRegistry.html#resourceKeyId"><span class="hs-identifier hs-var">resourceKeyId</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceKey m
</span><a href="#local-6989586621679083310"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-955"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Set ResourceId
forall a. Set a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set.empty</span></a></span><span>
</span><span id="line-956"></span><span>    </span><span class="annot"><span class="annottext">a -&gt; ReaderT (TempRegistry st m) m a
forall a. a -&gt; ReaderT (TempRegistry st m) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083311"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-957"></span><span>
</span><span id="line-958"></span><span class="hs-comment">-- | Higher level API on top of 'runWithTempRegistry': modify the given @st@,</span><span>
</span><span id="line-959"></span><span class="hs-comment">-- allocating resources in the process that will be transferred to the</span><span>
</span><span id="line-960"></span><span class="hs-comment">-- returned @st@.</span><span>
</span><span id="line-961"></span><span class="annot"><a href="Control.ResourceRegistry.html#modifyWithTempRegistry"><span class="hs-identifier hs-type">modifyWithTempRegistry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-962"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679081906"><span class="annot"><a href="#local-6989586621679081906"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679081907"><span class="annot"><a href="#local-6989586621679081907"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span id="local-6989586621679081908"><span class="annot"><a href="#local-6989586621679081908"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-963"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081906"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081906"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081906"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-964"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081906"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081907"><span class="hs-identifier hs-type">st</span></a></span><span>                                 </span><span class="annot"><span class="hs-comment">-- ^ Get the state</span></span><span>
</span><span id="line-965"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081907"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExitCase</span></span><span> </span><span class="annot"><a href="#local-6989586621679081907"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081906"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>          </span><span class="annot"><span class="hs-comment">-- ^ Store the new state</span></span><span>
</span><span id="line-966"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#StateT"><span class="hs-identifier hs-type">StateT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081907"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081907"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081906"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679081908"><span class="hs-identifier hs-type">a</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Modify the state</span></span><span>
</span><span id="line-967"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081906"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081908"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-968"></span><span id="modifyWithTempRegistry"><span class="annot"><span class="annottext">modifyWithTempRegistry :: forall (m :: * -&gt; *) st a.
(MonadSTM m, MonadMask m, MonadThread m) =&gt;
m st
-&gt; (st -&gt; ExitCase st -&gt; m ())
-&gt; StateT st (WithTempRegistry st m) a
-&gt; m a
</span><a href="Control.ResourceRegistry.html#modifyWithTempRegistry"><span class="hs-identifier hs-var hs-var">modifyWithTempRegistry</span></a></span></span><span> </span><span id="local-6989586621679083337"><span class="annot"><span class="annottext">m st
</span><a href="#local-6989586621679083337"><span class="hs-identifier hs-var">getSt</span></a></span></span><span> </span><span id="local-6989586621679083338"><span class="annot"><span class="annottext">st -&gt; ExitCase st -&gt; m ()
</span><a href="#local-6989586621679083338"><span class="hs-identifier hs-var">putSt</span></a></span></span><span> </span><span id="local-6989586621679083339"><span class="annot"><span class="annottext">StateT st (WithTempRegistry st m) a
</span><a href="#local-6989586621679083339"><span class="hs-identifier hs-var">modSt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WithTempRegistry st m (a, st) -&gt; m a
forall (m :: * -&gt; *) st a.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
WithTempRegistry st m (a, st) -&gt; m a
</span><a href="Control.ResourceRegistry.html#runWithTempRegistry"><span class="hs-identifier hs-var">runWithTempRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry st m (a, st) -&gt; m a)
-&gt; WithTempRegistry st m (a, st) -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-969"></span><span>    </span><span class="annot"><span class="annottext">((a, st), ()) -&gt; (a, st)
forall a b. (a, b) -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">(((a, st), ()) -&gt; (a, st))
-&gt; WithTempRegistry st m ((a, st), ())
-&gt; WithTempRegistry st m (a, st)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WithTempRegistry st m st
-&gt; (st -&gt; ExitCase (a, st) -&gt; WithTempRegistry st m ())
-&gt; (st -&gt; WithTempRegistry st m (a, st))
-&gt; WithTempRegistry st m ((a, st), ())
forall a b c.
WithTempRegistry st m a
-&gt; (a -&gt; ExitCase b -&gt; WithTempRegistry st m c)
-&gt; (a -&gt; WithTempRegistry st m b)
-&gt; WithTempRegistry st m (b, c)
forall (m :: * -&gt; *) a b c.
MonadCatch m =&gt;
m a -&gt; (a -&gt; ExitCase b -&gt; m c) -&gt; (a -&gt; m b) -&gt; m (b, c)
</span><span class="hs-identifier hs-var">generalBracket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m st -&gt; WithTempRegistry st m st
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; WithTempRegistry st m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">m st
</span><a href="#local-6989586621679083337"><span class="hs-identifier hs-var">getSt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">st -&gt; ExitCase (a, st) -&gt; WithTempRegistry st m ()
</span><a href="#local-6989586621679083342"><span class="hs-identifier hs-var">transfer</span></a></span><span> </span><span class="annot"><span class="annottext">st -&gt; WithTempRegistry st m (a, st)
</span><a href="#local-6989586621679083343"><span class="hs-identifier hs-var">mutate</span></a></span><span>
</span><span id="line-970"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-971"></span><span>    </span><span class="annot"><a href="#local-6989586621679083342"><span class="hs-identifier hs-type">transfer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679081907"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExitCase</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081908"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679081907"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081907"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081906"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-972"></span><span>    </span><span id="local-6989586621679083342"><span class="annot"><span class="annottext">transfer :: st -&gt; ExitCase (a, st) -&gt; WithTempRegistry st m ()
</span><a href="#local-6989586621679083342"><span class="hs-identifier hs-var hs-var">transfer</span></a></span></span><span> </span><span id="local-6989586621679083344"><span class="annot"><span class="annottext">st
</span><a href="#local-6989586621679083344"><span class="hs-identifier hs-var">initSt</span></a></span></span><span> </span><span id="local-6989586621679083345"><span class="annot"><span class="annottext">ExitCase (a, st)
</span><a href="#local-6989586621679083345"><span class="hs-identifier hs-var">ec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry st m ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; WithTempRegistry st m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry st m ())
-&gt; m () -&gt; WithTempRegistry st m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">st -&gt; ExitCase st -&gt; m ()
</span><a href="#local-6989586621679083338"><span class="hs-identifier hs-var">putSt</span></a></span><span> </span><span class="annot"><span class="annottext">st
</span><a href="#local-6989586621679083344"><span class="hs-identifier hs-var">initSt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a, st) -&gt; st
forall a b. (a, b) -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">((a, st) -&gt; st) -&gt; ExitCase (a, st) -&gt; ExitCase st
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCase (a, st)
</span><a href="#local-6989586621679083345"><span class="hs-identifier hs-var">ec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-973"></span><span>
</span><span id="line-974"></span><span>    </span><span class="annot"><a href="#local-6989586621679083343"><span class="hs-identifier hs-type">mutate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679081907"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081907"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081906"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081908"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679081907"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-975"></span><span>    </span><span id="local-6989586621679083343"><span class="annot"><span class="annottext">mutate :: st -&gt; WithTempRegistry st m (a, st)
</span><a href="#local-6989586621679083343"><span class="hs-identifier hs-var hs-var">mutate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateT st (WithTempRegistry st m) a
-&gt; st -&gt; WithTempRegistry st m (a, st)
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#runStateT"><span class="hs-identifier hs-var">runStateT</span></a></span><span> </span><span class="annot"><span class="annottext">StateT st (WithTempRegistry st m) a
</span><a href="#local-6989586621679083339"><span class="hs-identifier hs-var">modSt</span></a></span><span>
</span><span id="line-976"></span><span>
</span><span id="line-977"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Simple queries on the registry
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-980"></span><span>
</span><span id="line-981"></span><span class="annot"><span class="hs-comment">-- | The thread that created the registry</span></span><span>
</span><span id="line-982"></span><span id="local-6989586621679081917"><span class="annot"><a href="Control.ResourceRegistry.html#registryThread"><span class="hs-identifier hs-type">registryThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081917"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679081917"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-983"></span><span id="registryThread"><span class="annot"><span class="annottext">registryThread :: forall (m :: * -&gt; *). ResourceRegistry m -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#registryThread"><span class="hs-identifier hs-var hs-var">registryThread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context m -&gt; ThreadId m
forall (m :: * -&gt; *). Context m -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#contextThreadId"><span class="hs-identifier hs-var">contextThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">(Context m -&gt; ThreadId m)
-&gt; (ResourceRegistry m -&gt; Context m)
-&gt; ResourceRegistry m
-&gt; ThreadId m
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; Context m
forall (m :: * -&gt; *). ResourceRegistry m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#registryContext"><span class="hs-identifier hs-var">registryContext</span></a></span><span>
</span><span id="line-984"></span><span>
</span><span id="line-985"></span><span class="hs-comment">-- | Number of currently allocated resources</span><span>
</span><span id="line-986"></span><span class="hs-comment">--</span><span>
</span><span id="line-987"></span><span class="hs-comment">-- Primarily for the benefit of testing.</span><span>
</span><span id="line-988"></span><span id="local-6989586621679081919"><span class="annot"><a href="Control.ResourceRegistry.html#countResources"><span class="hs-identifier hs-type">countResources</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081919"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081919"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081919"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span></span><span>
</span><span id="line-989"></span><span id="countResources"><span class="annot"><span class="annottext">countResources :: forall (m :: * -&gt; *). MonadSTM m =&gt; ResourceRegistry m -&gt; m Int
</span><a href="Control.ResourceRegistry.html#countResources"><span class="hs-identifier hs-var hs-var">countResources</span></a></span></span><span> </span><span id="local-6989586621679083357"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083357"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m Int -&gt; m Int
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m Int -&gt; m Int) -&gt; STM m Int -&gt; m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RegistryState m -&gt; Int
forall (m :: * -&gt; *). RegistryState m -&gt; Int
</span><a href="#local-6989586621679083358"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RegistryState m -&gt; Int) -&gt; STM m (RegistryState m) -&gt; STM m Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (RegistryState m) -&gt; STM m (RegistryState m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; StrictTVar m (RegistryState m)
forall (m :: * -&gt; *).
ResourceRegistry m -&gt; StrictTVar m (RegistryState m)
</span><a href="Control.ResourceRegistry.html#registryState"><span class="hs-identifier hs-var">registryState</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083357"><span class="hs-identifier hs-var">rr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-990"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-991"></span><span>    </span><span id="local-6989586621679081921"><span class="annot"><a href="#local-6989586621679083358"><span class="hs-identifier hs-type">aux</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryState"><span class="hs-identifier hs-type">RegistryState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081921"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span></span><span>
</span><span id="line-992"></span><span>    </span><span id="local-6989586621679083358"><span class="annot"><span class="annottext">aux :: forall (m :: * -&gt; *). RegistryState m -&gt; Int
</span><a href="#local-6989586621679083358"><span class="hs-identifier hs-var hs-var">aux</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map ResourceId (Resource m) -&gt; Int
forall k a. Map k a -&gt; Int
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#size"><span class="hs-identifier hs-var">Map.size</span></a></span><span> </span><span class="annot"><span class="annottext">(Map ResourceId (Resource m) -&gt; Int)
-&gt; (RegistryState m -&gt; Map ResourceId (Resource m))
-&gt; RegistryState m
-&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">RegistryState m -&gt; Map ResourceId (Resource m)
forall (m :: * -&gt; *).
RegistryState m -&gt; Map ResourceId (Resource m)
</span><a href="Control.ResourceRegistry.html#registryResources"><span class="hs-identifier hs-var">registryResources</span></a></span><span>
</span><span id="line-993"></span><span>
</span><span id="line-994"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Allocating resources
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-997"></span><span>
</span><span id="line-998"></span><span class="hs-comment">-- | Allocate new resource</span><span>
</span><span id="line-999"></span><span class="hs-comment">--</span><span>
</span><span id="line-1000"></span><span class="hs-comment">-- The allocation function will be run with asynchronous exceptions masked. This</span><span>
</span><span id="line-1001"></span><span class="hs-comment">-- means that the resource allocation must either be fast or else interruptible;</span><span>
</span><span id="line-1002"></span><span class="hs-comment">-- see &quot;Dealing with Asynchronous Exceptions during Resource Acquisition&quot;</span><span>
</span><span id="line-1003"></span><span class="hs-comment">-- &lt;http://www.well-typed.com/blog/97/&gt; for details.</span><span>
</span><span id="line-1004"></span><span class="annot"><a href="Control.ResourceRegistry.html#allocate"><span class="hs-identifier hs-type">allocate</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1005"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679081649"><span class="annot"><a href="#local-6989586621679081649"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679081650"><span class="annot"><a href="#local-6989586621679081650"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1006"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081649"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081649"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081649"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1007"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081649"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1008"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081649"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081650"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1009"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081650"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081649"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Release the resource</span></span><span>
</span><span id="line-1010"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081649"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-type">ResourceKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081649"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679081650"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1011"></span><span id="allocate"><span class="annot"><span class="annottext">allocate :: forall (m :: * -&gt; *) a.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
ResourceRegistry m
-&gt; (ResourceId -&gt; m a) -&gt; (a -&gt; m ()) -&gt; m (ResourceKey m, a)
</span><a href="Control.ResourceRegistry.html#allocate"><span class="hs-identifier hs-var hs-var">allocate</span></a></span></span><span> </span><span id="local-6989586621679083377"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083377"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679083378"><span class="annot"><span class="annottext">ResourceId -&gt; m a
</span><a href="#local-6989586621679083378"><span class="hs-identifier hs-var">alloc</span></a></span></span><span> </span><span id="local-6989586621679083379"><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679083379"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either Void (ResourceKey m, a) -&gt; (ResourceKey m, a)
forall a. Either Void a -&gt; a
</span><a href="Control.ResourceRegistry.html#mustBeRight"><span class="hs-identifier hs-var">mustBeRight</span></a></span><span> </span><span class="annot"><span class="annottext">(Either Void (ResourceKey m, a) -&gt; (ResourceKey m, a))
-&gt; m (Either Void (ResourceKey m, a)) -&gt; m (ResourceKey m, a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-1012"></span><span>    </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; (ResourceId -&gt; m (Either Void a))
-&gt; (a -&gt; m Bool)
-&gt; m (Either Void (ResourceKey m, a))
forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
ResourceRegistry m
-&gt; (ResourceId -&gt; m (Either e a))
-&gt; (a -&gt; m Bool)
-&gt; m (Either e (ResourceKey m, a))
</span><a href="Control.ResourceRegistry.html#allocateEither"><span class="hs-identifier hs-var">allocateEither</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083377"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a -&gt; Either Void a) -&gt; m a -&gt; m (Either Void a)
forall a b. (a -&gt; b) -&gt; m a -&gt; m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Either Void a
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(m a -&gt; m (Either Void a))
-&gt; (ResourceId -&gt; m a) -&gt; ResourceId -&gt; m (Either Void a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId -&gt; m a
</span><a href="#local-6989586621679083378"><span class="hs-identifier hs-var">alloc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679083380"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083380"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679083379"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083380"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m Bool -&gt; m Bool
forall a b. m a -&gt; m b -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1013"></span><span>
</span><span id="line-1014"></span><span class="annot"><span class="hs-comment">-- | Generalization of 'allocate' for allocation functions that may fail</span></span><span>
</span><span id="line-1015"></span><span class="annot"><a href="Control.ResourceRegistry.html#allocateEither"><span class="hs-identifier hs-type">allocateEither</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1016"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679081898"><span class="annot"><a href="#local-6989586621679081898"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679081899"><span class="annot"><a href="#local-6989586621679081899"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621679081900"><span class="annot"><a href="#local-6989586621679081900"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1017"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081898"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081898"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081898"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1018"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081898"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1019"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081898"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081899"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081900"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1020"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679081900"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081898"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1021"></span><span>     </span><span class="hs-comment">-- ^ Release the resource, return 'True' when the resource</span><span>
</span><span id="line-1022"></span><span>     </span><span class="hs-comment">-- hasn't been released or closed before.</span><span>
</span><span id="line-1023"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081898"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081899"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-type">ResourceKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081898"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679081900"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1024"></span><span id="allocateEither"><span class="annot"><span class="annottext">allocateEither :: forall (m :: * -&gt; *) e a.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
ResourceRegistry m
-&gt; (ResourceId -&gt; m (Either e a))
-&gt; (a -&gt; m Bool)
-&gt; m (Either e (ResourceKey m, a))
</span><a href="Control.ResourceRegistry.html#allocateEither"><span class="hs-identifier hs-var hs-var">allocateEither</span></a></span></span><span> </span><span id="local-6989586621679083412"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083412"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679083413"><span class="annot"><span class="annottext">ResourceId -&gt; m (Either e a)
</span><a href="#local-6989586621679083413"><span class="hs-identifier hs-var">alloc</span></a></span></span><span> </span><span id="local-6989586621679083414"><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679083414"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1025"></span><span>    </span><span id="local-6989586621679083415"><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083415"><span class="hs-identifier hs-var">context</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Context m)
forall (m :: * -&gt; *).
(MonadThread m, HasCallStack) =&gt;
m (Context m)
</span><a href="Control.ResourceRegistry.html#captureContext"><span class="hs-identifier hs-var">captureContext</span></a></span><span>
</span><span id="line-1026"></span><span>    </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; Context m -&gt; m ()
forall (m :: * -&gt; *).
(MonadThrow m, MonadThread m, MonadSTM m) =&gt;
ResourceRegistry m -&gt; Context m -&gt; m ()
</span><a href="Control.ResourceRegistry.html#ensureKnownThread"><span class="hs-identifier hs-var">ensureKnownThread</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083412"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083415"><span class="hs-identifier hs-var">context</span></a></span><span>
</span><span id="line-1027"></span><span>    </span><span class="hs-comment">-- We check if the registry has been closed when we allocate the key, so</span><span>
</span><span id="line-1028"></span><span>    </span><span class="hs-comment">-- that we can avoid needlessly allocating the resource.</span><span>
</span><span id="line-1029"></span><span>    </span><span id="local-6989586621679083417"><span class="annot"><span class="annottext">Either PrettyCallStack ResourceId
</span><a href="#local-6989586621679083417"><span class="hs-identifier hs-var">mKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; State (RegistryState m) (Either PrettyCallStack ResourceId)
-&gt; m (Either PrettyCallStack ResourceId)
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
ResourceRegistry m -&gt; State (RegistryState m) a -&gt; m a
</span><a href="Control.ResourceRegistry.html#updateState"><span class="hs-identifier hs-var">updateState</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083412"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">State (RegistryState m) (Either PrettyCallStack ResourceId)
forall (m :: * -&gt; *).
State (RegistryState m) (Either PrettyCallStack ResourceId)
</span><a href="Control.ResourceRegistry.html#allocKey"><span class="hs-identifier hs-var">allocKey</span></a></span><span>
</span><span id="line-1030"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either PrettyCallStack ResourceId
</span><a href="#local-6989586621679083417"><span class="hs-identifier hs-var">mKey</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1031"></span><span>      </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679083418"><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679083418"><span class="hs-identifier hs-var">closed</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1032"></span><span>        </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; Context m -&gt; PrettyCallStack -&gt; m (Either e (ResourceKey m, a))
forall (m :: * -&gt; *) x.
(MonadThrow m, MonadThread m) =&gt;
ResourceRegistry m -&gt; Context m -&gt; PrettyCallStack -&gt; m x
</span><a href="Control.ResourceRegistry.html#throwRegistryClosed"><span class="hs-identifier hs-var">throwRegistryClosed</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083412"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083415"><span class="hs-identifier hs-var">context</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679083418"><span class="hs-identifier hs-var">closed</span></a></span><span>
</span><span id="line-1033"></span><span>      </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679083420"><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083420"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (Either e (ResourceKey m, a)) -&gt; m (Either e (ResourceKey m, a))
forall a. m a -&gt; m a
forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(m (Either e (ResourceKey m, a))
 -&gt; m (Either e (ResourceKey m, a)))
-&gt; m (Either e (ResourceKey m, a))
-&gt; m (Either e (ResourceKey m, a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1034"></span><span>        </span><span id="local-6989586621679083421"><span class="annot"><span class="annottext">Either e a
</span><a href="#local-6989586621679083421"><span class="hs-identifier hs-var">ma</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ResourceId -&gt; m (Either e a)
</span><a href="#local-6989586621679083413"><span class="hs-identifier hs-var">alloc</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083420"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-1035"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either e a
</span><a href="#local-6989586621679083421"><span class="hs-identifier hs-var">ma</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1036"></span><span>          </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span id="local-6989586621679083422"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679083422"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either e (ResourceKey m, a) -&gt; m (Either e (ResourceKey m, a))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either e (ResourceKey m, a) -&gt; m (Either e (ResourceKey m, a)))
-&gt; Either e (ResourceKey m, a) -&gt; m (Either e (ResourceKey m, a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">e -&gt; Either e (ResourceKey m, a)
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679083422"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1037"></span><span>          </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679083423"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083423"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1038"></span><span>            </span><span class="hs-comment">-- TODO: Might want to have an exception handler around this call to</span><span>
</span><span id="line-1039"></span><span>            </span><span class="hs-comment">-- 'updateState' just in case /that/ throws an exception.</span><span>
</span><span id="line-1040"></span><span>            </span><span id="local-6989586621679083424"><span class="annot"><span class="annottext">Either PrettyCallStack ()
</span><a href="#local-6989586621679083424"><span class="hs-identifier hs-var">inserted</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; State (RegistryState m) (Either PrettyCallStack ())
-&gt; m (Either PrettyCallStack ())
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
ResourceRegistry m -&gt; State (RegistryState m) a -&gt; m a
</span><a href="Control.ResourceRegistry.html#updateState"><span class="hs-identifier hs-var">updateState</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083412"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">(State (RegistryState m) (Either PrettyCallStack ())
 -&gt; m (Either PrettyCallStack ()))
-&gt; State (RegistryState m) (Either PrettyCallStack ())
-&gt; m (Either PrettyCallStack ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1041"></span><span>                 </span><span class="annot"><span class="annottext">ResourceId
-&gt; Resource m
-&gt; State (RegistryState m) (Either PrettyCallStack ())
forall (m :: * -&gt; *).
ResourceId
-&gt; Resource m
-&gt; State (RegistryState m) (Either PrettyCallStack ())
</span><a href="Control.ResourceRegistry.html#insertResource"><span class="hs-identifier hs-var">insertResource</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083420"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context m -&gt; a -&gt; Resource m
</span><a href="#local-6989586621679083425"><span class="hs-identifier hs-var">mkResource</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083415"><span class="hs-identifier hs-var">context</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083423"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1042"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either PrettyCallStack ()
</span><a href="#local-6989586621679083424"><span class="hs-identifier hs-var">inserted</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1043"></span><span>              </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679083426"><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679083426"><span class="hs-identifier hs-var">closed</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1044"></span><span>                </span><span class="hs-comment">-- Despite the earlier check, it's possible that the registry</span><span>
</span><span id="line-1045"></span><span>                </span><span class="hs-comment">-- got closed after we allocated a new key but before we got a</span><span>
</span><span id="line-1046"></span><span>                </span><span class="hs-comment">-- chance to register the resource. In this case, we must</span><span>
</span><span id="line-1047"></span><span>                </span><span class="hs-comment">-- deallocate the resource again before throwing the exception.</span><span>
</span><span id="line-1048"></span><span>                </span><span class="annot"><span class="annottext">m Bool -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m Bool -&gt; m ()) -&gt; m Bool -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679083414"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083423"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1049"></span><span>                </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; Context m -&gt; PrettyCallStack -&gt; m (Either e (ResourceKey m, a))
forall (m :: * -&gt; *) x.
(MonadThrow m, MonadThread m) =&gt;
ResourceRegistry m -&gt; Context m -&gt; PrettyCallStack -&gt; m x
</span><a href="Control.ResourceRegistry.html#throwRegistryClosed"><span class="hs-identifier hs-var">throwRegistryClosed</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083412"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083415"><span class="hs-identifier hs-var">context</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679083426"><span class="hs-identifier hs-var">closed</span></a></span><span>
</span><span id="line-1050"></span><span>              </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1051"></span><span>                </span><span class="annot"><span class="annottext">Either e (ResourceKey m, a) -&gt; m (Either e (ResourceKey m, a))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either e (ResourceKey m, a) -&gt; m (Either e (ResourceKey m, a)))
-&gt; Either e (ResourceKey m, a) -&gt; m (Either e (ResourceKey m, a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ResourceKey m, a) -&gt; Either e (ResourceKey m, a)
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; ResourceId -&gt; ResourceKey m
forall (m :: * -&gt; *).
ResourceRegistry m -&gt; ResourceId -&gt; ResourceKey m
</span><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-var">ResourceKey</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083412"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083420"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083423"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1052"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1053"></span><span>    </span><span class="annot"><a href="#local-6989586621679083425"><span class="hs-identifier hs-type">mkResource</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081898"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081900"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Resource"><span class="hs-identifier hs-type">Resource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081898"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1054"></span><span>    </span><span id="local-6989586621679083425"><span class="annot"><span class="annottext">mkResource :: Context m -&gt; a -&gt; Resource m
</span><a href="#local-6989586621679083425"><span class="hs-identifier hs-var hs-var">mkResource</span></a></span></span><span> </span><span id="local-6989586621679083427"><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083427"><span class="hs-identifier hs-var">context</span></a></span></span><span> </span><span id="local-6989586621679083428"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083428"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Resource"><span class="hs-identifier hs-type">Resource</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1055"></span><span>          </span><span class="annot"><span class="annottext">resourceContext :: Context m
</span><a href="Control.ResourceRegistry.html#resourceContext"><span class="hs-identifier hs-var">resourceContext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083427"><span class="hs-identifier hs-var">context</span></a></span><span>
</span><span id="line-1056"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">resourceRelease :: Release m
</span><a href="Control.ResourceRegistry.html#resourceRelease"><span class="hs-identifier hs-var">resourceRelease</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m Bool -&gt; Release m
forall (m :: * -&gt; *). m Bool -&gt; Release m
</span><a href="Control.ResourceRegistry.html#Release"><span class="hs-identifier hs-var">Release</span></a></span><span> </span><span class="annot"><span class="annottext">(m Bool -&gt; Release m) -&gt; m Bool -&gt; Release m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m Bool
</span><a href="#local-6989586621679083414"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083428"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1057"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1058"></span><span>
</span><span id="line-1059"></span><span id="local-6989586621679081933"><span id="local-6989586621679081934"><span class="annot"><a href="Control.ResourceRegistry.html#throwRegistryClosed"><span class="hs-identifier hs-type">throwRegistryClosed</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1060"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679081933"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081933"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1061"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081933"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1062"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081933"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1063"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span>
</span><span id="line-1064"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081933"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081934"><span class="hs-identifier hs-type">x</span></a></span></span></span><span>
</span><span id="line-1065"></span><span id="throwRegistryClosed"><span class="annot"><span class="annottext">throwRegistryClosed :: forall (m :: * -&gt; *) x.
(MonadThrow m, MonadThread m) =&gt;
ResourceRegistry m -&gt; Context m -&gt; PrettyCallStack -&gt; m x
</span><a href="Control.ResourceRegistry.html#throwRegistryClosed"><span class="hs-identifier hs-var hs-var">throwRegistryClosed</span></a></span></span><span> </span><span id="local-6989586621679083434"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083434"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679083435"><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083435"><span class="hs-identifier hs-var">context</span></a></span></span><span> </span><span id="local-6989586621679083436"><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679083436"><span class="hs-identifier hs-var">closed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RegistryClosedException -&gt; m x
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#RegistryClosedException"><span class="hs-identifier hs-type">RegistryClosedException</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1066"></span><span>      </span><span class="annot"><span class="annottext">registryClosedRegistryContext :: Context m
</span><a href="Control.ResourceRegistry.html#registryClosedRegistryContext"><span class="hs-identifier hs-var">registryClosedRegistryContext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; Context m
forall (m :: * -&gt; *). ResourceRegistry m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#registryContext"><span class="hs-identifier hs-var">registryContext</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083434"><span class="hs-identifier hs-var">rr</span></a></span><span>
</span><span id="line-1067"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">registryClosedCloseCallStack :: PrettyCallStack
</span><a href="Control.ResourceRegistry.html#registryClosedCloseCallStack"><span class="hs-identifier hs-var">registryClosedCloseCallStack</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679083436"><span class="hs-identifier hs-var">closed</span></a></span><span>
</span><span id="line-1068"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">registryClosedAllocContext :: Context m
</span><a href="Control.ResourceRegistry.html#registryClosedAllocContext"><span class="hs-identifier hs-var">registryClosedAllocContext</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083435"><span class="hs-identifier hs-var">context</span></a></span><span>
</span><span id="line-1069"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-1070"></span><span>
</span><span id="line-1071"></span><span class="hs-comment">-- | Release resource</span><span>
</span><span id="line-1072"></span><span class="hs-comment">--</span><span>
</span><span id="line-1073"></span><span class="hs-comment">-- This deallocates the resource and removes it from the registry. It will be</span><span>
</span><span id="line-1074"></span><span class="hs-comment">-- the responsibility of the caller to make sure that the resource is no longer</span><span>
</span><span id="line-1075"></span><span class="hs-comment">-- used in any thread.</span><span>
</span><span id="line-1076"></span><span class="hs-comment">--</span><span>
</span><span id="line-1077"></span><span class="hs-comment">-- The deallocation function is run with exceptions masked, so that we are</span><span>
</span><span id="line-1078"></span><span class="hs-comment">-- guaranteed not to remove the resource from the registry without releasing it.</span><span>
</span><span id="line-1079"></span><span class="hs-comment">--</span><span>
</span><span id="line-1080"></span><span class="hs-comment">-- Releasing an already released resource is a no-op.</span><span>
</span><span id="line-1081"></span><span class="hs-comment">--</span><span>
</span><span id="line-1082"></span><span class="hs-comment">-- When the resource has not been released before, its context is returned.</span><span>
</span><span id="line-1083"></span><span id="local-6989586621679081609"><span class="annot"><a href="Control.ResourceRegistry.html#release"><span class="hs-identifier hs-type">release</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1084"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081609"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081609"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081609"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1085"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-type">ResourceKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081609"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1086"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081609"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081609"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1087"></span><span id="release"><span class="annot"><span class="annottext">release :: forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m, MonadThread m, HasCallStack) =&gt;
ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="Control.ResourceRegistry.html#release"><span class="hs-identifier hs-var hs-var">release</span></a></span></span><span> </span><span id="local-6989586621679083454"><span class="annot"><span class="annottext">key :: ResourceKey m
</span><a href="#local-6989586621679083454"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-type">ResourceKey</span></a></span><span> </span><span id="local-6989586621679083455"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083455"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span class="annot"><span class="annottext">ResourceId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1088"></span><span>    </span><span id="local-6989586621679083456"><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083456"><span class="hs-identifier hs-var">context</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Context m)
forall (m :: * -&gt; *).
(MonadThread m, HasCallStack) =&gt;
m (Context m)
</span><a href="Control.ResourceRegistry.html#captureContext"><span class="hs-identifier hs-var">captureContext</span></a></span><span>
</span><span id="line-1089"></span><span>    </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; Context m -&gt; m ()
forall (m :: * -&gt; *).
(MonadThrow m, MonadThread m, MonadSTM m) =&gt;
ResourceRegistry m -&gt; Context m -&gt; m ()
</span><a href="Control.ResourceRegistry.html#ensureKnownThread"><span class="hs-identifier hs-var">ensureKnownThread</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083455"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083456"><span class="hs-identifier hs-var">context</span></a></span><span>
</span><span id="line-1090"></span><span>    </span><span class="annot"><span class="annottext">ResourceKey m -&gt; m (Maybe (Context m))
forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m) =&gt;
ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="Control.ResourceRegistry.html#unsafeRelease"><span class="hs-identifier hs-var">unsafeRelease</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceKey m
</span><a href="#local-6989586621679083454"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-1091"></span><span>
</span><span id="line-1092"></span><span class="hs-comment">-- | Unsafe version of 'release'</span><span>
</span><span id="line-1093"></span><span class="hs-comment">--</span><span>
</span><span id="line-1094"></span><span class="hs-comment">-- The only difference between 'release' and 'unsafeRelease' is that the latter</span><span>
</span><span id="line-1095"></span><span class="hs-comment">-- does not insist that it is called from a thread that is known to the</span><span>
</span><span id="line-1096"></span><span class="hs-comment">-- registry. This is dangerous, because it implies that there is a thread with</span><span>
</span><span id="line-1097"></span><span class="hs-comment">-- access to a resource which may be deallocated before that thread is</span><span>
</span><span id="line-1098"></span><span class="hs-comment">-- terminated. Of course, we can't detect all such situations (when the thread</span><span>
</span><span id="line-1099"></span><span class="hs-comment">-- merely uses a resource but does not allocate or release we can't tell), but</span><span>
</span><span id="line-1100"></span><span class="hs-comment">-- normally when we /do/ detect this we throw an exception.</span><span>
</span><span id="line-1101"></span><span class="hs-comment">--</span><span>
</span><span id="line-1102"></span><span class="hs-comment">-- This function should only be used if the above situation can be ruled out</span><span>
</span><span id="line-1103"></span><span class="hs-comment">-- or handled by other means.</span><span>
</span><span id="line-1104"></span><span id="local-6989586621679081939"><span class="annot"><a href="Control.ResourceRegistry.html#unsafeRelease"><span class="hs-identifier hs-type">unsafeRelease</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1105"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081939"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081939"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1106"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-type">ResourceKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081939"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1107"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081939"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081939"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1108"></span><span id="unsafeRelease"><span class="annot"><span class="annottext">unsafeRelease :: forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m) =&gt;
ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="Control.ResourceRegistry.html#unsafeRelease"><span class="hs-identifier hs-var hs-var">unsafeRelease</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-type">ResourceKey</span></a></span><span> </span><span id="local-6989586621679083466"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083466"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679083467"><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083467"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1109"></span><span>    </span><span class="annot"><span class="annottext">m (Maybe (Context m)) -&gt; m (Maybe (Context m))
forall a. m a -&gt; m a
forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(m (Maybe (Context m)) -&gt; m (Maybe (Context m)))
-&gt; m (Maybe (Context m)) -&gt; m (Maybe (Context m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1110"></span><span>      </span><span id="local-6989586621679083468"><span class="annot"><span class="annottext">Maybe (Resource m)
</span><a href="#local-6989586621679083468"><span class="hs-identifier hs-var">mResource</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; State (RegistryState m) (Maybe (Resource m))
-&gt; m (Maybe (Resource m))
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
ResourceRegistry m -&gt; State (RegistryState m) a -&gt; m a
</span><a href="Control.ResourceRegistry.html#updateState"><span class="hs-identifier hs-var">updateState</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083466"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">(State (RegistryState m) (Maybe (Resource m))
 -&gt; m (Maybe (Resource m)))
-&gt; State (RegistryState m) (Maybe (Resource m))
-&gt; m (Maybe (Resource m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId -&gt; State (RegistryState m) (Maybe (Resource m))
forall (m :: * -&gt; *).
ResourceId -&gt; State (RegistryState m) (Maybe (Resource m))
</span><a href="Control.ResourceRegistry.html#removeResource"><span class="hs-identifier hs-var">removeResource</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083467"><span class="hs-identifier hs-var">rid</span></a></span><span>
</span><span id="line-1111"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Resource m)
</span><a href="#local-6989586621679083468"><span class="hs-identifier hs-var">mResource</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1112"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Resource m)
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Context m) -&gt; m (Maybe (Context m))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Context m)
forall a. Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1113"></span><span>        </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679083469"><span class="annot"><span class="annottext">Resource m
</span><a href="#local-6989586621679083469"><span class="hs-identifier hs-var">resource</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1114"></span><span>          </span><span id="local-6989586621679083470"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679083470"><span class="hs-identifier hs-var">actuallyReleased</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Resource m -&gt; m Bool
forall (m :: * -&gt; *). Resource m -&gt; m Bool
</span><a href="Control.ResourceRegistry.html#releaseResource"><span class="hs-identifier hs-var">releaseResource</span></a></span><span> </span><span class="annot"><span class="annottext">Resource m
</span><a href="#local-6989586621679083469"><span class="hs-identifier hs-var">resource</span></a></span><span>
</span><span id="line-1115"></span><span>          </span><span class="annot"><span class="annottext">Maybe (Context m) -&gt; m (Maybe (Context m))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Context m) -&gt; m (Maybe (Context m)))
-&gt; Maybe (Context m) -&gt; m (Maybe (Context m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1116"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679083470"><span class="hs-identifier hs-var">actuallyReleased</span></a></span><span>
</span><span id="line-1117"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Context m -&gt; Maybe (Context m)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Resource m -&gt; Context m
forall (m :: * -&gt; *). Resource m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#resourceContext"><span class="hs-identifier hs-var">resourceContext</span></a></span><span> </span><span class="annot"><span class="annottext">Resource m
</span><a href="#local-6989586621679083469"><span class="hs-identifier hs-var">resource</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1118"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (Context m)
forall a. Maybe a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1119"></span><span>
</span><span id="line-1120"></span><span class="hs-comment">-- | Release all resources in the 'ResourceRegistry' without closing.</span><span>
</span><span id="line-1121"></span><span class="hs-comment">--</span><span>
</span><span id="line-1122"></span><span class="hs-comment">-- See 'closeRegistry' for more details.</span><span>
</span><span id="line-1123"></span><span id="local-6989586621679081941"><span class="annot"><a href="Control.ResourceRegistry.html#releaseAll"><span class="hs-identifier hs-type">releaseAll</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1124"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081941"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081941"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081941"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1125"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081941"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1126"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081941"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1127"></span><span id="releaseAll"><span class="annot"><span class="annottext">releaseAll :: forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m, MonadThread m, HasCallStack) =&gt;
ResourceRegistry m -&gt; m ()
</span><a href="Control.ResourceRegistry.html#releaseAll"><span class="hs-identifier hs-var hs-var">releaseAll</span></a></span></span><span> </span><span id="local-6989586621679083500"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083500"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1128"></span><span>    </span><span id="local-6989586621679083501"><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083501"><span class="hs-identifier hs-var">context</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Context m)
forall (m :: * -&gt; *).
(MonadThread m, HasCallStack) =&gt;
m (Context m)
</span><a href="Control.ResourceRegistry.html#captureContext"><span class="hs-identifier hs-var">captureContext</span></a></span><span>
</span><span id="line-1129"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context m -&gt; ThreadId m
forall (m :: * -&gt; *). Context m -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#contextThreadId"><span class="hs-identifier hs-var">contextThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083501"><span class="hs-identifier hs-var">context</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; ThreadId m -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Context m -&gt; ThreadId m
forall (m :: * -&gt; *). Context m -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#contextThreadId"><span class="hs-identifier hs-var">contextThreadId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; Context m
forall (m :: * -&gt; *). ResourceRegistry m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#registryContext"><span class="hs-identifier hs-var">registryContext</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083500"><span class="hs-identifier hs-var">rr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1130"></span><span>      </span><span class="annot"><span class="annottext">ResourceRegistryThreadException -&gt; m ()
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(ResourceRegistryThreadException -&gt; m ())
-&gt; ResourceRegistryThreadException -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistryClosedFromWrongThread"><span class="hs-identifier hs-type">ResourceRegistryClosedFromWrongThread</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1131"></span><span>          </span><span class="annot"><span class="annottext">resourceRegistryCreatedIn :: Context m
</span><a href="Control.ResourceRegistry.html#resourceRegistryCreatedIn"><span class="hs-identifier hs-var">resourceRegistryCreatedIn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; Context m
forall (m :: * -&gt; *). ResourceRegistry m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#registryContext"><span class="hs-identifier hs-var">registryContext</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083500"><span class="hs-identifier hs-var">rr</span></a></span><span>
</span><span id="line-1132"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">resourceRegistryUsedIn :: Context m
</span><a href="Control.ResourceRegistry.html#resourceRegistryUsedIn"><span class="hs-identifier hs-var">resourceRegistryUsedIn</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083501"><span class="hs-identifier hs-var">context</span></a></span><span>
</span><span id="line-1133"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1134"></span><span>    </span><span class="annot"><span class="annottext">m [Context m] -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m [Context m] -&gt; m ()) -&gt; m [Context m] -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; Context m
-&gt; (ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; m [Context m]
forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m, MonadThread m) =&gt;
ResourceRegistry m
-&gt; Context m
-&gt; (ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; m [Context m]
</span><a href="Control.ResourceRegistry.html#releaseAllHelper"><span class="hs-identifier hs-var">releaseAllHelper</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083500"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083501"><span class="hs-identifier hs-var">context</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceKey m -&gt; m (Maybe (Context m))
forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m, MonadThread m, HasCallStack) =&gt;
ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="Control.ResourceRegistry.html#release"><span class="hs-identifier hs-var">release</span></a></span><span>
</span><span id="line-1135"></span><span>
</span><span id="line-1136"></span><span class="hs-comment">-- | This is to 'releaseAll' what 'unsafeRelease' is to 'release': we do not</span><span>
</span><span id="line-1137"></span><span class="hs-comment">-- insist that this funciton is called from a thread that is known to the</span><span>
</span><span id="line-1138"></span><span class="hs-comment">-- registry. See 'unsafeRelease' for why this is dangerous.</span><span>
</span><span id="line-1139"></span><span id="local-6989586621679083502"><span class="annot"><a href="Control.ResourceRegistry.html#unsafeReleaseAll"><span class="hs-identifier hs-type">unsafeReleaseAll</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1140"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679083502"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679083502"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679083502"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1141"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679083502"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1142"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679083502"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1143"></span><span id="unsafeReleaseAll"><span class="annot"><span class="annottext">unsafeReleaseAll :: forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m, MonadThread m, HasCallStack) =&gt;
ResourceRegistry m -&gt; m ()
</span><a href="Control.ResourceRegistry.html#unsafeReleaseAll"><span class="hs-identifier hs-var hs-var">unsafeReleaseAll</span></a></span></span><span> </span><span id="local-6989586621679083520"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083520"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1144"></span><span>    </span><span id="local-6989586621679083521"><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083521"><span class="hs-identifier hs-var">context</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Context m)
forall (m :: * -&gt; *).
(MonadThread m, HasCallStack) =&gt;
m (Context m)
</span><a href="Control.ResourceRegistry.html#captureContext"><span class="hs-identifier hs-var">captureContext</span></a></span><span>
</span><span id="line-1145"></span><span>    </span><span class="annot"><span class="annottext">m [Context m] -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m [Context m] -&gt; m ()) -&gt; m [Context m] -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; Context m
-&gt; (ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; m [Context m]
forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m, MonadThread m) =&gt;
ResourceRegistry m
-&gt; Context m
-&gt; (ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; m [Context m]
</span><a href="Control.ResourceRegistry.html#releaseAllHelper"><span class="hs-identifier hs-var">releaseAllHelper</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083520"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083521"><span class="hs-identifier hs-var">context</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceKey m -&gt; m (Maybe (Context m))
forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m) =&gt;
ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="Control.ResourceRegistry.html#unsafeRelease"><span class="hs-identifier hs-var">unsafeRelease</span></a></span><span>
</span><span id="line-1146"></span><span>
</span><span id="line-1147"></span><span class="annot"><span class="hs-comment">-- | Internal helper used by 'releaseAll' and 'unsafeReleaseAll'.</span></span><span>
</span><span id="line-1148"></span><span id="local-6989586621679081674"><span class="annot"><a href="Control.ResourceRegistry.html#releaseAllHelper"><span class="hs-identifier hs-type">releaseAllHelper</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1149"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081674"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081674"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081674"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1150"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081674"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1151"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081674"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1152"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-type">ResourceKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081674"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081674"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081674"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1153"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ How to release a resource</span></span><span>
</span><span id="line-1154"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081674"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081674"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-1155"></span><span id="releaseAllHelper"><span class="annot"><span class="annottext">releaseAllHelper :: forall (m :: * -&gt; *).
(MonadMask m, MonadSTM m, MonadThread m) =&gt;
ResourceRegistry m
-&gt; Context m
-&gt; (ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; m [Context m]
</span><a href="Control.ResourceRegistry.html#releaseAllHelper"><span class="hs-identifier hs-var hs-var">releaseAllHelper</span></a></span></span><span> </span><span id="local-6989586621679083536"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083536"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679083537"><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083537"><span class="hs-identifier hs-var">context</span></a></span></span><span> </span><span id="local-6989586621679083538"><span class="annot"><span class="annottext">ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="#local-6989586621679083538"><span class="hs-identifier hs-var">releaser</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m [Context m] -&gt; m [Context m]
forall a. m a -&gt; m a
forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(m [Context m] -&gt; m [Context m]) -&gt; m [Context m] -&gt; m [Context m]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1156"></span><span>    </span><span id="local-6989586621679083539"><span class="annot"><span class="annottext">Either PrettyCallStack [ResourceId]
</span><a href="#local-6989586621679083539"><span class="hs-identifier hs-var">mKeys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId])
-&gt; m (Either PrettyCallStack [ResourceId])
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
ResourceRegistry m -&gt; State (RegistryState m) a -&gt; m a
</span><a href="Control.ResourceRegistry.html#updateState"><span class="hs-identifier hs-var">updateState</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083536"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">(State (RegistryState m) (Either PrettyCallStack [ResourceId])
 -&gt; m (Either PrettyCallStack [ResourceId]))
-&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId])
-&gt; m (Either PrettyCallStack [ResourceId])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State (RegistryState m) [ResourceId]
-&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId])
forall (m :: * -&gt; *) a.
State (RegistryState m) a
-&gt; State (RegistryState m) (Either PrettyCallStack a)
</span><a href="Control.ResourceRegistry.html#unlessClosed"><span class="hs-identifier hs-var">unlessClosed</span></a></span><span> </span><span class="annot"><span class="annottext">(State (RegistryState m) [ResourceId]
 -&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId]))
-&gt; State (RegistryState m) [ResourceId]
-&gt; State (RegistryState m) (Either PrettyCallStack [ResourceId])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RegistryState m -&gt; [ResourceId])
-&gt; State (RegistryState m) [ResourceId]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">RegistryState m -&gt; [ResourceId]
forall (m :: * -&gt; *). RegistryState m -&gt; [ResourceId]
</span><a href="Control.ResourceRegistry.html#getYoungestToOldest"><span class="hs-identifier hs-var">getYoungestToOldest</span></a></span><span>
</span><span id="line-1157"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either PrettyCallStack [ResourceId]
</span><a href="#local-6989586621679083539"><span class="hs-identifier hs-var">mKeys</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1158"></span><span>      </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679083540"><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679083540"><span class="hs-identifier hs-var">closed</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; Context m -&gt; PrettyCallStack -&gt; m [Context m]
forall (m :: * -&gt; *) x.
(MonadThrow m, MonadThread m) =&gt;
ResourceRegistry m -&gt; Context m -&gt; PrettyCallStack -&gt; m x
</span><a href="Control.ResourceRegistry.html#throwRegistryClosed"><span class="hs-identifier hs-var">throwRegistryClosed</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083536"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083537"><span class="hs-identifier hs-var">context</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679083540"><span class="hs-identifier hs-var">closed</span></a></span><span>
</span><span id="line-1159"></span><span>      </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679083541"><span class="annot"><span class="annottext">[ResourceId]
</span><a href="#local-6989586621679083541"><span class="hs-identifier hs-var">keys</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; [ResourceId]
-&gt; (ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; m [Context m]
forall (m :: * -&gt; *).
MonadCatch m =&gt;
ResourceRegistry m
-&gt; [ResourceId]
-&gt; (ResourceKey m -&gt; m (Maybe (Context m)))
-&gt; m [Context m]
</span><a href="Control.ResourceRegistry.html#releaseResources"><span class="hs-identifier hs-var">releaseResources</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083536"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">[ResourceId]
</span><a href="#local-6989586621679083541"><span class="hs-identifier hs-var">keys</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="#local-6989586621679083538"><span class="hs-identifier hs-var">releaser</span></a></span><span>
</span><span id="line-1160"></span><span>
</span><span id="line-1161"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Threads
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1164"></span><span>
</span><span id="line-1165"></span><span class="hs-comment">-- | Thread</span><span>
</span><span id="line-1166"></span><span class="hs-comment">--</span><span>
</span><span id="line-1167"></span><span class="hs-comment">-- The internals of this type are not exported.</span><span>
</span><span id="line-1168"></span><span class="hs-keyword">data</span><span> </span><span id="Thread"><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-var">Thread</span></a></span></span><span> </span><span id="local-6989586621679081945"><span class="annot"><a href="#local-6989586621679081945"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679081946"><span class="annot"><a href="#local-6989586621679081946"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="Thread"><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-var">Thread</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1169"></span><span>      </span><span class="annot"><span class="hs-comment">-- | The underlying @async@ thread id</span></span><span>
</span><span id="line-1170"></span><span>      </span><span id="threadId"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Thread m a -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#threadId"><span class="hs-identifier hs-var hs-var">threadId</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679081945"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1171"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="threadResourceId"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Thread m a -&gt; ResourceId
</span><a href="Control.ResourceRegistry.html#threadResourceId"><span class="hs-identifier hs-var hs-var">threadResourceId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span>
</span><span id="line-1172"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="threadAsync"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Thread m a -&gt; Async m a
</span><a href="Control.ResourceRegistry.html#threadAsync"><span class="hs-identifier hs-var hs-var">threadAsync</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679081945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081946"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1173"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="threadRegistry"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Thread m a -&gt; ResourceRegistry m
</span><a href="Control.ResourceRegistry.html#threadRegistry"><span class="hs-identifier hs-var hs-var">threadRegistry</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081945"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1174"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-1175"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679083551"><span id="local-6989586621679083556"><span id="local-6989586621679083561"><span class="annot"><span class="annottext">Context -&gt; Thread m a -&gt; IO (Maybe ThunkInfo)
Proxy (Thread m a) -&gt; String
(Context -&gt; Thread m a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; Thread m a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (Thread m a) -&gt; String)
-&gt; NoThunks (Thread m a)
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
forall (m :: * -&gt; *) a.
Context -&gt; Thread m a -&gt; IO (Maybe ThunkInfo)
forall (m :: * -&gt; *) a. Proxy (Thread m a) -&gt; String
$cnoThunks :: forall (m :: * -&gt; *) a.
Context -&gt; Thread m a -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; Thread m a -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall (m :: * -&gt; *) a.
Context -&gt; Thread m a -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; Thread m a -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: forall (m :: * -&gt; *) a. Proxy (Thread m a) -&gt; String
showTypeOf :: Proxy (Thread m a) -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OnlyCheckWhnfNamed</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Thread&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081946"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1176"></span><span>
</span><span id="line-1177"></span><span class="annot"><span class="hs-comment">-- | 'Eq' instance for 'Thread' compares 'threadId' only.</span></span><span>
</span><span id="line-1178"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679081963"><span id="local-6989586621679081964"><span id="local-6989586621679083569"><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081963"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081963"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081964"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1179"></span><span>  </span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">threadId :: forall (m :: * -&gt; *) a. Thread m a -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#threadId"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679083574"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083574"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679083575"><span class="annot"><span class="annottext">== :: Thread m a -&gt; Thread m a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></a></span></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">threadId :: forall (m :: * -&gt; *) a. Thread m a -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#threadId"><span class="hs-identifier hs-var">threadId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679083578"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083578"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083574"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; ThreadId m -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083578"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1180"></span><span>
</span><span id="line-1181"></span><span class="hs-comment">-- | Cancel a thread</span><span>
</span><span id="line-1182"></span><span class="hs-comment">--</span><span>
</span><span id="line-1183"></span><span class="hs-comment">-- This is a synchronous operation: the thread will have terminated when this</span><span>
</span><span id="line-1184"></span><span class="hs-comment">-- function returns.</span><span>
</span><span id="line-1185"></span><span class="hs-comment">--</span><span>
</span><span id="line-1186"></span><span class="hs-comment">-- Uses 'uninterruptibleCancel' because that's what 'withAsync' does.</span><span>
</span><span id="line-1187"></span><span id="local-6989586621679081965"><span id="local-6989586621679081967"><span class="annot"><a href="Control.ResourceRegistry.html#cancelThread"><span class="hs-identifier hs-type">cancelThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span> </span><span class="annot"><a href="#local-6989586621679081965"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081965"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081967"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081965"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1188"></span><span id="cancelThread"><span class="annot"><span class="annottext">cancelThread :: forall (m :: * -&gt; *) a. MonadAsync m =&gt; Thread m a -&gt; m ()
</span><a href="Control.ResourceRegistry.html#cancelThread"><span class="hs-identifier hs-var hs-var">cancelThread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m a -&gt; m ()
forall a. Async m a -&gt; m ()
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; m ()
</span><span class="hs-identifier hs-var">uninterruptibleCancel</span></span><span> </span><span class="annot"><span class="annottext">(Async m a -&gt; m ())
-&gt; (Thread m a -&gt; Async m a) -&gt; Thread m a -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Thread m a -&gt; Async m a
forall (m :: * -&gt; *) a. Thread m a -&gt; Async m a
</span><a href="Control.ResourceRegistry.html#threadAsync"><span class="hs-identifier hs-var">threadAsync</span></a></span><span>
</span><span id="line-1189"></span><span>
</span><span id="line-1190"></span><span class="hs-comment">-- | Wait for thread to terminate and return its result.</span><span>
</span><span id="line-1191"></span><span class="hs-comment">--</span><span>
</span><span id="line-1192"></span><span class="hs-comment">-- If the thread throws an exception, this will rethrow that exception.</span><span>
</span><span id="line-1193"></span><span class="hs-comment">--</span><span>
</span><span id="line-1194"></span><span class="hs-comment">-- NOTE: If A waits on B, and B is linked to the registry, and B throws an</span><span>
</span><span id="line-1195"></span><span class="hs-comment">-- exception, then A might /either/ receive the exception thrown by B /or/</span><span>
</span><span id="line-1196"></span><span class="hs-comment">-- the 'Control.Exception.ThreadKilled' exception thrown by the registry.</span><span>
</span><span id="line-1197"></span><span id="local-6989586621679081972"><span id="local-6989586621679081973"><span class="annot"><a href="Control.ResourceRegistry.html#waitThread"><span class="hs-identifier hs-type">waitThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span> </span><span class="annot"><a href="#local-6989586621679081972"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081972"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081973"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081972"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081973"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1198"></span><span id="waitThread"><span class="annot"><span class="annottext">waitThread :: forall (m :: * -&gt; *) a. MonadAsync m =&gt; Thread m a -&gt; m a
</span><a href="Control.ResourceRegistry.html#waitThread"><span class="hs-identifier hs-var hs-var">waitThread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m a -&gt; m a
forall a. Async m a -&gt; m a
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; m a
</span><span class="hs-identifier hs-var">wait</span></span><span> </span><span class="annot"><span class="annottext">(Async m a -&gt; m a)
-&gt; (Thread m a -&gt; Async m a) -&gt; Thread m a -&gt; m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Thread m a -&gt; Async m a
forall (m :: * -&gt; *) a. Thread m a -&gt; Async m a
</span><a href="Control.ResourceRegistry.html#threadAsync"><span class="hs-identifier hs-var">threadAsync</span></a></span><span>
</span><span id="line-1199"></span><span>
</span><span id="line-1200"></span><span class="annot"><span class="hs-comment">-- | Lift 'waitAny' to 'Thread'</span></span><span>
</span><span id="line-1201"></span><span class="annot"><a href="Control.ResourceRegistry.html#waitAnyThread"><span class="hs-identifier hs-type">waitAnyThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679081977"><span class="annot"><a href="#local-6989586621679081977"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679081978"><span class="annot"><a href="#local-6989586621679081978"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span> </span><span class="annot"><a href="#local-6989586621679081977"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081977"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081978"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081977"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081978"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1202"></span><span id="waitAnyThread"><span class="annot"><span class="annottext">waitAnyThread :: forall (m :: * -&gt; *) a. MonadAsync m =&gt; [Thread m a] -&gt; m a
</span><a href="Control.ResourceRegistry.html#waitAnyThread"><span class="hs-identifier hs-var hs-var">waitAnyThread</span></a></span></span><span> </span><span id="local-6989586621679083594"><span class="annot"><span class="annottext">[Thread m a]
</span><a href="#local-6989586621679083594"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Async m a, a) -&gt; a
forall a b. (a, b) -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">((Async m a, a) -&gt; a) -&gt; m (Async m a, a) -&gt; m a
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Async m a] -&gt; m (Async m a, a)
forall a. [Async m a] -&gt; m (Async m a, a)
forall (m :: * -&gt; *) a.
MonadAsync m =&gt;
[Async m a] -&gt; m (Async m a, a)
</span><span class="hs-identifier hs-var">waitAny</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Thread m a -&gt; Async m a) -&gt; [Thread m a] -&gt; [Async m a]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Thread m a -&gt; Async m a
forall (m :: * -&gt; *) a. Thread m a -&gt; Async m a
</span><a href="Control.ResourceRegistry.html#threadAsync"><span class="hs-identifier hs-var">threadAsync</span></a></span><span> </span><span class="annot"><span class="annottext">[Thread m a]
</span><a href="#local-6989586621679083594"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1203"></span><span>
</span><span id="line-1204"></span><span class="annot"><span class="hs-comment">-- | Fork a new thread</span></span><span>
</span><span id="line-1205"></span><span class="annot"><a href="Control.ResourceRegistry.html#forkThread"><span class="hs-identifier hs-type">forkThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1206"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679081982"><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679081983"><span class="annot"><a href="#local-6989586621679081983"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1207"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1208"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1209"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Label for the thread</span></span><span>
</span><span id="line-1210"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081983"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1211"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081983"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1212"></span><span id="forkThread"><span class="annot"><span class="annottext">forkThread :: forall (m :: * -&gt; *) a.
(MonadMask m, MonadAsync m, HasCallStack) =&gt;
ResourceRegistry m -&gt; String -&gt; m a -&gt; m (Thread m a)
</span><a href="Control.ResourceRegistry.html#forkThread"><span class="hs-identifier hs-var hs-var">forkThread</span></a></span></span><span> </span><span id="local-6989586621679083631"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083631"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679083632"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679083632"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621679083633"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679083633"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ResourceKey m, Thread m a) -&gt; Thread m a
forall a b. (a, b) -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">((ResourceKey m, Thread m a) -&gt; Thread m a)
-&gt; m (ResourceKey m, Thread m a) -&gt; m (Thread m a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-1213"></span><span>    </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; (ResourceId -&gt; m (Thread m a))
-&gt; (Thread m a -&gt; m ())
-&gt; m (ResourceKey m, Thread m a)
forall (m :: * -&gt; *) a.
(MonadSTM m, MonadMask m, MonadThread m, HasCallStack) =&gt;
ResourceRegistry m
-&gt; (ResourceId -&gt; m a) -&gt; (a -&gt; m ()) -&gt; m (ResourceKey m, a)
</span><a href="Control.ResourceRegistry.html#allocate"><span class="hs-identifier hs-var">allocate</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083631"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679083634"><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083634"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ResourceId -&gt; Async m a -&gt; Thread m a
</span><a href="#local-6989586621679083635"><span class="hs-identifier hs-var">mkThread</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083634"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">(Async m a -&gt; Thread m a) -&gt; m (Async m a) -&gt; m (Thread m a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; m (Async m a)
forall a. m a -&gt; m (Async m a)
forall (m :: * -&gt; *) a. MonadAsync m =&gt; m a -&gt; m (Async m a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResourceId -&gt; m a
</span><a href="#local-6989586621679083637"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083634"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Thread m a -&gt; m ()
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Thread m a -&gt; m ()
</span><a href="Control.ResourceRegistry.html#cancelThread"><span class="hs-identifier hs-var">cancelThread</span></a></span><span>
</span><span id="line-1214"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1215"></span><span>    </span><span class="annot"><a href="#local-6989586621679083635"><span class="hs-identifier hs-type">mkThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081983"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081983"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1216"></span><span>    </span><span id="local-6989586621679083635"><span class="annot"><span class="annottext">mkThread :: ResourceId -&gt; Async m a -&gt; Thread m a
</span><a href="#local-6989586621679083635"><span class="hs-identifier hs-var hs-var">mkThread</span></a></span></span><span> </span><span id="local-6989586621679083638"><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083638"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span id="local-6989586621679083639"><span class="annot"><span class="annottext">Async m a
</span><a href="#local-6989586621679083639"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1217"></span><span>          </span><span class="annot"><span class="annottext">threadId :: ThreadId m
</span><a href="Control.ResourceRegistry.html#threadId"><span class="hs-identifier hs-var">threadId</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m a -&gt; ThreadId m
forall a. Async m a -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m a
</span><a href="#local-6989586621679083639"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-1218"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">threadResourceId :: ResourceId
</span><a href="Control.ResourceRegistry.html#threadResourceId"><span class="hs-identifier hs-var">threadResourceId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083638"><span class="hs-identifier hs-var">rid</span></a></span><span>
</span><span id="line-1219"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">threadAsync :: Async m a
</span><a href="Control.ResourceRegistry.html#threadAsync"><span class="hs-identifier hs-var">threadAsync</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m a
</span><a href="#local-6989586621679083639"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-1220"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">threadRegistry :: ResourceRegistry m
</span><a href="Control.ResourceRegistry.html#threadRegistry"><span class="hs-identifier hs-var">threadRegistry</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083631"><span class="hs-identifier hs-var">rr</span></a></span><span>
</span><span id="line-1221"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1222"></span><span>
</span><span id="line-1223"></span><span>    </span><span class="annot"><a href="#local-6989586621679083637"><span class="hs-identifier hs-type">body'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081983"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1224"></span><span>    </span><span id="local-6989586621679083637"><span class="annot"><span class="annottext">body' :: ResourceId -&gt; m a
</span><a href="#local-6989586621679083637"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span> </span><span id="local-6989586621679083641"><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083641"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1225"></span><span>        </span><span id="local-6989586621679083642"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083642"><span class="hs-identifier hs-var">me</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (ThreadId m)
forall (m :: * -&gt; *). MonadThread m =&gt; m (ThreadId m)
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-1226"></span><span>        </span><span class="annot"><span class="annottext">ThreadId m -&gt; String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; ThreadId m -&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThread</span></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083642"><span class="hs-identifier hs-var">me</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679083632"><span class="hs-keyword hs-var">label</span></a></span><span>
</span><span id="line-1227"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId m -&gt; m ()
</span><a href="#local-6989586621679083645"><span class="hs-identifier hs-var">registerThread</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083642"><span class="hs-identifier hs-var">me</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m a -&gt; m a
forall a b. m a -&gt; m b -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679083633"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m a -&gt; m () -&gt; m a
forall a b. m a -&gt; m b -&gt; m a
forall (m :: * -&gt; *) a b. MonadThrow m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`finally`</span></span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; ResourceId -&gt; m ()
</span><a href="#local-6989586621679083647"><span class="hs-identifier hs-var">unregisterThread</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083642"><span class="hs-identifier hs-var">me</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083641"><span class="hs-identifier hs-var">rid</span></a></span><span>
</span><span id="line-1228"></span><span>
</span><span id="line-1229"></span><span>    </span><span class="hs-comment">-- Register the thread</span><span>
</span><span id="line-1230"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1231"></span><span>    </span><span class="hs-comment">-- We must add the thread to the list of known threads before the thread</span><span>
</span><span id="line-1232"></span><span>    </span><span class="hs-comment">-- will start to use the registry.</span><span>
</span><span id="line-1233"></span><span>    </span><span class="annot"><a href="#local-6989586621679083645"><span class="hs-identifier hs-type">registerThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1234"></span><span>    </span><span id="local-6989586621679083645"><span class="annot"><span class="annottext">registerThread :: ThreadId m -&gt; m ()
</span><a href="#local-6989586621679083645"><span class="hs-identifier hs-var hs-var">registerThread</span></a></span></span><span> </span><span id="local-6989586621679083648"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083648"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; State (RegistryState m) () -&gt; m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
ResourceRegistry m -&gt; State (RegistryState m) a -&gt; m a
</span><a href="Control.ResourceRegistry.html#updateState"><span class="hs-identifier hs-var">updateState</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083631"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">(State (RegistryState m) () -&gt; m ())
-&gt; State (RegistryState m) () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; State (RegistryState m) ()
forall (m :: * -&gt; *).
MonadThread m =&gt;
ThreadId m -&gt; State (RegistryState m) ()
</span><a href="Control.ResourceRegistry.html#insertThread"><span class="hs-identifier hs-var">insertThread</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083648"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-1235"></span><span>
</span><span id="line-1236"></span><span>    </span><span class="hs-comment">-- Unregister the thread</span><span>
</span><span id="line-1237"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1238"></span><span>    </span><span class="hs-comment">-- Threads are the only kinds of resources that &quot;deallocate themselves&quot;.</span><span>
</span><span id="line-1239"></span><span>    </span><span class="hs-comment">-- We remove the thread from the resources as well as the set of known</span><span>
</span><span id="line-1240"></span><span>    </span><span class="hs-comment">-- threads, so that these datastructures do not grow without bound.</span><span>
</span><span id="line-1241"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1242"></span><span>    </span><span class="hs-comment">-- This runs with asynchronous exceptions masked (due to 'finally'),</span><span>
</span><span id="line-1243"></span><span>    </span><span class="hs-comment">-- though for the current implementation of 'unregisterThread' this</span><span>
</span><span id="line-1244"></span><span>    </span><span class="hs-comment">-- makes no difference.</span><span>
</span><span id="line-1245"></span><span>    </span><span class="annot"><a href="#local-6989586621679083647"><span class="hs-identifier hs-type">unregisterThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceId"><span class="hs-identifier hs-type">ResourceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1246"></span><span>    </span><span id="local-6989586621679083647"><span class="annot"><span class="annottext">unregisterThread :: ThreadId m -&gt; ResourceId -&gt; m ()
</span><a href="#local-6989586621679083647"><span class="hs-identifier hs-var hs-var">unregisterThread</span></a></span></span><span> </span><span id="local-6989586621679083649"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083649"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span id="local-6989586621679083650"><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083650"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1247"></span><span>        </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; State (RegistryState m) () -&gt; m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
ResourceRegistry m -&gt; State (RegistryState m) a -&gt; m a
</span><a href="Control.ResourceRegistry.html#updateState"><span class="hs-identifier hs-var">updateState</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083631"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">(State (RegistryState m) () -&gt; m ())
-&gt; State (RegistryState m) () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1248"></span><span>          </span><span class="annot"><span class="annottext">ThreadId m -&gt; State (RegistryState m) ()
forall (m :: * -&gt; *).
MonadThread m =&gt;
ThreadId m -&gt; State (RegistryState m) ()
</span><a href="Control.ResourceRegistry.html#removeThread"><span class="hs-identifier hs-var">removeThread</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083649"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-1249"></span><span>          </span><span class="annot"><span class="annottext">StateT (RegistryState m) Identity (Maybe (Resource m))
-&gt; State (RegistryState m) ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT (RegistryState m) Identity (Maybe (Resource m))
 -&gt; State (RegistryState m) ())
-&gt; StateT (RegistryState m) Identity (Maybe (Resource m))
-&gt; State (RegistryState m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId
-&gt; StateT (RegistryState m) Identity (Maybe (Resource m))
forall (m :: * -&gt; *).
ResourceId -&gt; State (RegistryState m) (Maybe (Resource m))
</span><a href="Control.ResourceRegistry.html#removeResource"><span class="hs-identifier hs-var">removeResource</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679083650"><span class="hs-identifier hs-var">rid</span></a></span><span>
</span><span id="line-1250"></span><span>
</span><span id="line-1251"></span><span class="hs-comment">-- | Bracketed version of 'forkThread'</span><span>
</span><span id="line-1252"></span><span class="hs-comment">--</span><span>
</span><span id="line-1253"></span><span class="hs-comment">-- The analogue of 'withAsync' for the registry.</span><span>
</span><span id="line-1254"></span><span class="hs-comment">--</span><span>
</span><span id="line-1255"></span><span class="hs-comment">-- Scoping thread lifetime using 'withThread' is important when a parent</span><span>
</span><span id="line-1256"></span><span class="hs-comment">-- thread wants to link to a child thread /and handle any exceptions arising</span><span>
</span><span id="line-1257"></span><span class="hs-comment">-- from the link/:</span><span>
</span><span id="line-1258"></span><span class="hs-comment">--</span><span>
</span><span id="line-1259"></span><span class="hs-comment">-- &gt; let handleLinkException :: ExceptionInLinkedThread -&gt; m ()</span><span>
</span><span id="line-1260"></span><span class="hs-comment">-- &gt;     handleLinkException = ..</span><span>
</span><span id="line-1261"></span><span class="hs-comment">-- &gt; in handle handleLinkException $</span><span>
</span><span id="line-1262"></span><span class="hs-comment">-- &gt;      withThread registry codeInChild $ \child -&gt;</span><span>
</span><span id="line-1263"></span><span class="hs-comment">-- &gt;        ..</span><span>
</span><span id="line-1264"></span><span class="hs-comment">--</span><span>
</span><span id="line-1265"></span><span class="hs-comment">-- instead of</span><span>
</span><span id="line-1266"></span><span class="hs-comment">--</span><span>
</span><span id="line-1267"></span><span class="hs-comment">-- &gt; handle handleLinkException $ do  -- PROBABLY NOT CORRECT!</span><span>
</span><span id="line-1268"></span><span class="hs-comment">-- &gt;   child &lt;- forkThread registry codeInChild</span><span>
</span><span id="line-1269"></span><span class="hs-comment">-- &gt;   ..</span><span>
</span><span id="line-1270"></span><span class="hs-comment">--</span><span>
</span><span id="line-1271"></span><span class="hs-comment">-- where the parent may exit the scope of the exception handler before the child</span><span>
</span><span id="line-1272"></span><span class="hs-comment">-- terminates. If the lifetime of the child cannot be limited to the lifetime of</span><span>
</span><span id="line-1273"></span><span class="hs-comment">-- the parent, the child should probably be linked to the registry instead and</span><span>
</span><span id="line-1274"></span><span class="hs-comment">-- the thread that spawned the registry should handle any exceptions.</span><span>
</span><span id="line-1275"></span><span class="hs-comment">--</span><span>
</span><span id="line-1276"></span><span class="hs-comment">-- Note that in /principle/ there is no problem in using 'withAsync' alongside a</span><span>
</span><span id="line-1277"></span><span class="hs-comment">-- registry. After all, in a pattern like</span><span>
</span><span id="line-1278"></span><span class="hs-comment">--</span><span>
</span><span id="line-1279"></span><span class="hs-comment">-- &gt; withRegistry $ \registry -&gt;</span><span>
</span><span id="line-1280"></span><span class="hs-comment">-- &gt;   ..</span><span>
</span><span id="line-1281"></span><span class="hs-comment">-- &gt;   withAsync (.. registry ..) $ \async -&gt;</span><span>
</span><span id="line-1282"></span><span class="hs-comment">-- &gt;     ..</span><span>
</span><span id="line-1283"></span><span class="hs-comment">--</span><span>
</span><span id="line-1284"></span><span class="hs-comment">-- the async will be cancelled when leaving the scope of 'withAsync' and so</span><span>
</span><span id="line-1285"></span><span class="hs-comment">-- that reference to the registry, or indeed any of the resources inside the</span><span>
</span><span id="line-1286"></span><span class="hs-comment">-- registry, is safe. However, the registry implements a sanity check that the</span><span>
</span><span id="line-1287"></span><span class="hs-comment">-- registry is only used from known threads. This is useful: when a thread that</span><span>
</span><span id="line-1288"></span><span class="hs-comment">-- is not known to the registry (in other words, whose lifetime is not tied to</span><span>
</span><span id="line-1289"></span><span class="hs-comment">-- the lifetime of the registry) spawns a resource in that registry, that</span><span>
</span><span id="line-1290"></span><span class="hs-comment">-- resource may well be deallocated before the thread terminates, leading to</span><span>
</span><span id="line-1291"></span><span class="hs-comment">-- undefined and hard to debug behaviour (indeed, whether or not this results in</span><span>
</span><span id="line-1292"></span><span class="hs-comment">-- problems may well depend on precise timing); an exception that is thrown when</span><span>
</span><span id="line-1293"></span><span class="hs-comment">-- /allocating/ the resource is (more) deterministic and easier to debug.</span><span>
</span><span id="line-1294"></span><span class="hs-comment">-- Unfortunately, it means that the above pattern is not applicable, as the</span><span>
</span><span id="line-1295"></span><span class="hs-comment">-- thread spawned by 'withAsync' is not known to the registry, and so if it were</span><span>
</span><span id="line-1296"></span><span class="hs-comment">-- to try to use the registry, the registry would throw an error (even though</span><span>
</span><span id="line-1297"></span><span class="hs-comment">-- this pattern is actually safe). This situation is not ideal, but for now we</span><span>
</span><span id="line-1298"></span><span class="hs-comment">-- merely provide an alternative to 'withAsync' that /does/ register the thread</span><span>
</span><span id="line-1299"></span><span class="hs-comment">-- with the registry.</span><span>
</span><span id="line-1300"></span><span class="hs-comment">--</span><span>
</span><span id="line-1301"></span><span class="hs-comment">-- NOTE: Threads that are spawned out of the user's control but that must still</span><span>
</span><span id="line-1302"></span><span class="hs-comment">-- make use of the registry can use the unsafe API. This should be used with</span><span>
</span><span id="line-1303"></span><span class="hs-comment">-- caution, however.</span><span>
</span><span id="line-1304"></span><span id="local-6989586621679081988"><span id="local-6989586621679081989"><span id="local-6989586621679081990"><span class="annot"><a href="Control.ResourceRegistry.html#withThread"><span class="hs-identifier hs-type">withThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1305"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081988"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span> </span><span class="annot"><a href="#local-6989586621679081988"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1306"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081988"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1307"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Label for the thread</span></span><span>
</span><span id="line-1308"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081989"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1309"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081989"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081990"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1310"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081990"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1311"></span><span id="withThread"><span class="annot"><span class="annottext">withThread :: forall (m :: * -&gt; *) a b.
(MonadMask m, MonadAsync m) =&gt;
ResourceRegistry m -&gt; String -&gt; m a -&gt; (Thread m a -&gt; m b) -&gt; m b
</span><a href="Control.ResourceRegistry.html#withThread"><span class="hs-identifier hs-var hs-var">withThread</span></a></span></span><span> </span><span id="local-6989586621679083661"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083661"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679083662"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679083662"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621679083663"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679083663"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Thread m a)
-&gt; (Thread m a -&gt; m ()) -&gt; (Thread m a -&gt; m b) -&gt; m b
forall a b c. m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
forall (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; String -&gt; m a -&gt; m (Thread m a)
forall (m :: * -&gt; *) a.
(MonadMask m, MonadAsync m, HasCallStack) =&gt;
ResourceRegistry m -&gt; String -&gt; m a -&gt; m (Thread m a)
</span><a href="Control.ResourceRegistry.html#forkThread"><span class="hs-identifier hs-var">forkThread</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083661"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679083662"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679083663"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Thread m a -&gt; m ()
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Thread m a -&gt; m ()
</span><a href="Control.ResourceRegistry.html#cancelThread"><span class="hs-identifier hs-var">cancelThread</span></a></span><span>
</span><span id="line-1312"></span><span>
</span><span id="line-1313"></span><span class="annot"><span class="hs-comment">-- | Link specified 'Thread' to the (thread that created) the registry</span></span><span>
</span><span id="line-1314"></span><span id="local-6989586621679081994"><span id="local-6989586621679081996"><span class="annot"><a href="Control.ResourceRegistry.html#linkToRegistry"><span class="hs-identifier hs-type">linkToRegistry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span> </span><span class="annot"><a href="#local-6989586621679081994"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFork</span></span><span> </span><span class="annot"><a href="#local-6989586621679081994"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081994"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081994"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081996"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081994"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1315"></span><span id="linkToRegistry"><span class="annot"><span class="annottext">linkToRegistry :: forall (m :: * -&gt; *) a.
(MonadAsync m, MonadFork m, MonadMask m) =&gt;
Thread m a -&gt; m ()
</span><a href="Control.ResourceRegistry.html#linkToRegistry"><span class="hs-identifier hs-var hs-var">linkToRegistry</span></a></span></span><span> </span><span id="local-6989586621679083670"><span class="annot"><span class="annottext">Thread m a
</span><a href="#local-6989586621679083670"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; Async m a -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadAsync m, MonadFork m, MonadMask m) =&gt;
ThreadId m -&gt; Async m a -&gt; m ()
</span><a href="Control.ResourceRegistry.html#linkTo"><span class="hs-identifier hs-var">linkTo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; ThreadId m
forall (m :: * -&gt; *). ResourceRegistry m -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#registryThread"><span class="hs-identifier hs-var">registryThread</span></a></span><span> </span><span class="annot"><span class="annottext">(ResourceRegistry m -&gt; ThreadId m)
-&gt; ResourceRegistry m -&gt; ThreadId m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Thread m a -&gt; ResourceRegistry m
forall (m :: * -&gt; *) a. Thread m a -&gt; ResourceRegistry m
</span><a href="Control.ResourceRegistry.html#threadRegistry"><span class="hs-identifier hs-var">threadRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">Thread m a
</span><a href="#local-6989586621679083670"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Thread m a -&gt; Async m a
forall (m :: * -&gt; *) a. Thread m a -&gt; Async m a
</span><a href="Control.ResourceRegistry.html#threadAsync"><span class="hs-identifier hs-var">threadAsync</span></a></span><span> </span><span class="annot"><span class="annottext">Thread m a
</span><a href="#local-6989586621679083670"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1316"></span><span>
</span><span id="line-1317"></span><span class="hs-comment">-- | Fork a thread and link to it to the registry.</span><span>
</span><span id="line-1318"></span><span class="hs-comment">--</span><span>
</span><span id="line-1319"></span><span class="hs-comment">-- This function is just a convenience.</span><span>
</span><span id="line-1320"></span><span id="local-6989586621679082001"><span id="local-6989586621679082002"><span class="annot"><a href="Control.ResourceRegistry.html#forkLinkedThread"><span class="hs-identifier hs-type">forkLinkedThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1321"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span> </span><span class="annot"><a href="#local-6989586621679082001"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFork</span></span><span> </span><span class="annot"><a href="#local-6989586621679082001"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679082001"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1322"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082001"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1323"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Label for the thread</span></span><span>
</span><span id="line-1324"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679082001"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082002"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1325"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679082001"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082001"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082002"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1326"></span><span id="forkLinkedThread"><span class="annot"><span class="annottext">forkLinkedThread :: forall (m :: * -&gt; *) a.
(MonadAsync m, MonadFork m, MonadMask m, HasCallStack) =&gt;
ResourceRegistry m -&gt; String -&gt; m a -&gt; m (Thread m a)
</span><a href="Control.ResourceRegistry.html#forkLinkedThread"><span class="hs-identifier hs-var hs-var">forkLinkedThread</span></a></span></span><span> </span><span id="local-6989586621679083688"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083688"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679083689"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679083689"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621679083690"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679083690"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1327"></span><span>    </span><span id="local-6989586621679083691"><span class="annot"><span class="annottext">Thread m a
</span><a href="#local-6989586621679083691"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; String -&gt; m a -&gt; m (Thread m a)
forall (m :: * -&gt; *) a.
(MonadMask m, MonadAsync m, HasCallStack) =&gt;
ResourceRegistry m -&gt; String -&gt; m a -&gt; m (Thread m a)
</span><a href="Control.ResourceRegistry.html#forkThread"><span class="hs-identifier hs-var">forkThread</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083688"><span class="hs-identifier hs-var">rr</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679083689"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679083690"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1328"></span><span>    </span><span class="hs-comment">-- There is no race condition here between the new thread throwing an</span><span>
</span><span id="line-1329"></span><span>    </span><span class="hs-comment">-- exception and the 'linkToRegistry': if the thread /already/ threw the</span><span>
</span><span id="line-1330"></span><span>    </span><span class="hs-comment">-- exception when we link it, the exception will be raised immediately</span><span>
</span><span id="line-1331"></span><span>    </span><span class="hs-comment">-- (see 'linkTo' for details).</span><span>
</span><span id="line-1332"></span><span>    </span><span class="annot"><span class="annottext">Thread m a -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadAsync m, MonadFork m, MonadMask m) =&gt;
Thread m a -&gt; m ()
</span><a href="Control.ResourceRegistry.html#linkToRegistry"><span class="hs-identifier hs-var">linkToRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">Thread m a
</span><a href="#local-6989586621679083691"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1333"></span><span>    </span><span class="annot"><span class="annottext">Thread m a -&gt; m (Thread m a)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Thread m a
</span><a href="#local-6989586621679083691"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1334"></span><span>
</span><span id="line-1335"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Check that registry is used from known thread
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1338"></span><span>
</span><span id="line-1339"></span><span class="annot"><a href="Control.ResourceRegistry.html#ensureKnownThread"><span class="hs-identifier hs-type">ensureKnownThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1340"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679081932"><span class="annot"><a href="#local-6989586621679081932"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1341"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679081932"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081932"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679081932"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1342"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081932"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1343"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081932"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1344"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081932"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1345"></span><span id="ensureKnownThread"><span class="annot"><span class="annottext">ensureKnownThread :: forall (m :: * -&gt; *).
(MonadThrow m, MonadThread m, MonadSTM m) =&gt;
ResourceRegistry m -&gt; Context m -&gt; m ()
</span><a href="Control.ResourceRegistry.html#ensureKnownThread"><span class="hs-identifier hs-var hs-var">ensureKnownThread</span></a></span></span><span> </span><span id="local-6989586621679083717"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083717"><span class="hs-identifier hs-var">rr</span></a></span></span><span> </span><span id="local-6989586621679083718"><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083718"><span class="hs-identifier hs-var">context</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1346"></span><span>    </span><span id="local-6989586621679083719"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679083719"><span class="hs-identifier hs-var">isKnown</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679083720"><span class="hs-identifier hs-var">checkIsKnown</span></a></span><span>
</span><span id="line-1347"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679083719"><span class="hs-identifier hs-var">isKnown</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1348"></span><span>      </span><span class="annot"><span class="annottext">ResourceRegistryThreadException -&gt; m ()
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(ResourceRegistryThreadException -&gt; m ())
-&gt; ResourceRegistryThreadException -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistryUsedFromUntrackedThread"><span class="hs-identifier hs-type">ResourceRegistryUsedFromUntrackedThread</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1349"></span><span>                   </span><span class="annot"><span class="annottext">resourceRegistryCreatedIn :: Context m
</span><a href="Control.ResourceRegistry.html#resourceRegistryCreatedIn"><span class="hs-identifier hs-var">resourceRegistryCreatedIn</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; Context m
forall (m :: * -&gt; *). ResourceRegistry m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#registryContext"><span class="hs-identifier hs-var">registryContext</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083717"><span class="hs-identifier hs-var">rr</span></a></span><span>
</span><span id="line-1350"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">resourceRegistryUsedIn :: Context m
</span><a href="Control.ResourceRegistry.html#resourceRegistryUsedIn"><span class="hs-identifier hs-var">resourceRegistryUsedIn</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083718"><span class="hs-identifier hs-var">context</span></a></span><span>
</span><span id="line-1351"></span><span>                 </span><span class="hs-special">}</span><span>
</span><span id="line-1352"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1353"></span><span>    </span><span class="annot"><a href="#local-6989586621679083720"><span class="hs-identifier hs-type">checkIsKnown</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679081932"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-1354"></span><span>    </span><span id="local-6989586621679083720"><span class="annot"><span class="annottext">checkIsKnown :: m Bool
</span><a href="#local-6989586621679083720"><span class="hs-identifier hs-var hs-var">checkIsKnown</span></a></span></span><span>
</span><span id="line-1355"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Context m -&gt; ThreadId m
forall (m :: * -&gt; *). Context m -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#contextThreadId"><span class="hs-identifier hs-var">contextThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083718"><span class="hs-identifier hs-var">context</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; ThreadId m -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Context m -&gt; ThreadId m
forall (m :: * -&gt; *). Context m -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#contextThreadId"><span class="hs-identifier hs-var">contextThreadId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; Context m
forall (m :: * -&gt; *). ResourceRegistry m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#registryContext"><span class="hs-identifier hs-var">registryContext</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083717"><span class="hs-identifier hs-var">rr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1356"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-1357"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m Bool -&gt; m Bool
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m Bool -&gt; m Bool) -&gt; STM m Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1358"></span><span>          </span><span class="annot"><a href="Control.ResourceRegistry.html#KnownThreads"><span class="hs-identifier hs-type">KnownThreads</span></a></span><span> </span><span id="local-6989586621679083722"><span class="annot"><span class="annottext">Set (ThreadId m)
</span><a href="#local-6989586621679083722"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RegistryState m -&gt; KnownThreads m
forall (m :: * -&gt; *). RegistryState m -&gt; KnownThreads m
</span><a href="Control.ResourceRegistry.html#registryThreads"><span class="hs-identifier hs-var">registryThreads</span></a></span><span> </span><span class="annot"><span class="annottext">(RegistryState m -&gt; KnownThreads m)
-&gt; STM m (RegistryState m) -&gt; STM m (KnownThreads m)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (RegistryState m) -&gt; STM m (RegistryState m)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResourceRegistry m -&gt; StrictTVar m (RegistryState m)
forall (m :: * -&gt; *).
ResourceRegistry m -&gt; StrictTVar m (RegistryState m)
</span><a href="Control.ResourceRegistry.html#registryState"><span class="hs-identifier hs-var">registryState</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679083717"><span class="hs-identifier hs-var">rr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1359"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; STM m Bool
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; STM m Bool) -&gt; Bool -&gt; STM m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Context m -&gt; ThreadId m
forall (m :: * -&gt; *). Context m -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#contextThreadId"><span class="hs-identifier hs-var">contextThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">Context m
</span><a href="#local-6989586621679083718"><span class="hs-identifier hs-var">context</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; Set (ThreadId m) -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#member"><span class="hs-operator hs-var">`Set.member`</span></a></span><span> </span><span class="annot"><span class="annottext">Set (ThreadId m)
</span><a href="#local-6989586621679083722"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-1360"></span><span>
</span><span id="line-1361"></span><span class="hs-comment">-- | Registry used from untracked threads</span><span>
</span><span id="line-1362"></span><span class="hs-comment">--</span><span>
</span><span id="line-1363"></span><span class="hs-comment">-- If this exception is raised, it indicates a bug in the caller.</span><span>
</span><span id="line-1364"></span><span class="hs-keyword">data</span><span> </span><span id="ResourceRegistryThreadException"><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistryThreadException"><span class="hs-identifier hs-var">ResourceRegistryThreadException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1365"></span><span>    </span><span class="hs-comment">-- | If the registry is used from an untracked thread, we cannot do proper</span><span>
</span><span id="line-1366"></span><span>    </span><span class="hs-comment">-- reference counting. The following threads are /tracked/: the thread</span><span>
</span><span id="line-1367"></span><span>    </span><span class="hs-comment">-- that spawned the registry and all threads spawned by the registry.</span><span>
</span><span id="line-1368"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679083724"><span class="annot"><a href="#local-6989586621679083724"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679083724"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="ResourceRegistryUsedFromUntrackedThread"><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistryUsedFromUntrackedThread"><span class="hs-identifier hs-var">ResourceRegistryUsedFromUntrackedThread</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1369"></span><span>          </span><span class="annot"><span class="hs-comment">-- | Information about the context in which the registry was created</span></span><span>
</span><span id="line-1370"></span><span>          </span><span id="resourceRegistryCreatedIn"><span class="annot"><span class="annottext">()
</span><a href="Control.ResourceRegistry.html#resourceRegistryCreatedIn"><span class="hs-identifier hs-var hs-var">resourceRegistryCreatedIn</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679083724"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1371"></span><span>
</span><span id="line-1372"></span><span>          </span><span class="annot"><span class="hs-comment">-- | The context in which it was used</span></span><span>
</span><span id="line-1373"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="resourceRegistryUsedIn"><span class="annot"><span class="annottext">()
</span><a href="Control.ResourceRegistry.html#resourceRegistryUsedIn"><span class="hs-identifier hs-var hs-var">resourceRegistryUsedIn</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679083724"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1374"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1375"></span><span>
</span><span id="line-1376"></span><span>    </span><span class="annot"><span class="hs-comment">-- | Registry closed from different threat than that created it</span></span><span>
</span><span id="line-1377"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679083725"><span class="annot"><a href="#local-6989586621679083725"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679083725"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="ResourceRegistryClosedFromWrongThread"><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistryClosedFromWrongThread"><span class="hs-identifier hs-var">ResourceRegistryClosedFromWrongThread</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1378"></span><span>          </span><span class="annot"><span class="hs-comment">-- | Information about the context in which the registry was created</span></span><span>
</span><span id="line-1379"></span><span>          </span><span id="resourceRegistryCreatedIn"><span class="annot"><a href="Control.ResourceRegistry.html#resourceRegistryCreatedIn"><span class="hs-identifier hs-var">resourceRegistryCreatedIn</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679083725"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1380"></span><span>
</span><span id="line-1381"></span><span>          </span><span class="annot"><span class="hs-comment">-- | The context in which it was used</span></span><span>
</span><span id="line-1382"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="resourceRegistryUsedIn"><span class="annot"><a href="Control.ResourceRegistry.html#resourceRegistryUsedIn"><span class="hs-identifier hs-var">resourceRegistryUsedIn</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679083725"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1383"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1384"></span><span>
</span><span id="line-1385"></span><span id="local-6989586621679083727"><span id="local-6989586621679083729"><span id="local-6989586621679083733"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistryThreadException"><span class="hs-identifier hs-type">ResourceRegistryThreadException</span></a></span></span></span></span><span>
</span><span id="line-1386"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679083740"><span id="local-6989586621679083743"><span id="local-6989586621679083746"><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#ResourceRegistryThreadException"><span class="hs-identifier hs-type">ResourceRegistryThreadException</span></a></span></span></span></span><span>
</span><span id="line-1387"></span><span>
</span><span id="line-1388"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Auxiliary: context
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1391"></span><span>
</span><span id="line-1392"></span><span class="hs-comment">-- | The internal context of a resource registry, recording a 'PrettyCallStack'</span><span>
</span><span id="line-1393"></span><span class="hs-comment">-- of its creation and the creator's 'ThreadId'</span><span>
</span><span id="line-1394"></span><span class="hs-keyword">data</span><span> </span><span id="Context"><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-var">Context</span></a></span></span><span> </span><span id="local-6989586621679081602"><span class="annot"><a href="#local-6989586621679081602"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081602"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="Context"><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-var">Context</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1395"></span><span>      </span><span class="annot"><span class="hs-comment">-- | CallStack in which it was created</span></span><span>
</span><span id="line-1396"></span><span>      </span><span id="contextCallStack"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Context m -&gt; PrettyCallStack
</span><a href="Control.ResourceRegistry.html#contextCallStack"><span class="hs-identifier hs-var hs-var">contextCallStack</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span>
</span><span id="line-1397"></span><span>
</span><span id="line-1398"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Thread that created the registry or resource</span></span><span>
</span><span id="line-1399"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="contextThreadId"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Context m -&gt; ThreadId m
</span><a href="Control.ResourceRegistry.html#contextThreadId"><span class="hs-identifier hs-var hs-var">contextThreadId</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679081602"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1400"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-1401"></span><span>
</span><span id="line-1402"></span><span class="hs-comment">-- Existential type; we can't use generics</span><span>
</span><span id="line-1403"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679081421"><span id="local-6989586621679083753"><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081421"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1404"></span><span>  </span><span id="local-6989586621679083757"><span class="annot"><span class="annottext">showTypeOf :: Proxy (Context m) -&gt; String
</span><a href="#local-6989586621679083757"><span class="hs-identifier hs-var hs-var hs-var hs-var">showTypeOf</span></a></span></span><span> </span><span class="annot"><span class="annottext">Proxy (Context m)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Context&quot;</span></span><span>
</span><span id="line-1405"></span><span>  </span><span id="local-6989586621679083759"><span class="annot"><span class="annottext">wNoThunks :: Context -&gt; Context m -&gt; IO (Maybe ThunkInfo)
</span><a href="#local-6989586621679083759"><span class="hs-identifier hs-var hs-var hs-var hs-var">wNoThunks</span></a></span></span><span> </span><span id="local-6989586621679083761"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679083761"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span id="local-6989586621679083766"><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679083766"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621679083767"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083767"><span class="hs-identifier hs-var">tid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[IO (Maybe ThunkInfo)] -&gt; IO (Maybe ThunkInfo)
</span><span class="hs-identifier hs-var">allNoThunks</span></span><span>
</span><span id="line-1406"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Context -&gt; PrettyCallStack -&gt; IO (Maybe ThunkInfo)
forall a. NoThunks a =&gt; Context -&gt; a -&gt; IO (Maybe ThunkInfo)
</span><span class="hs-identifier hs-var">noThunks</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679083761"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyCallStack
</span><a href="#local-6989586621679083766"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-1407"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; InspectHeapNamed &quot;ThreadId&quot; (ThreadId m) -&gt; IO (Maybe ThunkInfo)
forall a. NoThunks a =&gt; Context -&gt; a -&gt; IO (Maybe ThunkInfo)
</span><span class="hs-identifier hs-var">noThunks</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679083761"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (name :: Symbol) a. a -&gt; InspectHeapNamed name a
</span><span class="hs-identifier hs-var">InspectHeapNamed</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;ThreadId&quot;</span></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083767"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1408"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-1409"></span><span>
</span><span id="line-1410"></span><span id="local-6989586621679082012"><span id="local-6989586621679083772"><span id="local-6989586621679083774"><span id="local-6989586621679083777"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082012"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1411"></span><span>
</span><span id="line-1412"></span><span id="local-6989586621679081581"><span class="annot"><a href="Control.ResourceRegistry.html#captureContext"><span class="hs-identifier hs-type">captureContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThread</span></span><span> </span><span class="annot"><a href="#local-6989586621679081581"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081581"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081581"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1413"></span><span id="captureContext"><span class="annot"><span class="annottext">captureContext :: forall (m :: * -&gt; *).
(MonadThread m, HasCallStack) =&gt;
m (Context m)
</span><a href="Control.ResourceRegistry.html#captureContext"><span class="hs-identifier hs-var hs-var">captureContext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrettyCallStack -&gt; ThreadId m -&gt; Context m
forall (m :: * -&gt; *).
MonadThread m =&gt;
PrettyCallStack -&gt; ThreadId m -&gt; Context m
</span><a href="Control.ResourceRegistry.html#Context"><span class="hs-identifier hs-var">Context</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyCallStack
HasCallStack =&gt; PrettyCallStack
</span><a href="Control.ResourceRegistry.html#prettyCallStack"><span class="hs-identifier hs-var">prettyCallStack</span></a></span><span> </span><span class="annot"><span class="annottext">(ThreadId m -&gt; Context m) -&gt; m (ThreadId m) -&gt; m (Context m)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">m (ThreadId m)
forall (m :: * -&gt; *). MonadThread m =&gt; m (ThreadId m)
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-1414"></span><span>
</span><span id="line-1415"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Misc utilities
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1418"></span><span>
</span><span id="line-1419"></span><span class="hs-comment">-- | Generalization of 'link' that links an async to an arbitrary thread.</span><span>
</span><span id="line-1420"></span><span class="hs-comment">--</span><span>
</span><span id="line-1421"></span><span class="hs-comment">-- Non standard (not in 'async' library)</span><span>
</span><span id="line-1422"></span><span class="hs-comment">--</span><span>
</span><span id="line-1423"></span><span id="local-6989586621679081999"><span id="local-6989586621679082000"><span class="annot"><a href="Control.ResourceRegistry.html#linkTo"><span class="hs-identifier hs-type">linkTo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1424"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span> </span><span class="annot"><a href="#local-6989586621679081999"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFork</span></span><span> </span><span class="annot"><a href="#local-6989586621679081999"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679081999"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1425"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679081999"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1426"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679081999"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082000"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1427"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081999"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1428"></span><span id="linkTo"><span class="annot"><span class="annottext">linkTo :: forall (m :: * -&gt; *) a.
(MonadAsync m, MonadFork m, MonadMask m) =&gt;
ThreadId m -&gt; Async m a -&gt; m ()
</span><a href="Control.ResourceRegistry.html#linkTo"><span class="hs-identifier hs-var hs-var">linkTo</span></a></span></span><span> </span><span id="local-6989586621679083797"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083797"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; (SomeException -&gt; Bool) -&gt; Async m a -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadAsync m, MonadFork m, MonadMask m) =&gt;
ThreadId m -&gt; (SomeException -&gt; Bool) -&gt; Async m a -&gt; m ()
</span><a href="Control.ResourceRegistry.html#linkToOnly"><span class="hs-identifier hs-var">linkToOnly</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083797"><span class="hs-identifier hs-var">tid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (SomeException -&gt; Bool) -&gt; SomeException -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Bool
</span><a href="Control.ResourceRegistry.html#isCancel"><span class="hs-identifier hs-var">isCancel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1429"></span><span>
</span><span id="line-1430"></span><span class="hs-comment">-- | Generalization of 'linkOnly' that links an async to an arbitrary thread.</span><span>
</span><span id="line-1431"></span><span class="hs-comment">--</span><span>
</span><span id="line-1432"></span><span class="hs-comment">-- Non standard (not in 'async' library).</span><span>
</span><span id="line-1433"></span><span class="hs-comment">--</span><span>
</span><span id="line-1434"></span><span class="annot"><a href="Control.ResourceRegistry.html#linkToOnly"><span class="hs-identifier hs-type">linkToOnly</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1435"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679082016"><span class="annot"><a href="#local-6989586621679082016"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679082017"><span class="annot"><a href="#local-6989586621679082017"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1436"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span> </span><span class="annot"><a href="#local-6989586621679082016"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFork</span></span><span> </span><span class="annot"><a href="#local-6989586621679082016"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679082016"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1437"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679082016"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1438"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Exception.Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1439"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679082016"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082017"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1440"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679082016"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1441"></span><span id="linkToOnly"><span class="annot"><span class="annottext">linkToOnly :: forall (m :: * -&gt; *) a.
(MonadAsync m, MonadFork m, MonadMask m) =&gt;
ThreadId m -&gt; (SomeException -&gt; Bool) -&gt; Async m a -&gt; m ()
</span><a href="Control.ResourceRegistry.html#linkToOnly"><span class="hs-identifier hs-var hs-var">linkToOnly</span></a></span></span><span> </span><span id="local-6989586621679083825"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083825"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span id="local-6989586621679083826"><span class="annot"><span class="annottext">SomeException -&gt; Bool
</span><a href="#local-6989586621679083826"><span class="hs-identifier hs-var">shouldThrow</span></a></span></span><span> </span><span id="local-6989586621679083827"><span class="annot"><span class="annottext">Async m a
</span><a href="#local-6989586621679083827"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1442"></span><span>    </span><span class="annot"><span class="annottext">m (ThreadId m) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ThreadId m) -&gt; m ()) -&gt; m (ThreadId m) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; m () -&gt; m (ThreadId m)
forall (m :: * -&gt; *) a.
(MonadFork m, MonadMask m) =&gt;
String -&gt; m a -&gt; m (ThreadId m)
</span><a href="Control.ResourceRegistry.html#forkRepeat"><span class="hs-identifier hs-var">forkRepeat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;linkToOnly &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083829"><span class="hs-identifier hs-var">linkedThreadId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m (ThreadId m)) -&gt; m () -&gt; m (ThreadId m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1443"></span><span>      </span><span id="local-6989586621679083830"><span class="annot"><span class="annottext">Either SomeException a
</span><a href="#local-6989586621679083830"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Async m a -&gt; m (Either SomeException a)
forall a. Async m a -&gt; m (Either SomeException a)
forall (m :: * -&gt; *) a.
MonadAsync m =&gt;
Async m a -&gt; m (Either SomeException a)
</span><span class="hs-identifier hs-var">waitCatch</span></span><span> </span><span class="annot"><span class="annottext">Async m a
</span><a href="#local-6989586621679083827"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1444"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either SomeException a
</span><a href="#local-6989586621679083830"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1445"></span><span>        </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679083832"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679083832"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Bool
</span><a href="#local-6989586621679083826"><span class="hs-identifier hs-var">shouldThrow</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679083832"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; ExceptionInLinkedThread -&gt; m ()
forall e. Exception e =&gt; ThreadId m -&gt; e -&gt; m ()
forall (m :: * -&gt; *) e.
(MonadFork m, Exception e) =&gt;
ThreadId m -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">throwTo</span></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083825"><span class="hs-identifier hs-var">tid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; ExceptionInLinkedThread
</span><a href="#local-6989586621679083834"><span class="hs-identifier hs-var">exceptionInLinkedThread</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679083832"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1446"></span><span>        </span><span id="local-6989586621679083835"><span class="annot"><span class="annottext">Either SomeException a
</span><a href="#local-6989586621679083835"><span class="hs-identifier hs-var">_otherwise</span></a></span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1447"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1448"></span><span>    </span><span class="annot"><a href="#local-6989586621679083829"><span class="hs-identifier hs-type">linkedThreadId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679082016"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1449"></span><span>    </span><span id="local-6989586621679083829"><span class="annot"><span class="annottext">linkedThreadId :: ThreadId m
</span><a href="#local-6989586621679083829"><span class="hs-identifier hs-var hs-var">linkedThreadId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Async m a -&gt; ThreadId m
forall a. Async m a -&gt; ThreadId m
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; ThreadId m
</span><span class="hs-identifier hs-var">asyncThreadId</span></span><span> </span><span class="annot"><span class="annottext">Async m a
</span><a href="#local-6989586621679083827"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1450"></span><span>
</span><span id="line-1451"></span><span>    </span><span class="annot"><a href="#local-6989586621679083834"><span class="hs-identifier hs-type">exceptionInLinkedThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Exception.Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptionInLinkedThread</span></span><span>
</span><span id="line-1452"></span><span>    </span><span id="local-6989586621679083834"><span class="annot"><span class="annottext">exceptionInLinkedThread :: SomeException -&gt; ExceptionInLinkedThread
</span><a href="#local-6989586621679083834"><span class="hs-identifier hs-var hs-var">exceptionInLinkedThread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1453"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; SomeException -&gt; ExceptionInLinkedThread
</span><span class="hs-identifier hs-var">ExceptionInLinkedThread</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId m -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679083829"><span class="hs-identifier hs-var">linkedThreadId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1454"></span><span>
</span><span id="line-1455"></span><span class="annot"><a href="Control.ResourceRegistry.html#isCancel"><span class="hs-identifier hs-type">isCancel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Exception.Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-1456"></span><span id="isCancel"><span class="annot"><span class="annottext">isCancel :: SomeException -&gt; Bool
</span><a href="Control.ResourceRegistry.html#isCancel"><span class="hs-identifier hs-var hs-var">isCancel</span></a></span></span><span> </span><span id="local-6989586621679083837"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679083837"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-1457"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncCancelled
</span><span class="hs-identifier hs-var">AsyncCancelled</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe AsyncCancelled
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Exception.Type.html#fromException"><span class="hs-identifier hs-var">fromException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679083837"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-1458"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-1459"></span><span>
</span><span id="line-1460"></span><span id="local-6989586621679082022"><span id="local-6989586621679082023"><span class="annot"><a href="Control.ResourceRegistry.html#forkRepeat"><span class="hs-identifier hs-type">forkRepeat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadFork</span></span><span> </span><span class="annot"><a href="#local-6989586621679082022"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679082022"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679082022"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082023"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679082022"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679082022"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1461"></span><span id="forkRepeat"><span class="annot"><span class="annottext">forkRepeat :: forall (m :: * -&gt; *) a.
(MonadFork m, MonadMask m) =&gt;
String -&gt; m a -&gt; m (ThreadId m)
</span><a href="Control.ResourceRegistry.html#forkRepeat"><span class="hs-identifier hs-var hs-var">forkRepeat</span></a></span></span><span> </span><span id="local-6989586621679083853"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679083853"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621679083854"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679083854"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1462"></span><span>  </span><span class="annot"><span class="annottext">((forall a. m a -&gt; m a) -&gt; m (ThreadId m)) -&gt; m (ThreadId m)
forall b. ((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">mask</span></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; m a) -&gt; m (ThreadId m)) -&gt; m (ThreadId m))
-&gt; ((forall a. m a -&gt; m a) -&gt; m (ThreadId m)) -&gt; m (ThreadId m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679083856"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679083856"><span class="hs-identifier hs-var">restore</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1463"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679083866"><span class="annot"><span class="annottext">go :: m ()
</span><a href="#local-6989586621679083866"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679083867"><span class="annot"><span class="annottext">Either SomeException a
</span><a href="#local-6989586621679083867"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m a -&gt; m (Either SomeException a)
forall (m :: * -&gt; *) a.
MonadCatch m =&gt;
m a -&gt; m (Either SomeException a)
</span><a href="Control.ResourceRegistry.html#tryAll"><span class="hs-identifier hs-var">tryAll</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m a -&gt; m a
forall a. m a -&gt; m a
</span><a href="#local-6989586621679083856"><span class="hs-identifier hs-var">restore</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679083854"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1464"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either SomeException a
</span><a href="#local-6989586621679083867"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1465"></span><span>                  </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679083866"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-1466"></span><span>                  </span><span class="annot"><span class="annottext">Either SomeException a
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1467"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m (ThreadId m)
forall (m :: * -&gt; *). MonadFork m =&gt; m () -&gt; m (ThreadId m)
</span><span class="hs-identifier hs-var">forkIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679083853"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall a b. m a -&gt; m b -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679083866"><span class="hs-identifier hs-var">go</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1468"></span><span>
</span><span id="line-1469"></span><span id="local-6989586621679082029"><span id="local-6989586621679082030"><span class="annot"><a href="Control.ResourceRegistry.html#tryAll"><span class="hs-identifier hs-type">tryAll</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679082029"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679082029"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082030"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679082029"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Exception.Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679082030"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1470"></span><span id="tryAll"><span class="annot"><span class="annottext">tryAll :: forall (m :: * -&gt; *) a.
MonadCatch m =&gt;
m a -&gt; m (Either SomeException a)
</span><a href="Control.ResourceRegistry.html#tryAll"><span class="hs-identifier hs-var hs-var">tryAll</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m a -&gt; m (Either SomeException a)
forall e a. Exception e =&gt; m a -&gt; m (Either e a)
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span>
</span><span id="line-1471"></span><span>
</span><span id="line-1472"></span><span id="local-6989586621679081897"><span class="annot"><a href="Control.ResourceRegistry.html#mustBeRight"><span class="hs-identifier hs-type">mustBeRight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081897"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081897"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1473"></span><span id="mustBeRight"><span class="annot"><span class="annottext">mustBeRight :: forall a. Either Void a -&gt; a
</span><a href="Control.ResourceRegistry.html#mustBeRight"><span class="hs-identifier hs-var hs-var">mustBeRight</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span id="local-6989586621679083873"><span class="annot"><span class="annottext">Void
</span><a href="#local-6989586621679083873"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Void -&gt; a
forall a. Void -&gt; a
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#absurd"><span class="hs-identifier hs-var">absurd</span></a></span><span> </span><span class="annot"><span class="annottext">Void
</span><a href="#local-6989586621679083873"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1474"></span><span class="annot"><a href="Control.ResourceRegistry.html#mustBeRight"><span class="hs-identifier hs-var">mustBeRight</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679083875"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083875"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679083875"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1475"></span><span>
</span><span id="line-1476"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Auxiliary: CallStack with different Show instance
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1479"></span><span>
</span><span id="line-1480"></span><span class="annot"><span class="hs-comment">-- | CallStack with 'Show' instance using 'prettyCallStack'</span></span><span>
</span><span id="line-1481"></span><span class="hs-keyword">newtype</span><span> </span><span id="PrettyCallStack"><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-var">PrettyCallStack</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PrettyCallStack"><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-var">PrettyCallStack</span></a></span></span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#CallStack"><span class="hs-identifier hs-type">CallStack</span></a></span><span>
</span><span id="line-1482"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679083877"><span id="local-6989586621679083882"><span id="local-6989586621679083886"><span class="annot"><span class="annottext">Context -&gt; PrettyCallStack -&gt; IO (Maybe ThunkInfo)
Proxy PrettyCallStack -&gt; String
(Context -&gt; PrettyCallStack -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; PrettyCallStack -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy PrettyCallStack -&gt; String)
-&gt; NoThunks PrettyCallStack
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
$cnoThunks :: Context -&gt; PrettyCallStack -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; PrettyCallStack -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; PrettyCallStack -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; PrettyCallStack -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: Proxy PrettyCallStack -&gt; String
showTypeOf :: Proxy PrettyCallStack -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-1483"></span><span>
</span><span id="line-1484"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679083890"><span id="local-6989586621679083894"><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1485"></span><span>  </span><span id="local-6989586621679083896"><span class="annot"><span class="annottext">show :: PrettyCallStack -&gt; String
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#show"><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span> </span><span id="local-6989586621679083897"><span class="annot"><span class="annottext">CallStack
</span><a href="#local-6989586621679083897"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallStack -&gt; String
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Exception.html#prettyCallStack"><span class="hs-identifier hs-var">GHC.prettyCallStack</span></a></span><span> </span><span class="annot"><span class="annottext">CallStack
</span><a href="#local-6989586621679083897"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-1486"></span><span>
</span><span id="line-1487"></span><span class="annot"><span class="hs-comment">-- | Capture a 'PrettyCallStack'</span></span><span>
</span><span id="line-1488"></span><span class="annot"><a href="Control.ResourceRegistry.html#prettyCallStack"><span class="hs-identifier hs-type">prettyCallStack</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span>
</span><span id="line-1489"></span><span id="prettyCallStack"><span class="annot"><span class="annottext">prettyCallStack :: HasCallStack =&gt; PrettyCallStack
</span><a href="Control.ResourceRegistry.html#prettyCallStack"><span class="hs-identifier hs-var hs-var">prettyCallStack</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallStack -&gt; PrettyCallStack
</span><a href="Control.ResourceRegistry.html#PrettyCallStack"><span class="hs-identifier hs-var">PrettyCallStack</span></a></span><span> </span><span class="annot"><span class="annottext">CallStack
HasCallStack =&gt; CallStack
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Stack.html#callStack"><span class="hs-identifier hs-var">GHC.callStack</span></a></span><span>
</span><span id="line-1490"></span><span>
</span><span id="line-1491"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Orphan instance
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1494"></span><span>
</span><span id="line-1495"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679081455"><span id="local-6989586621679081456"><span id="local-6989586621679083906"><span id="local-6989586621679083910"><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679081455"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679081456"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1496"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bimap</span></span><span> </span><span class="annot"><a href="#local-6989586621679081455"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081456"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1497"></span><span>  </span><span id="local-6989586621679083923"><span class="annot"><span class="annottext">wNoThunks :: Context -&gt; Bimap k v -&gt; IO (Maybe ThunkInfo)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">wNoThunks</span></span></span><span> </span><span id="local-6989586621679083924"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679083924"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; [(k, v)] -&gt; IO (Maybe ThunkInfo)
forall k v.
(NoThunks k, NoThunks v) =&gt;
Context -&gt; [(k, v)] -&gt; IO (Maybe ThunkInfo)
</span><span class="hs-identifier hs-var">noThunksInKeysAndValues</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679083924"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">([(k, v)] -&gt; IO (Maybe ThunkInfo))
-&gt; (Bimap k v -&gt; [(k, v)]) -&gt; Bimap k v -&gt; IO (Maybe ThunkInfo)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q976m622jbq42nf9zkhq5axjca5xj9w0-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Bimap k v -&gt; [(k, v)]
forall a b. Bimap a b -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">Bimap.toList</span></span><span>
</span><span id="line-1498"></span></pre></body></html>