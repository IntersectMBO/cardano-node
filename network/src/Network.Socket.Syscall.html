<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span class="hs-cpp">

#include &quot;HsNetDef.h&quot;
</span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.Socket.Syscall</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.Marshal.Utils.html"><span class="hs-identifier">Foreign.Marshal.Utils</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.Marshal.Utils.html#with"><span class="hs-identifier">with</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span class="hs-cpp">
# if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO.Error</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">catchIOError</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bracket</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">FunPtr</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Conc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">asyncDoProc</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Error.html"><span class="hs-identifier">Foreign.C.Error</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Error.html#getErrno"><span class="hs-identifier">getErrno</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Error.html#eINTR"><span class="hs-identifier">eINTR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Error.html#eINPROGRESS"><span class="hs-identifier">eINPROGRESS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Conc.html"><span class="hs-identifier">GHC.Conc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Conc.IO.html#threadWaitWrite"><span class="hs-identifier">threadWaitWrite</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#ifdef HAVE_ADVANCED_SOCKET_FLAGS
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.Socket.Cbits.html"><span class="hs-identifier">Network.Socket.Cbits</span></a></span><span class="hs-cpp">
#else
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network.Socket.Fcntl</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.Socket.Imports.html"><span class="hs-identifier">Network.Socket.Imports</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.Socket.Internal.html"><span class="hs-identifier">Network.Socket.Internal</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.Socket.Options.html"><span class="hs-identifier">Network.Socket.Options</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.Socket.Types.html"><span class="hs-identifier">Network.Socket.Types</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><span id="line-34"></span><span class="hs-comment">-- On Windows, our sockets are not put in non-blocking mode (non-blocking</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- is not supported for regular file descriptors on Windows, and it would</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- be a pain to support it only for sockets).  So there are two cases:</span><span>
</span><span id="line-37"></span><span class="hs-comment">--</span><span>
</span><span id="line-38"></span><span class="hs-comment">--  - the threaded RTS uses safe calls for socket operations to get</span><span>
</span><span id="line-39"></span><span class="hs-comment">--    non-blocking I/O, just like the rest of the I/O library</span><span>
</span><span id="line-40"></span><span class="hs-comment">--</span><span>
</span><span id="line-41"></span><span class="hs-comment">--  - with the non-threaded RTS, only some operations on sockets will be</span><span>
</span><span id="line-42"></span><span class="hs-comment">--    non-blocking.  Reads and writes go through the normal async I/O</span><span>
</span><span id="line-43"></span><span class="hs-comment">--    system.  accept() uses asyncDoProc so is non-blocking.  A handful</span><span>
</span><span id="line-44"></span><span class="hs-comment">--    of others (recvFrom, sendFd, recvFd) will block all threads - if this</span><span>
</span><span id="line-45"></span><span class="hs-comment">--    is a problem, -threaded is the workaround.</span><span>
</span><span id="line-46"></span><span class="hs-comment">--</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- Connection Functions</span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-comment">-- In the following connection and binding primitives.  The names of</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- the equivalent C functions have been preserved where possible. It</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- should be noted that some of these names used in the C library,</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- \tr{bind} in particular, have a different meaning to many Haskell</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- programmers and have thus been renamed by appending the prefix</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- Socket.</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-comment">-- | Create a new socket using the given address family, socket type</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- and protocol number.  The address family is usually 'AF_INET',</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- 'AF_INET6', or 'AF_UNIX'.  The socket type is usually 'Stream' or</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- 'Datagram'.  The protocol number is usually 'defaultProtocol'.</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- If 'AF_INET6' is used and the socket type is 'Stream' or 'Datagram',</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- the 'IPv6Only' socket option is set to 0 so that both IPv4 and IPv6</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- can be handled with one socket.</span><span>
</span><span id="line-65"></span><span class="hs-comment">--</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- &gt;&gt;&gt; import Network.Socket</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- &gt;&gt;&gt; import qualified Data.List.NonEmpty as NE</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- &gt;&gt;&gt; let hints = defaultHints { addrFlags = [AI_NUMERICHOST, AI_NUMERICSERV], addrSocketType = Stream }</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- &gt;&gt;&gt; addr &lt;- NE.head &lt;$&gt; getAddrInfo (Just hints) (Just &quot;127.0.0.1&quot;) (Just &quot;5000&quot;)</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- &gt;&gt;&gt; sock &lt;- socket (addrFamily addr) (addrSocketType addr) (addrProtocol addr)</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- &gt;&gt;&gt; Network.Socket.bind sock (addrAddress addr)</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- &gt;&gt;&gt; getSocketName sock</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- 127.0.0.1:5000</span><span>
</span><span id="line-74"></span><span class="annot"><a href="Network.Socket.Syscall.html#socket"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.Socket.Types.html#Family"><span class="hs-identifier hs-type">Family</span></a></span><span>         </span><span class="hs-comment">-- Family Name (usually AF_INET)</span><span>
</span><span id="line-75"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.Socket.Types.html#SocketType"><span class="hs-identifier hs-type">SocketType</span></a></span><span>     </span><span class="hs-comment">-- Socket Type (usually Stream)</span><span>
</span><span id="line-76"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.Socket.Types.html#ProtocolNumber"><span class="hs-identifier hs-type">ProtocolNumber</span></a></span><span> </span><span class="hs-comment">-- Protocol Number (getProtocolByName to find value)</span><span>
</span><span id="line-77"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a></span><span>      </span><span class="hs-comment">-- Unconnected Socket</span><span>
</span><span id="line-78"></span><span id="socket"><span class="annot"><span class="annottext">socket :: Family -&gt; SocketType -&gt; CInt -&gt; IO Socket
</span><a href="Network.Socket.Syscall.html#socket"><span class="hs-identifier hs-var hs-var">socket</span></a></span></span><span> </span><span id="local-6989586621679080953"><span class="annot"><span class="annottext">Family
</span><a href="#local-6989586621679080953"><span class="hs-keyword hs-var">family</span></a></span></span><span> </span><span id="local-6989586621679080954"><span class="annot"><span class="annottext">SocketType
</span><a href="#local-6989586621679080954"><span class="hs-identifier hs-var">stype</span></a></span></span><span> </span><span id="local-6989586621679080955"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679080955"><span class="hs-identifier hs-var">protocol</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO CInt -&gt; (CInt -&gt; IO CInt) -&gt; (CInt -&gt; IO Socket) -&gt; IO Socket
forall a b c. IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Control.Exception.Base.html#bracketOnError"><span class="hs-identifier hs-var">E.bracketOnError</span></a></span><span> </span><span class="annot"><span class="annottext">IO CInt
</span><a href="#local-6989586621679080957"><span class="hs-identifier hs-var">create</span></a></span><span> </span><span class="annot"><span class="annottext">CInt -&gt; IO CInt
</span><a href="Network.Socket.Types.html#c_close"><span class="hs-identifier hs-var">c_close</span></a></span><span> </span><span class="annot"><span class="annottext">((CInt -&gt; IO Socket) -&gt; IO Socket)
-&gt; (CInt -&gt; IO Socket) -&gt; IO Socket
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679080959"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679080959"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- Let's ensure that the socket (file descriptor) is closed even on</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-comment">-- asynchronous exceptions.</span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><span class="annottext">CInt -&gt; IO ()
forall {m :: * -&gt; *} {p}. Monad m =&gt; p -&gt; m ()
</span><a href="#local-6989586621679080960"><span class="hs-identifier hs-var">setNonBlock</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679080959"><span class="hs-identifier hs-var">fd</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span id="local-6989586621679080961"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679080961"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CInt -&gt; IO Socket
</span><a href="Network.Socket.Types.html#mkSocket"><span class="hs-identifier hs-var">mkSocket</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679080959"><span class="hs-identifier hs-var">fd</span></a></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-comment">-- This socket is not managed by the IO manager yet.</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-comment">-- So, we don't have to call &quot;close&quot; which uses &quot;closeFdWith&quot;.</span><span>
</span><span id="line-85"></span><span>    </span><span class="annot"><span class="annottext">Socket -&gt; IO ()
</span><a href="#local-6989586621679080963"><span class="hs-identifier hs-var">unsetIPv6Only</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679080961"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><span class="annottext">Socket -&gt; IO ()
</span><a href="#local-6989586621679080964"><span class="hs-identifier hs-var">setDontFragment</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679080961"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><span class="annottext">Socket -&gt; IO Socket
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679080961"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-89"></span><span>    </span><span id="local-6989586621679080957"><span class="annot"><span class="annottext">create :: IO CInt
</span><a href="#local-6989586621679080957"><span class="hs-identifier hs-var hs-var">create</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-90"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679080967"><span class="annot"><span class="annottext">c_stype :: CInt
</span><a href="#local-6989586621679080967"><span class="hs-identifier hs-var hs-var">c_stype</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CInt -&gt; CInt
</span><a href="#local-6989586621679080968"><span class="hs-identifier hs-var">modifyFlag</span></a></span><span> </span><span class="annot"><span class="annottext">(CInt -&gt; CInt) -&gt; CInt -&gt; CInt
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SocketType -&gt; CInt
</span><a href="Network.Socket.Types.html#packSocketType"><span class="hs-identifier hs-var">packSocketType</span></a></span><span> </span><span class="annot"><span class="annottext">SocketType
</span><a href="#local-6989586621679080954"><span class="hs-identifier hs-var">stype</span></a></span><span>
</span><span id="line-91"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; IO CInt -&gt; IO CInt
forall a. (Eq a, Num a) =&gt; String -&gt; IO a -&gt; IO a
</span><a href="Network.Socket.Internal.html#throwSocketErrorIfMinus1Retry"><span class="hs-identifier hs-var">throwSocketErrorIfMinus1Retry</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Network.Socket.socket&quot;</span></span><span> </span><span class="annot"><span class="annottext">(IO CInt -&gt; IO CInt) -&gt; IO CInt -&gt; IO CInt
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-92"></span><span>            </span><span class="annot"><span class="annottext">CInt -&gt; CInt -&gt; CInt -&gt; IO CInt
</span><a href="Network.Socket.Syscall.html#c_socket"><span class="hs-identifier hs-var">c_socket</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Family -&gt; CInt
</span><a href="Network.Socket.Types.html#packFamily"><span class="hs-identifier hs-var">packFamily</span></a></span><span> </span><span class="annot"><span class="annottext">Family
</span><a href="#local-6989586621679080953"><span class="hs-keyword hs-var">family</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679080967"><span class="hs-identifier hs-var">c_stype</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679080955"><span class="hs-identifier hs-var">protocol</span></a></span><span class="hs-cpp">

#ifdef HAVE_ADVANCED_SOCKET_FLAGS
</span><span>    </span><span id="local-6989586621679080968"><span class="annot"><span class="annottext">modifyFlag :: CInt -&gt; CInt
</span><a href="#local-6989586621679080968"><span class="hs-identifier hs-var hs-var">modifyFlag</span></a></span></span><span> </span><span id="local-6989586621679080975"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679080975"><span class="hs-identifier hs-var">c_stype</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679080975"><span class="hs-identifier hs-var">c_stype</span></a></span><span> </span><span class="annot"><span class="annottext">CInt -&gt; CInt -&gt; CInt
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="Network.Socket.Cbits.html#sockNonBlock"><span class="hs-identifier hs-var">sockNonBlock</span></a></span><span class="hs-cpp">
#else
</span><span>    </span><span class="hs-identifier">modifyFlag</span><span> </span><span class="hs-identifier">c_stype</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">c_stype</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#ifdef HAVE_ADVANCED_SOCKET_FLAGS
</span><span>    </span><span id="local-6989586621679080960"><span class="annot"><span class="annottext">setNonBlock :: p -&gt; m ()
</span><a href="#local-6989586621679080960"><span class="hs-identifier hs-var hs-var">setNonBlock</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span>    </span><span class="hs-identifier">setNonBlock</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">setNonBlockIfNeeded</span><span> </span><span class="hs-identifier">fd</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#if HAVE_DECL_IPV6_V6ONLY
</span><span>    </span><span id="local-6989586621679080963"><span class="annot"><span class="annottext">unsetIPv6Only :: Socket -&gt; IO ()
</span><a href="#local-6989586621679080963"><span class="hs-identifier hs-var hs-var">unsetIPv6Only</span></a></span></span><span> </span><span id="local-6989586621679080994"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679080994"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Family
</span><a href="#local-6989586621679080953"><span class="hs-keyword hs-var">family</span></a></span><span> </span><span class="annot"><span class="annottext">Family -&gt; Family -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Family
</span><a href="Network.Socket.Types.html#AF_INET6"><span class="hs-identifier hs-var">AF_INET6</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">SocketType
</span><a href="#local-6989586621679080954"><span class="hs-identifier hs-var">stype</span></a></span><span> </span><span class="annot"><span class="annottext">SocketType -&gt; [SocketType] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SocketType
</span><a href="Network.Socket.Types.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SocketType
</span><a href="Network.Socket.Types.html#Datagram"><span class="hs-identifier hs-var">Datagram</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span class="hs-cpp">
# if defined(mingw32_HOST_OS)
</span><span>      </span><span class="hs-comment">-- The IPv6Only option is only supported on Windows Vista and later,</span><span>
</span><span id="line-110"></span><span>      </span><span class="hs-comment">-- so trying to change it might throw an error.</span><span>
</span><span id="line-111"></span><span>      </span><span class="hs-identifier">setSocketOption</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier">IPv6Only</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">catchIOError</span><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
# elif defined(openbsd_HOST_OS)
</span><span>      </span><span class="hs-comment">-- don't change IPv6Only</span><span>
</span><span id="line-114"></span><span>      </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
# else
</span><span>      </span><span class="hs-comment">-- The default value of the IPv6Only option is platform specific,</span><span>
</span><span id="line-117"></span><span>      </span><span class="hs-comment">-- so we explicitly set it to 0 to provide a common default.</span><span>
</span><span id="line-118"></span><span>      </span><span class="annot"><span class="annottext">Socket -&gt; SocketOption -&gt; Int -&gt; IO ()
</span><a href="Network.Socket.Options.html#setSocketOption"><span class="hs-identifier hs-var">setSocketOption</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679080994"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SocketOption
</span><a href="Network.Socket.Options.html#IPv6Only"><span class="hs-identifier hs-var">IPv6Only</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-cpp">
# endif
</span><span class="hs-cpp">#else
</span><span>    </span><span class="hs-identifier">unsetIPv6Only</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-124"></span><span>    </span><span id="local-6989586621679080964"><span class="annot"><span class="annottext">setDontFragment :: Socket -&gt; IO ()
</span><a href="#local-6989586621679080964"><span class="hs-identifier hs-var hs-var">setDontFragment</span></a></span></span><span> </span><span id="local-6989586621679081001"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081001"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Family
</span><a href="#local-6989586621679080953"><span class="hs-keyword hs-var">family</span></a></span><span> </span><span class="annot"><span class="annottext">Family -&gt; Family -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Family
</span><a href="Network.Socket.Types.html#AF_INET"><span class="hs-identifier hs-var">AF_INET</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span class="hs-cpp">
#if HAVE_DECL_IP_DONTFRAG || HAVE_DECL_IP_MTU_DISCOVER
</span><span>      </span><span class="annot"><span class="annottext">Socket -&gt; SocketOption -&gt; Int -&gt; IO ()
</span><a href="Network.Socket.Options.html#setSocketOption"><span class="hs-identifier hs-var">setSocketOption</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081001"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SocketOption
</span><a href="Network.Socket.Options.html#DontFragment"><span class="hs-identifier hs-var">DontFragment</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-cpp">
#else
</span><span>      </span><span class="hs-comment">-- do nothing</span><span>
</span><span id="line-129"></span><span>      </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- Binding a socket</span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="hs-comment">-- | Bind the socket to an address. The socket must not already be</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- bound.  The 'Family' passed to @bind@ must be the</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- same as that passed to 'socket'.  If the special port number</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- 'defaultPort' is passed then the system assigns the next available</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- use port.</span><span>
</span><span id="line-141"></span><span id="local-6989586621679080885"><span class="annot"><a href="Network.Socket.Syscall.html#bind"><span class="hs-identifier hs-type">bind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.Socket.Types.html#SocketAddress"><span class="hs-identifier hs-type">SocketAddress</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080885"><span class="hs-identifier hs-type">sa</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080885"><span class="hs-identifier hs-type">sa</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-142"></span><span id="bind"><span class="annot"><span class="annottext">bind :: forall sa. SocketAddress sa =&gt; Socket -&gt; sa -&gt; IO ()
</span><a href="Network.Socket.Syscall.html#bind"><span class="hs-identifier hs-var hs-var">bind</span></a></span></span><span> </span><span id="local-6989586621679081011"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081011"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679081012"><span class="annot"><span class="annottext">sa
</span><a href="#local-6989586621679081012"><span class="hs-identifier hs-var">sa</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">sa -&gt; (Ptr sa -&gt; Int -&gt; IO ()) -&gt; IO ()
forall sa a.
SocketAddress sa =&gt;
sa -&gt; (Ptr sa -&gt; Int -&gt; IO a) -&gt; IO a
</span><a href="Network.Socket.Types.html#withSocketAddress"><span class="hs-identifier hs-var">withSocketAddress</span></a></span><span> </span><span class="annot"><span class="annottext">sa
</span><a href="#local-6989586621679081012"><span class="hs-identifier hs-var">sa</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr sa -&gt; Int -&gt; IO ()) -&gt; IO ())
-&gt; (Ptr sa -&gt; Int -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679081014"><span class="annot"><span class="annottext">Ptr sa
</span><a href="#local-6989586621679081014"><span class="hs-identifier hs-var">p_sa</span></a></span></span><span> </span><span id="local-6989586621679081015"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679081015"><span class="hs-identifier hs-var">siz</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO CInt -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO CInt -&gt; IO ()) -&gt; IO CInt -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Socket -&gt; (CInt -&gt; IO CInt) -&gt; IO CInt
forall r. Socket -&gt; (CInt -&gt; IO r) -&gt; IO r
</span><a href="Network.Socket.Types.html#withFdSocket"><span class="hs-identifier hs-var">withFdSocket</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081011"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">((CInt -&gt; IO CInt) -&gt; IO CInt) -&gt; (CInt -&gt; IO CInt) -&gt; IO CInt
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679081018"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081018"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679081021"><span class="annot"><span class="annottext">sz :: CInt
</span><a href="#local-6989586621679081021"><span class="hs-identifier hs-var hs-var">sz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; CInt
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679081015"><span class="hs-identifier hs-var">siz</span></a></span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO CInt -&gt; IO CInt
forall a. (Eq a, Num a) =&gt; String -&gt; IO a -&gt; IO a
</span><a href="Network.Socket.Internal.html#throwSocketErrorIfMinus1Retry"><span class="hs-identifier hs-var">throwSocketErrorIfMinus1Retry</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Network.Socket.bind&quot;</span></span><span> </span><span class="annot"><span class="annottext">(IO CInt -&gt; IO CInt) -&gt; IO CInt -&gt; IO CInt
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CInt -&gt; Ptr sa -&gt; CInt -&gt; IO CInt
forall sa. CInt -&gt; Ptr sa -&gt; CInt -&gt; IO CInt
</span><a href="Network.Socket.Syscall.html#c_bind"><span class="hs-identifier hs-var">c_bind</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081018"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr sa
</span><a href="#local-6989586621679081014"><span class="hs-identifier hs-var">p_sa</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081021"><span class="hs-identifier hs-var">sz</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- Connecting a socket</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="annot"><span class="hs-comment">-- | Connect to a remote socket at address.</span></span><span>
</span><span id="line-150"></span><span id="local-6989586621679081023"><span class="annot"><a href="Network.Socket.Syscall.html#connect"><span class="hs-identifier hs-type">connect</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.Socket.Types.html#SocketAddress"><span class="hs-identifier hs-type">SocketAddress</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081023"><span class="hs-identifier hs-type">sa</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679081023"><span class="hs-identifier hs-type">sa</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-151"></span><span id="connect"><span class="annot"><span class="annottext">connect :: forall sa. SocketAddress sa =&gt; Socket -&gt; sa -&gt; IO ()
</span><a href="Network.Socket.Syscall.html#connect"><span class="hs-identifier hs-var hs-var">connect</span></a></span></span><span> </span><span id="local-6989586621679081030"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081030"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679081031"><span class="annot"><span class="annottext">sa
</span><a href="#local-6989586621679081031"><span class="hs-identifier hs-var">sa</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><a href="Network.Socket.Internal.html#withSocketsDo"><span class="hs-identifier hs-var">withSocketsDo</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">sa -&gt; (Ptr sa -&gt; Int -&gt; IO ()) -&gt; IO ()
forall sa a.
SocketAddress sa =&gt;
sa -&gt; (Ptr sa -&gt; Int -&gt; IO a) -&gt; IO a
</span><a href="Network.Socket.Types.html#withSocketAddress"><span class="hs-identifier hs-var">withSocketAddress</span></a></span><span> </span><span class="annot"><span class="annottext">sa
</span><a href="#local-6989586621679081031"><span class="hs-identifier hs-var">sa</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr sa -&gt; Int -&gt; IO ()) -&gt; IO ())
-&gt; (Ptr sa -&gt; Int -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679081033"><span class="annot"><span class="annottext">Ptr sa
</span><a href="#local-6989586621679081033"><span class="hs-identifier hs-var">p_sa</span></a></span></span><span> </span><span id="local-6989586621679081034"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679081034"><span class="hs-identifier hs-var">sz</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><span class="annottext">Socket -&gt; Ptr sa -&gt; CInt -&gt; IO ()
forall sa. SocketAddress sa =&gt; Socket -&gt; Ptr sa -&gt; CInt -&gt; IO ()
</span><a href="Network.Socket.Syscall.html#connectLoop"><span class="hs-identifier hs-var">connectLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081030"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr sa
</span><a href="#local-6989586621679081033"><span class="hs-identifier hs-var">p_sa</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; CInt
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679081034"><span class="hs-identifier hs-var">sz</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span id="local-6989586621679080898"><span class="annot"><a href="Network.Socket.Syscall.html#connectLoop"><span class="hs-identifier hs-type">connectLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.Socket.Types.html#SocketAddress"><span class="hs-identifier hs-type">SocketAddress</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080898"><span class="hs-identifier hs-type">sa</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080898"><span class="hs-identifier hs-type">sa</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-155"></span><span id="connectLoop"><span class="annot"><span class="annottext">connectLoop :: forall sa. SocketAddress sa =&gt; Socket -&gt; Ptr sa -&gt; CInt -&gt; IO ()
</span><a href="Network.Socket.Syscall.html#connectLoop"><span class="hs-identifier hs-var hs-var">connectLoop</span></a></span></span><span> </span><span id="local-6989586621679081037"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081037"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679081038"><span class="annot"><span class="annottext">Ptr sa
</span><a href="#local-6989586621679081038"><span class="hs-identifier hs-var">p_sa</span></a></span></span><span> </span><span id="local-6989586621679081039"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081039"><span class="hs-identifier hs-var">sz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; (CInt -&gt; IO ()) -&gt; IO ()
forall r. Socket -&gt; (CInt -&gt; IO r) -&gt; IO r
</span><a href="Network.Socket.Types.html#withFdSocket"><span class="hs-identifier hs-var">withFdSocket</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081037"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">((CInt -&gt; IO ()) -&gt; IO ()) -&gt; (CInt -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679081040"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081040"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CInt -&gt; IO ()
</span><a href="#local-6989586621679081041"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081040"><span class="hs-identifier hs-var">fd</span></a></span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-157"></span><span>    </span><span id="local-6989586621679081044"><span class="annot"><span class="annottext">errLoc :: String
</span><a href="#local-6989586621679081044"><span class="hs-identifier hs-var hs-var">errLoc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Network.Socket.connect: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">Socket -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081037"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span id="local-6989586621679081041"><span class="annot"><span class="annottext">loop :: CInt -&gt; IO ()
</span><a href="#local-6989586621679081041"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621679081055"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081055"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-159"></span><span>       </span><span id="local-6989586621679081056"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081056"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CInt -&gt; Ptr sa -&gt; CInt -&gt; IO CInt
forall sa. CInt -&gt; Ptr sa -&gt; CInt -&gt; IO CInt
</span><a href="Network.Socket.Syscall.html#c_connect"><span class="hs-identifier hs-var">c_connect</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081055"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr sa
</span><a href="#local-6989586621679081038"><span class="hs-identifier hs-var">p_sa</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081039"><span class="hs-identifier hs-var">sz</span></a></span><span>
</span><span id="line-160"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081056"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">CInt -&gt; CInt -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">CInt
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span class="hs-cpp">
#if defined(mingw32_HOST_OS)
</span><span>           </span><span class="hs-identifier">throwSocketError</span><span> </span><span class="hs-identifier">errLoc</span><span class="hs-cpp">
#else
</span><span>           </span><span id="local-6989586621679081058"><span class="annot"><span class="annottext">Errno
</span><a href="#local-6989586621679081058"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Errno
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Error.html#getErrno"><span class="hs-identifier hs-var">getErrno</span></a></span><span>
</span><span id="line-165"></span><span>           </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-166"></span><span>             </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Errno
</span><a href="#local-6989586621679081058"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">Errno -&gt; Errno -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Errno
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Error.html#eINTR"><span class="hs-identifier hs-var">eINTR</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CInt -&gt; IO ()
</span><a href="#local-6989586621679081041"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081055"><span class="hs-identifier hs-var">fd</span></a></span><span>
</span><span id="line-167"></span><span>             </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Errno
</span><a href="#local-6989586621679081058"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">Errno -&gt; Errno -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Errno
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Error.html#eINPROGRESS"><span class="hs-identifier hs-var">eINPROGRESS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679081059"><span class="hs-identifier hs-var">connectBlocked</span></a></span><span>
</span><span id="line-168"></span><span class="hs-comment">--           _ | err == eAGAIN      -&gt; connectBlocked</span><span>
</span><span id="line-169"></span><span>             </span><span id="local-6989586621679081060"><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621679081060"><span class="hs-identifier hs-var">_otherwise</span></a></span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. String -&gt; IO a
</span><a href="Network.Socket.Internal.html#throwSocketError"><span class="hs-identifier hs-var">throwSocketError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679081044"><span class="hs-identifier hs-var">errLoc</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>    </span><span id="local-6989586621679081059"><span class="annot"><span class="annottext">connectBlocked :: IO ()
</span><a href="#local-6989586621679081059"><span class="hs-identifier hs-var hs-var">connectBlocked</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-172"></span><span>       </span><span class="annot"><span class="annottext">Socket -&gt; (CInt -&gt; IO ()) -&gt; IO ()
forall r. Socket -&gt; (CInt -&gt; IO r) -&gt; IO r
</span><a href="Network.Socket.Types.html#withFdSocket"><span class="hs-identifier hs-var">withFdSocket</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081037"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">((CInt -&gt; IO ()) -&gt; IO ()) -&gt; (CInt -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Fd -&gt; IO ()
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Conc.IO.html#threadWaitWrite"><span class="hs-identifier hs-var">threadWaitWrite</span></a></span><span> </span><span class="annot"><span class="annottext">(Fd -&gt; IO ()) -&gt; (CInt -&gt; Fd) -&gt; CInt -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CInt -&gt; Fd
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span>
</span><span id="line-173"></span><span>       </span><span id="local-6989586621679081076"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679081076"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; SocketOption -&gt; IO Int
</span><a href="Network.Socket.Options.html#getSocketOption"><span class="hs-identifier hs-var">getSocketOption</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081037"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SocketOption
</span><a href="Network.Socket.Options.html#SoError"><span class="hs-identifier hs-var">SoError</span></a></span><span>
</span><span id="line-174"></span><span>       </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679081076"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; CInt -&gt; IO ()
forall a. String -&gt; CInt -&gt; IO a
</span><a href="Network.Socket.Internal.html#throwSocketErrorCode"><span class="hs-identifier hs-var">throwSocketErrorCode</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679081044"><span class="hs-identifier hs-var">errLoc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; CInt
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679081076"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-177"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- Listen</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="hs-comment">-- | Listen for connections made to the socket.  The second argument</span><span>
</span><span id="line-181"></span><span class="hs-comment">-- specifies the maximum number of queued connections and should be at</span><span>
</span><span id="line-182"></span><span class="hs-comment">-- least 1; the maximum value is system-dependent (usually 5).</span><span>
</span><span id="line-183"></span><span class="annot"><a href="Network.Socket.Syscall.html#listen"><span class="hs-identifier hs-type">listen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span id="listen"><span class="annot"><span class="annottext">listen :: Socket -&gt; Int -&gt; IO ()
</span><a href="Network.Socket.Syscall.html#listen"><span class="hs-identifier hs-var hs-var">listen</span></a></span></span><span> </span><span id="local-6989586621679081082"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081082"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679081083"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679081083"><span class="hs-identifier hs-var">backlog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; (CInt -&gt; IO ()) -&gt; IO ()
forall r. Socket -&gt; (CInt -&gt; IO r) -&gt; IO r
</span><a href="Network.Socket.Types.html#withFdSocket"><span class="hs-identifier hs-var">withFdSocket</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081082"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">((CInt -&gt; IO ()) -&gt; IO ()) -&gt; (CInt -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679081084"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081084"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; IO CInt -&gt; IO ()
forall a. (Eq a, Num a) =&gt; String -&gt; IO a -&gt; IO ()
</span><a href="Network.Socket.Internal.html#throwSocketErrorIfMinus1Retry_"><span class="hs-identifier hs-var">throwSocketErrorIfMinus1Retry_</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Network.Socket.listen&quot;</span></span><span> </span><span class="annot"><span class="annottext">(IO CInt -&gt; IO ()) -&gt; IO CInt -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-186"></span><span>        </span><span class="annot"><span class="annottext">CInt -&gt; CInt -&gt; IO CInt
</span><a href="Network.Socket.Syscall.html#c_listen"><span class="hs-identifier hs-var">c_listen</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081084"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">(CInt -&gt; IO CInt) -&gt; CInt -&gt; IO CInt
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; CInt
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679081083"><span class="hs-identifier hs-var">backlog</span></a></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- Accept</span><span>
</span><span id="line-190"></span><span class="hs-comment">--</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- A call to `accept' only returns when data is available on the given</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- socket, unless the socket has been set to non-blocking.  It will</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- return a new socket which should be used to read the incoming data and</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- should then be closed. Using the socket returned by `accept' allows</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- incoming requests to be queued on the original socket.</span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="hs-comment">-- | Accept a connection.  The socket must be bound to an address and</span><span>
</span><span id="line-198"></span><span class="hs-comment">-- listening for connections.  The return value is a pair @(conn,</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- address)@ where @conn@ is a new socket object usable to send and</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- receive data on the connection, and @address@ is the address bound</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- to the socket on the other end of the connection.</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- On Unix, FD_CLOEXEC is set to the new 'Socket'.</span><span>
</span><span id="line-203"></span><span id="local-6989586621679080910"><span class="annot"><a href="Network.Socket.Syscall.html#accept"><span class="hs-identifier hs-type">accept</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.Socket.Types.html#SocketAddress"><span class="hs-identifier hs-type">SocketAddress</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080910"><span class="hs-identifier hs-type">sa</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.Socket.Types.html#Socket"><span class="hs-identifier hs-type">Socket</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679080910"><span class="hs-identifier hs-type">sa</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-204"></span><span id="accept"><span class="annot"><span class="annottext">accept :: forall sa. SocketAddress sa =&gt; Socket -&gt; IO (Socket, sa)
</span><a href="Network.Socket.Syscall.html#accept"><span class="hs-identifier hs-var hs-var">accept</span></a></span></span><span> </span><span id="local-6989586621679081095"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081095"><span class="hs-identifier hs-var">listing_sock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ptr sa -&gt; Int -&gt; IO (Socket, sa)) -&gt; IO (Socket, sa)
forall sa a. SocketAddress sa =&gt; (Ptr sa -&gt; Int -&gt; IO a) -&gt; IO a
</span><a href="Network.Socket.Types.html#withNewSocketAddress"><span class="hs-identifier hs-var">withNewSocketAddress</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr sa -&gt; Int -&gt; IO (Socket, sa)) -&gt; IO (Socket, sa))
-&gt; (Ptr sa -&gt; Int -&gt; IO (Socket, sa)) -&gt; IO (Socket, sa)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679081097"><span class="annot"><span class="annottext">Ptr sa
</span><a href="#local-6989586621679081097"><span class="hs-identifier hs-var">new_sa</span></a></span></span><span> </span><span id="local-6989586621679081098"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679081098"><span class="hs-identifier hs-var">sz</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><span class="annottext">Socket -&gt; (CInt -&gt; IO (Socket, sa)) -&gt; IO (Socket, sa)
forall r. Socket -&gt; (CInt -&gt; IO r) -&gt; IO r
</span><a href="Network.Socket.Types.html#withFdSocket"><span class="hs-identifier hs-var">withFdSocket</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081095"><span class="hs-identifier hs-var">listing_sock</span></a></span><span> </span><span class="annot"><span class="annottext">((CInt -&gt; IO (Socket, sa)) -&gt; IO (Socket, sa))
-&gt; (CInt -&gt; IO (Socket, sa)) -&gt; IO (Socket, sa)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679081099"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081099"><span class="hs-identifier hs-var">listing_fd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-206"></span><span> </span><span id="local-6989586621679081100"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081100"><span class="hs-identifier hs-var">new_sock</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO CInt -&gt; (CInt -&gt; IO CInt) -&gt; (CInt -&gt; IO Socket) -&gt; IO Socket
forall a b c. IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Control.Exception.Base.html#bracketOnError"><span class="hs-identifier hs-var">E.bracketOnError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CInt -&gt; Ptr sa -&gt; Int -&gt; IO CInt
forall {a} {sa}. Integral a =&gt; CInt -&gt; Ptr sa -&gt; a -&gt; IO CInt
</span><a href="#local-6989586621679081101"><span class="hs-identifier hs-var">callAccept</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081099"><span class="hs-identifier hs-var">listing_fd</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr sa
</span><a href="#local-6989586621679081097"><span class="hs-identifier hs-var">new_sa</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679081098"><span class="hs-identifier hs-var">sz</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CInt -&gt; IO CInt
</span><a href="Network.Socket.Types.html#c_close"><span class="hs-identifier hs-var">c_close</span></a></span><span> </span><span class="annot"><span class="annottext">CInt -&gt; IO Socket
</span><a href="Network.Socket.Types.html#mkSocket"><span class="hs-identifier hs-var">mkSocket</span></a></span><span>
</span><span id="line-207"></span><span> </span><span id="local-6989586621679081102"><span class="annot"><span class="annottext">sa
</span><a href="#local-6989586621679081102"><span class="hs-identifier hs-var">new_addr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr sa -&gt; IO sa
forall sa. SocketAddress sa =&gt; Ptr sa -&gt; IO sa
</span><a href="Network.Socket.Types.html#peekSocketAddress"><span class="hs-identifier hs-var">peekSocketAddress</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr sa
</span><a href="#local-6989586621679081097"><span class="hs-identifier hs-var">new_sa</span></a></span><span>
</span><span id="line-208"></span><span> </span><span class="annot"><span class="annottext">(Socket, sa) -&gt; IO (Socket, sa)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081100"><span class="hs-identifier hs-var">new_sock</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sa
</span><a href="#local-6989586621679081102"><span class="hs-identifier hs-var">new_addr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-keyword">where</span><span class="hs-cpp">
#if defined(mingw32_HOST_OS)
</span><span>     </span><span class="hs-identifier">callAccept</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-identifier">sa</span><span> </span><span class="hs-identifier">sz</span><span>
</span><span id="line-212"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">threaded</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">with</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">sz</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">ptr_len</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-213"></span><span>                       </span><span class="hs-identifier">throwSocketErrorIfMinus1Retry</span><span> </span><span class="hs-string">&quot;Network.Socket.accept&quot;</span><span> </span><span class="hs-operator">$</span><span>
</span><span id="line-214"></span><span>                         </span><span class="hs-identifier">c_accept_safe</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-identifier">sa</span><span> </span><span class="hs-identifier">ptr_len</span><span>
</span><span id="line-215"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-216"></span><span>             </span><span class="hs-identifier">bracket</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">c_newAcceptParams</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">sz</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">sa</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">c_free</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">paramData</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-217"></span><span>                 </span><span class="hs-identifier">rc</span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">asyncDoProc</span><span> </span><span class="hs-identifier">c_acceptDoProc</span><span> </span><span class="hs-identifier">paramData</span><span>
</span><span id="line-218"></span><span>                 </span><span class="hs-identifier">new_fd</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">c_acceptNewSock</span><span> </span><span class="hs-identifier">paramData</span><span>
</span><span id="line-219"></span><span>                 </span><span class="hs-identifier">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rc</span><span> </span><span class="hs-operator">/=</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span>
</span><span id="line-220"></span><span>                     </span><span class="hs-identifier">throwSocketErrorCode</span><span> </span><span class="hs-string">&quot;Network.Socket.accept&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">rc</span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>                 </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">new_fd</span><span class="hs-cpp">
#else
</span><span>     </span><span id="local-6989586621679081101"><span class="annot"><span class="annottext">callAccept :: CInt -&gt; Ptr sa -&gt; a -&gt; IO CInt
</span><a href="#local-6989586621679081101"><span class="hs-identifier hs-var hs-var">callAccept</span></a></span></span><span> </span><span id="local-6989586621679081127"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081127"><span class="hs-identifier hs-var">fd</span></a></span></span><span> </span><span id="local-6989586621679081128"><span class="annot"><span class="annottext">Ptr sa
</span><a href="#local-6989586621679081128"><span class="hs-identifier hs-var">sa</span></a></span></span><span> </span><span id="local-6989586621679081129"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679081129"><span class="hs-identifier hs-var">sz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CInt -&gt; (Ptr CInt -&gt; IO CInt) -&gt; IO CInt
forall a b. Storable a =&gt; a -&gt; (Ptr a -&gt; IO b) -&gt; IO b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.Marshal.Utils.html#with"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; CInt
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679081129"><span class="hs-identifier hs-var">sz</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Ptr CInt -&gt; IO CInt) -&gt; IO CInt)
-&gt; (Ptr CInt -&gt; IO CInt) -&gt; IO CInt
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621679081130"><span class="annot"><span class="annottext">Ptr CInt
</span><a href="#local-6989586621679081130"><span class="hs-identifier hs-var">ptr_len</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span class="hs-cpp">
# ifdef HAVE_ADVANCED_SOCKET_FLAGS
</span><span>       </span><span class="annot"><span class="annottext">Socket -&gt; String -&gt; IO CInt -&gt; IO CInt
forall a. (Eq a, Num a) =&gt; Socket -&gt; String -&gt; IO a -&gt; IO a
</span><a href="Network.Socket.Internal.html#throwSocketErrorWaitRead"><span class="hs-identifier hs-var">throwSocketErrorWaitRead</span></a></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679081095"><span class="hs-identifier hs-var">listing_sock</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Network.Socket.accept&quot;</span></span><span>
</span><span id="line-226"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CInt -&gt; Ptr sa -&gt; Ptr CInt -&gt; CInt -&gt; IO CInt
forall sa. CInt -&gt; Ptr sa -&gt; Ptr CInt -&gt; CInt -&gt; IO CInt
</span><a href="Network.Socket.Syscall.html#c_accept4"><span class="hs-identifier hs-var">c_accept4</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679081127"><span class="hs-identifier hs-var">fd</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr sa
</span><a href="#local-6989586621679081128"><span class="hs-identifier hs-var">sa</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CInt
</span><a href="#local-6989586621679081130"><span class="hs-identifier hs-var">ptr_len</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CInt
</span><a href="Network.Socket.Cbits.html#sockNonBlock"><span class="hs-identifier hs-var">sockNonBlock</span></a></span><span> </span><span class="annot"><span class="annottext">CInt -&gt; CInt -&gt; CInt
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="Network.Socket.Cbits.html#sockCloexec"><span class="hs-identifier hs-var">sockCloexec</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
# else
</span><span>       </span><span class="hs-identifier">new_fd</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">throwSocketErrorWaitRead</span><span> </span><span class="hs-identifier">listing_sock</span><span> </span><span class="hs-string">&quot;Network.Socket.accept&quot;</span><span>
</span><span id="line-229"></span><span>                        </span><span class="hs-special">(</span><span class="hs-identifier">c_accept</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-identifier">sa</span><span> </span><span class="hs-identifier">ptr_len</span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>       </span><span class="hs-identifier">setNonBlockIfNeeded</span><span> </span><span class="hs-identifier">new_fd</span><span>
</span><span id="line-231"></span><span>       </span><span class="hs-identifier">setCloseOnExecIfNeeded</span><span> </span><span class="hs-identifier">new_fd</span><span>
</span><span id="line-232"></span><span>       </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">new_fd</span><span class="hs-cpp">
# endif /* HAVE_ADVANCED_SOCKET_FLAGS */
</span><span class="hs-cpp">#endif
</span><span>
</span><span id="line-236"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CALLCONV</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;socket&quot;</span><span>
</span><span id="line-237"></span><span>  </span><span id="c_socket"><span class="annot"><a href="Network.Socket.Syscall.html#c_socket"><span class="hs-identifier hs-var">c_socket</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span>
</span><span id="line-238"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CALLCONV</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;bind&quot;</span><span>
</span><span id="line-239"></span><span>  </span><span id="c_bind"><span class="annot"><a href="Network.Socket.Syscall.html#c_bind"><span class="hs-identifier hs-var">c_bind</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679080895"><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080895"><span class="hs-identifier hs-type">sa</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span class="hs-comment">{-CSockLen???-}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span></span><span>
</span><span id="line-240"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CALLCONV</span><span> </span><span class="hs-identifier">SAFE_ON_WIN</span><span> </span><span class="hs-string">&quot;connect&quot;</span><span>
</span><span id="line-241"></span><span>  </span><span id="c_connect"><span class="annot"><a href="Network.Socket.Syscall.html#c_connect"><span class="hs-identifier hs-var">c_connect</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679081134"><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679081134"><span class="hs-identifier hs-type">sa</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span class="hs-comment">{-CSockLen???-}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span></span><span>
</span><span id="line-242"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CALLCONV</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;listen&quot;</span><span>
</span><span id="line-243"></span><span>  </span><span id="c_listen"><span class="annot"><a href="Network.Socket.Syscall.html#c_listen"><span class="hs-identifier hs-var">c_listen</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span class="hs-cpp">

#ifdef HAVE_ADVANCED_SOCKET_FLAGS
</span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CALLCONV</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;accept4&quot;</span><span>
</span><span id="line-247"></span><span>  </span><span id="c_accept4"><span class="annot"><a href="Network.Socket.Syscall.html#c_accept4"><span class="hs-identifier hs-var">c_accept4</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679080924"><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080924"><span class="hs-identifier hs-type">sa</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span class="hs-comment">{-CSockLen???-}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/q5s037f3dqgwfpccw3qcagm27malqb1y-ghc-9.6.7-doc/share/doc/ghc-9.6.7/html/libraries/base-4.18.3.0/src/Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a></span></span><span class="hs-cpp">
#else
</span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CALLCONV</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;accept&quot;</span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-identifier">c_accept</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">sa</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CInt</span><span class="hs-comment">{-CSockLen???-}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CALLCONV</span><span> </span><span class="hs-keyword">safe</span><span> </span><span class="hs-string">&quot;accept&quot;</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-identifier">c_accept_safe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">sa</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">CInt</span><span class="hs-comment">{-CSockLen???-}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><span id="line-256"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;rtsSupportsBoundThreads&quot;</span><span>
</span><span id="line-257"></span><span>  </span><span class="hs-identifier">threaded</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><span id="line-258"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;HsNet.h acceptNewSock&quot;</span><span>
</span><span id="line-259"></span><span>  </span><span class="hs-identifier">c_acceptNewSock</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><span id="line-260"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;HsNet.h newAcceptParams&quot;</span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-identifier">c_newAcceptParams</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;HsNet.h &amp;acceptDoProc&quot;</span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-identifier">c_acceptDoProc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">FunPtr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Int</span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;free&quot;</span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-identifier">c_free</span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span></pre></body></html>